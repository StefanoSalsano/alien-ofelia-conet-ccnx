<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Content-Centric Networking in C: ccnr/ccnr_proto.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_fcd5115610c592af72997d6bb8517d72.html">ccnr</a>
  </div>
</div>
<div class="contents">
<h1>ccnr_proto.c</h1><a href="ccnr__proto_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/**</span>
<a name="l00002"></a>00002 <span class="comment"> * @file ccnr_proto.c</span>
<a name="l00003"></a>00003 <span class="comment"> * </span>
<a name="l00004"></a>00004 <span class="comment"> * Part of ccnr -  CCNx Repository Daemon.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> */</span>
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <span class="comment">/*</span>
<a name="l00009"></a>00009 <span class="comment"> * Copyright (C) 2011 Palo Alto Research Center, Inc.</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * This work is free software; you can redistribute it and/or modify it under</span>
<a name="l00012"></a>00012 <span class="comment"> * the terms of the GNU General Public License version 2 as published by the</span>
<a name="l00013"></a>00013 <span class="comment"> * Free Software Foundation.</span>
<a name="l00014"></a>00014 <span class="comment"> * This work is distributed in the hope that it will be useful, but WITHOUT ANY</span>
<a name="l00015"></a>00015 <span class="comment"> * WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<a name="l00016"></a>00016 <span class="comment"> * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License</span>
<a name="l00017"></a>00017 <span class="comment"> * for more details. You should have received a copy of the GNU General Public</span>
<a name="l00018"></a>00018 <span class="comment"> * License along with this program; if not, write to the</span>
<a name="l00019"></a>00019 <span class="comment"> * Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,</span>
<a name="l00020"></a>00020 <span class="comment"> * Boston, MA 02110-1301, USA.</span>
<a name="l00021"></a>00021 <span class="comment"> */</span>
<a name="l00022"></a>00022  
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;stdint.h&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;sys/errno.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;<a class="code" href="ccn_8h.html" title="This is the low-level interface for CCNx clients.">ccn/ccn.h</a>&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;<a class="code" href="charbuf_8h.html" title="Expandable character buffer for counted sequences of arbitrary octets.">ccn/charbuf.h</a>&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;<a class="code" href="ccn__private_8h.html" title="Additional operations that are irrevalent for most clients.">ccn/ccn_private.h</a>&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;<a class="code" href="hashtb_8h.html" title="Hash table.">ccn/hashtb.h</a>&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;<a class="code" href="schedule_8h.html" title="Event scheduling.">ccn/schedule.h</a>&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;<a class="code" href="sockaddrutil_8h.html" title="sockaddr utilities">ccn/sockaddrutil.h</a>&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;<a class="code" href="uri_8h.html" title="ccn-scheme uri conversions.">ccn/uri.h</a>&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;<a class="code" href="coding_8h.html" title="Details of the ccn binary wire encoding.">ccn/coding.h</a>&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;<a class="code" href="_sync_base_8h.html" title="Part of CCNx Sync.">sync/SyncBase.h</a>&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="ccnr__private_8h.html" title="Private definitions for ccnr - the CCNx daemon.">ccnr_private.h</a>&quot;</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="ccnr__proto_8h.html" title="Part of ccnr - CCNx Repository Daemon.">ccnr_proto.h</a>&quot;</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="ccnr__dispatch_8h.html" title="Part of ccnr - CCNx Repository Daemon.">ccnr_dispatch.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="ccnr__forwarding_8h.html" title="Part of ccnr - CCNx Repository Daemon.">ccnr_forwarding.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="ccnr__init_8h.html" title="Part of ccnr - CCNx Repository Daemon.">ccnr_init.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="ccnr__io_8h.html" title="Part of ccnr - CCNx Repository Daemon.">ccnr_io.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="ccnr__msg_8h.html" title="Part of ccnr - CCNx Repository Daemon.">ccnr_msg.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="ccnr__sendq_8h.html" title="Part of ccnr - CCNx Repository Daemon.">ccnr_sendq.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="ccnr__store_8h.html" title="Part of ccnr - CCNx Repository Daemon.">ccnr_store.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="ccnr__sync_8h.html" title="Part of ccnr - CCNx Repository Daemon.">ccnr_sync.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="ccnr__util_8h.html" title="Part of ccnr - CCNx Repository Daemon.">ccnr_util.h</a>&quot;</span>
<a name="l00055"></a>00055 
<a name="l00056"></a><a class="code" href="ccnr__proto_8c.html#a5c5ac86d3f39a8829512117348e9a0fc">00056</a> <span class="preprocessor">#define CCNR_MAX_RETRY 5</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span>
<a name="l00058"></a>00058 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a>
<a name="l00059"></a>00059 <a class="code" href="ccnr__proto_8c.html#a09cb147151d02fa0624317f58188fd10">r_proto_start_write</a>(<span class="keyword">struct</span> <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *selfp,
<a name="l00060"></a>00060                     <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92" title="This tells what kind of event the upcall is handling.">ccn_upcall_kind</a> kind,
<a name="l00061"></a>00061                     <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info,
<a name="l00062"></a>00062                     <span class="keywordtype">int</span> marker_comp);
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a>
<a name="l00065"></a>00065 <a class="code" href="ccnr__proto_8c.html#a430cf7f7832e08280285d33c6f393cb9">r_proto_start_write_checked</a>(<span class="keyword">struct</span> <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *selfp,
<a name="l00066"></a>00066                             <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92" title="This tells what kind of event the upcall is handling.">ccn_upcall_kind</a> kind,
<a name="l00067"></a>00067                             <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info,
<a name="l00068"></a>00068                             <span class="keywordtype">int</span> marker_comp);
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a>
<a name="l00071"></a>00071 <a class="code" href="ccnr__proto_8c.html#a8131ce5b8fa912cef71a628be6aab86b">r_proto_begin_enumeration</a>(<span class="keyword">struct</span> <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *selfp,
<a name="l00072"></a>00072                           <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92" title="This tells what kind of event the upcall is handling.">ccn_upcall_kind</a> kind,
<a name="l00073"></a>00073                           <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info,
<a name="l00074"></a>00074                           <span class="keywordtype">int</span> marker_comp);
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a>
<a name="l00077"></a>00077 <a class="code" href="ccnr__proto_8c.html#a3cfb05cf8d7caa123adabe59f4cab40c">r_proto_continue_enumeration</a>(<span class="keyword">struct</span> <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *selfp,
<a name="l00078"></a>00078                              <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92" title="This tells what kind of event the upcall is handling.">ccn_upcall_kind</a> kind,
<a name="l00079"></a>00079                              <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info,
<a name="l00080"></a>00080                              <span class="keywordtype">int</span> marker_comp);
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a>
<a name="l00083"></a>00083 <a class="code" href="ccnr__proto_8c.html#a563189db2b1adcbad622696782ac0440">r_proto_bulk_import</a>(<span class="keyword">struct</span> <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *selfp,
<a name="l00084"></a>00084                              <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92" title="This tells what kind of event the upcall is handling.">ccn_upcall_kind</a> kind,
<a name="l00085"></a>00085                              <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info,
<a name="l00086"></a>00086                              <span class="keywordtype">int</span> marker_comp);
<a name="l00087"></a>00087 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00088"></a>00088 <a class="code" href="ccnr__proto_8c.html#a70fd987b1e084846de60266cd3c017c3" title="Compare a name component at index i to bytes in buf and return 1 if they are equal...">name_comp_equal_prefix</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data,
<a name="l00089"></a>00089                     <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structccn__indexbuf.html">ccn_indexbuf</a> *indexbuf,
<a name="l00090"></a>00090                     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i, <span class="keyword">const</span> <span class="keywordtype">void</span> *buf, <span class="keywordtype">size_t</span> length);
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a>
<a name="l00093"></a><a class="code" href="ccnr__proto_8c.html#ad2a5c89c02c02862fa60865cfd1b218e">00093</a> <a class="code" href="ccnr__proto_8c.html#ad2a5c89c02c02862fa60865cfd1b218e">r_proto_answer_req</a>(<span class="keyword">struct</span> <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *selfp,
<a name="l00094"></a>00094                  <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92" title="This tells what kind of event the upcall is handling.">ccn_upcall_kind</a> kind,
<a name="l00095"></a>00095                  <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info)
<a name="l00096"></a>00096 {
<a name="l00097"></a>00097     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *msg = NULL;
<a name="l00098"></a>00098     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = NULL;
<a name="l00099"></a>00099     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *keylocator = NULL;
<a name="l00100"></a>00100     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *signed_info = NULL;
<a name="l00101"></a>00101     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *reply_body = NULL;
<a name="l00102"></a>00102     <span class="keyword">struct </span><a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *ccnr = NULL;
<a name="l00103"></a>00103     <span class="keyword">struct </span><a class="code" href="structcontent__entry.html" title="The content hash table is keyed by the initial portion of the ContentObject that...">content_entry</a> *content = NULL;
<a name="l00104"></a>00104     <span class="keywordtype">int</span> res = 0;
<a name="l00105"></a>00105     <span class="keywordtype">int</span> <a class="code" href="structcontent__entry.html#a773fd41b5ae6d3903d23fe8a07e037a1" title="Number of name components plus one.">ncomps</a>;
<a name="l00106"></a>00106     <span class="keywordtype">int</span> marker_comp;
<a name="l00107"></a>00107     <span class="comment">// struct ccn_signing_params sp = CCN_SIGNING_PARAMS_INIT;</span>
<a name="l00108"></a>00108     
<a name="l00109"></a>00109     <span class="keywordflow">switch</span> (kind) {
<a name="l00110"></a>00110         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92ad00afdf8a89c718f4c451600b115b5e0" title="handler is about to be deregistered">CCN_UPCALL_FINAL</a>:
<a name="l00111"></a>00111             free(selfp);
<a name="l00112"></a>00112             <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcadadb47635316f12c6542c33cebcfa727" title="normal upcall return">CCN_UPCALL_RESULT_OK</a>);
<a name="l00113"></a>00113         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a10dc20968eaf28989921d076bbc81d62" title="incoming interest">CCN_UPCALL_INTEREST</a>:
<a name="l00114"></a>00114             <span class="keywordflow">break</span>;
<a name="l00115"></a>00115         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a01b7a7469d45ecef00337246a3a24d59" title="incoming interest, someone has answered">CCN_UPCALL_CONSUMED_INTEREST</a>:
<a name="l00116"></a>00116             <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcadadb47635316f12c6542c33cebcfa727" title="normal upcall return">CCN_UPCALL_RESULT_OK</a>);
<a name="l00117"></a>00117         <span class="keywordflow">default</span>:
<a name="l00118"></a>00118             <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>);
<a name="l00119"></a>00119     }
<a name="l00120"></a>00120     ccnr = (<span class="keyword">struct </span><a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *)selfp-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a>;
<a name="l00121"></a>00121     if (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a2d1e1fa6e4518cba402ea37d1b963d99">LM_128</a>, <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>))
<a name="l00122"></a>00122         <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;r_proto_answer_req&quot;</span>, NULL,
<a name="l00123"></a>00123                         info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ae3500edfbd06a2be152e0ef8fcc64328">CCN_PI_E</a>]);
<a name="l00124"></a>00124     
<a name="l00125"></a>00125     content = <a class="code" href="ccnr__store_8c.html#a79f1fc95cadf17dd869726090f66c494">r_store_lookup</a>(ccnr, info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>);
<a name="l00126"></a>00126     <span class="keywordflow">if</span> (content != NULL) {
<a name="l00127"></a>00127         <span class="keyword">struct </span><a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a> *<a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a> = <a class="code" href="ccnr__io_8c.html#ad9ca4dc679b9aa962638ae2c0ad9c68f" title="Looks up a fdholder based on its filedesc (private).">r_io_fdholder_from_fd</a>(ccnr, <a class="code" href="ccn_8h.html#a932df0f9c232ae47f06cd1db35ac1472">ccn_get_connection_fd</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>));
<a name="l00128"></a>00128         <span class="keywordflow">if</span> (fdholder != NULL)
<a name="l00129"></a>00129             <a class="code" href="ccnr__sendq_8c.html#a267b37db7be2acfe6f9724c85ec8c4e3">r_sendq_face_send_queue_insert</a>(ccnr, <a class="code" href="ccnr__io_8c.html#ad9ca4dc679b9aa962638ae2c0ad9c68f" title="Looks up a fdholder based on its filedesc (private).">r_io_fdholder_from_fd</a>(ccnr, <a class="code" href="ccn_8h.html#a932df0f9c232ae47f06cd1db35ac1472">ccn_get_connection_fd</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>)), content);
<a name="l00130"></a>00130         res = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca35e0232348739cde04ba6355c4395001" title="upcall claims to consume interest">CCN_UPCALL_RESULT_INTEREST_CONSUMED</a>;
<a name="l00131"></a>00131         <span class="keywordflow">goto</span> Finish;
<a name="l00132"></a>00132     }
<a name="l00133"></a>00133     <span class="comment">/* commands will potentially generate new content, test if new content is ok */</span>
<a name="l00134"></a>00134     <span class="keywordflow">if</span> ((info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#a0c535d59cbe268b169381219513d54c4">answerfrom</a> &amp; <a class="code" href="ccn_8h.html#a2eee6f7928f301760a9fe253faf676b3">CCN_AOK_NEW</a>) == 0) {
<a name="l00135"></a>00135         <span class="keywordflow">goto</span> Bail;
<a name="l00136"></a>00136     }
<a name="l00137"></a>00137     
<a name="l00138"></a>00138     <span class="comment">/* check for command markers */</span>
<a name="l00139"></a>00139     ncomps = info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a>;
<a name="l00140"></a>00140     <span class="keywordflow">if</span> (((marker_comp = ncomps - 2) &gt;= 0) &amp;&amp;
<a name="l00141"></a>00141         0 == <a class="code" href="ccnr__util_8c.html#acf919e5f16fe3629490c8cc5d663363e" title="Compare a name component at index i to bytes in buf and return 0 if they are equal...">r_util_name_comp_compare</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>, marker_comp, <a class="code" href="ccnr__proto_8h.html#af253a631fb194fe94e048b98420c8e2a">NAME_BE</a>, strlen(<a class="code" href="ccnr__proto_8h.html#af253a631fb194fe94e048b98420c8e2a">NAME_BE</a>))) {
<a name="l00142"></a>00142         <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a7323999db7afd7869b7b4ff665e751c8">LM_8</a>, <a class="code" href="loglevels_8h.html#a795a0a3098f6c9ba5990e8a23775284d" title="More debugging.">CCNL_FINER</a>))
<a name="l00143"></a>00143             <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;name_enumeration&quot;</span>, NULL,
<a name="l00144"></a>00144                             info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ae3500edfbd06a2be152e0ef8fcc64328">CCN_PI_E</a>]);
<a name="l00145"></a>00145         res = <a class="code" href="ccnr__proto_8c.html#a8131ce5b8fa912cef71a628be6aab86b">r_proto_begin_enumeration</a>(selfp, kind, info, marker_comp);
<a name="l00146"></a>00146         <span class="keywordflow">goto</span> Finish;
<a name="l00147"></a>00147     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((marker_comp = ncomps - 3) &gt;= 0) &amp;&amp;
<a name="l00148"></a>00148                0 == <a class="code" href="ccnr__util_8c.html#acf919e5f16fe3629490c8cc5d663363e" title="Compare a name component at index i to bytes in buf and return 0 if they are equal...">r_util_name_comp_compare</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>, marker_comp, <a class="code" href="ccnr__proto_8h.html#af253a631fb194fe94e048b98420c8e2a">NAME_BE</a>, strlen(<a class="code" href="ccnr__proto_8h.html#af253a631fb194fe94e048b98420c8e2a">NAME_BE</a>)) &amp;&amp;
<a name="l00149"></a>00149                0 == <a class="code" href="ccnr__util_8c.html#acf919e5f16fe3629490c8cc5d663363e" title="Compare a name component at index i to bytes in buf and return 0 if they are equal...">r_util_name_comp_compare</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>, marker_comp + 1, ccnr-&gt;<a class="code" href="structccnr__handle.html#ab7fec1a42e8328d78c348aaf4a7c06e6" title="public key digest in keyid format C1.M.K.">ccnr_keyid</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, ccnr-&gt;<a class="code" href="structccnr__handle.html#ab7fec1a42e8328d78c348aaf4a7c06e6" title="public key digest in keyid format C1.M.K.">ccnr_keyid</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>)) {
<a name="l00150"></a>00150         <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a7323999db7afd7869b7b4ff665e751c8">LM_8</a>, <a class="code" href="loglevels_8h.html#a795a0a3098f6c9ba5990e8a23775284d" title="More debugging.">CCNL_FINER</a>))
<a name="l00151"></a>00151             <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;name_enumeration_repoid&quot;</span>, NULL,
<a name="l00152"></a>00152                             info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ae3500edfbd06a2be152e0ef8fcc64328">CCN_PI_E</a>]);
<a name="l00153"></a>00153         res = <a class="code" href="ccnr__proto_8c.html#a8131ce5b8fa912cef71a628be6aab86b">r_proto_begin_enumeration</a>(selfp, kind, info, marker_comp);
<a name="l00154"></a>00154         <span class="keywordflow">goto</span> Finish;
<a name="l00155"></a>00155     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((marker_comp = ncomps - 5) &gt;= 0) &amp;&amp;
<a name="l00156"></a>00156                0 == <a class="code" href="ccnr__util_8c.html#acf919e5f16fe3629490c8cc5d663363e" title="Compare a name component at index i to bytes in buf and return 0 if they are equal...">r_util_name_comp_compare</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>, marker_comp, <a class="code" href="ccnr__proto_8h.html#af253a631fb194fe94e048b98420c8e2a">NAME_BE</a>, strlen(<a class="code" href="ccnr__proto_8h.html#af253a631fb194fe94e048b98420c8e2a">NAME_BE</a>)) &amp;&amp;
<a name="l00157"></a>00157                0 == <a class="code" href="ccnr__util_8c.html#acf919e5f16fe3629490c8cc5d663363e" title="Compare a name component at index i to bytes in buf and return 0 if they are equal...">r_util_name_comp_compare</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>, marker_comp + 1, ccnr-&gt;<a class="code" href="structccnr__handle.html#ab7fec1a42e8328d78c348aaf4a7c06e6" title="public key digest in keyid format C1.M.K.">ccnr_keyid</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, ccnr-&gt;<a class="code" href="structccnr__handle.html#ab7fec1a42e8328d78c348aaf4a7c06e6" title="public key digest in keyid format C1.M.K.">ccnr_keyid</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>)) {
<a name="l00158"></a>00158         <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a7323999db7afd7869b7b4ff665e751c8">LM_8</a>, <a class="code" href="loglevels_8h.html#a795a0a3098f6c9ba5990e8a23775284d" title="More debugging.">CCNL_FINER</a>))
<a name="l00159"></a>00159             <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;name_enumeration_continuation&quot;</span>,
<a name="l00160"></a>00160                             NULL, info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ae3500edfbd06a2be152e0ef8fcc64328">CCN_PI_E</a>]);
<a name="l00161"></a>00161         res = <a class="code" href="ccnr__proto_8c.html#a3cfb05cf8d7caa123adabe59f4cab40c">r_proto_continue_enumeration</a>(selfp, kind, info, marker_comp);
<a name="l00162"></a>00162         <span class="keywordflow">goto</span> Finish;
<a name="l00163"></a>00163     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((marker_comp = ncomps - 3) &gt; 0) &amp;&amp;
<a name="l00164"></a>00164                0 == <a class="code" href="ccnr__util_8c.html#acf919e5f16fe3629490c8cc5d663363e" title="Compare a name component at index i to bytes in buf and return 0 if they are equal...">r_util_name_comp_compare</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>, marker_comp, <a class="code" href="ccnr__proto_8h.html#a91ce9332aa047a51a70339a8f0e3fb75">REPO_SW</a>, strlen(<a class="code" href="ccnr__proto_8h.html#a91ce9332aa047a51a70339a8f0e3fb75">REPO_SW</a>))) {
<a name="l00165"></a>00165         <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a7323999db7afd7869b7b4ff665e751c8">LM_8</a>, <a class="code" href="loglevels_8h.html#a795a0a3098f6c9ba5990e8a23775284d" title="More debugging.">CCNL_FINER</a>))
<a name="l00166"></a>00166             <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;repo_start_write&quot;</span>, NULL,
<a name="l00167"></a>00167                             info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ae3500edfbd06a2be152e0ef8fcc64328">CCN_PI_E</a>]);
<a name="l00168"></a>00168         res = <a class="code" href="ccnr__proto_8c.html#a09cb147151d02fa0624317f58188fd10">r_proto_start_write</a>(selfp, kind, info, marker_comp);
<a name="l00169"></a>00169         <span class="keywordflow">goto</span> Finish;
<a name="l00170"></a>00170     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((marker_comp = ncomps - 5) &gt; 0) &amp;&amp;
<a name="l00171"></a>00171                0 == <a class="code" href="ccnr__util_8c.html#acf919e5f16fe3629490c8cc5d663363e" title="Compare a name component at index i to bytes in buf and return 0 if they are equal...">r_util_name_comp_compare</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>, marker_comp, <a class="code" href="ccnr__proto_8h.html#a406c47cb6e51afdff31544a8eba60833">REPO_SWC</a>, strlen(<a class="code" href="ccnr__proto_8h.html#a406c47cb6e51afdff31544a8eba60833">REPO_SWC</a>))) {
<a name="l00172"></a>00172         <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a7323999db7afd7869b7b4ff665e751c8">LM_8</a>, <a class="code" href="loglevels_8h.html#a795a0a3098f6c9ba5990e8a23775284d" title="More debugging.">CCNL_FINER</a>))
<a name="l00173"></a>00173             <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;repo_start_write_checked&quot;</span>,
<a name="l00174"></a>00174                             NULL, info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ae3500edfbd06a2be152e0ef8fcc64328">CCN_PI_E</a>]);
<a name="l00175"></a>00175         res = <a class="code" href="ccnr__proto_8c.html#a430cf7f7832e08280285d33c6f393cb9">r_proto_start_write_checked</a>(selfp, kind, info, marker_comp);
<a name="l00176"></a>00176         <span class="keywordflow">goto</span> Finish;
<a name="l00177"></a>00177     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((marker_comp = 0) == 0) &amp;&amp;
<a name="l00178"></a>00178                <a class="code" href="ccnr__proto_8c.html#a70fd987b1e084846de60266cd3c017c3" title="Compare a name component at index i to bytes in buf and return 1 if they are equal...">name_comp_equal_prefix</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>, marker_comp, <a class="code" href="ccnr__proto_8h.html#a877a26069de692ac0821c8b96fa54693">REPO_AF</a>, strlen(<a class="code" href="ccnr__proto_8h.html#a877a26069de692ac0821c8b96fa54693">REPO_AF</a>))) {
<a name="l00179"></a>00179         <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a7323999db7afd7869b7b4ff665e751c8">LM_8</a>, <a class="code" href="loglevels_8h.html#a795a0a3098f6c9ba5990e8a23775284d" title="More debugging.">CCNL_FINER</a>))
<a name="l00180"></a>00180             <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;repo_bulk_import&quot;</span>,
<a name="l00181"></a>00181                             NULL, info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ae3500edfbd06a2be152e0ef8fcc64328">CCN_PI_E</a>]);
<a name="l00182"></a>00182         res = <a class="code" href="ccnr__proto_8c.html#a563189db2b1adcbad622696782ac0440">r_proto_bulk_import</a>(selfp, kind, info, marker_comp);
<a name="l00183"></a>00183         <span class="keywordflow">goto</span> Finish;
<a name="l00184"></a>00184     }
<a name="l00185"></a>00185     <span class="keywordflow">goto</span> Bail;
<a name="l00186"></a>00186 Bail:
<a name="l00187"></a>00187     res = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>;
<a name="l00188"></a>00188 Finish:
<a name="l00189"></a>00189     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;msg);
<a name="l00190"></a>00190     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l00191"></a>00191     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;keylocator);
<a name="l00192"></a>00192     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;reply_body);
<a name="l00193"></a>00193     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;signed_info);
<a name="l00194"></a>00194     <span class="keywordflow">return</span>(res);
<a name="l00195"></a>00195 }
<a name="l00196"></a>00196 
<a name="l00197"></a>00197 <span class="comment">// XXX these should probably be rationalized and added to ccn_name_util.c</span><span class="comment"></span>
<a name="l00198"></a>00198 <span class="comment">/**</span>
<a name="l00199"></a>00199 <span class="comment"> * Compare a name component at index i to bytes in buf and return 1</span>
<a name="l00200"></a>00200 <span class="comment"> * if they are equal in the first length bytes.  The name component</span>
<a name="l00201"></a>00201 <span class="comment"> * must contain at least length bytes for this comparison to return</span>
<a name="l00202"></a>00202 <span class="comment"> * equality.</span>
<a name="l00203"></a>00203 <span class="comment"> * @returns 1 for equality, 0 for inequality.</span>
<a name="l00204"></a>00204 <span class="comment"> */</span>
<a name="l00205"></a>00205 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00206"></a><a class="code" href="ccnr__proto_8c.html#a70fd987b1e084846de60266cd3c017c3">00206</a> <a class="code" href="ccnr__proto_8c.html#a70fd987b1e084846de60266cd3c017c3" title="Compare a name component at index i to bytes in buf and return 1 if they are equal...">name_comp_equal_prefix</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data,
<a name="l00207"></a>00207                    <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structccn__indexbuf.html">ccn_indexbuf</a> *indexbuf,
<a name="l00208"></a>00208                    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i, <span class="keyword">const</span> <span class="keywordtype">void</span> *buf, <span class="keywordtype">size_t</span> length)
<a name="l00209"></a>00209 {
<a name="l00210"></a>00210     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *comp_ptr;
<a name="l00211"></a>00211     <span class="keywordtype">size_t</span> comp_size;
<a name="l00212"></a>00212     
<a name="l00213"></a>00213     <span class="keywordflow">if</span> (<a class="code" href="ccn_8h.html#a70c13909ea45ffb1069916d7a512fdda" title="Extract a pointer to and size of component at given index i.">ccn_name_comp_get</a>(data, indexbuf, i, &amp;comp_ptr, &amp;comp_size) != 0)
<a name="l00214"></a>00214         <span class="keywordflow">return</span>(0);
<a name="l00215"></a>00215     <span class="keywordflow">if</span> (comp_size &lt; length || memcmp(comp_ptr, buf, length) != 0)
<a name="l00216"></a>00216         <span class="keywordflow">return</span>(0);
<a name="l00217"></a>00217     <span class="keywordflow">return</span>(1);
<a name="l00218"></a>00218 }
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keywordtype">void</span>
<a name="l00221"></a><a class="code" href="ccnr__proto_8h.html#a0ae63b262caf3668f3bcd701fad0913c">00221</a> <a class="code" href="ccnr__proto_8c.html#aee367dfd2b8af67d21bcc3ece4db5b06">r_proto_uri_listen</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *ccnr, <span class="keyword">struct</span> ccn *ccn, <span class="keyword">const</span> <span class="keywordtype">char</span> *uri,
<a name="l00222"></a>00222                    <a class="code" href="ccn_8h.html#a9570a786d534c3eb0343de466857f11f" title="ccn_handler This is the procedure type for the closure&amp;#39;s implementation.">ccn_handler</a> p, intptr_t intdata)
<a name="l00223"></a>00223 {
<a name="l00224"></a>00224     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name;
<a name="l00225"></a>00225     <span class="keyword">struct </span><a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *closure = NULL;
<a name="l00226"></a>00226     
<a name="l00227"></a>00227     name = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00228"></a>00228     <a class="code" href="uri_8h.html#a7b960a7f4f9e3f8175ff05f191452104" title="Convert a ccnx-scheme URI to a ccnb-encoded Name.">ccn_name_from_uri</a>(name, uri);
<a name="l00229"></a>00229     <span class="keywordflow">if</span> (p != NULL) {
<a name="l00230"></a>00230         closure = calloc(1, <span class="keyword">sizeof</span>(*closure));
<a name="l00231"></a>00231         closure-&gt;<a class="code" href="structccn__closure.html#a48dca74271023e0caf287ad31dd1e66c" title="client-supplied handler">p</a> = p;
<a name="l00232"></a>00232         closure-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a> = ccnr;
<a name="l00233"></a>00233         closure-&gt;<a class="code" href="structccn__closure.html#a25a1e0591079ef386d0708a81f14b711" title="for client use">intdata</a> = intdata;
<a name="l00234"></a>00234     }
<a name="l00235"></a>00235     <a class="code" href="ccn_8h.html#a9193ff0e42816aea703225a374d5532d" title="Register to receive interests on a prefix.">ccn_set_interest_filter</a>(ccn, name, closure);
<a name="l00236"></a>00236     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l00237"></a>00237 }
<a name="l00238"></a>00238 
<a name="l00239"></a>00239 <span class="comment">// XXX - need an r_proto_uninit to uninstall the policy</span>
<a name="l00240"></a>00240 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keywordtype">void</span>
<a name="l00241"></a><a class="code" href="ccnr__proto_8h.html#a89fd1ffd369642f5a3ce31b92c1cddd8">00241</a> <a class="code" href="ccnr__proto_8c.html#abef394d94d4306260f1355204eadfb12">r_proto_init</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *ccnr) {
<a name="l00242"></a>00242     <span class="comment">// nothing to do</span>
<a name="l00243"></a>00243 }<span class="comment"></span>
<a name="l00244"></a>00244 <span class="comment">/**</span>
<a name="l00245"></a>00245 <span class="comment"> * Install the listener for the namespaces that the parsed policy says to serve</span>
<a name="l00246"></a>00246 <span class="comment"> * </span>
<a name="l00247"></a>00247 <span class="comment"> * Normal usage is to deactivate the old policy and then activate the new one</span>
<a name="l00248"></a>00248 <span class="comment"> */</span>
<a name="l00249"></a>00249 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keywordtype">void</span>
<a name="l00250"></a><a class="code" href="ccnr__proto_8h.html#ac15111c71400e7bce8bc3e0dfbee229a">00250</a> <a class="code" href="ccnr__proto_8c.html#a10e1f366d8ac499821f7dd09b777e9d0" title="Install the listener for the namespaces that the parsed policy says to serve.">r_proto_activate_policy</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *ccnr, <span class="keyword">struct</span> <a class="code" href="structccnr__parsed__policy.html">ccnr_parsed_policy</a> *pp) {
<a name="l00251"></a>00251     <span class="keywordtype">int</span> i;
<a name="l00252"></a>00252     
<a name="l00253"></a>00253     <span class="keywordflow">for</span> (i = 0; i &lt; pp-&gt;<a class="code" href="structccnr__parsed__policy.html#ac99ba64a37e3071da89dfea097f73d97">namespaces</a>-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a>; i++) {
<a name="l00254"></a>00254         <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, sdfdf, <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>))
<a name="l00255"></a>00255             <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;Adding listener for policy namespace %s&quot;</span>,
<a name="l00256"></a>00256                      (<span class="keywordtype">char</span> *)pp-&gt;<a class="code" href="structccnr__parsed__policy.html#a34b84b739cf9e12c772529935772000a">store</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a> + pp-&gt;<a class="code" href="structccnr__parsed__policy.html#ac99ba64a37e3071da89dfea097f73d97">namespaces</a>-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[i]);
<a name="l00257"></a>00257         <a class="code" href="ccnr__proto_8c.html#aee367dfd2b8af67d21bcc3ece4db5b06">r_proto_uri_listen</a>(ccnr, ccnr-&gt;<a class="code" href="structccnr__handle.html#aa358b4c6941900d7e02a620bf1e601b5" title="this talks directly with ccnd">direct_client</a>,
<a name="l00258"></a>00258                            (<span class="keywordtype">char</span> *)pp-&gt;<a class="code" href="structccnr__parsed__policy.html#a34b84b739cf9e12c772529935772000a">store</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a> + pp-&gt;<a class="code" href="structccnr__parsed__policy.html#ac99ba64a37e3071da89dfea097f73d97">namespaces</a>-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[i],
<a name="l00259"></a>00259                            <a class="code" href="ccnr__proto_8c.html#ad2a5c89c02c02862fa60865cfd1b218e">r_proto_answer_req</a>, 0);
<a name="l00260"></a>00260     }
<a name="l00261"></a>00261     <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, sdfdf, <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>))
<a name="l00262"></a>00262         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;Adding listener for policy global prefix %s&quot;</span>,
<a name="l00263"></a>00263                  (<span class="keywordtype">char</span> *)pp-&gt;<a class="code" href="structccnr__parsed__policy.html#a34b84b739cf9e12c772529935772000a">store</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a> + pp-&gt;<a class="code" href="structccnr__parsed__policy.html#a35998dadb60a54db4336b4a39408a014">global_prefix_offset</a>);
<a name="l00264"></a>00264     <a class="code" href="ccnr__proto_8c.html#aee367dfd2b8af67d21bcc3ece4db5b06">r_proto_uri_listen</a>(ccnr, ccnr-&gt;<a class="code" href="structccnr__handle.html#aa358b4c6941900d7e02a620bf1e601b5" title="this talks directly with ccnd">direct_client</a>,
<a name="l00265"></a>00265                        (<span class="keywordtype">char</span> *)pp-&gt;<a class="code" href="structccnr__parsed__policy.html#a34b84b739cf9e12c772529935772000a">store</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a> + pp-&gt;<a class="code" href="structccnr__parsed__policy.html#a35998dadb60a54db4336b4a39408a014">global_prefix_offset</a>,
<a name="l00266"></a>00266                        <a class="code" href="ccnr__proto_8c.html#ad2a5c89c02c02862fa60865cfd1b218e">r_proto_answer_req</a>, 0);    
<a name="l00267"></a>00267 }<span class="comment"></span>
<a name="l00268"></a>00268 <span class="comment">/**</span>
<a name="l00269"></a>00269 <span class="comment"> * Uninstall the listener for the namespaces that the parsed policy says to serve</span>
<a name="l00270"></a>00270 <span class="comment"> */</span>
<a name="l00271"></a>00271 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keywordtype">void</span>
<a name="l00272"></a><a class="code" href="ccnr__proto_8h.html#a1a16e25e45a973e98bb36ef32a7a8f4c">00272</a> <a class="code" href="ccnr__proto_8c.html#a85c77667b1ec23d0940fdc72ae10c377" title="Uninstall the listener for the namespaces that the parsed policy says to serve.">r_proto_deactivate_policy</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *ccnr, <span class="keyword">struct</span> <a class="code" href="structccnr__parsed__policy.html">ccnr_parsed_policy</a> *pp) {
<a name="l00273"></a>00273     <span class="keywordtype">int</span> i;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275     <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, sdfdf, <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>))
<a name="l00276"></a>00276         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;Removing listener for policy global prefix %s&quot;</span>,
<a name="l00277"></a>00277                  (<span class="keywordtype">char</span> *)pp-&gt;<a class="code" href="structccnr__parsed__policy.html#a34b84b739cf9e12c772529935772000a">store</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a> + pp-&gt;<a class="code" href="structccnr__parsed__policy.html#a35998dadb60a54db4336b4a39408a014">global_prefix_offset</a>);
<a name="l00278"></a>00278     <a class="code" href="ccnr__proto_8c.html#aee367dfd2b8af67d21bcc3ece4db5b06">r_proto_uri_listen</a>(ccnr, ccnr-&gt;<a class="code" href="structccnr__handle.html#aa358b4c6941900d7e02a620bf1e601b5" title="this talks directly with ccnd">direct_client</a>,
<a name="l00279"></a>00279                        (<span class="keywordtype">char</span> *)pp-&gt;<a class="code" href="structccnr__parsed__policy.html#a34b84b739cf9e12c772529935772000a">store</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a> + pp-&gt;<a class="code" href="structccnr__parsed__policy.html#a35998dadb60a54db4336b4a39408a014">global_prefix_offset</a>,
<a name="l00280"></a>00280                        NULL, 0);    
<a name="l00281"></a>00281     <span class="keywordflow">for</span> (i = 0; i &lt; pp-&gt;<a class="code" href="structccnr__parsed__policy.html#ac99ba64a37e3071da89dfea097f73d97">namespaces</a>-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a>; i++) {
<a name="l00282"></a>00282         <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, sdfdf, <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>))
<a name="l00283"></a>00283             <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;Removing listener for policy namespace %s&quot;</span>,
<a name="l00284"></a>00284                      (<span class="keywordtype">char</span> *)pp-&gt;<a class="code" href="structccnr__parsed__policy.html#a34b84b739cf9e12c772529935772000a">store</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a> + pp-&gt;<a class="code" href="structccnr__parsed__policy.html#ac99ba64a37e3071da89dfea097f73d97">namespaces</a>-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[i]);
<a name="l00285"></a>00285         <a class="code" href="ccnr__proto_8c.html#aee367dfd2b8af67d21bcc3ece4db5b06">r_proto_uri_listen</a>(ccnr, ccnr-&gt;<a class="code" href="structccnr__handle.html#aa358b4c6941900d7e02a620bf1e601b5" title="this talks directly with ccnd">direct_client</a>,
<a name="l00286"></a>00286                            (<span class="keywordtype">char</span> *)pp-&gt;<a class="code" href="structccnr__parsed__policy.html#a34b84b739cf9e12c772529935772000a">store</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a> + pp-&gt;<a class="code" href="structccnr__parsed__policy.html#ac99ba64a37e3071da89dfea097f73d97">namespaces</a>-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[i],
<a name="l00287"></a>00287                            NULL, 0);
<a name="l00288"></a>00288     }
<a name="l00289"></a>00289     
<a name="l00290"></a>00290 }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292 <span class="comment"></span>
<a name="l00293"></a>00293 <span class="comment">/**</span>
<a name="l00294"></a>00294 <span class="comment"> * Construct a charbuf with an encoding of a RepositoryInfo</span>
<a name="l00295"></a>00295 <span class="comment"> */</span> 
<a name="l00296"></a>00296 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keywordtype">int</span>
<a name="l00297"></a><a class="code" href="ccnr__proto_8h.html#ab77294f0d164080bc383c2f80a290a1a">00297</a> <a class="code" href="ccnr__proto_8c.html#a9b4a35b4d6f63e221a2238c2024ef911" title="Construct a charbuf with an encoding of a RepositoryInfo.">r_proto_append_repo_info</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *ccnr,
<a name="l00298"></a>00298                          <span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *rinfo,
<a name="l00299"></a>00299                          <span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *names,
<a name="l00300"></a>00300                          <span class="keyword">const</span> <span class="keywordtype">char</span> *info) {
<a name="l00301"></a>00301     <span class="keywordtype">int</span> res;
<a name="l00302"></a>00302     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00303"></a>00303     <span class="keywordflow">if</span> (name == NULL) <span class="keywordflow">return</span> (-1);
<a name="l00304"></a>00304     res = <a class="code" href="ccn_8h.html#afc2eb536e63f315968abe901e52b506a" title="Append a start-of-element marker.">ccnb_element_begin</a>(rinfo, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33ac1199d5c5fdd1bbb8262eba5e5822288">CCN_DTAG_RepositoryInfo</a>);
<a name="l00305"></a>00305     res |= <a class="code" href="ccn_8h.html#a10b8c6dc48e4640be33c90d983d3cb81" title="Append a tagged UDATA string, with printf-style formatting.">ccnb_tagged_putf</a>(rinfo, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a3d3ce6b81589bfaedc73c3052c421a18">CCN_DTAG_Version</a>, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;1.1&quot;</span>);
<a name="l00306"></a>00306     res |= <a class="code" href="ccn_8h.html#a10b8c6dc48e4640be33c90d983d3cb81" title="Append a tagged UDATA string, with printf-style formatting.">ccnb_tagged_putf</a>(rinfo, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a5ab3eca9eef2fe669ea334060f64ea95">CCN_DTAG_Type</a>, <span class="stringliteral">&quot;%s&quot;</span>, (names != NULL) ? <span class="stringliteral">&quot;DATA&quot;</span> : <span class="stringliteral">&quot;INFO&quot;</span>);
<a name="l00307"></a>00307     res |= <a class="code" href="ccn_8h.html#a10b8c6dc48e4640be33c90d983d3cb81" title="Append a tagged UDATA string, with printf-style formatting.">ccnb_tagged_putf</a>(rinfo, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a6d79f740a3f6e616394d5b01bb840b2d">CCN_DTAG_RepositoryVersion</a>, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;2.0&quot;</span>);
<a name="l00308"></a>00308     res |= <a class="code" href="ccn_8h.html#afc2eb536e63f315968abe901e52b506a" title="Append a start-of-element marker.">ccnb_element_begin</a>(rinfo, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a731a6aa6d25bcb774a0960151597e89e">CCN_DTAG_GlobalPrefixName</a>); <span class="comment">// same structure as Name</span>
<a name="l00309"></a>00309     res |= <a class="code" href="ccn_8h.html#aa46b72f2e6b3b7f7753ff3baaa4efdf8" title="Append an end-of-element marker.">ccnb_element_end</a>(rinfo);
<a name="l00310"></a>00310     <a class="code" href="ccn_8h.html#a4aa75ce6fc675e7a4c4c6d65e68817bd" title="Reset charbuf to represent an empty Name in binary format.">ccn_name_init</a>(name);
<a name="l00311"></a>00311     res |= <a class="code" href="uri_8h.html#a7b960a7f4f9e3f8175ff05f191452104" title="Convert a ccnx-scheme URI to a ccnb-encoded Name.">ccn_name_from_uri</a>(name, (<span class="keywordtype">char</span> *)ccnr-&gt;<a class="code" href="structccnr__handle.html#ae020455f28f9cc162243c81de19bc0ba" title="offsets for parsed fields of policy">parsed_policy</a>-&gt;<a class="code" href="structccnr__parsed__policy.html#a34b84b739cf9e12c772529935772000a">store</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a> + ccnr-&gt;<a class="code" href="structccnr__handle.html#ae020455f28f9cc162243c81de19bc0ba" title="offsets for parsed fields of policy">parsed_policy</a>-&gt;<a class="code" href="structccnr__parsed__policy.html#a35998dadb60a54db4336b4a39408a014">global_prefix_offset</a>);
<a name="l00312"></a>00312     res |= <a class="code" href="ccn_8h.html#a8ea2cc78c18c1aa99f12f44bd70bc7a1" title="Add sequence of ccnb-encoded Components to a ccnb-encoded Name.">ccn_name_append_components</a>(rinfo, name-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, 1, name-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> - 1);
<a name="l00313"></a>00313     res |= <a class="code" href="ccn_8h.html#a10b8c6dc48e4640be33c90d983d3cb81" title="Append a tagged UDATA string, with printf-style formatting.">ccnb_tagged_putf</a>(rinfo, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a9d7d538fe45251356a18e7693a811a7b">CCN_DTAG_LocalName</a>, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;Repository&quot;</span>);
<a name="l00314"></a>00314     <span class="keywordflow">if</span> (names != NULL)
<a name="l00315"></a>00315         res |= <a class="code" href="charbuf_8h.html#aca88638b2e81602eb4a1da9be923dad7">ccn_charbuf_append_charbuf</a>(rinfo, names);
<a name="l00316"></a>00316     <span class="keywordflow">if</span> (info != NULL)
<a name="l00317"></a>00317         res |= <a class="code" href="ccn_8h.html#a10b8c6dc48e4640be33c90d983d3cb81" title="Append a tagged UDATA string, with printf-style formatting.">ccnb_tagged_putf</a>(rinfo, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a0a7072cc5c13c2c1aa12cb492444664a">CCN_DTAG_InfoString</a>, <span class="stringliteral">&quot;%s&quot;</span>, info);
<a name="l00318"></a>00318     <span class="comment">// There is an optional CCN_DTAG_InfoString in the encoding here, like the LocalName</span>
<a name="l00319"></a>00319     res |= <a class="code" href="ccn_8h.html#aa46b72f2e6b3b7f7753ff3baaa4efdf8" title="Append an end-of-element marker.">ccnb_element_end</a>(rinfo); <span class="comment">// CCN_DTAG_RepositoryInfo</span>
<a name="l00320"></a>00320     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l00321"></a>00321     <span class="keywordflow">return</span> (res);
<a name="l00322"></a>00322 }
<a name="l00323"></a>00323 
<a name="l00324"></a>00324 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *
<a name="l00325"></a><a class="code" href="ccnr__proto_8c.html#ae9fb0cd62eca64538e77a1682f1e25fe">00325</a> <a class="code" href="ccnr__proto_8c.html#ae9fb0cd62eca64538e77a1682f1e25fe">r_proto_mktemplate</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__expect__content.html">ccnr_expect_content</a> *md, <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info)
<a name="l00326"></a>00326 {
<a name="l00327"></a>00327     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *templ = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00328"></a>00328     <a class="code" href="ccn_8h.html#afc2eb536e63f315968abe901e52b506a" title="Append a start-of-element marker.">ccnb_element_begin</a>(templ, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33ac3c02bb032cd835a5f9e439cadd0a455">CCN_DTAG_Interest</a>); <span class="comment">// same structure as Name</span>
<a name="l00329"></a>00329     <a class="code" href="ccn_8h.html#afc2eb536e63f315968abe901e52b506a" title="Append a start-of-element marker.">ccnb_element_begin</a>(templ, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a7903556a9a07652962c02014f7f7832f">CCN_DTAG_Name</a>);
<a name="l00330"></a>00330     <a class="code" href="ccn_8h.html#aa46b72f2e6b3b7f7753ff3baaa4efdf8" title="Append an end-of-element marker.">ccnb_element_end</a>(templ); <span class="comment">/* &lt;/Name&gt; */</span>
<a name="l00331"></a>00331     <span class="comment">// XXX - use pubid if possible</span>
<a name="l00332"></a>00332     <span class="comment">// XXX - if start-write was scoped, use scope here?</span>
<a name="l00333"></a>00333     <a class="code" href="ccn_8h.html#a10b8c6dc48e4640be33c90d983d3cb81" title="Append a tagged UDATA string, with printf-style formatting.">ccnb_tagged_putf</a>(templ, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a9f6129895fd850c53ef3727b4660a3ff">CCN_DTAG_MinSuffixComponents</a>, <span class="stringliteral">&quot;%d&quot;</span>, 1);
<a name="l00334"></a>00334     <a class="code" href="ccn_8h.html#a10b8c6dc48e4640be33c90d983d3cb81" title="Append a tagged UDATA string, with printf-style formatting.">ccnb_tagged_putf</a>(templ, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a7aad87e03f0facd444ae112ec6beaf84">CCN_DTAG_MaxSuffixComponents</a>, <span class="stringliteral">&quot;%d&quot;</span>, 1);
<a name="l00335"></a>00335     <a class="code" href="ccn_8h.html#aa46b72f2e6b3b7f7753ff3baaa4efdf8" title="Append an end-of-element marker.">ccnb_element_end</a>(templ); <span class="comment">/* &lt;/Interest&gt; */</span>
<a name="l00336"></a>00336     <span class="keywordflow">return</span>(templ);
<a name="l00337"></a>00337 }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a>
<a name="l00340"></a><a class="code" href="ccnr__proto_8h.html#a4e869bba021517ccbe0fa1c9097bb9aa">00340</a> <a class="code" href="ccnr__proto_8c.html#a7022342c3a0054757ce160533385ee77">r_proto_expect_content</a>(<span class="keyword">struct</span> <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *selfp,
<a name="l00341"></a>00341                  <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92" title="This tells what kind of event the upcall is handling.">ccn_upcall_kind</a> kind,
<a name="l00342"></a>00342                  <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info)
<a name="l00343"></a>00343 {
<a name="l00344"></a>00344     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = NULL;
<a name="l00345"></a>00345     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *templ = NULL;
<a name="l00346"></a>00346     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *ccnb = NULL;
<a name="l00347"></a>00347     <span class="keywordtype">size_t</span> ccnb_size = 0;
<a name="l00348"></a>00348     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *ib = NULL; <span class="comment">/* info-&gt;interest_ccnb */</span>
<a name="l00349"></a>00349     <span class="keyword">struct </span><a class="code" href="structccn__indexbuf.html">ccn_indexbuf</a> *ic = NULL;
<a name="l00350"></a>00350     <span class="keywordtype">int</span> res;
<a name="l00351"></a>00351     <span class="keyword">struct </span><a class="code" href="structccnr__expect__content.html">ccnr_expect_content</a> *md = selfp-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a>;
<a name="l00352"></a>00352     <span class="keyword">struct </span><a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *ccnr = NULL;
<a name="l00353"></a>00353     <span class="keyword">struct </span><a class="code" href="structcontent__entry.html" title="The content hash table is keyed by the initial portion of the ContentObject that...">content_entry</a> *content = NULL;
<a name="l00354"></a>00354     <span class="keywordtype">int</span> i;
<a name="l00355"></a>00355     <span class="keywordtype">int</span> empty_slots;
<a name="l00356"></a>00356     intmax_t segment;
<a name="l00357"></a>00357 
<a name="l00358"></a>00358     <span class="keywordflow">if</span> (kind == <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92ad00afdf8a89c718f4c451600b115b5e0" title="handler is about to be deregistered">CCN_UPCALL_FINAL</a>) {
<a name="l00359"></a>00359         <span class="keywordflow">if</span> (md != NULL) {
<a name="l00360"></a>00360             selfp-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a> = NULL;
<a name="l00361"></a>00361             free(md);
<a name="l00362"></a>00362             md = NULL;
<a name="l00363"></a>00363         }
<a name="l00364"></a>00364         free(selfp);
<a name="l00365"></a>00365         <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcadadb47635316f12c6542c33cebcfa727" title="normal upcall return">CCN_UPCALL_RESULT_OK</a>);
<a name="l00366"></a>00366     }
<a name="l00367"></a>00367     <span class="keywordflow">if</span> (md == NULL) {
<a name="l00368"></a>00368         <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>);
<a name="l00369"></a>00369     }
<a name="l00370"></a>00370     <span class="keywordflow">if</span> (md-&gt;<a class="code" href="structccnr__expect__content.html#a46fceaf340645989b95679cd88cde7a0" title="counter so we can give up eventually">done</a>)
<a name="l00371"></a>00371         <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>);
<a name="l00372"></a>00372     ccnr = (<span class="keyword">struct </span><a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *)md-&gt;<a class="code" href="structccnr__expect__content.html#a0927ea54848de19b025c85db8da4c9a0">ccnr</a>;
<a name="l00373"></a>00373     if (kind == <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a3c7ef9861eb5ba1529b4d05630e83c88" title="interest timed out">CCN_UPCALL_INTEREST_TIMED_OUT</a>) {
<a name="l00374"></a>00374         <span class="keywordflow">if</span> (md-&gt;<a class="code" href="structccnr__expect__content.html#adac55476405dcf0c618fa3754d3b8194">tries</a> &gt; <a class="code" href="ccnr__proto_8c.html#a5c5ac86d3f39a8829512117348e9a0fc">CCNR_MAX_RETRY</a>) {
<a name="l00375"></a>00375             <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;fetch_failed&quot;</span>, NULL,
<a name="l00376"></a>00376                             info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ae3500edfbd06a2be152e0ef8fcc64328">CCN_PI_E</a>]);
<a name="l00377"></a>00377             <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>);
<a name="l00378"></a>00378         }
<a name="l00379"></a>00379         md-&gt;<a class="code" href="structccnr__expect__content.html#adac55476405dcf0c618fa3754d3b8194">tries</a>++;
<a name="l00380"></a>00380         <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca686785df48ac222ef31beea39eebd404" title="reexpress the same interest again">CCN_UPCALL_RESULT_REEXPRESS</a>);
<a name="l00381"></a>00381     }
<a name="l00382"></a>00382     <span class="keywordflow">if</span> (kind == <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a8db121649c55820013bfaaf65e436f5c" title="content that has not been verified">CCN_UPCALL_CONTENT_UNVERIFIED</a>) {
<a name="l00383"></a>00383         <span class="comment">// XXX - Some forms of key locator can confuse libccn. Don&#39;t provoke it to fetch keys until that is hardened.</span>
<a name="l00384"></a>00384         <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, sdfdf, <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>))
<a name="l00385"></a>00385             <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;key_needed&quot;</span>, NULL, info-&gt;<a class="code" href="structccn__upcall__info.html#a226aa6acbc2fe85ee7d400b52ef3664a">content_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a5483525206dfb80f831040d0d9602906">pco</a>-&gt;<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387a1d25adf694c64b4ae597b26abe6b30fc">CCN_PCO_E</a>]);
<a name="l00386"></a>00386     }
<a name="l00387"></a>00387     <span class="keywordflow">switch</span> (kind) {
<a name="l00388"></a>00388         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a28260b0a25b7046e6930f0b13a718db0" title="incoming verified content">CCN_UPCALL_CONTENT</a>:
<a name="l00389"></a>00389         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a8db121649c55820013bfaaf65e436f5c" title="content that has not been verified">CCN_UPCALL_CONTENT_UNVERIFIED</a>:
<a name="l00390"></a>00390 <span class="preprocessor">#if (CCN_API_VERSION &gt;= 4004)</span>
<a name="l00391"></a>00391 <span class="preprocessor"></span>        <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92aa96e60c7c64a5a65145b918cf6fcb4b4" title="verification has not been attempted">CCN_UPCALL_CONTENT_RAW</a>:
<a name="l00392"></a>00392         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a1b0d17f15edd2e43d9a026d19498ab7c" title="key has not been fetched">CCN_UPCALL_CONTENT_KEYMISSING</a>:
<a name="l00393"></a>00393 <span class="preprocessor">#endif</span>
<a name="l00394"></a>00394 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
<a name="l00395"></a>00395         <span class="keywordflow">default</span>:
<a name="l00396"></a>00396             <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>);
<a name="l00397"></a>00397     }
<a name="l00398"></a>00398     
<a name="l00399"></a>00399     ccnb = info-&gt;<a class="code" href="structccn__upcall__info.html#a226aa6acbc2fe85ee7d400b52ef3664a">content_ccnb</a>;
<a name="l00400"></a>00400     ccnb_size = info-&gt;<a class="code" href="structccn__upcall__info.html#a5483525206dfb80f831040d0d9602906">pco</a>-&gt;<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387a1d25adf694c64b4ae597b26abe6b30fc">CCN_PCO_E</a>];
<a name="l00401"></a>00401     ib = info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>;
<a name="l00402"></a>00402     ic = info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>;
<a name="l00403"></a>00403     
<a name="l00404"></a>00404     content = <a class="code" href="ccnd_8c.html#a1fb68071f82867c2e54101a1171b3206" title="Process an arriving ContentObject.">process_incoming_content</a>(ccnr, <a class="code" href="ccnr__io_8c.html#ad9ca4dc679b9aa962638ae2c0ad9c68f" title="Looks up a fdholder based on its filedesc (private).">r_io_fdholder_from_fd</a>(ccnr, <a class="code" href="ccn_8h.html#a932df0f9c232ae47f06cd1db35ac1472">ccn_get_connection_fd</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>)),
<a name="l00405"></a>00405                                        (<span class="keywordtype">void</span> *)ccnb, ccnb_size, NULL);
<a name="l00406"></a>00406     <span class="keywordflow">if</span> (content == NULL) {
<a name="l00407"></a>00407         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;r_proto_expect_content: failed to process incoming content&quot;</span>);
<a name="l00408"></a>00408         <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>);
<a name="l00409"></a>00409     }
<a name="l00410"></a>00410     <a class="code" href="ccnr__store_8c.html#afb4f3bb1e938ab7384fc10370de8413c">r_store_commit_content</a>(ccnr, content);
<a name="l00411"></a>00411     <a class="code" href="ccnr__proto_8c.html#a22346544e87a567a668c08a4f722fe21" title="Initiate a key fetch if necessary.">r_proto_initiate_key_fetch</a>(ccnr, ccnb, info-&gt;<a class="code" href="structccn__upcall__info.html#a5483525206dfb80f831040d0d9602906">pco</a>, 0,
<a name="l00412"></a>00412                                <a class="code" href="ccnr__store_8c.html#a70e87f04b52f42d0f5563242e3245e92">r_store_content_cookie</a>(ccnr, content));
<a name="l00413"></a>00413     
<a name="l00414"></a>00414     md-&gt;<a class="code" href="structccnr__expect__content.html#adac55476405dcf0c618fa3754d3b8194">tries</a> = 0;
<a name="l00415"></a>00415     segment = <a class="code" href="ccnr__util_8c.html#a244ec75af79d7bea5ec7806a6bea7315">r_util_segment_from_component</a>(ib, ic-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[ic-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a> - 2], ic-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[ic-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a> - 1]);
<a name="l00416"></a>00416 
<a name="l00417"></a>00417     <span class="keywordflow">if</span> (<a class="code" href="ccn_8h.html#ad0c040bf9d94a14c2749fb21e6024857" title="Check whether content described by info is final block.">ccn_is_final_block</a>(info) == 1)
<a name="l00418"></a>00418         md-&gt;<a class="code" href="structccnr__expect__content.html#a913c369889b2639768a862a4cca6b27c">final</a> = segment;
<a name="l00419"></a>00419     
<a name="l00420"></a>00420     <span class="keywordflow">if</span> (md-&gt;<a class="code" href="structccnr__expect__content.html#acbedb43501cfd7904e3af9cdc64d79b0">keyfetch</a> != 0 &amp;&amp; segment &lt;= 0) {
<a name="l00421"></a>00421         <span class="comment">/* This should either be a key, or a link to get to it. */</span>
<a name="l00422"></a>00422         <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structccn__upcall__info.html#a5483525206dfb80f831040d0d9602906">pco</a>-&gt;<a class="code" href="structccn__parsed___content_object.html#a95f6fd64d36fcc6fee3d2770c9cc2ac7">type</a> == <a class="code" href="ccn_8h.html#a5ac452b850189ae724c4ff89ae81c702a0055466cba309d1764f3e428dd1fc059">CCN_CONTENT_LINK</a>) {
<a name="l00423"></a>00423             <a class="code" href="ccnr__proto_8c.html#a22346544e87a567a668c08a4f722fe21" title="Initiate a key fetch if necessary.">r_proto_initiate_key_fetch</a>(ccnr, ccnb, info-&gt;<a class="code" href="structccn__upcall__info.html#a5483525206dfb80f831040d0d9602906">pco</a>, 1, md-&gt;<a class="code" href="structccnr__expect__content.html#acbedb43501cfd7904e3af9cdc64d79b0">keyfetch</a>);
<a name="l00424"></a>00424         }
<a name="l00425"></a>00425         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structccn__upcall__info.html#a5483525206dfb80f831040d0d9602906">pco</a>-&gt;<a class="code" href="structccn__parsed___content_object.html#a95f6fd64d36fcc6fee3d2770c9cc2ac7">type</a> == <a class="code" href="ccn_8h.html#a5ac452b850189ae724c4ff89ae81c702ac721241f29c64d4acd212497a30b362c">CCN_CONTENT_KEY</a>) {
<a name="l00426"></a>00426             <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, sdfdf, <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>))
<a name="l00427"></a>00427                 <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;key_arrived %u&quot;</span>, (<span class="keywordtype">unsigned</span>)(md-&gt;<a class="code" href="structccnr__expect__content.html#acbedb43501cfd7904e3af9cdc64d79b0">keyfetch</a>));
<a name="l00428"></a>00428             <span class="comment">// XXX - should check that we got the right key.</span>
<a name="l00429"></a>00429         }
<a name="l00430"></a>00430         <span class="keywordflow">else</span> {
<a name="l00431"></a>00431             <span class="comment">// not a key or a link.  Log it so we have a clue.</span>
<a name="l00432"></a>00432             <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;ERROR - got something else when trying to fetch key for item %u&quot;</span>, (<span class="keywordtype">unsigned</span>)(md-&gt;<a class="code" href="structccnr__expect__content.html#acbedb43501cfd7904e3af9cdc64d79b0">keyfetch</a>));
<a name="l00433"></a>00433         }
<a name="l00434"></a>00434     }
<a name="l00435"></a>00435     
<a name="l00436"></a>00436     <span class="comment">// Unsegmented content should skip pipeline processing.</span>
<a name="l00437"></a>00437     <span class="keywordflow">if</span> (segment &lt; 0) {
<a name="l00438"></a>00438         <span class="keywordflow">if</span> (md-&gt;<a class="code" href="structccnr__expect__content.html#a2c61889eb0ed7569beab10a2e137f229">expect_complete</a> != NULL) {
<a name="l00439"></a>00439             (md-&gt;<a class="code" href="structccnr__expect__content.html#a2c61889eb0ed7569beab10a2e137f229">expect_complete</a>)(selfp, kind, info);
<a name="l00440"></a>00440         }
<a name="l00441"></a>00441         <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcadadb47635316f12c6542c33cebcfa727" title="normal upcall return">CCN_UPCALL_RESULT_OK</a>);
<a name="l00442"></a>00442     }
<a name="l00443"></a>00443     
<a name="l00444"></a>00444     <span class="comment">/* retire the current segment and any segments beyond the final one */</span>
<a name="l00445"></a>00445     empty_slots = 0;
<a name="l00446"></a>00446     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="ccnr__proto_8h.html#a2a08063e993e3cb158ffe7647f6ebc2e">CCNR_PIPELINE</a>; i++) {
<a name="l00447"></a>00447         <span class="keywordflow">if</span> (md-&gt;<a class="code" href="structccnr__expect__content.html#a4329ad176aba312a03834c5f7f060c0a">outstanding</a>[i] == segment || ((md-&gt;<a class="code" href="structccnr__expect__content.html#a913c369889b2639768a862a4cca6b27c">final</a> &gt; -1) &amp;&amp; (md-&gt;<a class="code" href="structccnr__expect__content.html#a4329ad176aba312a03834c5f7f060c0a">outstanding</a>[i] &gt; md-&gt;<a class="code" href="structccnr__expect__content.html#a913c369889b2639768a862a4cca6b27c">final</a>)))
<a name="l00448"></a>00448             md-&gt;<a class="code" href="structccnr__expect__content.html#a4329ad176aba312a03834c5f7f060c0a">outstanding</a>[i] = -1;
<a name="l00449"></a>00449         if (md-&gt;<a class="code" href="structccnr__expect__content.html#a4329ad176aba312a03834c5f7f060c0a">outstanding</a>[i] == -1)
<a name="l00450"></a>00450             empty_slots++;
<a name="l00451"></a>00451     
<a name="l00452"></a>00452     }
<a name="l00453"></a>00453     md-&gt;<a class="code" href="structccnr__expect__content.html#a46fceaf340645989b95679cd88cde7a0" title="counter so we can give up eventually">done</a> = (md-&gt;<a class="code" href="structccnr__expect__content.html#a913c369889b2639768a862a4cca6b27c">final</a> &gt; -1) &amp;&amp; (empty_slots == CCNR_PIPELINE);
<a name="l00454"></a>00454     <span class="comment">// if there is a completion handler set up, and we&#39;ve got all the blocks</span>
<a name="l00455"></a>00455     <span class="comment">// call it -- note that this may not be the last block if they arrive out of order.</span>
<a name="l00456"></a>00456     <span class="keywordflow">if</span> (md-&gt;<a class="code" href="structccnr__expect__content.html#a46fceaf340645989b95679cd88cde7a0" title="counter so we can give up eventually">done</a> &amp;&amp; (md-&gt;<a class="code" href="structccnr__expect__content.html#a2c61889eb0ed7569beab10a2e137f229">expect_complete</a> != NULL))
<a name="l00457"></a>00457         (md-&gt;<a class="code" href="structccnr__expect__content.html#a2c61889eb0ed7569beab10a2e137f229">expect_complete</a>)(selfp, kind, info);
<a name="l00458"></a>00458                               
<a name="l00459"></a>00459     <span class="keywordflow">if</span> (md-&gt;<a class="code" href="structccnr__expect__content.html#a913c369889b2639768a862a4cca6b27c">final</a> &gt; -1) {
<a name="l00460"></a>00460         <span class="keywordflow">return</span> (<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcadadb47635316f12c6542c33cebcfa727" title="normal upcall return">CCN_UPCALL_RESULT_OK</a>);
<a name="l00461"></a>00461     }
<a name="l00462"></a>00462 
<a name="l00463"></a>00463     name = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00464"></a>00464     <span class="keywordflow">if</span> (ic-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a> &lt; 2) abort();    
<a name="l00465"></a>00465     templ = <a class="code" href="ccnr__proto_8c.html#ae9fb0cd62eca64538e77a1682f1e25fe">r_proto_mktemplate</a>(md, info);
<a name="l00466"></a>00466     <span class="comment">/* fill the pipeline with new requests */</span>
<a name="l00467"></a>00467     <span class="keywordflow">for</span> (i = 0; i &lt; CCNR_PIPELINE; i++) {
<a name="l00468"></a>00468         <span class="keywordflow">if</span> (md-&gt;<a class="code" href="structccnr__expect__content.html#a4329ad176aba312a03834c5f7f060c0a">outstanding</a>[i] == -1) {
<a name="l00469"></a>00469             <a class="code" href="ccn_8h.html#a4aa75ce6fc675e7a4c4c6d65e68817bd" title="Reset charbuf to represent an empty Name in binary format.">ccn_name_init</a>(name);
<a name="l00470"></a>00470             res = <a class="code" href="ccn_8h.html#a8ea2cc78c18c1aa99f12f44bd70bc7a1" title="Add sequence of ccnb-encoded Components to a ccnb-encoded Name.">ccn_name_append_components</a>(name, ib, ic-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[0], ic-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[ic-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a> - 2]);
<a name="l00471"></a>00471             <span class="keywordflow">if</span> (res &lt; 0) abort();
<a name="l00472"></a>00472             <a class="code" href="ccn_8h.html#a3b95a770555b90f43d4876bea62c202d" title="Add a binary Component to a ccnb-encoded Name.">ccn_name_append_numeric</a>(name, <a class="code" href="ccn_8h.html#afec910e39c89dcf24a44f93e97032399af3eb8e7fa3a938a5bcc6c1f141357d71" title="consecutive block sequence numbers">CCN_MARKER_SEQNUM</a>, ++(selfp-&gt;<a class="code" href="structccn__closure.html#a25a1e0591079ef386d0708a81f14b711" title="for client use">intdata</a>));
<a name="l00473"></a>00473             res = <a class="code" href="ccn_8h.html#a9f2d6eede46c8aac3dbb4b6e22e1d492">ccn_express_interest</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, name, selfp, templ);
<a name="l00474"></a>00474             <span class="keywordflow">if</span> (res &lt; 0) abort();
<a name="l00475"></a>00475             md-&gt;<a class="code" href="structccnr__expect__content.html#a4329ad176aba312a03834c5f7f060c0a">outstanding</a>[i] = selfp-&gt;<a class="code" href="structccn__closure.html#a25a1e0591079ef386d0708a81f14b711" title="for client use">intdata</a>;
<a name="l00476"></a>00476         }
<a name="l00477"></a>00477     }
<a name="l00478"></a>00478     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;templ);
<a name="l00479"></a>00479     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l00480"></a>00480     
<a name="l00481"></a>00481     <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcadadb47635316f12c6542c33cebcfa727" title="normal upcall return">CCN_UPCALL_RESULT_OK</a>);
<a name="l00482"></a>00482 }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00485"></a><a class="code" href="ccnr__proto_8c.html#af2f1b5ff7ab1d71cf7f773d1e7ed8325">00485</a> <a class="code" href="ccnr__proto_8c.html#af2f1b5ff7ab1d71cf7f773d1e7ed8325">r_proto_policy_update</a>(<span class="keyword">struct</span> ccn_schedule *<a class="code" href="structccnr__handle.html#ae75f01e799058fbe52d154ebaa08ec52" title="our schedule">sched</a>,
<a name="l00486"></a>00486                       <span class="keywordtype">void</span> *clienth,
<a name="l00487"></a>00487                       <span class="keyword">struct</span> <a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev,
<a name="l00488"></a>00488                       <span class="keywordtype">int</span> flags)
<a name="l00489"></a>00489 {
<a name="l00490"></a>00490     <span class="keyword">struct </span><a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *ccnr = clienth;
<a name="l00491"></a>00491     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = ev-&gt;<a class="code" href="structccn__scheduled__event.html#a4f4c36335e9001eaca5442f672798e95">evdata</a>;
<a name="l00492"></a>00492     <span class="keyword">struct </span><a class="code" href="structcontent__entry.html" title="The content hash table is keyed by the initial portion of the ContentObject that...">content_entry</a> *content = NULL;
<a name="l00493"></a>00493     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *content_msg = NULL;
<a name="l00494"></a>00494     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *vers = NULL;
<a name="l00495"></a>00495     <span class="keywordtype">size_t</span> vers_size = 0;
<a name="l00496"></a>00496     <span class="keyword">struct </span><a class="code" href="structccn__parsed___content_object.html">ccn_parsed_ContentObject</a> pco = {0};
<a name="l00497"></a>00497     <span class="keyword">struct </span><a class="code" href="structccn__indexbuf.html">ccn_indexbuf</a> *nc;
<a name="l00498"></a>00498     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *policy = NULL;
<a name="l00499"></a>00499     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *policy_link_cob = NULL;
<a name="l00500"></a>00500     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *policyFileName = NULL;
<a name="l00501"></a>00501     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a> = NULL;
<a name="l00502"></a>00502     <span class="keywordtype">size_t</span> <a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> = 0;
<a name="l00503"></a>00503     <span class="keyword">struct </span><a class="code" href="structccnr__parsed__policy.html">ccnr_parsed_policy</a> *pp;
<a name="l00504"></a>00504     <span class="keywordtype">int</span> segment = -1;
<a name="l00505"></a>00505     <span class="keywordtype">int</span> <span class="keyword">final</span> = 0;
<a name="l00506"></a>00506     <span class="keywordtype">int</span> res;
<a name="l00507"></a>00507     <span class="keywordtype">int</span> ans = -1;
<a name="l00508"></a>00508     <span class="keywordtype">int</span> fd = -1;
<a name="l00509"></a>00509     
<a name="l00510"></a>00510     <span class="keywordflow">if</span> ((flags &amp; <a class="code" href="schedule_8h.html#a705b7a47118864084280c615c0e6a2de">CCN_SCHEDULE_CANCEL</a>) != 0) {
<a name="l00511"></a>00511         ans = 0;
<a name="l00512"></a>00512         <span class="keywordflow">goto</span> Bail;
<a name="l00513"></a>00513     }
<a name="l00514"></a>00514     
<a name="l00515"></a>00515     policy = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00516"></a>00516     nc = <a class="code" href="indexbuf_8h.html#a00ef00b3c7cbd2122bcdad019bd285c6" title="Create a new indexbuf.">ccn_indexbuf_create</a>();
<a name="l00517"></a>00517     <span class="keywordflow">do</span> {
<a name="l00518"></a>00518         <a class="code" href="ccn_8h.html#a3b95a770555b90f43d4876bea62c202d" title="Add a binary Component to a ccnb-encoded Name.">ccn_name_append_numeric</a>(name, <a class="code" href="ccn_8h.html#afec910e39c89dcf24a44f93e97032399af3eb8e7fa3a938a5bcc6c1f141357d71" title="consecutive block sequence numbers">CCN_MARKER_SEQNUM</a>, ++segment);
<a name="l00519"></a>00519         content = <a class="code" href="ccnr__store_8c.html#a18c07809591e2988b192125c1e92d260" title="Find the first content handle that matches the prefix given by the namish, which...">r_store_lookup_ccnb</a>(ccnr, name-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, name-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00520"></a>00520         <span class="keywordflow">if</span> (content == NULL) {
<a name="l00521"></a>00521             <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;policy lookup failed for&quot;</span>, NULL,
<a name="l00522"></a>00522                             name-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, name-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00523"></a>00523             <span class="keywordflow">goto</span> Bail;
<a name="l00524"></a>00524         }
<a name="l00525"></a>00525         <a class="code" href="ccn_8h.html#a79ca5ab3dd25aa67bf1949a440284978" title="Chop the name down to n components.">ccn_name_chop</a>(name, NULL, -1);
<a name="l00526"></a>00526         content_msg = <a class="code" href="ccnr__store_8c.html#aaae3d20273f3e24a347f97f29855fe8e" title="Get the base address of the content object.">r_store_content_base</a>(ccnr, content);
<a name="l00527"></a>00527         <span class="keywordflow">if</span> (content_msg == NULL) {
<a name="l00528"></a>00528             <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;Policy read failed for&quot;</span>, NULL,
<a name="l00529"></a>00529                             name-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, name-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00530"></a>00530             <span class="keywordflow">goto</span> Bail;            
<a name="l00531"></a>00531         }
<a name="l00532"></a>00532         res = <a class="code" href="ccn_8h.html#a464e10bcdb62aa8821df3ce27eb8c5aa">ccn_parse_ContentObject</a>(content_msg, <a class="code" href="ccnr__store_8c.html#a74b4e2f1e9f862f9d39db49e8d19e499">r_store_content_size</a>(ccnr, content), &amp;pco, nc);
<a name="l00533"></a>00533         res = <a class="code" href="ccn_8h.html#af630540ae5874ba0b17f1960482a85a9">ccn_ref_tagged_BLOB</a>(<a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a576ac34793f75d0385da2e0125785555">CCN_DTAG_Content</a>, content_msg,
<a name="l00534"></a>00534                                   pco.<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387adcd495b5bdd02ccb3679ab3808b3a7c9">CCN_PCO_B_Content</a>],
<a name="l00535"></a>00535                                   pco.<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387ad17e965ebbdde723eb20d4f9484ecb3c">CCN_PCO_E_Content</a>],
<a name="l00536"></a>00536                                   &amp;buf, &amp;length);
<a name="l00537"></a>00537         <a class="code" href="charbuf_8h.html#a5cc5c1412e38c015951394fcd79e2f6e">ccn_charbuf_append</a>(policy, buf, length);
<a name="l00538"></a>00538         <span class="keyword">final</span> = <a class="code" href="ccn_8h.html#a7a69e02d715e2b652c4565de0f698d2f" title="Given a ccnb encoded content object, the parsed form, and name components report...">ccn_is_final_pco</a>(content_msg, &amp;pco, nc);
<a name="l00539"></a>00539     } <span class="keywordflow">while</span> (!<span class="keyword">final</span>);
<a name="l00540"></a>00540     
<a name="l00541"></a>00541     pp = <a class="code" href="ccnr__init_8c.html#a93e8efca83f7274b89997d40bfb6fc79">ccnr_parsed_policy_create</a>();
<a name="l00542"></a>00542     <span class="keywordflow">if</span> (pp == NULL) {
<a name="l00543"></a>00543         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;Parsed policy allocation error&quot;</span>);
<a name="l00544"></a>00544         <span class="keywordflow">goto</span> Bail;
<a name="l00545"></a>00545     }
<a name="l00546"></a>00546     memmove(pp-&gt;<a class="code" href="structccnr__parsed__policy.html#a964c7f90e51dbdcc00387468ec8e7a3b">version</a>, vers, vers_size);
<a name="l00547"></a>00547     <span class="keywordflow">if</span> (<a class="code" href="ccnr__proto_8c.html#a1fd5a3888c075ae928fe02b60bba3a29" title="Parse a ccnb-encoded policy content object and fill in a ccn_parsed_policy structure...">r_proto_parse_policy</a>(ccnr, policy-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, policy-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, pp) &lt; 0) {
<a name="l00548"></a>00548         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;Malformed policy&quot;</span>);
<a name="l00549"></a>00549         <span class="keywordflow">goto</span> Bail;
<a name="l00550"></a>00550     }
<a name="l00551"></a>00551     res = strcmp((<span class="keywordtype">char</span> *)pp-&gt;<a class="code" href="structccnr__parsed__policy.html#a34b84b739cf9e12c772529935772000a">store</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a> + pp-&gt;<a class="code" href="structccnr__parsed__policy.html#a35998dadb60a54db4336b4a39408a014">global_prefix_offset</a>,
<a name="l00552"></a>00552                  (<span class="keywordtype">char</span> *)ccnr-&gt;<a class="code" href="structccnr__handle.html#ae020455f28f9cc162243c81de19bc0ba" title="offsets for parsed fields of policy">parsed_policy</a>-&gt;<a class="code" href="structccnr__parsed__policy.html#a34b84b739cf9e12c772529935772000a">store</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a> + ccnr-&gt;<a class="code" href="structccnr__handle.html#ae020455f28f9cc162243c81de19bc0ba" title="offsets for parsed fields of policy">parsed_policy</a>-&gt;<a class="code" href="structccnr__parsed__policy.html#a35998dadb60a54db4336b4a39408a014">global_prefix_offset</a>);
<a name="l00553"></a>00553     <span class="keywordflow">if</span> (0 != res) {
<a name="l00554"></a>00554         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;Policy global prefix mismatch&quot;</span>);
<a name="l00555"></a>00555         <span class="keywordflow">goto</span> Bail;
<a name="l00556"></a>00556     }
<a name="l00557"></a>00557     policy_link_cob = <a class="code" href="ccnr__init_8c.html#a8aa80f8e885eb1682efc93681a6c8108" title="should probably return a new cob, rather than reusing one.">ccnr_init_policy_link_cob</a>(ccnr, ccnr-&gt;<a class="code" href="structccnr__handle.html#aa358b4c6941900d7e02a620bf1e601b5" title="this talks directly with ccnd">direct_client</a>, name);
<a name="l00558"></a>00558     <span class="keywordflow">if</span> (policy_link_cob != NULL) {
<a name="l00559"></a>00559         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;ccnr-&gt;<a class="code" href="structccnr__handle.html#a4854a2e3b20d7c7abb820ca815bf9d82">policy_link_cob</a>);
<a name="l00560"></a>00560         ccnr-&gt;<a class="code" href="structccnr__handle.html#a4854a2e3b20d7c7abb820ca815bf9d82">policy_link_cob</a> = policy_link_cob;
<a name="l00561"></a>00561     }
<a name="l00562"></a>00562     policyFileName = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00563"></a>00563     <a class="code" href="charbuf_8h.html#a942c4bc14fffdbacfbc0fb477b01125e">ccn_charbuf_putf</a>(policyFileName, <span class="stringliteral">&quot;%s/repoPolicy&quot;</span>, ccnr-&gt;<a class="code" href="structccnr__handle.html#ae3ca616edc1adffe6941a0d8113e434f" title="the repository directory">directory</a>);
<a name="l00564"></a>00564     fd = open(<a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(policyFileName), O_WRONLY | O_CREAT, 0666);
<a name="l00565"></a>00565     <span class="keywordflow">if</span> (fd &lt; 0) {
<a name="l00566"></a>00566         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;open policy: %s (errno = %d)&quot;</span>, strerror(errno), errno);
<a name="l00567"></a>00567         <span class="keywordflow">goto</span> Bail;
<a name="l00568"></a>00568     }
<a name="l00569"></a>00569     lseek(fd, 0, SEEK_SET);
<a name="l00570"></a>00570     res = write(fd, ccnr-&gt;<a class="code" href="structccnr__handle.html#a4854a2e3b20d7c7abb820ca815bf9d82">policy_link_cob</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, ccnr-&gt;<a class="code" href="structccnr__handle.html#a4854a2e3b20d7c7abb820ca815bf9d82">policy_link_cob</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00571"></a>00571     <span class="keywordflow">if</span> (res == -1) {
<a name="l00572"></a>00572         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;write policy: %s (errno = %d)&quot;</span>, strerror(errno), errno);
<a name="l00573"></a>00573         <span class="keywordflow">goto</span> Bail;
<a name="l00574"></a>00574     }
<a name="l00575"></a>00575     res = ftruncate(fd, ccnr-&gt;<a class="code" href="structccnr__handle.html#a4854a2e3b20d7c7abb820ca815bf9d82">policy_link_cob</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00576"></a>00576     <span class="keywordflow">if</span> (res == -1) {
<a name="l00577"></a>00577         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;Policy truncate %u :%s (errno = %d)&quot;</span>,
<a name="l00578"></a>00578                  fd, strerror(errno), errno);
<a name="l00579"></a>00579         <span class="keywordflow">goto</span> Bail;
<a name="l00580"></a>00580     }
<a name="l00581"></a>00581     close(fd);
<a name="l00582"></a>00582     fd = -1;
<a name="l00583"></a>00583     <a class="code" href="ccnr__proto_8c.html#a85c77667b1ec23d0940fdc72ae10c377" title="Uninstall the listener for the namespaces that the parsed policy says to serve.">r_proto_deactivate_policy</a>(ccnr, ccnr-&gt;<a class="code" href="structccnr__handle.html#ae020455f28f9cc162243c81de19bc0ba" title="offsets for parsed fields of policy">parsed_policy</a>);
<a name="l00584"></a>00584     <a class="code" href="ccnr__init_8c.html#a95ae1b2f994a6710087a176d0f5aa4f5">ccnr_parsed_policy_destroy</a>(&amp;ccnr-&gt;<a class="code" href="structccnr__handle.html#ae020455f28f9cc162243c81de19bc0ba" title="offsets for parsed fields of policy">parsed_policy</a>);
<a name="l00585"></a>00585     ccnr-&gt;<a class="code" href="structccnr__handle.html#ae020455f28f9cc162243c81de19bc0ba" title="offsets for parsed fields of policy">parsed_policy</a> = pp;
<a name="l00586"></a>00586     <a class="code" href="ccnr__proto_8c.html#a10e1f366d8ac499821f7dd09b777e9d0" title="Install the listener for the namespaces that the parsed policy says to serve.">r_proto_activate_policy</a>(ccnr, pp);
<a name="l00587"></a>00587     
<a name="l00588"></a>00588     ans = 0;
<a name="l00589"></a>00589     
<a name="l00590"></a>00590 Bail:
<a name="l00591"></a>00591     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l00592"></a>00592     <a class="code" href="indexbuf_8h.html#a85816e7765050ed93ccdd29210dabfaf" title="Deallocate indexbuf.">ccn_indexbuf_destroy</a>(&amp;nc);
<a name="l00593"></a>00593     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;policy);
<a name="l00594"></a>00594     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;policyFileName);
<a name="l00595"></a>00595     <span class="keywordflow">if</span> (fd &gt;= 0) close(fd);
<a name="l00596"></a>00596     <span class="keywordflow">return</span> (ans);
<a name="l00597"></a>00597     
<a name="l00598"></a>00598 }    
<a name="l00599"></a>00599 
<a name="l00600"></a>00600 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00601"></a><a class="code" href="ccnr__proto_8c.html#a5313a2e879fe5d452edb9f41c5935fc3">00601</a> <a class="code" href="ccnr__proto_8c.html#a5313a2e879fe5d452edb9f41c5935fc3">r_proto_policy_complete</a>(<span class="keyword">struct</span> <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *selfp,
<a name="l00602"></a>00602                         <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92" title="This tells what kind of event the upcall is handling.">ccn_upcall_kind</a> kind,
<a name="l00603"></a>00603                         <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info)
<a name="l00604"></a>00604 {
<a name="l00605"></a>00605     <span class="keyword">struct </span><a class="code" href="structccnr__expect__content.html">ccnr_expect_content</a> *md = selfp-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a>;
<a name="l00606"></a>00606     <span class="keyword">struct </span><a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *ccnr = (<span class="keyword">struct </span><a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *)md-&gt;<a class="code" href="structccnr__expect__content.html#a0927ea54848de19b025c85db8da4c9a0">ccnr</a>;
<a name="l00607"></a>00607     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *ccnb;
<a name="l00608"></a>00608     <span class="keywordtype">size_t</span> ccnb_size;
<a name="l00609"></a>00609     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *vers = NULL;
<a name="l00610"></a>00610     <span class="keywordtype">size_t</span> vers_size = 0;
<a name="l00611"></a>00611     <span class="keyword">struct</span> <a class="code" href="structccn__indexbuf.html">ccn_indexbuf</a> *cc;
<a name="l00612"></a>00612     <span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name;
<a name="l00613"></a>00613     <span class="keywordtype">int</span> res;
<a name="l00614"></a>00614     
<a name="l00615"></a>00615     <span class="comment">// the version of the new policy must be greater than the exist one</span>
<a name="l00616"></a>00616     <span class="comment">// or we will not activate it and update the link to point to it.</span>
<a name="l00617"></a>00617     
<a name="l00618"></a>00618     ccnb = info-&gt;<a class="code" href="structccn__upcall__info.html#a226aa6acbc2fe85ee7d400b52ef3664a">content_ccnb</a>;
<a name="l00619"></a>00619     ccnb_size = info-&gt;<a class="code" href="structccn__upcall__info.html#a5483525206dfb80f831040d0d9602906">pco</a>-&gt;<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387a1d25adf694c64b4ae597b26abe6b30fc">CCN_PCO_E</a>];
<a name="l00620"></a>00620     cc = info-&gt;<a class="code" href="structccn__upcall__info.html#a4cb4214256b27c8512dc5f9de87aa400">content_comps</a>;
<a name="l00621"></a>00621     <a class="code" href="ccn_8h.html#a70c13909ea45ffb1069916d7a512fdda" title="Extract a pointer to and size of component at given index i.">ccn_name_comp_get</a>(ccnb, cc, cc-&gt;n - 3, &amp;vers, &amp;vers_size);
<a name="l00622"></a>00622     <span class="keywordflow">if</span> (vers_size != 7 || vers[0] != <a class="code" href="ccn_8h.html#afec910e39c89dcf24a44f93e97032399a8b7274d49f90dd8d37f86d1ee8a20c6e" title="timestamp-based versioning">CCN_MARKER_VERSION</a>)
<a name="l00623"></a>00623         <span class="keywordflow">return</span>(-1);
<a name="l00624"></a>00624     <span class="keywordflow">if</span> (memcmp(vers, ccnr-&gt;<a class="code" href="structccnr__handle.html#ae020455f28f9cc162243c81de19bc0ba" title="offsets for parsed fields of policy">parsed_policy</a>-&gt;<a class="code" href="structccnr__parsed__policy.html#a964c7f90e51dbdcc00387468ec8e7a3b">version</a>, <span class="keyword">sizeof</span>(ccnr-&gt;<a class="code" href="structccnr__handle.html#ae020455f28f9cc162243c81de19bc0ba" title="offsets for parsed fields of policy">parsed_policy</a>-&gt;<a class="code" href="structccnr__parsed__policy.html#a964c7f90e51dbdcc00387468ec8e7a3b">version</a>)) &lt;= 0) {
<a name="l00625"></a>00625         <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a2d1e1fa6e4518cba402ea37d1b963d99">LM_128</a>, <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>))
<a name="l00626"></a>00626             <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;r_proto_policy_complete older policy ignored&quot;</span>, NULL,
<a name="l00627"></a>00627                             ccnb, ccnb_size);        
<a name="l00628"></a>00628         <span class="keywordflow">return</span> (-1);
<a name="l00629"></a>00629     }
<a name="l00630"></a>00630     <span class="comment">// all components not including segment</span>
<a name="l00631"></a>00631     name = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00632"></a>00632     res = <a class="code" href="ccn_8h.html#a4aa75ce6fc675e7a4c4c6d65e68817bd" title="Reset charbuf to represent an empty Name in binary format.">ccn_name_init</a>(name);
<a name="l00633"></a>00633     <a class="code" href="ccn_8h.html#a8ea2cc78c18c1aa99f12f44bd70bc7a1" title="Add sequence of ccnb-encoded Components to a ccnb-encoded Name.">ccn_name_append_components</a>(name, ccnb, cc-&gt;buf[0], cc-&gt;buf[cc-&gt;n - 2]);
<a name="l00634"></a>00634     <a class="code" href="schedule_8h.html#a1b46f1ba6b54371f41a5c160cd1604ba">ccn_schedule_event</a>(ccnr-&gt;<a class="code" href="structccnr__handle.html#ae75f01e799058fbe52d154ebaa08ec52" title="our schedule">sched</a>, 500, <a class="code" href="ccnr__proto_8c.html#af2f1b5ff7ab1d71cf7f773d1e7ed8325">r_proto_policy_update</a>, name, 0);
<a name="l00635"></a>00635     <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a2d1e1fa6e4518cba402ea37d1b963d99">LM_128</a>, <a class="code" href="loglevels_8h.html#ac0d8d64571564474f2a508ed977125e8" title="MORE DEBUGGING YET.">CCNL_FINEST</a>))
<a name="l00636"></a>00636         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr,<span class="stringliteral">&quot;r_proto_policy_complete update scheduled&quot;</span>);        
<a name="l00637"></a>00637     
<a name="l00638"></a>00638     <span class="keywordflow">return</span> (0);
<a name="l00639"></a>00639 }
<a name="l00640"></a>00640 
<a name="l00641"></a>00641 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a>
<a name="l00642"></a><a class="code" href="ccnr__proto_8c.html#a09cb147151d02fa0624317f58188fd10">00642</a> <a class="code" href="ccnr__proto_8c.html#a09cb147151d02fa0624317f58188fd10">r_proto_start_write</a>(<span class="keyword">struct</span> <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *selfp,
<a name="l00643"></a>00643                     <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92" title="This tells what kind of event the upcall is handling.">ccn_upcall_kind</a> kind,
<a name="l00644"></a>00644                     <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info,
<a name="l00645"></a>00645                     <span class="keywordtype">int</span> marker_comp)
<a name="l00646"></a>00646 {
<a name="l00647"></a>00647     <span class="keyword">struct </span><a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *ccnr = NULL;
<a name="l00648"></a>00648     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *templ = NULL;
<a name="l00649"></a>00649     <span class="keyword">struct </span><a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *incoming = NULL;
<a name="l00650"></a>00650     <span class="keyword">struct </span><a class="code" href="structccnr__expect__content.html">ccnr_expect_content</a> *expect_content = NULL;
<a name="l00651"></a>00651     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *reply_body = NULL;
<a name="l00652"></a>00652     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = NULL;
<a name="l00653"></a>00653     <span class="keyword">struct </span><a class="code" href="structccn__indexbuf.html">ccn_indexbuf</a> *ic = NULL;
<a name="l00654"></a>00654     <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a> ans = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>;
<a name="l00655"></a>00655     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *msg = NULL;
<a name="l00656"></a>00656     <span class="keywordtype">int</span> res = 0;
<a name="l00657"></a>00657     <span class="keywordtype">int</span> start = 0;
<a name="l00658"></a>00658     <span class="keywordtype">int</span> end = 0;
<a name="l00659"></a>00659     <span class="keywordtype">int</span> is_policy = 0;
<a name="l00660"></a>00660     <span class="keywordtype">int</span> i;
<a name="l00661"></a>00661     <span class="keyword">struct </span><a class="code" href="structccn__signing__params.html" title="Parameters for creating signed content objects.">ccn_signing_params</a> sp = <a class="code" href="ccn_8h.html#a4ff046ac820ac0f2ef6acb912a03b328">CCN_SIGNING_PARAMS_INIT</a>;
<a name="l00662"></a>00662     
<a name="l00663"></a>00663     <span class="comment">// XXX - Check for valid nonce</span>
<a name="l00664"></a>00664     <span class="comment">// XXX - Check for pubid - if present and not ours, do not respond.</span>
<a name="l00665"></a>00665     <span class="comment">// Check for answer origin kind.</span>
<a name="l00666"></a>00666     <span class="comment">// If Exclude is there, there might be something fishy going on.</span>
<a name="l00667"></a>00667     
<a name="l00668"></a>00668     ccnr = (<span class="keyword">struct </span><a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *)selfp-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a>;
<a name="l00669"></a>00669     if (ccnr-&gt;<a class="code" href="structccnr__handle.html#a860d3791fab03c43f11ab3205a06fc86" title="Scope on start-write must be &amp;lt;= this value.">start_write_scope_limit</a> &lt; 3) {
<a name="l00670"></a>00670         start = info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9a93ab498c9cda336c253da7e19181c32d">CCN_PI_B_Scope</a>];
<a name="l00671"></a>00671         end = info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9a2a47735d8eda6fcfeca801046b8efa8b">CCN_PI_E_Scope</a>];
<a name="l00672"></a>00672         <span class="keywordflow">if</span> (start == end || info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#a390914a53122916d606c0c3f63b2af47">scope</a> &gt; ccnr-&gt;<a class="code" href="structccnr__handle.html#a860d3791fab03c43f11ab3205a06fc86" title="Scope on start-write must be &amp;lt;= this value.">start_write_scope_limit</a>) {
<a name="l00673"></a>00673             <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a2d1e1fa6e4518cba402ea37d1b963d99">LM_128</a>, <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>))
<a name="l00674"></a>00674                 <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;r_proto_start_write: interest scope exceeds limit&quot;</span>);
<a name="l00675"></a>00675             <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcadadb47635316f12c6542c33cebcfa727" title="normal upcall return">CCN_UPCALL_RESULT_OK</a>);
<a name="l00676"></a>00676         }
<a name="l00677"></a>00677     }
<a name="l00678"></a>00678     <span class="comment">// don&#39;t handle the policy file here</span>
<a name="l00679"></a>00679     start = info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9aec6eb389501f45e87378621c413261e2">CCN_PI_B_Name</a>];
<a name="l00680"></a>00680     end = info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[marker_comp - 1]; <span class="comment">// not including version or marker</span>
<a name="l00681"></a>00681     name = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00682"></a>00682     <a class="code" href="charbuf_8h.html#a5cc5c1412e38c015951394fcd79e2f6e">ccn_charbuf_append</a>(name, info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a> + start, end - start);
<a name="l00683"></a>00683     <a class="code" href="ccn_8h.html#ac8fba19d429bb106de10a008142882aa" title="Append a CCN_CLOSE.">ccn_charbuf_append_closer</a>(name);
<a name="l00684"></a>00684     <span class="keywordflow">if</span> (0 ==<a class="code" href="ccn_8h.html#a51eecb6e851286d46246101d2ea4b51b">ccn_compare_names</a>(name-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, name-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>,
<a name="l00685"></a>00685                               ccnr-&gt;<a class="code" href="structccnr__handle.html#ac96f020368a05e16691bf14acac27741">policy_name</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, ccnr-&gt;<a class="code" href="structccnr__handle.html#ac96f020368a05e16691bf14acac27741">policy_name</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>))
<a name="l00686"></a>00686         is_policy = 1;
<a name="l00687"></a>00687     
<a name="l00688"></a>00688     <span class="comment">/* Generate our reply */</span>
<a name="l00689"></a>00689     start = info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9aec6eb389501f45e87378621c413261e2">CCN_PI_B_Name</a>];
<a name="l00690"></a>00690     end = info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#af8e2d2c628b4b7bdb82de9edf8f91042">prefix_comps</a>];
<a name="l00691"></a>00691     name-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> = 0;
<a name="l00692"></a>00692     <a class="code" href="charbuf_8h.html#a5cc5c1412e38c015951394fcd79e2f6e">ccn_charbuf_append</a>(name, info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a> + start, end - start);
<a name="l00693"></a>00693     <a class="code" href="ccn_8h.html#ac8fba19d429bb106de10a008142882aa" title="Append a CCN_CLOSE.">ccn_charbuf_append_closer</a>(name);
<a name="l00694"></a>00694     msg = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00695"></a>00695     reply_body = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00696"></a>00696     <a class="code" href="ccnr__proto_8c.html#a9b4a35b4d6f63e221a2238c2024ef911" title="Construct a charbuf with an encoding of a RepositoryInfo.">r_proto_append_repo_info</a>(ccnr, reply_body, NULL, NULL);
<a name="l00697"></a>00697     sp.<a class="code" href="structccn__signing__params.html#a768c61b9b4e01e677bcd89f6be350367">freshness</a> = 12; <span class="comment">/* seconds */</span>
<a name="l00698"></a>00698     res = <a class="code" href="ccn_8h.html#a95240bd470b549c89a5e0fd72fa34d45" title="Create a signed ContentObject.">ccn_sign_content</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, msg, name, &amp;sp,
<a name="l00699"></a>00699                            reply_body-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, reply_body-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00700"></a>00700     <span class="keywordflow">if</span> (res &lt; 0)
<a name="l00701"></a>00701         <span class="keywordflow">goto</span> Bail;
<a name="l00702"></a>00702     <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a2d1e1fa6e4518cba402ea37d1b963d99">LM_128</a>, <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>))
<a name="l00703"></a>00703         <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;r_proto_start_write response&quot;</span>, NULL,
<a name="l00704"></a>00704                         msg-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, msg-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00705"></a>00705     res = <a class="code" href="ccn_8h.html#ac71f5c8727443c13afb11cf471f5f8fc">ccn_put</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, msg-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, msg-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00706"></a>00706     <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00707"></a>00707         <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;r_proto_start_write ccn_put FAILED&quot;</span>, NULL,
<a name="l00708"></a>00708                         msg-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, msg-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00709"></a>00709         <span class="keywordflow">goto</span> Bail;
<a name="l00710"></a>00710     }
<a name="l00711"></a>00711 
<a name="l00712"></a>00712     <span class="comment">/* Send an interest for segment 0 */</span>
<a name="l00713"></a>00713     expect_content = calloc(1, <span class="keyword">sizeof</span>(*expect_content));
<a name="l00714"></a>00714     <span class="keywordflow">if</span> (expect_content == NULL)
<a name="l00715"></a>00715         <span class="keywordflow">goto</span> Bail;
<a name="l00716"></a>00716     expect_content-&gt;<a class="code" href="structccnr__expect__content.html#a0927ea54848de19b025c85db8da4c9a0">ccnr</a> = ccnr;
<a name="l00717"></a>00717     expect_content-&gt;<a class="code" href="structccnr__expect__content.html#a913c369889b2639768a862a4cca6b27c">final</a> = -1;
<a name="l00718"></a>00718     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="ccnr__proto_8h.html#a2a08063e993e3cb158ffe7647f6ebc2e">CCNR_PIPELINE</a>; i++)
<a name="l00719"></a>00719         expect_content-&gt;<a class="code" href="structccnr__expect__content.html#a4329ad176aba312a03834c5f7f060c0a">outstanding</a>[i] = -1;
<a name="l00720"></a>00720     if (is_policy) {
<a name="l00721"></a>00721         expect_content-&gt;<a class="code" href="structccnr__expect__content.html#a2c61889eb0ed7569beab10a2e137f229">expect_complete</a> = &amp;<a class="code" href="ccnr__proto_8c.html#a5313a2e879fe5d452edb9f41c5935fc3">r_proto_policy_complete</a>;
<a name="l00722"></a>00722         <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a2d1e1fa6e4518cba402ea37d1b963d99">LM_128</a>, <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>))
<a name="l00723"></a>00723             <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;r_proto_start_write: is policy file&quot;</span>);
<a name="l00724"></a>00724     }
<a name="l00725"></a>00725     incoming = calloc(1, <span class="keyword">sizeof</span>(*incoming));
<a name="l00726"></a>00726     <span class="keywordflow">if</span> (incoming == NULL)
<a name="l00727"></a>00727         <span class="keywordflow">goto</span> Bail;
<a name="l00728"></a>00728     incoming-&gt;<a class="code" href="structccn__closure.html#a48dca74271023e0caf287ad31dd1e66c" title="client-supplied handler">p</a> = &amp;<a class="code" href="ccnr__proto_8c.html#a7022342c3a0054757ce160533385ee77">r_proto_expect_content</a>;
<a name="l00729"></a>00729     incoming-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a> = expect_content;
<a name="l00730"></a>00730     templ = <a class="code" href="ccnr__proto_8c.html#ae9fb0cd62eca64538e77a1682f1e25fe">r_proto_mktemplate</a>(expect_content, NULL);
<a name="l00731"></a>00731     ic = info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>;
<a name="l00732"></a>00732     <a class="code" href="ccn_8h.html#a4aa75ce6fc675e7a4c4c6d65e68817bd" title="Reset charbuf to represent an empty Name in binary format.">ccn_name_init</a>(name);
<a name="l00733"></a>00733     <a class="code" href="ccn_8h.html#a8ea2cc78c18c1aa99f12f44bd70bc7a1" title="Add sequence of ccnb-encoded Components to a ccnb-encoded Name.">ccn_name_append_components</a>(name, info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, ic-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[0], ic-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[marker_comp]);
<a name="l00734"></a>00734     <a class="code" href="ccn_8h.html#a3b95a770555b90f43d4876bea62c202d" title="Add a binary Component to a ccnb-encoded Name.">ccn_name_append_numeric</a>(name, <a class="code" href="ccn_8h.html#afec910e39c89dcf24a44f93e97032399af3eb8e7fa3a938a5bcc6c1f141357d71" title="consecutive block sequence numbers">CCN_MARKER_SEQNUM</a>, 0);
<a name="l00735"></a>00735     expect_content-&gt;<a class="code" href="structccnr__expect__content.html#a4329ad176aba312a03834c5f7f060c0a">outstanding</a>[0] = 0;
<a name="l00736"></a>00736     res = <a class="code" href="ccn_8h.html#a9f2d6eede46c8aac3dbb4b6e22e1d492">ccn_express_interest</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, name, incoming, templ);
<a name="l00737"></a>00737     <span class="keywordflow">if</span> (res &gt;= 0) {
<a name="l00738"></a>00738         <span class="comment">/* upcall will free these when it is done. */</span>
<a name="l00739"></a>00739         incoming = NULL;
<a name="l00740"></a>00740         expect_content = NULL;
<a name="l00741"></a>00741         ans = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca35e0232348739cde04ba6355c4395001" title="upcall claims to consume interest">CCN_UPCALL_RESULT_INTEREST_CONSUMED</a>;
<a name="l00742"></a>00742     }
<a name="l00743"></a>00743     <span class="keywordflow">else</span> {
<a name="l00744"></a>00744         <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;r_proto_start_write ccn_express_interest FAILED&quot;</span>, NULL,
<a name="l00745"></a>00745                         name-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, name-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00746"></a>00746         <span class="keywordflow">goto</span> Bail;
<a name="l00747"></a>00747     }
<a name="l00748"></a>00748     
<a name="l00749"></a>00749 Bail:
<a name="l00750"></a>00750     <span class="keywordflow">if</span> (incoming != NULL)
<a name="l00751"></a>00751         free(incoming);
<a name="l00752"></a>00752     <span class="keywordflow">if</span> (expect_content != NULL)
<a name="l00753"></a>00753         free(expect_content);
<a name="l00754"></a>00754     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;templ);
<a name="l00755"></a>00755     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l00756"></a>00756     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;reply_body);
<a name="l00757"></a>00757     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;msg);
<a name="l00758"></a>00758     <span class="keywordflow">return</span>(ans);
<a name="l00759"></a>00759 }
<a name="l00760"></a>00760 
<a name="l00761"></a>00761 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a>
<a name="l00762"></a><a class="code" href="ccnr__proto_8c.html#a430cf7f7832e08280285d33c6f393cb9">00762</a> <a class="code" href="ccnr__proto_8c.html#a430cf7f7832e08280285d33c6f393cb9">r_proto_start_write_checked</a>(<span class="keyword">struct</span> <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *selfp,
<a name="l00763"></a>00763                             <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92" title="This tells what kind of event the upcall is handling.">ccn_upcall_kind</a> kind,
<a name="l00764"></a>00764                             <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info,
<a name="l00765"></a>00765                             <span class="keywordtype">int</span> marker_comp)
<a name="l00766"></a>00766 {
<a name="l00767"></a>00767     <span class="keyword">struct </span><a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *ccnr = NULL;
<a name="l00768"></a>00768     <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a> ans = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcadadb47635316f12c6542c33cebcfa727" title="normal upcall return">CCN_UPCALL_RESULT_OK</a>;
<a name="l00769"></a>00769     <span class="keyword">struct </span><a class="code" href="structccn__indexbuf.html">ccn_indexbuf</a> *ic = NULL;
<a name="l00770"></a>00770     <span class="keyword">struct </span><a class="code" href="structcontent__entry.html" title="The content hash table is keyed by the initial portion of the ContentObject that...">content_entry</a> *content = NULL;
<a name="l00771"></a>00771     <span class="keyword">struct </span><a class="code" href="structccn__parsed__interest.html">ccn_parsed_interest</a> parsed_interest = {0};
<a name="l00772"></a>00772     <span class="keyword">struct </span><a class="code" href="structccn__parsed__interest.html">ccn_parsed_interest</a> *pi = &amp;parsed_interest;
<a name="l00773"></a>00773     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = NULL;
<a name="l00774"></a>00774     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *interest = NULL;
<a name="l00775"></a>00775     <span class="keyword">struct </span><a class="code" href="structccn__indexbuf.html">ccn_indexbuf</a> *comps = NULL;
<a name="l00776"></a>00776     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *msg = NULL;
<a name="l00777"></a>00777     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *reply_body = NULL;
<a name="l00778"></a>00778     <span class="keywordtype">int</span> start = 0;
<a name="l00779"></a>00779     <span class="keywordtype">int</span> end = 0;
<a name="l00780"></a>00780     <span class="keyword">struct </span><a class="code" href="structccn__signing__params.html" title="Parameters for creating signed content objects.">ccn_signing_params</a> sp = <a class="code" href="ccn_8h.html#a4ff046ac820ac0f2ef6acb912a03b328">CCN_SIGNING_PARAMS_INIT</a>;
<a name="l00781"></a>00781     <span class="keywordtype">int</span> res = 0;
<a name="l00782"></a>00782     
<a name="l00783"></a>00783     <span class="comment">// XXX - do we need to disallow the policy file here too?</span>
<a name="l00784"></a>00784     ccnr = (<span class="keyword">struct </span><a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *)selfp-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a>;
<a name="l00785"></a>00785     if (ccnr-&gt;<a class="code" href="structccnr__handle.html#a860d3791fab03c43f11ab3205a06fc86" title="Scope on start-write must be &amp;lt;= this value.">start_write_scope_limit</a> &lt; 3) {
<a name="l00786"></a>00786         start = info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9a93ab498c9cda336c253da7e19181c32d">CCN_PI_B_Scope</a>];
<a name="l00787"></a>00787         end = info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9a2a47735d8eda6fcfeca801046b8efa8b">CCN_PI_E_Scope</a>];
<a name="l00788"></a>00788         <span class="keywordflow">if</span> (start == end || info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#a390914a53122916d606c0c3f63b2af47">scope</a> &gt; ccnr-&gt;<a class="code" href="structccnr__handle.html#a860d3791fab03c43f11ab3205a06fc86" title="Scope on start-write must be &amp;lt;= this value.">start_write_scope_limit</a>) {
<a name="l00789"></a>00789             <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a2d1e1fa6e4518cba402ea37d1b963d99">LM_128</a>, <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>))
<a name="l00790"></a>00790                 <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;r_proto_start_write_checked: interest scope exceeds limit&quot;</span>);
<a name="l00791"></a>00791             <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcadadb47635316f12c6542c33cebcfa727" title="normal upcall return">CCN_UPCALL_RESULT_OK</a>);
<a name="l00792"></a>00792         }
<a name="l00793"></a>00793     }
<a name="l00794"></a>00794     name = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00795"></a>00795     <a class="code" href="ccn_8h.html#a4aa75ce6fc675e7a4c4c6d65e68817bd" title="Reset charbuf to represent an empty Name in binary format.">ccn_name_init</a>(name);
<a name="l00796"></a>00796     ic = info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>;
<a name="l00797"></a>00797     <a class="code" href="ccn_8h.html#a8ea2cc78c18c1aa99f12f44bd70bc7a1" title="Add sequence of ccnb-encoded Components to a ccnb-encoded Name.">ccn_name_append_components</a>(name, info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, ic-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[0], ic-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[marker_comp]);
<a name="l00798"></a>00798     <a class="code" href="ccn_8h.html#a8ea2cc78c18c1aa99f12f44bd70bc7a1" title="Add sequence of ccnb-encoded Components to a ccnb-encoded Name.">ccn_name_append_components</a>(name, info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, ic-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[marker_comp + 2], ic-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[ic-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a> - 1]);
<a name="l00799"></a>00799     <span class="comment">// Make an interest for the exact item we&#39;re checking</span>
<a name="l00800"></a>00800     interest = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00801"></a>00801     <a class="code" href="ccn_8h.html#afc2eb536e63f315968abe901e52b506a" title="Append a start-of-element marker.">ccnb_element_begin</a>(interest, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33ac3c02bb032cd835a5f9e439cadd0a455">CCN_DTAG_Interest</a>);
<a name="l00802"></a>00802     <a class="code" href="charbuf_8h.html#aca88638b2e81602eb4a1da9be923dad7">ccn_charbuf_append_charbuf</a>(interest, name);
<a name="l00803"></a>00803     <a class="code" href="ccn_8h.html#aa46b72f2e6b3b7f7753ff3baaa4efdf8" title="Append an end-of-element marker.">ccnb_element_end</a>(interest); <span class="comment">/* &lt;/Interest&gt; */</span>
<a name="l00804"></a>00804     <span class="comment">// Parse it</span>
<a name="l00805"></a>00805     comps = <a class="code" href="indexbuf_8h.html#a00ef00b3c7cbd2122bcdad019bd285c6" title="Create a new indexbuf.">ccn_indexbuf_create</a>();
<a name="l00806"></a>00806     res = <a class="code" href="ccn_8h.html#afd0b5c0251d4cdf65601d38a7a113b75">ccn_parse_interest</a>(interest-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, interest-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, pi, comps);
<a name="l00807"></a>00807     <span class="keywordflow">if</span> (res &lt; 0)
<a name="l00808"></a>00808         abort();
<a name="l00809"></a>00809     <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a2d1e1fa6e4518cba402ea37d1b963d99">LM_128</a>, <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>))
<a name="l00810"></a>00810         <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;r_proto_start_write_checked looking for&quot;</span>, NULL,
<a name="l00811"></a>00811                         interest-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, interest-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00812"></a>00812     content = <a class="code" href="ccnr__store_8c.html#a79f1fc95cadf17dd869726090f66c494">r_store_lookup</a>(ccnr, interest-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, pi, comps);
<a name="l00813"></a>00813     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;interest);
<a name="l00814"></a>00814     <a class="code" href="indexbuf_8h.html#a85816e7765050ed93ccdd29210dabfaf" title="Deallocate indexbuf.">ccn_indexbuf_destroy</a>(&amp;comps);
<a name="l00815"></a>00815     <span class="keywordflow">if</span> (content == NULL) {
<a name="l00816"></a>00816         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l00817"></a>00817         <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a2d1e1fa6e4518cba402ea37d1b963d99">LM_128</a>, <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>))
<a name="l00818"></a>00818             <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;r_proto_start_write_checked: NOT PRESENT&quot;</span>);
<a name="l00819"></a>00819         <span class="comment">// XXX - dropping into the start_write case means we do not check the provided digest when fetching, so this is not completely right.</span>
<a name="l00820"></a>00820         <span class="keywordflow">return</span>(<a class="code" href="ccnr__proto_8c.html#a09cb147151d02fa0624317f58188fd10">r_proto_start_write</a>(selfp, kind, info, marker_comp));
<a name="l00821"></a>00821     }
<a name="l00822"></a>00822     <span class="comment">// what&#39;s the return value if the item is in the repository already?</span>
<a name="l00823"></a>00823     <span class="comment">// if it does have it -- getRepoInfo(interest.name(), null, target_names)</span>
<a name="l00824"></a>00824     <span class="comment">// response has local name as the full name of the thing we claim to have --</span>
<a name="l00825"></a>00825     <span class="comment">// take the command marker and nonce out of the middle of the incoming interest,</span>
<a name="l00826"></a>00826     <span class="comment">// which is what we have in the &quot;name&quot; of the interest we created to check the content.</span><span class="comment"></span>
<a name="l00827"></a>00827 <span class="comment">    ///// begin copied code</span>
<a name="l00828"></a>00828 <span class="comment"></span>    <span class="comment">/* Generate our reply */</span>
<a name="l00829"></a>00829     msg = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00830"></a>00830     reply_body = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00831"></a>00831     <a class="code" href="ccnr__proto_8c.html#a9b4a35b4d6f63e221a2238c2024ef911" title="Construct a charbuf with an encoding of a RepositoryInfo.">r_proto_append_repo_info</a>(ccnr, reply_body, name, NULL);
<a name="l00832"></a>00832     start = info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9aec6eb389501f45e87378621c413261e2">CCN_PI_B_Name</a>];
<a name="l00833"></a>00833     end = info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#af8e2d2c628b4b7bdb82de9edf8f91042">prefix_comps</a>];
<a name="l00834"></a>00834     name-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> = 0;
<a name="l00835"></a>00835     <a class="code" href="charbuf_8h.html#a5cc5c1412e38c015951394fcd79e2f6e">ccn_charbuf_append</a>(name, info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a> + start, end - start);
<a name="l00836"></a>00836     <a class="code" href="ccn_8h.html#ac8fba19d429bb106de10a008142882aa" title="Append a CCN_CLOSE.">ccn_charbuf_append_closer</a>(name);
<a name="l00837"></a>00837     sp.<a class="code" href="structccn__signing__params.html#a768c61b9b4e01e677bcd89f6be350367">freshness</a> = 12; <span class="comment">/* Seconds */</span>
<a name="l00838"></a>00838     res = <a class="code" href="ccn_8h.html#a95240bd470b549c89a5e0fd72fa34d45" title="Create a signed ContentObject.">ccn_sign_content</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, msg, name, &amp;sp,
<a name="l00839"></a>00839                            reply_body-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, reply_body-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00840"></a>00840     <span class="keywordflow">if</span> (res &lt; 0)
<a name="l00841"></a>00841         <span class="keywordflow">goto</span> Bail;
<a name="l00842"></a>00842     <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a2d1e1fa6e4518cba402ea37d1b963d99">LM_128</a>, <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>))
<a name="l00843"></a>00843         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;r_proto_start_write_checked PRESENT&quot;</span>);
<a name="l00844"></a>00844     res = <a class="code" href="ccn_8h.html#ac71f5c8727443c13afb11cf471f5f8fc">ccn_put</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, msg-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, msg-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00845"></a>00845     <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00846"></a>00846         <span class="comment">// note the error somehow.</span>
<a name="l00847"></a>00847         <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;r_proto_start_write_checked ccn_put FAILED&quot;</span>, NULL,
<a name="l00848"></a>00848                         msg-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, msg-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00849"></a>00849     }<span class="comment"></span>
<a name="l00850"></a>00850 <span class="comment">    //// end of copied code</span>
<a name="l00851"></a>00851 <span class="comment"></span>Bail:
<a name="l00852"></a>00852     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l00853"></a>00853     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;reply_body);
<a name="l00854"></a>00854     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;msg);
<a name="l00855"></a>00855     <span class="keywordflow">return</span>(ans);
<a name="l00856"></a>00856 }
<a name="l00857"></a>00857 <span class="comment"></span>
<a name="l00858"></a>00858 <span class="comment">/**</span>
<a name="l00859"></a>00859 <span class="comment"> * Returns 1 if the Exclude in the interest described by the info parameter</span>
<a name="l00860"></a>00860 <span class="comment"> * would exclude the full name in name.</span>
<a name="l00861"></a>00861 <span class="comment"> */</span>
<a name="l00862"></a>00862 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00863"></a><a class="code" href="ccnr__proto_8c.html#aca9fa508dbede1f006cfd42bbf0f902a">00863</a> <a class="code" href="ccnr__proto_8c.html#aca9fa508dbede1f006cfd42bbf0f902a" title="Returns 1 if the Exclude in the interest described by the info parameter would exclude...">r_proto_check_exclude</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *ccnr,
<a name="l00864"></a>00864                       <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info,
<a name="l00865"></a>00865                       <span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name)
<a name="l00866"></a>00866 {
<a name="l00867"></a>00867     <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> decoder;
<a name="l00868"></a>00868     <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> *d = NULL;
<a name="l00869"></a>00869     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *comp = NULL;
<a name="l00870"></a>00870     <span class="keywordtype">size_t</span> comp_size;
<a name="l00871"></a>00871     <span class="keywordtype">size_t</span> name_comp_size;
<a name="l00872"></a>00872     <span class="keyword">struct </span><a class="code" href="structccn__indexbuf.html">ccn_indexbuf</a> *name_comps = NULL;
<a name="l00873"></a>00873     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *name_string = NULL;
<a name="l00874"></a>00874     <span class="keywordtype">int</span> nc;
<a name="l00875"></a>00875     <span class="keywordtype">int</span> ci;
<a name="l00876"></a>00876     <span class="keywordtype">int</span> res;
<a name="l00877"></a>00877     <span class="keywordtype">int</span> ans = 0;
<a name="l00878"></a>00878     
<a name="l00879"></a>00879     <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9a4c40a9e5305b7602b96ababfd02f6775">CCN_PI_B_Exclude</a>] &lt; info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ad7411aa4c9a0b67d3b48c4abbe1e0f0a">CCN_PI_E_Exclude</a>]) {
<a name="l00880"></a>00880         d = <a class="code" href="ccn_8h.html#a4ba830f8dad511663779d85122db633a">ccn_buf_decoder_start</a>(&amp;decoder,
<a name="l00881"></a>00881                                   info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a> + info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9a4c40a9e5305b7602b96ababfd02f6775">CCN_PI_B_Exclude</a>],
<a name="l00882"></a>00882                                   info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ad7411aa4c9a0b67d3b48c4abbe1e0f0a">CCN_PI_E_Exclude</a>] -
<a name="l00883"></a>00883                                   info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9a4c40a9e5305b7602b96ababfd02f6775">CCN_PI_B_Exclude</a>]);
<a name="l00884"></a>00884         
<a name="l00885"></a>00885         <span class="comment">// handle easy case of &lt;Exclude&gt;&lt;Component&gt;...&lt;/Exclude&gt;</span>
<a name="l00886"></a>00886         <span class="comment">// XXX - this may need to be better, but not necessarily complete</span>
<a name="l00887"></a>00887         <span class="keywordflow">if</span> (<a class="code" href="ccn_8h.html#a127d4f9a3f901ba15bc5335d5a9fa3b0">ccn_buf_match_dtag</a>(d, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a9dcce1e4306cb7fd0e58d99ef370476e">CCN_DTAG_Exclude</a>)) {
<a name="l00888"></a>00888             <a class="code" href="ccn_8h.html#a1b17cadb92b2339cba24721b0466a0ce">ccn_buf_advance</a>(d);
<a name="l00889"></a>00889         } <span class="keywordflow">else</span> 
<a name="l00890"></a>00890             <span class="keywordflow">goto</span> Bail;
<a name="l00891"></a>00891         <span class="comment">// there may be something to check, so get the components of the name</span>
<a name="l00892"></a>00892         name_comps = <a class="code" href="indexbuf_8h.html#a00ef00b3c7cbd2122bcdad019bd285c6" title="Create a new indexbuf.">ccn_indexbuf_create</a>();
<a name="l00893"></a>00893         nc = <a class="code" href="ccn_8h.html#a75efe309adf727b49a9afe58fed4b483" title="Find Component boundaries in a ccnb-encoded Name.">ccn_name_split</a>(name, name_comps);
<a name="l00894"></a>00894         <span class="comment">// the component in the name we are matching is last plus one of the interest</span>
<a name="l00895"></a>00895         <span class="comment">// but ci includes an extra value for the end of the last component</span>
<a name="l00896"></a>00896         ci = info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a>;
<a name="l00897"></a>00897         res = <a class="code" href="ccn_8h.html#a70c13909ea45ffb1069916d7a512fdda" title="Extract a pointer to and size of component at given index i.">ccn_name_comp_get</a>(name-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, name_comps, ci - 1, &amp;name_string, &amp;name_comp_size);
<a name="l00898"></a>00898         <span class="keywordflow">if</span> (res &lt; 0)
<a name="l00899"></a>00899             <span class="keywordflow">goto</span> Bail;
<a name="l00900"></a>00900         <span class="keywordflow">while</span> (<a class="code" href="ccn_8h.html#a127d4f9a3f901ba15bc5335d5a9fa3b0">ccn_buf_match_dtag</a>(d, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33ad20ad6d29fb3d5cb3631152e0fc1ccc0">CCN_DTAG_Component</a>)) {
<a name="l00901"></a>00901             <a class="code" href="ccn_8h.html#a1b17cadb92b2339cba24721b0466a0ce">ccn_buf_advance</a>(d);
<a name="l00902"></a>00902             comp_size = 0;
<a name="l00903"></a>00903             <span class="keywordflow">if</span> (<a class="code" href="ccn_8h.html#a9fed718b821292cf45ba00f17a09e69e">ccn_buf_match_blob</a>(d, &amp;comp, &amp;comp_size))
<a name="l00904"></a>00904                 <a class="code" href="ccn_8h.html#a1b17cadb92b2339cba24721b0466a0ce">ccn_buf_advance</a>(d);
<a name="l00905"></a>00905             <a class="code" href="ccn_8h.html#a1868a32594c3c2a98e60049a3f3184b8" title="Enter an error state if element closer not found.">ccn_buf_check_close</a>(d);
<a name="l00906"></a>00906             <span class="keywordflow">if</span> (comp_size == name_comp_size) {
<a name="l00907"></a>00907                 res = memcmp(comp, name_string, comp_size);
<a name="l00908"></a>00908                 <span class="keywordflow">if</span> (res == 0) {
<a name="l00909"></a>00909                     ans = 1;
<a name="l00910"></a>00910                     <span class="keywordflow">goto</span> Bail; <span class="comment">/* One of the explicit excludes */</span>
<a name="l00911"></a>00911                 }
<a name="l00912"></a>00912                 <span class="keywordflow">if</span> (res &gt; 0)
<a name="l00913"></a>00913                     <span class="keywordflow">break</span>;
<a name="l00914"></a>00914             }
<a name="l00915"></a>00915         }
<a name="l00916"></a>00916     }
<a name="l00917"></a>00917     
<a name="l00918"></a>00918 Bail:
<a name="l00919"></a>00919     <a class="code" href="indexbuf_8h.html#a85816e7765050ed93ccdd29210dabfaf" title="Deallocate indexbuf.">ccn_indexbuf_destroy</a>(&amp;name_comps);
<a name="l00920"></a>00920     <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a7323999db7afd7869b7b4ff665e751c8">LM_8</a>, <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>))
<a name="l00921"></a>00921         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;r_proto_check_exclude: do%s exclude&quot;</span>, (ans == 1) ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot; not&quot;</span>);
<a name="l00922"></a>00922     <span class="keywordflow">return</span>(ans);
<a name="l00923"></a>00923 }
<a name="l00924"></a>00924 
<a name="l00925"></a>00925 <span class="keywordtype">void</span>
<a name="l00926"></a><a class="code" href="ccnr__proto_8h.html#a839f36da4f87d560b0cd5e7c21e7c83b">00926</a> <a class="code" href="ccnr__proto_8c.html#a839f36da4f87d560b0cd5e7c21e7c83b">r_proto_finalize_enum_state</a>(<span class="keyword">struct</span> <a class="code" href="structhashtb__enumerator.html">hashtb_enumerator</a> *e)
<a name="l00927"></a>00927 {
<a name="l00928"></a>00928     <span class="keyword">struct </span><a class="code" href="structenum__state.html">enum_state</a> *es = e-&gt;<a class="code" href="structhashtb__enumerator.html#af755f33ac2cc13fa63684f362ac6be1c">data</a>;
<a name="l00929"></a>00929     <span class="keywordtype">unsigned</span> i;
<a name="l00930"></a>00930     
<a name="l00931"></a>00931     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;es-&gt;<a class="code" href="structenum__state.html#a556983d4b4b1073f7605779c4f488cbb">name</a>);
<a name="l00932"></a>00932     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;es-&gt;<a class="code" href="structenum__state.html#a523196f897efab74dfba5c732d8597e8">interest</a>); <span class="comment">// unnecessary?</span>
<a name="l00933"></a>00933     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;es-&gt;<a class="code" href="structenum__state.html#aba41a40dd7e71c7f6a431857672fb5b8">reply_body</a>);
<a name="l00934"></a>00934     <a class="code" href="indexbuf_8h.html#a85816e7765050ed93ccdd29210dabfaf" title="Deallocate indexbuf.">ccn_indexbuf_destroy</a>(&amp;es-&gt;<a class="code" href="structenum__state.html#a983b607b7e0f784162e95473917f4e43">interest_comps</a>);
<a name="l00935"></a>00935     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="ccnr__private_8h.html#aad037352217601f68b01e07776c6f0c3">ENUM_N_COBS</a>; i++)
<a name="l00936"></a>00936         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;(es-&gt;<a class="code" href="structenum__state.html#a50537883df14c53ad8475f35d63a681c">cob</a>[i]));
<a name="l00937"></a>00937     <span class="keywordflow">return</span>;
<a name="l00938"></a>00938 }
<a name="l00939"></a>00939 
<a name="l00940"></a><a class="code" href="ccnr__proto_8c.html#ab8447991c4b9e95c2aa118c84f83d168">00940</a> <span class="preprocessor">#define ENUMERATION_STATE_TICK_MICROSEC 1000000</span>
<a name="l00941"></a>00941 <span class="preprocessor"></span><span class="comment">/**</span>
<a name="l00942"></a>00942 <span class="comment"> * Remove expired enumeration table entries</span>
<a name="l00943"></a>00943 <span class="comment"> */</span>
<a name="l00944"></a>00944 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00945"></a><a class="code" href="ccnr__proto_8c.html#a9cc88e81a710eadbd5dd6399962354e4">00945</a> <a class="code" href="ccnr__proto_8c.html#a9cc88e81a710eadbd5dd6399962354e4" title="Remove expired enumeration table entries.">reap_enumerations</a>(<span class="keyword">struct</span> ccn_schedule *sched,
<a name="l00946"></a>00946                   <span class="keywordtype">void</span> *clienth,
<a name="l00947"></a>00947                   <span class="keyword">struct</span> <a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev,
<a name="l00948"></a>00948                   <span class="keywordtype">int</span> flags)
<a name="l00949"></a>00949 {
<a name="l00950"></a>00950     <span class="keyword">struct </span><a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *ccnr = clienth;
<a name="l00951"></a>00951     <span class="keyword">struct </span><a class="code" href="structhashtb__enumerator.html">hashtb_enumerator</a> ee;
<a name="l00952"></a>00952     <span class="keyword">struct </span><a class="code" href="structhashtb__enumerator.html">hashtb_enumerator</a> *e = &amp;ee;
<a name="l00953"></a>00953     <span class="keyword">struct </span><a class="code" href="structenum__state.html">enum_state</a> *es = NULL;
<a name="l00954"></a>00954     
<a name="l00955"></a>00955     <span class="keywordflow">if</span> ((flags &amp; <a class="code" href="schedule_8h.html#a705b7a47118864084280c615c0e6a2de">CCN_SCHEDULE_CANCEL</a>) != 0) {
<a name="l00956"></a>00956         ccnr-&gt;<a class="code" href="structccnr__handle.html#a0f81b978f9849aae87d057e93074b5ab" title="cleans out old enumeration state">reap_enumerations</a> = NULL;
<a name="l00957"></a>00957         <span class="keywordflow">return</span>(0);
<a name="l00958"></a>00958     }
<a name="l00959"></a>00959     <a class="code" href="hashtb_8h.html#a9f99fb4a9a147c8d73c1e6ab9415849d">hashtb_start</a>(ccnr-&gt;<a class="code" href="structccnr__handle.html#a11d69a8caf053c392072b6d07ecb0b2b" title="keyed by enumeration interest">enum_state_tab</a>, e);
<a name="l00960"></a>00960     <span class="keywordflow">for</span> (es = e-&gt;<a class="code" href="structhashtb__enumerator.html#af755f33ac2cc13fa63684f362ac6be1c">data</a>; es != NULL; es = e-&gt;<a class="code" href="structhashtb__enumerator.html#af755f33ac2cc13fa63684f362ac6be1c">data</a>) {
<a name="l00961"></a>00961         <span class="keywordflow">if</span> (es-&gt;<a class="code" href="structenum__state.html#a76892d4297718af6f55d17166ad46822">active</a> != <a class="code" href="ccnr__private_8h.html#a9d0a349f5750f51944256996129ef8eaac46618d3f50abcd35f828f1604867d17">ES_ACTIVE</a> &amp;&amp;
<a name="l00962"></a>00962             <a class="code" href="ccnr__util_8c.html#a54ef532b7de238358c7a21a65d939930">r_util_timecmp</a>(es-&gt;<a class="code" href="structenum__state.html#afb0691182f4333d1530b92ee30321e93">lastuse_sec</a> + es-&gt;<a class="code" href="structenum__state.html#abe951530e08bf00b087d1c82ae3bdb64">lifetime</a>, es-&gt;<a class="code" href="structenum__state.html#af3fe5372ea130351c48712b9a55fb9c9">lastuse_usec</a>,
<a name="l00963"></a>00963                            ccnr-&gt;<a class="code" href="structccnr__handle.html#a018117b25163afe16d015b6c71528a01" title="cached gettime seconds">sec</a>, ccnr-&gt;<a class="code" href="structccnr__handle.html#a08e40c533ecdfc9b15fd1b88e7c09c1a" title="cached gettime microseconds">usec</a>) &lt;= 0) {
<a name="l00964"></a>00964                 <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a7323999db7afd7869b7b4ff665e751c8">LM_8</a>, <a class="code" href="loglevels_8h.html#a795a0a3098f6c9ba5990e8a23775284d" title="More debugging.">CCNL_FINER</a>))
<a name="l00965"></a>00965                     <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;reap enumeration state&quot;</span>, NULL,
<a name="l00966"></a>00966                                     es-&gt;<a class="code" href="structenum__state.html#a556983d4b4b1073f7605779c4f488cbb">name</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, es-&gt;<a class="code" href="structenum__state.html#a556983d4b4b1073f7605779c4f488cbb">name</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);                           <span class="comment">// remove the entry from the hash table, finalization frees data</span>
<a name="l00967"></a>00967                 <a class="code" href="hashtb_8h.html#a9f2f39d261df3329e6c08db936b8b203">hashtb_delete</a>(e);
<a name="l00968"></a>00968             }
<a name="l00969"></a>00969         <a class="code" href="hashtb_8h.html#ac734849284c60658f52525f200acf38d">hashtb_next</a>(e);
<a name="l00970"></a>00970     }
<a name="l00971"></a>00971     <a class="code" href="hashtb_8h.html#a7072bd345c49a74700394947c761f998">hashtb_end</a>(e);
<a name="l00972"></a>00972     <span class="keywordflow">if</span> (<a class="code" href="hashtb_8h.html#aeb88fe755e1a142e94836a5b347b1927">hashtb_n</a>(ccnr-&gt;<a class="code" href="structccnr__handle.html#a11d69a8caf053c392072b6d07ecb0b2b" title="keyed by enumeration interest">enum_state_tab</a>) == 0) {
<a name="l00973"></a>00973         ccnr-&gt;<a class="code" href="structccnr__handle.html#a0f81b978f9849aae87d057e93074b5ab" title="cleans out old enumeration state">reap_enumerations</a> = NULL;
<a name="l00974"></a>00974         <span class="keywordflow">return</span>(0);
<a name="l00975"></a>00975     }
<a name="l00976"></a>00976     <span class="keywordflow">return</span>(<a class="code" href="ccnr__proto_8c.html#ab8447991c4b9e95c2aa118c84f83d168">ENUMERATION_STATE_TICK_MICROSEC</a>);
<a name="l00977"></a>00977 }
<a name="l00978"></a>00978 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00979"></a><a class="code" href="ccnr__proto_8c.html#a1e1ba0c455da37d01178bb2345ff3d44">00979</a> <a class="code" href="ccnr__proto_8c.html#a1e1ba0c455da37d01178bb2345ff3d44">reap_enumerations_needed</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *ccnr)
<a name="l00980"></a>00980 {
<a name="l00981"></a>00981     <span class="keywordflow">if</span> (ccnr-&gt;<a class="code" href="structccnr__handle.html#a0f81b978f9849aae87d057e93074b5ab" title="cleans out old enumeration state">reap_enumerations</a> == NULL)
<a name="l00982"></a>00982         ccnr-&gt;<a class="code" href="structccnr__handle.html#a0f81b978f9849aae87d057e93074b5ab" title="cleans out old enumeration state">reap_enumerations</a> = <a class="code" href="schedule_8h.html#a1b46f1ba6b54371f41a5c160cd1604ba">ccn_schedule_event</a>(ccnr-&gt;<a class="code" href="structccnr__handle.html#ae75f01e799058fbe52d154ebaa08ec52" title="our schedule">sched</a>,
<a name="l00983"></a>00983                                                      <a class="code" href="ccnr__proto_8c.html#ab8447991c4b9e95c2aa118c84f83d168">ENUMERATION_STATE_TICK_MICROSEC</a>,
<a name="l00984"></a>00984                                                      <a class="code" href="ccnr__proto_8c.html#a9cc88e81a710eadbd5dd6399962354e4" title="Remove expired enumeration table entries.">reap_enumerations</a>,
<a name="l00985"></a>00985                                                      NULL, 0);
<a name="l00986"></a>00986 }
<a name="l00987"></a>00987 
<a name="l00988"></a>00988 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a>
<a name="l00989"></a><a class="code" href="ccnr__proto_8c.html#a8131ce5b8fa912cef71a628be6aab86b">00989</a> <a class="code" href="ccnr__proto_8c.html#a8131ce5b8fa912cef71a628be6aab86b">r_proto_begin_enumeration</a>(<span class="keyword">struct</span> <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *selfp,
<a name="l00990"></a>00990                           <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92" title="This tells what kind of event the upcall is handling.">ccn_upcall_kind</a> kind,
<a name="l00991"></a>00991                           <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info,
<a name="l00992"></a>00992                           <span class="keywordtype">int</span> marker_comp)
<a name="l00993"></a>00993 {
<a name="l00994"></a>00994     <span class="keyword">struct </span><a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *ccnr = NULL;
<a name="l00995"></a>00995     <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a> ans = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>;
<a name="l00996"></a>00996     <span class="keyword">struct </span><a class="code" href="structccn__parsed__interest.html">ccn_parsed_interest</a> parsed_interest = {0};
<a name="l00997"></a>00997     <span class="keyword">struct </span><a class="code" href="structccn__parsed__interest.html">ccn_parsed_interest</a> *pi = &amp;parsed_interest;
<a name="l00998"></a>00998     <span class="keyword">struct </span><a class="code" href="structhashtb__enumerator.html">hashtb_enumerator</a> enumerator = {0};
<a name="l00999"></a>00999     <span class="keyword">struct </span><a class="code" href="structhashtb__enumerator.html">hashtb_enumerator</a> *e = &amp;enumerator;
<a name="l01000"></a>01000     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = NULL;
<a name="l01001"></a>01001     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *cob = NULL;
<a name="l01002"></a>01002     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *interest = NULL;
<a name="l01003"></a>01003     <span class="keyword">struct </span><a class="code" href="structccn__indexbuf.html">ccn_indexbuf</a> *comps = NULL;
<a name="l01004"></a>01004     <span class="keywordtype">int</span> res;
<a name="l01005"></a>01005     <span class="keyword">struct </span><a class="code" href="structcontent__entry.html" title="The content hash table is keyed by the initial portion of the ContentObject that...">content_entry</a> *content = NULL;
<a name="l01006"></a>01006     <span class="keyword">struct </span><a class="code" href="structenum__state.html">enum_state</a> *es = NULL;
<a name="l01007"></a>01007     
<a name="l01008"></a>01008     ccnr = (<span class="keyword">struct </span><a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *)selfp-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a>;
<a name="l01009"></a>01009     <span class="comment">// Construct a name up to but not including the begin enumeration marker component</span>
<a name="l01010"></a>01010     name = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01011"></a>01011     <a class="code" href="ccn_8h.html#a4aa75ce6fc675e7a4c4c6d65e68817bd" title="Reset charbuf to represent an empty Name in binary format.">ccn_name_init</a>(name);
<a name="l01012"></a>01012     <a class="code" href="ccn_8h.html#a8ea2cc78c18c1aa99f12f44bd70bc7a1" title="Add sequence of ccnb-encoded Components to a ccnb-encoded Name.">ccn_name_append_components</a>(name, info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>,
<a name="l01013"></a>01013                                info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[0],
<a name="l01014"></a>01014                                info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[marker_comp]);
<a name="l01015"></a>01015     <span class="comment">// Make an interest for the part of the namespace we are after, from the name</span>
<a name="l01016"></a>01016     interest = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01017"></a>01017     <a class="code" href="ccn_8h.html#afc2eb536e63f315968abe901e52b506a" title="Append a start-of-element marker.">ccnb_element_begin</a>(interest, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33ac3c02bb032cd835a5f9e439cadd0a455">CCN_DTAG_Interest</a>);
<a name="l01018"></a>01018     <a class="code" href="charbuf_8h.html#aca88638b2e81602eb4a1da9be923dad7">ccn_charbuf_append_charbuf</a>(interest, name);
<a name="l01019"></a>01019     <a class="code" href="ccn_8h.html#aa46b72f2e6b3b7f7753ff3baaa4efdf8" title="Append an end-of-element marker.">ccnb_element_end</a>(interest); <span class="comment">/* &lt;/Interest&gt; */</span>
<a name="l01020"></a>01020     
<a name="l01021"></a>01021     <span class="comment">// Parse it</span>
<a name="l01022"></a>01022     comps = <a class="code" href="indexbuf_8h.html#a00ef00b3c7cbd2122bcdad019bd285c6" title="Create a new indexbuf.">ccn_indexbuf_create</a>();
<a name="l01023"></a>01023     res = <a class="code" href="ccn_8h.html#afd0b5c0251d4cdf65601d38a7a113b75">ccn_parse_interest</a>(interest-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, interest-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, pi, comps);
<a name="l01024"></a>01024     <span class="keywordflow">if</span> (res &lt; 0)
<a name="l01025"></a>01025         abort();
<a name="l01026"></a>01026     <span class="comment">// Look for a previous enumeration under this prefix</span>
<a name="l01027"></a>01027     <a class="code" href="hashtb_8h.html#a9f99fb4a9a147c8d73c1e6ab9415849d">hashtb_start</a>(ccnr-&gt;<a class="code" href="structccnr__handle.html#a11d69a8caf053c392072b6d07ecb0b2b" title="keyed by enumeration interest">enum_state_tab</a>, e);
<a name="l01028"></a>01028     res = <a class="code" href="hashtb_8h.html#a6a29faf3e0e001fac2a19caf350ed839">hashtb_seek</a>(e, name-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, name-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, 0);
<a name="l01029"></a>01029     es = e-&gt;<a class="code" href="structhashtb__enumerator.html#af755f33ac2cc13fa63684f362ac6be1c">data</a>;
<a name="l01030"></a>01030     <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a7323999db7afd7869b7b4ff665e751c8">LM_8</a>, <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>))
<a name="l01031"></a>01031         <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;enumeration: begin hash key&quot;</span>, NULL,
<a name="l01032"></a>01032                         name-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, name-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01033"></a>01033     <span class="comment">// Do not restart an active enumeration, it is probably a duplicate interest</span>
<a name="l01034"></a>01034     <span class="comment">// TODO: may need attention when es-&gt;active == ES_ACTIVE_PENDING_INACTIVE</span>
<a name="l01035"></a>01035     <span class="keywordflow">if</span> (res == <a class="code" href="hashtb_8h.html#ad17577840d8e3d79e5e170716201b649">HT_OLD_ENTRY</a> &amp;&amp; es-&gt;<a class="code" href="structenum__state.html#a76892d4297718af6f55d17166ad46822">active</a> != <a class="code" href="ccnr__private_8h.html#a9d0a349f5750f51944256996129ef8eaa2fbb7bd9e6595187077698d89a850e0a">ES_INACTIVE</a>) {
<a name="l01036"></a>01036         <span class="keywordflow">if</span> (es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a> &gt; 0)
<a name="l01037"></a>01037             cob = es-&gt;<a class="code" href="structenum__state.html#a50537883df14c53ad8475f35d63a681c">cob</a>[(es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a> - 1) % <a class="code" href="ccnr__private_8h.html#aad037352217601f68b01e07776c6f0c3">ENUM_N_COBS</a>];
<a name="l01038"></a>01038         <span class="keywordflow">if</span> (cob &amp;&amp; <a class="code" href="ccn_8h.html#a2e161e1c17ef110dfa019bc1d560c82c" title="Test for a match between a ContentObject and an Interest.">ccn_content_matches_interest</a>(cob-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, cob-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, 1, NULL,
<a name="l01039"></a>01039                                          info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ae3500edfbd06a2be152e0ef8fcc64328">CCN_PI_E</a>], info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>)) {
<a name="l01040"></a>01040             <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a7323999db7afd7869b7b4ff665e751c8">LM_8</a>, <a class="code" href="loglevels_8h.html#a795a0a3098f6c9ba5990e8a23775284d" title="More debugging.">CCNL_FINER</a>))
<a name="l01041"></a>01041                 <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;enumeration: duplicate request for last cob&quot;</span>);
<a name="l01042"></a>01042             <a class="code" href="ccn_8h.html#ac71f5c8727443c13afb11cf471f5f8fc">ccn_put</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, cob-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, cob-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01043"></a>01043             es-&gt;<a class="code" href="structenum__state.html#a56c207d4d4cb6fb08f023c2451719931">cob_deferred</a>[(es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a> - 1) % <a class="code" href="ccnr__private_8h.html#aad037352217601f68b01e07776c6f0c3">ENUM_N_COBS</a>] = 0;
<a name="l01044"></a>01044             ans = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca35e0232348739cde04ba6355c4395001" title="upcall claims to consume interest">CCN_UPCALL_RESULT_INTEREST_CONSUMED</a>;
<a name="l01045"></a>01045         } <span class="keywordflow">else</span> {
<a name="l01046"></a>01046             <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a7323999db7afd7869b7b4ff665e751c8">LM_8</a>, <a class="code" href="loglevels_8h.html#ac0d8d64571564474f2a508ed977125e8" title="MORE DEBUGGING YET.">CCNL_FINEST</a>)) {
<a name="l01047"></a>01047                 <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;enumeration: restart of active enumeration, or excluded&quot;</span>);
<a name="l01048"></a>01048                 <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;enum    interest: &quot;</span>, NULL, info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ae3500edfbd06a2be152e0ef8fcc64328">CCN_PI_E</a>]);
<a name="l01049"></a>01049                 <span class="keywordflow">if</span> (cob != NULL)
<a name="l01050"></a>01050                     <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;enum cob content: &quot;</span>, NULL, cob-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, cob-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01051"></a>01051             }
<a name="l01052"></a>01052             ans = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcadadb47635316f12c6542c33cebcfa727" title="normal upcall return">CCN_UPCALL_RESULT_OK</a>;
<a name="l01053"></a>01053         }
<a name="l01054"></a>01054         <a class="code" href="hashtb_8h.html#a7072bd345c49a74700394947c761f998">hashtb_end</a>(e);
<a name="l01055"></a>01055         <span class="keywordflow">goto</span> Bail;
<a name="l01056"></a>01056     }
<a name="l01057"></a>01057     <span class="comment">// Continue to construct the name under which we will respond: %C1.E.be</span>
<a name="l01058"></a>01058     <a class="code" href="ccn_8h.html#a8ea2cc78c18c1aa99f12f44bd70bc7a1" title="Add sequence of ccnb-encoded Components to a ccnb-encoded Name.">ccn_name_append_components</a>(name, info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>,
<a name="l01059"></a>01059                                info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[marker_comp],
<a name="l01060"></a>01060                                info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[marker_comp + 1]);
<a name="l01061"></a>01061     <span class="comment">// Append the repository key id %C1.K.%00&lt;repoid&gt;</span>
<a name="l01062"></a>01062     <a class="code" href="ccn_8h.html#a3f4f614f38ae77dccb4099e982c646f8" title="Add a Component to a Name.">ccn_name_append</a>(name, ccnr-&gt;<a class="code" href="structccnr__handle.html#ab7fec1a42e8328d78c348aaf4a7c06e6" title="public key digest in keyid format C1.M.K.">ccnr_keyid</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, ccnr-&gt;<a class="code" href="structccnr__handle.html#ab7fec1a42e8328d78c348aaf4a7c06e6" title="public key digest in keyid format C1.M.K.">ccnr_keyid</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01063"></a>01063     
<a name="l01064"></a>01064     <span class="keywordflow">if</span> (res == <a class="code" href="hashtb_8h.html#a4218c265c59263d9fcf6af877da406ac">HT_NEW_ENTRY</a> || es-&gt;<a class="code" href="structenum__state.html#aa96f4d061cb4809f43f1049ab850432c">starting_cookie</a> != ccnr-&gt;<a class="code" href="structccnr__handle.html#a92fe372c2494f28621e20e9661691f5b" title="newest used cookie number">cookie</a>) {
<a name="l01065"></a>01065         <span class="comment">// this is a new enumeration, the time is now.</span>
<a name="l01066"></a>01066         res = <a class="code" href="ccn_8h.html#af222a5e0ff25d4f2ff60eed72b3defb2" title="Extend a Name with a new version stamp.">ccn_create_version</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, name, <a class="code" href="ccn_8h.html#ac0d9b4a6ddee8ae94d87d8c2340ac907" title="use current time">CCN_V_NOW</a>, 0, 0);
<a name="l01067"></a>01067         <span class="keywordflow">if</span> (es-&gt;<a class="code" href="structenum__state.html#a556983d4b4b1073f7605779c4f488cbb">name</a> != NULL)
<a name="l01068"></a>01068             <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;es-&gt;<a class="code" href="structenum__state.html#a556983d4b4b1073f7605779c4f488cbb">name</a>);
<a name="l01069"></a>01069         es-&gt;<a class="code" href="structenum__state.html#a556983d4b4b1073f7605779c4f488cbb">name</a> = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01070"></a>01070         <a class="code" href="charbuf_8h.html#aca88638b2e81602eb4a1da9be923dad7">ccn_charbuf_append_charbuf</a>(es-&gt;<a class="code" href="structenum__state.html#a556983d4b4b1073f7605779c4f488cbb">name</a>, name);
<a name="l01071"></a>01071         es-&gt;<a class="code" href="structenum__state.html#aa96f4d061cb4809f43f1049ab850432c">starting_cookie</a> = ccnr-&gt;<a class="code" href="structccnr__handle.html#a92fe372c2494f28621e20e9661691f5b" title="newest used cookie number">cookie</a>; <span class="comment">// XXX - a conservative indicator of change</span>
<a name="l01072"></a>01072     }
<a name="l01073"></a>01073     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l01074"></a>01074     <span class="comment">// check the exclude against the result name</span>
<a name="l01075"></a>01075     <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a7323999db7afd7869b7b4ff665e751c8">LM_8</a>, <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>))
<a name="l01076"></a>01076         <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;begin enum: result name&quot;</span>, NULL,
<a name="l01077"></a>01077                         es-&gt;<a class="code" href="structenum__state.html#a556983d4b4b1073f7605779c4f488cbb">name</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, es-&gt;<a class="code" href="structenum__state.html#a556983d4b4b1073f7605779c4f488cbb">name</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01078"></a>01078     
<a name="l01079"></a>01079     <span class="keywordflow">if</span> (<a class="code" href="ccnr__proto_8c.html#aca9fa508dbede1f006cfd42bbf0f902a" title="Returns 1 if the Exclude in the interest described by the info parameter would exclude...">r_proto_check_exclude</a>(ccnr, info, es-&gt;<a class="code" href="structenum__state.html#a556983d4b4b1073f7605779c4f488cbb">name</a>) &gt; 0) {
<a name="l01080"></a>01080         <a class="code" href="hashtb_8h.html#a7072bd345c49a74700394947c761f998">hashtb_end</a>(e);
<a name="l01081"></a>01081         <span class="keywordflow">goto</span> Bail;
<a name="l01082"></a>01082     }
<a name="l01083"></a>01083 
<a name="l01084"></a>01084     <span class="comment">// do we have anything that matches this enumeration request?</span>
<a name="l01085"></a>01085     content = <a class="code" href="ccnr__store_8c.html#acf33cf2bbc9d109184f04c57cbd4458d">r_store_find_first_match_candidate</a>(ccnr, interest-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, pi);
<a name="l01086"></a>01086     <span class="keywordflow">if</span> (content != NULL &amp;&amp;
<a name="l01087"></a>01087         !<a class="code" href="ccnr__store_8c.html#a373161d0e77726ee8c135eb03e2a2319">r_store_content_matches_interest_prefix</a>(ccnr, content, interest-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, interest-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>))
<a name="l01088"></a>01088         content = NULL;
<a name="l01089"></a>01089     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;es-&gt;<a class="code" href="structenum__state.html#a50537883df14c53ad8475f35d63a681c">cob</a>[0]);
<a name="l01090"></a>01090     es-&gt;<a class="code" href="structenum__state.html#a50537883df14c53ad8475f35d63a681c">cob</a>[0] = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01091"></a>01091     memset(es-&gt;<a class="code" href="structenum__state.html#a56c207d4d4cb6fb08f023c2451719931">cob_deferred</a>, 0, <span class="keyword">sizeof</span>(es-&gt;<a class="code" href="structenum__state.html#a56c207d4d4cb6fb08f023c2451719931">cob_deferred</a>));
<a name="l01092"></a>01092     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;es-&gt;<a class="code" href="structenum__state.html#aba41a40dd7e71c7f6a431857672fb5b8">reply_body</a>);
<a name="l01093"></a>01093     es-&gt;<a class="code" href="structenum__state.html#aba41a40dd7e71c7f6a431857672fb5b8">reply_body</a> = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01094"></a>01094     <a class="code" href="ccn_8h.html#afc2eb536e63f315968abe901e52b506a" title="Append a start-of-element marker.">ccnb_element_begin</a>(es-&gt;<a class="code" href="structenum__state.html#aba41a40dd7e71c7f6a431857672fb5b8">reply_body</a>, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a5b3b65f26639507aca14d45ec4f4b12b">CCN_DTAG_Collection</a>);
<a name="l01095"></a>01095     es-&gt;<a class="code" href="structenum__state.html#af8d02d1473f589418b8aa7590788eef8">content</a> = content;
<a name="l01096"></a>01096     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;es-&gt;<a class="code" href="structenum__state.html#a523196f897efab74dfba5c732d8597e8">interest</a>);
<a name="l01097"></a>01097     es-&gt;<a class="code" href="structenum__state.html#a523196f897efab74dfba5c732d8597e8">interest</a> = interest;
<a name="l01098"></a>01098     interest = NULL;
<a name="l01099"></a>01099     <a class="code" href="indexbuf_8h.html#a85816e7765050ed93ccdd29210dabfaf" title="Deallocate indexbuf.">ccn_indexbuf_destroy</a>(&amp;es-&gt;<a class="code" href="structenum__state.html#a983b607b7e0f784162e95473917f4e43">interest_comps</a>);
<a name="l01100"></a>01100     es-&gt;<a class="code" href="structenum__state.html#a983b607b7e0f784162e95473917f4e43">interest_comps</a> = comps;
<a name="l01101"></a>01101     comps = NULL;
<a name="l01102"></a>01102     es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a> = 0;
<a name="l01103"></a>01103     es-&gt;<a class="code" href="structenum__state.html#afb0691182f4333d1530b92ee30321e93">lastuse_sec</a> = ccnr-&gt;<a class="code" href="structccnr__handle.html#a018117b25163afe16d015b6c71528a01" title="cached gettime seconds">sec</a>;
<a name="l01104"></a>01104     es-&gt;<a class="code" href="structenum__state.html#af3fe5372ea130351c48712b9a55fb9c9">lastuse_usec</a> = ccnr-&gt;<a class="code" href="structccnr__handle.html#a08e40c533ecdfc9b15fd1b88e7c09c1a" title="cached gettime microseconds">usec</a>;
<a name="l01105"></a>01105     <span class="keywordflow">if</span> (content) {
<a name="l01106"></a>01106         es-&gt;<a class="code" href="structenum__state.html#abe951530e08bf00b087d1c82ae3bdb64">lifetime</a> = 3 * <a class="code" href="ccn_8h.html#a1db8902f71f2d19e0c4064b44d1cb115">ccn_interest_lifetime_seconds</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, pi);
<a name="l01107"></a>01107         es-&gt;<a class="code" href="structenum__state.html#a76892d4297718af6f55d17166ad46822">active</a> = <a class="code" href="ccnr__private_8h.html#a9d0a349f5750f51944256996129ef8eaac46618d3f50abcd35f828f1604867d17">ES_ACTIVE</a>;
<a name="l01108"></a>01108     } <span class="keywordflow">else</span> {
<a name="l01109"></a>01109         es-&gt;<a class="code" href="structenum__state.html#abe951530e08bf00b087d1c82ae3bdb64">lifetime</a> = <a class="code" href="ccn_8h.html#a1db8902f71f2d19e0c4064b44d1cb115">ccn_interest_lifetime_seconds</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, pi);
<a name="l01110"></a>01110         es-&gt;<a class="code" href="structenum__state.html#a76892d4297718af6f55d17166ad46822">active</a> = <a class="code" href="ccnr__private_8h.html#a9d0a349f5750f51944256996129ef8eaa1089b420949e8a5c7e1941661eae5c0b">ES_PENDING</a>;
<a name="l01111"></a>01111     }
<a name="l01112"></a>01112     <a class="code" href="hashtb_8h.html#a7072bd345c49a74700394947c761f998">hashtb_end</a>(e);
<a name="l01113"></a>01113     <a class="code" href="ccnr__proto_8c.html#a1e1ba0c455da37d01178bb2345ff3d44">reap_enumerations_needed</a>(ccnr);
<a name="l01114"></a>01114     <span class="keywordflow">if</span> (content)
<a name="l01115"></a>01115         ans = <a class="code" href="ccnr__proto_8c.html#a3cfb05cf8d7caa123adabe59f4cab40c">r_proto_continue_enumeration</a>(selfp, kind, info, marker_comp);
<a name="l01116"></a>01116     <span class="keywordflow">else</span>
<a name="l01117"></a>01117         ans = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcadadb47635316f12c6542c33cebcfa727" title="normal upcall return">CCN_UPCALL_RESULT_OK</a>;
<a name="l01118"></a>01118 Bail:
<a name="l01119"></a>01119     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l01120"></a>01120     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;interest);
<a name="l01121"></a>01121     <a class="code" href="indexbuf_8h.html#a85816e7765050ed93ccdd29210dabfaf" title="Deallocate indexbuf.">ccn_indexbuf_destroy</a>(&amp;comps);
<a name="l01122"></a>01122     <span class="keywordflow">return</span>(ans);
<a name="l01123"></a>01123 }
<a name="l01124"></a>01124 
<a name="l01125"></a>01125 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a>
<a name="l01126"></a><a class="code" href="ccnr__proto_8c.html#a3cfb05cf8d7caa123adabe59f4cab40c">01126</a> <a class="code" href="ccnr__proto_8c.html#a3cfb05cf8d7caa123adabe59f4cab40c">r_proto_continue_enumeration</a>(<span class="keyword">struct</span> <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *selfp,
<a name="l01127"></a>01127                              <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92" title="This tells what kind of event the upcall is handling.">ccn_upcall_kind</a> kind,
<a name="l01128"></a>01128                              <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info,
<a name="l01129"></a>01129                              <span class="keywordtype">int</span> marker_comp) {
<a name="l01130"></a>01130     <span class="comment">// XXX - watch out for pipelined interests for the enumerations -- there</span>
<a name="l01131"></a>01131     <span class="comment">// MUST be an active enumeration continuation before we do anything here.</span>
<a name="l01132"></a>01132     <span class="comment">// Should chop 1 component off interest -- which will look like</span>
<a name="l01133"></a>01133     <span class="comment">// ccnx:/.../%C1.E.be/%C1.M.K%00.../%FD.../%00%02</span>
<a name="l01134"></a>01134     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *hashkey = NULL;
<a name="l01135"></a>01135     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *result_name = NULL;
<a name="l01136"></a>01136     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *cob = NULL;
<a name="l01137"></a>01137     <span class="keyword">struct </span><a class="code" href="structccn__indexbuf.html">ccn_indexbuf</a> *ic = NULL;
<a name="l01138"></a>01138     intmax_t segment;
<a name="l01139"></a>01139     <span class="keyword">struct </span><a class="code" href="structenum__state.html">enum_state</a> *es = NULL;
<a name="l01140"></a>01140     <span class="keyword">struct </span><a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *ccnr = NULL;
<a name="l01141"></a>01141     <span class="keyword">struct </span><a class="code" href="structhashtb__enumerator.html">hashtb_enumerator</a> enumerator = {0};
<a name="l01142"></a>01142     <span class="keyword">struct </span><a class="code" href="structhashtb__enumerator.html">hashtb_enumerator</a> *e = &amp;enumerator;
<a name="l01143"></a>01143     <span class="keyword">struct </span><a class="code" href="structccn__signing__params.html" title="Parameters for creating signed content objects.">ccn_signing_params</a> sp = <a class="code" href="ccn_8h.html#a4ff046ac820ac0f2ef6acb912a03b328">CCN_SIGNING_PARAMS_INIT</a>;
<a name="l01144"></a>01144     <span class="keywordtype">int</span> cobs_deferred;
<a name="l01145"></a>01145     <span class="keywordtype">int</span> i;
<a name="l01146"></a>01146     <span class="keywordtype">int</span> res = 0;
<a name="l01147"></a>01147     
<a name="l01148"></a>01148     ccnr = (<span class="keyword">struct </span><a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *)selfp-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a>;
<a name="l01149"></a>01149     ic = info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>;
<a name="l01150"></a>01150     hashkey=<a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01151"></a>01151     <a class="code" href="ccn_8h.html#a4aa75ce6fc675e7a4c4c6d65e68817bd" title="Reset charbuf to represent an empty Name in binary format.">ccn_name_init</a>(hashkey);
<a name="l01152"></a>01152     <a class="code" href="ccn_8h.html#a8ea2cc78c18c1aa99f12f44bd70bc7a1" title="Add sequence of ccnb-encoded Components to a ccnb-encoded Name.">ccn_name_append_components</a>(hashkey, info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>,
<a name="l01153"></a>01153                                info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[0],
<a name="l01154"></a>01154                                info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[marker_comp]);
<a name="l01155"></a>01155     <a class="code" href="hashtb_8h.html#a9f99fb4a9a147c8d73c1e6ab9415849d">hashtb_start</a>(ccnr-&gt;<a class="code" href="structccnr__handle.html#a11d69a8caf053c392072b6d07ecb0b2b" title="keyed by enumeration interest">enum_state_tab</a>, e);
<a name="l01156"></a>01156     res = <a class="code" href="hashtb_8h.html#a6a29faf3e0e001fac2a19caf350ed839">hashtb_seek</a>(e, hashkey-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hashkey-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, 0);
<a name="l01157"></a>01157     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;hashkey);
<a name="l01158"></a>01158     <span class="keywordflow">if</span> (res != <a class="code" href="hashtb_8h.html#ad17577840d8e3d79e5e170716201b649">HT_OLD_ENTRY</a>) {
<a name="l01159"></a>01159         <a class="code" href="hashtb_8h.html#a7072bd345c49a74700394947c761f998">hashtb_end</a>(e);
<a name="l01160"></a>01160         <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>);
<a name="l01161"></a>01161     }
<a name="l01162"></a>01162     es = e-&gt;<a class="code" href="structhashtb__enumerator.html#af755f33ac2cc13fa63684f362ac6be1c">data</a>;
<a name="l01163"></a>01163     <span class="keywordflow">if</span> (es-&gt;<a class="code" href="structenum__state.html#a76892d4297718af6f55d17166ad46822">active</a> != <a class="code" href="ccnr__private_8h.html#a9d0a349f5750f51944256996129ef8eaac46618d3f50abcd35f828f1604867d17">ES_ACTIVE</a> &amp;&amp; es-&gt;<a class="code" href="structenum__state.html#a76892d4297718af6f55d17166ad46822">active</a> != <a class="code" href="ccnr__private_8h.html#a9d0a349f5750f51944256996129ef8eaa18866cec422c118912ab6f920c640313">ES_ACTIVE_PENDING_INACTIVE</a>) {
<a name="l01164"></a>01164         <a class="code" href="hashtb_8h.html#a7072bd345c49a74700394947c761f998">hashtb_end</a>(e);
<a name="l01165"></a>01165         <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>);
<a name="l01166"></a>01166     }
<a name="l01167"></a>01167     <span class="comment">// If there is a segment in the request, get the value.</span>
<a name="l01168"></a>01168     segment = <a class="code" href="ccnr__util_8c.html#a244ec75af79d7bea5ec7806a6bea7315">r_util_segment_from_component</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>,
<a name="l01169"></a>01169                                             ic-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[ic-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a> - 2],
<a name="l01170"></a>01170                                             ic-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[ic-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a> - 1]);
<a name="l01171"></a>01171     <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a7323999db7afd7869b7b4ff665e751c8">LM_8</a>, <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>))
<a name="l01172"></a>01172         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;enumeration: requested %jd :: expected %jd&quot;</span>, segment, es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a>);
<a name="l01173"></a>01173     <span class="keywordflow">if</span> (segment &gt;= 0 &amp;&amp; segment != es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a>) {
<a name="l01174"></a>01174         <span class="comment">// too far in the future for us to process</span>
<a name="l01175"></a>01175         <span class="keywordflow">if</span> (segment &gt; es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a> + (<a class="code" href="ccnr__private_8h.html#aad037352217601f68b01e07776c6f0c3">ENUM_N_COBS</a> / 2)) {
<a name="l01176"></a>01176             <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a7323999db7afd7869b7b4ff665e751c8">LM_8</a>, <a class="code" href="loglevels_8h.html#a795a0a3098f6c9ba5990e8a23775284d" title="More debugging.">CCNL_FINER</a>))
<a name="l01177"></a>01177                 <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;enumeration: ignoring future segment requested %jd :: expected %jd&quot;</span>, segment, es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a>);
<a name="l01178"></a>01178             <a class="code" href="hashtb_8h.html#a7072bd345c49a74700394947c761f998">hashtb_end</a>(e);
<a name="l01179"></a>01179             <span class="keywordflow">return</span> (<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcadadb47635316f12c6542c33cebcfa727" title="normal upcall return">CCN_UPCALL_RESULT_OK</a>);
<a name="l01180"></a>01180         }
<a name="l01181"></a>01181         <span class="comment">// if theres a possibility we could have it</span>
<a name="l01182"></a>01182         <span class="keywordflow">if</span> (segment &gt;= es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a> - <a class="code" href="ccnr__private_8h.html#aad037352217601f68b01e07776c6f0c3">ENUM_N_COBS</a>) {
<a name="l01183"></a>01183             cob = es-&gt;<a class="code" href="structenum__state.html#a50537883df14c53ad8475f35d63a681c">cob</a>[segment % <a class="code" href="ccnr__private_8h.html#aad037352217601f68b01e07776c6f0c3">ENUM_N_COBS</a>];
<a name="l01184"></a>01184             <span class="keywordflow">if</span> (cob &amp;&amp;
<a name="l01185"></a>01185                 <a class="code" href="ccn_8h.html#a2e161e1c17ef110dfa019bc1d560c82c" title="Test for a match between a ContentObject and an Interest.">ccn_content_matches_interest</a>(cob-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, cob-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, 1, NULL,
<a name="l01186"></a>01186                                              info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ae3500edfbd06a2be152e0ef8fcc64328">CCN_PI_E</a>], info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>)) {
<a name="l01187"></a>01187                     <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, <a class="code" href="ccnr__private_8h.html#a7323999db7afd7869b7b4ff665e751c8">LM_8</a>, <a class="code" href="loglevels_8h.html#a795a0a3098f6c9ba5990e8a23775284d" title="More debugging.">CCNL_FINER</a>))
<a name="l01188"></a>01188                         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;enumeration: putting cob for out-of-order segment %jd&quot;</span>,
<a name="l01189"></a>01189                                  segment);
<a name="l01190"></a>01190                     <a class="code" href="ccn_8h.html#ac71f5c8727443c13afb11cf471f5f8fc">ccn_put</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, cob-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, cob-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01191"></a>01191                     es-&gt;<a class="code" href="structenum__state.html#a56c207d4d4cb6fb08f023c2451719931">cob_deferred</a>[segment % <a class="code" href="ccnr__private_8h.html#aad037352217601f68b01e07776c6f0c3">ENUM_N_COBS</a>] = 0;
<a name="l01192"></a>01192                     <span class="keywordflow">if</span> (es-&gt;<a class="code" href="structenum__state.html#a76892d4297718af6f55d17166ad46822">active</a> == <a class="code" href="ccnr__private_8h.html#a9d0a349f5750f51944256996129ef8eaa18866cec422c118912ab6f920c640313">ES_ACTIVE_PENDING_INACTIVE</a>) {
<a name="l01193"></a>01193                         <span class="keywordflow">for</span> (i = 0, cobs_deferred = 0; i &lt; <a class="code" href="ccnr__private_8h.html#aad037352217601f68b01e07776c6f0c3">ENUM_N_COBS</a>; i++) {
<a name="l01194"></a>01194                             cobs_deferred += es-&gt;<a class="code" href="structenum__state.html#a56c207d4d4cb6fb08f023c2451719931">cob_deferred</a>[i];
<a name="l01195"></a>01195                         }
<a name="l01196"></a>01196                         <span class="keywordflow">if</span> (cobs_deferred == 0)
<a name="l01197"></a>01197                             <span class="keywordflow">goto</span> EnumerationComplete;
<a name="l01198"></a>01198                     }
<a name="l01199"></a>01199                     <a class="code" href="hashtb_8h.html#a7072bd345c49a74700394947c761f998">hashtb_end</a>(e);
<a name="l01200"></a>01200                     <span class="keywordflow">return</span> (<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca35e0232348739cde04ba6355c4395001" title="upcall claims to consume interest">CCN_UPCALL_RESULT_INTEREST_CONSUMED</a>);
<a name="l01201"></a>01201                 }
<a name="l01202"></a>01202         }
<a name="l01203"></a>01203     }
<a name="l01204"></a>01204 NextSegment:
<a name="l01205"></a>01205     <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, blah, <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>))
<a name="l01206"></a>01206         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;enumeration: generating segment %jd&quot;</span>, es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a>);
<a name="l01207"></a>01207     es-&gt;<a class="code" href="structenum__state.html#afb0691182f4333d1530b92ee30321e93">lastuse_sec</a> = ccnr-&gt;<a class="code" href="structccnr__handle.html#a018117b25163afe16d015b6c71528a01" title="cached gettime seconds">sec</a>;
<a name="l01208"></a>01208     es-&gt;<a class="code" href="structenum__state.html#af3fe5372ea130351c48712b9a55fb9c9">lastuse_usec</a> = ccnr-&gt;<a class="code" href="structccnr__handle.html#a08e40c533ecdfc9b15fd1b88e7c09c1a" title="cached gettime microseconds">usec</a>;
<a name="l01209"></a>01209     <span class="keywordflow">while</span> (es-&gt;<a class="code" href="structenum__state.html#af8d02d1473f589418b8aa7590788eef8">content</a> != NULL &amp;&amp;
<a name="l01210"></a>01210            <a class="code" href="ccnr__store_8c.html#a373161d0e77726ee8c135eb03e2a2319">r_store_content_matches_interest_prefix</a>(ccnr, es-&gt;<a class="code" href="structenum__state.html#af8d02d1473f589418b8aa7590788eef8">content</a>,
<a name="l01211"></a>01211                                                    es-&gt;<a class="code" href="structenum__state.html#a523196f897efab74dfba5c732d8597e8">interest</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>,
<a name="l01212"></a>01212                                                    es-&gt;<a class="code" href="structenum__state.html#a523196f897efab74dfba5c732d8597e8">interest</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>)) {
<a name="l01213"></a>01213         <span class="keywordtype">int</span> save = es-&gt;<a class="code" href="structenum__state.html#aba41a40dd7e71c7f6a431857672fb5b8">reply_body</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>;
<a name="l01214"></a>01214         <a class="code" href="ccn_8h.html#afc2eb536e63f315968abe901e52b506a" title="Append a start-of-element marker.">ccnb_element_begin</a>(es-&gt;<a class="code" href="structenum__state.html#aba41a40dd7e71c7f6a431857672fb5b8">reply_body</a>, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33ad6154d93cb98378617c667731ecf5c32">CCN_DTAG_Link</a>);
<a name="l01215"></a>01215         <a class="code" href="ccn_8h.html#afc2eb536e63f315968abe901e52b506a" title="Append a start-of-element marker.">ccnb_element_begin</a>(es-&gt;<a class="code" href="structenum__state.html#aba41a40dd7e71c7f6a431857672fb5b8">reply_body</a>, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a7903556a9a07652962c02014f7f7832f">CCN_DTAG_Name</a>);
<a name="l01216"></a>01216         <a class="code" href="ccn_8h.html#aa46b72f2e6b3b7f7753ff3baaa4efdf8" title="Append an end-of-element marker.">ccnb_element_end</a>(es-&gt;<a class="code" href="structenum__state.html#aba41a40dd7e71c7f6a431857672fb5b8">reply_body</a>); <span class="comment">/* &lt;/Name&gt; */</span>
<a name="l01217"></a>01217         res = <a class="code" href="ccnr__store_8c.html#a1174393741ef6f2a3b513766dcf29a97">r_store_name_append_components</a>(es-&gt;<a class="code" href="structenum__state.html#aba41a40dd7e71c7f6a431857672fb5b8">reply_body</a>, ccnr, es-&gt;<a class="code" href="structenum__state.html#af8d02d1473f589418b8aa7590788eef8">content</a>, es-&gt;<a class="code" href="structenum__state.html#a983b607b7e0f784162e95473917f4e43">interest_comps</a>-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a> - 1, 1);
<a name="l01218"></a>01218         <a class="code" href="ccn_8h.html#aa46b72f2e6b3b7f7753ff3baaa4efdf8" title="Append an end-of-element marker.">ccnb_element_end</a>(es-&gt;<a class="code" href="structenum__state.html#aba41a40dd7e71c7f6a431857672fb5b8">reply_body</a>); <span class="comment">/* &lt;/Link&gt; */</span>
<a name="l01219"></a>01219         <span class="keywordflow">if</span> (res == 0) {
<a name="l01220"></a>01220             <span class="comment">/* The name matched exactly, need to skip. */</span>
<a name="l01221"></a>01221             es-&gt;<a class="code" href="structenum__state.html#aba41a40dd7e71c7f6a431857672fb5b8">reply_body</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> = save;
<a name="l01222"></a>01222             es-&gt;<a class="code" href="structenum__state.html#af8d02d1473f589418b8aa7590788eef8">content</a> = <a class="code" href="ccnr__store_8c.html#ab179aa8dea9df6c5183b2eaf55c45ad5">r_store_next_child_at_level</a>(ccnr, es-&gt;<a class="code" href="structenum__state.html#af8d02d1473f589418b8aa7590788eef8">content</a>, es-&gt;<a class="code" href="structenum__state.html#a983b607b7e0f784162e95473917f4e43">interest_comps</a>-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a> - 1);
<a name="l01223"></a>01223             <span class="keywordflow">continue</span>;
<a name="l01224"></a>01224         }
<a name="l01225"></a>01225         <span class="keywordflow">if</span> (res != 1) {
<a name="l01226"></a>01226             <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;oops&quot;</span>, NULL, es-&gt;<a class="code" href="structenum__state.html#a523196f897efab74dfba5c732d8597e8">interest</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, es-&gt;<a class="code" href="structenum__state.html#a523196f897efab74dfba5c732d8597e8">interest</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01227"></a>01227             <a class="code" href="ccnr__store_8c.html#a4967ebff8011a63877d2add998be5cfc">ccnr_debug_content</a>(ccnr, __LINE__, <span class="stringliteral">&quot;oops&quot;</span>, NULL, es-&gt;<a class="code" href="structenum__state.html#af8d02d1473f589418b8aa7590788eef8">content</a>);
<a name="l01228"></a>01228             abort();
<a name="l01229"></a>01229         }
<a name="l01230"></a>01230         es-&gt;<a class="code" href="structenum__state.html#af8d02d1473f589418b8aa7590788eef8">content</a> = <a class="code" href="ccnr__store_8c.html#ab179aa8dea9df6c5183b2eaf55c45ad5">r_store_next_child_at_level</a>(ccnr, es-&gt;<a class="code" href="structenum__state.html#af8d02d1473f589418b8aa7590788eef8">content</a>, es-&gt;<a class="code" href="structenum__state.html#a983b607b7e0f784162e95473917f4e43">interest_comps</a>-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a> - 1);
<a name="l01231"></a>01231         <span class="keywordflow">if</span> (es-&gt;<a class="code" href="structenum__state.html#aba41a40dd7e71c7f6a431857672fb5b8">reply_body</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> &gt;= 4096) {
<a name="l01232"></a>01232             result_name = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01233"></a>01233             <a class="code" href="charbuf_8h.html#aca88638b2e81602eb4a1da9be923dad7">ccn_charbuf_append_charbuf</a>(result_name, es-&gt;<a class="code" href="structenum__state.html#a556983d4b4b1073f7605779c4f488cbb">name</a>);
<a name="l01234"></a>01234             <a class="code" href="ccn_8h.html#a3b95a770555b90f43d4876bea62c202d" title="Add a binary Component to a ccnb-encoded Name.">ccn_name_append_numeric</a>(result_name, <a class="code" href="ccn_8h.html#afec910e39c89dcf24a44f93e97032399af3eb8e7fa3a938a5bcc6c1f141357d71" title="consecutive block sequence numbers">CCN_MARKER_SEQNUM</a>, es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a>);
<a name="l01235"></a>01235             sp.<a class="code" href="structccn__signing__params.html#a768c61b9b4e01e677bcd89f6be350367">freshness</a> = 60;
<a name="l01236"></a>01236             cob = es-&gt;<a class="code" href="structenum__state.html#a50537883df14c53ad8475f35d63a681c">cob</a>[es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a> % <a class="code" href="ccnr__private_8h.html#aad037352217601f68b01e07776c6f0c3">ENUM_N_COBS</a>];
<a name="l01237"></a>01237             <span class="keywordflow">if</span> (cob == NULL) {
<a name="l01238"></a>01238                 cob = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01239"></a>01239                 es-&gt;<a class="code" href="structenum__state.html#a50537883df14c53ad8475f35d63a681c">cob</a>[es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a> % <a class="code" href="ccnr__private_8h.html#aad037352217601f68b01e07776c6f0c3">ENUM_N_COBS</a>] = cob;
<a name="l01240"></a>01240             }
<a name="l01241"></a>01241             cob-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> = 0;
<a name="l01242"></a>01242             res = <a class="code" href="ccn_8h.html#a95240bd470b549c89a5e0fd72fa34d45" title="Create a signed ContentObject.">ccn_sign_content</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, cob, result_name, &amp;sp,
<a name="l01243"></a>01243                                    es-&gt;<a class="code" href="structenum__state.html#aba41a40dd7e71c7f6a431857672fb5b8">reply_body</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, 4096);
<a name="l01244"></a>01244             <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;result_name);
<a name="l01245"></a>01245             <span class="keywordflow">if</span> (segment == -1 || segment == es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a>) {
<a name="l01246"></a>01246                 <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, blah, <a class="code" href="loglevels_8h.html#a795a0a3098f6c9ba5990e8a23775284d" title="More debugging.">CCNL_FINER</a>))
<a name="l01247"></a>01247                     <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;enumeration: putting cob for segment %jd&quot;</span>, es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a>);
<a name="l01248"></a>01248                 <a class="code" href="ccn_8h.html#ac71f5c8727443c13afb11cf471f5f8fc">ccn_put</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, cob-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, cob-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01249"></a>01249             } <span class="keywordflow">else</span> {
<a name="l01250"></a>01250                 es-&gt;<a class="code" href="structenum__state.html#a56c207d4d4cb6fb08f023c2451719931">cob_deferred</a>[es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a> % <a class="code" href="ccnr__private_8h.html#aad037352217601f68b01e07776c6f0c3">ENUM_N_COBS</a>] = 1;
<a name="l01251"></a>01251             }
<a name="l01252"></a>01252             es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a>++;
<a name="l01253"></a>01253             memmove(es-&gt;<a class="code" href="structenum__state.html#aba41a40dd7e71c7f6a431857672fb5b8">reply_body</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, es-&gt;<a class="code" href="structenum__state.html#aba41a40dd7e71c7f6a431857672fb5b8">reply_body</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a> + 4096, es-&gt;<a class="code" href="structenum__state.html#aba41a40dd7e71c7f6a431857672fb5b8">reply_body</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> - 4096);
<a name="l01254"></a>01254             es-&gt;<a class="code" href="structenum__state.html#aba41a40dd7e71c7f6a431857672fb5b8">reply_body</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> -= 4096;
<a name="l01255"></a>01255             <span class="keywordflow">if</span> (segment &gt;= es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a>)
<a name="l01256"></a>01256                  <span class="keywordflow">goto</span> NextSegment;
<a name="l01257"></a>01257             <a class="code" href="hashtb_8h.html#a7072bd345c49a74700394947c761f998">hashtb_end</a>(e);
<a name="l01258"></a>01258             <span class="keywordflow">return</span> (<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca35e0232348739cde04ba6355c4395001" title="upcall claims to consume interest">CCN_UPCALL_RESULT_INTEREST_CONSUMED</a>);
<a name="l01259"></a>01259         }
<a name="l01260"></a>01260     }
<a name="l01261"></a>01261     <span class="comment">// we will only get here if we are finishing an in-progress enumeration</span>
<a name="l01262"></a>01262     <a class="code" href="ccn_8h.html#aa46b72f2e6b3b7f7753ff3baaa4efdf8" title="Append an end-of-element marker.">ccnb_element_end</a>(es-&gt;<a class="code" href="structenum__state.html#aba41a40dd7e71c7f6a431857672fb5b8">reply_body</a>); <span class="comment">/* &lt;/Collection&gt; */</span>
<a name="l01263"></a>01263     result_name = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01264"></a>01264     <a class="code" href="charbuf_8h.html#aca88638b2e81602eb4a1da9be923dad7">ccn_charbuf_append_charbuf</a>(result_name, es-&gt;<a class="code" href="structenum__state.html#a556983d4b4b1073f7605779c4f488cbb">name</a>);
<a name="l01265"></a>01265     <a class="code" href="ccn_8h.html#a3b95a770555b90f43d4876bea62c202d" title="Add a binary Component to a ccnb-encoded Name.">ccn_name_append_numeric</a>(result_name, <a class="code" href="ccn_8h.html#afec910e39c89dcf24a44f93e97032399af3eb8e7fa3a938a5bcc6c1f141357d71" title="consecutive block sequence numbers">CCN_MARKER_SEQNUM</a>, es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a>);
<a name="l01266"></a>01266     sp.<a class="code" href="structccn__signing__params.html#a768c61b9b4e01e677bcd89f6be350367">freshness</a> = 60;
<a name="l01267"></a>01267     sp.<a class="code" href="structccn__signing__params.html#a2b9c1f834abea9bd43f1d901e852802e">sp_flags</a> |= <a class="code" href="ccn_8h.html#abff51f3f313d457fbcc13006343fdd28">CCN_SP_FINAL_BLOCK</a>;
<a name="l01268"></a>01268     cob = es-&gt;<a class="code" href="structenum__state.html#a50537883df14c53ad8475f35d63a681c">cob</a>[es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a> % <a class="code" href="ccnr__private_8h.html#aad037352217601f68b01e07776c6f0c3">ENUM_N_COBS</a>];
<a name="l01269"></a>01269     <span class="keywordflow">if</span> (cob == NULL) {
<a name="l01270"></a>01270         cob = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01271"></a>01271         es-&gt;<a class="code" href="structenum__state.html#a50537883df14c53ad8475f35d63a681c">cob</a>[es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a> % <a class="code" href="ccnr__private_8h.html#aad037352217601f68b01e07776c6f0c3">ENUM_N_COBS</a>] = cob;
<a name="l01272"></a>01272     }
<a name="l01273"></a>01273     cob-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> = 0;
<a name="l01274"></a>01274     res = <a class="code" href="ccn_8h.html#a95240bd470b549c89a5e0fd72fa34d45" title="Create a signed ContentObject.">ccn_sign_content</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, cob, result_name, &amp;sp, es-&gt;<a class="code" href="structenum__state.html#aba41a40dd7e71c7f6a431857672fb5b8">reply_body</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>,
<a name="l01275"></a>01275                            es-&gt;<a class="code" href="structenum__state.html#aba41a40dd7e71c7f6a431857672fb5b8">reply_body</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01276"></a>01276     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;result_name);    
<a name="l01277"></a>01277     <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, blah, <a class="code" href="loglevels_8h.html#a795a0a3098f6c9ba5990e8a23775284d" title="More debugging.">CCNL_FINER</a>))
<a name="l01278"></a>01278         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;enumeration: putting final cob for segment %jd&quot;</span>, es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a>);
<a name="l01279"></a>01279     <a class="code" href="ccn_8h.html#ac71f5c8727443c13afb11cf471f5f8fc">ccn_put</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, cob-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, cob-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01280"></a>01280     es-&gt;<a class="code" href="structenum__state.html#a56c207d4d4cb6fb08f023c2451719931">cob_deferred</a>[es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a> % <a class="code" href="ccnr__private_8h.html#aad037352217601f68b01e07776c6f0c3">ENUM_N_COBS</a>] = 0;
<a name="l01281"></a>01281     <span class="keywordflow">for</span> (i = 0, cobs_deferred = 0; i &lt; <a class="code" href="ccnr__private_8h.html#aad037352217601f68b01e07776c6f0c3">ENUM_N_COBS</a>; i++) {
<a name="l01282"></a>01282         cobs_deferred += es-&gt;<a class="code" href="structenum__state.html#a56c207d4d4cb6fb08f023c2451719931">cob_deferred</a>[i];
<a name="l01283"></a>01283     }
<a name="l01284"></a>01284     <span class="keywordflow">if</span> (cobs_deferred &gt; 0) {
<a name="l01285"></a>01285         <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, blah, <a class="code" href="loglevels_8h.html#a795a0a3098f6c9ba5990e8a23775284d" title="More debugging.">CCNL_FINER</a>))
<a name="l01286"></a>01286             <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;enumeration: %d pending cobs, inactive pending complete&quot;</span>,
<a name="l01287"></a>01287                      cobs_deferred);
<a name="l01288"></a>01288         es-&gt;<a class="code" href="structenum__state.html#a76892d4297718af6f55d17166ad46822">active</a> = <a class="code" href="ccnr__private_8h.html#a9d0a349f5750f51944256996129ef8eaa18866cec422c118912ab6f920c640313">ES_ACTIVE_PENDING_INACTIVE</a>;
<a name="l01289"></a>01289         <a class="code" href="hashtb_8h.html#a7072bd345c49a74700394947c761f998">hashtb_end</a>(e);
<a name="l01290"></a>01290         <span class="keywordflow">return</span> (<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca35e0232348739cde04ba6355c4395001" title="upcall claims to consume interest">CCN_UPCALL_RESULT_INTEREST_CONSUMED</a>);
<a name="l01291"></a>01291     }
<a name="l01292"></a>01292 EnumerationComplete:
<a name="l01293"></a>01293     <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, blah, <a class="code" href="loglevels_8h.html#a795a0a3098f6c9ba5990e8a23775284d" title="More debugging.">CCNL_FINER</a>))
<a name="l01294"></a>01294         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;enumeration: inactive&quot;</span>, es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a>);
<a name="l01295"></a>01295     <span class="comment">// The enumeration is complete, free charbufs but leave the name.</span>
<a name="l01296"></a>01296     es-&gt;<a class="code" href="structenum__state.html#a76892d4297718af6f55d17166ad46822">active</a> = <a class="code" href="ccnr__private_8h.html#a9d0a349f5750f51944256996129ef8eaa2fbb7bd9e6595187077698d89a850e0a">ES_INACTIVE</a>;
<a name="l01297"></a>01297     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;es-&gt;<a class="code" href="structenum__state.html#a523196f897efab74dfba5c732d8597e8">interest</a>);
<a name="l01298"></a>01298     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;es-&gt;<a class="code" href="structenum__state.html#aba41a40dd7e71c7f6a431857672fb5b8">reply_body</a>);
<a name="l01299"></a>01299     <span class="keywordflow">for</span> (i = 0; i &lt; ENUM_N_COBS; i++)
<a name="l01300"></a>01300         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;es-&gt;<a class="code" href="structenum__state.html#a50537883df14c53ad8475f35d63a681c">cob</a>[i]);
<a name="l01301"></a>01301     <a class="code" href="indexbuf_8h.html#a85816e7765050ed93ccdd29210dabfaf" title="Deallocate indexbuf.">ccn_indexbuf_destroy</a>(&amp;es-&gt;<a class="code" href="structenum__state.html#a983b607b7e0f784162e95473917f4e43">interest_comps</a>);
<a name="l01302"></a>01302     <a class="code" href="hashtb_8h.html#a7072bd345c49a74700394947c761f998">hashtb_end</a>(e);
<a name="l01303"></a>01303     <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca35e0232348739cde04ba6355c4395001" title="upcall claims to consume interest">CCN_UPCALL_RESULT_INTEREST_CONSUMED</a>);
<a name="l01304"></a>01304 }
<a name="l01305"></a>01305 
<a name="l01306"></a>01306 <span class="keywordtype">void</span>
<a name="l01307"></a><a class="code" href="ccnr__proto_8c.html#aae05c0877f3d803804ee2703f6c6f727">01307</a> <a class="code" href="ccnr__proto_8c.html#aae05c0877f3d803804ee2703f6c6f727">r_proto_dump_enums</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *ccnr)
<a name="l01308"></a>01308 {
<a name="l01309"></a>01309     <span class="keyword">struct </span><a class="code" href="structenum__state.html">enum_state</a> *es = NULL;
<a name="l01310"></a>01310     <span class="keyword">struct </span><a class="code" href="structhashtb__enumerator.html">hashtb_enumerator</a> enumerator = {0};
<a name="l01311"></a>01311     <span class="keyword">struct </span><a class="code" href="structhashtb__enumerator.html">hashtb_enumerator</a> *e = &amp;enumerator;
<a name="l01312"></a>01312     
<a name="l01313"></a>01313     <span class="keywordflow">for</span> (<a class="code" href="hashtb_8h.html#a9f99fb4a9a147c8d73c1e6ab9415849d">hashtb_start</a>(ccnr-&gt;<a class="code" href="structccnr__handle.html#a11d69a8caf053c392072b6d07ecb0b2b" title="keyed by enumeration interest">enum_state_tab</a>, e); e-&gt;<a class="code" href="structhashtb__enumerator.html#af755f33ac2cc13fa63684f362ac6be1c">data</a> != NULL; <a class="code" href="hashtb_8h.html#ac734849284c60658f52525f200acf38d">hashtb_next</a>(e)) {
<a name="l01314"></a>01314         es = e-&gt;<a class="code" href="structhashtb__enumerator.html#af755f33ac2cc13fa63684f362ac6be1c">data</a>;
<a name="l01315"></a>01315         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;Enumeration active: %d, next segment %d, cookie %u&quot;</span>,
<a name="l01316"></a>01316                  es-&gt;<a class="code" href="structenum__state.html#a76892d4297718af6f55d17166ad46822">active</a>, es-&gt;<a class="code" href="structenum__state.html#a30a987df0999bff3466605eab62fce68">next_segment</a>, es-&gt;<a class="code" href="structenum__state.html#aa96f4d061cb4809f43f1049ab850432c">starting_cookie</a>);
<a name="l01317"></a>01317         <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;     enum name&quot;</span>, NULL,
<a name="l01318"></a>01318                         es-&gt;<a class="code" href="structenum__state.html#a556983d4b4b1073f7605779c4f488cbb">name</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, es-&gt;<a class="code" href="structenum__state.html#a556983d4b4b1073f7605779c4f488cbb">name</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01319"></a>01319         
<a name="l01320"></a>01320     }  
<a name="l01321"></a>01321     <a class="code" href="hashtb_8h.html#a7072bd345c49a74700394947c761f998">hashtb_end</a>(e);
<a name="l01322"></a>01322 }
<a name="l01323"></a>01323 
<a name="l01324"></a>01324 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a>
<a name="l01325"></a><a class="code" href="ccnr__proto_8c.html#a563189db2b1adcbad622696782ac0440">01325</a> <a class="code" href="ccnr__proto_8c.html#a563189db2b1adcbad622696782ac0440">r_proto_bulk_import</a>(<span class="keyword">struct</span> <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *selfp,
<a name="l01326"></a>01326                           <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92" title="This tells what kind of event the upcall is handling.">ccn_upcall_kind</a> kind,
<a name="l01327"></a>01327                           <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info,
<a name="l01328"></a>01328                           <span class="keywordtype">int</span> marker_comp)
<a name="l01329"></a>01329 {
<a name="l01330"></a>01330     <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a> ans = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>;
<a name="l01331"></a>01331     <span class="keyword">struct </span><a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *ccnr = NULL;
<a name="l01332"></a>01332     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *filename = NULL;
<a name="l01333"></a>01333     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *filename2 = NULL;
<a name="l01334"></a>01334     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *mstart = NULL;
<a name="l01335"></a>01335     <span class="keywordtype">size_t</span> mlength;
<a name="l01336"></a>01336     <span class="keyword">struct </span><a class="code" href="structccn__indexbuf.html">ccn_indexbuf</a> *ic = NULL;
<a name="l01337"></a>01337     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *msg = NULL;
<a name="l01338"></a>01338     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = NULL;
<a name="l01339"></a>01339     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *reply_body = NULL;
<a name="l01340"></a>01340     <span class="keyword">struct </span><a class="code" href="structccn__signing__params.html" title="Parameters for creating signed content objects.">ccn_signing_params</a> sp = <a class="code" href="ccn_8h.html#a4ff046ac820ac0f2ef6acb912a03b328">CCN_SIGNING_PARAMS_INIT</a>;
<a name="l01341"></a>01341     <span class="keyword">const</span> <span class="keywordtype">char</span> *infostring = <span class="stringliteral">&quot;OK&quot;</span>;
<a name="l01342"></a>01342     <span class="keywordtype">int</span> res;
<a name="l01343"></a>01343     
<a name="l01344"></a>01344     ccnr = (<span class="keyword">struct </span><a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *)selfp-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a>;
<a name="l01345"></a>01345     <a class="code" href="ccn_8h.html#a70c13909ea45ffb1069916d7a512fdda" title="Extract a pointer to and size of component at given index i.">ccn_name_comp_get</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>, marker_comp,
<a name="l01346"></a>01346                       &amp;mstart, &amp;mlength);
<a name="l01347"></a>01347     <span class="keywordflow">if</span> (mlength &lt;= strlen(<a class="code" href="ccnr__proto_8h.html#a877a26069de692ac0821c8b96fa54693">REPO_AF</a>) + 1 || mstart[strlen(<a class="code" href="ccnr__proto_8h.html#a877a26069de692ac0821c8b96fa54693">REPO_AF</a>)] != <span class="charliteral">&#39;~&#39;</span>) {
<a name="l01348"></a>01348         infostring = <span class="stringliteral">&quot;missing or malformed bulk import name component&quot;</span>;
<a name="l01349"></a>01349         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;r_proto_bulk_import: %s&quot;</span>, infostring);
<a name="l01350"></a>01350         <span class="keywordflow">goto</span> Reply;
<a name="l01351"></a>01351     }
<a name="l01352"></a>01352     mstart += strlen(<a class="code" href="ccnr__proto_8h.html#a877a26069de692ac0821c8b96fa54693">REPO_AF</a>) + 1;
<a name="l01353"></a>01353     mlength -= (strlen(<a class="code" href="ccnr__proto_8h.html#a877a26069de692ac0821c8b96fa54693">REPO_AF</a>) + 1);
<a name="l01354"></a>01354     <span class="keywordflow">if</span> (memchr(mstart, <span class="charliteral">&#39;/&#39;</span>, mlength) != NULL) {
<a name="l01355"></a>01355         infostring = <span class="stringliteral">&quot;bulk import filename must not include directory&quot;</span>;
<a name="l01356"></a>01356         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;r_proto_bulk_import: %s&quot;</span>, infostring);
<a name="l01357"></a>01357         <span class="keywordflow">goto</span> Reply;
<a name="l01358"></a>01358     }
<a name="l01359"></a>01359     filename = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01360"></a>01360     <a class="code" href="charbuf_8h.html#a12190393f4067f51977b2d702ae6d8a4">ccn_charbuf_append_string</a>(filename, <span class="stringliteral">&quot;import/&quot;</span>);
<a name="l01361"></a>01361     <a class="code" href="charbuf_8h.html#a5cc5c1412e38c015951394fcd79e2f6e">ccn_charbuf_append</a>(filename, mstart, mlength);
<a name="l01362"></a>01362     res = <a class="code" href="ccnr__init_8c.html#a738b47c78e8a6eafed6cc926567b09ab">r_init_map_and_process_file</a>(ccnr, filename, 0);
<a name="l01363"></a>01363     <span class="keywordflow">if</span> (res == 1) {
<a name="l01364"></a>01364         infostring = <span class="stringliteral">&quot;unable to open bulk import file&quot;</span>;
<a name="l01365"></a>01365         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;r_proto_bulk_import: %s&quot;</span>, infostring);
<a name="l01366"></a>01366         <span class="keywordflow">goto</span> Reply;
<a name="l01367"></a>01367     }
<a name="l01368"></a>01368     <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01369"></a>01369         infostring = <span class="stringliteral">&quot;error parsing bulk import file&quot;</span>;
<a name="l01370"></a>01370         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;r_proto_bulk_import: %s&quot;</span>, infostring);
<a name="l01371"></a>01371         <span class="keywordflow">goto</span> Reply;
<a name="l01372"></a>01372     }
<a name="l01373"></a>01373     <span class="comment">/* we think we can process it */</span>
<a name="l01374"></a>01374     filename-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> = 0;
<a name="l01375"></a>01375     <a class="code" href="charbuf_8h.html#a942c4bc14fffdbacfbc0fb477b01125e">ccn_charbuf_putf</a>(filename, <span class="stringliteral">&quot;%s/import/&quot;</span>, ccnr-&gt;<a class="code" href="structccnr__handle.html#ae3ca616edc1adffe6941a0d8113e434f" title="the repository directory">directory</a>);
<a name="l01376"></a>01376     <a class="code" href="charbuf_8h.html#a5cc5c1412e38c015951394fcd79e2f6e">ccn_charbuf_append</a>(filename, mstart, mlength);
<a name="l01377"></a>01377     filename2 = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01378"></a>01378     <a class="code" href="charbuf_8h.html#a942c4bc14fffdbacfbc0fb477b01125e">ccn_charbuf_putf</a>(filename2, <span class="stringliteral">&quot;%s/import/.&quot;</span>, ccnr-&gt;<a class="code" href="structccnr__handle.html#ae3ca616edc1adffe6941a0d8113e434f" title="the repository directory">directory</a>);
<a name="l01379"></a>01379     <a class="code" href="charbuf_8h.html#a5cc5c1412e38c015951394fcd79e2f6e">ccn_charbuf_append</a>(filename2, mstart, mlength);
<a name="l01380"></a>01380     res = rename(<a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(filename),
<a name="l01381"></a>01381                  <a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(filename2));
<a name="l01382"></a>01382     <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01383"></a>01383         infostring = <span class="stringliteral">&quot;error renaming bulk import file&quot;</span>;
<a name="l01384"></a>01384         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;r_proto_bulk_import: %s&quot;</span>, infostring);
<a name="l01385"></a>01385         <span class="keywordflow">goto</span> Reply;        
<a name="l01386"></a>01386     }
<a name="l01387"></a>01387     filename-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> = 0;
<a name="l01388"></a>01388     <a class="code" href="charbuf_8h.html#a12190393f4067f51977b2d702ae6d8a4">ccn_charbuf_append_string</a>(filename, <span class="stringliteral">&quot;import/.&quot;</span>);
<a name="l01389"></a>01389     <a class="code" href="charbuf_8h.html#a5cc5c1412e38c015951394fcd79e2f6e">ccn_charbuf_append</a>(filename, mstart, mlength);
<a name="l01390"></a>01390     res = <a class="code" href="ccnr__init_8c.html#a738b47c78e8a6eafed6cc926567b09ab">r_init_map_and_process_file</a>(ccnr, filename, 1);
<a name="l01391"></a>01391     <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01392"></a>01392         infostring = <span class="stringliteral">&quot;error merging bulk import file&quot;</span>;
<a name="l01393"></a>01393         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;r_proto_bulk_import: %s&quot;</span>, infostring);
<a name="l01394"></a>01394         <span class="comment">// fall through and unlink anyway</span>
<a name="l01395"></a>01395     }
<a name="l01396"></a>01396     <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, sdfdf, <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>))
<a name="l01397"></a>01397         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(ccnr, <span class="stringliteral">&quot;unlinking bulk import file %s&quot;</span>, <a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(filename2));   
<a name="l01398"></a>01398     unlink(<a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(filename2));
<a name="l01399"></a>01399 
<a name="l01400"></a>01400 Reply:
<a name="l01401"></a>01401     <span class="comment">/* Generate our reply */</span>
<a name="l01402"></a>01402     name = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01403"></a>01403     <a class="code" href="ccn_8h.html#a4aa75ce6fc675e7a4c4c6d65e68817bd" title="Reset charbuf to represent an empty Name in binary format.">ccn_name_init</a>(name);
<a name="l01404"></a>01404     ic = info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>;
<a name="l01405"></a>01405     <a class="code" href="ccn_8h.html#a8ea2cc78c18c1aa99f12f44bd70bc7a1" title="Add sequence of ccnb-encoded Components to a ccnb-encoded Name.">ccn_name_append_components</a>(name, info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, ic-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[0], ic-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[ic-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a> - 1]);
<a name="l01406"></a>01406 
<a name="l01407"></a>01407     msg = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01408"></a>01408     reply_body = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01409"></a>01409     <a class="code" href="ccnr__proto_8c.html#a9b4a35b4d6f63e221a2238c2024ef911" title="Construct a charbuf with an encoding of a RepositoryInfo.">r_proto_append_repo_info</a>(ccnr, reply_body, NULL, infostring);
<a name="l01410"></a>01410     sp.<a class="code" href="structccn__signing__params.html#a768c61b9b4e01e677bcd89f6be350367">freshness</a> = 12; <span class="comment">/* Seconds */</span>
<a name="l01411"></a>01411     res = <a class="code" href="ccn_8h.html#a95240bd470b549c89a5e0fd72fa34d45" title="Create a signed ContentObject.">ccn_sign_content</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, msg, name, &amp;sp,
<a name="l01412"></a>01412                            reply_body-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, reply_body-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01413"></a>01413     <span class="keywordflow">if</span> (res &lt; 0)
<a name="l01414"></a>01414         <span class="keywordflow">goto</span> Bail;
<a name="l01415"></a>01415     res = <a class="code" href="ccn_8h.html#ac71f5c8727443c13afb11cf471f5f8fc">ccn_put</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, msg-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, msg-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01416"></a>01416     <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01417"></a>01417         <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;r_proto_bulk_import ccn_put FAILED&quot;</span>, NULL,
<a name="l01418"></a>01418                         msg-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, msg-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01419"></a>01419         <span class="keywordflow">goto</span> Bail;
<a name="l01420"></a>01420     }
<a name="l01421"></a>01421     ans = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca35e0232348739cde04ba6355c4395001" title="upcall claims to consume interest">CCN_UPCALL_RESULT_INTEREST_CONSUMED</a>;
<a name="l01422"></a>01422 
<a name="l01423"></a>01423 Bail:
<a name="l01424"></a>01424     <span class="keywordflow">if</span> (filename != NULL) <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;filename);
<a name="l01425"></a>01425     <span class="keywordflow">if</span> (filename2 != NULL) <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;filename2);
<a name="l01426"></a>01426     <span class="keywordflow">if</span> (name != NULL) <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l01427"></a>01427     <span class="keywordflow">if</span> (msg != NULL) <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;msg);
<a name="l01428"></a>01428     <span class="keywordflow">if</span> (reply_body != NULL) <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;reply_body);
<a name="l01429"></a>01429     <span class="keywordflow">return</span> (ans);
<a name="l01430"></a>01430 }
<a name="l01431"></a>01431 
<a name="l01432"></a>01432 <span class="comment">/* Construct a charbuf with an encoding of a Policy object </span>
<a name="l01433"></a>01433 <span class="comment"> *</span>
<a name="l01434"></a>01434 <span class="comment"> *  &lt;xs:complexType name=&quot;PolicyType&quot;&gt;</span>
<a name="l01435"></a>01435 <span class="comment"> *      &lt;xs:sequence&gt;</span>
<a name="l01436"></a>01436 <span class="comment"> *      &lt;xs:element name=&quot;PolicyVersion&quot; type=&quot;xs:string&quot;/&gt; </span>
<a name="l01437"></a>01437 <span class="comment"> *      &lt;xs:element name=&quot;LocalName&quot; type=&quot;xs:string&quot;/&gt;</span>
<a name="l01438"></a>01438 <span class="comment"> *      &lt;xs:element name=&quot;GlobalPrefix&quot; type=&quot;xs:string&quot;/&gt;</span>
<a name="l01439"></a>01439 <span class="comment"> *  &lt;!-- 0 or more names --&gt;</span>
<a name="l01440"></a>01440 <span class="comment"> *      &lt;xs:element name=&quot;Namespace&quot; type=&quot;xs:string&quot; minOccurs=&quot;0&quot; maxOccurs=&quot;unbounded&quot;/&gt;</span>
<a name="l01441"></a>01441 <span class="comment"> *      &lt;/xs:sequence&gt;</span>
<a name="l01442"></a>01442 <span class="comment"> *  &lt;/xs:complexType&gt;</span>
<a name="l01443"></a>01443 <span class="comment"> */</span> 
<a name="l01444"></a>01444 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keywordtype">int</span>
<a name="l01445"></a><a class="code" href="ccnr__proto_8h.html#ade02a3f868c0d42b519ea9ec9185ab44">01445</a> <a class="code" href="ccnr__proto_8c.html#a03f6adb892890e069ed2de424f5f7471">r_proto_policy_append_basic</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *ccnr,
<a name="l01446"></a>01446                             <span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *policy,
<a name="l01447"></a>01447                             <span class="keyword">const</span> <span class="keywordtype">char</span> *version, <span class="keyword">const</span> <span class="keywordtype">char</span> *local_name,
<a name="l01448"></a>01448                             <span class="keyword">const</span> <span class="keywordtype">char</span> *global_prefix)
<a name="l01449"></a>01449 {
<a name="l01450"></a>01450     <span class="keywordtype">int</span> res;
<a name="l01451"></a>01451     res = <a class="code" href="ccn_8h.html#afc2eb536e63f315968abe901e52b506a" title="Append a start-of-element marker.">ccnb_element_begin</a>(policy, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33aae7114a341a1231fff6e93724d25c6ed">CCN_DTAG_Policy</a>);
<a name="l01452"></a>01452     res |= <a class="code" href="ccn_8h.html#a10b8c6dc48e4640be33c90d983d3cb81" title="Append a tagged UDATA string, with printf-style formatting.">ccnb_tagged_putf</a>(policy, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a39d259c3a77167a3041fc51e0ff69f55">CCN_DTAG_PolicyVersion</a>, <span class="stringliteral">&quot;%s&quot;</span>, version);
<a name="l01453"></a>01453     res |= <a class="code" href="ccn_8h.html#a10b8c6dc48e4640be33c90d983d3cb81" title="Append a tagged UDATA string, with printf-style formatting.">ccnb_tagged_putf</a>(policy, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a9d7d538fe45251356a18e7693a811a7b">CCN_DTAG_LocalName</a>, <span class="stringliteral">&quot;%s&quot;</span>, local_name);
<a name="l01454"></a>01454     res |= <a class="code" href="ccn_8h.html#a10b8c6dc48e4640be33c90d983d3cb81" title="Append a tagged UDATA string, with printf-style formatting.">ccnb_tagged_putf</a>(policy, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33aa71d8031b44cd39f4ebdef09c1a9678b">CCN_DTAG_GlobalPrefix</a>, <span class="stringliteral">&quot;%s&quot;</span>, global_prefix);
<a name="l01455"></a>01455     res |= <a class="code" href="ccn_8h.html#aa46b72f2e6b3b7f7753ff3baaa4efdf8" title="Append an end-of-element marker.">ccnb_element_end</a>(policy);
<a name="l01456"></a>01456     <span class="keywordflow">return</span> (res);
<a name="l01457"></a>01457 }
<a name="l01458"></a>01458 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keywordtype">int</span>
<a name="l01459"></a><a class="code" href="ccnr__proto_8h.html#a988bd44b83e717395fcde7669553376e">01459</a> <a class="code" href="ccnr__proto_8c.html#a04232b8c4b837b754c62910e924d9aaa">r_proto_policy_append_namespace</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *ccnr,
<a name="l01460"></a>01460                                 <span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *policy,
<a name="l01461"></a>01461                                 <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">namespace</span>)
<a name="l01462"></a>01462 {
<a name="l01463"></a>01463     <span class="keywordtype">int</span> res;
<a name="l01464"></a>01464     <span class="keywordflow">if</span> (policy-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> &lt; 2)
<a name="l01465"></a>01465         <span class="keywordflow">return</span>(-1);
<a name="l01466"></a>01466     policy-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>--;   <span class="comment">/* remove the closer */</span>
<a name="l01467"></a>01467     res = <a class="code" href="ccn_8h.html#a10b8c6dc48e4640be33c90d983d3cb81" title="Append a tagged UDATA string, with printf-style formatting.">ccnb_tagged_putf</a>(policy, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a6c2e835c1d313c286bb3605eb305995b">CCN_DTAG_Namespace</a>, <span class="stringliteral">&quot;%s&quot;</span>, <span class="keyword">namespace</span>);
<a name="l01468"></a>01468     <a class="code" href="ccn_8h.html#aa46b72f2e6b3b7f7753ff3baaa4efdf8" title="Append an end-of-element marker.">ccnb_element_end</a>(policy);
<a name="l01469"></a>01469     <span class="keywordflow">return</span>(res);
<a name="l01470"></a>01470 }
<a name="l01471"></a>01471 <span class="comment"></span>
<a name="l01472"></a>01472 <span class="comment">/**</span>
<a name="l01473"></a>01473 <span class="comment"> * Parse a ccnb-encoded policy content object and fill in a ccn_parsed_policy</span>
<a name="l01474"></a>01474 <span class="comment"> * structure as the result.</span>
<a name="l01475"></a>01475 <span class="comment"> */</span>
<a name="l01476"></a>01476 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keywordtype">int</span>
<a name="l01477"></a><a class="code" href="ccnr__proto_8h.html#a84382d03b05753f4a306a67d3e85aec0">01477</a> <a class="code" href="ccnr__proto_8c.html#a1fd5a3888c075ae928fe02b60bba3a29" title="Parse a ccnb-encoded policy content object and fill in a ccn_parsed_policy structure...">r_proto_parse_policy</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *ccnr, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> length,
<a name="l01478"></a>01478                      <span class="keyword">struct</span> <a class="code" href="structccnr__parsed__policy.html">ccnr_parsed_policy</a> *pp)
<a name="l01479"></a>01479 {
<a name="l01480"></a>01480     <span class="keywordtype">int</span> res = 0;
<a name="l01481"></a>01481     <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> decoder;
<a name="l01482"></a>01482     <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> *d = <a class="code" href="ccn_8h.html#a4ba830f8dad511663779d85122db633a">ccn_buf_decoder_start</a>(&amp;decoder, buf,
<a name="l01483"></a>01483                                                       length);
<a name="l01484"></a>01484     <span class="keywordflow">if</span> (<a class="code" href="ccn_8h.html#a127d4f9a3f901ba15bc5335d5a9fa3b0">ccn_buf_match_dtag</a>(d, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33aae7114a341a1231fff6e93724d25c6ed">CCN_DTAG_Policy</a>)) {
<a name="l01485"></a>01485         <a class="code" href="ccn_8h.html#a1b17cadb92b2339cba24721b0466a0ce">ccn_buf_advance</a>(d);
<a name="l01486"></a>01486         pp-&gt;<a class="code" href="structccnr__parsed__policy.html#aac937ce4f39eb9898b4b305ec5262746">policy_version_offset</a> = <a class="code" href="ccn_8h.html#aea33945d85ab225836c568e3eee632e6" title="Parses a ccnb-encoded element expected to contain a UDATA string.">ccn_parse_tagged_string</a>(d, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a39d259c3a77167a3041fc51e0ff69f55">CCN_DTAG_PolicyVersion</a>, pp-&gt;<a class="code" href="structccnr__parsed__policy.html#a34b84b739cf9e12c772529935772000a">store</a>);
<a name="l01487"></a>01487         pp-&gt;<a class="code" href="structccnr__parsed__policy.html#afbe345ebdcd578fee3200c45e070d423">local_name_offset</a> = <a class="code" href="ccn_8h.html#aea33945d85ab225836c568e3eee632e6" title="Parses a ccnb-encoded element expected to contain a UDATA string.">ccn_parse_tagged_string</a>(d, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a9d7d538fe45251356a18e7693a811a7b">CCN_DTAG_LocalName</a>, pp-&gt;<a class="code" href="structccnr__parsed__policy.html#a34b84b739cf9e12c772529935772000a">store</a>);
<a name="l01488"></a>01488         pp-&gt;<a class="code" href="structccnr__parsed__policy.html#a35998dadb60a54db4336b4a39408a014">global_prefix_offset</a> = <a class="code" href="ccn_8h.html#aea33945d85ab225836c568e3eee632e6" title="Parses a ccnb-encoded element expected to contain a UDATA string.">ccn_parse_tagged_string</a>(d, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33aa71d8031b44cd39f4ebdef09c1a9678b">CCN_DTAG_GlobalPrefix</a>, pp-&gt;<a class="code" href="structccnr__parsed__policy.html#a34b84b739cf9e12c772529935772000a">store</a>);
<a name="l01489"></a>01489         pp-&gt;<a class="code" href="structccnr__parsed__policy.html#ac99ba64a37e3071da89dfea097f73d97">namespaces</a>-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a> = 0;
<a name="l01490"></a>01490         <span class="keywordflow">while</span> (<a class="code" href="ccn_8h.html#a127d4f9a3f901ba15bc5335d5a9fa3b0">ccn_buf_match_dtag</a>(d, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a6c2e835c1d313c286bb3605eb305995b">CCN_DTAG_Namespace</a>)) {
<a name="l01491"></a>01491             <a class="code" href="indexbuf_8h.html#a9a1c2df9c772ecb48d71a84b8e3a051b">ccn_indexbuf_append_element</a>(pp-&gt;<a class="code" href="structccnr__parsed__policy.html#ac99ba64a37e3071da89dfea097f73d97">namespaces</a>, <a class="code" href="ccn_8h.html#aea33945d85ab225836c568e3eee632e6" title="Parses a ccnb-encoded element expected to contain a UDATA string.">ccn_parse_tagged_string</a>(d, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a6c2e835c1d313c286bb3605eb305995b">CCN_DTAG_Namespace</a>, pp-&gt;<a class="code" href="structccnr__parsed__policy.html#a34b84b739cf9e12c772529935772000a">store</a>));
<a name="l01492"></a>01492         }
<a name="l01493"></a>01493         <a class="code" href="ccn_8h.html#a1868a32594c3c2a98e60049a3f3184b8" title="Enter an error state if element closer not found.">ccn_buf_check_close</a>(d);
<a name="l01494"></a>01494     } <span class="keywordflow">else</span> {
<a name="l01495"></a>01495         <span class="keywordflow">return</span>(-1);
<a name="l01496"></a>01496     }
<a name="l01497"></a>01497     <span class="keywordflow">return</span> (res);
<a name="l01498"></a>01498 }
<a name="l01499"></a>01499 <span class="comment"></span>
<a name="l01500"></a>01500 <span class="comment">/**</span>
<a name="l01501"></a>01501 <span class="comment"> * Initiate a key fetch if necessary.</span>
<a name="l01502"></a>01502 <span class="comment"> * @returns -1 if error or no name, 0 if fetch was issued, 1 if already stored.</span>
<a name="l01503"></a>01503 <span class="comment"> */</span>
<a name="l01504"></a>01504 <span class="keywordtype">int</span>
<a name="l01505"></a><a class="code" href="ccnr__proto_8h.html#a22346544e87a567a668c08a4f722fe21">01505</a> <a class="code" href="ccnr__proto_8c.html#a22346544e87a567a668c08a4f722fe21" title="Initiate a key fetch if necessary.">r_proto_initiate_key_fetch</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *ccnr,
<a name="l01506"></a>01506                            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *msg,
<a name="l01507"></a>01507                            <span class="keyword">struct</span> <a class="code" href="structccn__parsed___content_object.html">ccn_parsed_ContentObject</a> *pco,
<a name="l01508"></a>01508                            <span class="keywordtype">int</span> use_link,
<a name="l01509"></a>01509                            <a class="code" href="ccnr__private_8h.html#aa218fe1bf4c4e7deaa9f150cf7435593" title="A cookie is used as a more ephemeral way of holding a reference to a content object...">ccnr_cookie</a> a)
<a name="l01510"></a>01510 {
<a name="l01511"></a>01511     <span class="comment">/* </span>
<a name="l01512"></a>01512 <span class="comment">     * Create a new interest in the key name, set up a callback that will</span>
<a name="l01513"></a>01513 <span class="comment">     * insert the key into repo.</span>
<a name="l01514"></a>01514 <span class="comment">     */</span>
<a name="l01515"></a>01515     <span class="keywordtype">int</span> res;
<a name="l01516"></a>01516     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *key_name = NULL;
<a name="l01517"></a>01517     <span class="keyword">struct </span><a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *key_closure = NULL;
<a name="l01518"></a>01518     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *templ = NULL;
<a name="l01519"></a>01519     <span class="keyword">struct </span><a class="code" href="structccnr__expect__content.html">ccnr_expect_content</a> *expect_content = NULL;
<a name="l01520"></a>01520     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *namestart = NULL;
<a name="l01521"></a>01521     <span class="keywordtype">int</span> namelen = 0;
<a name="l01522"></a>01522     <span class="keywordtype">int</span> keynamelen;
<a name="l01523"></a>01523     <span class="keywordtype">int</span> i;
<a name="l01524"></a>01524     
<a name="l01525"></a>01525     keynamelen = (pco-&gt;<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387adf82b30b50dd50fbb429b525ec0ece79">CCN_PCO_E_KeyName_Name</a>] -
<a name="l01526"></a>01526                   pco-&gt;<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387ae19e9aa1067305641338667f13e7c827">CCN_PCO_B_KeyName_Name</a>]);
<a name="l01527"></a>01527     <span class="keywordflow">if</span> (use_link) {
<a name="l01528"></a>01528         <span class="comment">/* Try to follow a link instead of using keyname */</span>
<a name="l01529"></a>01529         <span class="keywordflow">if</span> (pco-&gt;<a class="code" href="structccn__parsed___content_object.html#a95f6fd64d36fcc6fee3d2770c9cc2ac7">type</a> == <a class="code" href="ccn_8h.html#a5ac452b850189ae724c4ff89ae81c702a0055466cba309d1764f3e428dd1fc059">CCN_CONTENT_LINK</a>) {
<a name="l01530"></a>01530             <span class="comment">/* For now we only pay attention to the Name in the Link. */</span>
<a name="l01531"></a>01531             <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data = NULL;
<a name="l01532"></a>01532             <span class="keywordtype">size_t</span> data_size = 0;
<a name="l01533"></a>01533             <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> decoder;
<a name="l01534"></a>01534             <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> *d;
<a name="l01535"></a>01535             res = <a class="code" href="ccn_8h.html#ac3a7a8cad96caf34fc73240b20f07cd2">ccn_content_get_value</a>(msg, pco-&gt;<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387a1d25adf694c64b4ae597b26abe6b30fc">CCN_PCO_E</a>], pco,
<a name="l01536"></a>01536                                         &amp;data, &amp;data_size);
<a name="l01537"></a>01537             <span class="keywordflow">if</span> (res &lt; 0)
<a name="l01538"></a>01538                 <span class="keywordflow">return</span>(-1);
<a name="l01539"></a>01539             d = <a class="code" href="ccn_8h.html#a4ba830f8dad511663779d85122db633a">ccn_buf_decoder_start</a>(&amp;decoder, data, data_size);
<a name="l01540"></a>01540             <span class="keywordflow">if</span> (<a class="code" href="ccn_8h.html#a127d4f9a3f901ba15bc5335d5a9fa3b0">ccn_buf_match_dtag</a>(d, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33ad6154d93cb98378617c667731ecf5c32">CCN_DTAG_Link</a>)) {
<a name="l01541"></a>01541                 <span class="keywordtype">int</span> start = 0;
<a name="l01542"></a>01542                 <span class="keywordtype">int</span> end = 0;
<a name="l01543"></a>01543                 <a class="code" href="ccn_8h.html#a1b17cadb92b2339cba24721b0466a0ce">ccn_buf_advance</a>(d);
<a name="l01544"></a>01544                 start = d-&gt;<a class="code" href="structccn__buf__decoder.html#ad0c36c4f48a2a7995653059161ca4ba9">decoder</a>.<a class="code" href="structccn__skeleton__decoder.html#a1a01207fc832f394a15137371255f197" title="Starting index of most-recent token.">token_index</a>;
<a name="l01545"></a>01545                 <a class="code" href="ccn_8h.html#a0991323fcfa9202fd34db25fd4f65485" title="Parses a ccnb-encoded name.">ccn_parse_Name</a>(d, NULL);
<a name="l01546"></a>01546                 end = d-&gt;<a class="code" href="structccn__buf__decoder.html#ad0c36c4f48a2a7995653059161ca4ba9">decoder</a>.<a class="code" href="structccn__skeleton__decoder.html#a1a01207fc832f394a15137371255f197" title="Starting index of most-recent token.">token_index</a>;
<a name="l01547"></a>01547                 <a class="code" href="ccn_8h.html#a1868a32594c3c2a98e60049a3f3184b8" title="Enter an error state if element closer not found.">ccn_buf_check_close</a>(d);
<a name="l01548"></a>01548                 <span class="keywordflow">if</span> (d-&gt;<a class="code" href="structccn__buf__decoder.html#ad0c36c4f48a2a7995653059161ca4ba9">decoder</a>.<a class="code" href="structccn__skeleton__decoder.html#a59243d42e65373a2946e57137e244389" title="Decoder state.">state</a> &lt; 0)
<a name="l01549"></a>01549                     <span class="keywordflow">return</span>(-1);
<a name="l01550"></a>01550                 namestart = data + start;
<a name="l01551"></a>01551                 namelen = end - start;
<a name="l01552"></a>01552                 <span class="keywordflow">if</span> (namelen == keynamelen &amp;&amp;
<a name="l01553"></a>01553                     0 == memcmp(namestart, msg + pco-&gt;<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387ae19e9aa1067305641338667f13e7c827">CCN_PCO_B_KeyName_Name</a>], namelen)) {
<a name="l01554"></a>01554                     <span class="comment">/*</span>
<a name="l01555"></a>01555 <span class="comment">                     * The link matches the key locator. There is no point</span>
<a name="l01556"></a>01556 <span class="comment">                     * in checking two times for the same thing.</span>
<a name="l01557"></a>01557 <span class="comment">                     */</span>
<a name="l01558"></a>01558                     <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, sdfdf, <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>))
<a name="l01559"></a>01559                         <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;keyfetch_link_opt&quot;</span>,
<a name="l01560"></a>01560                                         NULL, namestart, namelen);
<a name="l01561"></a>01561                     <span class="keywordflow">return</span>(-1);
<a name="l01562"></a>01562                 }
<a name="l01563"></a>01563             }
<a name="l01564"></a>01564         }
<a name="l01565"></a>01565     }
<a name="l01566"></a>01566     <span class="keywordflow">else</span> {
<a name="l01567"></a>01567         <span class="comment">/* Use the KeyName if present */</span>
<a name="l01568"></a>01568         namestart = msg + pco-&gt;<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387ae19e9aa1067305641338667f13e7c827">CCN_PCO_B_KeyName_Name</a>];
<a name="l01569"></a>01569         namelen = (pco-&gt;<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387adf82b30b50dd50fbb429b525ec0ece79">CCN_PCO_E_KeyName_Name</a>] -
<a name="l01570"></a>01570                    pco-&gt;<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387ae19e9aa1067305641338667f13e7c827">CCN_PCO_B_KeyName_Name</a>]);
<a name="l01571"></a>01571     }
<a name="l01572"></a>01572     <span class="comment">/*</span>
<a name="l01573"></a>01573 <span class="comment">     * If there is no KeyName or link, provided, we can&#39;t ask, so do not bother.</span>
<a name="l01574"></a>01574 <span class="comment">     */</span>
<a name="l01575"></a>01575     <span class="keywordflow">if</span> (namelen == 0 || a == 0)
<a name="l01576"></a>01576         <span class="keywordflow">return</span>(-1);
<a name="l01577"></a>01577     key_name = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01578"></a>01578     <a class="code" href="charbuf_8h.html#a5cc5c1412e38c015951394fcd79e2f6e">ccn_charbuf_append</a>(key_name, namestart, namelen);
<a name="l01579"></a>01579     <span class="comment">/* Construct an interest complete with Name so we can do lookup */</span>
<a name="l01580"></a>01580     templ = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01581"></a>01581     <a class="code" href="ccn_8h.html#a2fded0bbb7253c024924baa53beda660" title="Append a ccnb start marker.">ccn_charbuf_append_tt</a>(templ, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33ac3c02bb032cd835a5f9e439cadd0a455">CCN_DTAG_Interest</a>, <a class="code" href="coding_8h.html#a750e116f861c8e3f015cde245bbc0570aea37aecfff1efe438c628cfa8f18c449" title="starts composite - numval is tagdict index (enum ccn_dtag)">CCN_DTAG</a>);
<a name="l01582"></a>01582     <a class="code" href="charbuf_8h.html#a5cc5c1412e38c015951394fcd79e2f6e">ccn_charbuf_append</a>(templ, key_name-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, key_name-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01583"></a>01583     <a class="code" href="ccn_8h.html#a10b8c6dc48e4640be33c90d983d3cb81" title="Append a tagged UDATA string, with printf-style formatting.">ccnb_tagged_putf</a>(templ, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a9f6129895fd850c53ef3727b4660a3ff">CCN_DTAG_MinSuffixComponents</a>, <span class="stringliteral">&quot;%d&quot;</span>, 1);
<a name="l01584"></a>01584     <a class="code" href="ccn_8h.html#a10b8c6dc48e4640be33c90d983d3cb81" title="Append a tagged UDATA string, with printf-style formatting.">ccnb_tagged_putf</a>(templ, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a7aad87e03f0facd444ae112ec6beaf84">CCN_DTAG_MaxSuffixComponents</a>, <span class="stringliteral">&quot;%d&quot;</span>, 3);
<a name="l01585"></a>01585     <span class="keywordflow">if</span> (pco-&gt;<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387a5d93359cb710dcf121388a99108af2e8">CCN_PCO_B_KeyName_Pub</a>] &lt; pco-&gt;<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387ae8875d2a96fe53b0dcb8ed00d5eee812">CCN_PCO_E_KeyName_Pub</a>]) {
<a name="l01586"></a>01586         <a class="code" href="charbuf_8h.html#a5cc5c1412e38c015951394fcd79e2f6e">ccn_charbuf_append</a>(templ,
<a name="l01587"></a>01587                            msg + pco-&gt;<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387a5d93359cb710dcf121388a99108af2e8">CCN_PCO_B_KeyName_Pub</a>],
<a name="l01588"></a>01588                            (pco-&gt;<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387ae8875d2a96fe53b0dcb8ed00d5eee812">CCN_PCO_E_KeyName_Pub</a>] - 
<a name="l01589"></a>01589                             pco-&gt;<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387a5d93359cb710dcf121388a99108af2e8">CCN_PCO_B_KeyName_Pub</a>]));
<a name="l01590"></a>01590     }
<a name="l01591"></a>01591     <a class="code" href="ccn_8h.html#ac8fba19d429bb106de10a008142882aa" title="Append a CCN_CLOSE.">ccn_charbuf_append_closer</a>(templ); <span class="comment">/* &lt;/Interest&gt; */</span>
<a name="l01592"></a>01592     <span class="comment">/* See if we already have it - if so we declare we are done. */</span>
<a name="l01593"></a>01593     <span class="keywordflow">if</span> (<a class="code" href="ccnr__sync_8c.html#ab592ff9892a132a89b8c3b83e7a280d5" title="Look up a content object that is stored locally in the repository based on the supplied...">r_lookup</a>(ccnr, templ, NULL) == 0) {
<a name="l01594"></a>01594         res = 1;
<a name="l01595"></a>01595         <span class="comment">// Note - it might be that the thing we found is not really the thing</span>
<a name="l01596"></a>01596         <span class="comment">// we were after.  For now we don&#39;t check.</span>
<a name="l01597"></a>01597     }
<a name="l01598"></a>01598     <span class="keywordflow">else</span> {
<a name="l01599"></a>01599         <span class="comment">/* We do not have it; need to ask */</span>
<a name="l01600"></a>01600         res = -1;
<a name="l01601"></a>01601         expect_content = calloc(1, <span class="keyword">sizeof</span>(*expect_content));
<a name="l01602"></a>01602         <span class="keywordflow">if</span> (expect_content == NULL)
<a name="l01603"></a>01603             <span class="keywordflow">goto</span> Bail;
<a name="l01604"></a>01604         expect_content-&gt;<a class="code" href="structccnr__expect__content.html#a0927ea54848de19b025c85db8da4c9a0">ccnr</a> = ccnr;
<a name="l01605"></a>01605         expect_content-&gt;<a class="code" href="structccnr__expect__content.html#a913c369889b2639768a862a4cca6b27c">final</a> = -1;
<a name="l01606"></a>01606         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="ccnr__proto_8h.html#a2a08063e993e3cb158ffe7647f6ebc2e">CCNR_PIPELINE</a>; i++)
<a name="l01607"></a>01607             expect_content-&gt;<a class="code" href="structccnr__expect__content.html#a4329ad176aba312a03834c5f7f060c0a">outstanding</a>[i] = -1;
<a name="l01608"></a>01608         <span class="comment">/* inform r_proto_expect_content we are looking for a key. */</span>
<a name="l01609"></a>01609         expect_content-&gt;<a class="code" href="structccnr__expect__content.html#acbedb43501cfd7904e3af9cdc64d79b0">keyfetch</a> = a;
<a name="l01610"></a>01610         key_closure = calloc(1, <span class="keyword">sizeof</span>(*key_closure));
<a name="l01611"></a>01611         <span class="keywordflow">if</span> (key_closure == NULL)
<a name="l01612"></a>01612             <span class="keywordflow">goto</span> Bail;
<a name="l01613"></a>01613         key_closure-&gt;<a class="code" href="structccn__closure.html#a48dca74271023e0caf287ad31dd1e66c" title="client-supplied handler">p</a> = &amp;<a class="code" href="ccnr__proto_8c.html#a7022342c3a0054757ce160533385ee77">r_proto_expect_content</a>;
<a name="l01614"></a>01614         key_closure-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a> = expect_content;
<a name="l01615"></a>01615         res = <a class="code" href="ccn_8h.html#a9f2d6eede46c8aac3dbb4b6e22e1d492">ccn_express_interest</a>(ccnr-&gt;<a class="code" href="structccnr__handle.html#aa358b4c6941900d7e02a620bf1e601b5" title="this talks directly with ccnd">direct_client</a>, key_name, key_closure, templ);
<a name="l01616"></a>01616         <span class="keywordflow">if</span> (res &gt;= 0) {
<a name="l01617"></a>01617             <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(ccnr, sdfdf, <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>))
<a name="l01618"></a>01618                 <a class="code" href="ccnr__msg_8c.html#a8b7babb696471c87efc0adfafd868e28" title="Produce a ccnr debug trace entry.">ccnr_debug_ccnb</a>(ccnr, __LINE__, <span class="stringliteral">&quot;keyfetch_start&quot;</span>,
<a name="l01619"></a>01619                                 NULL, templ-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, templ-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01620"></a>01620             key_closure = NULL;
<a name="l01621"></a>01621             expect_content = NULL;
<a name="l01622"></a>01622             res = 0;
<a name="l01623"></a>01623         }
<a name="l01624"></a>01624     }
<a name="l01625"></a>01625 Bail:
<a name="l01626"></a>01626     <span class="keywordflow">if</span> (key_closure != NULL)
<a name="l01627"></a>01627         free(key_closure);
<a name="l01628"></a>01628     <span class="keywordflow">if</span> (expect_content != NULL)
<a name="l01629"></a>01629         free(expect_content);
<a name="l01630"></a>01630     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;key_name);
<a name="l01631"></a>01631     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;templ);
<a name="l01632"></a>01632     <span class="keywordflow">return</span>(res);
<a name="l01633"></a>01633 }
<a name="l01634"></a>01634 
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Mon Feb 4 11:56:45 2013 for Content-Centric Networking in C by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
