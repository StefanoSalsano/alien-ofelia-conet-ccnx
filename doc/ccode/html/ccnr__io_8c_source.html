<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Content-Centric Networking in C: ccnr/ccnr_io.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_fcd5115610c592af72997d6bb8517d72.html">ccnr</a>
  </div>
</div>
<div class="contents">
<h1>ccnr_io.c</h1><a href="ccnr__io_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/**</span>
<a name="l00002"></a>00002 <span class="comment"> * @file ccnr_io.c</span>
<a name="l00003"></a>00003 <span class="comment"> * </span>
<a name="l00004"></a>00004 <span class="comment"> * Part of ccnr -  CCNx Repository Daemon.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> */</span>
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <span class="comment">/*</span>
<a name="l00009"></a>00009 <span class="comment"> * Copyright (C) 2011 Palo Alto Research Center, Inc.</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * This work is free software; you can redistribute it and/or modify it under</span>
<a name="l00012"></a>00012 <span class="comment"> * the terms of the GNU General Public License version 2 as published by the</span>
<a name="l00013"></a>00013 <span class="comment"> * Free Software Foundation.</span>
<a name="l00014"></a>00014 <span class="comment"> * This work is distributed in the hope that it will be useful, but WITHOUT ANY</span>
<a name="l00015"></a>00015 <span class="comment"> * WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<a name="l00016"></a>00016 <span class="comment"> * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License</span>
<a name="l00017"></a>00017 <span class="comment"> * for more details. You should have received a copy of the GNU General Public</span>
<a name="l00018"></a>00018 <span class="comment"> * License along with this program; if not, write to the</span>
<a name="l00019"></a>00019 <span class="comment"> * Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,</span>
<a name="l00020"></a>00020 <span class="comment"> * Boston, MA 02110-1301, USA.</span>
<a name="l00021"></a>00021 <span class="comment"> */</span>
<a name="l00022"></a>00022  
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;limits.h&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;netdb.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;poll.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;stddef.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;stdint.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;sys/un.h&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;<a class="code" href="bloom_8h.html" title="Bloom filters.">ccn/bloom.h</a>&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;<a class="code" href="ccn_8h.html" title="This is the low-level interface for CCNx clients.">ccn/ccn.h</a>&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;<a class="code" href="ccn__private_8h.html" title="Additional operations that are irrevalent for most clients.">ccn/ccn_private.h</a>&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;<a class="code" href="charbuf_8h.html" title="Expandable character buffer for counted sequences of arbitrary octets.">ccn/charbuf.h</a>&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;<a class="code" href="face__mgmt_8h.html" title="Part of the CCNx C Library.">ccn/face_mgmt.h</a>&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;<a class="code" href="hashtb_8h.html" title="Hash table.">ccn/hashtb.h</a>&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;<a class="code" href="indexbuf_8h.html" title="Expandable buffer of non-negative values.">ccn/indexbuf.h</a>&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;<a class="code" href="schedule_8h.html" title="Event scheduling.">ccn/schedule.h</a>&gt;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;<a class="code" href="reg__mgmt_8h.html" title="Part of the CCNx C Library.">ccn/reg_mgmt.h</a>&gt;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;<a class="code" href="uri_8h.html" title="ccn-scheme uri conversions.">ccn/uri.h</a>&gt;</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="ccnr__private_8h.html" title="Private definitions for ccnr - the CCNx daemon.">ccnr_private.h</a>&quot;</span>
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="ccnr__io_8h.html" title="Part of ccnr - CCNx Repository Daemon.">ccnr_io.h</a>&quot;</span>
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="ccnr__forwarding_8h.html" title="Part of ccnr - CCNx Repository Daemon.">ccnr_forwarding.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="ccnr__internal__client_8h.html" title="Part of ccnr - CCNx Repository Daemon.">ccnr_internal_client.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="ccnr__link_8h.html" title="Part of ccnr - CCNx Repository Daemon.">ccnr_link.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="ccnr__msg_8h.html" title="Part of ccnr - CCNx Repository Daemon.">ccnr_msg.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="ccnr__sendq_8h.html" title="Part of ccnr - CCNx Repository Daemon.">ccnr_sendq.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="ccnr__stats_8h.html" title="Part of ccnr - CCNx Repository Daemon.">ccnr_stats.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="comment"></span>
<a name="l00066"></a>00066 <span class="comment">/**</span>
<a name="l00067"></a>00067 <span class="comment"> * Looks up a fdholder based on its filedesc (private).</span>
<a name="l00068"></a>00068 <span class="comment"> */</span>
<a name="l00069"></a>00069 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keyword">struct </span><a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a> *
<a name="l00070"></a><a class="code" href="ccnr__io_8h.html#ad41059307ce45251ec8787223a2db683">00070</a> <a class="code" href="ccnr__io_8c.html#ad9ca4dc679b9aa962638ae2c0ad9c68f" title="Looks up a fdholder based on its filedesc (private).">r_io_fdholder_from_fd</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *h, <span class="keywordtype">unsigned</span> <a class="code" href="structfdholder.html#ac908cd30e57c88fb92e778c88c61c5a5" title="file descriptor">filedesc</a>)
<a name="l00071"></a>00071 {
<a name="l00072"></a>00072     <span class="keywordtype">unsigned</span> slot = filedesc;
<a name="l00073"></a>00073     <span class="keyword">struct </span><a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a> *<a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a> = NULL;
<a name="l00074"></a>00074     <span class="keywordflow">if</span> (slot &lt; h-&gt;face_limit) {
<a name="l00075"></a>00075         fdholder = h-&gt;<a class="code" href="structccnr__handle.html#a5270519ee2d84ae571ce01688c20f8d6" title="array with face_limit elements">fdholder_by_fd</a>[slot];
<a name="l00076"></a>00076         <span class="keywordflow">if</span> (fdholder != NULL &amp;&amp; fdholder-&gt;<a class="code" href="structfdholder.html#ac908cd30e57c88fb92e778c88c61c5a5" title="file descriptor">filedesc</a> != filedesc)
<a name="l00077"></a>00077             fdholder = NULL;
<a name="l00078"></a>00078     }
<a name="l00079"></a>00079     <span class="keywordflow">return</span>(fdholder);
<a name="l00080"></a>00080 }
<a name="l00081"></a>00081 <span class="comment"></span>
<a name="l00082"></a>00082 <span class="comment">/**</span>
<a name="l00083"></a>00083 <span class="comment"> * Looks up a fdholder based on its filedesc.</span>
<a name="l00084"></a>00084 <span class="comment"> */</span>
<a name="l00085"></a>00085 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keyword">struct </span><a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a> *
<a name="l00086"></a><a class="code" href="ccnr__io_8h.html#aa84358124bdc6370ccd4f408bb571222">00086</a> <a class="code" href="ccnr__io_8c.html#aa8dae854e493d0ee495e4002f2bd097c" title="Looks up a fdholder based on its filedesc.">ccnr_r_io_fdholder_from_fd</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *h, <span class="keywordtype">unsigned</span> <a class="code" href="structfdholder.html#ac908cd30e57c88fb92e778c88c61c5a5" title="file descriptor">filedesc</a>)
<a name="l00087"></a>00087 {
<a name="l00088"></a>00088     <span class="keywordflow">return</span>(<a class="code" href="ccnr__io_8c.html#ad9ca4dc679b9aa962638ae2c0ad9c68f" title="Looks up a fdholder based on its filedesc (private).">r_io_fdholder_from_fd</a>(h, filedesc));
<a name="l00089"></a>00089 }
<a name="l00090"></a>00090 <span class="comment"></span>
<a name="l00091"></a>00091 <span class="comment">/**</span>
<a name="l00092"></a>00092 <span class="comment"> * Assigns the filedesc for a nacent fdholder,</span>
<a name="l00093"></a>00093 <span class="comment"> * calls r_io_register_new_face() if successful.</span>
<a name="l00094"></a>00094 <span class="comment"> */</span>
<a name="l00095"></a>00095 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keywordtype">int</span>
<a name="l00096"></a><a class="code" href="ccnr__io_8h.html#a98c76ef86e09f0e4b4bad1bfeea08a68">00096</a> <a class="code" href="ccnr__io_8c.html#a775a36317c78f580a4d8a56df2202d0c" title="Assigns the filedesc for a nacent fdholder, calls r_io_register_new_face() if successful...">r_io_enroll_face</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *h, <span class="keyword">struct</span> <a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a> *<a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a>)
<a name="l00097"></a>00097 {
<a name="l00098"></a>00098     <span class="keywordtype">unsigned</span> i = fdholder-&gt;<a class="code" href="structfdholder.html#ac908cd30e57c88fb92e778c88c61c5a5" title="file descriptor">filedesc</a>;
<a name="l00099"></a>00099     <span class="keywordtype">unsigned</span> n = h-&gt;<a class="code" href="structccnr__handle.html#a60ce3909d3d49be5a067e49fd8a15ea9" title="current number of fdholder slots">face_limit</a>;
<a name="l00100"></a>00100     <span class="keyword">struct </span>fdholder **a = h-&gt;<a class="code" href="structccnr__handle.html#a5270519ee2d84ae571ce01688c20f8d6" title="array with face_limit elements">fdholder_by_fd</a>;
<a name="l00101"></a>00101     <span class="keywordflow">if</span> (i &lt; n &amp;&amp; a[i] == NULL) {
<a name="l00102"></a>00102         <span class="keywordflow">if</span> (a[i] == NULL)
<a name="l00103"></a>00103             <span class="keywordflow">goto</span> use_i;
<a name="l00104"></a>00104         abort();
<a name="l00105"></a>00105     }
<a name="l00106"></a>00106     <span class="keywordflow">if</span> (i &gt; 65535)
<a name="l00107"></a>00107         abort();
<a name="l00108"></a>00108     a = realloc(a, (i + 1) * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> fdholder *));
<a name="l00109"></a>00109     <span class="keywordflow">if</span> (a == NULL)
<a name="l00110"></a>00110         <span class="keywordflow">return</span>(-1); <span class="comment">/* ENOMEM */</span>
<a name="l00111"></a>00111     h-&gt;<a class="code" href="structccnr__handle.html#a60ce3909d3d49be5a067e49fd8a15ea9" title="current number of fdholder slots">face_limit</a> = i + 1;
<a name="l00112"></a>00112     <span class="keywordflow">while</span> (n &lt; h-&gt;face_limit)
<a name="l00113"></a>00113         a[n++] = NULL;
<a name="l00114"></a>00114     h-&gt;<a class="code" href="structccnr__handle.html#a5270519ee2d84ae571ce01688c20f8d6" title="array with face_limit elements">fdholder_by_fd</a> = a;
<a name="l00115"></a>00115 use_i:
<a name="l00116"></a>00116     a[i] = fdholder;
<a name="l00117"></a>00117     <span class="keywordflow">if</span> (i == 0)
<a name="l00118"></a>00118         h-&gt;<a class="code" href="structccnr__handle.html#a60b1ff48ff8a50320097c88d9696087d" title="special fdholder for internal client">face0</a> = fdholder; <span class="comment">/* This one is special */</span>
<a name="l00119"></a>00119     fdholder-&gt;<a class="code" href="structfdholder.html#ac908cd30e57c88fb92e778c88c61c5a5" title="file descriptor">filedesc</a> = i;
<a name="l00120"></a>00120     fdholder-&gt;<a class="code" href="structfdholder.html#a9a6c1be5c2788e12b4106f679dc7d980">meter</a>[<a class="code" href="ccnd__private_8h.html#a64d4281f797a99f7317a023249ff07e6a0deb02bc3d87c103d45bb4c854a02fb0">FM_BYTI</a>] = <a class="code" href="ccnr__stats_8c.html#ad9e6edb9a33dd370f2bd13b9ba4b09c4" title="create and initialize separately allocated meter.">ccnr_meter_create</a>(h, <span class="stringliteral">&quot;bytein&quot;</span>);
<a name="l00121"></a>00121     fdholder-&gt;<a class="code" href="structfdholder.html#a9a6c1be5c2788e12b4106f679dc7d980">meter</a>[<a class="code" href="ccnd__private_8h.html#a64d4281f797a99f7317a023249ff07e6a68df0f6c6a44af2cf5c43a81ccb8ee49">FM_BYTO</a>] = <a class="code" href="ccnr__stats_8c.html#ad9e6edb9a33dd370f2bd13b9ba4b09c4" title="create and initialize separately allocated meter.">ccnr_meter_create</a>(h, <span class="stringliteral">&quot;byteout&quot;</span>);
<a name="l00122"></a>00122     fdholder-&gt;<a class="code" href="structfdholder.html#a9a6c1be5c2788e12b4106f679dc7d980">meter</a>[<a class="code" href="ccnd__private_8h.html#a64d4281f797a99f7317a023249ff07e6a35265b23808719ce3d1c75f71be21825">FM_INTI</a>] = <a class="code" href="ccnr__stats_8c.html#ad9e6edb9a33dd370f2bd13b9ba4b09c4" title="create and initialize separately allocated meter.">ccnr_meter_create</a>(h, <span class="stringliteral">&quot;intrin&quot;</span>);
<a name="l00123"></a>00123     fdholder-&gt;<a class="code" href="structfdholder.html#a9a6c1be5c2788e12b4106f679dc7d980">meter</a>[<a class="code" href="ccnd__private_8h.html#a64d4281f797a99f7317a023249ff07e6abf18d5b8e4f59f2d406be0caae4a2761">FM_INTO</a>] = <a class="code" href="ccnr__stats_8c.html#ad9e6edb9a33dd370f2bd13b9ba4b09c4" title="create and initialize separately allocated meter.">ccnr_meter_create</a>(h, <span class="stringliteral">&quot;introut&quot;</span>);
<a name="l00124"></a>00124     fdholder-&gt;<a class="code" href="structfdholder.html#a9a6c1be5c2788e12b4106f679dc7d980">meter</a>[<a class="code" href="ccnd__private_8h.html#a64d4281f797a99f7317a023249ff07e6aab609c384e2f89ded0e86f308da36616">FM_DATI</a>] = <a class="code" href="ccnr__stats_8c.html#ad9e6edb9a33dd370f2bd13b9ba4b09c4" title="create and initialize separately allocated meter.">ccnr_meter_create</a>(h, <span class="stringliteral">&quot;datain&quot;</span>);
<a name="l00125"></a>00125     fdholder-&gt;<a class="code" href="structfdholder.html#a9a6c1be5c2788e12b4106f679dc7d980">meter</a>[<a class="code" href="ccnd__private_8h.html#a64d4281f797a99f7317a023249ff07e6aa5447fdfd2cd7b97b1228a556f33ffa2">FM_DATO</a>] = <a class="code" href="ccnr__stats_8c.html#ad9e6edb9a33dd370f2bd13b9ba4b09c4" title="create and initialize separately allocated meter.">ccnr_meter_create</a>(h, <span class="stringliteral">&quot;dataout&quot;</span>);
<a name="l00126"></a>00126     <a class="code" href="ccnr__io_8c.html#a6809cc3f71d4cf47a651dbfe88c5b675" title="Called when a fdholder is first created, and (perhaps) a second time in the case...">r_io_register_new_face</a>(h, fdholder);
<a name="l00127"></a>00127     <span class="keywordflow">return</span> (fdholder-&gt;<a class="code" href="structfdholder.html#ac908cd30e57c88fb92e778c88c61c5a5" title="file descriptor">filedesc</a>);
<a name="l00128"></a>00128 }
<a name="l00129"></a>00129 <span class="comment"></span>
<a name="l00130"></a>00130 <span class="comment">/**</span>
<a name="l00131"></a>00131 <span class="comment"> * Close an open file descriptor quietly.</span>
<a name="l00132"></a>00132 <span class="comment"> */</span>
<a name="l00133"></a>00133 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00134"></a><a class="code" href="ccnr__io_8c.html#a994e5d8e4c6fbcf92af52094ebb38032">00134</a> <a class="code" href="ccnr__io_8c.html#a994e5d8e4c6fbcf92af52094ebb38032" title="Close an open file descriptor quietly.">close_fd</a>(<span class="keywordtype">int</span> *pfd)
<a name="l00135"></a>00135 {
<a name="l00136"></a>00136     <span class="keywordflow">if</span> (*pfd != -1) {
<a name="l00137"></a>00137         close(*pfd);
<a name="l00138"></a>00138         *pfd = -1;
<a name="l00139"></a>00139     }
<a name="l00140"></a>00140 }
<a name="l00141"></a>00141 <span class="comment"></span>
<a name="l00142"></a>00142 <span class="comment">/**</span>
<a name="l00143"></a>00143 <span class="comment"> * Close an open file descriptor, and grumble about it.</span>
<a name="l00144"></a>00144 <span class="comment"> */</span>
<a name="l00145"></a>00145 <span class="comment">/* unused */</span> <span class="keywordtype">void</span>
<a name="l00146"></a><a class="code" href="ccnr__io_8c.html#aa453e7d9f766c387f720113d2d5c621c">00146</a> <a class="code" href="ccnr__io_8c.html#aa453e7d9f766c387f720113d2d5c621c" title="Close an open file descriptor, and grumble about it.">ccnr_close_fd</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *h, <span class="keywordtype">unsigned</span> <a class="code" href="structfdholder.html#ac908cd30e57c88fb92e778c88c61c5a5" title="file descriptor">filedesc</a>, <span class="keywordtype">int</span> *pfd)
<a name="l00147"></a>00147 {
<a name="l00148"></a>00148     <span class="keywordtype">int</span> res;
<a name="l00149"></a>00149     
<a name="l00150"></a>00150     <span class="keywordflow">if</span> (*pfd != -1) {
<a name="l00151"></a>00151         <span class="keywordtype">int</span> linger = 0;
<a name="l00152"></a>00152         setsockopt(*pfd, SOL_SOCKET, SO_LINGER,
<a name="l00153"></a>00153                    &amp;linger, <span class="keyword">sizeof</span>(linger));
<a name="l00154"></a>00154         res = close(*pfd);
<a name="l00155"></a>00155         <span class="keywordflow">if</span> (res == -1)
<a name="l00156"></a>00156             <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(h, <span class="stringliteral">&quot;close failed for fdholder %u fd=%d: %s (errno=%d)&quot;</span>,
<a name="l00157"></a>00157                      filedesc, *pfd, strerror(errno), errno);
<a name="l00158"></a>00158         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(h, io, <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>))
<a name="l00159"></a>00159             <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(h, <span class="stringliteral">&quot;closing fd %d while finalizing fdholder %u&quot;</span>, *pfd, filedesc);
<a name="l00160"></a>00160         *pfd = -1;
<a name="l00161"></a>00161     }
<a name="l00162"></a>00162 }
<a name="l00163"></a>00163 
<a name="l00164"></a>00164 <span class="comment"></span>
<a name="l00165"></a>00165 <span class="comment">/**</span>
<a name="l00166"></a>00166 <span class="comment"> * Initialize the fdholder flags based upon the addr information</span>
<a name="l00167"></a>00167 <span class="comment"> * and the provided explicit setflags.</span>
<a name="l00168"></a>00168 <span class="comment"> */</span>
<a name="l00169"></a>00169 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00170"></a><a class="code" href="ccnr__io_8c.html#a711ff95cf32579b274d58e005550486d">00170</a> <a class="code" href="ccnr__io_8c.html#a711ff95cf32579b274d58e005550486d" title="Initialize the fdholder flags based upon the addr information and the provided explicit...">init_face_flags</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *h, <span class="keyword">struct</span> <a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a> *<a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a>, <span class="keywordtype">int</span> setflags)
<a name="l00171"></a>00171 {
<a name="l00172"></a>00172     <span class="keyword">const</span> <span class="keyword">struct </span>sockaddr *addr;
<a name="l00173"></a>00173     
<a name="l00174"></a>00174     <span class="keywordflow">if</span> ((setflags &amp; (<a class="code" href="ccnr__private_8h.html#af7dbc9e8fede4d97d924282930fab471">CCNR_FACE_REPODATA</a>)) != 0) {
<a name="l00175"></a>00175         fdholder-&gt;<a class="code" href="structfdholder.html#a4333d63eec8e74bebfa6a208ac4a04e1" title="CCNR_FACE_* fdholder flags.">flags</a> |= setflags;
<a name="l00176"></a>00176         <span class="keywordflow">return</span>;
<a name="l00177"></a>00177     }
<a name="l00178"></a>00178     addr = (<span class="keywordtype">void</span> *)fdholder-&gt;<a class="code" href="structfdholder.html#a999d438f8d6746d3d73c728895ea9602">name</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>;
<a name="l00179"></a>00179     if (addr-&gt;sa_family == AF_INET6) {
<a name="l00180"></a>00180         <span class="keyword">const</span> <span class="keyword">struct </span>sockaddr_in6 *addr6 = (<span class="keyword">struct </span>sockaddr_in6 *)addr;
<a name="l00181"></a>00181         fdholder-&gt;<a class="code" href="structfdholder.html#a4333d63eec8e74bebfa6a208ac4a04e1" title="CCNR_FACE_* fdholder flags.">flags</a> |= <a class="code" href="ccnr__private_8h.html#a2f01e75e466bf5bbd28745753268330b" title="IPv6.">CCNR_FACE_INET6</a>;
<a name="l00182"></a>00182 <span class="preprocessor">#ifdef IN6_IS_ADDR_LOOPBACK</span>
<a name="l00183"></a>00183 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (IN6_IS_ADDR_LOOPBACK(&amp;addr6-&gt;sin6_addr))
<a name="l00184"></a>00184             fdholder-&gt;<a class="code" href="structfdholder.html#a4333d63eec8e74bebfa6a208ac4a04e1" title="CCNR_FACE_* fdholder flags.">flags</a> |= <a class="code" href="ccnr__private_8h.html#a08ab78ff1353c7769cbd48de610b0f00" title="v4 or v6 loopback address">CCNR_FACE_LOOPBACK</a>;
<a name="l00185"></a>00185 #endif
<a name="l00186"></a>00186     }
<a name="l00187"></a>00187     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (addr-&gt;sa_family == AF_INET) {
<a name="l00188"></a>00188         <span class="keyword">const</span> <span class="keyword">struct </span>sockaddr_in *addr4 = (<span class="keyword">struct </span>sockaddr_in *)addr;
<a name="l00189"></a>00189         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *rawaddr;
<a name="l00190"></a>00190         rawaddr = (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;addr4-&gt;sin_addr.s_addr;
<a name="l00191"></a>00191         fdholder-&gt;<a class="code" href="structfdholder.html#a4333d63eec8e74bebfa6a208ac4a04e1" title="CCNR_FACE_* fdholder flags.">flags</a> |= <a class="code" href="ccnr__private_8h.html#adace32c583071eebb603f21dbf6b6043" title="IPv4.">CCNR_FACE_INET</a>;
<a name="l00192"></a>00192         if (rawaddr[0] == 127)
<a name="l00193"></a>00193             fdholder-&gt;<a class="code" href="structfdholder.html#a4333d63eec8e74bebfa6a208ac4a04e1" title="CCNR_FACE_* fdholder flags.">flags</a> |= <a class="code" href="ccnr__private_8h.html#a08ab78ff1353c7769cbd48de610b0f00" title="v4 or v6 loopback address">CCNR_FACE_LOOPBACK</a>;
<a name="l00194"></a>00194         <span class="keywordflow">else</span> {
<a name="l00195"></a>00195             <span class="comment">/* If our side and the peer have the same address, consider it loopback */</span>
<a name="l00196"></a>00196             <span class="comment">/* This is the situation inside of FreeBSD jail. */</span>
<a name="l00197"></a>00197             <span class="keyword">struct </span>sockaddr_in myaddr;
<a name="l00198"></a>00198             socklen_t myaddrlen = <span class="keyword">sizeof</span>(myaddr);
<a name="l00199"></a>00199             <span class="keywordflow">if</span> (0 == getsockname(fdholder-&gt;<a class="code" href="structfdholder.html#ac908cd30e57c88fb92e778c88c61c5a5" title="file descriptor">filedesc</a>, (<span class="keyword">struct</span> sockaddr *)&amp;myaddr, &amp;myaddrlen)) {
<a name="l00200"></a>00200                 <span class="keywordflow">if</span> (addr4-&gt;sin_addr.s_addr == myaddr.sin_addr.s_addr)
<a name="l00201"></a>00201                     fdholder-&gt;<a class="code" href="structfdholder.html#a4333d63eec8e74bebfa6a208ac4a04e1" title="CCNR_FACE_* fdholder flags.">flags</a> |= <a class="code" href="ccnr__private_8h.html#a08ab78ff1353c7769cbd48de610b0f00" title="v4 or v6 loopback address">CCNR_FACE_LOOPBACK</a>;
<a name="l00202"></a>00202             }
<a name="l00203"></a>00203         }
<a name="l00204"></a>00204     }
<a name="l00205"></a>00205     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (addr-&gt;sa_family == AF_UNIX)
<a name="l00206"></a>00206         fdholder-&gt;<a class="code" href="structfdholder.html#a4333d63eec8e74bebfa6a208ac4a04e1" title="CCNR_FACE_* fdholder flags.">flags</a> |= (<a class="code" href="ccnr__private_8h.html#aaa6759b4e8d735e24a69618919156b2b" title="Considered friendly.">CCNR_FACE_GG</a> | <a class="code" href="ccnr__private_8h.html#ad8221ac731fe32b6a1690487d1e569ef" title="PF_UNIX socket.">CCNR_FACE_LOCAL</a>);
<a name="l00207"></a>00207     fdholder-&gt;<a class="code" href="structfdholder.html#a4333d63eec8e74bebfa6a208ac4a04e1" title="CCNR_FACE_* fdholder flags.">flags</a> |= setflags;
<a name="l00208"></a>00208 }
<a name="l00209"></a>00209 <span class="comment"></span>
<a name="l00210"></a>00210 <span class="comment">/**</span>
<a name="l00211"></a>00211 <span class="comment"> * Make a new fdholder corresponding to the fd</span>
<a name="l00212"></a>00212 <span class="comment"> */</span>
<a name="l00213"></a>00213 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keyword">struct </span><a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a> *
<a name="l00214"></a><a class="code" href="ccnr__io_8h.html#a78324ff1dc177fda7255711758f6eefb">00214</a> <a class="code" href="ccnr__io_8c.html#aad75ac1add5fd8245a4f339705cce74c" title="Make a new fdholder corresponding to the fd.">r_io_record_fd</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *h, <span class="keywordtype">int</span> fd,
<a name="l00215"></a>00215                   <span class="keywordtype">void</span> *who, socklen_t wholen,
<a name="l00216"></a>00216                   <span class="keywordtype">int</span> setflags)
<a name="l00217"></a>00217 {
<a name="l00218"></a>00218     <span class="keywordtype">int</span> res;
<a name="l00219"></a>00219     <span class="keyword">struct </span><a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a> *<a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a> = NULL;
<a name="l00220"></a>00220     
<a name="l00221"></a>00221     res = fcntl(fd, F_SETFL, O_NONBLOCK);
<a name="l00222"></a>00222     <span class="keywordflow">if</span> (res == -1)
<a name="l00223"></a>00223         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(h, <span class="stringliteral">&quot;fcntl: %s&quot;</span>, strerror(errno));
<a name="l00224"></a>00224     fdholder = calloc(1, <span class="keyword">sizeof</span>(*fdholder));
<a name="l00225"></a>00225     
<a name="l00226"></a>00226     
<a name="l00227"></a>00227     <span class="keywordflow">if</span> (fdholder == NULL)
<a name="l00228"></a>00228         <span class="keywordflow">return</span>(fdholder);
<a name="l00229"></a>00229     fdholder-&gt;<a class="code" href="structfdholder.html#a999d438f8d6746d3d73c728895ea9602">name</a> = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00230"></a>00230     <span class="keywordflow">if</span> (fdholder-&gt;<a class="code" href="structfdholder.html#a999d438f8d6746d3d73c728895ea9602">name</a> == NULL)
<a name="l00231"></a>00231         abort();
<a name="l00232"></a>00232     <span class="keywordflow">if</span> (who != NULL)
<a name="l00233"></a>00233         <a class="code" href="charbuf_8h.html#a5cc5c1412e38c015951394fcd79e2f6e">ccn_charbuf_append</a>(fdholder-&gt;<a class="code" href="structfdholder.html#a999d438f8d6746d3d73c728895ea9602">name</a>, who, wholen);
<a name="l00234"></a>00234     fdholder-&gt;<a class="code" href="structfdholder.html#ac908cd30e57c88fb92e778c88c61c5a5" title="file descriptor">filedesc</a> = fd;
<a name="l00235"></a>00235     <a class="code" href="ccnr__io_8c.html#a711ff95cf32579b274d58e005550486d" title="Initialize the fdholder flags based upon the addr information and the provided explicit...">init_face_flags</a>(h, fdholder, setflags);
<a name="l00236"></a>00236     res = <a class="code" href="ccnr__io_8c.html#a775a36317c78f580a4d8a56df2202d0c" title="Assigns the filedesc for a nacent fdholder, calls r_io_register_new_face() if successful...">r_io_enroll_face</a>(h, fdholder);
<a name="l00237"></a>00237     <span class="keywordflow">if</span> (res == -1) {
<a name="l00238"></a>00238         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;fdholder-&gt;<a class="code" href="structfdholder.html#a999d438f8d6746d3d73c728895ea9602">name</a>);
<a name="l00239"></a>00239         free(fdholder);
<a name="l00240"></a>00240         fdholder = NULL;
<a name="l00241"></a>00241     }
<a name="l00242"></a>00242     <span class="keywordflow">return</span>(fdholder);
<a name="l00243"></a>00243 }
<a name="l00244"></a>00244 <span class="comment"></span>
<a name="l00245"></a>00245 <span class="comment">/**</span>
<a name="l00246"></a>00246 <span class="comment"> * Accept an incoming DGRAM_STREAM connection, creating a new fdholder.</span>
<a name="l00247"></a>00247 <span class="comment"> * @returns fd of new socket, or -1 for an error.</span>
<a name="l00248"></a>00248 <span class="comment"> */</span>
<a name="l00249"></a>00249 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keywordtype">int</span>
<a name="l00250"></a><a class="code" href="ccnr__io_8h.html#a7c343f885182f8bd0939a26a4c76abbe">00250</a> <a class="code" href="ccnr__io_8c.html#a91a9390a097e7daec0906099972c3ac8" title="Accept an incoming DGRAM_STREAM connection, creating a new fdholder.">r_io_accept_connection</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *h, <span class="keywordtype">int</span> listener_fd)
<a name="l00251"></a>00251 {
<a name="l00252"></a>00252     <span class="keyword">struct </span>sockaddr_storage who;
<a name="l00253"></a>00253     socklen_t wholen = <span class="keyword">sizeof</span>(who);
<a name="l00254"></a>00254     <span class="keywordtype">int</span> fd;
<a name="l00255"></a>00255     <span class="keyword">struct </span><a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a> *<a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a>;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257     fd = accept(listener_fd, (<span class="keyword">struct</span> sockaddr *)&amp;who, &amp;wholen);
<a name="l00258"></a>00258     <span class="keywordflow">if</span> (fd == -1) {
<a name="l00259"></a>00259         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(h, <span class="stringliteral">&quot;accept: %s&quot;</span>, strerror(errno));
<a name="l00260"></a>00260         <span class="keywordflow">return</span>(-1);
<a name="l00261"></a>00261     }
<a name="l00262"></a>00262     fdholder = <a class="code" href="ccnr__io_8c.html#aad75ac1add5fd8245a4f339705cce74c" title="Make a new fdholder corresponding to the fd.">r_io_record_fd</a>(h, fd,
<a name="l00263"></a>00263                             (<span class="keyword">struct</span> sockaddr *)&amp;who, wholen,
<a name="l00264"></a>00264                             <a class="code" href="ccnr__private_8h.html#a57698dcb0d2d135575264be656d92490" title="Might not be talking ccn.">CCNR_FACE_UNDECIDED</a>);
<a name="l00265"></a>00265     <span class="keywordflow">if</span> (fdholder == NULL)
<a name="l00266"></a>00266         <a class="code" href="ccnr__io_8c.html#a994e5d8e4c6fbcf92af52094ebb38032" title="Close an open file descriptor quietly.">close_fd</a>(&amp;fd);
<a name="l00267"></a>00267     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(h, io, <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>))
<a name="l00268"></a>00268         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(h, <span class="stringliteral">&quot;accepted client fd=%d id=%u&quot;</span>, fd, fdholder-&gt;<a class="code" href="structfdholder.html#ac908cd30e57c88fb92e778c88c61c5a5" title="file descriptor">filedesc</a>);
<a name="l00269"></a>00269     <span class="keywordflow">return</span>(fd);
<a name="l00270"></a>00270 }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keywordtype">int</span>
<a name="l00273"></a><a class="code" href="ccnr__io_8h.html#aaac6a5066ed30823b527ce6912b8b846">00273</a> <a class="code" href="ccnr__io_8c.html#a13f7d18e00d3875d919bdc45373e1adb">r_io_open_repo_data_file</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *h, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structfdholder.html#a999d438f8d6746d3d73c728895ea9602">name</a>, <span class="keywordtype">int</span> output)
<a name="l00274"></a>00274 {
<a name="l00275"></a>00275     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *temp = NULL;
<a name="l00276"></a>00276     <span class="keywordtype">int</span> fd = -1;
<a name="l00277"></a>00277     <span class="keyword">struct </span><a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a> *<a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a> = NULL;
<a name="l00278"></a>00278 
<a name="l00279"></a>00279     temp = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00280"></a>00280     <a class="code" href="charbuf_8h.html#a942c4bc14fffdbacfbc0fb477b01125e">ccn_charbuf_putf</a>(temp, <span class="stringliteral">&quot;%s/%s&quot;</span>, h-&gt;<a class="code" href="structccnr__handle.html#ae3ca616edc1adffe6941a0d8113e434f" title="the repository directory">directory</a>, name);
<a name="l00281"></a>00281     fd = open(<a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(temp), output ? (O_CREAT | O_WRONLY | O_APPEND) : O_RDONLY, 0666);
<a name="l00282"></a>00282     <span class="keywordflow">if</span> (fd == -1) {
<a name="l00283"></a>00283         <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(h, sdf, <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>))
<a name="l00284"></a>00284             <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(h, <span class="stringliteral">&quot;open(%s): %s&quot;</span>, <a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(temp), strerror(errno));
<a name="l00285"></a>00285         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;temp);
<a name="l00286"></a>00286         <span class="keywordflow">return</span>(-1);
<a name="l00287"></a>00287     }
<a name="l00288"></a>00288     fdholder = <a class="code" href="ccnr__io_8c.html#aad75ac1add5fd8245a4f339705cce74c" title="Make a new fdholder corresponding to the fd.">r_io_record_fd</a>(h, fd,
<a name="l00289"></a>00289                             temp-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, temp-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>,
<a name="l00290"></a>00290                             <a class="code" href="ccnr__private_8h.html#af7dbc9e8fede4d97d924282930fab471">CCNR_FACE_REPODATA</a> | (output ? <a class="code" href="ccnr__private_8h.html#affe6d30cce8ff19007e645c2edb35505" title="use for sending only">CCNR_FACE_NORECV</a> : <a class="code" href="ccnr__private_8h.html#a1141793d92134b60bc5bb61c0ada2aa2" title="Don&amp;#39;t send anymore.">CCNR_FACE_NOSEND</a>));
<a name="l00291"></a>00291     <span class="keywordflow">if</span> (fdholder == NULL)
<a name="l00292"></a>00292         <a class="code" href="ccnr__io_8c.html#a994e5d8e4c6fbcf92af52094ebb38032" title="Close an open file descriptor quietly.">close_fd</a>(&amp;fd);
<a name="l00293"></a>00293     <span class="keywordflow">else</span> {
<a name="l00294"></a>00294         <span class="keywordflow">if</span> (!output) {
<a name="l00295"></a>00295             <span class="comment">/* Use a larger buffer for indexing an existing repo file */</span>
<a name="l00296"></a>00296             <span class="keywordflow">if</span> (fdholder-&gt;<a class="code" href="structfdholder.html#afe614e89f412cf7b16477ed3244ab676">inbuf</a> == NULL) {
<a name="l00297"></a>00297                 fdholder-&gt;<a class="code" href="structfdholder.html#afe614e89f412cf7b16477ed3244ab676">inbuf</a> = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00298"></a>00298                 fdholder-&gt;<a class="code" href="structfdholder.html#a8fc8c4a44f00fd8738149f5ebabe6510">bufoffset</a> = 0;
<a name="l00299"></a>00299             }
<a name="l00300"></a>00300             <span class="keywordflow">if</span> (fdholder-&gt;<a class="code" href="structfdholder.html#afe614e89f412cf7b16477ed3244ab676">inbuf</a> != NULL)
<a name="l00301"></a>00301                 <a class="code" href="charbuf_8h.html#a3e0e15f90919b9a4da02704830f09717">ccn_charbuf_reserve</a>(fdholder-&gt;<a class="code" href="structfdholder.html#afe614e89f412cf7b16477ed3244ab676">inbuf</a>, 256 * 1024);
<a name="l00302"></a>00302         }
<a name="l00303"></a>00303         <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(h, sdf, <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>))
<a name="l00304"></a>00304             <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(h, <span class="stringliteral">&quot;opened fd=%d file=%s&quot;</span>, fd, <a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(temp));
<a name="l00305"></a>00305     }
<a name="l00306"></a>00306     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;temp);
<a name="l00307"></a>00307     <span class="keywordflow">return</span>(fd);
<a name="l00308"></a>00308 }
<a name="l00309"></a>00309 
<a name="l00310"></a>00310 
<a name="l00311"></a>00311 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keywordtype">int</span>
<a name="l00312"></a><a class="code" href="ccnr__io_8h.html#a803651a3a40a769676aa9663cc79795b">00312</a> <a class="code" href="ccnr__io_8c.html#ab73f41787bd85d4cce92a1263e8dd4cf">r_io_repo_data_file_fd</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *h, <span class="keywordtype">unsigned</span> repofile, <span class="keywordtype">int</span> output)
<a name="l00313"></a>00313 {
<a name="l00314"></a>00314     <span class="keywordflow">if</span> (repofile != 1)
<a name="l00315"></a>00315         <span class="keywordflow">return</span>(-1);
<a name="l00316"></a>00316     <span class="keywordflow">if</span> (output)
<a name="l00317"></a>00317         <span class="keywordflow">return</span>(-1);
<a name="l00318"></a>00318     <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structccnr__handle.html#a969633721ac8e64a690cdbb1634c7af3" title="read-only access to repoFile1">repofile1_fd</a> &gt; 0)
<a name="l00319"></a>00319         <span class="keywordflow">return</span>(h-&gt;<a class="code" href="structccnr__handle.html#a969633721ac8e64a690cdbb1634c7af3" title="read-only access to repoFile1">repofile1_fd</a>);
<a name="l00320"></a>00320     h-&gt;<a class="code" href="structccnr__handle.html#a969633721ac8e64a690cdbb1634c7af3" title="read-only access to repoFile1">repofile1_fd</a> = <a class="code" href="ccnr__io_8c.html#a13f7d18e00d3875d919bdc45373e1adb">r_io_open_repo_data_file</a>(h, <span class="stringliteral">&quot;repoFile1&quot;</span>, 0);
<a name="l00321"></a>00321     <span class="keywordflow">return</span>(h-&gt;<a class="code" href="structccnr__handle.html#a969633721ac8e64a690cdbb1634c7af3" title="read-only access to repoFile1">repofile1_fd</a>);
<a name="l00322"></a>00322 }
<a name="l00323"></a>00323 
<a name="l00324"></a>00324 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keywordtype">void</span>
<a name="l00325"></a><a class="code" href="ccnr__io_8h.html#ab2e4b77c9a4bb9ef4bb53c485e957f64">00325</a> <a class="code" href="ccnr__io_8c.html#a314433faac9985e00db95014a2786721">r_io_shutdown_client_fd</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *h, <span class="keywordtype">int</span> fd)
<a name="l00326"></a>00326 {
<a name="l00327"></a>00327     <span class="keyword">struct </span><a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a> *<a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a> = NULL;
<a name="l00328"></a>00328     <span class="keyword">enum</span> <a class="code" href="ccnd__private_8h.html#a4e3d681b05662964910a195835a7fb0b">cq_delay_class</a> c;
<a name="l00329"></a>00329     <span class="keywordtype">int</span> m;
<a name="l00330"></a>00330     <span class="keywordtype">int</span> res;
<a name="l00331"></a>00331     
<a name="l00332"></a>00332     fdholder = <a class="code" href="ccnr__io_8c.html#ad9ca4dc679b9aa962638ae2c0ad9c68f" title="Looks up a fdholder based on its filedesc (private).">r_io_fdholder_from_fd</a>(h, fd);
<a name="l00333"></a>00333     <span class="keywordflow">if</span> (fdholder == NULL) {
<a name="l00334"></a>00334         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(h, <span class="stringliteral">&quot;no fd holder for fd %d&quot;</span>, fd);
<a name="l00335"></a>00335         <span class="keywordflow">return</span>;
<a name="l00336"></a>00336     }
<a name="l00337"></a>00337     <span class="keywordflow">if</span> (fdholder == h-&gt;<a class="code" href="structccnr__handle.html#a60b1ff48ff8a50320097c88d9696087d" title="special fdholder for internal client">face0</a>)
<a name="l00338"></a>00338         (res = 0, h-&gt;<a class="code" href="structccnr__handle.html#a60b1ff48ff8a50320097c88d9696087d" title="special fdholder for internal client">face0</a> = NULL);
<a name="l00339"></a>00339     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((fdholder-&gt;<a class="code" href="structfdholder.html#a4333d63eec8e74bebfa6a208ac4a04e1" title="CCNR_FACE_* fdholder flags.">flags</a> &amp; <a class="code" href="ccnr__private_8h.html#aa882865c6e1caeb64ec3f21fced8b96d">CCNR_FACE_CCND</a>))
<a name="l00340"></a>00340         res = <a class="code" href="ccn_8h.html#a0bbd9a8ad8414a8f7f955cca679f4d9c">ccn_disconnect</a>(h-&gt;<a class="code" href="structccnr__handle.html#aa358b4c6941900d7e02a620bf1e601b5" title="this talks directly with ccnd">direct_client</a>);
<a name="l00341"></a>00341     <span class="keywordflow">else</span>
<a name="l00342"></a>00342         res = close(fd);
<a name="l00343"></a>00343     <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(h, sdfdf, <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>))
<a name="l00344"></a>00344         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(h, <span class="stringliteral">&quot;shutdown client fd=%d&quot;</span>, fd);
<a name="l00345"></a>00345     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;fdholder-&gt;<a class="code" href="structfdholder.html#afe614e89f412cf7b16477ed3244ab676">inbuf</a>);
<a name="l00346"></a>00346     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;fdholder-&gt;<a class="code" href="structfdholder.html#a938fa5f8863180a44d5628d3be2824b6" title="Buffered output data.">outbuf</a>);
<a name="l00347"></a>00347     <span class="keywordflow">for</span> (c = 0; c &lt; <a class="code" href="ccnd__private_8h.html#a4e3d681b05662964910a195835a7fb0ba7ffbfb12e45549cb96b8293639c45fcd">CCN_CQ_N</a>; c++)
<a name="l00348"></a>00348         <a class="code" href="ccnr__sendq_8c.html#aa4f281876f0db972a327cfa4bcd07a67">r_sendq_content_queue_destroy</a>(h, &amp;(fdholder-&gt;<a class="code" href="structfdholder.html#a4de0fd2a2b46d43af90f46a28b460a55" title="outgoing content, per delay class">q</a>[c]));
<a name="l00349"></a>00349     <span class="keywordflow">for</span> (m = 0; m &lt; <a class="code" href="ccnr__private_8h.html#a11e4411911ab1332d04935d8041ac495a7aede2712e7d2fe9f6370b626f3da2cc">CCNR_FACE_METER_N</a>; m++)
<a name="l00350"></a>00350         <a class="code" href="ccnr__stats_8c.html#a15abc280f91dd7694f4d5a7ef95dfea1" title="Destroy a separately allocated meter.">ccnr_meter_destroy</a>(&amp;fdholder-&gt;<a class="code" href="structfdholder.html#a9a6c1be5c2788e12b4106f679dc7d980">meter</a>[m]);
<a name="l00351"></a>00351     <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structccnr__handle.html#a5270519ee2d84ae571ce01688c20f8d6" title="array with face_limit elements">fdholder_by_fd</a>[fd] != fdholder) abort();
<a name="l00352"></a>00352     h-&gt;<a class="code" href="structccnr__handle.html#a5270519ee2d84ae571ce01688c20f8d6" title="array with face_limit elements">fdholder_by_fd</a>[fd] = NULL;
<a name="l00353"></a>00353     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;fdholder-&gt;<a class="code" href="structfdholder.html#a999d438f8d6746d3d73c728895ea9602">name</a>);
<a name="l00354"></a>00354     free(fdholder);
<a name="l00355"></a>00355     <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structccnr__handle.html#a321b0bbf03bc23d8be34f87ea56b7585" title="data currently being indexed">active_in_fd</a> == fd)
<a name="l00356"></a>00356         h-&gt;<a class="code" href="structccnr__handle.html#a321b0bbf03bc23d8be34f87ea56b7585" title="data currently being indexed">active_in_fd</a> = -1;
<a name="l00357"></a>00357     <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structccnr__handle.html#a86ef1c067b8e023ae75dd0973e15f950" title="repo file we will write to">active_out_fd</a> == fd)
<a name="l00358"></a>00358         h-&gt;<a class="code" href="structccnr__handle.html#a86ef1c067b8e023ae75dd0973e15f950" title="repo file we will write to">active_out_fd</a> = -1;
<a name="l00359"></a>00359     <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structccnr__handle.html#a969633721ac8e64a690cdbb1634c7af3" title="read-only access to repoFile1">repofile1_fd</a> == fd)
<a name="l00360"></a>00360         h-&gt;<a class="code" href="structccnr__handle.html#a969633721ac8e64a690cdbb1634c7af3" title="read-only access to repoFile1">repofile1_fd</a> = -1;
<a name="l00361"></a>00361     <span class="comment">// r_fwd_reap_needed(h, 250000);</span>
<a name="l00362"></a>00362 }
<a name="l00363"></a>00363 <span class="comment"></span>
<a name="l00364"></a>00364 <span class="comment">/**</span>
<a name="l00365"></a>00365 <span class="comment"> * Destroys the fdholder identified by filedesc.</span>
<a name="l00366"></a>00366 <span class="comment"> * @returns 0 for success, -1 for failure.</span>
<a name="l00367"></a>00367 <span class="comment"> */</span>
<a name="l00368"></a>00368 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keywordtype">int</span>
<a name="l00369"></a><a class="code" href="ccnr__io_8h.html#ab88969e4bf6e183fcc4d6c7a3ba04925">00369</a> <a class="code" href="ccnr__io_8c.html#a744b2dc7a52b5d37ae92394b82c96e8f" title="Destroys the fdholder identified by filedesc.">r_io_destroy_face</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *h, <span class="keywordtype">unsigned</span> <a class="code" href="structfdholder.html#ac908cd30e57c88fb92e778c88c61c5a5" title="file descriptor">filedesc</a>)
<a name="l00370"></a>00370 {
<a name="l00371"></a>00371     <a class="code" href="ccnr__io_8c.html#a314433faac9985e00db95014a2786721">r_io_shutdown_client_fd</a>(h, filedesc);
<a name="l00372"></a>00372     <span class="keywordflow">return</span>(0);
<a name="l00373"></a>00373 }
<a name="l00374"></a>00374 <span class="comment"></span>
<a name="l00375"></a>00375 <span class="comment">/**</span>
<a name="l00376"></a>00376 <span class="comment"> * Called when a fdholder is first created, and (perhaps) a second time in the case</span>
<a name="l00377"></a>00377 <span class="comment"> * that a fdholder transitions from the undecided state.</span>
<a name="l00378"></a>00378 <span class="comment"> */</span>
<a name="l00379"></a>00379 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keywordtype">void</span>
<a name="l00380"></a><a class="code" href="ccnr__io_8h.html#ae5d38587f6dd0d1e6b504869a6ca09c8">00380</a> <a class="code" href="ccnr__io_8c.html#a6809cc3f71d4cf47a651dbfe88c5b675" title="Called when a fdholder is first created, and (perhaps) a second time in the case...">r_io_register_new_face</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *h, <span class="keyword">struct</span> <a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a> *<a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a>)
<a name="l00381"></a>00381 {
<a name="l00382"></a>00382     <span class="keywordflow">if</span> (fdholder-&gt;<a class="code" href="structfdholder.html#ac908cd30e57c88fb92e778c88c61c5a5" title="file descriptor">filedesc</a> != 0 &amp;&amp; (fdholder-&gt;<a class="code" href="structfdholder.html#a4333d63eec8e74bebfa6a208ac4a04e1" title="CCNR_FACE_* fdholder flags.">flags</a> &amp; (<a class="code" href="ccnr__private_8h.html#a57698dcb0d2d135575264be656d92490" title="Might not be talking ccn.">CCNR_FACE_UNDECIDED</a> | <a class="code" href="ccnr__private_8h.html#a9e6ccf754353e249fd88436e52290f94" title="a listener or a bound dgram socket">CCNR_FACE_PASSIVE</a>)) == 0) {
<a name="l00383"></a>00383         <a class="code" href="ccnr__internal__client_8c.html#a265c6864021dbc9047f670beca911e1d" title="Called by ccnr when a fdholder undergoes a substantive status change that should...">ccnr_face_status_change</a>(h, fdholder-&gt;<a class="code" href="structfdholder.html#ac908cd30e57c88fb92e778c88c61c5a5" title="file descriptor">filedesc</a>);
<a name="l00384"></a>00384     }
<a name="l00385"></a>00385 }
<a name="l00386"></a>00386 <span class="comment"></span>
<a name="l00387"></a>00387 <span class="comment">/**</span>
<a name="l00388"></a>00388 <span class="comment"> * Handle errors after send() or sendto().</span>
<a name="l00389"></a>00389 <span class="comment"> * @returns -1 if error has been dealt with, or 0 to defer sending.</span>
<a name="l00390"></a>00390 <span class="comment"> */</span>
<a name="l00391"></a>00391 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00392"></a><a class="code" href="ccnr__io_8c.html#a4683d340527abe5ce11d71776b31a246">00392</a> <a class="code" href="ccnr__io_8c.html#a4683d340527abe5ce11d71776b31a246" title="Handle errors after send() or sendto().">handle_send_error</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *h, <span class="keywordtype">int</span> errnum, <span class="keyword">struct</span> <a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a> *<a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a>,
<a name="l00393"></a>00393                   <span class="keyword">const</span> <span class="keywordtype">void</span> *data, <span class="keywordtype">size_t</span> size)
<a name="l00394"></a>00394 {
<a name="l00395"></a>00395     <span class="keywordtype">int</span> res = -1;
<a name="l00396"></a>00396     <span class="keywordflow">if</span> (errnum == EAGAIN) {
<a name="l00397"></a>00397         res = 0;
<a name="l00398"></a>00398     }
<a name="l00399"></a>00399     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (errnum == EPIPE) {
<a name="l00400"></a>00400         fdholder-&gt;<a class="code" href="structfdholder.html#a4333d63eec8e74bebfa6a208ac4a04e1" title="CCNR_FACE_* fdholder flags.">flags</a> |= <a class="code" href="ccnr__private_8h.html#a1141793d92134b60bc5bb61c0ada2aa2" title="Don&amp;#39;t send anymore.">CCNR_FACE_NOSEND</a>;
<a name="l00401"></a>00401         fdholder-&gt;<a class="code" href="structfdholder.html#a86923f30f670aa49fd65e852d29daa26">outbufindex</a> = 0;
<a name="l00402"></a>00402         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;fdholder-&gt;<a class="code" href="structfdholder.html#a938fa5f8863180a44d5628d3be2824b6" title="Buffered output data.">outbuf</a>);
<a name="l00403"></a>00403     }
<a name="l00404"></a>00404     <span class="keywordflow">else</span> {
<a name="l00405"></a>00405         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(h, <span class="stringliteral">&quot;send/write to fd %u failed: %s (errno = %d)&quot;</span>,
<a name="l00406"></a>00406                  fdholder-&gt;<a class="code" href="structfdholder.html#ac908cd30e57c88fb92e778c88c61c5a5" title="file descriptor">filedesc</a>, strerror(errnum), errnum);
<a name="l00407"></a>00407         <span class="keywordflow">if</span> (errnum == EISCONN || errnum == EFBIG || errnum == ENOSPC)
<a name="l00408"></a>00408             res = 0;
<a name="l00409"></a>00409     }
<a name="l00410"></a>00410     <span class="keywordflow">return</span>(res);
<a name="l00411"></a>00411 }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00414"></a><a class="code" href="ccnr__io_8c.html#aba06f489a005b089cae786104129ca86">00414</a> <a class="code" href="ccnr__io_8c.html#aba06f489a005b089cae786104129ca86">sending_fd</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *h, <span class="keyword">struct</span> <a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a> *<a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a>)
<a name="l00415"></a>00415 {
<a name="l00416"></a>00416     <span class="keywordflow">return</span>(fdholder-&gt;<a class="code" href="structfdholder.html#ac908cd30e57c88fb92e778c88c61c5a5" title="file descriptor">filedesc</a>);
<a name="l00417"></a>00417 }
<a name="l00418"></a>00418 <span class="comment"></span>
<a name="l00419"></a>00419 <span class="comment">/**</span>
<a name="l00420"></a>00420 <span class="comment"> * Send data to the fdholder.</span>
<a name="l00421"></a>00421 <span class="comment"> *</span>
<a name="l00422"></a>00422 <span class="comment"> * No direct error result is provided; the fdholder state is updated as needed.</span>
<a name="l00423"></a>00423 <span class="comment"> */</span>
<a name="l00424"></a>00424 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keywordtype">void</span>
<a name="l00425"></a><a class="code" href="ccnr__io_8h.html#a2930509ca06dbadcd0bd055a23e4703c">00425</a> <a class="code" href="ccnr__io_8c.html#a0fc56906a634526232f06a7827fbf5ec" title="Send data to the fdholder.">r_io_send</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *h,
<a name="l00426"></a>00426           <span class="keyword">struct</span> <a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a> *<a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a>,
<a name="l00427"></a>00427           <span class="keyword">const</span> <span class="keywordtype">void</span> *data, <span class="keywordtype">size_t</span> size,
<a name="l00428"></a>00428           off_t *offsetp)
<a name="l00429"></a>00429 {
<a name="l00430"></a>00430     ssize_t res;
<a name="l00431"></a>00431     off_t offset = -1;
<a name="l00432"></a>00432     
<a name="l00433"></a>00433     <span class="keywordflow">if</span> (offsetp != NULL)
<a name="l00434"></a>00434         *offsetp = (off_t)-1;
<a name="l00435"></a>00435     <span class="keywordflow">if</span> ((fdholder-&gt;<a class="code" href="structfdholder.html#a4333d63eec8e74bebfa6a208ac4a04e1" title="CCNR_FACE_* fdholder flags.">flags</a> &amp; <a class="code" href="ccnr__private_8h.html#a1141793d92134b60bc5bb61c0ada2aa2" title="Don&amp;#39;t send anymore.">CCNR_FACE_NOSEND</a>) != 0)
<a name="l00436"></a>00436         <span class="keywordflow">return</span>;
<a name="l00437"></a>00437     <span class="keywordflow">if</span> (fdholder-&gt;<a class="code" href="structfdholder.html#a938fa5f8863180a44d5628d3be2824b6" title="Buffered output data.">outbuf</a> != NULL) {
<a name="l00438"></a>00438         <a class="code" href="charbuf_8h.html#a5cc5c1412e38c015951394fcd79e2f6e">ccn_charbuf_append</a>(fdholder-&gt;<a class="code" href="structfdholder.html#a938fa5f8863180a44d5628d3be2824b6" title="Buffered output data.">outbuf</a>, data, size);
<a name="l00439"></a>00439         <span class="keywordflow">return</span>;
<a name="l00440"></a>00440     }
<a name="l00441"></a>00441     <span class="keywordflow">if</span> (fdholder == h-&gt;<a class="code" href="structccnr__handle.html#a60b1ff48ff8a50320097c88d9696087d" title="special fdholder for internal client">face0</a>) {
<a name="l00442"></a>00442         <a class="code" href="ccnr__stats_8c.html#aa037d7a20b1d08dab89294377d7d8a22" title="Count something (messages, packets, bytes), and roll up some kind of statistics on...">ccnr_meter_bump</a>(h, fdholder-&gt;<a class="code" href="structfdholder.html#a9a6c1be5c2788e12b4106f679dc7d980">meter</a>[<a class="code" href="ccnd__private_8h.html#a64d4281f797a99f7317a023249ff07e6a68df0f6c6a44af2cf5c43a81ccb8ee49">FM_BYTO</a>], size);
<a name="l00443"></a>00443         <a class="code" href="ccn__private_8h.html#a9c7fdb65a91223a51cd7a3e6ab850765" title="Dispatch a message through the registered upcalls.">ccn_dispatch_message</a>(h-&gt;<a class="code" href="structccnr__handle.html#a727b64d3a16c6655ef03dcf81cc54c9a" title="internal client">internal_client</a>, (<span class="keywordtype">void</span> *)data, size);
<a name="l00444"></a>00444         <a class="code" href="ccnr__dispatch_8c.html#a4f7a7467f4f4d4d18f5d1bab0b908bce">r_dispatch_process_internal_client_buffer</a>(h);
<a name="l00445"></a>00445         <span class="keywordflow">return</span>;
<a name="l00446"></a>00446     }
<a name="l00447"></a>00447     <span class="keywordflow">if</span> ((fdholder-&gt;<a class="code" href="structfdholder.html#a4333d63eec8e74bebfa6a208ac4a04e1" title="CCNR_FACE_* fdholder flags.">flags</a> &amp; <a class="code" href="ccnr__private_8h.html#aa882865c6e1caeb64ec3f21fced8b96d">CCNR_FACE_CCND</a>) != 0) {
<a name="l00448"></a>00448         <span class="comment">/* Writes here need to go via the direct client&#39;s handle. */</span>
<a name="l00449"></a>00449         <a class="code" href="ccnr__stats_8c.html#aa037d7a20b1d08dab89294377d7d8a22" title="Count something (messages, packets, bytes), and roll up some kind of statistics on...">ccnr_meter_bump</a>(h, fdholder-&gt;<a class="code" href="structfdholder.html#a9a6c1be5c2788e12b4106f679dc7d980">meter</a>[<a class="code" href="ccnd__private_8h.html#a64d4281f797a99f7317a023249ff07e6a68df0f6c6a44af2cf5c43a81ccb8ee49">FM_BYTO</a>], size);
<a name="l00450"></a>00450         res = <a class="code" href="ccn_8h.html#ac71f5c8727443c13afb11cf471f5f8fc">ccn_put</a>(h-&gt;<a class="code" href="structccnr__handle.html#aa358b4c6941900d7e02a620bf1e601b5" title="this talks directly with ccnd">direct_client</a>, data, size);
<a name="l00451"></a>00451         <span class="keywordflow">if</span> (res &lt; 0 &amp;&amp; <a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(h, <a class="code" href="ccnr__io_8c.html#a0fc56906a634526232f06a7827fbf5ec" title="Send data to the fdholder.">r_io_send</a>, <a class="code" href="loglevels_8h.html#a2813bb28b1559ff71ca56e66d8df63a6" title="Something might be wrong.">CCNL_WARNING</a>))
<a name="l00452"></a>00452             <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(h, <span class="stringliteral">&quot;ccn_put failed&quot;</span>);
<a name="l00453"></a>00453         <span class="keywordflow">if</span> (res == 1 &amp;&amp; <a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(h, <a class="code" href="ccnr__io_8c.html#a0fc56906a634526232f06a7827fbf5ec" title="Send data to the fdholder.">r_io_send</a>, <a class="code" href="loglevels_8h.html#ac0d8d64571564474f2a508ed977125e8" title="MORE DEBUGGING YET.">CCNL_FINEST</a>))
<a name="l00454"></a>00454             <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(h, <span class="stringliteral">&quot;ccn_put deferred output for later send&quot;</span>);
<a name="l00455"></a>00455         <span class="keywordflow">return</span>;
<a name="l00456"></a>00456     }
<a name="l00457"></a>00457     <span class="keywordflow">if</span> ((fdholder-&gt;<a class="code" href="structfdholder.html#a4333d63eec8e74bebfa6a208ac4a04e1" title="CCNR_FACE_* fdholder flags.">flags</a> &amp; <a class="code" href="ccnr__private_8h.html#af7dbc9e8fede4d97d924282930fab471">CCNR_FACE_REPODATA</a>) != 0) {
<a name="l00458"></a>00458         offset = lseek(fdholder-&gt;<a class="code" href="structfdholder.html#ac908cd30e57c88fb92e778c88c61c5a5" title="file descriptor">filedesc</a>, 0, SEEK_END);
<a name="l00459"></a>00459         <span class="keywordflow">if</span> (offset == (off_t)-1) {
<a name="l00460"></a>00460             <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(h, <span class="stringliteral">&quot;lseek(%d): %s&quot;</span>, fdholder-&gt;<a class="code" href="structfdholder.html#ac908cd30e57c88fb92e778c88c61c5a5" title="file descriptor">filedesc</a>, strerror(errno));
<a name="l00461"></a>00461             <span class="keywordflow">return</span>;
<a name="l00462"></a>00462         }
<a name="l00463"></a>00463         <span class="keywordflow">if</span> (offsetp != NULL)
<a name="l00464"></a>00464             *offsetp = offset;
<a name="l00465"></a>00465         <span class="keywordflow">if</span> (fdholder-&gt;<a class="code" href="structfdholder.html#ac908cd30e57c88fb92e778c88c61c5a5" title="file descriptor">filedesc</a> == h-&gt;<a class="code" href="structccnr__handle.html#a86ef1c067b8e023ae75dd0973e15f950" title="repo file we will write to">active_out_fd</a>) {
<a name="l00466"></a>00466             <span class="keywordflow">if</span> (offset != h-&gt;<a class="code" href="structccnr__handle.html#ac8d0031bfa709973703ab9eb0c5af73c" title="repoFile1 size at shutdown">stable</a> &amp;&amp; h-&gt;<a class="code" href="structccnr__handle.html#ac8d0031bfa709973703ab9eb0c5af73c" title="repoFile1 size at shutdown">stable</a> != 0)
<a name="l00467"></a>00467                 <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(h, <span class="stringliteral">&quot;expected file size %ju, found %ju&quot;</span>,
<a name="l00468"></a>00468                     (uintmax_t)h-&gt;<a class="code" href="structccnr__handle.html#ac8d0031bfa709973703ab9eb0c5af73c" title="repoFile1 size at shutdown">stable</a>,
<a name="l00469"></a>00469                     (uintmax_t)offset);
<a name="l00470"></a>00470             h-&gt;<a class="code" href="structccnr__handle.html#ac8d0031bfa709973703ab9eb0c5af73c" title="repoFile1 size at shutdown">stable</a> = offset + size;
<a name="l00471"></a>00471         }
<a name="l00472"></a>00472     }
<a name="l00473"></a>00473     <span class="keywordflow">if</span> ((fdholder-&gt;<a class="code" href="structfdholder.html#a4333d63eec8e74bebfa6a208ac4a04e1" title="CCNR_FACE_* fdholder flags.">flags</a> &amp; <a class="code" href="ccnr__private_8h.html#a036a3d15d021ab23e1a588e402de5586" title="fdholder flags">CCNR_FACE_DGRAM</a>) == 0)
<a name="l00474"></a>00474         res = write(fdholder-&gt;<a class="code" href="structfdholder.html#ac908cd30e57c88fb92e778c88c61c5a5" title="file descriptor">filedesc</a>, data, size);
<a name="l00475"></a>00475     <span class="keywordflow">else</span>
<a name="l00476"></a>00476         res = sendto(<a class="code" href="ccnr__io_8c.html#aba06f489a005b089cae786104129ca86">sending_fd</a>(h, fdholder), data, size, 0,
<a name="l00477"></a>00477                      (<span class="keyword">struct</span> sockaddr *)fdholder-&gt;<a class="code" href="structfdholder.html#a999d438f8d6746d3d73c728895ea9602">name</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>,
<a name="l00478"></a>00478                      fdholder-&gt;<a class="code" href="structfdholder.html#a999d438f8d6746d3d73c728895ea9602">name</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00479"></a>00479     <span class="keywordflow">if</span> (res &gt; 0)
<a name="l00480"></a>00480         <a class="code" href="ccnr__stats_8c.html#aa037d7a20b1d08dab89294377d7d8a22" title="Count something (messages, packets, bytes), and roll up some kind of statistics on...">ccnr_meter_bump</a>(h, fdholder-&gt;<a class="code" href="structfdholder.html#a9a6c1be5c2788e12b4106f679dc7d980">meter</a>[<a class="code" href="ccnd__private_8h.html#a64d4281f797a99f7317a023249ff07e6a68df0f6c6a44af2cf5c43a81ccb8ee49">FM_BYTO</a>], res);
<a name="l00481"></a>00481     <span class="keywordflow">if</span> (res == size)
<a name="l00482"></a>00482         <span class="keywordflow">return</span>;
<a name="l00483"></a>00483     <span class="keywordflow">if</span> (res == -1) {
<a name="l00484"></a>00484         res = <a class="code" href="ccnr__io_8c.html#a4683d340527abe5ce11d71776b31a246" title="Handle errors after send() or sendto().">handle_send_error</a>(h, errno, fdholder, data, size);
<a name="l00485"></a>00485         <span class="keywordflow">if</span> (res == -1)
<a name="l00486"></a>00486             <span class="keywordflow">return</span>;
<a name="l00487"></a>00487     }
<a name="l00488"></a>00488     <span class="keywordflow">if</span> ((fdholder-&gt;<a class="code" href="structfdholder.html#a4333d63eec8e74bebfa6a208ac4a04e1" title="CCNR_FACE_* fdholder flags.">flags</a> &amp; <a class="code" href="ccnr__private_8h.html#a036a3d15d021ab23e1a588e402de5586" title="fdholder flags">CCNR_FACE_DGRAM</a>) != 0) {
<a name="l00489"></a>00489         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(h, <span class="stringliteral">&quot;sendto short&quot;</span>);
<a name="l00490"></a>00490         <span class="keywordflow">return</span>;
<a name="l00491"></a>00491     }
<a name="l00492"></a>00492     <span class="keywordflow">if</span> ((fdholder-&gt;<a class="code" href="structfdholder.html#a4333d63eec8e74bebfa6a208ac4a04e1" title="CCNR_FACE_* fdholder flags.">flags</a> &amp; <a class="code" href="ccnr__private_8h.html#af7dbc9e8fede4d97d924282930fab471">CCNR_FACE_REPODATA</a>) != 0) {
<a name="l00493"></a>00493         <span class="comment">// need to truncate back to last known good object then exit.</span>
<a name="l00494"></a>00494         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(h, <span class="stringliteral">&quot;Unrecoverable write error writing to repository. Content NOT stored.&quot;</span>);
<a name="l00495"></a>00495         ftruncate(fdholder-&gt;<a class="code" href="structfdholder.html#ac908cd30e57c88fb92e778c88c61c5a5" title="file descriptor">filedesc</a>, offset);
<a name="l00496"></a>00496         h-&gt;<a class="code" href="structccnr__handle.html#a6c2af24a1cd0382446796ca9038adf9b" title="true while should be running">running</a> = 0;
<a name="l00497"></a>00497         <span class="keywordflow">return</span>;
<a name="l00498"></a>00498     }
<a name="l00499"></a>00499     fdholder-&gt;<a class="code" href="structfdholder.html#a86923f30f670aa49fd65e852d29daa26">outbufindex</a> = 0;
<a name="l00500"></a>00500     fdholder-&gt;<a class="code" href="structfdholder.html#a938fa5f8863180a44d5628d3be2824b6" title="Buffered output data.">outbuf</a> = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00501"></a>00501     <span class="keywordflow">if</span> (fdholder-&gt;<a class="code" href="structfdholder.html#a938fa5f8863180a44d5628d3be2824b6" title="Buffered output data.">outbuf</a> == NULL) {
<a name="l00502"></a>00502         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(h, <span class="stringliteral">&quot;do_write: %s&quot;</span>, strerror(errno));
<a name="l00503"></a>00503         <span class="keywordflow">return</span>;
<a name="l00504"></a>00504     }
<a name="l00505"></a>00505     <a class="code" href="charbuf_8h.html#a5cc5c1412e38c015951394fcd79e2f6e">ccn_charbuf_append</a>(fdholder-&gt;<a class="code" href="structfdholder.html#a938fa5f8863180a44d5628d3be2824b6" title="Buffered output data.">outbuf</a>,
<a name="l00506"></a>00506                        ((<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)data) + res, size - res);
<a name="l00507"></a>00507 }<span class="comment"></span>
<a name="l00508"></a>00508 <span class="comment">/**</span>
<a name="l00509"></a>00509 <span class="comment"> * Set up the array of fd descriptors for the poll(2) call.</span>
<a name="l00510"></a>00510 <span class="comment"> *</span>
<a name="l00511"></a>00511 <span class="comment"> */</span>
<a name="l00512"></a>00512 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keywordtype">void</span>
<a name="l00513"></a><a class="code" href="ccnr__io_8h.html#a65bfcddf8b685a461068de4e908bbebd">00513</a> <a class="code" href="ccnr__io_8c.html#a5d96f431cc04e8d2eedf9f620b7b2ea3" title="Set up the array of fd descriptors for the poll(2) call.">r_io_prepare_poll_fds</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *h)
<a name="l00514"></a>00514 {
<a name="l00515"></a>00515     <span class="keywordtype">int</span> i, j, nfds;
<a name="l00516"></a>00516     
<a name="l00517"></a>00517     <span class="keywordflow">for</span> (i = 1, nfds = 0; i &lt; h-&gt;<a class="code" href="structccnr__handle.html#a60ce3909d3d49be5a067e49fd8a15ea9" title="current number of fdholder slots">face_limit</a>; i++)
<a name="l00518"></a>00518         <span class="keywordflow">if</span> (<a class="code" href="ccnr__io_8c.html#ad9ca4dc679b9aa962638ae2c0ad9c68f" title="Looks up a fdholder based on its filedesc (private).">r_io_fdholder_from_fd</a>(h, i) != NULL)
<a name="l00519"></a>00519             nfds++;
<a name="l00520"></a>00520     
<a name="l00521"></a>00521     <span class="keywordflow">if</span> (nfds != h-&gt;<a class="code" href="structccnr__handle.html#a60b09849de07648e3d27e42da374070c" title="number of entries in fds array">nfds</a>) {
<a name="l00522"></a>00522         h-&gt;<a class="code" href="structccnr__handle.html#a60b09849de07648e3d27e42da374070c" title="number of entries in fds array">nfds</a> = nfds;
<a name="l00523"></a>00523         h-&gt;<a class="code" href="structccnr__handle.html#af9c114be53423f5f1c823419fac1b022" title="used for poll system call">fds</a> = realloc(h-&gt;<a class="code" href="structccnr__handle.html#af9c114be53423f5f1c823419fac1b022" title="used for poll system call">fds</a>, h-&gt;<a class="code" href="structccnr__handle.html#a60b09849de07648e3d27e42da374070c" title="number of entries in fds array">nfds</a> * <span class="keyword">sizeof</span>(h-&gt;<a class="code" href="structccnr__handle.html#af9c114be53423f5f1c823419fac1b022" title="used for poll system call">fds</a>[0]));
<a name="l00524"></a>00524         memset(h-&gt;<a class="code" href="structccnr__handle.html#af9c114be53423f5f1c823419fac1b022" title="used for poll system call">fds</a>, 0, h-&gt;<a class="code" href="structccnr__handle.html#a60b09849de07648e3d27e42da374070c" title="number of entries in fds array">nfds</a> * <span class="keyword">sizeof</span>(h-&gt;<a class="code" href="structccnr__handle.html#af9c114be53423f5f1c823419fac1b022" title="used for poll system call">fds</a>[0]));
<a name="l00525"></a>00525     }
<a name="l00526"></a>00526     <span class="keywordflow">for</span> (i = 1, j = 0; i &lt; h-&gt;<a class="code" href="structccnr__handle.html#a60ce3909d3d49be5a067e49fd8a15ea9" title="current number of fdholder slots">face_limit</a>; i++) {
<a name="l00527"></a>00527         <span class="keyword">struct </span><a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a> *<a class="code" href="structfdholder.html" title="Each fdholder is referenced by its file descriptor.">fdholder</a> = <a class="code" href="ccnr__io_8c.html#ad9ca4dc679b9aa962638ae2c0ad9c68f" title="Looks up a fdholder based on its filedesc (private).">r_io_fdholder_from_fd</a>(h, i);
<a name="l00528"></a>00528         <span class="keywordflow">if</span> (fdholder != NULL) {
<a name="l00529"></a>00529             h-&gt;<a class="code" href="structccnr__handle.html#af9c114be53423f5f1c823419fac1b022" title="used for poll system call">fds</a>[j].fd = fdholder-&gt;<a class="code" href="structfdholder.html#ac908cd30e57c88fb92e778c88c61c5a5" title="file descriptor">filedesc</a>;
<a name="l00530"></a>00530             h-&gt;<a class="code" href="structccnr__handle.html#af9c114be53423f5f1c823419fac1b022" title="used for poll system call">fds</a>[j].events = 0;
<a name="l00531"></a>00531             <span class="keywordflow">if</span> ((fdholder-&gt;<a class="code" href="structfdholder.html#a4333d63eec8e74bebfa6a208ac4a04e1" title="CCNR_FACE_* fdholder flags.">flags</a> &amp; (<a class="code" href="ccnr__private_8h.html#affe6d30cce8ff19007e645c2edb35505" title="use for sending only">CCNR_FACE_NORECV</a>|<a class="code" href="ccnr__private_8h.html#af7dbc9e8fede4d97d924282930fab471">CCNR_FACE_REPODATA</a>)) == 0)
<a name="l00532"></a>00532                 h-&gt;<a class="code" href="structccnr__handle.html#af9c114be53423f5f1c823419fac1b022" title="used for poll system call">fds</a>[j].events |= POLLIN;
<a name="l00533"></a>00533             <span class="keywordflow">if</span> (fdholder-&gt;<a class="code" href="structfdholder.html#ac908cd30e57c88fb92e778c88c61c5a5" title="file descriptor">filedesc</a> == h-&gt;<a class="code" href="structccnr__handle.html#a321b0bbf03bc23d8be34f87ea56b7585" title="data currently being indexed">active_in_fd</a>)
<a name="l00534"></a>00534                 h-&gt;<a class="code" href="structccnr__handle.html#af9c114be53423f5f1c823419fac1b022" title="used for poll system call">fds</a>[j].events |= POLLIN;
<a name="l00535"></a>00535             <span class="keywordflow">if</span> (((fdholder-&gt;<a class="code" href="structfdholder.html#a4333d63eec8e74bebfa6a208ac4a04e1" title="CCNR_FACE_* fdholder flags.">flags</a> &amp; <a class="code" href="ccnr__private_8h.html#af7dbc9e8fede4d97d924282930fab471">CCNR_FACE_REPODATA</a>) == 0) &amp;&amp;
<a name="l00536"></a>00536                 ((fdholder-&gt;<a class="code" href="structfdholder.html#a938fa5f8863180a44d5628d3be2824b6" title="Buffered output data.">outbuf</a> != NULL || (fdholder-&gt;<a class="code" href="structfdholder.html#a4333d63eec8e74bebfa6a208ac4a04e1" title="CCNR_FACE_* fdholder flags.">flags</a> &amp; <a class="code" href="ccnr__private_8h.html#a4df41105cb52adfe10e7624bd93fffdc" title="close stream when output is done">CCNR_FACE_CLOSING</a>) != 0)))
<a name="l00537"></a>00537                 h-&gt;<a class="code" href="structccnr__handle.html#af9c114be53423f5f1c823419fac1b022" title="used for poll system call">fds</a>[j].events |= POLLOUT;
<a name="l00538"></a>00538              <span class="keywordflow">if</span> ((fdholder-&gt;<a class="code" href="structfdholder.html#a4333d63eec8e74bebfa6a208ac4a04e1" title="CCNR_FACE_* fdholder flags.">flags</a> &amp; <a class="code" href="ccnr__private_8h.html#aa882865c6e1caeb64ec3f21fced8b96d">CCNR_FACE_CCND</a>) != 0) {
<a name="l00539"></a>00539                  <span class="keywordflow">if</span> (<a class="code" href="ccn_8h.html#a9b6da55e8377d824bb7200dc4287354f">ccn_output_is_pending</a>(h-&gt;<a class="code" href="structccnr__handle.html#aa358b4c6941900d7e02a620bf1e601b5" title="this talks directly with ccnd">direct_client</a>)) {
<a name="l00540"></a>00540                      <span class="keywordflow">if</span> (<a class="code" href="ccnr__private_8h.html#a2f3296ebf2e6ebb38af5517f39966451" title="This is true if we should log at the given level.">CCNSHOULDLOG</a>(h, xxx, <a class="code" href="loglevels_8h.html#ac0d8d64571564474f2a508ed977125e8" title="MORE DEBUGGING YET.">CCNL_FINEST</a>))
<a name="l00541"></a>00541                         <a class="code" href="ccnr__msg_8c.html#ae8f064042e04d941d18181ba70d5fa7d" title="Produce ccnr debug output.">ccnr_msg</a>(h, <span class="stringliteral">&quot;including direct client in poll set&quot;</span>);
<a name="l00542"></a>00542                      h-&gt;<a class="code" href="structccnr__handle.html#af9c114be53423f5f1c823419fac1b022" title="used for poll system call">fds</a>[j].events |= POLLOUT;
<a name="l00543"></a>00543                 }
<a name="l00544"></a>00544              }
<a name="l00545"></a>00545             j++;
<a name="l00546"></a>00546         }
<a name="l00547"></a>00547     }
<a name="l00548"></a>00548 }
<a name="l00549"></a>00549 <span class="comment"></span>
<a name="l00550"></a>00550 <span class="comment">/**</span>
<a name="l00551"></a>00551 <span class="comment"> * Shutdown all open fds.</span>
<a name="l00552"></a>00552 <span class="comment"> */</span>
<a name="l00553"></a>00553 <a class="code" href="ccnr__private_8h.html#ad17d551e31d1828c68acf40684849b7e">PUBLIC</a> <span class="keywordtype">void</span>
<a name="l00554"></a><a class="code" href="ccnr__io_8h.html#a9698b2567dd213288b12bf9cd99d64ca">00554</a> <a class="code" href="ccnr__io_8c.html#a4a5eb57b09be62a6f2a18f6077111c03" title="Shutdown all open fds.">r_io_shutdown_all</a>(<span class="keyword">struct</span> <a class="code" href="structccnr__handle.html" title="We pass this handle almost everywhere within ccnr.">ccnr_handle</a> *h)
<a name="l00555"></a>00555 {
<a name="l00556"></a>00556     <span class="keywordtype">int</span> i;
<a name="l00557"></a>00557     <span class="keywordflow">for</span> (i = 1; i &lt; h-&gt;<a class="code" href="structccnr__handle.html#a60ce3909d3d49be5a067e49fd8a15ea9" title="current number of fdholder slots">face_limit</a>; i++) {
<a name="l00558"></a>00558         <span class="keywordflow">if</span> (<a class="code" href="ccnr__io_8c.html#ad9ca4dc679b9aa962638ae2c0ad9c68f" title="Looks up a fdholder based on its filedesc (private).">r_io_fdholder_from_fd</a>(h, i) != NULL)
<a name="l00559"></a>00559             <a class="code" href="ccnr__io_8c.html#a314433faac9985e00db95014a2786721">r_io_shutdown_client_fd</a>(h, i);
<a name="l00560"></a>00560     }
<a name="l00561"></a>00561     <a class="code" href="ccnr__internal__client_8c.html#a3f8c18bce7aaa2f72aba7b0f5d7a78b9">ccnr_internal_client_stop</a>(h);
<a name="l00562"></a>00562     <a class="code" href="ccnr__io_8c.html#a314433faac9985e00db95014a2786721">r_io_shutdown_client_fd</a>(h, 0);
<a name="l00563"></a>00563 }
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Mon Feb 4 11:56:45 2013 for Content-Centric Networking in C by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
