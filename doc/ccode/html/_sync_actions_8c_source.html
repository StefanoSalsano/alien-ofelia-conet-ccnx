<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Content-Centric Networking in C: sync/SyncActions.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_a2ce97d05a9d430b2851eef455e009f7.html">sync</a>
  </div>
</div>
<div class="contents">
<h1>SyncActions.c</h1><a href="_sync_actions_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/**</span>
<a name="l00002"></a>00002 <span class="comment"> * @file sync/SyncActions.c</span>
<a name="l00003"></a>00003 <span class="comment"> *  </span>
<a name="l00004"></a>00004 <span class="comment"> * Part of CCNx Sync.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * This library is free software; you can redistribute it and/or modify it</span>
<a name="l00007"></a>00007 <span class="comment"> * under the terms of the GNU Lesser General Public License version 2.1</span>
<a name="l00008"></a>00008 <span class="comment"> * as published by the Free Software Foundation.</span>
<a name="l00009"></a>00009 <span class="comment"> * This library is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU</span>
<a name="l00012"></a>00012 <span class="comment"> * Lesser General Public License for more details. You should have received</span>
<a name="l00013"></a>00013 <span class="comment"> * a copy of the GNU Lesser General Public License along with this library;</span>
<a name="l00014"></a>00014 <span class="comment"> * if not, write to the Free Software Foundation, Inc., 51 Franklin Street,</span>
<a name="l00015"></a>00015 <span class="comment"> * Fifth Floor, Boston, MA 02110-1301 USA.</span>
<a name="l00016"></a>00016 <span class="comment"> */</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;strings.h&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;sys/resource.h&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;<a class="code" href="ccn_8h.html" title="This is the low-level interface for CCNx clients.">ccn/ccn.h</a>&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;<a class="code" href="charbuf_8h.html" title="Expandable character buffer for counted sequences of arbitrary octets.">ccn/charbuf.h</a>&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;<a class="code" href="coding_8h.html" title="Details of the ccn binary wire encoding.">ccn/coding.h</a>&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;<a class="code" href="indexbuf_8h.html" title="Expandable buffer of non-negative values.">ccn/indexbuf.h</a>&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;<a class="code" href="schedule_8h.html" title="Event scheduling.">ccn/schedule.h</a>&gt;</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="_sync_actions_8h.html" title="Part of CCNx Sync.">SyncActions.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="_sync_node_8h.html" title="Part of CCNx Sync.">SyncNode.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="_sync_private_8h.html" title="Part of CCNx Sync.">SyncPrivate.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="_sync_root_8h.html" title="Part of CCNx Sync.">SyncRoot.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="_sync_tree_worker_8h.html" title="Part of CCNx Sync.">SyncTreeWorker.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="_sync_util_8h.html" title="Part of CCNx Sync.">SyncUtil.h</a>&quot;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a><a class="code" href="_sync_actions_8c.html#a52037c938e3c1b126c6277da5ca689d0">00038</a> <span class="preprocessor">#define M 1000000</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span><span class="comment">// various configuration parameters</span>
<a name="l00040"></a>00040 <span class="comment">// TBD: get them from an external source?</span>
<a name="l00041"></a><a class="code" href="_sync_actions_8c.html#abcf03dd02fc21c497e5f79698025ce11">00041</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="_sync_actions_8c.html#abcf03dd02fc21c497e5f79698025ce11">useCompExcl</a> = 1;             <span class="comment">// governs use of nextcomp exclusion use</span>
<a name="l00042"></a><a class="code" href="_sync_actions_8c.html#ad990ae99fb88eb7b8bb2864dd04a459f">00042</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="_sync_actions_8c.html#ad990ae99fb88eb7b8bb2864dd04a459f">showHighLevel</a> = 1;           <span class="comment">// governs high-level comments</span>
<a name="l00043"></a><a class="code" href="_sync_actions_8c.html#ab72e0532e7d3a1c56b45587dd044ac04">00043</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="_sync_actions_8c.html#ab72e0532e7d3a1c56b45587dd044ac04">nDeltasLimit</a> = 4;            <span class="comment">// limit of deltas objects in chain per root</span>
<a name="l00044"></a><a class="code" href="_sync_actions_8c.html#a6f820954efdf20f00e127de4f5860876">00044</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="_sync_actions_8c.html#a6f820954efdf20f00e127de4f5860876">cachePurgeTrigger</a> = 60;      <span class="comment">// cache entry purge, in seconds</span>
<a name="l00045"></a><a class="code" href="_sync_actions_8c.html#a7e7cfdcf4ab42abb3df14fbae3e8c633">00045</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="_sync_actions_8c.html#a7e7cfdcf4ab42abb3df14fbae3e8c633">cacheCleanBatch</a> = 8;         <span class="comment">// cache clean batch seconds</span>
<a name="l00046"></a><a class="code" href="_sync_actions_8c.html#aa2d8a6bb0c73f1389f5bb385f99403f4">00046</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="_sync_actions_8c.html#aa2d8a6bb0c73f1389f5bb385f99403f4">cacheCleanDelta</a> = 4;         <span class="comment">// cache clean batch seconds</span>
<a name="l00047"></a><a class="code" href="_sync_actions_8c.html#a96ca9c9a78727d3479674cdaa27b56f5">00047</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="_sync_actions_8c.html#a96ca9c9a78727d3479674cdaa27b56f5">adviseNeedReset</a> = 1;         <span class="comment">// reset value for adviseNeed</span>
<a name="l00048"></a><a class="code" href="_sync_actions_8c.html#acfd7bc324565430eec2237e4631ed78e">00048</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="_sync_actions_8c.html#acfd7bc324565430eec2237e4631ed78e">updateStallDelta</a> = 15;       <span class="comment">// seconds used to determine stalled update</span>
<a name="l00049"></a><a class="code" href="_sync_actions_8c.html#aa02c95782f2c18068edaec0a8ae9cd78">00049</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="_sync_actions_8c.html#aa02c95782f2c18068edaec0a8ae9cd78">updateNeedDelta</a> = 6;         <span class="comment">// seconds for adaptive update</span>
<a name="l00050"></a><a class="code" href="_sync_actions_8c.html#a967f58bd9114d0d03f535fb552c89f4f">00050</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="_sync_actions_8c.html#a967f58bd9114d0d03f535fb552c89f4f">fenceSeconds</a> = 2;            <span class="comment">// seconds between setting the fence</span>
<a name="l00051"></a><a class="code" href="_sync_actions_8c.html#a259cad241b04e57ac063e149d3fb511e">00051</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="_sync_actions_8c.html#a259cad241b04e57ac063e149d3fb511e">shortDelayMicros</a> = 1000;     <span class="comment">// short delay for quick reschedule</span>
<a name="l00052"></a><a class="code" href="_sync_actions_8c.html#a4950bbc15af82d9a617aa082cfea552c">00052</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="_sync_actions_8c.html#a4950bbc15af82d9a617aa082cfea552c">compareAssumeBad</a> = 20;       <span class="comment">// secs since last fetch OK to assume compare failed</span>
<a name="l00053"></a><a class="code" href="_sync_actions_8c.html#ad6e384ed8d6687203b96177c4425df08">00053</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="_sync_actions_8c.html#ad6e384ed8d6687203b96177c4425df08">nodeSplitTrigger</a> = 4000;     <span class="comment">// in bytes, triggers node split</span>
<a name="l00054"></a><a class="code" href="_sync_actions_8c.html#a81327fc9c584dac59986ec3725d2cd77">00054</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="_sync_actions_8c.html#a81327fc9c584dac59986ec3725d2cd77">hashSplitTrigger</a> = 17;       <span class="comment">// trigger for splitting based on hash (n/255)</span>
<a name="l00055"></a><a class="code" href="_sync_actions_8c.html#ad6ea5755329f76c1602ad6ba25a27daf">00055</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="_sync_actions_8c.html#ad6ea5755329f76c1602ad6ba25a27daf">namesYieldInc</a> = 100;         <span class="comment">// number of names to inc between yield tests</span>
<a name="l00056"></a><a class="code" href="_sync_actions_8c.html#a01f91d5802d6020d15662f4afea91e9f">00056</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="_sync_actions_8c.html#a01f91d5802d6020d15662f4afea91e9f">namesYieldMicros</a> = 20*1000;  <span class="comment">// number of micros to use as yield trigger</span>
<a name="l00057"></a>00057 
<a name="l00058"></a><a class="code" href="_sync_actions_8c.html#ad12cf4a0550d67730e5d830dfe78babb">00058</a> <span class="preprocessor">#define SYNC_UPDATE_VERSION (20120307)</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span>
<a name="l00060"></a><a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767">00060</a> <span class="keyword">enum</span> <a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767">SyncCompareState</a> {
<a name="l00061"></a><a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767aea4e7487ab4ca7505378434b0cc96e77">00061</a>     <a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767aea4e7487ab4ca7505378434b0cc96e77">SyncCompare_init</a>,
<a name="l00062"></a><a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767a13fe7db0510e8011214f3e4156c55f0f">00062</a>     <a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767a13fe7db0510e8011214f3e4156c55f0f">SyncCompare_preload</a>,
<a name="l00063"></a><a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767a167f902359266f6b85bd0cf3fc4e55d6">00063</a>     <a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767a167f902359266f6b85bd0cf3fc4e55d6">SyncCompare_busy</a>,
<a name="l00064"></a><a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767a0af8ae16c6d77b372a710583dd92aa50">00064</a>     <a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767a0af8ae16c6d77b372a710583dd92aa50">SyncCompare_waiting</a>,
<a name="l00065"></a><a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767aeb531ecb7a38ab9a97cb60e31646b3fc">00065</a>     <a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767aeb531ecb7a38ab9a97cb60e31646b3fc">SyncCompare_done</a>
<a name="l00066"></a>00066 };
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="keyword">struct </span>SyncCompareData {
<a name="l00069"></a>00069     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root;    <span class="comment">/**&lt; parent root for this comparison */</span>
<a name="l00070"></a>00070     <span class="keyword">struct </span><a class="code" href="struct_sync_tree_worker_head.html">SyncTreeWorkerHead</a> *twL; <span class="comment">/**&lt; local tree walker state */</span>
<a name="l00071"></a>00071     <span class="keyword">struct </span><a class="code" href="struct_sync_tree_worker_head.html">SyncTreeWorkerHead</a> *twR; <span class="comment">/**&lt; remote tree walker state */</span>
<a name="l00072"></a>00072     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *hashL;      <span class="comment">/**&lt; hash for root of local sync tree */</span>
<a name="l00073"></a>00073     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *hashR;      <span class="comment">/**&lt; hash for root of remote sync tree */</span>
<a name="l00074"></a>00074     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *cbL;        <span class="comment">/**&lt; local tree scratch */</span>
<a name="l00075"></a>00075     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *cbR;        <span class="comment">/**&lt; remote tree scratch */</span>
<a name="l00076"></a>00076     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *lagL;       <span class="comment">/**&lt; local lag name */</span>
<a name="l00077"></a>00077     <span class="keywordtype">int</span> *lagMatch;                  <span class="comment">/**&lt; lagging # of matching components */</span>
<a name="l00078"></a>00078     <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *errList; <span class="comment">/**&lt; actions that had errors for this compare */</span>
<a name="l00079"></a>00079     <span class="keywordtype">int</span> errsQueued;                 <span class="comment">/**&lt; names added during this comparison */</span>
<a name="l00080"></a>00080     <span class="keywordtype">int</span> namesAdded;                 <span class="comment">/**&lt; names added during this comparison */</span>
<a name="l00081"></a>00081     <span class="keywordtype">int</span> nodeFetchBusy;              <span class="comment">/**&lt; number of busy remote node fetches */</span>
<a name="l00082"></a>00082     <span class="keywordtype">int</span> nodeFetchFailed;            <span class="comment">/**&lt; number of failed remote node fetches */</span>
<a name="l00083"></a>00083     <span class="keywordtype">int</span> contentPos;                 <span class="comment">/**&lt; position of next content to fetch */</span>
<a name="l00084"></a>00084     <span class="keywordtype">int</span> contentFetchBusy;           <span class="comment">/**&lt; number of busy content fetches */</span>
<a name="l00085"></a>00085     <span class="keywordtype">int</span> contentFetchFailed;         <span class="comment">/**&lt; number of failed content fetches */</span>
<a name="l00086"></a>00086     <span class="keyword">struct </span><a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev; <span class="comment">/**&lt; progress event */</span>
<a name="l00087"></a>00087     <span class="keyword">enum</span> <a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767">SyncCompareState</a> state;    <span class="comment">/**&lt; summary state of comparison */</span>
<a name="l00088"></a>00088     int64_t lastFetchOK;          <span class="comment">/**&lt; time marker for last successul node/content fetch */</span>
<a name="l00089"></a>00089     int64_t startTime;            <span class="comment">/**&lt; time marker for compare data creation */</span>
<a name="l00090"></a>00090     int64_t lastEnter;            <span class="comment">/**&lt; time marker for last compare step entry */</span>
<a name="l00091"></a>00091     int64_t lastMark;             <span class="comment">/**&lt; time marker for stall determination */</span>
<a name="l00092"></a>00092     int64_t maxHold;                <span class="comment">/**&lt; max time thread was held by compare */</span>
<a name="l00093"></a>00093 };
<a name="l00094"></a>00094 
<a name="l00095"></a><a class="code" href="_sync_actions_8c.html#aa6cc1c7877f35a7df1951c989f371e90">00095</a> <span class="keyword">enum</span> <a class="code" href="_sync_actions_8c.html#aa6cc1c7877f35a7df1951c989f371e90">SyncUpdateState</a> {
<a name="l00096"></a><a class="code" href="_sync_actions_8c.html#aa6cc1c7877f35a7df1951c989f371e90aec69f28641f92a3fd6b9451380718992">00096</a>     <a class="code" href="_sync_actions_8c.html#aa6cc1c7877f35a7df1951c989f371e90aec69f28641f92a3fd6b9451380718992">SyncUpdate_init</a>,
<a name="l00097"></a><a class="code" href="_sync_actions_8c.html#aa6cc1c7877f35a7df1951c989f371e90acfbd019b329059114ff86b166111ea52">00097</a>     <a class="code" href="_sync_actions_8c.html#aa6cc1c7877f35a7df1951c989f371e90acfbd019b329059114ff86b166111ea52">SyncUpdate_inserted</a>,
<a name="l00098"></a><a class="code" href="_sync_actions_8c.html#aa6cc1c7877f35a7df1951c989f371e90a43d2e9c591ba0aee21329a369e1c2f5d">00098</a>     <a class="code" href="_sync_actions_8c.html#aa6cc1c7877f35a7df1951c989f371e90a43d2e9c591ba0aee21329a369e1c2f5d">SyncUpdate_busy</a>,
<a name="l00099"></a><a class="code" href="_sync_actions_8c.html#aa6cc1c7877f35a7df1951c989f371e90a5f6d060a88470dcc1e7c3cb11c63a9d2">00099</a>     <a class="code" href="_sync_actions_8c.html#aa6cc1c7877f35a7df1951c989f371e90a5f6d060a88470dcc1e7c3cb11c63a9d2">SyncUpdate_error</a>,
<a name="l00100"></a><a class="code" href="_sync_actions_8c.html#aa6cc1c7877f35a7df1951c989f371e90aa419e6f00b85f158b4bdd84a1066b8f4">00100</a>     <a class="code" href="_sync_actions_8c.html#aa6cc1c7877f35a7df1951c989f371e90aa419e6f00b85f158b4bdd84a1066b8f4">SyncUpdate_done</a>
<a name="l00101"></a>00101 };
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 <span class="keyword">struct </span>SyncUpdateData {
<a name="l00104"></a>00104     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root;
<a name="l00105"></a>00105     <span class="keyword">enum</span> <a class="code" href="_sync_actions_8c.html#aa6cc1c7877f35a7df1951c989f371e90">SyncUpdateState</a> state;
<a name="l00106"></a>00106     <span class="keyword">struct </span><a class="code" href="struct_sync_name_accum.html">SyncNameAccum</a> *sort;
<a name="l00107"></a>00107     <span class="keyword">struct </span><a class="code" href="struct_sync_node_accum.html">SyncNodeAccum</a> *nodes;
<a name="l00108"></a>00108     <span class="keyword">struct </span><a class="code" href="struct_sync_tree_worker_head.html">SyncTreeWorkerHead</a> *tw;
<a name="l00109"></a>00109     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *cb;
<a name="l00110"></a>00110     <a class="code" href="struct_index_sorter___struct.html">IndexSorter_Base</a> ixBase;
<a name="l00111"></a>00111     <a class="code" href="_index_sorter_8h.html#a0a81cac7637bf5c4fcbe34ededd138ae">IndexSorter_Index</a> ixPos;
<a name="l00112"></a>00112     <span class="keywordtype">int</span> nameLenAccum;
<a name="l00113"></a>00113     <span class="keywordtype">int</span> namesAdded;
<a name="l00114"></a>00114     <span class="keywordtype">int</span> initLen;
<a name="l00115"></a>00115     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceStart; <span class="comment">/*&lt; entry for start hash (may be NULL) */</span>
<a name="l00116"></a>00116     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceStop;  <span class="comment">/*&lt; entry for end hash */</span>
<a name="l00117"></a>00117     int64_t startTime;
<a name="l00118"></a>00118     int64_t entryTime;
<a name="l00119"></a>00119     int64_t maxHold;
<a name="l00120"></a>00120     <span class="keywordtype">int</span> preSortCount;
<a name="l00121"></a>00121     <span class="keywordtype">int</span> postSortCount;
<a name="l00122"></a>00122     <span class="keyword">struct </span><a class="code" href="struct_sync_root_deltas.html">SyncRootDeltas</a> *deltas;
<a name="l00123"></a>00123 };
<a name="l00124"></a>00124 <span class="comment"></span>
<a name="l00125"></a>00125 <span class="comment">///////////////////////////////////////////////////////////////////////////</span>
<a name="l00126"></a>00126 <span class="comment">///// Forward procedure declarations</span>
<a name="l00127"></a>00127 <span class="comment">///////////////////////////////////////////////////////////////////////////</span>
<a name="l00128"></a>00128 <span class="comment"></span>
<a name="l00129"></a>00129 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00130"></a>00130 <a class="code" href="_sync_actions_8c.html#a4758fead9a41b25c3856d0a86f308682">HeartbeatAction</a>(<span class="keyword">struct</span> ccn_schedule *sched,
<a name="l00131"></a>00131                 <span class="keywordtype">void</span> *clienth,
<a name="l00132"></a>00132                 <span class="keyword">struct</span> <a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev,
<a name="l00133"></a>00133                 <span class="keywordtype">int</span> flags);
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00136"></a>00136 <a class="code" href="_sync_actions_8c.html#a1c708bcddeda324dbc2f5dc27376d251">UpdateAction</a>(<span class="keyword">struct</span> ccn_schedule *sched,
<a name="l00137"></a>00137              <span class="keywordtype">void</span> *clienth,
<a name="l00138"></a>00138              <span class="keyword">struct</span> <a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev,
<a name="l00139"></a>00139              <span class="keywordtype">int</span> flags);
<a name="l00140"></a>00140 
<a name="l00141"></a>00141 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00142"></a>00142 <a class="code" href="_sync_actions_8c.html#a9489e03537895943d0ffdbd6378c13d2">CompareAction</a>(<span class="keyword">struct</span> ccn_schedule *sched,
<a name="l00143"></a>00143               <span class="keywordtype">void</span> *clienth,
<a name="l00144"></a>00144               <span class="keyword">struct</span> <a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev,
<a name="l00145"></a>00145               <span class="keywordtype">int</span> flags);
<a name="l00146"></a>00146 
<a name="l00147"></a>00147 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00148"></a>00148 <a class="code" href="_sync_actions_8c.html#ac59cbfbac45ae18f43a1bed7d1c6a8ce">SyncUpdateRoot</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root);
<a name="l00149"></a>00149 
<a name="l00150"></a>00150 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00151"></a>00151 <a class="code" href="_sync_actions_8c.html#a883ea40ef1982edd049f48944662a933">SyncSendRootAdviseInterest</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root);
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00154"></a>00154 <a class="code" href="_sync_actions_8c.html#ac35071e0f9bf12dcd5d9b37f36463a79">SyncStartCompareAction</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root, <span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *hashR);
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00157"></a>00157 <a class="code" href="_sync_actions_8c.html#a834f23cf4596b1ef8013a972558f936c">SyncRegisterInterests</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root);
<a name="l00158"></a>00158 <span class="comment"></span>
<a name="l00159"></a>00159 <span class="comment">///////////////////////////////////////////////////////////////////////////</span>
<a name="l00160"></a>00160 <span class="comment">///// General internal routines</span>
<a name="l00161"></a>00161 <span class="comment">///////////////////////////////////////////////////////////////////////////</span>
<a name="l00162"></a>00162 <span class="comment"></span>
<a name="l00163"></a>00163 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00164"></a><a class="code" href="_sync_actions_8c.html#acdda024c6e7c4bdd33219b0dbd62fddf">00164</a> <a class="code" href="_sync_actions_8c.html#acdda024c6e7c4bdd33219b0dbd62fddf">showCacheEntry</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root, <span class="keywordtype">char</span> *dst, <span class="keywordtype">int</span> lim,
<a name="l00165"></a>00165                <span class="keywordtype">char</span> *prefix, <span class="keyword">struct</span> <a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce) {
<a name="l00166"></a>00166     <span class="keywordtype">int</span> n = 0;
<a name="l00167"></a>00167     <span class="keywordflow">if</span> (ce == NULL) n = snprintf(dst, lim, <span class="stringliteral">&quot;%shash#null&quot;</span>, prefix);
<a name="l00168"></a>00168     <span class="keywordflow">else</span> n = snprintf(dst, lim, <span class="stringliteral">&quot;%shash#%08x&quot;</span>, prefix, (uint32_t) ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a875dcf9fba72d3d3d8da0e8266ada7de" title="the small hash">small</a>);
<a name="l00169"></a>00169     <span class="keywordflow">return</span> n;
<a name="l00170"></a>00170 }
<a name="l00171"></a>00171 
<a name="l00172"></a>00172 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00173"></a><a class="code" href="_sync_actions_8c.html#a677c4508262ab00cdea51b16065eac17">00173</a> <a class="code" href="_sync_actions_8c.html#a677c4508262ab00cdea51b16065eac17">showCacheEntry1</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root, <span class="keywordtype">char</span> *here, <span class="keywordtype">char</span> *msg,
<a name="l00174"></a>00174                 <span class="keyword">struct</span> <a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce) {
<a name="l00175"></a>00175     <span class="keywordtype">char</span> temp[1024];
<a name="l00176"></a>00176     <a class="code" href="_sync_actions_8c.html#acdda024c6e7c4bdd33219b0dbd62fddf">showCacheEntry</a>(root, temp, <span class="keyword">sizeof</span>(temp), <span class="stringliteral">&quot;&quot;</span>, ce);
<a name="l00177"></a>00177     <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, msg, temp);
<a name="l00178"></a>00178 }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00181"></a><a class="code" href="_sync_actions_8c.html#a693571491e7f8b307640238175b6aa57">00181</a> <a class="code" href="_sync_actions_8c.html#a693571491e7f8b307640238175b6aa57">showCacheEntry2</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root, <span class="keywordtype">char</span> *here, <span class="keywordtype">char</span> *msg,
<a name="l00182"></a>00182                 <span class="keyword">struct</span> <a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce1, <span class="keyword">struct</span> <a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce2) {
<a name="l00183"></a>00183     <span class="keywordtype">char</span> temp[1024];
<a name="l00184"></a>00184     <span class="keywordtype">int</span> n = <a class="code" href="_sync_actions_8c.html#acdda024c6e7c4bdd33219b0dbd62fddf">showCacheEntry</a>(root, temp, <span class="keyword">sizeof</span>(temp), <span class="stringliteral">&quot;&quot;</span>, ce1);
<a name="l00185"></a>00185     <a class="code" href="_sync_actions_8c.html#acdda024c6e7c4bdd33219b0dbd62fddf">showCacheEntry</a>(root, temp+n, <span class="keyword">sizeof</span>(temp)-n, <span class="stringliteral">&quot;, &quot;</span>, ce2);
<a name="l00186"></a>00186     <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, msg, temp);
<a name="l00187"></a>00187 }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *
<a name="l00190"></a><a class="code" href="_sync_actions_8c.html#a16e2f339bd3d0141bdc0fbf8a128ff26">00190</a> <a class="code" href="_sync_actions_8c.html#a16e2f339bd3d0141bdc0fbf8a128ff26">newActionData</a>(<span class="keyword">enum</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692">SyncRegisterActionKind</a> <a class="code" href="struct_sync_action_data.html#ad64d193a1ef56426675d4042263da5c5">kind</a>) {
<a name="l00191"></a>00191     <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *data = <a class="code" href="_sync_macros_8h.html#ab707d3cfcb52f2e2f819771123942548">NEW_STRUCT</a>(1, <a class="code" href="struct_sync_action_data.html">SyncActionData</a>);
<a name="l00192"></a>00192     data-&gt;<a class="code" href="struct_sync_action_data.html#a79f3e380339ba613e01440cf2b6611fc">startTime</a> = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l00193"></a>00193     data-&gt;<a class="code" href="struct_sync_action_data.html#ad64d193a1ef56426675d4042263da5c5">kind</a> = kind;
<a name="l00194"></a>00194     data-&gt;<a class="code" href="struct_sync_action_data.html#ab5d23823af742d60d39bd922aaef5ba2">state</a> = <a class="code" href="_sync_actions_8h.html#a2372ce16c57f6d11f0da968c3156350bad9b5f2926a39c011f73cafe7ee6adab0">SyncActionState_init</a>;
<a name="l00195"></a>00195     <span class="keywordflow">return</span> data;
<a name="l00196"></a>00196 }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00199"></a><a class="code" href="_sync_actions_8c.html#a95080bffa712dcfdea59f2fe0affd18b">00199</a> <a class="code" href="_sync_actions_8c.html#a95080bffa712dcfdea59f2fe0affd18b">linkActionData</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *<a class="code" href="struct_sync_action_data.html#aec2fc78ddb23d1c2bc5f51841e4a1b07">root</a>, <span class="keyword">struct</span> <a class="code" href="struct_sync_action_data.html">SyncActionData</a> *data) {
<a name="l00200"></a>00200     data-&gt;<a class="code" href="struct_sync_action_data.html#aec2fc78ddb23d1c2bc5f51841e4a1b07">root</a> = root;
<a name="l00201"></a>00201     data-&gt;<a class="code" href="struct_sync_action_data.html#ae7913dd2b3df8180192935b705b38684">ce</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#abe335cfe4efd3e95c6fd099835d4baf9">ceCurrent</a>;
<a name="l00202"></a>00202     data-&gt;<a class="code" href="struct_sync_action_data.html#ae24e9863185867798652ec7429afb2c0">next</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#a17d4b18dfe2d8907b5fe1715699cb353" title="data for pending interests">actions</a>;
<a name="l00203"></a>00203     data-&gt;<a class="code" href="struct_sync_action_data.html#ab5d23823af742d60d39bd922aaef5ba2">state</a> = <a class="code" href="_sync_actions_8h.html#a2372ce16c57f6d11f0da968c3156350bafe49035eaf96149f83ee607ed18ec38a">SyncActionState_sent</a>;
<a name="l00204"></a>00204     root-&gt;<a class="code" href="struct_sync_root_struct.html#a17d4b18dfe2d8907b5fe1715699cb353" title="data for pending interests">actions</a> = data;
<a name="l00205"></a>00205 }
<a name="l00206"></a>00206 
<a name="l00207"></a>00207 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00208"></a><a class="code" href="_sync_actions_8c.html#a8fe1475d430cd709f611343f55b17d94">00208</a> <a class="code" href="_sync_actions_8c.html#a8fe1475d430cd709f611343f55b17d94">delinkActionData</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_action_data.html">SyncActionData</a> *data) {
<a name="l00209"></a>00209     <span class="keywordflow">if</span> (data == NULL) <span class="keywordflow">return</span>;
<a name="l00210"></a>00210     <span class="keywordflow">if</span> (data-&gt;<a class="code" href="struct_sync_action_data.html#ab5d23823af742d60d39bd922aaef5ba2">state</a> == <a class="code" href="_sync_actions_8h.html#a2372ce16c57f6d11f0da968c3156350bafe49035eaf96149f83ee607ed18ec38a">SyncActionState_sent</a>) {
<a name="l00211"></a>00211         <span class="comment">// remove from the action chain in the root</span>
<a name="l00212"></a>00212         <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = data-&gt;<a class="code" href="struct_sync_action_data.html#aec2fc78ddb23d1c2bc5f51841e4a1b07">root</a>;
<a name="l00213"></a>00213         <span class="keywordflow">if</span> (root == NULL) <span class="keywordflow">return</span>;
<a name="l00214"></a>00214         <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *each = root-&gt;<a class="code" href="struct_sync_root_struct.html#a17d4b18dfe2d8907b5fe1715699cb353" title="data for pending interests">actions</a>;
<a name="l00215"></a>00215         <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *lag = NULL;
<a name="l00216"></a>00216         data-&gt;<a class="code" href="struct_sync_action_data.html#ab5d23823af742d60d39bd922aaef5ba2">state</a> = <a class="code" href="_sync_actions_8h.html#a2372ce16c57f6d11f0da968c3156350ba7e6ad7a29a249b172b7065640f6a452f">SyncActionState_loose</a>;
<a name="l00217"></a>00217         <span class="keywordflow">while</span> (each != NULL) {
<a name="l00218"></a>00218             <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *<a class="code" href="struct_sync_action_data.html#ae24e9863185867798652ec7429afb2c0">next</a> = each-&gt;<a class="code" href="struct_sync_action_data.html#ae24e9863185867798652ec7429afb2c0">next</a>;
<a name="l00219"></a>00219             <span class="keywordflow">if</span> (data == each) {
<a name="l00220"></a>00220                 data-&gt;<a class="code" href="struct_sync_action_data.html#ae24e9863185867798652ec7429afb2c0">next</a> = NULL;
<a name="l00221"></a>00221                 <span class="keywordflow">if</span> (lag == NULL) root-&gt;<a class="code" href="struct_sync_root_struct.html#a17d4b18dfe2d8907b5fe1715699cb353" title="data for pending interests">actions</a> = next;
<a name="l00222"></a>00222                 <span class="keywordflow">else</span> lag-&gt;<a class="code" href="struct_sync_action_data.html#ae24e9863185867798652ec7429afb2c0">next</a> = next;
<a name="l00223"></a>00223                 <span class="keywordflow">break</span>;
<a name="l00224"></a>00224             }
<a name="l00225"></a>00225             lag = each;
<a name="l00226"></a>00226             each = next;
<a name="l00227"></a>00227         }
<a name="l00228"></a>00228     } <span class="keywordflow">else</span> {
<a name="l00229"></a>00229         <span class="keywordflow">if</span> (data-&gt;<a class="code" href="struct_sync_action_data.html#ab5d23823af742d60d39bd922aaef5ba2">state</a> == <a class="code" href="_sync_actions_8h.html#a2372ce16c57f6d11f0da968c3156350baff5b24fc2a58337eb7579685348aebc9">SyncActionState_error</a>) {
<a name="l00230"></a>00230             <span class="comment">// remove from the errList chain in the comparison</span>
<a name="l00231"></a>00231             <span class="keyword">struct </span>SyncCompareData *comp = data-&gt;<a class="code" href="struct_sync_action_data.html#afcaa4a02f141595e243f1be8ff79a3d5">comp</a>;
<a name="l00232"></a>00232             <span class="keywordflow">if</span> (comp == NULL) <span class="keywordflow">return</span>;
<a name="l00233"></a>00233             <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *each = comp-&gt;errList;
<a name="l00234"></a>00234             <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *lag = NULL;
<a name="l00235"></a>00235             data-&gt;<a class="code" href="struct_sync_action_data.html#ab5d23823af742d60d39bd922aaef5ba2">state</a> = <a class="code" href="_sync_actions_8h.html#a2372ce16c57f6d11f0da968c3156350ba7e6ad7a29a249b172b7065640f6a452f">SyncActionState_loose</a>;
<a name="l00236"></a>00236             <span class="keywordflow">while</span> (each != NULL) {
<a name="l00237"></a>00237                 <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *<a class="code" href="struct_sync_action_data.html#ae24e9863185867798652ec7429afb2c0">next</a> = each-&gt;<a class="code" href="struct_sync_action_data.html#ae24e9863185867798652ec7429afb2c0">next</a>;
<a name="l00238"></a>00238                 <span class="keywordflow">if</span> (data == each) {
<a name="l00239"></a>00239                     data-&gt;<a class="code" href="struct_sync_action_data.html#ae24e9863185867798652ec7429afb2c0">next</a> = NULL;
<a name="l00240"></a>00240                     <span class="keywordflow">if</span> (comp-&gt;errsQueued &gt; 0) comp-&gt;errsQueued--;
<a name="l00241"></a>00241                     <span class="keywordflow">if</span> (lag == NULL) comp-&gt;errList = next;
<a name="l00242"></a>00242                     <span class="keywordflow">else</span> lag-&gt;<a class="code" href="struct_sync_action_data.html#ae24e9863185867798652ec7429afb2c0">next</a> = next;
<a name="l00243"></a>00243                     <span class="keywordflow">break</span>;
<a name="l00244"></a>00244                 }
<a name="l00245"></a>00245                 lag = each;
<a name="l00246"></a>00246                 each = next;
<a name="l00247"></a>00247             }
<a name="l00248"></a>00248         }
<a name="l00249"></a>00249     }
<a name="l00250"></a>00250 }
<a name="l00251"></a>00251 
<a name="l00252"></a>00252 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00253"></a><a class="code" href="_sync_actions_8c.html#a322cb98032f017f439ac04b1df79627b">00253</a> <a class="code" href="_sync_actions_8c.html#a322cb98032f017f439ac04b1df79627b">moveActionData</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_action_data.html">SyncActionData</a> *data, <span class="keyword">enum</span> <a class="code" href="_sync_actions_8h.html#a2372ce16c57f6d11f0da968c3156350b">SyncActionState</a> dstState) {
<a name="l00254"></a>00254     <span class="comment">// moves the action data to the given state queue</span>
<a name="l00255"></a>00255     <span class="comment">// (must be SyncActionState_sent or SyncActionState_error)</span>
<a name="l00256"></a>00256     <span class="comment">// returns 1 for success, 0 for not possible</span>
<a name="l00257"></a>00257     <span class="keywordflow">if</span> (data == NULL) <span class="keywordflow">return</span> 0;
<a name="l00258"></a>00258     <span class="keywordflow">if</span> (dstState == <a class="code" href="_sync_actions_8h.html#a2372ce16c57f6d11f0da968c3156350baff5b24fc2a58337eb7579685348aebc9">SyncActionState_error</a> &amp;&amp; data-&gt;<a class="code" href="struct_sync_action_data.html#ab5d23823af742d60d39bd922aaef5ba2">state</a> != <a class="code" href="_sync_actions_8h.html#a2372ce16c57f6d11f0da968c3156350bafe49035eaf96149f83ee607ed18ec38a">SyncActionState_sent</a>)
<a name="l00259"></a>00259         <span class="keywordflow">return</span> 0;
<a name="l00260"></a>00260     <span class="keywordflow">if</span> (dstState == <a class="code" href="_sync_actions_8h.html#a2372ce16c57f6d11f0da968c3156350bafe49035eaf96149f83ee607ed18ec38a">SyncActionState_sent</a> &amp;&amp; data-&gt;<a class="code" href="struct_sync_action_data.html#ab5d23823af742d60d39bd922aaef5ba2">state</a> != <a class="code" href="_sync_actions_8h.html#a2372ce16c57f6d11f0da968c3156350baff5b24fc2a58337eb7579685348aebc9">SyncActionState_error</a>)
<a name="l00261"></a>00261         <span class="keywordflow">return</span> 0;
<a name="l00262"></a>00262     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = data-&gt;<a class="code" href="struct_sync_action_data.html#aec2fc78ddb23d1c2bc5f51841e4a1b07">root</a>;
<a name="l00263"></a>00263     <span class="keyword">struct </span>SyncCompareData *comp = data-&gt;<a class="code" href="struct_sync_action_data.html#afcaa4a02f141595e243f1be8ff79a3d5">comp</a>;
<a name="l00264"></a>00264     <span class="keywordflow">if</span> (root == NULL || comp == NULL) <span class="keywordflow">return</span> 0;
<a name="l00265"></a>00265     <a class="code" href="_sync_actions_8c.html#a8fe1475d430cd709f611343f55b17d94">delinkActionData</a>(data);
<a name="l00266"></a>00266     <span class="keywordflow">if</span> (dstState == <a class="code" href="_sync_actions_8h.html#a2372ce16c57f6d11f0da968c3156350bafe49035eaf96149f83ee607ed18ec38a">SyncActionState_sent</a>) {
<a name="l00267"></a>00267         data-&gt;<a class="code" href="struct_sync_action_data.html#ae24e9863185867798652ec7429afb2c0">next</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#a17d4b18dfe2d8907b5fe1715699cb353" title="data for pending interests">actions</a>;
<a name="l00268"></a>00268         root-&gt;<a class="code" href="struct_sync_root_struct.html#a17d4b18dfe2d8907b5fe1715699cb353" title="data for pending interests">actions</a> = data;
<a name="l00269"></a>00269     } <span class="keywordflow">else</span> {
<a name="l00270"></a>00270         data-&gt;<a class="code" href="struct_sync_action_data.html#ae24e9863185867798652ec7429afb2c0">next</a> = comp-&gt;errList;
<a name="l00271"></a>00271         comp-&gt;errList = data;
<a name="l00272"></a>00272         comp-&gt;errsQueued++;
<a name="l00273"></a>00273     }
<a name="l00274"></a>00274     data-&gt;<a class="code" href="struct_sync_action_data.html#ab5d23823af742d60d39bd922aaef5ba2">state</a> = dstState;
<a name="l00275"></a>00275     <span class="keywordflow">return</span> 1;
<a name="l00276"></a>00276 }
<a name="l00277"></a>00277 
<a name="l00278"></a>00278 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *
<a name="l00279"></a><a class="code" href="_sync_actions_8c.html#a9826ac9a64ba2f80ef24985bee419929">00279</a> <a class="code" href="_sync_actions_8c.html#a9826ac9a64ba2f80ef24985bee419929">destroyActionData</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_action_data.html">SyncActionData</a> *data) {
<a name="l00280"></a>00280     <span class="keywordflow">if</span> (data != NULL) {
<a name="l00281"></a>00281         <a class="code" href="_sync_actions_8c.html#a8fe1475d430cd709f611343f55b17d94">delinkActionData</a>(data);
<a name="l00282"></a>00282         <span class="comment">// remove any resources</span>
<a name="l00283"></a>00283         <span class="keywordflow">if</span> (data-&gt;<a class="code" href="struct_sync_action_data.html#a74202828f01407a2254b56ba73bdfd23">prefix</a> != NULL)
<a name="l00284"></a>00284             <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;data-&gt;<a class="code" href="struct_sync_action_data.html#a74202828f01407a2254b56ba73bdfd23">prefix</a>);
<a name="l00285"></a>00285         <span class="keywordflow">if</span> (data-&gt;<a class="code" href="struct_sync_action_data.html#af8df0a4ba0bd30cd13c1976985e8d7f1">hash</a> != NULL)
<a name="l00286"></a>00286             <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;data-&gt;<a class="code" href="struct_sync_action_data.html#af8df0a4ba0bd30cd13c1976985e8d7f1">hash</a>);
<a name="l00287"></a>00287         data-&gt;<a class="code" href="struct_sync_action_data.html#ae24e9863185867798652ec7429afb2c0">next</a> = NULL;
<a name="l00288"></a>00288         data-&gt;<a class="code" href="struct_sync_action_data.html#aec2fc78ddb23d1c2bc5f51841e4a1b07">root</a> = NULL;
<a name="l00289"></a>00289         data-&gt;<a class="code" href="struct_sync_action_data.html#afcaa4a02f141595e243f1be8ff79a3d5">comp</a> = NULL;
<a name="l00290"></a>00290         free(data);
<a name="l00291"></a>00291     }
<a name="l00292"></a>00292     <span class="keywordflow">return</span> NULL;
<a name="l00293"></a>00293 }
<a name="l00294"></a>00294 
<a name="l00295"></a>00295 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l00296"></a><a class="code" href="_sync_actions_8c.html#a25e9755894d555e4e08d8af7b61e91ae">00296</a> <a class="code" href="_sync_actions_8c.html#a25e9755894d555e4e08d8af7b61e91ae">getCmdStr</a>(<span class="keyword">enum</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692">SyncRegisterActionKind</a> <a class="code" href="struct_sync_action_data.html#ad64d193a1ef56426675d4042263da5c5">kind</a>) {
<a name="l00297"></a>00297     <span class="keywordflow">switch</span> (kind) {
<a name="l00298"></a>00298         <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692a39c856787f4097f1f34c1827c24358b2" title="root advise handler">SRI_Kind_AdviseInt</a>:
<a name="l00299"></a>00299         <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692a8e4c22d4ecccb39943c4a3ebaa6ea0e2" title="root advise request">SRI_Kind_RootAdvise</a>:
<a name="l00300"></a>00300             <span class="keywordflow">return</span> <span class="stringliteral">&quot;\xC1.S.ra&quot;</span>;
<a name="l00301"></a>00301         <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692acb00b1720ed5338efebdba3809611d17" title="node fetch handler">SRI_Kind_FetchInt</a>:
<a name="l00302"></a>00302         <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692ab2b6e276363d6bbb97dbbe40b695006b" title="node fetch request">SRI_Kind_NodeFetch</a>:
<a name="l00303"></a>00303             <span class="keywordflow">return</span> <span class="stringliteral">&quot;\xC1.S.nf&quot;</span>;
<a name="l00304"></a>00304         <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692ae4c4b5fac43e82b5de019d17decbfa99" title="root stats request">SRI_Kind_RootStats</a>:
<a name="l00305"></a>00305             <span class="keywordflow">return</span> <span class="stringliteral">&quot;\xC1.S.rs&quot;</span>;
<a name="l00306"></a>00306         <span class="keywordflow">default</span>:
<a name="l00307"></a>00307             <span class="keywordflow">return</span> NULL;
<a name="l00308"></a>00308     }
<a name="l00309"></a>00309 }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l00312"></a><a class="code" href="_sync_actions_8c.html#a2e45b34bf59d445273e73ab77c39eef0">00312</a> <a class="code" href="_sync_actions_8c.html#a2e45b34bf59d445273e73ab77c39eef0">getKindStr</a>(<span class="keyword">enum</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692">SyncRegisterActionKind</a> <a class="code" href="struct_sync_action_data.html#ad64d193a1ef56426675d4042263da5c5">kind</a>) {
<a name="l00313"></a>00313     <span class="keywordflow">switch</span> (kind) {
<a name="l00314"></a>00314         <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692a7640d722dadf2853d6ea27eda0e8d3ef">SRI_Kind_None</a>:
<a name="l00315"></a>00315             <span class="keywordflow">return</span> <span class="stringliteral">&quot;None&quot;</span>;
<a name="l00316"></a>00316         <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692a39c856787f4097f1f34c1827c24358b2" title="root advise handler">SRI_Kind_AdviseInt</a>:
<a name="l00317"></a>00317         <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692a8e4c22d4ecccb39943c4a3ebaa6ea0e2" title="root advise request">SRI_Kind_RootAdvise</a>:
<a name="l00318"></a>00318             <span class="keywordflow">return</span> <span class="stringliteral">&quot;RootAdvise&quot;</span>;
<a name="l00319"></a>00319         <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692acb00b1720ed5338efebdba3809611d17" title="node fetch handler">SRI_Kind_FetchInt</a>:
<a name="l00320"></a>00320         <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692ab2b6e276363d6bbb97dbbe40b695006b" title="node fetch request">SRI_Kind_NodeFetch</a>:
<a name="l00321"></a>00321             <span class="keywordflow">return</span> <span class="stringliteral">&quot;NodeFetch&quot;</span>;
<a name="l00322"></a>00322         <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692ae4c4b5fac43e82b5de019d17decbfa99" title="root stats request">SRI_Kind_RootStats</a>:
<a name="l00323"></a>00323             <span class="keywordflow">return</span> <span class="stringliteral">&quot;RootStats&quot;</span>;
<a name="l00324"></a>00324         <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692a88e2022363f5e282355841039623cf19" title="general content">SRI_Kind_Content</a>:
<a name="l00325"></a>00325             <span class="keywordflow">return</span> <span class="stringliteral">&quot;Content&quot;</span>;
<a name="l00326"></a>00326         <span class="keywordflow">default</span>:
<a name="l00327"></a>00327             <span class="keywordflow">return</span> NULL;
<a name="l00328"></a>00328     }
<a name="l00329"></a>00329 }
<a name="l00330"></a>00330 
<a name="l00331"></a>00331 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00332"></a><a class="code" href="_sync_actions_8c.html#a8d981d346c90e43d3f8d9e52077e28ca">00332</a> <a class="code" href="_sync_actions_8c.html#a8d981d346c90e43d3f8d9e52077e28ca">setCovered</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *<a class="code" href="struct_sync_action_data.html#ae7913dd2b3df8180192935b705b38684">ce</a>) {
<a name="l00333"></a>00333     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.setCovered&quot;</span>;
<a name="l00334"></a>00334     <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381ae306c2dc55f40bf7e12c45acaf8d7a26" title="remote hash known covered by the local root">SyncHashState_covered</a>) {
<a name="l00335"></a>00335         <span class="comment">// nothing to do, already covered</span>
<a name="l00336"></a>00336     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381aec73ed0d374163f11f2d715ce0a3c197" title="a remote hash has been seen">SyncHashState_remote</a>) {
<a name="l00337"></a>00337         <span class="comment">// only set this bit if a remote hash has been entered</span>
<a name="l00338"></a>00338         <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a17d9349c3a973e5322e76c116a4c5b6d" title="the parent head">head</a>-&gt;<a class="code" href="struct_sync_hash_cache_head.html#aae4f738e778a493f25625017a060393f" title="the parent root">root</a>;
<a name="l00339"></a>00339         <span class="keywordflow">if</span> (root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a795a0a3098f6c9ba5990e8a23775284d" title="More debugging.">CCNL_FINER</a>) {
<a name="l00340"></a>00340             <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#aba3a8329dde03169d4bb1f369b2d78cf" title="hash used to reach this entry">hash</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#aba3a8329dde03169d4bb1f369b2d78cf" title="hash used to reach this entry">hash</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00341"></a>00341             <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, hex);
<a name="l00342"></a>00342             free(hex);
<a name="l00343"></a>00343         }
<a name="l00344"></a>00344         ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> |= <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381ae306c2dc55f40bf7e12c45acaf8d7a26" title="remote hash known covered by the local root">SyncHashState_covered</a>;
<a name="l00345"></a>00345     }
<a name="l00346"></a>00346 }
<a name="l00347"></a>00347 
<a name="l00348"></a>00348 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00349"></a><a class="code" href="_sync_actions_8c.html#a870761b1ea0620fc7bf78e6a7c4a8fb3">00349</a> <a class="code" href="_sync_actions_8c.html#a870761b1ea0620fc7bf78e6a7c4a8fb3">isCovered</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce) {
<a name="l00350"></a>00350     <span class="keywordflow">if</span> (ce == NULL) <span class="keywordflow">return</span> 1;
<a name="l00351"></a>00351     <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381ae306c2dc55f40bf7e12c45acaf8d7a26" title="remote hash known covered by the local root">SyncHashState_covered</a>) <span class="keywordflow">return</span> 1;
<a name="l00352"></a>00352     <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a9e849b0fed91e850763db20a54956128" title="a local node exists">SyncHashState_local</a>) {
<a name="l00353"></a>00353         <a class="code" href="_sync_actions_8c.html#a8d981d346c90e43d3f8d9e52077e28ca">setCovered</a>(ce);
<a name="l00354"></a>00354         <span class="keywordflow">return</span> 1;
<a name="l00355"></a>00355     }
<a name="l00356"></a>00356     <span class="keywordflow">return</span> 0;
<a name="l00357"></a>00357 }
<a name="l00358"></a>00358 
<a name="l00359"></a>00359 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00360"></a><a class="code" href="_sync_actions_8c.html#a5649db4933bbb71f0337fe748e52fec0">00360</a> <a class="code" href="_sync_actions_8c.html#a5649db4933bbb71f0337fe748e52fec0">reportExclude</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root, <span class="keyword">struct</span> <a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> *d) {
<a name="l00361"></a>00361     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.reportExclude&quot;</span>;
<a name="l00362"></a>00362     <span class="keywordtype">int</span> res = -1;
<a name="l00363"></a>00363     <span class="keywordflow">if</span> (<a class="code" href="ccn_8h.html#a127d4f9a3f901ba15bc5335d5a9fa3b0">ccn_buf_match_dtag</a>(d, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a9dcce1e4306cb7fd0e58d99ef370476e">CCN_DTAG_Exclude</a>)) {
<a name="l00364"></a>00364         res = d-&gt;<a class="code" href="structccn__buf__decoder.html#ad0c36c4f48a2a7995653059161ca4ba9">decoder</a>.<a class="code" href="structccn__skeleton__decoder.html#a7b9506b719a58e60ace62f904aba050a" title="Starting index of most-recent element.">element_index</a>;
<a name="l00365"></a>00365         <a class="code" href="ccn_8h.html#a1b17cadb92b2339cba24721b0466a0ce">ccn_buf_advance</a>(d);
<a name="l00366"></a>00366         <span class="comment">// optional Any | Bloom not present</span>
<a name="l00367"></a>00367         <span class="keywordflow">while</span> (<a class="code" href="ccn_8h.html#a127d4f9a3f901ba15bc5335d5a9fa3b0">ccn_buf_match_dtag</a>(d, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33ad20ad6d29fb3d5cb3631152e0fc1ccc0">CCN_DTAG_Component</a>)) {
<a name="l00368"></a>00368             <span class="keywordtype">size_t</span> cs = 0;
<a name="l00369"></a>00369             <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cp = NULL;
<a name="l00370"></a>00370             <a class="code" href="ccn_8h.html#a1b17cadb92b2339cba24721b0466a0ce">ccn_buf_advance</a>(d);
<a name="l00371"></a>00371             <span class="keywordflow">if</span> (<a class="code" href="ccn_8h.html#a9fed718b821292cf45ba00f17a09e69e">ccn_buf_match_blob</a>(d, &amp;cp, &amp;cs)) {
<a name="l00372"></a>00372                 <a class="code" href="ccn_8h.html#a1b17cadb92b2339cba24721b0466a0ce">ccn_buf_advance</a>(d);
<a name="l00373"></a>00373                 <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(cp, cs);
<a name="l00374"></a>00374                 <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, hex);
<a name="l00375"></a>00375                 free(hex);
<a name="l00376"></a>00376                 <a class="code" href="ccn_8h.html#a1868a32594c3c2a98e60049a3f3184b8" title="Enter an error state if element closer not found.">ccn_buf_check_close</a>(d);
<a name="l00377"></a>00377             }
<a name="l00378"></a>00378         }
<a name="l00379"></a>00379         <a class="code" href="ccn_8h.html#a1868a32594c3c2a98e60049a3f3184b8" title="Enter an error state if element closer not found.">ccn_buf_check_close</a>(d);
<a name="l00380"></a>00380     }
<a name="l00381"></a>00381     <span class="keywordflow">if</span> (d-&gt;<a class="code" href="structccn__buf__decoder.html#ad0c36c4f48a2a7995653059161ca4ba9">decoder</a>.<a class="code" href="structccn__skeleton__decoder.html#a59243d42e65373a2946e57137e244389" title="Decoder state.">state</a> &lt; 0)
<a name="l00382"></a>00382         res = d-&gt;<a class="code" href="structccn__buf__decoder.html#ad0c36c4f48a2a7995653059161ca4ba9">decoder</a>.<a class="code" href="structccn__skeleton__decoder.html#a59243d42e65373a2946e57137e244389" title="Decoder state.">state</a>;
<a name="l00383"></a>00383     <span class="keywordflow">if</span> (res &lt; 0)
<a name="l00384"></a>00384         <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;parse failed&quot;</span>);
<a name="l00385"></a>00385     <span class="keywordflow">return</span> res;
<a name="l00386"></a>00386 }
<a name="l00387"></a>00387 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00388"></a><a class="code" href="_sync_actions_8c.html#ad2d955864020d9986169c8574244c472">00388</a> <a class="code" href="_sync_actions_8c.html#ad2d955864020d9986169c8574244c472">kickCompare</a>(<span class="keyword">struct</span> SyncCompareData *scd, <span class="keyword">struct</span> <a class="code" href="struct_sync_action_data.html">SyncActionData</a> *action) {
<a name="l00389"></a>00389     <span class="comment">// we just got content for a particular action</span>
<a name="l00390"></a>00390     <span class="comment">// may need to restart CompareAction</span>
<a name="l00391"></a>00391     <span class="keywordflow">if</span> (scd != NULL &amp;&amp; scd-&gt;ev == NULL) {
<a name="l00392"></a>00392         <span class="keyword">struct </span><a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev = <a class="code" href="schedule_8h.html#a1b46f1ba6b54371f41a5c160cd1604ba">ccn_schedule_event</a>(scd-&gt;root-&gt;base-&gt;sd-&gt;sched,
<a name="l00393"></a>00393                                                             <a class="code" href="_sync_actions_8c.html#a259cad241b04e57ac063e149d3fb511e">shortDelayMicros</a>,
<a name="l00394"></a>00394                                                             <a class="code" href="_sync_actions_8c.html#a9489e03537895943d0ffdbd6378c13d2">CompareAction</a>,
<a name="l00395"></a>00395                                                             scd,
<a name="l00396"></a>00396                                                             0);
<a name="l00397"></a>00397         scd-&gt;ev = ev;
<a name="l00398"></a>00398     }
<a name="l00399"></a>00399 }
<a name="l00400"></a>00400 
<a name="l00401"></a>00401 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00402"></a><a class="code" href="_sync_actions_8c.html#a2355f67fe61fee13d8cdcb7ca131d911">00402</a> <a class="code" href="_sync_actions_8c.html#a2355f67fe61fee13d8cdcb7ca131d911">kickHeartBeat</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root, <span class="keywordtype">int</span> micros) {
<a name="l00403"></a>00403     <span class="keywordflow">if</span> (root != NULL)
<a name="l00404"></a>00404         <a class="code" href="schedule_8h.html#a1b46f1ba6b54371f41a5c160cd1604ba">ccn_schedule_event</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>-&gt;<a class="code" href="structsync__plumbing.html#ab5e574093a95dfb432043980ce9a5e17">sched</a>,
<a name="l00405"></a>00405                            micros,
<a name="l00406"></a>00406                            <a class="code" href="_sync_actions_8c.html#a4758fead9a41b25c3856d0a86f308682">HeartbeatAction</a>,
<a name="l00407"></a>00407                            root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>,
<a name="l00408"></a>00408                            0);
<a name="l00409"></a>00409 }
<a name="l00410"></a>00410 
<a name="l00411"></a><a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">00411</a> <span class="preprocessor">#define StatsLine(XXX) \</span>
<a name="l00412"></a>00412 <span class="preprocessor">if (stats-&gt;XXX) \</span>
<a name="l00413"></a>00413 <span class="preprocessor">pos += snprintf(s+pos, lim-pos, &quot;, %s %ju&quot;, #XXX, (uintmax_t) stats-&gt;XXX);</span>
<a name="l00414"></a>00414 <span class="preprocessor"></span>
<a name="l00415"></a>00415 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *
<a name="l00416"></a><a class="code" href="_sync_actions_8c.html#a2246f94f121a2ca6c1346b721484ed80">00416</a> <a class="code" href="_sync_actions_8c.html#a2246f94f121a2ca6c1346b721484ed80">formatStats</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root, <span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *cb) {
<a name="l00417"></a>00417     <span class="keyword">struct </span><a class="code" href="struct_sync_root_stats.html">SyncRootStats</a> *stats = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a38e2e743a14abac78e109da409dfd072">stats</a>;
<a name="l00418"></a>00418     <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *ncL = NULL;
<a name="l00419"></a>00419     <span class="keywordtype">char</span> s[2000];
<a name="l00420"></a>00420     <span class="keywordtype">int</span> lim = <span class="keyword">sizeof</span>(s);
<a name="l00421"></a>00421     <span class="keywordtype">int</span> pos = 0;
<a name="l00422"></a>00422     int64_t now = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l00423"></a>00423     <span class="keywordtype">int</span> ru_ok = -1;
<a name="l00424"></a>00424 <span class="preprocessor">#ifdef RUSAGE_SELF</span>
<a name="l00425"></a>00425 <span class="preprocessor"></span>    <span class="keyword">struct </span>rusage ru;
<a name="l00426"></a>00426     ru_ok = getrusage(RUSAGE_SELF, &amp;ru);
<a name="l00427"></a>00427 <span class="preprocessor">#endif</span>
<a name="l00428"></a>00428 <span class="preprocessor"></span>    <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *hash = root-&gt;<a class="code" href="struct_sync_root_struct.html#a013f6ae133c768d7bff2495445283bb4" title="current top-level cache hash">currentHash</a>;
<a name="l00429"></a>00429     <span class="keyword">struct </span>SyncCompareData *comp = root-&gt;<a class="code" href="struct_sync_root_struct.html#afc1f6cd0fc635888971bee16931d4aa6" title="data for doing sync tree comparison">compare</a>;
<a name="l00430"></a>00430     <span class="keyword">struct </span>SyncUpdateData *update = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb992ba3fa12a25258ed93ae52b25eb5" title="data for doing sync tree updates">update</a>;
<a name="l00431"></a>00431     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceL = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#abe335cfe4efd3e95c6fd099835d4baf9">ceCurrent</a>;
<a name="l00432"></a>00432     <span class="keywordflow">if</span> (ceL != NULL) {
<a name="l00433"></a>00433         <a class="code" href="_sync_hash_cache_8c.html#a88b8496fee4324b2359f23e3c6dd9472" title="fetches the cache entry to be eligible, ce != NULL &amp;amp;&amp;amp; ce-&amp;gt;ncL != NULL...">SyncCacheEntryFetch</a>(ceL);
<a name="l00434"></a>00434         ncL = ceL-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a>;
<a name="l00435"></a>00435     }
<a name="l00436"></a>00436     
<a name="l00437"></a>00437     pos += snprintf(s+pos, lim-pos, <span class="stringliteral">&quot;stats for root#%u&quot;</span>, root-&gt;<a class="code" href="struct_sync_root_struct.html#a86cbcbdd2e2d8c30311da406d36c80e5" title="root Id for reporting">rootId</a>);
<a name="l00438"></a>00438     <span class="keywordflow">if</span> (hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> &gt; 0) {
<a name="l00439"></a>00439         <span class="comment">// show the current hash</span>
<a name="l00440"></a>00440         <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00441"></a>00441         pos += snprintf(s+pos, lim-pos, <span class="stringliteral">&quot;, currentHash %s&quot;</span>, hex);
<a name="l00442"></a>00442         free(hex);
<a name="l00443"></a>00443     }
<a name="l00444"></a>00444     <span class="keywordflow">if</span> (comp != NULL) {
<a name="l00445"></a>00445         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *hashR = comp-&gt;hashR;
<a name="l00446"></a>00446         <span class="keywordflow">if</span> (hashR != NULL &amp;&amp; hashR-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> &gt; 0) {
<a name="l00447"></a>00447             <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hashR-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hashR-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00448"></a>00448             pos += snprintf(s+pos, lim-pos, <span class="stringliteral">&quot;, remoteHash %s&quot;</span>, hex);
<a name="l00449"></a>00449             free(hex);
<a name="l00450"></a>00450         }
<a name="l00451"></a>00451         intmax_t dt = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(comp-&gt;startTime, now);
<a name="l00452"></a>00452         pos += snprintf(s+pos, lim-pos, <span class="stringliteral">&quot;, compareBusy %jd&quot;</span>, dt);
<a name="l00453"></a>00453     }
<a name="l00454"></a>00454     <span class="keywordflow">if</span> (update != NULL) {
<a name="l00455"></a>00455         intmax_t dt = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(update-&gt;startTime, now);
<a name="l00456"></a>00456         pos += snprintf(s+pos, lim-pos, <span class="stringliteral">&quot;, updateBusy %jd&quot;</span>, dt);
<a name="l00457"></a>00457     }
<a name="l00458"></a>00458     
<a name="l00459"></a>00459     <span class="keywordflow">if</span> (root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#adc7ec5ad8b965350a0581a489ab42f18">lastHashChange</a> != 0) {
<a name="l00460"></a>00460         uintmax_t x = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#adc7ec5ad8b965350a0581a489ab42f18">lastHashChange</a>;
<a name="l00461"></a>00461         pos += snprintf(s+pos, lim-pos, <span class="stringliteral">&quot;, lastHashChange %ju.%06u&quot;</span>,
<a name="l00462"></a>00462                         x / <a class="code" href="_sync_actions_8c.html#a52037c938e3c1b126c6277da5ca689d0">M</a>, (<span class="keywordtype">unsigned</span>) (x % <a class="code" href="_sync_actions_8c.html#a52037c938e3c1b126c6277da5ca689d0">M</a>));
<a name="l00463"></a>00463     }
<a name="l00464"></a>00464     
<a name="l00465"></a>00465     <span class="keywordflow">if</span> (root-&gt;<a class="code" href="struct_sync_root_struct.html#a973c1488c9df1486c21fc37465c10def" title="names needing addition to root">namesToAdd</a> != NULL) {
<a name="l00466"></a>00466         intmax_t rem = root-&gt;<a class="code" href="struct_sync_root_struct.html#a973c1488c9df1486c21fc37465c10def" title="names needing addition to root">namesToAdd</a>-&gt;<a class="code" href="struct_sync_name_accum.html#a43e6bf3321957d08f4985443cc36555d">len</a>;
<a name="l00467"></a>00467         <span class="keywordflow">if</span> (rem &gt; 0)
<a name="l00468"></a>00468             pos += snprintf(s+pos, lim-pos, <span class="stringliteral">&quot;, namesToAdd %jd&quot;</span>, rem);
<a name="l00469"></a>00469     }
<a name="l00470"></a>00470     <span class="keywordflow">if</span> (root-&gt;<a class="code" href="struct_sync_root_struct.html#ac28d004acf78c3ef247937c0b10d8b7c" title="names needing contents fetch">namesToFetch</a> != NULL) {
<a name="l00471"></a>00471         intmax_t rem = root-&gt;<a class="code" href="struct_sync_root_struct.html#ac28d004acf78c3ef247937c0b10d8b7c" title="names needing contents fetch">namesToFetch</a>-&gt;<a class="code" href="struct_sync_name_accum.html#a43e6bf3321957d08f4985443cc36555d">len</a>;
<a name="l00472"></a>00472         <span class="keywordflow">if</span> (comp != NULL) rem = rem - comp-&gt;contentPos;
<a name="l00473"></a>00473         <span class="keywordflow">if</span> (rem &gt; 0)
<a name="l00474"></a>00474             pos += snprintf(s+pos, lim-pos, <span class="stringliteral">&quot;, namesToFetch %jd&quot;</span>, rem);
<a name="l00475"></a>00475     }
<a name="l00476"></a>00476     <span class="keywordflow">if</span> (ncL != NULL) {
<a name="l00477"></a>00477         pos += snprintf(s+pos, lim-pos, <span class="stringliteral">&quot;, treeDepth %ju&quot;</span>, (uintmax_t) 
<a name="l00478"></a>00478                         ncL-&gt;<a class="code" href="struct_sync_node_composite.html#a2394633cbdfbb3733266a8fef137f6e2" title="max tree depth (includes this node)">treeDepth</a>);
<a name="l00479"></a>00479         pos += snprintf(s+pos, lim-pos, <span class="stringliteral">&quot;, treeNames %ju&quot;</span>, (uintmax_t) 
<a name="l00480"></a>00480                         ncL-&gt;<a class="code" href="struct_sync_node_composite.html#a0555c71f0d4daa546a4ca44fa4a6f8ee" title="leaf count (includes this node)">leafCount</a>);
<a name="l00481"></a>00481         pos += snprintf(s+pos, lim-pos, <span class="stringliteral">&quot;, treeBytes %ju&quot;</span>, (uintmax_t) 
<a name="l00482"></a>00482                         ncL-&gt;<a class="code" href="struct_sync_node_composite.html#a4f55e19904666a108bcc67488ac7d6c6" title="byte count sum for child nodes (this node NOT included)">byteCount</a> + ncL-&gt;<a class="code" href="struct_sync_node_composite.html#a5b1cdb9c3eabafe04a18c8623784ff04" title="pointer to ccnb encoding">cb</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00483"></a>00483     }
<a name="l00484"></a>00484     
<a name="l00485"></a>00485     <a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">StatsLine</a>(comparesDone);
<a name="l00486"></a>00486     <a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">StatsLine</a>(lastCompareMicros);
<a name="l00487"></a>00487     <a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">StatsLine</a>(updatesDone);
<a name="l00488"></a>00488     <a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">StatsLine</a>(lastUpdateMicros);
<a name="l00489"></a>00489     <a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">StatsLine</a>(nodesCreated);
<a name="l00490"></a>00490     <a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">StatsLine</a>(nodesShared);
<a name="l00491"></a>00491     <a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">StatsLine</a>(rootAdviseSent);
<a name="l00492"></a>00492     <a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">StatsLine</a>(rootAdviseSeen);
<a name="l00493"></a>00493     <a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">StatsLine</a>(rootAdviseReceived);
<a name="l00494"></a>00494     <a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">StatsLine</a>(rootAdviseTimeout);
<a name="l00495"></a>00495     <a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">StatsLine</a>(rootAdviseFailed);
<a name="l00496"></a>00496     <a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">StatsLine</a>(nodeFetchSent);
<a name="l00497"></a>00497     <a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">StatsLine</a>(nodeFetchSeen);
<a name="l00498"></a>00498     <a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">StatsLine</a>(nodeFetchReceived);
<a name="l00499"></a>00499     <a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">StatsLine</a>(nodeFetchTimeout);
<a name="l00500"></a>00500     <a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">StatsLine</a>(nodeFetchFailed);
<a name="l00501"></a>00501     <a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">StatsLine</a>(nodeFetchBytes);
<a name="l00502"></a>00502     <a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">StatsLine</a>(contentFetchSent);
<a name="l00503"></a>00503     <a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">StatsLine</a>(contentFetchReceived);
<a name="l00504"></a>00504     <a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">StatsLine</a>(contentFetchTimeout);
<a name="l00505"></a>00505     <a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">StatsLine</a>(contentFetchFailed);
<a name="l00506"></a>00506     <a class="code" href="_sync_actions_8c.html#af46f5c10aab1e071fb7fed42f552aadb">StatsLine</a>(contentFetchBytes);
<a name="l00507"></a>00507     
<a name="l00508"></a>00508 <span class="preprocessor">#ifdef RUSAGE_SELF</span>
<a name="l00509"></a>00509 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ru_ok &gt;= 0) {
<a name="l00510"></a>00510         pos += snprintf(s+pos, lim-pos, <span class="stringliteral">&quot;, maxrss %ju&quot;</span>,
<a name="l00511"></a>00511                         (uintmax_t) ru.ru_maxrss);
<a name="l00512"></a>00512         pos += snprintf(s+pos, lim-pos, <span class="stringliteral">&quot;, utime %ju.%06u&quot;</span>,
<a name="l00513"></a>00513                         (uintmax_t) ru.ru_utime.tv_sec,
<a name="l00514"></a>00514                         (<span class="keywordtype">unsigned</span>) ru.ru_utime.tv_usec);
<a name="l00515"></a>00515         pos += snprintf(s+pos, lim-pos, <span class="stringliteral">&quot;, stime %ju.%06u&quot;</span>,
<a name="l00516"></a>00516                         (uintmax_t) ru.ru_stime.tv_sec,
<a name="l00517"></a>00517                         (<span class="keywordtype">unsigned</span>) ru.ru_stime.tv_usec);
<a name="l00518"></a>00518     }
<a name="l00519"></a>00519 <span class="preprocessor">#endif   </span>
<a name="l00520"></a>00520 <span class="preprocessor"></span>    <a class="code" href="charbuf_8h.html#a5cc5c1412e38c015951394fcd79e2f6e">ccn_charbuf_append</a>(cb, s, pos);
<a name="l00521"></a>00521     <span class="keywordflow">return</span> cb;
<a name="l00522"></a>00522 }
<a name="l00523"></a>00523 
<a name="l00524"></a>00524 <span class="preprocessor">#undef StatsLine</span>
<a name="l00525"></a>00525 <span class="preprocessor"></span>
<a name="l00526"></a>00526 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *
<a name="l00527"></a><a class="code" href="_sync_actions_8c.html#adf89fd412f0e65a80e9a7e961f7d6b13">00527</a> <a class="code" href="_sync_actions_8c.html#adf89fd412f0e65a80e9a7e961f7d6b13">constructCommandPrefix</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root,
<a name="l00528"></a>00528                        <span class="keyword">enum</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692">SyncRegisterActionKind</a> kind) {
<a name="l00529"></a>00529     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *prefix = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00530"></a>00530     <span class="keywordtype">int</span> res = 0;
<a name="l00531"></a>00531     <a class="code" href="ccn_8h.html#a4aa75ce6fc675e7a4c4c6d65e68817bd" title="Reset charbuf to represent an empty Name in binary format.">ccn_name_init</a>(prefix);
<a name="l00532"></a>00532     <span class="keywordflow">if</span> (root-&gt;<a class="code" href="struct_sync_root_struct.html#a6ba6270127aea47744c6860e6aff6627" title="Sync Protocol topo prefix.">topoPrefix</a> != NULL &amp;&amp; root-&gt;<a class="code" href="struct_sync_root_struct.html#a6ba6270127aea47744c6860e6aff6627" title="Sync Protocol topo prefix.">topoPrefix</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> &gt; 0) {
<a name="l00533"></a>00533         <span class="comment">// the topo (if any) always comes first</span>
<a name="l00534"></a>00534         res |= <a class="code" href="_sync_util_8c.html#ab3aa3affaa70eb4e73a29afdad0cda71" title="appends components from src to dst (both must be names)">SyncAppendAllComponents</a>(prefix, root-&gt;<a class="code" href="struct_sync_root_struct.html#a6ba6270127aea47744c6860e6aff6627" title="Sync Protocol topo prefix.">topoPrefix</a>);
<a name="l00535"></a>00535     }
<a name="l00536"></a>00536     <span class="comment">// the command comes after the topo</span>
<a name="l00537"></a>00537     <a class="code" href="ccn_8h.html#aec5620dc4689a663ea7181cdebeda4d0" title="Add a Component that is a NUL-terminated string.">ccn_name_append_str</a>(prefix, <a class="code" href="_sync_actions_8c.html#a25e9755894d555e4e08d8af7b61e91ae">getCmdStr</a>(kind));
<a name="l00538"></a>00538     res |= <a class="code" href="ccn_8h.html#a3f4f614f38ae77dccb4099e982c646f8" title="Add a Component to a Name.">ccn_name_append</a>(prefix, root-&gt;<a class="code" href="struct_sync_root_struct.html#add7a152b7bdc85bd56a20b16f1da93f6" title="the raw hash of the sliceCoding">sliceHash</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, root-&gt;<a class="code" href="struct_sync_root_struct.html#add7a152b7bdc85bd56a20b16f1da93f6" title="the raw hash of the sliceCoding">sliceHash</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00539"></a>00539     
<a name="l00540"></a>00540     <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00541"></a>00541         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;prefix);
<a name="l00542"></a>00542     }
<a name="l00543"></a>00543     <span class="keywordflow">return</span> prefix;
<a name="l00544"></a>00544 }
<a name="l00545"></a>00545 
<a name="l00546"></a>00546 <span class="comment">// extract deltas extracts a list of delta names from an upcall info</span>
<a name="l00547"></a>00547 <span class="comment">// the names are placed in a name accum stored in root-&gt;priv-&gt;remoteDeltas</span>
<a name="l00548"></a>00548 <span class="comment">// returns &lt; 0 on error, or the name count on success</span>
<a name="l00549"></a>00549 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00550"></a><a class="code" href="_sync_actions_8c.html#a30eb686207e398b04523666b16e4de17">00550</a> <a class="code" href="_sync_actions_8c.html#a30eb686207e398b04523666b16e4de17">extractDeltas</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root, <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info) {
<a name="l00551"></a>00551     <span class="comment">// first, find the content</span>
<a name="l00552"></a>00552     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.extractDeltas&quot;</span>;
<a name="l00553"></a>00553     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cp = NULL;
<a name="l00554"></a>00554     <span class="keywordtype">int</span> count = 0;
<a name="l00555"></a>00555     <span class="keywordtype">size_t</span> cs = 0;
<a name="l00556"></a>00556     <span class="keywordtype">size_t</span> ccnb_size = info-&gt;<a class="code" href="structccn__upcall__info.html#a5483525206dfb80f831040d0d9602906">pco</a>-&gt;<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387a1d25adf694c64b4ae597b26abe6b30fc">CCN_PCO_E</a>];
<a name="l00557"></a>00557     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *ccnb = info-&gt;<a class="code" href="structccn__upcall__info.html#a226aa6acbc2fe85ee7d400b52ef3664a">content_ccnb</a>;
<a name="l00558"></a>00558     <span class="keywordtype">int</span> res = <a class="code" href="ccn_8h.html#ac3a7a8cad96caf34fc73240b20f07cd2">ccn_content_get_value</a>(ccnb, ccnb_size, info-&gt;<a class="code" href="structccn__upcall__info.html#a5483525206dfb80f831040d0d9602906">pco</a>,
<a name="l00559"></a>00559                                     &amp;cp, &amp;cs);
<a name="l00560"></a>00560     <span class="keywordflow">if</span> (res &lt; 0 || cs &lt; 2) {
<a name="l00561"></a>00561         <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;ccn_content_get_value&quot;</span>, __LINE__);
<a name="l00562"></a>00562         <span class="keywordflow">return</span> -1;
<a name="l00563"></a>00563     }
<a name="l00564"></a>00564     
<a name="l00565"></a>00565     <span class="comment">// second, parse the object</span>
<a name="l00566"></a>00566     <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> ds;
<a name="l00567"></a>00567     <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> *d = <a class="code" href="ccn_8h.html#a4ba830f8dad511663779d85122db633a">ccn_buf_decoder_start</a>(&amp;ds, cp, cs);
<a name="l00568"></a>00568     
<a name="l00569"></a>00569     <span class="keywordflow">if</span> (<a class="code" href="ccn_8h.html#a127d4f9a3f901ba15bc5335d5a9fa3b0">ccn_buf_match_dtag</a>(d, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33aca145734b1ddf48bd51a90dbe90e5138">CCN_DTAG_SyncNodeDeltas</a>)) {
<a name="l00570"></a>00570         <a class="code" href="ccn_8h.html#a1b17cadb92b2339cba24721b0466a0ce">ccn_buf_advance</a>(d);
<a name="l00571"></a>00571         uintmax_t vers = <a class="code" href="_sync_util_8c.html#a748feb74d831a6cbec1075024ded26bb">SyncParseUnsigned</a>(d, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a4f736b68912ea01258ea8c85f507e144">CCN_DTAG_SyncVersion</a>);
<a name="l00572"></a>00572         <span class="keywordflow">if</span> (<a class="code" href="_sync_util_8c.html#a85a42d217af026083077adafcc731f0b">SyncCheckDecodeErr</a>(d) || vers != <a class="code" href="_sync_actions_8c.html#ad12cf4a0550d67730e5d830dfe78babb">SYNC_UPDATE_VERSION</a>) {
<a name="l00573"></a>00573             <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad version&quot;</span>, __LINE__);
<a name="l00574"></a>00574             <span class="keywordflow">return</span> -1;
<a name="l00575"></a>00575         }
<a name="l00576"></a>00576         <span class="keyword">struct </span><a class="code" href="struct_sync_name_accum.html">SyncNameAccum</a> *na = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#aaf1e25bbca5a71684b2deefce4f2082f">remoteDeltas</a>;
<a name="l00577"></a>00577         <span class="keywordflow">if</span> (na != NULL) <a class="code" href="_sync_util_8c.html#a6c2c47daae1a00b2fd20577c8bd7eef0" title="frees the name accum and all of the names">SyncFreeNameAccumAndNames</a>(na);
<a name="l00578"></a>00578         na = <a class="code" href="_sync_util_8c.html#adcdacf16d78ec4fff95eff5f0d63446b">SyncAllocNameAccum</a>(4);
<a name="l00579"></a>00579         root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#aaf1e25bbca5a71684b2deefce4f2082f">remoteDeltas</a> = na;
<a name="l00580"></a>00580         <span class="keywordflow">while</span> (<a class="code" href="ccn_8h.html#a127d4f9a3f901ba15bc5335d5a9fa3b0">ccn_buf_match_dtag</a>(d, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a7903556a9a07652962c02014f7f7832f">CCN_DTAG_Name</a>)) {
<a name="l00581"></a>00581             <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = <a class="code" href="_sync_util_8c.html#aa637859a381e666813e30b3308718817">SyncExtractName</a>(d);
<a name="l00582"></a>00582             <span class="keywordflow">if</span> (name == NULL) {
<a name="l00583"></a>00583                 <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad name&quot;</span>, __LINE__);
<a name="l00584"></a>00584                 <span class="keywordflow">break</span>;
<a name="l00585"></a>00585             }
<a name="l00586"></a>00586             <a class="code" href="_sync_util_8c.html#a9c7204a6cd37470ba61c05e5da8d8fc6" title="appends a new name with associated data important: the name is not copied!">SyncNameAccumAppend</a>(na, name, 0);
<a name="l00587"></a>00587             count++;
<a name="l00588"></a>00588         }
<a name="l00589"></a>00589         <a class="code" href="ccn_8h.html#a1868a32594c3c2a98e60049a3f3184b8" title="Enter an error state if element closer not found.">ccn_buf_check_close</a>(d);
<a name="l00590"></a>00590     }
<a name="l00591"></a>00591     <span class="keywordflow">return</span> count;
<a name="l00592"></a>00592 }
<a name="l00593"></a>00593 
<a name="l00594"></a>00594 <span class="comment">// extractNode parses and creates a sync tree node from an upcall info</span>
<a name="l00595"></a>00595 <span class="comment">// returns NULL if there was any kind of error</span>
<a name="l00596"></a>00596 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *
<a name="l00597"></a><a class="code" href="_sync_actions_8c.html#aef266441ec21334a137f07c70f706859">00597</a> <a class="code" href="_sync_actions_8c.html#aef266441ec21334a137f07c70f706859">extractNode</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root, <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info) {
<a name="l00598"></a>00598     <span class="comment">// first, find the content</span>
<a name="l00599"></a>00599     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.extractNode&quot;</span>;
<a name="l00600"></a>00600     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cp = NULL;
<a name="l00601"></a>00601     <span class="keywordtype">size_t</span> cs = 0;
<a name="l00602"></a>00602     <span class="keywordtype">size_t</span> ccnb_size = info-&gt;<a class="code" href="structccn__upcall__info.html#a5483525206dfb80f831040d0d9602906">pco</a>-&gt;<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387a1d25adf694c64b4ae597b26abe6b30fc">CCN_PCO_E</a>];
<a name="l00603"></a>00603     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *ccnb = info-&gt;<a class="code" href="structccn__upcall__info.html#a226aa6acbc2fe85ee7d400b52ef3664a">content_ccnb</a>;
<a name="l00604"></a>00604     <span class="keywordtype">int</span> res = <a class="code" href="ccn_8h.html#ac3a7a8cad96caf34fc73240b20f07cd2">ccn_content_get_value</a>(ccnb, ccnb_size, info-&gt;<a class="code" href="structccn__upcall__info.html#a5483525206dfb80f831040d0d9602906">pco</a>,
<a name="l00605"></a>00605                                     &amp;cp, &amp;cs);
<a name="l00606"></a>00606     <span class="keywordflow">if</span> (res &lt; 0 || cs &lt; <a class="code" href="_sync_macros_8h.html#a03bbbc9005ca1cbfcda5b5012c7b61d7">DEFAULT_HASH_BYTES</a>) {
<a name="l00607"></a>00607         <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;ccn_content_get_value&quot;</span>, __LINE__);
<a name="l00608"></a>00608         <span class="keywordflow">return</span> NULL;
<a name="l00609"></a>00609     }
<a name="l00610"></a>00610     
<a name="l00611"></a>00611     <span class="comment">// second, parse the object</span>
<a name="l00612"></a>00612     <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *nc = <a class="code" href="_sync_node_8c.html#adbc4a9ebd7d35b9d7c9d36a9c3263bb7" title="allocates a new, empty, composite object">SyncAllocComposite</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>);
<a name="l00613"></a>00613     <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> ds;
<a name="l00614"></a>00614     <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> *d = <a class="code" href="ccn_8h.html#a4ba830f8dad511663779d85122db633a">ccn_buf_decoder_start</a>(&amp;ds, cp, cs);
<a name="l00615"></a>00615     res |= <a class="code" href="_sync_node_8c.html#aaea566ba70951e05863f749b1d8c97eb" title="parses an encoded node and fills in the supplied node implicitly resets the node...">SyncParseComposite</a>(nc, d);
<a name="l00616"></a>00616     <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00617"></a>00617         <span class="comment">// failed, so back out of the allocations</span>
<a name="l00618"></a>00618         <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad parse&quot;</span>, -res);
<a name="l00619"></a>00619         <a class="code" href="_sync_node_8c.html#af28433d58bb465b237a50e3b0aa9d0e4" title="freeComposite returns the storage for the composite object">SyncFreeComposite</a>(nc);
<a name="l00620"></a>00620         nc = NULL;
<a name="l00621"></a>00621     }
<a name="l00622"></a>00622     <span class="keywordflow">return</span> nc;
<a name="l00623"></a>00623 }
<a name="l00624"></a>00624 
<a name="l00625"></a>00625 <span class="comment">// noteHash remembers a remote hash (given by the hash cache entry),</span>
<a name="l00626"></a>00626 <span class="comment">// promoting it to the front</span>
<a name="l00627"></a>00627 <span class="comment">// if add == TRUE and there is no remote hash, then add it, else ignore it</span>
<a name="l00628"></a>00628 <span class="comment">// returns &lt; 0 for error, 0 if not added, 1 if added</span>
<a name="l00629"></a>00629 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00630"></a><a class="code" href="_sync_actions_8c.html#ab011bfe2bd9aaf272495352a045ae144">00630</a> <a class="code" href="_sync_actions_8c.html#ab011bfe2bd9aaf272495352a045ae144">noteHash</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root, <span class="keyword">struct</span> <a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce,
<a name="l00631"></a>00631                <span class="keywordtype">int</span> add, <span class="keywordtype">int</span> remote) {
<a name="l00632"></a>00632     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.noteRemoteHash&quot;</span>;
<a name="l00633"></a>00633     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l00634"></a>00634     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *hash = NULL;
<a name="l00635"></a>00635     <span class="keywordtype">int</span> hl = 0;
<a name="l00636"></a>00636     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_info_list.html">SyncHashInfoList</a> *head = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a7c217e7610fe07ecbf7ad85c2b4785c7">remoteSeen</a>;
<a name="l00637"></a>00637     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_info_list.html">SyncHashInfoList</a> *each = head;
<a name="l00638"></a>00638     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_info_list.html">SyncHashInfoList</a> *lag = NULL;
<a name="l00639"></a>00639     int64_t mark = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l00640"></a>00640     <span class="keywordtype">int</span> res = 0;
<a name="l00641"></a>00641     <span class="keywordflow">if</span> (remote == 0) {
<a name="l00642"></a>00642         head = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a7f856ccd9518ec05ad8605f8fb46a47b">localMade</a>;
<a name="l00643"></a>00643         here = <span class="stringliteral">&quot;Sync.noteLocalHash&quot;</span>;
<a name="l00644"></a>00644     }
<a name="l00645"></a>00645     <span class="keywordflow">if</span> (ce != NULL) {
<a name="l00646"></a>00646         ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a6861960908cc217b639d3f1af6bbc520" title="time when entry last used in compare">lastUsed</a> = mark;
<a name="l00647"></a>00647         <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a9e849b0fed91e850763db20a54956128" title="a local node exists">SyncHashState_local</a>)
<a name="l00648"></a>00648             <a class="code" href="_sync_actions_8c.html#a8d981d346c90e43d3f8d9e52077e28ca">setCovered</a>(ce);
<a name="l00649"></a>00649         hash = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#aba3a8329dde03169d4bb1f369b2d78cf" title="hash used to reach this entry">hash</a>;
<a name="l00650"></a>00650         hl = hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>;
<a name="l00651"></a>00651     }
<a name="l00652"></a>00652     <span class="keywordflow">while</span> (each != NULL) {
<a name="l00653"></a>00653         <span class="keywordflow">if</span> (ce == each-&gt;<a class="code" href="struct_sync_hash_info_list.html#a454640fcbb0a9ba9baa38dfe544a71ef">ce</a>) {
<a name="l00654"></a>00654             <span class="keywordflow">if</span> (lag != NULL) {
<a name="l00655"></a>00655                 <span class="comment">// move it to the front</span>
<a name="l00656"></a>00656                 lag-&gt;<a class="code" href="struct_sync_hash_info_list.html#a09d3622f803ab21ac48e83f1fafdd643">next</a> = each-&gt;<a class="code" href="struct_sync_hash_info_list.html#a09d3622f803ab21ac48e83f1fafdd643">next</a>;
<a name="l00657"></a>00657                 each-&gt;<a class="code" href="struct_sync_hash_info_list.html#a09d3622f803ab21ac48e83f1fafdd643">next</a> = head;
<a name="l00658"></a>00658                 head = each;
<a name="l00659"></a>00659                 res = 1;
<a name="l00660"></a>00660             }
<a name="l00661"></a>00661             <span class="keywordflow">break</span>;
<a name="l00662"></a>00662         }
<a name="l00663"></a>00663         lag = each;
<a name="l00664"></a>00664         each = each-&gt;<a class="code" href="struct_sync_hash_info_list.html#a09d3622f803ab21ac48e83f1fafdd643">next</a>;
<a name="l00665"></a>00665     }
<a name="l00666"></a>00666     <span class="keywordflow">if</span> (each == NULL &amp;&amp; add) {
<a name="l00667"></a>00667         <span class="comment">// need a new entry</span>
<a name="l00668"></a>00668         each = <a class="code" href="_sync_macros_8h.html#ab707d3cfcb52f2e2f819771123942548">NEW_STRUCT</a>(1, <a class="code" href="struct_sync_hash_info_list.html">SyncHashInfoList</a>);
<a name="l00669"></a>00669         each-&gt;<a class="code" href="struct_sync_hash_info_list.html#a09d3622f803ab21ac48e83f1fafdd643">next</a> = head;
<a name="l00670"></a>00670         head = each;
<a name="l00671"></a>00671     }
<a name="l00672"></a>00672     <span class="keywordflow">if</span> (each != NULL) {
<a name="l00673"></a>00673         each-&gt;<a class="code" href="struct_sync_hash_info_list.html#a454640fcbb0a9ba9baa38dfe544a71ef">ce</a> = ce;
<a name="l00674"></a>00674         <span class="keywordflow">if</span> (ce != NULL) ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#aa390761ef0ed674d7baf92b1d2ccf2d9" title="the tree worker usage count">busy</a>++;
<a name="l00675"></a>00675         each-&gt;<a class="code" href="struct_sync_hash_info_list.html#a8b13c67f4f157d047c6c6efc9f05d95c">lastSeen</a> = mark;
<a name="l00676"></a>00676         each-&gt;<a class="code" href="struct_sync_hash_info_list.html#a80001233f5a192af604d2df927529f47">lastReplied</a> = 0;
<a name="l00677"></a>00677     }
<a name="l00678"></a>00678     <span class="keywordflow">if</span> (remote == 0) root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a7f856ccd9518ec05ad8605f8fb46a47b">localMade</a> = head;
<a name="l00679"></a>00679     <span class="keywordflow">else</span> root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a7c217e7610fe07ecbf7ad85c2b4785c7">remoteSeen</a> = head;
<a name="l00680"></a>00680 
<a name="l00681"></a>00681     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l00682"></a>00682         <span class="keywordtype">char</span> *hex = <span class="stringliteral">&quot;empty&quot;</span>;
<a name="l00683"></a>00683         <span class="keywordflow">if</span> (hl &gt; 0) hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hl);
<a name="l00684"></a>00684         <span class="keywordtype">char</span> *extra = ((<a class="code" href="_sync_actions_8c.html#a870761b1ea0620fc7bf78e6a7c4a8fb3">isCovered</a>(ce)) ? <span class="stringliteral">&quot;covered, &quot;</span> : <span class="stringliteral">&quot;&quot;</span>);
<a name="l00685"></a>00685         <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>, <span class="stringliteral">&quot;%s, root#%u, %s%s&quot;</span>, here, root-&gt;<a class="code" href="struct_sync_root_struct.html#a86cbcbdd2e2d8c30311da406d36c80e5" title="root Id for reporting">rootId</a>, extra, hex);
<a name="l00686"></a>00686         <span class="keywordflow">if</span> (hl &gt; 0) free(hex);
<a name="l00687"></a>00687     }
<a name="l00688"></a>00688     <span class="keywordflow">return</span> res;
<a name="l00689"></a>00689 }
<a name="l00690"></a>00690 
<a name="l00691"></a>00691 <span class="comment">// chooseRemoteHash returns the most recently seen/used remote hash</span>
<a name="l00692"></a>00692 <span class="comment">// from the remoteSeen list.  The chosen hash must be remote (duh),</span>
<a name="l00693"></a>00693 <span class="comment">// and not covered and must have been seen or used recently enough.</span>
<a name="l00694"></a>00694 <span class="comment">// (TBD: is 2*rootAdviseLifetime a good choice?)</span>
<a name="l00695"></a>00695 <span class="comment">// chooseRemoteHash also prunes the remoteSeen list of ineligible entries.</span>
<a name="l00696"></a>00696 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="struct_sync_hash_info_list.html">SyncHashInfoList</a> *
<a name="l00697"></a><a class="code" href="_sync_actions_8c.html#a7eec1898b50d6390b806243b395b1d53">00697</a> <a class="code" href="_sync_actions_8c.html#a7eec1898b50d6390b806243b395b1d53">chooseRemoteHash</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root) {
<a name="l00698"></a>00698     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_info_list.html">SyncHashInfoList</a> *each = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a7c217e7610fe07ecbf7ad85c2b4785c7">remoteSeen</a>;
<a name="l00699"></a>00699     int64_t now = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l00700"></a>00700     int64_t limit = ((int64_t)root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>-&gt;<a class="code" href="struct_sync_private.html#a0797a7f49da728903eb8c2a1adbca1a9">rootAdviseLifetime</a>)*2*<a class="code" href="_sync_actions_8c.html#a52037c938e3c1b126c6277da5ca689d0">M</a>;
<a name="l00701"></a>00701     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_info_list.html">SyncHashInfoList</a> *lag = NULL;
<a name="l00702"></a>00702     <span class="keywordflow">while</span> (each != NULL) {
<a name="l00703"></a>00703         <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = each-&gt;<a class="code" href="struct_sync_hash_info_list.html#a454640fcbb0a9ba9baa38dfe544a71ef">ce</a>;
<a name="l00704"></a>00704         <span class="keyword">struct </span><a class="code" href="struct_sync_hash_info_list.html">SyncHashInfoList</a> *<a class="code" href="struct_sync_hash_info_list.html#a09d3622f803ab21ac48e83f1fafdd643">next</a> = each-&gt;<a class="code" href="struct_sync_hash_info_list.html#a09d3622f803ab21ac48e83f1fafdd643">next</a>;
<a name="l00705"></a>00705         int64_t dt = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(each-&gt;<a class="code" href="struct_sync_hash_info_list.html#a8b13c67f4f157d047c6c6efc9f05d95c">lastSeen</a>, now);
<a name="l00706"></a>00706         <span class="keywordflow">if</span> (dt &lt; limit) {
<a name="l00707"></a>00707             <span class="comment">// not expired</span>
<a name="l00708"></a>00708             <span class="keywordflow">if</span> (ce != NULL 
<a name="l00709"></a>00709                 &amp;&amp; (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381aec73ed0d374163f11f2d715ce0a3c197" title="a remote hash has been seen">SyncHashState_remote</a>)
<a name="l00710"></a>00710                 &amp;&amp; ((ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381ae306c2dc55f40bf7e12c45acaf8d7a26" title="remote hash known covered by the local root">SyncHashState_covered</a>) == 0))
<a name="l00711"></a>00711                 <span class="keywordflow">return</span> each;
<a name="l00712"></a>00712         } <span class="keywordflow">else</span> {
<a name="l00713"></a>00713             <span class="comment">// prune this entry (too old)</span>
<a name="l00714"></a>00714             <span class="keywordflow">if</span> (lag == NULL) root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a7c217e7610fe07ecbf7ad85c2b4785c7">remoteSeen</a> = next;
<a name="l00715"></a>00715             <span class="keywordflow">else</span> lag-&gt;<a class="code" href="struct_sync_hash_info_list.html#a09d3622f803ab21ac48e83f1fafdd643">next</a> = next;
<a name="l00716"></a>00716             free(each);
<a name="l00717"></a>00717         }
<a name="l00718"></a>00718         each = next;
<a name="l00719"></a>00719     }
<a name="l00720"></a>00720     <span class="keywordflow">return</span> NULL;
<a name="l00721"></a>00721 }
<a name="l00722"></a>00722 
<a name="l00723"></a>00723 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00724"></a><a class="code" href="_sync_actions_8c.html#af1d3bf7c6863a87ad17a9f27cda5e9e6">00724</a> <a class="code" href="_sync_actions_8c.html#af1d3bf7c6863a87ad17a9f27cda5e9e6">fauxError</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base) {
<a name="l00725"></a>00725     <span class="comment">// returns 1 with probability fauxErrorTrigger percent [roughly]</span>
<a name="l00726"></a>00726     <span class="keywordflow">if</span> (base != NULL &amp;&amp; base-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>-&gt;<a class="code" href="struct_sync_private.html#a85942eb53a96c6c004dddfc45bfa3833">fauxErrorTrigger</a> &gt; 0) {
<a name="l00727"></a>00727         <span class="keywordtype">int</span> fet = base-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>-&gt;<a class="code" href="struct_sync_private.html#a85942eb53a96c6c004dddfc45bfa3833">fauxErrorTrigger</a>;
<a name="l00728"></a>00728         <span class="keywordflow">if</span> (fet &gt; 0) {
<a name="l00729"></a>00729             <span class="keywordtype">int</span> r = random() % 100;
<a name="l00730"></a>00730             <span class="keywordflow">if</span> (r &lt; fet) <span class="keywordflow">return</span> 1;
<a name="l00731"></a>00731         }
<a name="l00732"></a>00732     }
<a name="l00733"></a>00733     <span class="keywordflow">return</span> 0;
<a name="l00734"></a>00734 }
<a name="l00735"></a>00735 <span class="comment"></span>
<a name="l00736"></a>00736 <span class="comment">///////////////////////////////////////////////////////////////////////////</span>
<a name="l00737"></a>00737 <span class="comment">///// Comparison internal routines</span>
<a name="l00738"></a>00738 <span class="comment">///////////////////////////////////////////////////////////////////////////</span>
<a name="l00739"></a>00739 <span class="comment"></span>
<a name="l00740"></a>00740 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00741"></a><a class="code" href="_sync_actions_8c.html#aa82d85556d61517fb147eda456d8170f">00741</a> <a class="code" href="_sync_actions_8c.html#aa82d85556d61517fb147eda456d8170f">destroyCompareData</a>(<span class="keyword">struct</span> SyncCompareData *data) {
<a name="l00742"></a>00742     <span class="keywordflow">if</span> (data == NULL) <span class="keywordflow">return</span>;
<a name="l00743"></a>00743     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = data-&gt;root;
<a name="l00744"></a>00744     <span class="keyword">struct </span><a class="code" href="struct_sync_private.html">SyncPrivate</a> *priv = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>;
<a name="l00745"></a>00745     <span class="keywordflow">if</span> (root != NULL) {
<a name="l00746"></a>00746         <span class="keywordflow">while</span> (data-&gt;errList != NULL) {
<a name="l00747"></a>00747             <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *sad = data-&gt;errList;
<a name="l00748"></a>00748             <a class="code" href="_sync_actions_8c.html#a9826ac9a64ba2f80ef24985bee419929">destroyActionData</a>(sad);
<a name="l00749"></a>00749         }
<a name="l00750"></a>00750         root-&gt;<a class="code" href="struct_sync_root_struct.html#ac28d004acf78c3ef247937c0b10d8b7c" title="names needing contents fetch">namesToFetch</a> = <a class="code" href="_sync_util_8c.html#a6c2c47daae1a00b2fd20577c8bd7eef0" title="frees the name accum and all of the names">SyncFreeNameAccumAndNames</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#ac28d004acf78c3ef247937c0b10d8b7c" title="names needing contents fetch">namesToFetch</a>);
<a name="l00751"></a>00751         root-&gt;<a class="code" href="struct_sync_root_struct.html#afc1f6cd0fc635888971bee16931d4aa6" title="data for doing sync tree comparison">compare</a> = NULL;
<a name="l00752"></a>00752         <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *each = root-&gt;<a class="code" href="struct_sync_root_struct.html#a17d4b18dfe2d8907b5fe1715699cb353" title="data for pending interests">actions</a>;
<a name="l00753"></a>00753         <span class="comment">// break the link from the action to the compare</span>
<a name="l00754"></a>00754         <span class="keywordflow">while</span> (each != NULL) {
<a name="l00755"></a>00755             <span class="keywordflow">if</span> (each-&gt;<a class="code" href="struct_sync_action_data.html#afcaa4a02f141595e243f1be8ff79a3d5">comp</a> == data) each-&gt;<a class="code" href="struct_sync_action_data.html#afcaa4a02f141595e243f1be8ff79a3d5">comp</a> = NULL;
<a name="l00756"></a>00756             each = each-&gt;<a class="code" href="struct_sync_action_data.html#ae24e9863185867798652ec7429afb2c0">next</a>;
<a name="l00757"></a>00757         }
<a name="l00758"></a>00758     }
<a name="l00759"></a>00759     <span class="keywordflow">if</span> (priv-&gt;<a class="code" href="struct_sync_private.html#af2979f2e620ae3bcfdf2d18dd14f31c0">comparesBusy</a> &gt; 0) priv-&gt;<a class="code" href="struct_sync_private.html#af2979f2e620ae3bcfdf2d18dd14f31c0">comparesBusy</a>--;
<a name="l00760"></a>00760     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;data-&gt;hashL);
<a name="l00761"></a>00761     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;data-&gt;hashR);
<a name="l00762"></a>00762     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;data-&gt;cbL);
<a name="l00763"></a>00763     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;data-&gt;cbR);
<a name="l00764"></a>00764     data-&gt;twL = <a class="code" href="_sync_tree_worker_8c.html#a5b7baae8bce01030ed514fd40e6268c5" title="Free the storage for the worker.">SyncTreeWorkerFree</a>(data-&gt;twL);
<a name="l00765"></a>00765     data-&gt;twR = <a class="code" href="_sync_tree_worker_8c.html#a5b7baae8bce01030ed514fd40e6268c5" title="Free the storage for the worker.">SyncTreeWorkerFree</a>(data-&gt;twR);
<a name="l00766"></a>00766     <span class="keywordflow">if</span> (data-&gt;ev != NULL &amp;&amp; root != NULL) {
<a name="l00767"></a>00767         data-&gt;ev-&gt;evdata = NULL;
<a name="l00768"></a>00768         <a class="code" href="schedule_8h.html#a0b636a012b97cc600634684736018fe7" title="Cancel a scheduled event.">ccn_schedule_cancel</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>-&gt;<a class="code" href="structsync__plumbing.html#ab5e574093a95dfb432043980ce9a5e17">sched</a>, data-&gt;ev);
<a name="l00769"></a>00769     }
<a name="l00770"></a>00770     free(data);
<a name="l00771"></a>00771 }
<a name="l00772"></a>00772 
<a name="l00773"></a>00773 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00774"></a><a class="code" href="_sync_actions_8c.html#a6ffcca40b4dd24eda285bddfc24ece7e">00774</a> <a class="code" href="_sync_actions_8c.html#a6ffcca40b4dd24eda285bddfc24ece7e">abortCompare</a>(<span class="keyword">struct</span> SyncCompareData *data, <span class="keywordtype">char</span> *why) {
<a name="l00775"></a>00775     <span class="comment">// this compare failed due to a node fetch or content fetch failure</span>
<a name="l00776"></a>00776     <span class="comment">// we could get repeated failures if we try the same remote node,</span>
<a name="l00777"></a>00777     <span class="comment">// so remove it from the seen remote nodes, then destroy the compare data</span>
<a name="l00778"></a>00778     <span class="keywordflow">if</span> (data == NULL) <span class="keywordflow">return</span>;
<a name="l00779"></a>00779     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = data-&gt;root;
<a name="l00780"></a>00780     <span class="keywordflow">if</span> (root != NULL) {
<a name="l00781"></a>00781         <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.abortCompare&quot;</span>;
<a name="l00782"></a>00782         <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>;
<a name="l00783"></a>00783         <span class="keyword">struct </span><a class="code" href="struct_sync_root_private.html">SyncRootPrivate</a> *priv = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>;
<a name="l00784"></a>00784         <span class="keyword">struct </span><a class="code" href="struct_sync_hash_info_list.html">SyncHashInfoList</a> *list = priv-&gt;<a class="code" href="struct_sync_root_private.html#a7c217e7610fe07ecbf7ad85c2b4785c7">remoteSeen</a>;
<a name="l00785"></a>00785         <span class="keyword">struct </span><a class="code" href="struct_sync_hash_info_list.html">SyncHashInfoList</a> *lag = NULL;
<a name="l00786"></a>00786         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *hash = data-&gt;hashR;
<a name="l00787"></a>00787         <span class="keywordflow">while</span> (list != NULL) {
<a name="l00788"></a>00788             <span class="keyword">struct </span><a class="code" href="struct_sync_hash_info_list.html">SyncHashInfoList</a> *<a class="code" href="struct_sync_hash_info_list.html#a09d3622f803ab21ac48e83f1fafdd643">next</a> = list-&gt;<a class="code" href="struct_sync_hash_info_list.html#a09d3622f803ab21ac48e83f1fafdd643">next</a>;
<a name="l00789"></a>00789             <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = list-&gt;<a class="code" href="struct_sync_hash_info_list.html#a454640fcbb0a9ba9baa38dfe544a71ef">ce</a>;
<a name="l00790"></a>00790             <span class="keywordflow">if</span> (ce != NULL &amp;&amp; <a class="code" href="_sync_util_8c.html#a7fdd3f26c8deb6fc7807c077916e02d6" title="compares two hash codes in charbufs">SyncCompareHash</a>(ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#aba3a8329dde03169d4bb1f369b2d78cf" title="hash used to reach this entry">hash</a>, hash) == 0) {
<a name="l00791"></a>00791                 <span class="comment">// found the failed root, so remove the remote entry</span>
<a name="l00792"></a>00792                 <span class="comment">// if we really needed it it will come back via root advise</span>
<a name="l00793"></a>00793                 <span class="keywordflow">if</span> (base-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l00794"></a>00794                     <span class="comment">// maybe this should be a warning?</span>
<a name="l00795"></a>00795                     <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00796"></a>00796                     <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base,
<a name="l00797"></a>00797                              <span class="stringliteral">&quot;%s, root#%u, remove remote hash %s&quot;</span>,
<a name="l00798"></a>00798                              here, root-&gt;<a class="code" href="struct_sync_root_struct.html#a86cbcbdd2e2d8c30311da406d36c80e5" title="root Id for reporting">rootId</a>, hex);
<a name="l00799"></a>00799                     free(hex);
<a name="l00800"></a>00800                 }
<a name="l00801"></a>00801                 list-&gt;<a class="code" href="struct_sync_hash_info_list.html#a09d3622f803ab21ac48e83f1fafdd643">next</a> = NULL;
<a name="l00802"></a>00802                 list-&gt;<a class="code" href="struct_sync_hash_info_list.html#a454640fcbb0a9ba9baa38dfe544a71ef">ce</a> = NULL;
<a name="l00803"></a>00803                 <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#aa390761ef0ed674d7baf92b1d2ccf2d9" title="the tree worker usage count">busy</a> &gt; 0) ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#aa390761ef0ed674d7baf92b1d2ccf2d9" title="the tree worker usage count">busy</a>--;
<a name="l00804"></a>00804                 <span class="keywordflow">if</span> (lag == NULL) priv-&gt;<a class="code" href="struct_sync_root_private.html#a7c217e7610fe07ecbf7ad85c2b4785c7">remoteSeen</a> = next;
<a name="l00805"></a>00805                 <span class="keywordflow">else</span> lag-&gt;<a class="code" href="struct_sync_hash_info_list.html#a09d3622f803ab21ac48e83f1fafdd643">next</a> = next;
<a name="l00806"></a>00806                 free(list);
<a name="l00807"></a>00807                 <span class="keywordflow">break</span>;
<a name="l00808"></a>00808             }
<a name="l00809"></a>00809             lag = list;
<a name="l00810"></a>00810             list = next;
<a name="l00811"></a>00811         }
<a name="l00812"></a>00812         <span class="keywordflow">if</span> (root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a2813bb28b1559ff71ca56e66d8df63a6" title="Something might be wrong.">CCNL_WARNING</a>)
<a name="l00813"></a>00813             <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, why);
<a name="l00814"></a>00814     }
<a name="l00815"></a>00815     <a class="code" href="_sync_actions_8c.html#aa82d85556d61517fb147eda456d8170f">destroyCompareData</a>(data);
<a name="l00816"></a>00816 }
<a name="l00817"></a>00817 
<a name="l00818"></a>00818 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00819"></a><a class="code" href="_sync_actions_8c.html#aaf9c87ebf674e592c7bcb15aebbe937e">00819</a> <a class="code" href="_sync_actions_8c.html#aaf9c87ebf674e592c7bcb15aebbe937e">extractBuf</a>(<span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *cb, <span class="keyword">struct</span> <a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *nc, <span class="keyword">struct</span> <a class="code" href="struct_sync_node_elem.html">SyncNodeElem</a> *ne) {
<a name="l00820"></a>00820     <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> ds;
<a name="l00821"></a>00821     <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> *d = <a class="code" href="_sync_node_8c.html#a68422d265d86c4cd45315b342f399b4f" title="Makes a decoder from an element.">SyncInitDecoderFromElem</a>(&amp;ds, nc, ne);
<a name="l00822"></a>00822     <a class="code" href="charbuf_8h.html#aa0cf436e626f2e8d0fefeaed179676de">ccn_charbuf_reset</a>(cb);
<a name="l00823"></a>00823     <span class="keywordtype">int</span> res = <a class="code" href="_sync_util_8c.html#ad88a88ea7a19638ca65486387db41a72">SyncAppendElementInner</a>(cb, d);
<a name="l00824"></a>00824     <span class="keywordflow">return</span> res;    
<a name="l00825"></a>00825 }
<a name="l00826"></a>00826 
<a name="l00827"></a>00827 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *
<a name="l00828"></a><a class="code" href="_sync_actions_8c.html#a57765ab975d6321506506421ce05f1be">00828</a> <a class="code" href="_sync_actions_8c.html#a57765ab975d6321506506421ce05f1be">ensureRemoteEntry</a>(<span class="keyword">struct</span> SyncCompareData *data,
<a name="l00829"></a>00829                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * xp,
<a name="l00830"></a>00830                   ssize_t xs) {
<a name="l00831"></a>00831     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.ensureRemoteEntry&quot;</span>;
<a name="l00832"></a>00832     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = data-&gt;root;
<a name="l00833"></a>00833     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = <a class="code" href="_sync_hash_cache_8c.html#abcf5e784c52d971d943bddef80731954" title="based on the raw hash, ensure that a remote cache entry exists ent-&amp;gt;state |= set...">SyncHashEnter</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>, xp, xs, <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381aec73ed0d374163f11f2d715ce0a3c197" title="a remote hash has been seen">SyncHashState_remote</a>);
<a name="l00834"></a>00834     <span class="keywordflow">if</span> (ce == NULL) {
<a name="l00835"></a>00835         <span class="comment">// and why did this fail?</span>
<a name="l00836"></a>00836         <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad enter&quot;</span>, __LINE__);
<a name="l00837"></a>00837         <span class="keywordflow">return</span> ce;
<a name="l00838"></a>00838     }
<a name="l00839"></a>00839     <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a9e849b0fed91e850763db20a54956128" title="a local node exists">SyncHashState_local</a>) <a class="code" href="_sync_actions_8c.html#a8d981d346c90e43d3f8d9e52077e28ca">setCovered</a>(ce);
<a name="l00840"></a>00840     <span class="keywordflow">return</span> ce;
<a name="l00841"></a>00841 }
<a name="l00842"></a>00842 
<a name="l00843"></a>00843 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *
<a name="l00844"></a><a class="code" href="_sync_actions_8c.html#a7bfdb2b3f3276a018144a52daaa6122b">00844</a> <a class="code" href="_sync_actions_8c.html#a7bfdb2b3f3276a018144a52daaa6122b">cacheEntryForElem</a>(<span class="keyword">struct</span> SyncCompareData *data,
<a name="l00845"></a>00845                   <span class="keyword">struct</span> <a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *nc,
<a name="l00846"></a>00846                   <span class="keyword">struct</span> <a class="code" href="struct_sync_node_elem.html">SyncNodeElem</a> *ne,
<a name="l00847"></a>00847                   <span class="keywordtype">int</span> remote) {
<a name="l00848"></a>00848     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.cacheEntryForElem&quot;</span>;
<a name="l00849"></a>00849     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = data-&gt;root;
<a name="l00850"></a>00850     <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> ds;
<a name="l00851"></a>00851     <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> *d = <a class="code" href="_sync_node_8c.html#a2c3c4e8ac29c16de51ab89101c57c84e" title="Makes a decoder from an offset range using the node charbuf.">SyncInitDecoderFromOffset</a>(&amp;ds, nc,
<a name="l00852"></a>00852                                                           ne-&gt;<a class="code" href="struct_sync_node_elem.html#a20ccaf134fbf6330b2da16f33b313a05" title="start of element encoding">start</a>,
<a name="l00853"></a>00853                                                           ne-&gt;<a class="code" href="struct_sync_node_elem.html#ac5994b53656f2c5fc163770a1805f00e" title="stop of element encoding">stop</a>);
<a name="l00854"></a>00854     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * xp = NULL;
<a name="l00855"></a>00855     ssize_t xs = 0;
<a name="l00856"></a>00856     <a class="code" href="_sync_util_8c.html#a530e9d73b66665fcb2801436189b76cc" title="finds the hash code, storing the pointer to *xp and the length to *xs if the hash...">SyncGetHashPtr</a>(d, &amp;xp, &amp;xs);
<a name="l00857"></a>00857     <span class="keywordflow">if</span> (xs == 0 || xp == NULL) {
<a name="l00858"></a>00858         <span class="comment">// no hash?  this could be a problem</span>
<a name="l00859"></a>00859         <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;no hash&quot;</span>, __LINE__);
<a name="l00860"></a>00860         <span class="keywordflow">return</span> NULL;
<a name="l00861"></a>00861     }
<a name="l00862"></a>00862     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = NULL;
<a name="l00863"></a>00863     <span class="keywordflow">if</span> (remote &gt; 0) {
<a name="l00864"></a>00864         <span class="comment">// the entry should be remote</span>
<a name="l00865"></a>00865         ce = <a class="code" href="_sync_actions_8c.html#a57765ab975d6321506506421ce05f1be">ensureRemoteEntry</a>(data, xp, xs);
<a name="l00866"></a>00866     } <span class="keywordflow">else</span> {
<a name="l00867"></a>00867         <span class="comment">// local entry, fetch it if missing</span>
<a name="l00868"></a>00868         ce = <a class="code" href="_sync_hash_cache_8c.html#a15c6eafb71bb631fde85a2424f5ac449" title="lookup a full hash in a hash table (raw contents, no tag)">SyncHashLookup</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>, xp, xs);
<a name="l00869"></a>00869         <span class="keywordflow">if</span> (<a class="code" href="_sync_hash_cache_8c.html#a88b8496fee4324b2359f23e3c6dd9472" title="fetches the cache entry to be eligible, ce != NULL &amp;amp;&amp;amp; ce-&amp;gt;ncL != NULL...">SyncCacheEntryFetch</a>(ce) &lt; 0) {
<a name="l00870"></a>00870             <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad fetch&quot;</span>, __LINE__);
<a name="l00871"></a>00871             <span class="keywordflow">return</span> NULL;
<a name="l00872"></a>00872         }
<a name="l00873"></a>00873     }
<a name="l00874"></a>00874     <span class="keywordflow">if</span> (ce == NULL) {
<a name="l00875"></a>00875         <span class="comment">// this entry should already exist</span>
<a name="l00876"></a>00876         <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad lookup&quot;</span>, __LINE__);
<a name="l00877"></a>00877         <span class="keywordflow">return</span> ce;
<a name="l00878"></a>00878     }
<a name="l00879"></a>00879     ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a6861960908cc217b639d3f1af6bbc520" title="time when entry last used in compare">lastUsed</a> = data-&gt;lastEnter;
<a name="l00880"></a>00880     <span class="keywordflow">return</span> ce;
<a name="l00881"></a>00881 }
<a name="l00882"></a>00882 
<a name="l00883"></a>00883 <span class="comment">// callback for when an interest gets a reply</span>
<a name="l00884"></a>00884 <span class="comment">// used when fetching a remote content object by explicit name</span>
<a name="l00885"></a>00885 <span class="comment">// or when fetching a remote node</span>
<a name="l00886"></a>00886 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a>
<a name="l00887"></a><a class="code" href="_sync_actions_8c.html#ab3bc73d83d698750be68d3a6239fbc61">00887</a> <a class="code" href="_sync_actions_8c.html#ab3bc73d83d698750be68d3a6239fbc61">SyncRemoteFetchResponse</a>(<span class="keyword">struct</span> <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *selfp,
<a name="l00888"></a>00888                         <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92" title="This tells what kind of event the upcall is handling.">ccn_upcall_kind</a> kind,
<a name="l00889"></a>00889                         <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info) {
<a name="l00890"></a>00890     <span class="keyword">static</span> <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.SyncRemoteFetchResponse&quot;</span>;
<a name="l00891"></a>00891     <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *data = selfp-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a>;
<a name="l00892"></a>00892     <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a> ret = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcadadb47635316f12c6542c33cebcfa727" title="normal upcall return">CCN_UPCALL_RESULT_OK</a>;
<a name="l00893"></a>00893     <span class="keywordflow">switch</span> (kind) {
<a name="l00894"></a>00894         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92ad00afdf8a89c718f4c451600b115b5e0" title="handler is about to be deregistered">CCN_UPCALL_FINAL</a>:
<a name="l00895"></a>00895             selfp-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a> = <a class="code" href="_sync_actions_8c.html#a9826ac9a64ba2f80ef24985bee419929">destroyActionData</a>(data);
<a name="l00896"></a>00896             free(selfp);
<a name="l00897"></a>00897             <span class="keywordflow">break</span>;
<a name="l00898"></a>00898         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a8db121649c55820013bfaaf65e436f5c" title="content that has not been verified">CCN_UPCALL_CONTENT_UNVERIFIED</a>:
<a name="l00899"></a>00899             <span class="comment">// TBD: fix this when we can actually verify</span>
<a name="l00900"></a>00900             <span class="comment">// return CCN_UPCALL_RESULT_VERIFY;</span>
<a name="l00901"></a>00901         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92aa96e60c7c64a5a65145b918cf6fcb4b4" title="verification has not been attempted">CCN_UPCALL_CONTENT_RAW</a>:
<a name="l00902"></a>00902         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a1b0d17f15edd2e43d9a026d19498ab7c" title="key has not been fetched">CCN_UPCALL_CONTENT_KEYMISSING</a>:
<a name="l00903"></a>00903         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a3c7ef9861eb5ba1529b4d05630e83c88" title="interest timed out">CCN_UPCALL_INTEREST_TIMED_OUT</a>:
<a name="l00904"></a>00904         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a28260b0a25b7046e6930f0b13a718db0" title="incoming verified content">CCN_UPCALL_CONTENT</a>: {
<a name="l00905"></a>00905             <span class="keywordflow">if</span> (data == NULL) <span class="keywordflow">break</span>;
<a name="l00906"></a>00906             <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = data-&gt;<a class="code" href="struct_sync_action_data.html#aec2fc78ddb23d1c2bc5f51841e4a1b07">root</a>;
<a name="l00907"></a>00907             <span class="keyword">struct </span>SyncCompareData *comp = data-&gt;<a class="code" href="struct_sync_action_data.html#afcaa4a02f141595e243f1be8ff79a3d5">comp</a>;
<a name="l00908"></a>00908             <span class="keywordflow">if</span> (root == NULL) <span class="keywordflow">break</span>;
<a name="l00909"></a>00909             <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l00910"></a>00910             <span class="keyword">struct </span><a class="code" href="struct_sync_root_stats.html">SyncRootStats</a> *stats = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a38e2e743a14abac78e109da409dfd072">stats</a>;
<a name="l00911"></a>00911             <span class="keywordtype">size_t</span> bytes = 0;
<a name="l00912"></a>00912             <span class="keywordtype">int</span> faux = <a class="code" href="_sync_actions_8c.html#af1d3bf7c6863a87ad17a9f27cda5e9e6">fauxError</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>);
<a name="l00913"></a>00913             int64_t now = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l00914"></a>00914             <span class="keywordflow">if</span> (info != NULL &amp;&amp; info-&gt;<a class="code" href="structccn__upcall__info.html#a5483525206dfb80f831040d0d9602906">pco</a> != NULL &amp;&amp; faux == 0
<a name="l00915"></a>00915                 &amp;&amp; kind != <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a3c7ef9861eb5ba1529b4d05630e83c88" title="interest timed out">CCN_UPCALL_INTEREST_TIMED_OUT</a>)
<a name="l00916"></a>00916                 bytes = info-&gt;<a class="code" href="structccn__upcall__info.html#a5483525206dfb80f831040d0d9602906">pco</a>-&gt;<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387a1d25adf694c64b4ae597b26abe6b30fc">CCN_PCO_E</a>];
<a name="l00917"></a>00917             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l00918"></a>00918                 <span class="keywordtype">char</span> temp[64];
<a name="l00919"></a>00919                 <span class="keywordtype">char</span> *ns = <span class="stringliteral">&quot;node&quot;</span>;
<a name="l00920"></a>00920                 <span class="keywordtype">char</span> *ks = <span class="stringliteral">&quot;ok&quot;</span>;
<a name="l00921"></a>00921                 <span class="keywordflow">if</span> (faux) ks = <span class="stringliteral">&quot;faux error&quot;</span>;
<a name="l00922"></a>00922                 <span class="keywordflow">if</span> (data-&gt;<a class="code" href="struct_sync_action_data.html#ad64d193a1ef56426675d4042263da5c5">kind</a> == <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692a88e2022363f5e282355841039623cf19" title="general content">SRI_Kind_Content</a>) ns = <span class="stringliteral">&quot;content&quot;</span>;
<a name="l00923"></a>00923                 <span class="keywordflow">if</span> (kind == <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a3c7ef9861eb5ba1529b4d05630e83c88" title="interest timed out">CCN_UPCALL_INTEREST_TIMED_OUT</a>) ks = <span class="stringliteral">&quot;timeout!&quot;</span>;
<a name="l00924"></a>00924                 int64_t dt = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(data-&gt;<a class="code" href="struct_sync_action_data.html#a79f3e380339ba613e01440cf2b6611fc">startTime</a>, now);
<a name="l00925"></a>00925                 dt = (dt + 500) / 1000;
<a name="l00926"></a>00926                 <span class="keywordflow">if</span> (bytes &gt; 0) 
<a name="l00927"></a>00927                     snprintf(temp, <span class="keyword">sizeof</span>(temp),
<a name="l00928"></a>00928                              <span class="stringliteral">&quot;%s, %s, %d.%03d secs, %u bytes&quot;</span>,
<a name="l00929"></a>00929                              ns, ks, (<span class="keywordtype">int</span>) (dt / 1000), (<span class="keywordtype">int</span>) (dt % 1000),
<a name="l00930"></a>00930                              (<span class="keywordtype">unsigned</span>) bytes);
<a name="l00931"></a>00931                 <span class="keywordflow">else</span>
<a name="l00932"></a>00932                     snprintf(temp, <span class="keyword">sizeof</span>(temp),
<a name="l00933"></a>00933                              <span class="stringliteral">&quot;%s, %s, %d.%03d secs&quot;</span>,
<a name="l00934"></a>00934                              ns, ks, (<span class="keywordtype">int</span>) (dt / 1000), (<span class="keywordtype">int</span>) (dt % 1000));
<a name="l00935"></a>00935                 <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, temp, data-&gt;<a class="code" href="struct_sync_action_data.html#a74202828f01407a2254b56ba73bdfd23">prefix</a>);
<a name="l00936"></a>00936             }
<a name="l00937"></a>00937             
<a name="l00938"></a>00938             <span class="keywordflow">switch</span> (data-&gt;<a class="code" href="struct_sync_action_data.html#ad64d193a1ef56426675d4042263da5c5">kind</a>) {
<a name="l00939"></a>00939                 <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692a88e2022363f5e282355841039623cf19" title="general content">SRI_Kind_Content</a>: {
<a name="l00940"></a>00940                     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = data-&gt;<a class="code" href="struct_sync_action_data.html#aec2fc78ddb23d1c2bc5f51841e4a1b07">root</a>;
<a name="l00941"></a>00941                     <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>;
<a name="l00942"></a>00942                     <span class="keyword">struct </span><a class="code" href="structsync__plumbing.html">sync_plumbing</a> *sd = base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>;
<a name="l00943"></a>00943                     <span class="keywordflow">if</span> (sd-&gt;<a class="code" href="structsync__plumbing.html#a4978a2b8be6bda0393274d9c107b7436">client_methods</a>-&gt;<a class="code" href="structsync__plumbing__client__methods.html#adb5dd1f668aa3aaf41d4607615a00a55">r_sync_upcall_store</a> != NULL
<a name="l00944"></a>00944                         &amp;&amp; bytes &gt; 0) {
<a name="l00945"></a>00945                         <span class="comment">// we fetched the content, so store it to the repo</span>
<a name="l00946"></a>00946                         <span class="comment">// if no r_sync_upcall_store method, treat as failure</span>
<a name="l00947"></a>00947                         ret = sd-&gt;<a class="code" href="structsync__plumbing.html#a4978a2b8be6bda0393274d9c107b7436">client_methods</a>-&gt;<a class="code" href="structsync__plumbing__client__methods.html#adb5dd1f668aa3aaf41d4607615a00a55">r_sync_upcall_store</a>(sd, <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a28260b0a25b7046e6930f0b13a718db0" title="incoming verified content">CCN_UPCALL_CONTENT</a>, info);
<a name="l00948"></a>00948                         <span class="keywordflow">if</span> (ret &lt; 0) {
<a name="l00949"></a>00949                             <span class="comment">// note this specific failure cause</span>
<a name="l00950"></a>00950                             bytes = 0;
<a name="l00951"></a>00951                             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a1aa8c032da69595d9b27357c2bb83da9" title="Severe errors.">CCNL_SEVERE</a>)
<a name="l00952"></a>00952                                 <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;content store&quot;</span>, __LINE__);
<a name="l00953"></a>00953                         } <span class="keywordflow">else</span> {
<a name="l00954"></a>00954                             <span class="comment">// we need to update the tree, too</span>
<a name="l00955"></a>00955                             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>)
<a name="l00956"></a>00956                                 <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;content stored&quot;</span>);
<a name="l00957"></a>00957                         }
<a name="l00958"></a>00958                     }
<a name="l00959"></a>00959                     <span class="keywordflow">if</span> (comp != NULL &amp;&amp; comp-&gt;contentFetchBusy &gt; 0)
<a name="l00960"></a>00960                         comp-&gt;contentFetchBusy--;
<a name="l00961"></a>00961                     <span class="keywordflow">if</span> (bytes &gt; 0) {
<a name="l00962"></a>00962                         <span class="comment">// content fetch wins</span>
<a name="l00963"></a>00963                         stats-&gt;<a class="code" href="struct_sync_root_stats.html#a8466efba3c5e156ff20d7109364f2050">contentFetchReceived</a>++;
<a name="l00964"></a>00964                         stats-&gt;<a class="code" href="struct_sync_root_stats.html#a3a79c4266d4f5e30ff25fd7e5a370448">contentFetchBytes</a> += bytes;
<a name="l00965"></a>00965                         <span class="keywordflow">if</span> (comp != NULL)
<a name="l00966"></a>00966                             comp-&gt;lastFetchOK = now;
<a name="l00967"></a>00967                     } <span class="keywordflow">else</span> {
<a name="l00968"></a>00968                         <span class="comment">// content fetch failed</span>
<a name="l00969"></a>00969                         <span class="keywordflow">if</span> (kind == <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a3c7ef9861eb5ba1529b4d05630e83c88" title="interest timed out">CCN_UPCALL_INTEREST_TIMED_OUT</a>)
<a name="l00970"></a>00970                             stats-&gt;<a class="code" href="struct_sync_root_stats.html#a7fce1be08dea17047de0cd04e225c0b0">contentFetchTimeout</a>++;
<a name="l00971"></a>00971                         stats-&gt;<a class="code" href="struct_sync_root_stats.html#a8304620e513c3f4e711228e67b49268f">contentFetchFailed</a>++;
<a name="l00972"></a>00972                         <span class="keywordflow">if</span> (comp != NULL) {
<a name="l00973"></a>00973                             <span class="comment">// remember that this one failed</span>
<a name="l00974"></a>00974                             comp-&gt;contentFetchFailed++;
<a name="l00975"></a>00975                             <span class="keywordflow">if</span> (!<a class="code" href="_sync_actions_8c.html#a322cb98032f017f439ac04b1df79627b">moveActionData</a>(data, <a class="code" href="_sync_actions_8h.html#a2372ce16c57f6d11f0da968c3156350baff5b24fc2a58337eb7579685348aebc9">SyncActionState_error</a>))
<a name="l00976"></a>00976                                 <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;moveActionData&quot;</span>, __LINE__);
<a name="l00977"></a>00977                             selfp-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a> = NULL;
<a name="l00978"></a>00978                         }
<a name="l00979"></a>00979                     }
<a name="l00980"></a>00980                     <span class="comment">// wake up CompareAction to handle more content</span>
<a name="l00981"></a>00981                     <a class="code" href="_sync_actions_8c.html#ad2d955864020d9986169c8574244c472">kickCompare</a>(comp, data);
<a name="l00982"></a>00982                     <span class="keywordflow">break</span>;
<a name="l00983"></a>00983                 }
<a name="l00984"></a>00984                 <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692ab2b6e276363d6bbb97dbbe40b695006b" title="node fetch request">SRI_Kind_NodeFetch</a>: {
<a name="l00985"></a>00985                     <span class="comment">// node fetch reply</span>
<a name="l00986"></a>00986                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *xp = data-&gt;<a class="code" href="struct_sync_action_data.html#af8df0a4ba0bd30cd13c1976985e8d7f1">hash</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>;
<a name="l00987"></a>00987                     ssize_t xs = data-&gt;<a class="code" href="struct_sync_action_data.html#af8df0a4ba0bd30cd13c1976985e8d7f1">hash</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>;
<a name="l00988"></a>00988                     <span class="keywordtype">char</span> *highWhy = <span class="stringliteral">&quot;??&quot;</span>;
<a name="l00989"></a>00989                     <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(xp, xs);
<a name="l00990"></a>00990                     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = <a class="code" href="_sync_hash_cache_8c.html#a15c6eafb71bb631fde85a2424f5ac449" title="lookup a full hash in a hash table (raw contents, no tag)">SyncHashLookup</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>, xp, xs);
<a name="l00991"></a>00991                     <span class="keywordflow">if</span> (bytes &lt;= 0) {
<a name="l00992"></a>00992                         <span class="comment">// did not get the node at all</span>
<a name="l00993"></a>00993                         highWhy = <span class="stringliteral">&quot;no fetch&quot;</span>;
<a name="l00994"></a>00994                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ce != NULL &amp;&amp; (<a class="code" href="_sync_actions_8c.html#a870761b1ea0620fc7bf78e6a7c4a8fb3">isCovered</a>(ce) || ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a> != NULL)) {
<a name="l00995"></a>00995                         <span class="comment">// there was a race, and we no longer need this</span>
<a name="l00996"></a>00996                         <span class="comment">// for stats, count this as a success</span>
<a name="l00997"></a>00997                         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l00998"></a>00998                             <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, <span class="stringliteral">&quot;remote node covered&quot;</span>, hex);
<a name="l00999"></a>00999                         }
<a name="l01000"></a>01000                         highWhy = <span class="stringliteral">&quot;covered&quot;</span>;
<a name="l01001"></a>01001                     } <span class="keywordflow">else</span> {
<a name="l01002"></a>01002                         <span class="comment">// we actually need the node that arrived</span>
<a name="l01003"></a>01003                         <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *ncR = <a class="code" href="_sync_actions_8c.html#aef266441ec21334a137f07c70f706859">extractNode</a>(root, info);
<a name="l01004"></a>01004                         <span class="keywordflow">if</span> (ncR == NULL) {
<a name="l01005"></a>01005                             <span class="comment">// decoding error, so can&#39;t use</span>
<a name="l01006"></a>01006                             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a1aa8c032da69595d9b27357c2bb83da9" title="Severe errors.">CCNL_SEVERE</a>)
<a name="l01007"></a>01007                                 <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, <span class="stringliteral">&quot;extractNode failed&quot;</span>, hex);
<a name="l01008"></a>01008                             bytes = 0;
<a name="l01009"></a>01009                             highWhy = <span class="stringliteral">&quot;extract failed&quot;</span>;
<a name="l01010"></a>01010                         } <span class="keywordflow">else</span> {
<a name="l01011"></a>01011                             <span class="comment">// the entry can now be completed</span>
<a name="l01012"></a>01012                             ce = <a class="code" href="_sync_hash_cache_8c.html#abcf5e784c52d971d943bddef80731954" title="based on the raw hash, ensure that a remote cache entry exists ent-&amp;gt;state |= set...">SyncHashEnter</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>, xp, xs, <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381aec73ed0d374163f11f2d715ce0a3c197" title="a remote hash has been seen">SyncHashState_remote</a>);
<a name="l01013"></a>01013                             ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a> = ncR;
<a name="l01014"></a>01014                             <a class="code" href="_sync_node_8c.html#aab2c27ab0d33e00e6bfe576bd9142c0a" title="Increments the reference count.">SyncNodeIncRC</a>(ncR);
<a name="l01015"></a>01015                             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l01016"></a>01016                                 <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, <span class="stringliteral">&quot;remote node entered&quot;</span>, hex);
<a name="l01017"></a>01017                             }
<a name="l01018"></a>01018                             <span class="keywordflow">if</span> (comp == NULL) {
<a name="l01019"></a>01019                                 <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#af91ddb985e8b28b1f1d0c74c7b6385c9" title="Configuration errors.">CCNL_ERROR</a>)
<a name="l01020"></a>01020                                     <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;remote node comp == NULL&quot;</span>);
<a name="l01021"></a>01021                             }
<a name="l01022"></a>01022                             highWhy = <span class="stringliteral">&quot;entered&quot;</span>;
<a name="l01023"></a>01023                         }
<a name="l01024"></a>01024                         
<a name="l01025"></a>01025                     }
<a name="l01026"></a>01026                     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a> &amp;&amp; <a class="code" href="_sync_actions_8c.html#ad990ae99fb88eb7b8bb2864dd04a459f">showHighLevel</a>) {
<a name="l01027"></a>01027                         <span class="keywordtype">char</span> temp[64];
<a name="l01028"></a>01028                         snprintf(temp, <span class="keyword">sizeof</span>(temp),
<a name="l01029"></a>01029                                  <span class="stringliteral">&quot;reply received, %s&quot;</span>,
<a name="l01030"></a>01030                                  highWhy);
<a name="l01031"></a>01031                         <a class="code" href="_sync_actions_8c.html#a677c4508262ab00cdea51b16065eac17">showCacheEntry1</a>(root, <span class="stringliteral">&quot;Sync.$NodeFetch&quot;</span>, temp, ce);
<a name="l01032"></a>01032                     }
<a name="l01033"></a>01033                     
<a name="l01034"></a>01034                     <span class="keywordflow">if</span> (comp != NULL &amp;&amp; comp-&gt;nodeFetchBusy &gt; 0)
<a name="l01035"></a>01035                         comp-&gt;nodeFetchBusy--;
<a name="l01036"></a>01036                     <span class="keywordflow">if</span> (bytes &gt; 0) {
<a name="l01037"></a>01037                         <span class="comment">// node fetch wins</span>
<a name="l01038"></a>01038                         stats-&gt;<a class="code" href="struct_sync_root_stats.html#a3c59f3f4c264cf4a1ba48b1fd860d4ab">nodeFetchReceived</a>++;
<a name="l01039"></a>01039                         stats-&gt;<a class="code" href="struct_sync_root_stats.html#ac91e71cdcb8ef29a62e2b2c0bdf5b85f">nodeFetchBytes</a> += bytes;
<a name="l01040"></a>01040                         <span class="keywordflow">if</span> (comp != NULL)
<a name="l01041"></a>01041                             comp-&gt;lastFetchOK = now;
<a name="l01042"></a>01042                     } <span class="keywordflow">else</span> {
<a name="l01043"></a>01043                         <span class="comment">// node fetch fails</span>
<a name="l01044"></a>01044                         <span class="keywordflow">if</span> (kind == <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a3c7ef9861eb5ba1529b4d05630e83c88" title="interest timed out">CCN_UPCALL_INTEREST_TIMED_OUT</a>)
<a name="l01045"></a>01045                             stats-&gt;<a class="code" href="struct_sync_root_stats.html#ab8a264cc1f61ac6854e96dfb1a22ff80">nodeFetchTimeout</a>++;
<a name="l01046"></a>01046                         <span class="keywordflow">else</span> stats-&gt;<a class="code" href="struct_sync_root_stats.html#a083403051f2d7faf56c5cb0b887f9b60">nodeFetchFailed</a>++;
<a name="l01047"></a>01047                         <span class="keywordflow">if</span> (comp != NULL) {
<a name="l01048"></a>01048                             <span class="comment">// remember that this one failed</span>
<a name="l01049"></a>01049                             <span class="keywordflow">if</span> (!<a class="code" href="_sync_actions_8c.html#a322cb98032f017f439ac04b1df79627b">moveActionData</a>(data, <a class="code" href="_sync_actions_8h.html#a2372ce16c57f6d11f0da968c3156350baff5b24fc2a58337eb7579685348aebc9">SyncActionState_error</a>))
<a name="l01050"></a>01050                                 <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;moveActionData&quot;</span>, __LINE__);
<a name="l01051"></a>01051                             comp-&gt;nodeFetchFailed++;
<a name="l01052"></a>01052                             selfp-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a> = NULL;
<a name="l01053"></a>01053                         }
<a name="l01054"></a>01054                     }
<a name="l01055"></a>01055                     <span class="keywordflow">if</span> (ce != NULL &amp;&amp; (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a543f8cfea4a3c99237abeac7e563b90b" title="remote node is being fetched">SyncHashState_fetching</a>))
<a name="l01056"></a>01056                         <span class="comment">// we are no longer fetching this node</span>
<a name="l01057"></a>01057                         ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> -= <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a543f8cfea4a3c99237abeac7e563b90b" title="remote node is being fetched">SyncHashState_fetching</a>;
<a name="l01058"></a>01058                     <a class="code" href="_sync_actions_8c.html#ad2d955864020d9986169c8574244c472">kickCompare</a>(comp, data);
<a name="l01059"></a>01059                     free(hex);
<a name="l01060"></a>01060                     <span class="keywordflow">break</span>;
<a name="l01061"></a>01061                 }
<a name="l01062"></a>01062                 <span class="keywordflow">default</span>:
<a name="l01063"></a>01063                     <span class="comment">// SHOULD NOT HAPPEN</span>
<a name="l01064"></a>01064                     ret = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>;
<a name="l01065"></a>01065                     <span class="keywordflow">break</span>;
<a name="l01066"></a>01066             }
<a name="l01067"></a>01067             <span class="keywordflow">break</span>;
<a name="l01068"></a>01068         }
<a name="l01069"></a>01069         <span class="keywordflow">default</span>:
<a name="l01070"></a>01070             <span class="comment">// SHOULD NOT HAPPEN</span>
<a name="l01071"></a>01071             ret = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>;
<a name="l01072"></a>01072             <span class="keywordflow">break</span>;
<a name="l01073"></a>01073     }
<a name="l01074"></a>01074     <span class="keywordflow">return</span> ret;
<a name="l01075"></a>01075 }
<a name="l01076"></a>01076 
<a name="l01077"></a>01077 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01078"></a><a class="code" href="_sync_actions_8c.html#a3aa9439bfcf15d6b0d01ebd855d2f02b">01078</a> <a class="code" href="_sync_actions_8c.html#a3aa9439bfcf15d6b0d01ebd855d2f02b">SyncStartNodeFetch</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root,
<a name="l01079"></a>01079                    <span class="keyword">struct</span> <a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce,
<a name="l01080"></a>01080                    <span class="keyword">struct</span> SyncCompareData *comp) {
<a name="l01081"></a>01081     <span class="keyword">static</span> <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.SyncStartNodeFetch&quot;</span>;
<a name="l01082"></a>01082     <span class="keyword">enum</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692">SyncRegisterActionKind</a> <a class="code" href="struct_sync_node_composite.html#aaee23facd1659e09af651d13fda65616" title="kind bits">kind</a> = <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692ab2b6e276363d6bbb97dbbe40b695006b" title="node fetch request">SRI_Kind_NodeFetch</a>;
<a name="l01083"></a>01083     <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>;
<a name="l01084"></a>01084     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = base-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l01085"></a>01085     <span class="keyword">struct </span>ccn *ccn = base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>-&gt;<a class="code" href="structsync__plumbing.html#a5c7f66f36ab1eb5de840d06ab1da6e74">ccn</a>;
<a name="l01086"></a>01086     <span class="keywordflow">if</span> (ccn == NULL)
<a name="l01087"></a>01087         <span class="keywordflow">return</span> <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad ccn handle&quot;</span>, __LINE__);
<a name="l01088"></a>01088     <span class="comment">// first, check for existing fetch of same hash</span>
<a name="l01089"></a>01089     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *hash = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#aba3a8329dde03169d4bb1f369b2d78cf" title="hash used to reach this entry">hash</a>;
<a name="l01090"></a>01090     <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *data = root-&gt;<a class="code" href="struct_sync_root_struct.html#a17d4b18dfe2d8907b5fe1715699cb353" title="data for pending interests">actions</a>;
<a name="l01091"></a>01091     <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a543f8cfea4a3c99237abeac7e563b90b" title="remote node is being fetched">SyncHashState_fetching</a>)
<a name="l01092"></a>01092         <span class="comment">// already busy</span>
<a name="l01093"></a>01093         <span class="keywordflow">return</span> 0;
<a name="l01094"></a>01094     <span class="keywordflow">while</span> (data != NULL) {
<a name="l01095"></a>01095         <span class="keywordflow">if</span> (data-&gt;<a class="code" href="struct_sync_action_data.html#ad64d193a1ef56426675d4042263da5c5">kind</a> == kind &amp;&amp; <a class="code" href="_sync_util_8c.html#a7fdd3f26c8deb6fc7807c077916e02d6" title="compares two hash codes in charbufs">SyncCompareHash</a>(data-&gt;<a class="code" href="struct_sync_action_data.html#af8df0a4ba0bd30cd13c1976985e8d7f1">hash</a>, hash) == 0)
<a name="l01096"></a>01096             <span class="keywordflow">return</span> 0;
<a name="l01097"></a>01097         data = data-&gt;<a class="code" href="struct_sync_action_data.html#ae24e9863185867798652ec7429afb2c0">next</a>;
<a name="l01098"></a>01098     }
<a name="l01099"></a>01099     
<a name="l01100"></a>01100     <span class="keyword">struct </span><a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *action = <a class="code" href="_sync_macros_8h.html#ab707d3cfcb52f2e2f819771123942548">NEW_STRUCT</a>(1, <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a>);
<a name="l01101"></a>01101     data = <a class="code" href="_sync_actions_8c.html#a16e2f339bd3d0141bdc0fbf8a128ff26">newActionData</a>(kind);
<a name="l01102"></a>01102     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = <a class="code" href="_sync_actions_8c.html#adf89fd412f0e65a80e9a7e961f7d6b13">constructCommandPrefix</a>(root, kind);
<a name="l01103"></a>01103     <span class="keywordtype">int</span> res = -1;
<a name="l01104"></a>01104     <span class="keywordtype">char</span> *why = <span class="stringliteral">&quot;constructCommandPrefix&quot;</span>;
<a name="l01105"></a>01105     <span class="keywordflow">if</span> (name != NULL) {
<a name="l01106"></a>01106         data-&gt;<a class="code" href="struct_sync_action_data.html#ac2ecd62add48955272a5d9402d4532e4">skipToHash</a> = <a class="code" href="_sync_util_8c.html#aa1be3053fdf3e2122f3582e74ff8b694">SyncComponentCount</a>(name);
<a name="l01107"></a>01107         <a class="code" href="ccn_8h.html#a3f4f614f38ae77dccb4099e982c646f8" title="Add a Component to a Name.">ccn_name_append</a>(name, hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01108"></a>01108         data-&gt;<a class="code" href="struct_sync_action_data.html#a74202828f01407a2254b56ba73bdfd23">prefix</a> = name;
<a name="l01109"></a>01109         data-&gt;<a class="code" href="struct_sync_action_data.html#af8df0a4ba0bd30cd13c1976985e8d7f1">hash</a> = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01110"></a>01110         <a class="code" href="charbuf_8h.html#aca88638b2e81602eb4a1da9be923dad7">ccn_charbuf_append_charbuf</a>(data-&gt;<a class="code" href="struct_sync_action_data.html#af8df0a4ba0bd30cd13c1976985e8d7f1">hash</a>, hash);
<a name="l01111"></a>01111         data-&gt;<a class="code" href="struct_sync_action_data.html#afcaa4a02f141595e243f1be8ff79a3d5">comp</a> = comp;
<a name="l01112"></a>01112         action-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a> = data;
<a name="l01113"></a>01113         action-&gt;<a class="code" href="structccn__closure.html#a48dca74271023e0caf287ad31dd1e66c" title="client-supplied handler">p</a> = &amp;<a class="code" href="_sync_actions_8c.html#ab3bc73d83d698750be68d3a6239fbc61">SyncRemoteFetchResponse</a>;
<a name="l01114"></a>01114         
<a name="l01115"></a>01115         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *<span class="keyword">template</span> = <a class="code" href="_sync_util_8c.html#a72ca03631d566369877fc92b0819d720" title="given a spec for the desired fields (scope, lifetime, maxSuffix, child are omitted...">SyncGenInterest</a>(NULL,
<a name="l01116"></a>01116                                                        root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a043c6fc891ececbddbc4b446ecd5bc31">syncScope</a>,
<a name="l01117"></a>01117                                                        base-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>-&gt;<a class="code" href="struct_sync_private.html#aef32dcbbdb91811e0931637faa26a1d5">fetchLifetime</a>,
<a name="l01118"></a>01118                                                        -1, 1, NULL);
<a name="l01119"></a>01119         res = <a class="code" href="ccn_8h.html#a9f2d6eede46c8aac3dbb4b6e22e1d492">ccn_express_interest</a>(ccn, name, action, <span class="keyword">template</span>);
<a name="l01120"></a>01120         <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01121"></a>01121             why = <span class="stringliteral">&quot;ccn_express_interest&quot;</span>;
<a name="l01122"></a>01122             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a1aa8c032da69595d9b27357c2bb83da9" title="Severe errors.">CCNL_SEVERE</a>) {
<a name="l01123"></a>01123                 <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01124"></a>01124                 <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, <span class="stringliteral">&quot;failed to express interest&quot;</span>, hex);
<a name="l01125"></a>01125                 free(hex);
<a name="l01126"></a>01126             }
<a name="l01127"></a>01127         } <span class="keywordflow">else</span> {
<a name="l01128"></a>01128             root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a38e2e743a14abac78e109da409dfd072">stats</a>-&gt;<a class="code" href="struct_sync_root_stats.html#ae77e159f348e2d93114ae4ed40ccf5ad">nodeFetchSent</a>++;
<a name="l01129"></a>01129             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l01130"></a>01130                 <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01131"></a>01131                 <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, <span class="stringliteral">&quot;fetching&quot;</span>, hex);
<a name="l01132"></a>01132                 free(hex);
<a name="l01133"></a>01133                 <span class="keywordflow">if</span> (<a class="code" href="_sync_actions_8c.html#ad990ae99fb88eb7b8bb2864dd04a459f">showHighLevel</a>)
<a name="l01134"></a>01134                     <a class="code" href="_sync_actions_8c.html#a677c4508262ab00cdea51b16065eac17">showCacheEntry1</a>(root, <span class="stringliteral">&quot;Sync.$NodeFetch&quot;</span>, <span class="stringliteral">&quot;interest sent&quot;</span>, ce);
<a name="l01135"></a>01135             }
<a name="l01136"></a>01136         }
<a name="l01137"></a>01137         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;<span class="keyword">template</span>);
<a name="l01138"></a>01138     }
<a name="l01139"></a>01139     <span class="keywordflow">if</span> (res &gt;= 0) {
<a name="l01140"></a>01140         <span class="comment">// link the request into the root</span>
<a name="l01141"></a>01141         <a class="code" href="_sync_actions_8c.html#a95080bffa712dcfdea59f2fe0affd18b">linkActionData</a>(root, data);
<a name="l01142"></a>01142         comp-&gt;nodeFetchBusy++;
<a name="l01143"></a>01143         ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> |= <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a543f8cfea4a3c99237abeac7e563b90b" title="remote node is being fetched">SyncHashState_fetching</a>;
<a name="l01144"></a>01144         res = 1;
<a name="l01145"></a>01145     } <span class="keywordflow">else</span> {
<a name="l01146"></a>01146         <span class="comment">// return the storage</span>
<a name="l01147"></a>01147         comp-&gt;nodeFetchFailed++;
<a name="l01148"></a>01148         data = <a class="code" href="_sync_actions_8c.html#a9826ac9a64ba2f80ef24985bee419929">destroyActionData</a>(data);
<a name="l01149"></a>01149         free(action);
<a name="l01150"></a>01150         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a1aa8c032da69595d9b27357c2bb83da9" title="Severe errors.">CCNL_SEVERE</a>)
<a name="l01151"></a>01151             <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, why, __LINE__);
<a name="l01152"></a>01152     }
<a name="l01153"></a>01153     <span class="keywordflow">return</span> res;
<a name="l01154"></a>01154 }
<a name="l01155"></a>01155 
<a name="l01156"></a>01156 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01157"></a><a class="code" href="_sync_actions_8c.html#a839f3c57b2aad7b029b076f05acde0e3">01157</a> <a class="code" href="_sync_actions_8c.html#a839f3c57b2aad7b029b076f05acde0e3">comparisonFailed</a>(<span class="keyword">struct</span> SyncCompareData *data, <span class="keywordtype">char</span> *why, <span class="keywordtype">int</span> line) {
<a name="l01158"></a>01158     <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(data-&gt;root, <span class="stringliteral">&quot;Sync.CompareAction&quot;</span>, why, line);
<a name="l01159"></a>01159     data-&gt;state = <a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767a0af8ae16c6d77b372a710583dd92aa50">SyncCompare_waiting</a>;
<a name="l01160"></a>01160     <span class="keywordflow">return</span> -1;
<a name="l01161"></a>01161 }
<a name="l01162"></a>01162 
<a name="l01163"></a>01163 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01164"></a><a class="code" href="_sync_actions_8c.html#a3195c4b08a028d7d415c24cb746f503b">01164</a> <a class="code" href="_sync_actions_8c.html#a3195c4b08a028d7d415c24cb746f503b">addNameFromCompare</a>(<span class="keyword">struct</span> SyncCompareData *data) {
<a name="l01165"></a>01165     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.addNameFromCompare&quot;</span>;
<a name="l01166"></a>01166     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = data-&gt;root;
<a name="l01167"></a>01167     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l01168"></a>01168     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = data-&gt;cbR;
<a name="l01169"></a>01169     <span class="keywordflow">if</span> (root-&gt;<a class="code" href="struct_sync_root_struct.html#ac28d004acf78c3ef247937c0b10d8b7c" title="names needing contents fetch">namesToFetch</a> == NULL)
<a name="l01170"></a>01170         root-&gt;<a class="code" href="struct_sync_root_struct.html#ac28d004acf78c3ef247937c0b10d8b7c" title="names needing contents fetch">namesToFetch</a> = <a class="code" href="_sync_util_8c.html#adcdacf16d78ec4fff95eff5f0d63446b">SyncAllocNameAccum</a>(0);
<a name="l01171"></a>01171     <a class="code" href="_sync_util_8c.html#a9c7204a6cd37470ba61c05e5da8d8fc6" title="appends a new name with associated data important: the name is not copied!">SyncNameAccumAppend</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#ac28d004acf78c3ef247937c0b10d8b7c" title="names needing contents fetch">namesToFetch</a>, <a class="code" href="_sync_util_8c.html#a01fc44dbffb2f846caf907c293b98c02">SyncCopyName</a>(name), 0);
<a name="l01172"></a>01172     <span class="keyword">struct </span><a class="code" href="struct_sync_tree_worker_entry.html">SyncTreeWorkerEntry</a> *tweR = <a class="code" href="_sync_tree_worker_8c.html#a776013fec43bda3e07895da7e668f05a">SyncTreeWorkerTop</a>(data-&gt;twR);
<a name="l01173"></a>01173     tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l01174"></a>01174     tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#a1fe537a031485a9ca226ff4fc83d6aa3">count</a>++;
<a name="l01175"></a>01175     data-&gt;namesAdded++;
<a name="l01176"></a>01176     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l01177"></a>01177         <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, <span class="stringliteral">&quot;added&quot;</span>, name);
<a name="l01178"></a>01178     }
<a name="l01179"></a>01179     <span class="keywordflow">return</span> 0;
<a name="l01180"></a>01180 }
<a name="l01181"></a>01181 
<a name="l01182"></a>01182 <span class="comment">/*</span>
<a name="l01183"></a>01183 <span class="comment"> * doPreload(data) walks the remote tree, and requests a fetch for every remote</span>
<a name="l01184"></a>01184 <span class="comment"> * node that is not covered locally and has not been fetched,</span>
<a name="l01185"></a>01185 <span class="comment"> * and is not being fetched.  This allows large trees to be fetched in parallel,</span>
<a name="l01186"></a>01186 <span class="comment"> * speeding up the load process.</span>
<a name="l01187"></a>01187 <span class="comment"> */</span>
<a name="l01188"></a>01188 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01189"></a><a class="code" href="_sync_actions_8c.html#a348fc44c61e040fec66f083f0785edaa">01189</a> <a class="code" href="_sync_actions_8c.html#a348fc44c61e040fec66f083f0785edaa">doPreload</a>(<span class="keyword">struct</span> SyncCompareData *data) {
<a name="l01190"></a>01190     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = data-&gt;root;
<a name="l01191"></a>01191     <span class="keyword">struct </span><a class="code" href="struct_sync_tree_worker_head.html">SyncTreeWorkerHead</a> *twR = data-&gt;twR;
<a name="l01192"></a>01192     <span class="keywordtype">int</span> busyLim = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>-&gt;<a class="code" href="struct_sync_private.html#abc0dcd016d407f91323ef33772d98e15">maxFetchBusy</a>;
<a name="l01193"></a>01193     <span class="keywordflow">for</span> (;;) {
<a name="l01194"></a>01194         <span class="keywordflow">if</span> (data-&gt;nodeFetchBusy &gt; busyLim) <span class="keywordflow">return</span> 0;
<a name="l01195"></a>01195         <span class="keywordflow">if</span> (twR-&gt;<a class="code" href="struct_sync_tree_worker_head.html#ad3fbea62094d3a5e81e325f896e8a4df">level</a> &lt;= 0) <span class="keywordflow">break</span>;
<a name="l01196"></a>01196         <span class="keyword">struct </span><a class="code" href="struct_sync_tree_worker_entry.html">SyncTreeWorkerEntry</a> *ent = <a class="code" href="_sync_tree_worker_8c.html#a776013fec43bda3e07895da7e668f05a">SyncTreeWorkerTop</a>(twR);
<a name="l01197"></a>01197         <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceR = ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#aa98b86e01f36d39897ed843711728a36">cacheEntry</a>;
<a name="l01198"></a>01198         <span class="keywordflow">if</span> (ceR == NULL)
<a name="l01199"></a>01199             <span class="keywordflow">return</span> -1;
<a name="l01200"></a>01200         <span class="keywordflow">if</span> (ceR-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a543f8cfea4a3c99237abeac7e563b90b" title="remote node is being fetched">SyncHashState_fetching</a>
<a name="l01201"></a>01201             || <a class="code" href="_sync_actions_8c.html#a870761b1ea0620fc7bf78e6a7c4a8fb3">isCovered</a>(ceR)) {
<a name="l01202"></a>01202             <span class="comment">// not a needed node, so pop it</span>
<a name="l01203"></a>01203         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ceR-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a> != NULL) {
<a name="l01204"></a>01204             <span class="comment">// visit the children</span>
<a name="l01205"></a>01205             <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *ncR = ceR-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a>;
<a name="l01206"></a>01206             <span class="keywordtype">int</span> lim = ncR-&gt;<a class="code" href="struct_sync_node_composite.html#a29c915fd509d8e74edf1d862f357915a" title="number of references">refLen</a>;
<a name="l01207"></a>01207             <span class="keywordflow">while</span> (ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a> &lt; lim) {
<a name="l01208"></a>01208                 <span class="keyword">struct </span><a class="code" href="struct_sync_node_elem.html">SyncNodeElem</a> *ep = &amp;ncR-&gt;<a class="code" href="struct_sync_node_composite.html#a2d6c08c55513380b341cf6ef74aab2d5" title="pointer to references array">refs</a>[ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>];
<a name="l01209"></a>01209                 <span class="keywordflow">if</span> ((ep-&gt;<a class="code" href="struct_sync_node_elem.html#a770ab2553870198f1b5dbc1a7302eccb" title="leaf/composite flag">kind</a> &amp; <a class="code" href="_sync_node_8h.html#ab268103cfe0f550f6c750922e68b4706a814b9a3505f28764701d289e71b8a649" title="leaf">SyncElemKind_leaf</a>) == 0)
<a name="l01210"></a>01210                     <span class="keywordflow">break</span>;
<a name="l01211"></a>01211                 ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l01212"></a>01212             }
<a name="l01213"></a>01213             <span class="keywordflow">if</span> (ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a> &lt; lim) {
<a name="l01214"></a>01214                 <span class="keyword">struct </span><a class="code" href="struct_sync_node_elem.html">SyncNodeElem</a> *ep = &amp;ncR-&gt;<a class="code" href="struct_sync_node_composite.html#a2d6c08c55513380b341cf6ef74aab2d5" title="pointer to references array">refs</a>[ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>];
<a name="l01215"></a>01215                 <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *sub = <a class="code" href="_sync_actions_8c.html#a7bfdb2b3f3276a018144a52daaa6122b">cacheEntryForElem</a>(data, ncR, ep, 1);
<a name="l01216"></a>01216                 <span class="keywordflow">if</span> (sub == NULL)
<a name="l01217"></a>01217                     <span class="keywordflow">return</span> -1;
<a name="l01218"></a>01218                 ent = <a class="code" href="_sync_tree_worker_8c.html#a10a364304f0c94e2e44252cf24ed6572" title="pushes into the node at the current position">SyncTreeWorkerPush</a>(twR);
<a name="l01219"></a>01219                 <span class="keywordflow">if</span> (ent == NULL)
<a name="l01220"></a>01220                     <span class="keywordflow">return</span> -1;
<a name="l01221"></a>01221                 <span class="keywordflow">continue</span>;
<a name="l01222"></a>01222             }
<a name="l01223"></a>01223         } <span class="keywordflow">else</span> {
<a name="l01224"></a>01224             <span class="comment">// init the fetch, then pop</span>
<a name="l01225"></a>01225             <a class="code" href="_sync_actions_8c.html#a3aa9439bfcf15d6b0d01ebd855d2f02b">SyncStartNodeFetch</a>(root, ceR, data);
<a name="l01226"></a>01226         }
<a name="l01227"></a>01227         <span class="comment">// common exit to pop and iterate</span>
<a name="l01228"></a>01228         ent = <a class="code" href="_sync_tree_worker_8c.html#a0029e127047a93efbc28a7b93e1ae005" title="pops the stack and returns the top entry popping an empty stack has no effect and...">SyncTreeWorkerPop</a>(twR);
<a name="l01229"></a>01229         <span class="keywordflow">if</span> (ent != NULL) ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l01230"></a>01230     }
<a name="l01231"></a>01231     <span class="keywordflow">while</span> (data-&gt;nodeFetchBusy &lt; busyLim) {
<a name="l01232"></a>01232         <span class="comment">// restart the failed node fetches (while we can)</span>
<a name="l01233"></a>01233         <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *sad = data-&gt;errList;
<a name="l01234"></a>01234         <span class="keywordflow">if</span> (sad == NULL) <span class="keywordflow">break</span>;
<a name="l01235"></a>01235         <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceR = <a class="code" href="_sync_hash_cache_8c.html#a15c6eafb71bb631fde85a2424f5ac449" title="lookup a full hash in a hash table (raw contents, no tag)">SyncHashLookup</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>,
<a name="l01236"></a>01236                                                         sad-&gt;<a class="code" href="struct_sync_action_data.html#af8df0a4ba0bd30cd13c1976985e8d7f1">hash</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>,
<a name="l01237"></a>01237                                                         sad-&gt;<a class="code" href="struct_sync_action_data.html#af8df0a4ba0bd30cd13c1976985e8d7f1">hash</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01238"></a>01238         <a class="code" href="_sync_actions_8c.html#a3aa9439bfcf15d6b0d01ebd855d2f02b">SyncStartNodeFetch</a>(root, ceR, data);
<a name="l01239"></a>01239         <a class="code" href="_sync_actions_8c.html#a9826ac9a64ba2f80ef24985bee419929">destroyActionData</a>(sad);
<a name="l01240"></a>01240     }
<a name="l01241"></a>01241     
<a name="l01242"></a>01242     <span class="keywordflow">if</span> (data-&gt;nodeFetchBusy &gt; 0) <span class="keywordflow">return</span> 0;
<a name="l01243"></a>01243     <span class="keywordflow">if</span> (data-&gt;errList != NULL) <span class="keywordflow">return</span> 0;
<a name="l01244"></a>01244     <span class="keywordflow">if</span> (twR-&gt;<a class="code" href="struct_sync_tree_worker_head.html#ad3fbea62094d3a5e81e325f896e8a4df">level</a> &gt; 0) <span class="keywordflow">return</span> 0;
<a name="l01245"></a>01245     <span class="keywordflow">return</span> 1;
<a name="l01246"></a>01246 }
<a name="l01247"></a>01247 
<a name="l01248"></a>01248 <span class="comment">/*</span>
<a name="l01249"></a>01249 <span class="comment"> * doComparison(data) is a key routine, because it determines what is</span>
<a name="l01250"></a>01250 <span class="comment"> * present in data-&gt;twR that is not present in data-&gt;twL.  It does so by</span>
<a name="l01251"></a>01251 <span class="comment"> * walking the two trees, L and R, in increasing name order.  To gain efficiency</span>
<a name="l01252"></a>01252 <span class="comment"> * doComparison avoids examining nodes in R that are already covered, and nodes</span>
<a name="l01253"></a>01253 <span class="comment"> * in L that have been bypassed in the walk of R.</span>
<a name="l01254"></a>01254 <span class="comment"> *</span>
<a name="l01255"></a>01255 <span class="comment"> * Ideally doComparison allows determination of k differences in O(k*log(N))</span>
<a name="l01256"></a>01256 <span class="comment"> * steps, where N is the number of names in the union of L and R.  However, if</span>
<a name="l01257"></a>01257 <span class="comment"> * the tree structures differ significantly the cost can be as high as O(N).</span>
<a name="l01258"></a>01258 <span class="comment"> */</span>
<a name="l01259"></a>01259 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01260"></a><a class="code" href="_sync_actions_8c.html#a5a4c7d24bb2d0d6fe9008b3b36f70dd3">01260</a> <a class="code" href="_sync_actions_8c.html#a5a4c7d24bb2d0d6fe9008b3b36f70dd3">doComparison</a>(<span class="keyword">struct</span> SyncCompareData *data) {
<a name="l01261"></a>01261     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = data-&gt;root;
<a name="l01262"></a>01262     <span class="keyword">struct </span><a class="code" href="struct_sync_tree_worker_head.html">SyncTreeWorkerHead</a> *twL = data-&gt;twL;
<a name="l01263"></a>01263     <span class="keyword">struct </span><a class="code" href="struct_sync_tree_worker_head.html">SyncTreeWorkerHead</a> *twR = data-&gt;twR;
<a name="l01264"></a>01264     
<a name="l01265"></a>01265     <span class="keywordflow">for</span> (;;) {
<a name="l01266"></a>01266         <span class="keyword">struct </span><a class="code" href="struct_sync_tree_worker_entry.html">SyncTreeWorkerEntry</a> *tweR = <a class="code" href="_sync_tree_worker_8c.html#a776013fec43bda3e07895da7e668f05a">SyncTreeWorkerTop</a>(twR);
<a name="l01267"></a>01267         <span class="keywordflow">if</span> (tweR == NULL) {
<a name="l01268"></a>01268             <span class="comment">// the remote is done, so no more names to add</span>
<a name="l01269"></a>01269             <span class="keywordflow">return</span> 1;
<a name="l01270"></a>01270         }
<a name="l01271"></a>01271         <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceR = tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#aa98b86e01f36d39897ed843711728a36">cacheEntry</a>;
<a name="l01272"></a>01272         <span class="keywordflow">if</span> (ceR == NULL)
<a name="l01273"></a>01273             <span class="keywordflow">return</span> <a class="code" href="_sync_actions_8c.html#a839f3c57b2aad7b029b076f05acde0e3">comparisonFailed</a>(data, <span class="stringliteral">&quot;bad cache entry for R&quot;</span>, __LINE__);
<a name="l01274"></a>01274         ceR-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a6861960908cc217b639d3f1af6bbc520" title="time when entry last used in compare">lastUsed</a> = data-&gt;lastEnter;
<a name="l01275"></a>01275         <span class="keywordflow">if</span> (tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a> == 0 &amp;&amp; <a class="code" href="_sync_actions_8c.html#a870761b1ea0620fc7bf78e6a7c4a8fb3">isCovered</a>(ceR)) {
<a name="l01276"></a>01276             <span class="comment">// short cut, nothing in R we don&#39;t have</span>
<a name="l01277"></a>01277             <span class="keywordtype">size_t</span> c = tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#a1fe537a031485a9ca226ff4fc83d6aa3">count</a>;
<a name="l01278"></a>01278             tweR = <a class="code" href="_sync_tree_worker_8c.html#a0029e127047a93efbc28a7b93e1ae005" title="pops the stack and returns the top entry popping an empty stack has no effect and...">SyncTreeWorkerPop</a>(twR);
<a name="l01279"></a>01279             <span class="keywordflow">if</span> (tweR != NULL) {
<a name="l01280"></a>01280                 tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l01281"></a>01281                 tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#a1fe537a031485a9ca226ff4fc83d6aa3">count</a> += c;
<a name="l01282"></a>01282             }
<a name="l01283"></a>01283             <span class="keywordflow">continue</span>;
<a name="l01284"></a>01284         }
<a name="l01285"></a>01285         <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *ncR = ceR-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a>;
<a name="l01286"></a>01286         <span class="keywordflow">if</span> (ncR == NULL) {
<a name="l01287"></a>01287             <span class="comment">// top remote node not present, so go get it</span>
<a name="l01288"></a>01288             <span class="keywordtype">int</span> nf = <a class="code" href="_sync_actions_8c.html#a3aa9439bfcf15d6b0d01ebd855d2f02b">SyncStartNodeFetch</a>(root, ceR, data);
<a name="l01289"></a>01289             <span class="keywordflow">if</span> (nf == 0) {
<a name="l01290"></a>01290                 <span class="comment">// TBD: duplicate, so ignore the fetch?</span>
<a name="l01291"></a>01291                 <span class="comment">// for now, this is an error!</span>
<a name="l01292"></a>01292                 <span class="keywordflow">return</span> <a class="code" href="_sync_actions_8c.html#a839f3c57b2aad7b029b076f05acde0e3">comparisonFailed</a>(data, <span class="stringliteral">&quot;node fetch duplicate?&quot;</span>, __LINE__);
<a name="l01293"></a>01293             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nf &gt; 0) {
<a name="l01294"></a>01294                 <span class="comment">// node fetch started OK</span>
<a name="l01295"></a>01295             } <span class="keywordflow">else</span> {
<a name="l01296"></a>01296                 <span class="comment">// node fetch failed to initiate</span>
<a name="l01297"></a>01297                 <span class="keywordflow">return</span> <a class="code" href="_sync_actions_8c.html#a839f3c57b2aad7b029b076f05acde0e3">comparisonFailed</a>(data, <span class="stringliteral">&quot;bad node fetch for R&quot;</span>, __LINE__);
<a name="l01298"></a>01298             }
<a name="l01299"></a>01299             <span class="keywordflow">return</span> 0;
<a name="l01300"></a>01300         }
<a name="l01301"></a>01301         <span class="keywordflow">if</span> (tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a> &gt;= ncR-&gt;<a class="code" href="struct_sync_node_composite.html#a29c915fd509d8e74edf1d862f357915a" title="number of references">refLen</a>) {
<a name="l01302"></a>01302             <span class="comment">// we just went off the end of the current remote node, so pop it</span>
<a name="l01303"></a>01303             <span class="comment">// skip over the processed element if we still have a node</span>
<a name="l01304"></a>01304             <span class="keywordtype">size_t</span> c = tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#a1fe537a031485a9ca226ff4fc83d6aa3">count</a>;
<a name="l01305"></a>01305             <span class="keywordflow">if</span> (c == 0) {
<a name="l01306"></a>01306                 <span class="comment">// nothing was added, so this node must be covered</span>
<a name="l01307"></a>01307                 <a class="code" href="_sync_actions_8c.html#a8d981d346c90e43d3f8d9e52077e28ca">setCovered</a>(ceR);
<a name="l01308"></a>01308             }
<a name="l01309"></a>01309             tweR = <a class="code" href="_sync_tree_worker_8c.html#a0029e127047a93efbc28a7b93e1ae005" title="pops the stack and returns the top entry popping an empty stack has no effect and...">SyncTreeWorkerPop</a>(twR);
<a name="l01310"></a>01310             <span class="keywordflow">if</span> (tweR != NULL) {
<a name="l01311"></a>01311                 tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l01312"></a>01312                 tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#a1fe537a031485a9ca226ff4fc83d6aa3">count</a> += c;
<a name="l01313"></a>01313             }
<a name="l01314"></a>01314             <span class="keywordflow">continue</span>;
<a name="l01315"></a>01315         }
<a name="l01316"></a>01316         <span class="keyword">struct </span><a class="code" href="struct_sync_node_elem.html">SyncNodeElem</a> *neR = <a class="code" href="_sync_tree_worker_8c.html#a77931eb09ea49c8f1c460467e836336d" title="requires that the node be present">SyncTreeWorkerGetElem</a>(twR);
<a name="l01317"></a>01317         <span class="keywordflow">if</span> (neR == NULL)
<a name="l01318"></a>01318             <span class="keywordflow">return</span> <a class="code" href="_sync_actions_8c.html#a839f3c57b2aad7b029b076f05acde0e3">comparisonFailed</a>(data, <span class="stringliteral">&quot;bad element for R&quot;</span>, __LINE__);
<a name="l01319"></a>01319         
<a name="l01320"></a>01320         <span class="keywordflow">if</span> (<a class="code" href="_sync_actions_8c.html#aaf9c87ebf674e592c7bcb15aebbe937e">extractBuf</a>(data-&gt;cbR, ncR, neR) &lt; 0)
<a name="l01321"></a>01321             <span class="comment">// the remote name/hash extract failed</span>
<a name="l01322"></a>01322             <span class="keywordflow">return</span> <a class="code" href="_sync_actions_8c.html#a839f3c57b2aad7b029b076f05acde0e3">comparisonFailed</a>(data, <span class="stringliteral">&quot;bad extract for R&quot;</span>, __LINE__);
<a name="l01323"></a>01323         
<a name="l01324"></a>01324         <span class="keyword">struct </span><a class="code" href="struct_sync_tree_worker_entry.html">SyncTreeWorkerEntry</a> *tweL = <a class="code" href="_sync_tree_worker_8c.html#a776013fec43bda3e07895da7e668f05a">SyncTreeWorkerTop</a>(twL);
<a name="l01325"></a>01325         <span class="keywordflow">if</span> (tweL == NULL) {
<a name="l01326"></a>01326             <span class="comment">// L is now empty, so add R</span>
<a name="l01327"></a>01327             <span class="keywordflow">if</span> (neR-&gt;<a class="code" href="struct_sync_node_elem.html#a770ab2553870198f1b5dbc1a7302eccb" title="leaf/composite flag">kind</a> == <a class="code" href="_sync_node_8h.html#ab268103cfe0f550f6c750922e68b4706a4ee0bed023456d8699399116bfd2858b" title="node">SyncElemKind_node</a>) {
<a name="l01328"></a>01328                 <span class="comment">// to add a node R, push into it</span>
<a name="l01329"></a>01329                 <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *subR = <a class="code" href="_sync_actions_8c.html#a7bfdb2b3f3276a018144a52daaa6122b">cacheEntryForElem</a>(data, ncR, neR, 1);
<a name="l01330"></a>01330                 <span class="keywordflow">if</span> (subR == NULL || <a class="code" href="_sync_tree_worker_8c.html#a10a364304f0c94e2e44252cf24ed6572" title="pushes into the node at the current position">SyncTreeWorkerPush</a>(twR) == NULL)
<a name="l01331"></a>01331                     <span class="keywordflow">return</span> <a class="code" href="_sync_actions_8c.html#a839f3c57b2aad7b029b076f05acde0e3">comparisonFailed</a>(data, <span class="stringliteral">&quot;bad cache entry for R&quot;</span>, __LINE__);
<a name="l01332"></a>01332             } <span class="keywordflow">else</span> {
<a name="l01333"></a>01333                 <span class="comment">// R is a leaf</span>
<a name="l01334"></a>01334                 <a class="code" href="_sync_actions_8c.html#a3195c4b08a028d7d415c24cb746f503b">addNameFromCompare</a>(data);
<a name="l01335"></a>01335             }
<a name="l01336"></a>01336         } <span class="keywordflow">else</span> {
<a name="l01337"></a>01337             <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceL = tweL-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#aa98b86e01f36d39897ed843711728a36">cacheEntry</a>;
<a name="l01338"></a>01338             <span class="keywordflow">if</span> (<a class="code" href="_sync_hash_cache_8c.html#a88b8496fee4324b2359f23e3c6dd9472" title="fetches the cache entry to be eligible, ce != NULL &amp;amp;&amp;amp; ce-&amp;gt;ncL != NULL...">SyncCacheEntryFetch</a>(ceL) &lt; 0)
<a name="l01339"></a>01339                 <span class="keywordflow">return</span> <a class="code" href="_sync_actions_8c.html#a839f3c57b2aad7b029b076f05acde0e3">comparisonFailed</a>(data, <span class="stringliteral">&quot;bad cache entry for L&quot;</span>, __LINE__);
<a name="l01340"></a>01340             <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *ncL = ceL-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a>;
<a name="l01341"></a>01341             ceL-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a6861960908cc217b639d3f1af6bbc520" title="time when entry last used in compare">lastUsed</a> = data-&gt;lastEnter;
<a name="l01342"></a>01342             <span class="keywordflow">if</span> (tweL-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a> &gt;= ncL-&gt;<a class="code" href="struct_sync_node_composite.html#a29c915fd509d8e74edf1d862f357915a" title="number of references">refLen</a>) {
<a name="l01343"></a>01343                 <span class="comment">// we just went off the end of the current local node, so pop it</span>
<a name="l01344"></a>01344                 tweL = <a class="code" href="_sync_tree_worker_8c.html#a0029e127047a93efbc28a7b93e1ae005" title="pops the stack and returns the top entry popping an empty stack has no effect and...">SyncTreeWorkerPop</a>(twL);
<a name="l01345"></a>01345                 <span class="keywordflow">if</span> (tweL != NULL) tweL-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l01346"></a>01346                 <span class="keywordflow">continue</span>;
<a name="l01347"></a>01347             }
<a name="l01348"></a>01348             <span class="keyword">struct </span><a class="code" href="struct_sync_node_elem.html">SyncNodeElem</a> *neL = <a class="code" href="_sync_tree_worker_8c.html#a77931eb09ea49c8f1c460467e836336d" title="requires that the node be present">SyncTreeWorkerGetElem</a>(twL);
<a name="l01349"></a>01349             <span class="keywordflow">if</span> (neL == NULL || <a class="code" href="_sync_actions_8c.html#aaf9c87ebf674e592c7bcb15aebbe937e">extractBuf</a>(data-&gt;cbL, ncL, neL) &lt; 0) {
<a name="l01350"></a>01350                 <span class="comment">// the local name/hash extract failed</span>
<a name="l01351"></a>01351                 <span class="keywordflow">return</span> <a class="code" href="_sync_actions_8c.html#a839f3c57b2aad7b029b076f05acde0e3">comparisonFailed</a>(data, <span class="stringliteral">&quot;bad extract for L&quot;</span>, __LINE__);
<a name="l01352"></a>01352             }
<a name="l01353"></a>01353             <span class="keywordflow">if</span> (neR-&gt;<a class="code" href="struct_sync_node_elem.html#a770ab2553870198f1b5dbc1a7302eccb" title="leaf/composite flag">kind</a> == <a class="code" href="_sync_node_8h.html#ab268103cfe0f550f6c750922e68b4706a4ee0bed023456d8699399116bfd2858b" title="node">SyncElemKind_node</a>) {
<a name="l01354"></a>01354                 <span class="comment">// quick kill for a remote node?</span>
<a name="l01355"></a>01355                 <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *subR = <a class="code" href="_sync_actions_8c.html#a7bfdb2b3f3276a018144a52daaa6122b">cacheEntryForElem</a>(data, ncR, neR, 1);
<a name="l01356"></a>01356                 <span class="keywordflow">if</span> (subR == NULL)
<a name="l01357"></a>01357                     <span class="keywordflow">return</span> <a class="code" href="_sync_actions_8c.html#a839f3c57b2aad7b029b076f05acde0e3">comparisonFailed</a>(data, <span class="stringliteral">&quot;bad element for R&quot;</span>, __LINE__);
<a name="l01358"></a>01358                 <span class="keywordflow">if</span> (<a class="code" href="_sync_actions_8c.html#a870761b1ea0620fc7bf78e6a7c4a8fb3">isCovered</a>(subR)) {
<a name="l01359"></a>01359                     <span class="comment">// nothing to add, this node is already covered</span>
<a name="l01360"></a>01360                     <span class="comment">// note: this works even if the remote node is not present!</span>
<a name="l01361"></a>01361                     tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l01362"></a>01362                     <span class="keywordflow">continue</span>;
<a name="l01363"></a>01363                 }
<a name="l01364"></a>01364                 <span class="keywordflow">if</span> (subR-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a> == NULL) {
<a name="l01365"></a>01365                     <span class="comment">// there is a remote hash, but no node present,</span>
<a name="l01366"></a>01366                     <span class="comment">// so push into it to force the fetch</span>
<a name="l01367"></a>01367                     <span class="keywordflow">if</span> (<a class="code" href="_sync_tree_worker_8c.html#a10a364304f0c94e2e44252cf24ed6572" title="pushes into the node at the current position">SyncTreeWorkerPush</a>(twR) == NULL)
<a name="l01368"></a>01368                         <span class="keywordflow">return</span> <a class="code" href="_sync_actions_8c.html#a839f3c57b2aad7b029b076f05acde0e3">comparisonFailed</a>(data, <span class="stringliteral">&quot;bad push for R&quot;</span>, __LINE__);
<a name="l01369"></a>01369                     <span class="keywordflow">continue</span>;
<a name="l01370"></a>01370                 }
<a name="l01371"></a>01371                 
<a name="l01372"></a>01372                 <span class="keywordflow">if</span> (neL-&gt;<a class="code" href="struct_sync_node_elem.html#a770ab2553870198f1b5dbc1a7302eccb" title="leaf/composite flag">kind</a> == <a class="code" href="_sync_node_8h.html#ab268103cfe0f550f6c750922e68b4706a814b9a3505f28764701d289e71b8a649" title="leaf">SyncElemKind_leaf</a>) {
<a name="l01373"></a>01373                     <span class="comment">// L is a leaf, R is a node that is present</span>
<a name="l01374"></a>01374                     <span class="keyword">enum</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64">SyncCompareResult</a> scr = <a class="code" href="_sync_node_8c.html#ace5e85a8d920773cb68e947238f2448a" title="Compares a name against the min and max names in the node.">SyncNodeCompareMinMax</a>(subR-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a>, data-&gt;cbL);
<a name="l01375"></a>01375                     <span class="keywordflow">switch</span> (scr) {
<a name="l01376"></a>01376                         <span class="keywordflow">case</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64a0c33200977bb75a132aa6fdcfc354ea4">SCR_before</a>:
<a name="l01377"></a>01377                             <span class="comment">// L &lt; Min(R), so advance L</span>
<a name="l01378"></a>01378                             tweL-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l01379"></a>01379                             <span class="keywordflow">break</span>;
<a name="l01380"></a>01380                         <span class="keywordflow">case</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64a7a3a53a61272e732e13e4a229a73dab8">SCR_max</a>:
<a name="l01381"></a>01381                             <span class="comment">// L == Max(R), advance both</span>
<a name="l01382"></a>01382                             tweL-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l01383"></a>01383                             tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l01384"></a>01384                             <span class="keywordflow">break</span>;
<a name="l01385"></a>01385                         <span class="keywordflow">default</span>:
<a name="l01386"></a>01386                             <span class="comment">// in all other cases, dive into R</span>
<a name="l01387"></a>01387                             <span class="keywordflow">if</span> (<a class="code" href="_sync_tree_worker_8c.html#a10a364304f0c94e2e44252cf24ed6572" title="pushes into the node at the current position">SyncTreeWorkerPush</a>(twR) == NULL)
<a name="l01388"></a>01388                                 <span class="keywordflow">return</span> <a class="code" href="_sync_actions_8c.html#a839f3c57b2aad7b029b076f05acde0e3">comparisonFailed</a>(data, <span class="stringliteral">&quot;bad push for R&quot;</span>, __LINE__);
<a name="l01389"></a>01389                             <span class="keywordflow">break</span>;
<a name="l01390"></a>01390                     }
<a name="l01391"></a>01391                     
<a name="l01392"></a>01392                 } <span class="keywordflow">else</span> {
<a name="l01393"></a>01393                     <span class="comment">// both L and R are nodes, test for L being present</span>
<a name="l01394"></a>01394                     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *subL = <a class="code" href="_sync_actions_8c.html#a7bfdb2b3f3276a018144a52daaa6122b">cacheEntryForElem</a>(data, ncL, neL, 0);
<a name="l01395"></a>01395                     <span class="keywordflow">if</span> (subL == NULL || subL-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a> == NULL)
<a name="l01396"></a>01396                         <span class="keywordflow">return</span> <a class="code" href="_sync_actions_8c.html#a839f3c57b2aad7b029b076f05acde0e3">comparisonFailed</a>(data, <span class="stringliteral">&quot;bad cache entry for L&quot;</span>, __LINE__);
<a name="l01397"></a>01397                     <span class="comment">// both L and R are nodes, and both are present</span>
<a name="l01398"></a>01398                     <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *ncL = subL-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a>;
<a name="l01399"></a>01399                     <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *ncR = subR-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a>;
<a name="l01400"></a>01400                     <span class="keywordtype">int</span> cmp = <a class="code" href="_sync_util_8c.html#a83e5cd9675cc633d9504bd3ee7c8f025">SyncCmpNames</a>(ncR-&gt;<a class="code" href="struct_sync_node_composite.html#a3c48241aa540c2dbae4a5a1f1cbb5b66" title="minimum name">minName</a>, ncL-&gt;<a class="code" href="struct_sync_node_composite.html#ada7af45eaf5373b0a25e7cc943f883c0" title="maximum name">maxName</a>);
<a name="l01401"></a>01401                     <span class="keywordflow">if</span> (cmp &gt; 0) {
<a name="l01402"></a>01402                         <span class="comment">// Min(R) &gt; Max(L), so advance L</span>
<a name="l01403"></a>01403                         tweL-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l01404"></a>01404                     } <span class="keywordflow">else</span> {
<a name="l01405"></a>01405                         <span class="comment">// dive into both nodes</span>
<a name="l01406"></a>01406                         <span class="keywordflow">if</span> (<a class="code" href="_sync_tree_worker_8c.html#a10a364304f0c94e2e44252cf24ed6572" title="pushes into the node at the current position">SyncTreeWorkerPush</a>(twL) == NULL)
<a name="l01407"></a>01407                             <span class="keywordflow">return</span> <a class="code" href="_sync_actions_8c.html#a839f3c57b2aad7b029b076f05acde0e3">comparisonFailed</a>(data, <span class="stringliteral">&quot;bad push for L&quot;</span>, __LINE__);
<a name="l01408"></a>01408                         <span class="keywordflow">if</span> (<a class="code" href="_sync_tree_worker_8c.html#a10a364304f0c94e2e44252cf24ed6572" title="pushes into the node at the current position">SyncTreeWorkerPush</a>(twR) == NULL)
<a name="l01409"></a>01409                             <span class="keywordflow">return</span> <a class="code" href="_sync_actions_8c.html#a839f3c57b2aad7b029b076f05acde0e3">comparisonFailed</a>(data, <span class="stringliteral">&quot;bad push for R&quot;</span>, __LINE__);
<a name="l01410"></a>01410                     }
<a name="l01411"></a>01411                 }
<a name="l01412"></a>01412             } <span class="keywordflow">else</span> {
<a name="l01413"></a>01413                 <span class="comment">// R is a leaf</span>
<a name="l01414"></a>01414                 <span class="keywordflow">if</span> (neL-&gt;<a class="code" href="struct_sync_node_elem.html#a770ab2553870198f1b5dbc1a7302eccb" title="leaf/composite flag">kind</a> == <a class="code" href="_sync_node_8h.html#ab268103cfe0f550f6c750922e68b4706a814b9a3505f28764701d289e71b8a649" title="leaf">SyncElemKind_leaf</a>) {
<a name="l01415"></a>01415                     <span class="comment">// both L and R are names, so the compare is simple</span>
<a name="l01416"></a>01416                     <span class="keywordtype">int</span> cmp = <a class="code" href="_sync_util_8c.html#a83e5cd9675cc633d9504bd3ee7c8f025">SyncCmpNames</a>(data-&gt;cbL, data-&gt;cbR);
<a name="l01417"></a>01417                     <span class="keywordflow">if</span> (cmp == 0) {
<a name="l01418"></a>01418                         <span class="comment">// L == R, so advance both</span>
<a name="l01419"></a>01419                         tweL-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l01420"></a>01420                         tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l01421"></a>01421                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmp &lt; 0) {
<a name="l01422"></a>01422                         <span class="comment">// L &lt; R, advance L </span>
<a name="l01423"></a>01423                         tweL-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l01424"></a>01424                     } <span class="keywordflow">else</span> {
<a name="l01425"></a>01425                         <span class="comment">// L &gt; R, so add R</span>
<a name="l01426"></a>01426                         <a class="code" href="_sync_actions_8c.html#a3195c4b08a028d7d415c24cb746f503b">addNameFromCompare</a>(data);
<a name="l01427"></a>01427                     }
<a name="l01428"></a>01428                 } <span class="keywordflow">else</span> {
<a name="l01429"></a>01429                     <span class="comment">// R is a leaf, but L is a node</span>
<a name="l01430"></a>01430                     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *subL = <a class="code" href="_sync_actions_8c.html#a7bfdb2b3f3276a018144a52daaa6122b">cacheEntryForElem</a>(data, ncL, neL, 0);
<a name="l01431"></a>01431                     <span class="keywordflow">if</span> (subL == NULL || subL-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a> == NULL)
<a name="l01432"></a>01432                         <span class="keywordflow">return</span> <a class="code" href="_sync_actions_8c.html#a839f3c57b2aad7b029b076f05acde0e3">comparisonFailed</a>(data, <span class="stringliteral">&quot;bad cache entry for L&quot;</span>, __LINE__);
<a name="l01433"></a>01433                     <span class="keyword">enum</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64">SyncCompareResult</a> scr = <a class="code" href="_sync_node_8c.html#ace5e85a8d920773cb68e947238f2448a" title="Compares a name against the min and max names in the node.">SyncNodeCompareMinMax</a>(subL-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a>, data-&gt;cbR);
<a name="l01434"></a>01434                     <span class="keywordflow">switch</span> (scr) {
<a name="l01435"></a>01435                         <span class="keywordflow">case</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64a0c33200977bb75a132aa6fdcfc354ea4">SCR_before</a>:
<a name="l01436"></a>01436                             <span class="comment">// R &lt; Min(L), so add R</span>
<a name="l01437"></a>01437                             <a class="code" href="_sync_actions_8c.html#a3195c4b08a028d7d415c24cb746f503b">addNameFromCompare</a>(data);
<a name="l01438"></a>01438                             <span class="keywordflow">break</span>;
<a name="l01439"></a>01439                         <span class="keywordflow">case</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64a7a3a53a61272e732e13e4a229a73dab8">SCR_max</a>:
<a name="l01440"></a>01440                             <span class="comment">// R == Max(L), advance both</span>
<a name="l01441"></a>01441                             tweL-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l01442"></a>01442                             tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l01443"></a>01443                             <span class="keywordflow">break</span>;
<a name="l01444"></a>01444                         <span class="keywordflow">case</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64ae59232c058740e4c8407b05a3d2a30f7">SCR_min</a>:
<a name="l01445"></a>01445                             <span class="comment">// R == Min(L), advance R</span>
<a name="l01446"></a>01446                             tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l01447"></a>01447                             <span class="keywordflow">break</span>;
<a name="l01448"></a>01448                         <span class="keywordflow">case</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64a40ed003d6315e67fb76e3a251c61bf8b">SCR_after</a>:
<a name="l01449"></a>01449                             <span class="comment">// R &gt; Max(L), advance L</span>
<a name="l01450"></a>01450                             tweL-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l01451"></a>01451                             <span class="keywordflow">break</span>;
<a name="l01452"></a>01452                         <span class="keywordflow">case</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64a2c9d0ac245c2e225518313dfa540899b">SCR_inside</a>:
<a name="l01453"></a>01453                             <span class="comment">// Min(L) &lt; R &lt; Max(L), so dive into L</span>
<a name="l01454"></a>01454                             <span class="keywordflow">if</span> (<a class="code" href="_sync_tree_worker_8c.html#a10a364304f0c94e2e44252cf24ed6572" title="pushes into the node at the current position">SyncTreeWorkerPush</a>(twL) == NULL)
<a name="l01455"></a>01455                                 <span class="keywordflow">return</span> <a class="code" href="_sync_actions_8c.html#a839f3c57b2aad7b029b076f05acde0e3">comparisonFailed</a>(data, <span class="stringliteral">&quot;bad push for L&quot;</span>, __LINE__);
<a name="l01456"></a>01456                             <span class="keywordflow">break</span>;
<a name="l01457"></a>01457                         <span class="keywordflow">default</span>:
<a name="l01458"></a>01458                             <span class="comment">// this is really broken</span>
<a name="l01459"></a>01459                             <span class="keywordflow">return</span> <a class="code" href="_sync_actions_8c.html#a839f3c57b2aad7b029b076f05acde0e3">comparisonFailed</a>(data, <span class="stringliteral">&quot;bad min/max compare&quot;</span>, __LINE__);
<a name="l01460"></a>01460                     }
<a name="l01461"></a>01461                     
<a name="l01462"></a>01462                 }
<a name="l01463"></a>01463             }
<a name="l01464"></a>01464         }
<a name="l01465"></a>01465     }
<a name="l01466"></a>01466 }
<a name="l01467"></a>01467 
<a name="l01468"></a>01468 <span class="comment">// purge the nodes associated with cache entries that have not been</span>
<a name="l01469"></a>01469 <span class="comment">// recently used, provided that the nodes are not reachable from the current</span>
<a name="l01470"></a>01470 <span class="comment">// sync tree root</span>
<a name="l01471"></a>01471 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01472"></a><a class="code" href="_sync_actions_8c.html#aa7b4b03461c37b445235b4fd9a523416">01472</a> <a class="code" href="_sync_actions_8c.html#aa7b4b03461c37b445235b4fd9a523416">purgeOldEntries</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root) {
<a name="l01473"></a>01473     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.purgeOldEntries&quot;</span>;
<a name="l01474"></a>01474     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_head.html">SyncHashCacheHead</a> *ch = root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>;
<a name="l01475"></a>01475     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceL = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#abe335cfe4efd3e95c6fd099835d4baf9">ceCurrent</a>;
<a name="l01476"></a>01476     <span class="keywordflow">if</span> (ceL == NULL) <span class="keywordflow">return</span>;
<a name="l01477"></a>01477     <span class="keyword">struct </span><a class="code" href="struct_sync_tree_worker_head.html">SyncTreeWorkerHead</a> *twL = <a class="code" href="_sync_tree_worker_8c.html#ab50ea183a52285c94049d758fa2cb966" title="create a new tree worker, based on the given cache ent != NULL: initialize from the...">SyncTreeWorkerCreate</a>(ch, ceL);
<a name="l01478"></a>01478     int64_t now = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l01479"></a>01479     int64_t trigger = <a class="code" href="_sync_actions_8c.html#a6f820954efdf20f00e127de4f5860876">cachePurgeTrigger</a> * <a class="code" href="_sync_actions_8c.html#a52037c938e3c1b126c6277da5ca689d0">M</a>;
<a name="l01480"></a>01480     <a class="code" href="_sync_hash_cache_8c.html#a3b70f87d8ce6ed84b0b658dd0d4742e9" title="clear all marks">SyncHashClearMarks</a>(ch);
<a name="l01481"></a>01481     <a class="code" href="_sync_tree_worker_8c.html#ac9c887161d7349bd1475805fe09ed92b" title="Mark all reachable cache entries using the current tree worker head, with backtrack...">SyncTreeMarkReachable</a>(twL, 0);
<a name="l01482"></a>01482     <span class="keywordtype">int</span> hx = 0;
<a name="l01483"></a>01483     <span class="keywordflow">for</span> (hx = 0; hx &lt; ch-&gt;<a class="code" href="struct_sync_hash_cache_head.html#a97cde5fba4685fecaf8ea024d754f5e4" title="the mod to use">mod</a>; hx++) {
<a name="l01484"></a>01484         <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = ch-&gt;<a class="code" href="struct_sync_hash_cache_head.html#a688782daa06219bbf7f4876c0c704064" title="the vector of hash chains">ents</a>[hx];
<a name="l01485"></a>01485         <span class="keywordflow">while</span> (ce != NULL) {
<a name="l01486"></a>01486             <span class="keywordflow">if</span> ((ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a82c2c7c70f2313fdc8a563bd15874184" title="cache entry has been marked">SyncHashState_marked</a>) == 0
<a name="l01487"></a>01487                 &amp;&amp; ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a83898a8e93d5a30a5b8278f74aedb6ef" title="local node has been stored">SyncHashState_stored</a>) {
<a name="l01488"></a>01488                 <span class="comment">// stored, but not reachable using current tree</span>
<a name="l01489"></a>01489                 <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *ncL = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a>;
<a name="l01490"></a>01490                 <span class="keywordflow">if</span> (ncL != NULL) {
<a name="l01491"></a>01491                     int64_t dt = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a6861960908cc217b639d3f1af6bbc520" title="time when entry last used in compare">lastUsed</a>, now);
<a name="l01492"></a>01492                     <span class="keywordflow">if</span> (dt &gt; trigger) {
<a name="l01493"></a>01493                         <span class="comment">// old enough to know better</span>
<a name="l01494"></a>01494                         ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a> = NULL;
<a name="l01495"></a>01495                         ncL = <a class="code" href="_sync_node_8c.html#adbec8777422ca7e8c80714aa77afb5a4" title="Decrements the reference count.">SyncNodeDecRC</a>(ncL);
<a name="l01496"></a>01496                         <span class="keywordflow">if</span> (root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l01497"></a>01497                             <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#aba3a8329dde03169d4bb1f369b2d78cf" title="hash used to reach this entry">hash</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#aba3a8329dde03169d4bb1f369b2d78cf" title="hash used to reach this entry">hash</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01498"></a>01498                             <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, hex);
<a name="l01499"></a>01499                             free(hex);
<a name="l01500"></a>01500                         }
<a name="l01501"></a>01501                     }
<a name="l01502"></a>01502                 }
<a name="l01503"></a>01503             }
<a name="l01504"></a>01504             ce = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ae4e3f5be0c085331268dc1ee724f9742" title="the next entry in the hash chain">next</a>;
<a name="l01505"></a>01505         }
<a name="l01506"></a>01506     }
<a name="l01507"></a>01507     <a class="code" href="_sync_tree_worker_8c.html#a5b7baae8bce01030ed514fd40e6268c5" title="Free the storage for the worker.">SyncTreeWorkerFree</a>(twL);
<a name="l01508"></a>01508 }
<a name="l01509"></a>01509 
<a name="l01510"></a>01510 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01511"></a><a class="code" href="_sync_actions_8c.html#a9a21b71e95e7ec6ee2fa427b57022fbf">01511</a> <a class="code" href="_sync_actions_8c.html#a9a21b71e95e7ec6ee2fa427b57022fbf">SyncStartContentFetch</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root,
<a name="l01512"></a>01512                       <span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name,
<a name="l01513"></a>01513                       <span class="keyword">struct</span> SyncCompareData *comp) {
<a name="l01514"></a>01514     <span class="keyword">static</span> <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.SyncStartContentFetch&quot;</span>;
<a name="l01515"></a>01515     <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>;
<a name="l01516"></a>01516     <span class="keyword">struct </span><a class="code" href="structsync__plumbing.html">sync_plumbing</a> *sd = base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>;
<a name="l01517"></a>01517     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = base-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l01518"></a>01518     <span class="keywordtype">int</span> res = -1;
<a name="l01519"></a>01519     <span class="keyword">struct </span>ccn *ccn = base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>-&gt;<a class="code" href="structsync__plumbing.html#a5c7f66f36ab1eb5de840d06ab1da6e74">ccn</a>;
<a name="l01520"></a>01520     <span class="keywordflow">if</span> (ccn == NULL || name == NULL)
<a name="l01521"></a>01521         <span class="keywordflow">return</span> <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad ccnr handle&quot;</span>, __LINE__);
<a name="l01522"></a>01522     
<a name="l01523"></a>01523     <span class="keywordflow">if</span> (sd-&gt;<a class="code" href="structsync__plumbing.html#a4978a2b8be6bda0393274d9c107b7436">client_methods</a>-&gt;<a class="code" href="structsync__plumbing__client__methods.html#acafd58bc51f62ef7ceebf9cdfae22f57">r_sync_lookup</a> != NULL) {
<a name="l01524"></a>01524         <span class="comment">// first, test to see if the content is already in the repo (yes, it happens)</span>
<a name="l01525"></a>01525         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *interest = <a class="code" href="_sync_util_8c.html#a72ca03631d566369877fc92b0819d720" title="given a spec for the desired fields (scope, lifetime, maxSuffix, child are omitted...">SyncGenInterest</a>(name, 1, 0, 0, -1, NULL); 
<a name="l01526"></a>01526         res = sd-&gt;<a class="code" href="structsync__plumbing.html#a4978a2b8be6bda0393274d9c107b7436">client_methods</a>-&gt;<a class="code" href="structsync__plumbing__client__methods.html#acafd58bc51f62ef7ceebf9cdfae22f57">r_sync_lookup</a>(sd, interest, NULL);
<a name="l01527"></a>01527         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;interest);
<a name="l01528"></a>01528         <span class="keywordflow">if</span> (res &gt;= 0) {
<a name="l01529"></a>01529             <span class="comment">// this name is already in the Repo, no need to fetch</span>
<a name="l01530"></a>01530             <span class="comment">// (ignore the sequence number through this path)</span>
<a name="l01531"></a>01531             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>)
<a name="l01532"></a>01532                 <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, <span class="stringliteral">&quot;ignored, already present&quot;</span>, name);
<a name="l01533"></a>01533             <a class="code" href="_sync_util_8c.html#afe14c6afc4e09022082c1241ba6ab66c" title="Adds the given name to any applicable roots.">SyncAddName</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>, name, 0);
<a name="l01534"></a>01534             <span class="keywordflow">return</span> 0;
<a name="l01535"></a>01535         }
<a name="l01536"></a>01536     }
<a name="l01537"></a>01537     
<a name="l01538"></a>01538     <span class="keyword">struct </span><a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *action = <a class="code" href="_sync_macros_8h.html#ab707d3cfcb52f2e2f819771123942548">NEW_STRUCT</a>(1, <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a>);
<a name="l01539"></a>01539     <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *data = <a class="code" href="_sync_actions_8c.html#a16e2f339bd3d0141bdc0fbf8a128ff26">newActionData</a>(<a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692a88e2022363f5e282355841039623cf19" title="general content">SRI_Kind_Content</a>);
<a name="l01540"></a>01540     data-&gt;<a class="code" href="struct_sync_action_data.html#a74202828f01407a2254b56ba73bdfd23">prefix</a> = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01541"></a>01541     <a class="code" href="charbuf_8h.html#aca88638b2e81602eb4a1da9be923dad7">ccn_charbuf_append_charbuf</a>(data-&gt;<a class="code" href="struct_sync_action_data.html#a74202828f01407a2254b56ba73bdfd23">prefix</a>, name);
<a name="l01542"></a>01542     data-&gt;<a class="code" href="struct_sync_action_data.html#afcaa4a02f141595e243f1be8ff79a3d5">comp</a> = comp;
<a name="l01543"></a>01543     action-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a> = data;
<a name="l01544"></a>01544     action-&gt;<a class="code" href="structccn__closure.html#a48dca74271023e0caf287ad31dd1e66c" title="client-supplied handler">p</a> = &amp;<a class="code" href="_sync_actions_8c.html#ab3bc73d83d698750be68d3a6239fbc61">SyncRemoteFetchResponse</a>;
<a name="l01545"></a>01545     data-&gt;<a class="code" href="struct_sync_action_data.html#ac2ecd62add48955272a5d9402d4532e4">skipToHash</a> = -1;  <span class="comment">// no hash here</span>
<a name="l01546"></a>01546     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *<span class="keyword">template</span> = <a class="code" href="_sync_util_8c.html#a72ca03631d566369877fc92b0819d720" title="given a spec for the desired fields (scope, lifetime, maxSuffix, child are omitted...">SyncGenInterest</a>(NULL,
<a name="l01547"></a>01547                                                    root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a043c6fc891ececbddbc4b446ecd5bc31">syncScope</a>,
<a name="l01548"></a>01548                                                    base-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>-&gt;<a class="code" href="struct_sync_private.html#aef32dcbbdb91811e0931637faa26a1d5">fetchLifetime</a>,
<a name="l01549"></a>01549                                                    0, -1, NULL);
<a name="l01550"></a>01550     res = <a class="code" href="ccn_8h.html#a9f2d6eede46c8aac3dbb4b6e22e1d492">ccn_express_interest</a>(ccn, name, action, <span class="keyword">template</span>);
<a name="l01551"></a>01551     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;<span class="keyword">template</span>);
<a name="l01552"></a>01552     <span class="keywordflow">if</span> (res &gt;= 0) {
<a name="l01553"></a>01553         <span class="comment">// link the request into the root</span>
<a name="l01554"></a>01554         root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a38e2e743a14abac78e109da409dfd072">stats</a>-&gt;<a class="code" href="struct_sync_root_stats.html#a20ef6b375420c7a1d4f59342df8193a3">contentFetchSent</a>++;
<a name="l01555"></a>01555         <a class="code" href="_sync_actions_8c.html#a95080bffa712dcfdea59f2fe0affd18b">linkActionData</a>(root, data);
<a name="l01556"></a>01556         res = 1;
<a name="l01557"></a>01557         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>)
<a name="l01558"></a>01558             <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, <span class="stringliteral">&quot;fetching&quot;</span>, name);
<a name="l01559"></a>01559         comp-&gt;contentFetchBusy++;
<a name="l01560"></a>01560     } <span class="keywordflow">else</span> {
<a name="l01561"></a>01561         <span class="comment">// return the storage</span>
<a name="l01562"></a>01562         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a1aa8c032da69595d9b27357c2bb83da9" title="Severe errors.">CCNL_SEVERE</a>)
<a name="l01563"></a>01563             <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, <span class="stringliteral">&quot;failed&quot;</span>, name);
<a name="l01564"></a>01564         data = <a class="code" href="_sync_actions_8c.html#a9826ac9a64ba2f80ef24985bee419929">destroyActionData</a>(data);
<a name="l01565"></a>01565         free(action);
<a name="l01566"></a>01566         comp-&gt;contentFetchFailed++;
<a name="l01567"></a>01567     }
<a name="l01568"></a>01568     <span class="keywordflow">return</span> res;
<a name="l01569"></a>01569 }
<a name="l01570"></a>01570 
<a name="l01571"></a>01571 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01572"></a><a class="code" href="_sync_actions_8c.html#a9489e03537895943d0ffdbd6378c13d2">01572</a> <a class="code" href="_sync_actions_8c.html#a9489e03537895943d0ffdbd6378c13d2">CompareAction</a>(<span class="keyword">struct</span> ccn_schedule *sched,
<a name="l01573"></a>01573               <span class="keywordtype">void</span> *clienth,
<a name="l01574"></a>01574               <span class="keyword">struct</span> <a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev,
<a name="l01575"></a>01575               <span class="keywordtype">int</span> flags) {
<a name="l01576"></a>01576     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.CompareAction&quot;</span>;
<a name="l01577"></a>01577     <span class="keyword">struct </span>SyncCompareData *data = (<span class="keyword">struct </span>SyncCompareData *) ev-&gt;<a class="code" href="structccn__scheduled__event.html#a4f4c36335e9001eaca5442f672798e95">evdata</a>;
<a name="l01578"></a>01578     if (data == NULL || data-&gt;root == NULL) {
<a name="l01579"></a>01579         <span class="comment">// invalid, not sure how we got here</span>
<a name="l01580"></a>01580         <span class="keywordflow">return</span> -1;
<a name="l01581"></a>01581     }
<a name="l01582"></a>01582     data-&gt;lastEnter = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l01583"></a>01583     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = data-&gt;root;
<a name="l01584"></a>01584     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l01585"></a>01585     <span class="keywordflow">if</span> (data-&gt;ev != ev || flags &amp; <a class="code" href="schedule_8h.html#a705b7a47118864084280c615c0e6a2de">CCN_SCHEDULE_CANCEL</a>) {
<a name="l01586"></a>01586         <span class="comment">// orphaned or cancelled</span>
<a name="l01587"></a>01587         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>)
<a name="l01588"></a>01588             <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;orphan?&quot;</span>);
<a name="l01589"></a>01589         data-&gt;ev = NULL;
<a name="l01590"></a>01590         <span class="keywordflow">return</span> -1;
<a name="l01591"></a>01591     }
<a name="l01592"></a>01592     
<a name="l01593"></a>01593     <span class="keywordtype">int</span> delay = <a class="code" href="_sync_actions_8c.html#a259cad241b04e57ac063e149d3fb511e">shortDelayMicros</a>;
<a name="l01594"></a>01594     <span class="keywordflow">switch</span> (data-&gt;state) {
<a name="l01595"></a>01595         <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767aea4e7487ab4ca7505378434b0cc96e77">SyncCompare_init</a>:
<a name="l01596"></a>01596             <span class="comment">// nothing to do, flow into next state</span>
<a name="l01597"></a>01597             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>)
<a name="l01598"></a>01598                 <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;init&quot;</span>);
<a name="l01599"></a>01599             data-&gt;state = <a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767a13fe7db0510e8011214f3e4156c55f0f">SyncCompare_preload</a>;
<a name="l01600"></a>01600         <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767a13fe7db0510e8011214f3e4156c55f0f">SyncCompare_preload</a>: {
<a name="l01601"></a>01601             <span class="comment">// nothing to do (yet), flow into next state</span>
<a name="l01602"></a>01602             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>)
<a name="l01603"></a>01603                 <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;preload&quot;</span>);
<a name="l01604"></a>01604             <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceR = <a class="code" href="_sync_hash_cache_8c.html#a15c6eafb71bb631fde85a2424f5ac449" title="lookup a full hash in a hash table (raw contents, no tag)">SyncHashLookup</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>,
<a name="l01605"></a>01605                                                             data-&gt;hashR-&gt;buf,
<a name="l01606"></a>01606                                                             data-&gt;hashR-&gt;length);
<a name="l01607"></a>01607             <a class="code" href="_sync_tree_worker_8c.html#a2b23b35551daa1814a39180621642342" title="initialize an existing worker from the cache entry resulting level will be 1">SyncTreeWorkerInit</a>(data-&gt;twR, ceR);
<a name="l01608"></a>01608             <span class="keywordtype">int</span> res = <a class="code" href="_sync_actions_8c.html#a348fc44c61e040fec66f083f0785edaa">doPreload</a>(data);
<a name="l01609"></a>01609             <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01610"></a>01610                 <a class="code" href="_sync_actions_8c.html#a6ffcca40b4dd24eda285bddfc24ece7e">abortCompare</a>(data, <span class="stringliteral">&quot;doPreload failed&quot;</span>);
<a name="l01611"></a>01611                 <span class="keywordflow">return</span> -1;
<a name="l01612"></a>01612             }
<a name="l01613"></a>01613             <span class="keywordflow">if</span> (res == 0) {
<a name="l01614"></a>01614                 <span class="comment">// not yet preloaded</span>
<a name="l01615"></a>01615                 <span class="keywordflow">if</span> (data-&gt;nodeFetchBusy &gt; 0) {
<a name="l01616"></a>01616                     <span class="comment">// rely on SyncRemoteFetchResponse to restart us</span>
<a name="l01617"></a>01617                     data-&gt;ev = NULL;
<a name="l01618"></a>01618                     delay = -1;
<a name="l01619"></a>01619                 }
<a name="l01620"></a>01620                 <span class="keywordflow">break</span>;
<a name="l01621"></a>01621             }
<a name="l01622"></a>01622             <span class="comment">// before switch to busy, reset the remote tree walker</span>
<a name="l01623"></a>01623             <a class="code" href="_sync_tree_worker_8c.html#a2b23b35551daa1814a39180621642342" title="initialize an existing worker from the cache entry resulting level will be 1">SyncTreeWorkerInit</a>(data-&gt;twR, ceR);
<a name="l01624"></a>01624             data-&gt;state = <a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767a167f902359266f6b85bd0cf3fc4e55d6">SyncCompare_busy</a>;
<a name="l01625"></a>01625         }
<a name="l01626"></a>01626         <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767a167f902359266f6b85bd0cf3fc4e55d6">SyncCompare_busy</a>: {
<a name="l01627"></a>01627             <span class="comment">// come here when we are comparing the trees</span>
<a name="l01628"></a>01628             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>)
<a name="l01629"></a>01629                 <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;busy&quot;</span>);
<a name="l01630"></a>01630             <span class="keywordtype">int</span> res = <a class="code" href="_sync_actions_8c.html#a5a4c7d24bb2d0d6fe9008b3b36f70dd3">doComparison</a>(data);
<a name="l01631"></a>01631             <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01632"></a>01632                 <a class="code" href="_sync_actions_8c.html#a6ffcca40b4dd24eda285bddfc24ece7e">abortCompare</a>(data, <span class="stringliteral">&quot;doComparison failed&quot;</span>);
<a name="l01633"></a>01633                 <span class="keywordflow">return</span> -1;
<a name="l01634"></a>01634             }
<a name="l01635"></a>01635             <span class="keywordflow">if</span> (data-&gt;errList != NULL) {
<a name="l01636"></a>01636                 <span class="comment">// we had a load started during compare, so retreat a state</span>
<a name="l01637"></a>01637                 data-&gt;state = <a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767a13fe7db0510e8011214f3e4156c55f0f">SyncCompare_preload</a>;
<a name="l01638"></a>01638                 <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a2813bb28b1559ff71ca56e66d8df63a6" title="Something might be wrong.">CCNL_WARNING</a>)
<a name="l01639"></a>01639                     <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;retreat one state&quot;</span>);
<a name="l01640"></a>01640                 <span class="keywordflow">break</span>;
<a name="l01641"></a>01641             }
<a name="l01642"></a>01642             <span class="keywordflow">if</span> (res == 0)
<a name="l01643"></a>01643                 <span class="comment">// comparison not yet complete</span>
<a name="l01644"></a>01644                 <span class="keywordflow">break</span>;
<a name="l01645"></a>01645             <span class="comment">// either full success or failure gets here</span>
<a name="l01646"></a>01646             data-&gt;state = <a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767a0af8ae16c6d77b372a710583dd92aa50">SyncCompare_waiting</a>;
<a name="l01647"></a>01647         }
<a name="l01648"></a>01648         <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767a0af8ae16c6d77b372a710583dd92aa50">SyncCompare_waiting</a>: {
<a name="l01649"></a>01649             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>)
<a name="l01650"></a>01650                 <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;waiting&quot;</span>);
<a name="l01651"></a>01651             <span class="keyword">struct </span><a class="code" href="struct_sync_name_accum.html">SyncNameAccum</a> *namesToFetch = root-&gt;<a class="code" href="struct_sync_root_struct.html#ac28d004acf78c3ef247937c0b10d8b7c" title="names needing contents fetch">namesToFetch</a>;
<a name="l01652"></a>01652             <span class="keywordtype">int</span> busyLim = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>-&gt;<a class="code" href="struct_sync_private.html#abc0dcd016d407f91323ef33772d98e15">maxFetchBusy</a>;
<a name="l01653"></a>01653             <span class="keywordtype">int</span> len = ((namesToFetch != NULL) ? namesToFetch-&gt;<a class="code" href="struct_sync_name_accum.html#a43e6bf3321957d08f4985443cc36555d">len</a> : 0);
<a name="l01654"></a>01654             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l01655"></a>01655                 <span class="keywordtype">int</span> pos = data-&gt;contentPos;
<a name="l01656"></a>01656                 <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>, <span class="stringliteral">&quot;%s, root#%u, pos %d, names %d&quot;</span>,
<a name="l01657"></a>01657                          here, root-&gt;<a class="code" href="struct_sync_root_struct.html#a86cbcbdd2e2d8c30311da406d36c80e5" title="root Id for reporting">rootId</a>, pos, len);
<a name="l01658"></a>01658             }
<a name="l01659"></a>01659             <span class="keywordflow">while</span> (data-&gt;contentFetchBusy &lt; busyLim
<a name="l01660"></a>01660                    &amp;&amp; data-&gt;contentPos &lt; len) {
<a name="l01661"></a>01661                 <span class="comment">// initiate the content fetches</span>
<a name="l01662"></a>01662                 <span class="keywordtype">int</span> pos = data-&gt;contentPos;
<a name="l01663"></a>01663                 <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = namesToFetch-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[pos].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a>;
<a name="l01664"></a>01664                 <a class="code" href="_sync_actions_8c.html#a9a21b71e95e7ec6ee2fa427b57022fbf">SyncStartContentFetch</a>(root, name, data);
<a name="l01665"></a>01665                 data-&gt;contentPos = pos + 1;
<a name="l01666"></a>01666             }
<a name="l01667"></a>01667             <span class="keywordflow">while</span> (data-&gt;contentFetchBusy &lt; busyLim) {
<a name="l01668"></a>01668                 <span class="comment">// restart the failed fetches</span>
<a name="l01669"></a>01669                 <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *sad = data-&gt;errList;
<a name="l01670"></a>01670                 <span class="keywordflow">if</span> (sad == NULL) <span class="keywordflow">break</span>;
<a name="l01671"></a>01671                 <a class="code" href="_sync_actions_8c.html#a9a21b71e95e7ec6ee2fa427b57022fbf">SyncStartContentFetch</a>(root, sad-&gt;<a class="code" href="struct_sync_action_data.html#a74202828f01407a2254b56ba73bdfd23">prefix</a>, data);
<a name="l01672"></a>01672                 <a class="code" href="_sync_actions_8c.html#a9826ac9a64ba2f80ef24985bee419929">destroyActionData</a>(sad);
<a name="l01673"></a>01673             }
<a name="l01674"></a>01674             <span class="keywordflow">if</span> (data-&gt;contentFetchBusy &gt; 0) {
<a name="l01675"></a>01675                 <span class="comment">// rely on SyncRemoteFetchResponse to restart us</span>
<a name="l01676"></a>01676                 data-&gt;ev = NULL;
<a name="l01677"></a>01677                 delay = -1;
<a name="l01678"></a>01678                 <span class="keywordflow">break</span>;
<a name="l01679"></a>01679             }
<a name="l01680"></a>01680             data-&gt;state = <a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767aeb531ecb7a38ab9a97cb60e31646b3fc">SyncCompare_done</a>;
<a name="l01681"></a>01681         }
<a name="l01682"></a>01682         <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767aeb531ecb7a38ab9a97cb60e31646b3fc">SyncCompare_done</a>: {
<a name="l01683"></a>01683             <span class="comment">// cleanup</span>
<a name="l01684"></a>01684             int64_t now = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l01685"></a>01685             int64_t mh = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(data-&gt;lastEnter, now);
<a name="l01686"></a>01686             int64_t dt = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(data-&gt;startTime, now);
<a name="l01687"></a>01687             root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a38e2e743a14abac78e109da409dfd072">stats</a>-&gt;<a class="code" href="struct_sync_root_stats.html#ac3f27589297fa61ec990992c7159dbc3">comparesDone</a>++;
<a name="l01688"></a>01688             root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a38e2e743a14abac78e109da409dfd072">stats</a>-&gt;<a class="code" href="struct_sync_root_stats.html#a836aa0fb960776160d6a257eda1eb88d">lastCompareMicros</a> = dt;
<a name="l01689"></a>01689             <span class="keywordflow">if</span> (mh &gt; data-&gt;maxHold) data-&gt;maxHold = mh;
<a name="l01690"></a>01690             mh = (mh + 500) / 1000;
<a name="l01691"></a>01691             dt = (dt + 500) / 1000;
<a name="l01692"></a>01692 
<a name="l01693"></a>01693             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l01694"></a>01694                 <span class="keywordtype">int</span> reportStats = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>-&gt;<a class="code" href="struct_sync_private.html#acd528207af00ce4363b23c811eb083e6">syncActionsPrivate</a> &amp; 4;
<a name="l01695"></a>01695                 <span class="keywordtype">char</span> temp[64];
<a name="l01696"></a>01696                 snprintf(temp, <span class="keyword">sizeof</span>(temp)-2,
<a name="l01697"></a>01697                          <span class="stringliteral">&quot;%d.%03d secs [%d.%03d], %d names added&quot;</span>,
<a name="l01698"></a>01698                          (<span class="keywordtype">int</span>) (dt / 1000), (<span class="keywordtype">int</span>) (dt % 1000),
<a name="l01699"></a>01699                          (<span class="keywordtype">int</span>) (mh / 1000), (<span class="keywordtype">int</span>) (mh % 1000),
<a name="l01700"></a>01700                          (<span class="keywordtype">int</span>) data-&gt;namesAdded);
<a name="l01701"></a>01701                 <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, <span class="stringliteral">&quot;done&quot;</span>, temp);
<a name="l01702"></a>01702                 <span class="keywordflow">if</span> (reportStats) {
<a name="l01703"></a>01703                     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *cb = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01704"></a>01704                     <a class="code" href="_sync_actions_8c.html#a2246f94f121a2ca6c1346b721484ed80">formatStats</a>(root, cb);
<a name="l01705"></a>01705                     <span class="keywordtype">char</span> *str = <a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(cb);
<a name="l01706"></a>01706                     <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>, <span class="stringliteral">&quot;%s, %s&quot;</span>, here, str);
<a name="l01707"></a>01707                     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;cb);
<a name="l01708"></a>01708                 }
<a name="l01709"></a>01709             }
<a name="l01710"></a>01710             <a class="code" href="_sync_actions_8c.html#aa82d85556d61517fb147eda456d8170f">destroyCompareData</a>(data);
<a name="l01711"></a>01711             <span class="keywordflow">return</span> -1;
<a name="l01712"></a>01712         }
<a name="l01713"></a>01713         <span class="keywordflow">default</span>: <span class="keywordflow">break</span>;
<a name="l01714"></a>01714     }
<a name="l01715"></a>01715     int64_t mh = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(data-&gt;lastEnter, <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>());
<a name="l01716"></a>01716     <span class="keywordflow">if</span> (mh &gt; data-&gt;maxHold) data-&gt;maxHold = mh;
<a name="l01717"></a>01717     <span class="keywordflow">return</span> delay;
<a name="l01718"></a>01718 }
<a name="l01719"></a>01719 <span class="comment"></span>
<a name="l01720"></a>01720 <span class="comment">///////////////////////////////////////////////////////////////////////////</span>
<a name="l01721"></a>01721 <span class="comment">///// Tree building internal routines</span>
<a name="l01722"></a>01722 <span class="comment">///////////////////////////////////////////////////////////////////////////</span>
<a name="l01723"></a>01723 <span class="comment"></span>
<a name="l01724"></a>01724 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *
<a name="l01725"></a><a class="code" href="_sync_actions_8c.html#a12f107ab8c09088d09713f29247cdbab">01725</a> <a class="code" href="_sync_actions_8c.html#a12f107ab8c09088d09713f29247cdbab">newNodeCommon</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root,
<a name="l01726"></a>01726               <span class="keyword">struct</span> <a class="code" href="struct_sync_node_accum.html">SyncNodeAccum</a> *nodes,
<a name="l01727"></a>01727               <span class="keyword">struct</span> <a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *nc) {
<a name="l01728"></a>01728     <span class="comment">// finish building and inserting a local node</span>
<a name="l01729"></a>01729     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.newNodeCommon&quot;</span>;
<a name="l01730"></a>01730     <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>;
<a name="l01731"></a>01731     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = base-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l01732"></a>01732     <span class="keywordflow">if</span> (nc == NULL || nc-&gt;<a class="code" href="struct_sync_node_composite.html#ab073cc0831daad1ab5096c261f75f6eb" title="combined hash (no tag, requires SyncEndComposite)">hash</a> == NULL) {
<a name="l01733"></a>01733         <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad node&quot;</span>, __LINE__);
<a name="l01734"></a>01734         <span class="keywordflow">return</span> NULL;
<a name="l01735"></a>01735     }
<a name="l01736"></a>01736     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_head.html">SyncHashCacheHead</a> *ch = root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>;
<a name="l01737"></a>01737     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *hash = nc-&gt;<a class="code" href="struct_sync_node_composite.html#ab073cc0831daad1ab5096c261f75f6eb" title="combined hash (no tag, requires SyncEndComposite)">hash</a>;
<a name="l01738"></a>01738     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = <a class="code" href="_sync_hash_cache_8c.html#a15c6eafb71bb631fde85a2424f5ac449" title="lookup a full hash in a hash table (raw contents, no tag)">SyncHashLookup</a>(ch, hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01739"></a>01739     <a class="code" href="_sync_hash_cache_8c.html#a88b8496fee4324b2359f23e3c6dd9472" title="fetches the cache entry to be eligible, ce != NULL &amp;amp;&amp;amp; ce-&amp;gt;ncL != NULL...">SyncCacheEntryFetch</a>(ce);
<a name="l01740"></a>01740     <span class="keywordflow">if</span> (ce != NULL &amp;&amp; ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a> != NULL) {
<a name="l01741"></a>01741         <span class="comment">// an equivalent local node is already in the cache</span>
<a name="l01742"></a>01742         <span class="comment">// so get rid of the new node and return the existing entry</span>
<a name="l01743"></a>01743         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l01744"></a>01744             <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01745"></a>01745             <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, <span class="stringliteral">&quot;suppressed duplicate&quot;</span>, hex);
<a name="l01746"></a>01746             free(hex);
<a name="l01747"></a>01747         }
<a name="l01748"></a>01748         <a class="code" href="_sync_node_8c.html#af28433d58bb465b237a50e3b0aa9d0e4" title="freeComposite returns the storage for the composite object">SyncFreeComposite</a>(nc);
<a name="l01749"></a>01749         nc = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a>;
<a name="l01750"></a>01750         root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a38e2e743a14abac78e109da409dfd072">stats</a>-&gt;<a class="code" href="struct_sync_root_stats.html#a9c4b7420a516f81a8fcbf566b31a93b8">nodesShared</a>++;
<a name="l01751"></a>01751     } <span class="keywordflow">else</span> {
<a name="l01752"></a>01752         <span class="comment">// no local cache entry, so make one</span>
<a name="l01753"></a>01753         <span class="keyword">struct </span><a class="code" href="struct_sync_private.html">SyncPrivate</a> *priv = base-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>;
<a name="l01754"></a>01754         ce = <a class="code" href="_sync_hash_cache_8c.html#abcf5e784c52d971d943bddef80731954" title="based on the raw hash, ensure that a remote cache entry exists ent-&amp;gt;state |= set...">SyncHashEnter</a>(ch, hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a9e849b0fed91e850763db20a54956128" title="a local node exists">SyncHashState_local</a>);
<a name="l01755"></a>01755         <span class="keywordflow">if</span> (ce == NULL) {
<a name="l01756"></a>01756             <span class="comment">// this should not have happened!</span>
<a name="l01757"></a>01757             <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad enter&quot;</span>, __LINE__);
<a name="l01758"></a>01758             <a class="code" href="_sync_node_8c.html#adbec8777422ca7e8c80714aa77afb5a4" title="Decrements the reference count.">SyncNodeDecRC</a>(nc);
<a name="l01759"></a>01759             <span class="keywordflow">return</span> NULL;
<a name="l01760"></a>01760         }
<a name="l01761"></a>01761         ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a> = nc;
<a name="l01762"></a>01762         <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381aec73ed0d374163f11f2d715ce0a3c197" title="a remote hash has been seen">SyncHashState_remote</a>)
<a name="l01763"></a>01763             <a class="code" href="_sync_actions_8c.html#a8d981d346c90e43d3f8d9e52077e28ca">setCovered</a>(ce);
<a name="l01764"></a>01764         <span class="comment">// queue this cache entry for storing</span>
<a name="l01765"></a>01765         ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> |= <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381ad4b20491244029e5364fcf26e8bd7a56" title="local node is queued to be stored">SyncHashState_storing</a>;
<a name="l01766"></a>01766         <span class="keywordflow">if</span> (priv-&gt;<a class="code" href="struct_sync_private.html#a0546eef720ae9f5db072974db5c50630">storingTail</a> == NULL) {
<a name="l01767"></a>01767             <span class="comment">// storing queue is empty</span>
<a name="l01768"></a>01768             priv-&gt;<a class="code" href="struct_sync_private.html#af894176c154e2a66ac8c15c43c905d95">storingHead</a> = ce;
<a name="l01769"></a>01769         } <span class="keywordflow">else</span> {
<a name="l01770"></a>01770             <span class="comment">// append to the tail</span>
<a name="l01771"></a>01771             priv-&gt;<a class="code" href="struct_sync_private.html#a0546eef720ae9f5db072974db5c50630">storingTail</a>-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a5b90f06d440bfd79f5c998a116a0477d" title="the next entry in the storing chain">storing</a> = ce;
<a name="l01772"></a>01772         }
<a name="l01773"></a>01773         priv-&gt;<a class="code" href="struct_sync_private.html#a0546eef720ae9f5db072974db5c50630">storingTail</a> = ce;
<a name="l01774"></a>01774         priv-&gt;<a class="code" href="struct_sync_private.html#a3e547cf3839479721855d5bab5be0e2a">nStoring</a>++;
<a name="l01775"></a>01775         root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a38e2e743a14abac78e109da409dfd072">stats</a>-&gt;<a class="code" href="struct_sync_root_stats.html#a9772ca97f213641e9f310dc58cb55863">nodesCreated</a>++;
<a name="l01776"></a>01776         <span class="keywordflow">if</span> (nc-&gt;<a class="code" href="struct_sync_node_composite.html#a5b1cdb9c3eabafe04a18c8623784ff04" title="pointer to ccnb encoding">cb</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> &gt;= <a class="code" href="_sync_actions_8c.html#ad6e384ed8d6687203b96177c4425df08">nodeSplitTrigger</a>) {
<a name="l01777"></a>01777             <span class="comment">// if this happens then our split estimate was wrong!</span>
<a name="l01778"></a>01778             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>)
<a name="l01779"></a>01779                 <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base,
<a name="l01780"></a>01780                          <span class="stringliteral">&quot;%s, root#%u, cb-&gt;length (%d) &gt;= nodeSplitTrigger (%d)&quot;</span>,
<a name="l01781"></a>01781                          here, root-&gt;<a class="code" href="struct_sync_root_struct.html#a86cbcbdd2e2d8c30311da406d36c80e5" title="root Id for reporting">rootId</a>,
<a name="l01782"></a>01782                          (<span class="keywordtype">int</span>) nc-&gt;<a class="code" href="struct_sync_node_composite.html#a5b1cdb9c3eabafe04a18c8623784ff04" title="pointer to ccnb encoding">cb</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, (<span class="keywordtype">int</span>) <a class="code" href="_sync_actions_8c.html#ad6e384ed8d6687203b96177c4425df08">nodeSplitTrigger</a>);
<a name="l01783"></a>01783         }
<a name="l01784"></a>01784     }
<a name="l01785"></a>01785     <a class="code" href="_sync_node_8c.html#aab2c27ab0d33e00e6bfe576bd9142c0a" title="Increments the reference count.">SyncNodeIncRC</a>(nc);
<a name="l01786"></a>01786     <a class="code" href="_sync_util_8c.html#adcc1cea741c9dc3781e76b1713a6a579">SyncAccumNode</a>(nodes, nc);
<a name="l01787"></a>01787     <span class="keywordflow">return</span> ce;
<a name="l01788"></a>01788 }
<a name="l01789"></a>01789 
<a name="l01790"></a>01790 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *
<a name="l01791"></a><a class="code" href="_sync_actions_8c.html#aafbab8e971bc3b20be60f597bde137d1">01791</a> <a class="code" href="_sync_actions_8c.html#aafbab8e971bc3b20be60f597bde137d1">nodeFromNodes</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root, <span class="keyword">struct</span> <a class="code" href="struct_sync_node_accum.html">SyncNodeAccum</a> *na) {
<a name="l01792"></a>01792     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.nodeFromNodes&quot;</span>;
<a name="l01793"></a>01793     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_head.html">SyncHashCacheHead</a> *ch = root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>;
<a name="l01794"></a>01794     <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>;
<a name="l01795"></a>01795     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = base-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l01796"></a>01796     <span class="keywordtype">int</span> lim = na-&gt;<a class="code" href="struct_sync_node_accum.html#a8039343609e269cef4ae64c55467bdfa">len</a>;
<a name="l01797"></a>01797     <span class="keywordflow">if</span> (lim == 0) {
<a name="l01798"></a>01798         <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;empty&quot;</span>, __LINE__);
<a name="l01799"></a>01799         <span class="keywordflow">return</span> NULL;
<a name="l01800"></a>01800     }
<a name="l01801"></a>01801     <span class="keywordflow">if</span> (lim == 1) {
<a name="l01802"></a>01802         <span class="comment">// just return the singleton node</span>
<a name="l01803"></a>01803         <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *nc = na-&gt;<a class="code" href="struct_sync_node_accum.html#a0c6a127c7ca656dea4b08e09e28ed50e">ents</a>[0];
<a name="l01804"></a>01804         <span class="keywordflow">if</span> (nc == NULL || nc-&gt;<a class="code" href="struct_sync_node_composite.html#ab073cc0831daad1ab5096c261f75f6eb" title="combined hash (no tag, requires SyncEndComposite)">hash</a> == NULL) {
<a name="l01805"></a>01805             <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad node&quot;</span>, __LINE__);
<a name="l01806"></a>01806             <span class="keywordflow">return</span> NULL;
<a name="l01807"></a>01807         }
<a name="l01808"></a>01808         <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = <a class="code" href="_sync_hash_cache_8c.html#a15c6eafb71bb631fde85a2424f5ac449" title="lookup a full hash in a hash table (raw contents, no tag)">SyncHashLookup</a>(ch,
<a name="l01809"></a>01809                                                        nc-&gt;<a class="code" href="struct_sync_node_composite.html#ab073cc0831daad1ab5096c261f75f6eb" title="combined hash (no tag, requires SyncEndComposite)">hash</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>,
<a name="l01810"></a>01810                                                        nc-&gt;<a class="code" href="struct_sync_node_composite.html#ab073cc0831daad1ab5096c261f75f6eb" title="combined hash (no tag, requires SyncEndComposite)">hash</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01811"></a>01811         <span class="keywordflow">if</span> (ce == NULL)
<a name="l01812"></a>01812             <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad lookup&quot;</span>, __LINE__);
<a name="l01813"></a>01813         <span class="keywordflow">return</span> ce;
<a name="l01814"></a>01814     }
<a name="l01815"></a>01815     
<a name="l01816"></a>01816     <span class="keywordtype">int</span> accLim = <a class="code" href="_sync_actions_8c.html#ad6e384ed8d6687203b96177c4425df08">nodeSplitTrigger</a> - <a class="code" href="_sync_actions_8c.html#ad6e384ed8d6687203b96177c4425df08">nodeSplitTrigger</a>/8;
<a name="l01817"></a>01817     <span class="keyword">struct </span><a class="code" href="struct_sync_node_accum.html">SyncNodeAccum</a> *nodes = <a class="code" href="_sync_util_8c.html#acfdd4906ae2c5ffb57df166f281a8436">SyncAllocNodeAccum</a>(0);
<a name="l01818"></a>01818     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = NULL;
<a name="l01819"></a>01819     <span class="keywordtype">int</span> j = 0;
<a name="l01820"></a>01820     <span class="keywordflow">while</span> (j &lt; lim) {
<a name="l01821"></a>01821         <span class="keywordtype">int</span> maxLen = 0;
<a name="l01822"></a>01822         <span class="keywordtype">int</span> i = j;
<a name="l01823"></a>01823         <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *nc = <a class="code" href="_sync_node_8c.html#adbc4a9ebd7d35b9d7c9d36a9c3263bb7" title="allocates a new, empty, composite object">SyncAllocComposite</a>(base);
<a name="l01824"></a>01824         <span class="keywordtype">int</span> accLen = nc-&gt;<a class="code" href="struct_sync_node_composite.html#a5b1cdb9c3eabafe04a18c8623784ff04" title="pointer to ccnb encoding">cb</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>;
<a name="l01825"></a>01825         <span class="comment">// first, loop to find the run length</span>
<a name="l01826"></a>01826         <span class="keywordflow">while</span> (i &lt; lim &amp;&amp; accLen &lt; accLim) {
<a name="l01827"></a>01827             <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *elem = na-&gt;<a class="code" href="struct_sync_node_accum.html#a0c6a127c7ca656dea4b08e09e28ed50e">ents</a>[i];
<a name="l01828"></a>01828             i++;
<a name="l01829"></a>01829             <span class="keywordtype">int</span> nodeLen = elem-&gt;<a class="code" href="struct_sync_node_composite.html#ab073cc0831daad1ab5096c261f75f6eb" title="combined hash (no tag, requires SyncEndComposite)">hash</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> + 8;
<a name="l01830"></a>01830             <span class="keywordflow">if</span> (nodeLen &gt; maxLen) maxLen = nodeLen;
<a name="l01831"></a>01831             accLen = accLen + nodeLen + (maxLen - nodeLen) * 2;
<a name="l01832"></a>01832         }
<a name="l01833"></a>01833         
<a name="l01834"></a>01834         <span class="comment">// append the references in the run</span>
<a name="l01835"></a>01835         <span class="keywordflow">while</span> (j &lt; i) {
<a name="l01836"></a>01836             <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *elem = na-&gt;<a class="code" href="struct_sync_node_accum.html#a0c6a127c7ca656dea4b08e09e28ed50e">ents</a>[j];
<a name="l01837"></a>01837             j++;
<a name="l01838"></a>01838             <a class="code" href="_sync_node_8c.html#acebf6b0bcb035bb0d072abf4e8d02d5f" title="extends the references section of a composite object with a new node, updating the...">SyncNodeAddNode</a>(nc, elem);
<a name="l01839"></a>01839         }
<a name="l01840"></a>01840         <a class="code" href="_sync_node_8c.html#a15cb874167ed7c39b1d2af2957a5036d" title="endComposite finishes up the encoding, appending the composite fields the hash field...">SyncEndComposite</a>(nc); <span class="comment">// finish the node</span>
<a name="l01841"></a>01841         ce = <a class="code" href="_sync_actions_8c.html#a12f107ab8c09088d09713f29247cdbab">newNodeCommon</a>(root, nodes, nc);
<a name="l01842"></a>01842     }
<a name="l01843"></a>01843     <span class="comment">// go recursive just in case we need the extra levels</span>
<a name="l01844"></a>01844     ce = <a class="code" href="_sync_actions_8c.html#aafbab8e971bc3b20be60f597bde137d1">nodeFromNodes</a>(root, nodes);
<a name="l01845"></a>01845     nodes = <a class="code" href="_sync_util_8c.html#a1bc7a4088f04170cdf7ea57e04866c4b">SyncFreeNodeAccum</a>(nodes);
<a name="l01846"></a>01846     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l01847"></a>01847         <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base, <span class="stringliteral">&quot;%s, root#%u, %d refs&quot;</span>, here, root-&gt;<a class="code" href="struct_sync_root_struct.html#a86cbcbdd2e2d8c30311da406d36c80e5" title="root Id for reporting">rootId</a>, lim);
<a name="l01848"></a>01848     }
<a name="l01849"></a>01849     <span class="keywordflow">return</span> ce;
<a name="l01850"></a>01850 }
<a name="l01851"></a>01851 
<a name="l01852"></a>01852 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01853"></a><a class="code" href="_sync_actions_8c.html#a044828070bf2362a52a7f12bd7517537">01853</a> <a class="code" href="_sync_actions_8c.html#a044828070bf2362a52a7f12bd7517537">SyncStartSliceEnum</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root) {
<a name="l01854"></a>01854     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.SyncStartSliceEnum&quot;</span>;
<a name="l01855"></a>01855     <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>;
<a name="l01856"></a>01856     <span class="keyword">struct </span><a class="code" href="structsync__plumbing.html">sync_plumbing</a> *sd = base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>;
<a name="l01857"></a>01857     <span class="keywordflow">if</span> (sd-&gt;<a class="code" href="structsync__plumbing.html#a4978a2b8be6bda0393274d9c107b7436">client_methods</a>-&gt;<a class="code" href="structsync__plumbing__client__methods.html#ac52176f76c4d7084b3899f1a49913495">r_sync_enumerate</a> == NULL)
<a name="l01858"></a>01858         <span class="keywordflow">return</span> -1;
<a name="l01859"></a>01859     <span class="keywordflow">if</span> (base-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>-&gt;<a class="code" href="struct_sync_private.html#a58f4a8cec789303dba45ae3cc09ffb5e">sliceBusy</a> == 0) {
<a name="l01860"></a>01860         <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l01861"></a>01861         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = root-&gt;<a class="code" href="struct_sync_root_struct.html#a88e2d2d45da428702e31f7067278a19a" title="Sync Protocol naming prefix.">namingPrefix</a>;
<a name="l01862"></a>01862         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *nin = <a class="code" href="_sync_util_8c.html#a72ca03631d566369877fc92b0819d720" title="given a spec for the desired fields (scope, lifetime, maxSuffix, child are omitted...">SyncGenInterest</a>(name,
<a name="l01863"></a>01863                                                   -1, -1, -1, -1,
<a name="l01864"></a>01864                                                   NULL);
<a name="l01865"></a>01865         <span class="keywordtype">int</span> res = sd-&gt;<a class="code" href="structsync__plumbing.html#a4978a2b8be6bda0393274d9c107b7436">client_methods</a>-&gt;<a class="code" href="structsync__plumbing__client__methods.html#ac52176f76c4d7084b3899f1a49913495">r_sync_enumerate</a>(sd, nin);
<a name="l01866"></a>01866         
<a name="l01867"></a>01867         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;nin);
<a name="l01868"></a>01868         <span class="keywordflow">if</span> (res &gt; 0) {
<a name="l01869"></a>01869             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>)
<a name="l01870"></a>01870                 <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, <span class="stringliteral">&quot;slice enum start&quot;</span>, name);
<a name="l01871"></a>01871             base-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>-&gt;<a class="code" href="struct_sync_private.html#a58f4a8cec789303dba45ae3cc09ffb5e">sliceBusy</a> = res;
<a name="l01872"></a>01872             root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a312e33d7f5b862de736711a14f7210f8">sliceBusy</a> = res;
<a name="l01873"></a>01873             <span class="keywordflow">return</span> 1;
<a name="l01874"></a>01874         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a1aa8c032da69595d9b27357c2bb83da9" title="Severe errors.">CCNL_SEVERE</a>) {
<a name="l01875"></a>01875             <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, <span class="stringliteral">&quot;slice enum failed&quot;</span>, name);
<a name="l01876"></a>01876             <span class="keywordflow">return</span> -1;
<a name="l01877"></a>01877         }
<a name="l01878"></a>01878     }
<a name="l01879"></a>01879     <span class="keywordflow">return</span> 0;
<a name="l01880"></a>01880 }
<a name="l01881"></a>01881 
<a name="l01882"></a>01882 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01883"></a><a class="code" href="_sync_actions_8c.html#a9a12e6807de3d81b4cbcedec71a719d2">01883</a> <a class="code" href="_sync_actions_8c.html#a9a12e6807de3d81b4cbcedec71a719d2">setFence</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base) {
<a name="l01884"></a>01884     <span class="keyword">struct </span><a class="code" href="struct_sync_private.html">SyncPrivate</a> *priv = base-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>;
<a name="l01885"></a>01885     <span class="keyword">struct </span><a class="code" href="structsync__plumbing.html">sync_plumbing</a> *sd = base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>;
<a name="l01886"></a>01886     <span class="keywordflow">if</span> (sd != NULL &amp;&amp; sd-&gt;<a class="code" href="structsync__plumbing.html#a4978a2b8be6bda0393274d9c107b7436">client_methods</a> != NULL
<a name="l01887"></a>01887         &amp;&amp; sd-&gt;<a class="code" href="structsync__plumbing.html#a4978a2b8be6bda0393274d9c107b7436">client_methods</a>-&gt;<a class="code" href="structsync__plumbing__client__methods.html#a8b547f16f44704896f2a66038e7e5107">r_sync_fence</a> != NULL) {
<a name="l01888"></a>01888         <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = priv-&gt;<a class="code" href="struct_sync_private.html#ab73c3970c30ef4b6d3bcf11eac0b5cef">rootHead</a>;
<a name="l01889"></a>01889         uint64_t fence = priv-&gt;<a class="code" href="struct_sync_private.html#afef14ccb7a9ae7858fd67182025cb614">lastFenceVal</a>;
<a name="l01890"></a>01890         <span class="keywordflow">while</span> (root != NULL) {
<a name="l01891"></a>01891             <span class="keyword">struct </span><a class="code" href="struct_sync_root_private.html">SyncRootPrivate</a> *rp = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>;
<a name="l01892"></a>01892             uint64_t ms = rp-&gt;<a class="code" href="struct_sync_root_private.html#a5c92db78c4f0122436bb02819849478e">max_seq_num_stable</a>;
<a name="l01893"></a>01893             <span class="keywordflow">if</span> (ms &gt; fence) <span class="comment">// XXX: should it not be the min of the maxes?</span>
<a name="l01894"></a>01894                 fence = ms;
<a name="l01895"></a>01895             root = root-&gt;<a class="code" href="struct_sync_root_struct.html#acd0d587d8fdf825a7145f5f26c86cac2" title="next root in our list">next</a>;
<a name="l01896"></a>01896         }
<a name="l01897"></a>01897         <span class="keywordflow">if</span> (fence &gt; priv-&gt;<a class="code" href="struct_sync_private.html#afef14ccb7a9ae7858fd67182025cb614">lastFenceVal</a>) {
<a name="l01898"></a>01898             sd-&gt;<a class="code" href="structsync__plumbing.html#a4978a2b8be6bda0393274d9c107b7436">client_methods</a>-&gt;<a class="code" href="structsync__plumbing__client__methods.html#a8b547f16f44704896f2a66038e7e5107">r_sync_fence</a>(sd, fence);
<a name="l01899"></a>01899             priv-&gt;<a class="code" href="struct_sync_private.html#afef14ccb7a9ae7858fd67182025cb614">lastFenceVal</a> = fence;
<a name="l01900"></a>01900         }
<a name="l01901"></a>01901     }
<a name="l01902"></a>01902 }
<a name="l01903"></a>01903 <span class="comment"></span>
<a name="l01904"></a>01904 <span class="comment">///////////////////////////////////////////////////////////////////////////</span>
<a name="l01905"></a>01905 <span class="comment">///// Main dispatching routine, the heart beat</span>
<a name="l01906"></a>01906 <span class="comment">///////////////////////////////////////////////////////////////////////////</span>
<a name="l01907"></a>01907 <span class="comment"></span>
<a name="l01908"></a>01908 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01909"></a><a class="code" href="_sync_actions_8c.html#a4758fead9a41b25c3856d0a86f308682">01909</a> <a class="code" href="_sync_actions_8c.html#a4758fead9a41b25c3856d0a86f308682">HeartbeatAction</a>(<span class="keyword">struct</span> ccn_schedule *sched,
<a name="l01910"></a>01910                 <span class="keywordtype">void</span> *clienth,
<a name="l01911"></a>01911                 <span class="keyword">struct</span> <a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev,
<a name="l01912"></a>01912                 <span class="keywordtype">int</span> flags) {
<a name="l01913"></a>01913     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.HeartbeatAction&quot;</span>;
<a name="l01914"></a>01914     <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = (<span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *) ev-&gt;<a class="code" href="structccn__scheduled__event.html#a4f4c36335e9001eaca5442f672798e95">evdata</a>;
<a name="l01915"></a>01915     if (base == NULL || base-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a> == NULL || (flags &amp; <a class="code" href="schedule_8h.html#a705b7a47118864084280c615c0e6a2de">CCN_SCHEDULE_CANCEL</a>)) {
<a name="l01916"></a>01916         <span class="comment">// TBD: and why did this happen? (can&#39;t report it, though)</span>
<a name="l01917"></a>01917         <span class="keywordflow">return</span> -1;
<a name="l01918"></a>01918     }
<a name="l01919"></a>01919     
<a name="l01920"></a>01920     <span class="keyword">struct </span><a class="code" href="struct_sync_private.html">SyncPrivate</a> *priv = base-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>;
<a name="l01921"></a>01921     <span class="keywordflow">if</span> (priv-&gt;<a class="code" href="struct_sync_private.html#a6ce7fb490cd43b077407aa78fc307c04">sliceEnum</a> &gt; 0) {
<a name="l01922"></a>01922         <span class="comment">// we are still busy enumerating the slices, so reschedule</span>
<a name="l01923"></a>01923         <span class="keywordflow">return</span> <a class="code" href="_sync_actions_8c.html#a259cad241b04e57ac063e149d3fb511e">shortDelayMicros</a>;
<a name="l01924"></a>01924     }
<a name="l01925"></a>01925     
<a name="l01926"></a>01926     <span class="comment">// check for first root that needs a slice enumeration</span>
<a name="l01927"></a>01927     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = priv-&gt;<a class="code" href="struct_sync_private.html#ab73c3970c30ef4b6d3bcf11eac0b5cef">rootHead</a>;
<a name="l01928"></a>01928     <span class="keywordflow">while</span> (root != NULL) {
<a name="l01929"></a>01929         <span class="keywordflow">if</span> (root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a312e33d7f5b862de736711a14f7210f8">sliceBusy</a> &lt; 0 &amp;&amp; priv-&gt;<a class="code" href="struct_sync_private.html#a58f4a8cec789303dba45ae3cc09ffb5e">sliceBusy</a> == 0) {
<a name="l01930"></a>01930             <span class="comment">// this root needs an enumeration</span>
<a name="l01931"></a>01931             <span class="keywordflow">if</span> (<a class="code" href="_sync_actions_8c.html#a044828070bf2362a52a7f12bd7517537">SyncStartSliceEnum</a>(root) &lt; 0)
<a name="l01932"></a>01932                 <span class="keywordflow">return</span> priv-&gt;<a class="code" href="struct_sync_private.html#a8b696ef7751755c5ad4725910618e5fa">heartbeatMicros</a>;
<a name="l01933"></a>01933             <span class="keywordflow">return</span> <a class="code" href="_sync_actions_8c.html#a259cad241b04e57ac063e149d3fb511e">shortDelayMicros</a>;
<a name="l01934"></a>01934         }
<a name="l01935"></a>01935         root = root-&gt;<a class="code" href="struct_sync_root_struct.html#acd0d587d8fdf825a7145f5f26c86cac2" title="next root in our list">next</a>;
<a name="l01936"></a>01936     }
<a name="l01937"></a>01937     int64_t now = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l01938"></a>01938     root = priv-&gt;<a class="code" href="struct_sync_private.html#ab73c3970c30ef4b6d3bcf11eac0b5cef">rootHead</a>;
<a name="l01939"></a>01939     int64_t lifeMicros = ((int64_t) priv-&gt;<a class="code" href="struct_sync_private.html#a0797a7f49da728903eb8c2a1adbca1a9">rootAdviseLifetime</a>) * <a class="code" href="_sync_actions_8c.html#a52037c938e3c1b126c6277da5ca689d0">M</a>;
<a name="l01940"></a>01940     int64_t needMicros = ((int64_t) <a class="code" href="_sync_actions_8c.html#aa02c95782f2c18068edaec0a8ae9cd78">updateNeedDelta</a>) * <a class="code" href="_sync_actions_8c.html#a52037c938e3c1b126c6277da5ca689d0">M</a>;
<a name="l01941"></a>01941         
<a name="l01942"></a>01942     <span class="keywordflow">while</span> (root != NULL) {
<a name="l01943"></a>01943         <span class="keyword">struct </span><a class="code" href="struct_sync_root_private.html">SyncRootPrivate</a> *rp = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>;
<a name="l01944"></a>01944         <span class="keyword">struct </span>SyncCompareData *comp = root-&gt;<a class="code" href="struct_sync_root_struct.html#afc1f6cd0fc635888971bee16931d4aa6" title="data for doing sync tree comparison">compare</a>;
<a name="l01945"></a>01945         <span class="keywordflow">if</span> (rp-&gt;<a class="code" href="struct_sync_root_private.html#a312e33d7f5b862de736711a14f7210f8">sliceBusy</a> &lt; 0 &amp;&amp; priv-&gt;<a class="code" href="struct_sync_private.html#a58f4a8cec789303dba45ae3cc09ffb5e">sliceBusy</a> == 0) {
<a name="l01946"></a>01946             <span class="comment">// this root needs an enumeration</span>
<a name="l01947"></a>01947             <span class="keywordflow">if</span> (<a class="code" href="_sync_actions_8c.html#a044828070bf2362a52a7f12bd7517537">SyncStartSliceEnum</a>(root) &lt; 0)
<a name="l01948"></a>01948                 <span class="keywordflow">return</span> priv-&gt;<a class="code" href="struct_sync_private.html#a8b696ef7751755c5ad4725910618e5fa">heartbeatMicros</a>;
<a name="l01949"></a>01949         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (priv-&gt;<a class="code" href="struct_sync_private.html#a58f4a8cec789303dba45ae3cc09ffb5e">sliceBusy</a> &gt; 0) {
<a name="l01950"></a>01950             <span class="comment">// this root is busy enumerating</span>
<a name="l01951"></a>01951         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb992ba3fa12a25258ed93ae52b25eb5" title="data for doing sync tree updates">update</a> != NULL) {
<a name="l01952"></a>01952             <span class="comment">// update is busy, so don&#39;t process this root</span>
<a name="l01953"></a>01953         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (comp == NULL) {
<a name="l01954"></a>01954             <span class="comment">// only run the update when not comparing</span>
<a name="l01955"></a>01955             <span class="keywordtype">size_t</span> addLen = root-&gt;<a class="code" href="struct_sync_root_struct.html#a973c1488c9df1486c21fc37465c10def" title="names needing addition to root">namesToAdd</a>-&gt;<a class="code" href="struct_sync_name_accum.html#a43e6bf3321957d08f4985443cc36555d">len</a>;
<a name="l01956"></a>01956             int64_t deltaAdvise = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(rp-&gt;<a class="code" href="struct_sync_root_private.html#a9c79def61eb0960acdd5db128e76e4fe">lastAdvise</a>, now);
<a name="l01957"></a>01957             int64_t deltaUpdate = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(rp-&gt;<a class="code" href="struct_sync_root_private.html#ab12485a114af6f5de646eb708d579ef0">lastUpdate</a>, now);
<a name="l01958"></a>01958             int64_t needUpdate = needMicros;
<a name="l01959"></a>01959             <span class="keywordflow">if</span> (addLen == rp-&gt;<a class="code" href="struct_sync_root_private.html#a547e143db916569c79cf6d5b15b765ab">prevAddLen</a>)
<a name="l01960"></a>01960                 <span class="comment">// no change recently, so </span>
<a name="l01961"></a>01961                 needUpdate = rp-&gt;<a class="code" href="struct_sync_root_private.html#a38e2e743a14abac78e109da409dfd072">stats</a>-&gt;<a class="code" href="struct_sync_root_stats.html#a046206258d64b5e4dc23b6a5420d6315">lastUpdateMicros</a> * 2;
<a name="l01962"></a>01962             <span class="keywordflow">if</span> (rp-&gt;<a class="code" href="struct_sync_root_private.html#ae1767969829a1018570bf64d50ab5c8f">adviseNeed</a> &lt;= 0 &amp;&amp; deltaAdvise &gt; lifeMicros)
<a name="l01963"></a>01963                 <span class="comment">// it&#39;s been a while since the last RootAdvise</span>
<a name="l01964"></a>01964                 rp-&gt;<a class="code" href="struct_sync_root_private.html#ae1767969829a1018570bf64d50ab5c8f">adviseNeed</a> = <a class="code" href="_sync_actions_8c.html#a96ca9c9a78727d3479674cdaa27b56f5">adviseNeedReset</a>;
<a name="l01965"></a>01965             <span class="keywordflow">if</span> (deltaUpdate &gt;= needUpdate) {
<a name="l01966"></a>01966                 <span class="comment">// TBD: determine if this is a good algorithm for adaptive update  </span>
<a name="l01967"></a>01967                 <span class="keywordflow">if</span> (addLen &gt; 0) {
<a name="l01968"></a>01968                     <span class="comment">// need to update the root</span>
<a name="l01969"></a>01969                     <a class="code" href="_sync_actions_8c.html#ac59cbfbac45ae18f43a1bed7d1c6a8ce">SyncUpdateRoot</a>(root);
<a name="l01970"></a>01970                 }
<a name="l01971"></a>01971                 <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceL = rp-&gt;<a class="code" href="struct_sync_root_private.html#abe335cfe4efd3e95c6fd099835d4baf9">ceCurrent</a>;
<a name="l01972"></a>01972                 <span class="keywordflow">if</span> (ceL != NULL &amp;&amp; (ceL-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a9e849b0fed91e850763db20a54956128" title="a local node exists">SyncHashState_local</a>)) {
<a name="l01973"></a>01973                     <span class="keywordflow">if</span> (rp-&gt;<a class="code" href="struct_sync_root_private.html#ae1767969829a1018570bf64d50ab5c8f">adviseNeed</a> &gt; 0 || ceL != rp-&gt;<a class="code" href="struct_sync_root_private.html#a1998de60355f20d0664de51eac6258c8">lastLocalSent</a>) {
<a name="l01974"></a>01974                         <a class="code" href="_sync_actions_8c.html#a883ea40ef1982edd049f48944662a933">SyncSendRootAdviseInterest</a>(root);
<a name="l01975"></a>01975                     }
<a name="l01976"></a>01976                 } <span class="keywordflow">else</span>
<a name="l01977"></a>01977                     <span class="comment">// empty hash, so try for a starting reply</span>
<a name="l01978"></a>01978                     <a class="code" href="_sync_actions_8c.html#a883ea40ef1982edd049f48944662a933">SyncSendRootAdviseInterest</a>(root);
<a name="l01979"></a>01979                 <span class="keywordflow">if</span> (root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb992ba3fa12a25258ed93ae52b25eb5" title="data for doing sync tree updates">update</a> == NULL) {
<a name="l01980"></a>01980                     <span class="keywordflow">if</span> (rp-&gt;<a class="code" href="struct_sync_root_private.html#aaf1e25bbca5a71684b2deefce4f2082f">remoteDeltas</a> != NULL)
<a name="l01981"></a>01981                         <span class="comment">// there are cheap updates to try first</span>
<a name="l01982"></a>01982                         <a class="code" href="_sync_actions_8c.html#ac35071e0f9bf12dcd5d9b37f36463a79">SyncStartCompareAction</a>(root, NULL);
<a name="l01983"></a>01983                     <span class="keywordflow">else</span> {
<a name="l01984"></a>01984                         <span class="comment">// we might try the expensive way</span>
<a name="l01985"></a>01985                         <span class="keyword">struct </span><a class="code" href="struct_sync_hash_info_list.html">SyncHashInfoList</a> *x = <a class="code" href="_sync_actions_8c.html#a7eec1898b50d6390b806243b395b1d53">chooseRemoteHash</a>(root);
<a name="l01986"></a>01986                         <span class="keywordflow">if</span> (x != NULL) {
<a name="l01987"></a>01987                             <a class="code" href="_sync_actions_8c.html#ac35071e0f9bf12dcd5d9b37f36463a79">SyncStartCompareAction</a>(root, x-&gt;<a class="code" href="struct_sync_hash_info_list.html#a454640fcbb0a9ba9baa38dfe544a71ef">ce</a>-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#aba3a8329dde03169d4bb1f369b2d78cf" title="hash used to reach this entry">hash</a>);
<a name="l01988"></a>01988                         }
<a name="l01989"></a>01989                     }
<a name="l01990"></a>01990                 }
<a name="l01991"></a>01991             }
<a name="l01992"></a>01992             rp-&gt;<a class="code" href="struct_sync_root_private.html#a547e143db916569c79cf6d5b15b765ab">prevAddLen</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#a973c1488c9df1486c21fc37465c10def" title="names needing addition to root">namesToAdd</a>-&gt;<a class="code" href="struct_sync_name_accum.html#a43e6bf3321957d08f4985443cc36555d">len</a>;
<a name="l01993"></a>01993         } <span class="keywordflow">else</span> {
<a name="l01994"></a>01994             <span class="comment">// running a compare, check for stall or excessive time since last fetch</span>
<a name="l01995"></a>01995             int64_t dt = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(comp-&gt;lastMark, now);
<a name="l01996"></a>01996             <span class="keywordflow">if</span> (dt &gt; <a class="code" href="_sync_actions_8c.html#acfd7bc324565430eec2237e4631ed78e">updateStallDelta</a>*<a class="code" href="_sync_actions_8c.html#a52037c938e3c1b126c6277da5ca689d0">M</a>) {
<a name="l01997"></a>01997                 <span class="comment">// periodic stall warning</span>
<a name="l01998"></a>01998                 <span class="keywordflow">if</span> (base-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a2813bb28b1559ff71ca56e66d8df63a6" title="Something might be wrong.">CCNL_WARNING</a>)
<a name="l01999"></a>01999                     <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;compare stalled?&quot;</span>);
<a name="l02000"></a>02000                 comp-&gt;lastMark = now;
<a name="l02001"></a>02001             }
<a name="l02002"></a>02002             <span class="comment">// test for fatal stall (based on last fetch time)</span>
<a name="l02003"></a>02003             dt = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(comp-&gt;lastFetchOK, now);
<a name="l02004"></a>02004             <span class="keywordflow">if</span> (dt &gt; <a class="code" href="_sync_actions_8c.html#a4950bbc15af82d9a617aa082cfea552c">compareAssumeBad</a>*M) {
<a name="l02005"></a>02005                 <a class="code" href="_sync_actions_8c.html#a6ffcca40b4dd24eda285bddfc24ece7e">abortCompare</a>(comp, <span class="stringliteral">&quot;no progress&quot;</span>);
<a name="l02006"></a>02006             }
<a name="l02007"></a>02007         }
<a name="l02008"></a>02008         <span class="comment">// TBD: prune eldest remote roots from list</span>
<a name="l02009"></a>02009         <span class="comment">// TBD: prune old remote node entries from cache</span>
<a name="l02010"></a>02010         root = root-&gt;<a class="code" href="struct_sync_root_struct.html#acd0d587d8fdf825a7145f5f26c86cac2" title="next root in our list">next</a>;
<a name="l02011"></a>02011     }
<a name="l02012"></a>02012     int64_t deltaClean = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(priv-&gt;<a class="code" href="struct_sync_private.html#aa8a411a4886e11876d629be29f3a70dc">lastCacheClean</a>, now);
<a name="l02013"></a>02013     <span class="keywordflow">if</span> (priv-&gt;<a class="code" href="struct_sync_private.html#a1be098de9d69d31c3343f6e3aeec76cf">useRepoStore</a> &amp;&amp; deltaClean &gt;= <a class="code" href="_sync_actions_8c.html#aa2d8a6bb0c73f1389f5bb385f99403f4">cacheCleanDelta</a>*<a class="code" href="_sync_actions_8c.html#a52037c938e3c1b126c6277da5ca689d0">M</a>) {
<a name="l02014"></a>02014         <span class="comment">// time to try to clean a batch of cache entries</span>
<a name="l02015"></a>02015         <span class="comment">// TBD: reclaim local nodes when not used for a while?</span>
<a name="l02016"></a>02016         <span class="keywordtype">int</span> cleanRem = <a class="code" href="_sync_actions_8c.html#a7e7cfdcf4ab42abb3df14fbae3e8c633">cacheCleanBatch</a>;
<a name="l02017"></a>02017         <span class="keywordflow">while</span> (cleanRem &gt; 0) {
<a name="l02018"></a>02018             <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = priv-&gt;<a class="code" href="struct_sync_private.html#af894176c154e2a66ac8c15c43c905d95">storingHead</a>;
<a name="l02019"></a>02019             <span class="keywordflow">if</span> (ce == NULL) <span class="keywordflow">break</span>;
<a name="l02020"></a>02020             <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceN = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a5b90f06d440bfd79f5c998a116a0477d" title="the next entry in the storing chain">storing</a>;
<a name="l02021"></a>02021             <a class="code" href="_sync_hash_cache_8c.html#afb2e6f78b30fa3d307dcc9e3b0b86056" title="stores the cahe entry to the repo to be eligible, ce != NULL &amp;amp;&amp;amp; ce-&amp;gt;ncL...">SyncCacheEntryStore</a>(ce);
<a name="l02022"></a>02022             priv-&gt;<a class="code" href="struct_sync_private.html#af894176c154e2a66ac8c15c43c905d95">storingHead</a> = ceN;
<a name="l02023"></a>02023             <span class="keywordflow">if</span> (ceN == NULL) priv-&gt;<a class="code" href="struct_sync_private.html#a0546eef720ae9f5db072974db5c50630">storingTail</a> = ceN;
<a name="l02024"></a>02024             <span class="keywordflow">if</span> (priv-&gt;<a class="code" href="struct_sync_private.html#a3e547cf3839479721855d5bab5be0e2a">nStoring</a> &gt; 0) priv-&gt;<a class="code" href="struct_sync_private.html#a3e547cf3839479721855d5bab5be0e2a">nStoring</a>--;
<a name="l02025"></a>02025             root = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a17d9349c3a973e5322e76c116a4c5b6d" title="the parent head">head</a>-&gt;<a class="code" href="struct_sync_hash_cache_head.html#aae4f738e778a493f25625017a060393f" title="the parent root">root</a>;
<a name="l02026"></a>02026             cleanRem--;
<a name="l02027"></a>02027         }
<a name="l02028"></a>02028         priv-&gt;<a class="code" href="struct_sync_private.html#aa8a411a4886e11876d629be29f3a70dc">lastCacheClean</a> = now;
<a name="l02029"></a>02029     }
<a name="l02030"></a>02030     int64_t deltaFence = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(priv-&gt;<a class="code" href="struct_sync_private.html#ab03a238c3314b3063373347e50254ef7">lastFenceTime</a>, now);
<a name="l02031"></a>02031     <span class="keywordflow">if</span> (priv-&gt;<a class="code" href="struct_sync_private.html#a1be098de9d69d31c3343f6e3aeec76cf">useRepoStore</a> &amp;&amp; deltaFence &gt;= <a class="code" href="_sync_actions_8c.html#a967f58bd9114d0d03f535fb552c89f4f">fenceSeconds</a>*M) {
<a name="l02032"></a>02032         <span class="comment">// TBD: clean a batch of cache entries</span>
<a name="l02033"></a>02033         <span class="comment">// TBD: reclaim local nodes when not used for a while?</span>
<a name="l02034"></a>02034         priv-&gt;<a class="code" href="struct_sync_private.html#ab03a238c3314b3063373347e50254ef7">lastFenceTime</a> = now;
<a name="l02035"></a>02035         <a class="code" href="_sync_actions_8c.html#a9a12e6807de3d81b4cbcedec71a719d2">setFence</a>(base);
<a name="l02036"></a>02036     }
<a name="l02037"></a>02037     
<a name="l02038"></a>02038     <span class="keywordflow">return</span> priv-&gt;<a class="code" href="struct_sync_private.html#a8b696ef7751755c5ad4725910618e5fa">heartbeatMicros</a>;
<a name="l02039"></a>02039 }
<a name="l02040"></a>02040 
<a name="l02041"></a>02041 <span class="comment"></span>
<a name="l02042"></a>02042 <span class="comment">///////////////////////////////////////////////////////////////////////////</span>
<a name="l02043"></a>02043 <span class="comment">///// External routines</span>
<a name="l02044"></a>02044 <span class="comment">///////////////////////////////////////////////////////////////////////////</span>
<a name="l02045"></a>02045 <span class="comment"></span>
<a name="l02046"></a>02046 <span class="keywordtype">int</span>
<a name="l02047"></a><a class="code" href="_sync_actions_8c.html#aff1ca26129e6d6b02bf799de59a26bd8">02047</a> <a class="code" href="_sync_actions_8c.html#aff1ca26129e6d6b02bf799de59a26bd8">SyncStartHeartbeat</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base) {
<a name="l02048"></a>02048     <span class="keyword">static</span> <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.SyncStartHeartbeat&quot;</span>;
<a name="l02049"></a>02049     <span class="keywordtype">int</span> res = -1;
<a name="l02050"></a>02050     <span class="keywordflow">if</span> (base != NULL &amp;&amp; base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>-&gt;<a class="code" href="structsync__plumbing.html#ab5e574093a95dfb432043980ce9a5e17">sched</a> != NULL) {
<a name="l02051"></a>02051         <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = base-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l02052"></a>02052         <span class="keyword">struct </span><a class="code" href="structsync__plumbing.html">sync_plumbing</a> *sd = base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>;
<a name="l02053"></a>02053         <span class="keyword">struct </span><a class="code" href="struct_sync_private.html">SyncPrivate</a> *priv = base-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>;
<a name="l02054"></a>02054         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *nin = <a class="code" href="_sync_util_8c.html#a72ca03631d566369877fc92b0819d720" title="given a spec for the desired fields (scope, lifetime, maxSuffix, child are omitted...">SyncGenInterest</a>(priv-&gt;<a class="code" href="struct_sync_private.html#abb613517c031d15f2a065c28fb0738a0">sliceCmdPrefix</a>,
<a name="l02055"></a>02055                                                   -1, -1, -1, -1,
<a name="l02056"></a>02056                                                   NULL);
<a name="l02057"></a>02057         
<a name="l02058"></a>02058         <span class="comment">// at startup we ask for all of the existing slices</span>
<a name="l02059"></a>02059         <span class="keywordflow">if</span> (sd-&gt;<a class="code" href="structsync__plumbing.html#a4978a2b8be6bda0393274d9c107b7436">client_methods</a>-&gt;<a class="code" href="structsync__plumbing__client__methods.html#ac52176f76c4d7084b3899f1a49913495">r_sync_enumerate</a> != NULL)
<a name="l02060"></a>02060             res = sd-&gt;<a class="code" href="structsync__plumbing.html#a4978a2b8be6bda0393274d9c107b7436">client_methods</a>-&gt;<a class="code" href="structsync__plumbing__client__methods.html#ac52176f76c4d7084b3899f1a49913495">r_sync_enumerate</a>(sd, nin);
<a name="l02061"></a>02061         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;nin);
<a name="l02062"></a>02062         <span class="keywordflow">if</span> (res &gt; 0) {
<a name="l02063"></a>02063             priv-&gt;<a class="code" href="struct_sync_private.html#a6ce7fb490cd43b077407aa78fc307c04">sliceEnum</a> = res;
<a name="l02064"></a>02064             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>)
<a name="l02065"></a>02065                 <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base, <span class="stringliteral">&quot;%s, slice enumerate started, %d&quot;</span>, here, res);
<a name="l02066"></a>02066             res = 0;
<a name="l02067"></a>02067         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a2813bb28b1559ff71ca56e66d8df63a6" title="Something might be wrong.">CCNL_WARNING</a>) {
<a name="l02068"></a>02068             <span class="comment">// it is OK to fail here, since </span>
<a name="l02069"></a>02069             <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base, <span class="stringliteral">&quot;%s, no slices found&quot;</span>, here);
<a name="l02070"></a>02070         }
<a name="l02071"></a>02071         
<a name="l02072"></a>02072         <span class="comment">// next we schedule the heartbeat itself</span>
<a name="l02073"></a>02073         <span class="keyword">struct </span><a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev = <a class="code" href="schedule_8h.html#a1b46f1ba6b54371f41a5c160cd1604ba">ccn_schedule_event</a>(base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>-&gt;<a class="code" href="structsync__plumbing.html#ab5e574093a95dfb432043980ce9a5e17">sched</a>,
<a name="l02074"></a>02074                                                             priv-&gt;<a class="code" href="struct_sync_private.html#a8b696ef7751755c5ad4725910618e5fa">heartbeatMicros</a>,
<a name="l02075"></a>02075                                                             <a class="code" href="_sync_actions_8c.html#a4758fead9a41b25c3856d0a86f308682">HeartbeatAction</a>,
<a name="l02076"></a>02076                                                             base,
<a name="l02077"></a>02077                                                             0);
<a name="l02078"></a>02078         
<a name="l02079"></a>02079         res = 0;
<a name="l02080"></a>02080         <span class="keywordflow">if</span> (ev == NULL) {
<a name="l02081"></a>02081             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a1aa8c032da69595d9b27357c2bb83da9" title="Severe errors.">CCNL_SEVERE</a>)
<a name="l02082"></a>02082                 <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base, <span class="stringliteral">&quot;%s, initial schedule failed!&quot;</span>, here);
<a name="l02083"></a>02083             res = -1;
<a name="l02084"></a>02084         }
<a name="l02085"></a>02085     }
<a name="l02086"></a>02086     <span class="keywordflow">return</span> res;
<a name="l02087"></a>02087 }
<a name="l02088"></a>02088 
<a name="l02089"></a>02089 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *
<a name="l02090"></a><a class="code" href="_sync_actions_8c.html#adb2f129a63a7e944fa3b6bb62f3c3084">02090</a> <a class="code" href="_sync_actions_8c.html#adb2f129a63a7e944fa3b6bb62f3c3084">SyncFindAction</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root, <span class="keyword">enum</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692">SyncRegisterActionKind</a> kind) {
<a name="l02091"></a>02091     <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *each = root-&gt;<a class="code" href="struct_sync_root_struct.html#a17d4b18dfe2d8907b5fe1715699cb353" title="data for pending interests">actions</a>;
<a name="l02092"></a>02092     <span class="keywordflow">while</span> (each != NULL) {
<a name="l02093"></a>02093         <span class="keywordflow">if</span> (each-&gt;<a class="code" href="struct_sync_action_data.html#ad64d193a1ef56426675d4042263da5c5">kind</a> == kind) <span class="keywordflow">return</span> each;
<a name="l02094"></a>02094         each = each-&gt;<a class="code" href="struct_sync_action_data.html#ae24e9863185867798652ec7429afb2c0">next</a>;
<a name="l02095"></a>02095     }
<a name="l02096"></a>02096     <span class="keywordflow">return</span> NULL;
<a name="l02097"></a>02097 }
<a name="l02098"></a>02098 
<a name="l02099"></a>02099 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02100"></a><a class="code" href="_sync_actions_8c.html#ac5cbd5a4401811c4458a1d75fca8c6c4">02100</a> <a class="code" href="_sync_actions_8c.html#ac5cbd5a4401811c4458a1d75fca8c6c4">findAndDeleteRoot</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base, <span class="keywordtype">char</span> *here,
<a name="l02101"></a>02101                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *hp, ssize_t hs) {
<a name="l02102"></a>02102     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = base-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>-&gt;<a class="code" href="struct_sync_private.html#ab73c3970c30ef4b6d3bcf11eac0b5cef">rootHead</a>;
<a name="l02103"></a>02103     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = base-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l02104"></a>02104     <span class="keywordflow">while</span> (root != NULL) {
<a name="l02105"></a>02105         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *sh = root-&gt;<a class="code" href="struct_sync_root_struct.html#add7a152b7bdc85bd56a20b16f1da93f6" title="the raw hash of the sliceCoding">sliceHash</a>;
<a name="l02106"></a>02106         <span class="keywordflow">if</span> (sh-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> == hs &amp;&amp; memcmp(sh-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hp, hs) == 0) {
<a name="l02107"></a>02107             <span class="comment">// matching an existing root, so delete it</span>
<a name="l02108"></a>02108             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l02109"></a>02109                 <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hp, hs);
<a name="l02110"></a>02110                 <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base,
<a name="l02111"></a>02111                          <span class="stringliteral">&quot;%s, root#%u, deleted, %s&quot;</span>,
<a name="l02112"></a>02112                          here, root-&gt;<a class="code" href="struct_sync_root_struct.html#a86cbcbdd2e2d8c30311da406d36c80e5" title="root Id for reporting">rootId</a>, hex);
<a name="l02113"></a>02113                 free(hex);
<a name="l02114"></a>02114             }
<a name="l02115"></a>02115             <span class="comment">// need to remove any pending stores for deleted roots</span>
<a name="l02116"></a>02116             <span class="keyword">struct </span><a class="code" href="struct_sync_private.html">SyncPrivate</a> *priv = base-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>;
<a name="l02117"></a>02117             <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = priv-&gt;<a class="code" href="struct_sync_private.html#af894176c154e2a66ac8c15c43c905d95">storingHead</a>;
<a name="l02118"></a>02118             <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *lag = NULL;
<a name="l02119"></a>02119             <span class="keywordflow">while</span> (ce != NULL) {
<a name="l02120"></a>02120                 <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceN = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a5b90f06d440bfd79f5c998a116a0477d" title="the next entry in the storing chain">storing</a>;
<a name="l02121"></a>02121                 <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a17d9349c3a973e5322e76c116a4c5b6d" title="the parent head">head</a>-&gt;<a class="code" href="struct_sync_hash_cache_head.html#aae4f738e778a493f25625017a060393f" title="the parent root">root</a> == root) {
<a name="l02122"></a>02122                     <span class="comment">// this root is going away, so delink the pending store</span>
<a name="l02123"></a>02123                     <span class="keywordflow">if</span> (lag == NULL) priv-&gt;<a class="code" href="struct_sync_private.html#af894176c154e2a66ac8c15c43c905d95">storingHead</a> = ceN;
<a name="l02124"></a>02124                     <span class="keywordflow">else</span> lag-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a5b90f06d440bfd79f5c998a116a0477d" title="the next entry in the storing chain">storing</a> = ceN;
<a name="l02125"></a>02125                     <span class="keywordflow">if</span> (priv-&gt;<a class="code" href="struct_sync_private.html#a3e547cf3839479721855d5bab5be0e2a">nStoring</a> &gt; 0) priv-&gt;<a class="code" href="struct_sync_private.html#a3e547cf3839479721855d5bab5be0e2a">nStoring</a>--;
<a name="l02126"></a>02126                 } <span class="keywordflow">else</span> lag = ce;
<a name="l02127"></a>02127                 <span class="keywordflow">if</span> (ceN == NULL) priv-&gt;<a class="code" href="struct_sync_private.html#a0546eef720ae9f5db072974db5c50630">storingTail</a> = lag;
<a name="l02128"></a>02128                 ce = ceN;
<a name="l02129"></a>02129             }
<a name="l02130"></a>02130             <span class="comment">// any actions for this root are now invalid</span>
<a name="l02131"></a>02131             <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *actions = root-&gt;<a class="code" href="struct_sync_root_struct.html#a17d4b18dfe2d8907b5fe1715699cb353" title="data for pending interests">actions</a>;
<a name="l02132"></a>02132             root-&gt;<a class="code" href="struct_sync_root_struct.html#a17d4b18dfe2d8907b5fe1715699cb353" title="data for pending interests">actions</a> = NULL;
<a name="l02133"></a>02133             <span class="keywordflow">while</span> (actions != NULL) {
<a name="l02134"></a>02134                 <span class="comment">// mark each interest as inactive, let the timeout free the data</span>
<a name="l02135"></a>02135                 <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *next = actions-&gt;<a class="code" href="struct_sync_action_data.html#ae24e9863185867798652ec7429afb2c0">next</a>;
<a name="l02136"></a>02136                 actions-&gt;<a class="code" href="struct_sync_action_data.html#aec2fc78ddb23d1c2bc5f51841e4a1b07">root</a> = NULL;
<a name="l02137"></a>02137                 actions-&gt;<a class="code" href="struct_sync_action_data.html#ae24e9863185867798652ec7429afb2c0">next</a> = NULL;
<a name="l02138"></a>02138                 actions = next;
<a name="l02139"></a>02139             }
<a name="l02140"></a>02140             <a class="code" href="_sync_root_8c.html#a7e320127c8aedab8b84d66a5816bf0ec" title="Removes the root from the base, and frees up associated storage.">SyncRemRoot</a>(root);
<a name="l02141"></a>02141             <span class="keywordflow">return</span> 1;
<a name="l02142"></a>02142         }
<a name="l02143"></a>02143         root = root-&gt;<a class="code" href="struct_sync_root_struct.html#acd0d587d8fdf825a7145f5f26c86cac2" title="next root in our list">next</a>;
<a name="l02144"></a>02144     }
<a name="l02145"></a>02145     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l02146"></a>02146         <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hp, hs);
<a name="l02147"></a>02147         <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base,
<a name="l02148"></a>02148                  <span class="stringliteral">&quot;%s, root not found, %s&quot;</span>,
<a name="l02149"></a>02149                  here, hex);
<a name="l02150"></a>02150         free(hex);
<a name="l02151"></a>02151     }
<a name="l02152"></a>02152     <span class="keywordflow">return</span> 0;
<a name="l02153"></a>02153 }
<a name="l02154"></a>02154 
<a name="l02155"></a>02155 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02156"></a><a class="code" href="_sync_actions_8c.html#ad570ed53bd25c0b07f250c835150e969">02156</a> <a class="code" href="_sync_actions_8c.html#ad570ed53bd25c0b07f250c835150e969">SyncHandleSlice</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base, <span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name) {
<a name="l02157"></a>02157     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.SyncHandleSlice&quot;</span>;
<a name="l02158"></a>02158     <span class="keywordtype">char</span> *why = NULL;
<a name="l02159"></a>02159     <span class="keyword">struct </span><a class="code" href="structsync__plumbing.html">sync_plumbing</a> *sd = base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>;
<a name="l02160"></a>02160     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = base-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l02161"></a>02161     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *hp = NULL;
<a name="l02162"></a>02162     ssize_t hs = 0;
<a name="l02163"></a>02163     <span class="keywordflow">if</span> (sd-&gt;<a class="code" href="structsync__plumbing.html#a4978a2b8be6bda0393274d9c107b7436">client_methods</a>-&gt;<a class="code" href="structsync__plumbing__client__methods.html#acafd58bc51f62ef7ceebf9cdfae22f57">r_sync_lookup</a> == NULL)
<a name="l02164"></a>02164         <span class="keywordflow">return</span> -__LINE__;
<a name="l02165"></a>02165     <span class="keywordtype">int</span> match = <a class="code" href="_sync_util_8c.html#a4ccb250b1c02f44a29dfb8bbecd77c38">SyncPrefixMatch</a>(base-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>-&gt;<a class="code" href="struct_sync_private.html#abb613517c031d15f2a065c28fb0738a0">sliceCmdPrefix</a>, name, 0);
<a name="l02166"></a>02166     <span class="keywordflow">if</span> (match &lt; 0) <span class="keywordflow">return</span> match;
<a name="l02167"></a>02167     <span class="comment">// the component after the prefix should be the hash</span>
<a name="l02168"></a>02168     <a class="code" href="_sync_util_8c.html#a21fa4394736fe24d8834c404efd4f814" title="finds the bytes for a component (not including the tag) src must be a name, comp...">SyncGetComponentPtr</a>(name, match, &amp;hp, &amp;hs);
<a name="l02169"></a>02169     why = <span class="stringliteral">&quot;invalid hash&quot;</span>;
<a name="l02170"></a>02170     <span class="keywordflow">if</span> (hs &gt; 0 &amp;&amp; hs &lt; <a class="code" href="_sync_macros_8h.html#a3922c71e229552ce16d1c6e016c10dd8">MAX_HASH_BYTES</a>) {
<a name="l02171"></a>02171         <span class="comment">// we pass the first smoke test</span>
<a name="l02172"></a>02172         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *content = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l02173"></a>02173         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *interest = <a class="code" href="_sync_util_8c.html#a72ca03631d566369877fc92b0819d720" title="given a spec for the desired fields (scope, lifetime, maxSuffix, child are omitted...">SyncGenInterest</a>(name, 1, 0, -1, 1, NULL);
<a name="l02174"></a>02174         <span class="keywordtype">int</span> lookupRes = -__LINE__;
<a name="l02175"></a>02175         <span class="keywordflow">if</span> (interest != NULL) {
<a name="l02176"></a>02176             lookupRes = sd-&gt;<a class="code" href="structsync__plumbing.html#a4978a2b8be6bda0393274d9c107b7436">client_methods</a>-&gt;<a class="code" href="structsync__plumbing__client__methods.html#acafd58bc51f62ef7ceebf9cdfae22f57">r_sync_lookup</a>(sd, interest, content);
<a name="l02177"></a>02177             <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;interest);
<a name="l02178"></a>02178         }
<a name="l02179"></a>02179         why = <span class="stringliteral">&quot;bad fetch&quot;</span>;
<a name="l02180"></a>02180         <span class="keywordflow">if</span> (lookupRes &gt;= 0 &amp;&amp; content-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> &gt; 0) {
<a name="l02181"></a>02181             <span class="comment">// we got the content</span>
<a name="l02182"></a>02182             <span class="keyword">struct </span><a class="code" href="structccn__parsed___content_object.html">ccn_parsed_ContentObject</a> pcos;
<a name="l02183"></a>02183             <span class="keyword">struct </span><a class="code" href="structccn__parsed___content_object.html">ccn_parsed_ContentObject</a> *pco = &amp;pcos;
<a name="l02184"></a>02184             <span class="keywordtype">int</span> parseRes = <a class="code" href="ccn_8h.html#a464e10bcdb62aa8821df3ce27eb8c5aa">ccn_parse_ContentObject</a>(content-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>,
<a name="l02185"></a>02185                                                    content-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>,
<a name="l02186"></a>02186                                                    pco, NULL);
<a name="l02187"></a>02187             <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *xp = NULL;
<a name="l02188"></a>02188             <span class="keywordtype">size_t</span> xs = 0;
<a name="l02189"></a>02189             why = <span class="stringliteral">&quot;bad content object&quot;</span>;
<a name="l02190"></a>02190             <span class="keywordflow">if</span> (parseRes &gt;= 0) {
<a name="l02191"></a>02191                 <span class="keywordflow">if</span> (pco-&gt;<a class="code" href="structccn__parsed___content_object.html#a95f6fd64d36fcc6fee3d2770c9cc2ac7">type</a> == <a class="code" href="ccn_8h.html#a5ac452b850189ae724c4ff89ae81c702a73b644ea179c5d4145072df836092a1f">CCN_CONTENT_GONE</a>) {
<a name="l02192"></a>02192                     <a class="code" href="_sync_actions_8c.html#ac5cbd5a4401811c4458a1d75fca8c6c4">findAndDeleteRoot</a>(base, here, hp, hs);
<a name="l02193"></a>02193                     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;content);
<a name="l02194"></a>02194                     <span class="keywordflow">return</span> 0;
<a name="l02195"></a>02195                 } <span class="keywordflow">else</span> {
<a name="l02196"></a>02196                     why = <span class="stringliteral">&quot;bad content start&quot;</span>;
<a name="l02197"></a>02197                     parseRes = <a class="code" href="_sync_util_8c.html#aaae26146344803b2a8c9aa3840bc9ef3" title="given a charbuf cb for a content object, with optional parsing offsets in pco, sets...">SyncPointerToContent</a>(content, pco, &amp;xp, &amp;xs);
<a name="l02198"></a>02198                     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a1aa8c032da69595d9b27357c2bb83da9" title="Severe errors.">CCNL_SEVERE</a> &amp;&amp; (xs &lt;= 0 || parseRes &lt; 0)) {
<a name="l02199"></a>02199                         <span class="comment">// we can&#39;t get the pointer, so somebody is wrong</span>
<a name="l02200"></a>02200                         ssize_t start = pco-&gt;<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387adcd495b5bdd02ccb3679ab3808b3a7c9">CCN_PCO_B_Content</a>];
<a name="l02201"></a>02201                         ssize_t stop = pco-&gt;<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387ad17e965ebbdde723eb20d4f9484ecb3c">CCN_PCO_E_Content</a>];
<a name="l02202"></a>02202                         <span class="keywordtype">int</span> len = stop-start;
<a name="l02203"></a>02203                         <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(content-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>+start, len);
<a name="l02204"></a>02204                         <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base,
<a name="l02205"></a>02205                                  <span class="stringliteral">&quot;%s, invalid content start, line %d, len %d, %s&quot;</span>,
<a name="l02206"></a>02206                                  here, -parseRes, len, hex);
<a name="l02207"></a>02207                         free(hex);
<a name="l02208"></a>02208                     }
<a name="l02209"></a>02209                 }
<a name="l02210"></a>02210             }
<a name="l02211"></a>02211             <span class="keywordflow">if</span> (parseRes &gt;= 0) {
<a name="l02212"></a>02212                 <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = base-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>-&gt;<a class="code" href="struct_sync_private.html#ab73c3970c30ef4b6d3bcf11eac0b5cef">rootHead</a>;
<a name="l02213"></a>02213                 <span class="keywordflow">while</span> (root != NULL) {
<a name="l02214"></a>02214                     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *sh = root-&gt;<a class="code" href="struct_sync_root_struct.html#add7a152b7bdc85bd56a20b16f1da93f6" title="the raw hash of the sliceCoding">sliceHash</a>;
<a name="l02215"></a>02215                     <span class="keywordflow">if</span> (sh-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> == hs &amp;&amp; memcmp(sh-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hp, hs) == 0) {
<a name="l02216"></a>02216                         <span class="comment">// we already have this slice (or at least the hash matches)</span>
<a name="l02217"></a>02217                         <span class="comment">// ignore anything else (first arrival wins)</span>
<a name="l02218"></a>02218                         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l02219"></a>02219                             <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hp, hs);
<a name="l02220"></a>02220                             <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base,
<a name="l02221"></a>02221                                      <span class="stringliteral">&quot;%s, new root ignored for slice %s&quot;</span>,
<a name="l02222"></a>02222                                      here, hex);
<a name="l02223"></a>02223                             free(hex);
<a name="l02224"></a>02224                         }
<a name="l02225"></a>02225                         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;content);
<a name="l02226"></a>02226                         <span class="keywordflow">return</span> 0;
<a name="l02227"></a>02227                     }
<a name="l02228"></a>02228                     root = root-&gt;<a class="code" href="struct_sync_root_struct.html#acd0d587d8fdf825a7145f5f26c86cac2" title="next root in our list">next</a>;
<a name="l02229"></a>02229                 }
<a name="l02230"></a>02230                 why = <span class="stringliteral">&quot;no content tag&quot;</span>;
<a name="l02231"></a>02231                 <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> rds;
<a name="l02232"></a>02232                 <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> *rd = NULL;
<a name="l02233"></a>02233                 rd = <a class="code" href="ccn_8h.html#a4ba830f8dad511663779d85122db633a">ccn_buf_decoder_start</a>(&amp;rds, xp, xs);
<a name="l02234"></a>02234                 root = <a class="code" href="_sync_root_8c.html#acd5e0ea632c51a5e079da5b8bcc25763" title="Parse a content object representing a config slice, and if successful add it to the...">SyncRootDecodeAndAdd</a>(base, rd);
<a name="l02235"></a>02235                 why = <span class="stringliteral">&quot;slice decode&quot;</span>;
<a name="l02236"></a>02236                 <span class="keywordflow">if</span> (root != NULL) {
<a name="l02237"></a>02237                     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *sh = root-&gt;<a class="code" href="struct_sync_root_struct.html#add7a152b7bdc85bd56a20b16f1da93f6" title="the raw hash of the sliceCoding">sliceHash</a>;
<a name="l02238"></a>02238                     <span class="keywordflow">if</span> (sh-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> == hs &amp;&amp; memcmp(sh-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hp, hs) == 0) {
<a name="l02239"></a>02239                         <span class="comment">// this slice is new</span>
<a name="l02240"></a>02240                         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l02241"></a>02241                             <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hp, hs);
<a name="l02242"></a>02242                             <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, <span class="stringliteral">&quot;new root for slice&quot;</span>, hex);
<a name="l02243"></a>02243                             free(hex);
<a name="l02244"></a>02244                         }
<a name="l02245"></a>02245                         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;content);
<a name="l02246"></a>02246                         <a class="code" href="_sync_actions_8c.html#a834f23cf4596b1ef8013a972558f936c">SyncRegisterInterests</a>(root);
<a name="l02247"></a>02247                         <span class="keywordflow">return</span> 1;
<a name="l02248"></a>02248                     } <span class="keywordflow">else</span> {
<a name="l02249"></a>02249                         <span class="comment">// hashes don&#39;t match, so whoever wrote the slice is at fault</span>
<a name="l02250"></a>02250                         <span class="comment">// destroy the root, since it may well be bogus</span>
<a name="l02251"></a>02251                         <span class="comment">// (we could have checked earlier, but the end-to-end check is better)</span>
<a name="l02252"></a>02252                         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a2813bb28b1559ff71ca56e66d8df63a6" title="Something might be wrong.">CCNL_WARNING</a>) {
<a name="l02253"></a>02253                             <span class="keywordtype">char</span> *hexL = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(sh-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, sh-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l02254"></a>02254                             <span class="keywordtype">char</span> *hexR = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hp, hs);
<a name="l02255"></a>02255                             <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base, <span class="stringliteral">&quot;%s, failed, hashes not equal, L %s, R %s&quot;</span>,
<a name="l02256"></a>02256                                      here, hexL, hexR);
<a name="l02257"></a>02257                             free(hexL);
<a name="l02258"></a>02258                             free(hexR);
<a name="l02259"></a>02259                         }
<a name="l02260"></a>02260                         root = <a class="code" href="_sync_root_8c.html#a7e320127c8aedab8b84d66a5816bf0ec" title="Removes the root from the base, and frees up associated storage.">SyncRemRoot</a>(root);
<a name="l02261"></a>02261                         <span class="keywordflow">if</span> (root != NULL) {
<a name="l02262"></a>02262                             <span class="comment">// failed to remove the root, this could be nasty</span>
<a name="l02263"></a>02263                             <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;root not removed&quot;</span>, __LINE__);
<a name="l02264"></a>02264                         }
<a name="l02265"></a>02265                     }
<a name="l02266"></a>02266                 }
<a name="l02267"></a>02267                 
<a name="l02268"></a>02268             }
<a name="l02269"></a>02269         }
<a name="l02270"></a>02270         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a1aa8c032da69595d9b27357c2bb83da9" title="Severe errors.">CCNL_SEVERE</a>)
<a name="l02271"></a>02271             <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base, <span class="stringliteral">&quot;%s, failed! (%s)&quot;</span>, here, why);
<a name="l02272"></a>02272         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;content);
<a name="l02273"></a>02273     }
<a name="l02274"></a>02274     <span class="keywordflow">return</span> -1;
<a name="l02275"></a>02275 }
<a name="l02276"></a>02276 
<a name="l02277"></a>02277 <span class="comment">// NewDeltas allocates a new deltas object for the given root</span>
<a name="l02278"></a>02278 <span class="comment">// note: caller is responsible for storing the pointer </span>
<a name="l02279"></a>02279 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="struct_sync_root_deltas.html">SyncRootDeltas</a> *
<a name="l02280"></a><a class="code" href="_sync_actions_8c.html#a7443aed719df8ae6c7599e34711714b9">02280</a> <a class="code" href="_sync_actions_8c.html#a7443aed719df8ae6c7599e34711714b9">NewDeltas</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root) {
<a name="l02281"></a>02281     <span class="keyword">struct </span><a class="code" href="struct_sync_root_deltas.html">SyncRootDeltas</a> *deltas = <a class="code" href="_sync_macros_8h.html#ab707d3cfcb52f2e2f819771123942548">NEW_STRUCT</a>(1, <a class="code" href="struct_sync_root_deltas.html">SyncRootDeltas</a>);
<a name="l02282"></a>02282     deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a8a2da51337ad341fe46305ad75b3feed">ceStart</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#abe335cfe4efd3e95c6fd099835d4baf9">ceCurrent</a>;
<a name="l02283"></a>02283     deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a2eb71f131a177b594dd505d31ef13f0c">coding</a> = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l02284"></a>02284     deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#aac0743f0c4be65b0fc296b660cb17a53">whenMade</a> = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l02285"></a>02285     <a class="code" href="ccn_8h.html#afc2eb536e63f315968abe901e52b506a" title="Append a start-of-element marker.">ccnb_element_begin</a>(deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a2eb71f131a177b594dd505d31ef13f0c">coding</a>, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33aca145734b1ddf48bd51a90dbe90e5138">CCN_DTAG_SyncNodeDeltas</a>);
<a name="l02286"></a>02286     <a class="code" href="_sync_util_8c.html#a76715b669066c712303384030a36242f">SyncAppendTaggedNumber</a>(deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a2eb71f131a177b594dd505d31ef13f0c">coding</a>, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a4f736b68912ea01258ea8c85f507e144">CCN_DTAG_SyncVersion</a>, <a class="code" href="_sync_actions_8c.html#ad12cf4a0550d67730e5d830dfe78babb">SYNC_UPDATE_VERSION</a>);
<a name="l02287"></a>02287     <span class="keywordflow">return</span> deltas;
<a name="l02288"></a>02288 }
<a name="l02289"></a>02289 
<a name="l02290"></a>02290 <span class="comment">// FreeDeltas frees up a deltas object, which is presumed to be delinked</span>
<a name="l02291"></a>02291 <span class="comment">// no action if deltas == NULL</span>
<a name="l02292"></a>02292 <span class="comment">// returns NULL</span>
<a name="l02293"></a>02293 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="struct_sync_root_deltas.html">SyncRootDeltas</a> *
<a name="l02294"></a><a class="code" href="_sync_actions_8c.html#a406c5876c44e5103173754f0ce6327a0">02294</a> <a class="code" href="_sync_actions_8c.html#a406c5876c44e5103173754f0ce6327a0">FreeDeltas</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_deltas.html">SyncRootDeltas</a> *deltas) {
<a name="l02295"></a>02295     <span class="keywordflow">if</span> (deltas != NULL) {
<a name="l02296"></a>02296         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a2eb71f131a177b594dd505d31ef13f0c">coding</a>);
<a name="l02297"></a>02297         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#ad3f2b0e4b2c0363f5e79f98af9d6e7aa">name</a>);
<a name="l02298"></a>02298         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a8b8de9e0004c44b94632a574d515c6c7">cob</a>);
<a name="l02299"></a>02299         free(deltas);
<a name="l02300"></a>02300     }
<a name="l02301"></a>02301     <span class="keywordflow">return</span> NULL;
<a name="l02302"></a>02302 }
<a name="l02303"></a>02303 
<a name="l02304"></a>02304 <span class="comment">// RemRootDeltas removes a specific deltas object from the chain,</span>
<a name="l02305"></a>02305 <span class="comment">// updating the chain head and tail and the count as needed</span>
<a name="l02306"></a>02306 <span class="comment">// returns 1 if the rmoval worked, 0 if the object was not found</span>
<a name="l02307"></a>02307 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02308"></a><a class="code" href="_sync_actions_8c.html#a4cb6f1f2011fc2d9e2e79aa09c829c7f">02308</a> <a class="code" href="_sync_actions_8c.html#a4cb6f1f2011fc2d9e2e79aa09c829c7f">RemRootDeltas</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root, <span class="keyword">struct</span> <a class="code" href="struct_sync_root_deltas.html">SyncRootDeltas</a> *deltas) {
<a name="l02309"></a>02309     <span class="keyword">struct </span><a class="code" href="struct_sync_root_private.html">SyncRootPrivate</a> *rp = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>;
<a name="l02310"></a>02310     <span class="keywordflow">if</span> (deltas != NULL) {
<a name="l02311"></a>02311         <span class="keyword">struct </span><a class="code" href="struct_sync_root_deltas.html">SyncRootDeltas</a> *lag = NULL;
<a name="l02312"></a>02312         <span class="keyword">struct </span><a class="code" href="struct_sync_root_deltas.html">SyncRootDeltas</a> *each = rp-&gt;<a class="code" href="struct_sync_root_private.html#a5af352dcc2e4e1b3971291edcf79de1b">deltasHead</a>;
<a name="l02313"></a>02313         <span class="keywordflow">while</span> (each != NULL) {
<a name="l02314"></a>02314             <span class="keyword">struct </span><a class="code" href="struct_sync_root_deltas.html">SyncRootDeltas</a> *next = each-&gt;<a class="code" href="struct_sync_root_deltas.html#aa72728441fb5d92b6e88a173593be109">next</a>;
<a name="l02315"></a>02315             <span class="keywordflow">if</span> (each == deltas) {
<a name="l02316"></a>02316                 <span class="comment">// found it, so delink</span>
<a name="l02317"></a>02317                 <span class="keywordflow">if</span> (lag == NULL) rp-&gt;<a class="code" href="struct_sync_root_private.html#a5af352dcc2e4e1b3971291edcf79de1b">deltasHead</a> = next;
<a name="l02318"></a>02318                 <span class="keywordflow">else</span> lag-&gt;<a class="code" href="struct_sync_root_deltas.html#aa72728441fb5d92b6e88a173593be109">next</a> = next;
<a name="l02319"></a>02319                 <span class="keywordflow">if</span> (deltas == rp-&gt;<a class="code" href="struct_sync_root_private.html#aafd656c3421405665406939706237aef">deltasTail</a>)
<a name="l02320"></a>02320                     rp-&gt;<a class="code" href="struct_sync_root_private.html#aafd656c3421405665406939706237aef">deltasTail</a> = lag;
<a name="l02321"></a>02321                 rp-&gt;<a class="code" href="struct_sync_root_private.html#a1057f2fa60ff406d5470f057615fc53b">nDeltas</a>--;
<a name="l02322"></a>02322                 <span class="comment">// delinked, so free the storage</span>
<a name="l02323"></a>02323                 <a class="code" href="_sync_actions_8c.html#a406c5876c44e5103173754f0ce6327a0">FreeDeltas</a>(deltas);
<a name="l02324"></a>02324                 <span class="keywordflow">return</span> 1;
<a name="l02325"></a>02325             }
<a name="l02326"></a>02326             lag = each;
<a name="l02327"></a>02327             each = next;
<a name="l02328"></a>02328         }
<a name="l02329"></a>02329     }
<a name="l02330"></a>02330     <span class="keywordflow">return</span> 0;
<a name="l02331"></a>02331 }
<a name="l02332"></a>02332 
<a name="l02333"></a>02333 <span class="comment">// SendDeltasReply sends a RootAdvise reply using the given deltas.</span>
<a name="l02334"></a>02334 <span class="comment">// It may purge older deltas objects from the root.</span>
<a name="l02335"></a>02335 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02336"></a><a class="code" href="_sync_actions_8c.html#acc491ad38b38700ae0597ecc5422eca3">02336</a> <a class="code" href="_sync_actions_8c.html#acc491ad38b38700ae0597ecc5422eca3">SendDeltasReply</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root, <span class="keyword">struct</span> <a class="code" href="struct_sync_root_deltas.html">SyncRootDeltas</a> *deltas) {
<a name="l02337"></a>02337     <span class="keyword">static</span> <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.SendDeltasReply&quot;</span>;
<a name="l02338"></a>02338     <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>;
<a name="l02339"></a>02339     <span class="keyword">struct </span><a class="code" href="struct_sync_root_private.html">SyncRootPrivate</a> *rp = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>;
<a name="l02340"></a>02340     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#ad3f2b0e4b2c0363f5e79f98af9d6e7aa">name</a>;
<a name="l02341"></a>02341     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *cob = deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a8b8de9e0004c44b94632a574d515c6c7">cob</a>;
<a name="l02342"></a>02342     <span class="keywordtype">int</span> res = 0;
<a name="l02343"></a>02343     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l02344"></a>02344     <span class="keywordtype">char</span> *newCobMsg = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02345"></a>02345     <span class="keywordflow">if</span> (name == NULL) {
<a name="l02346"></a>02346         <span class="comment">// don&#39;t have an output name yet, so make it</span>
<a name="l02347"></a>02347         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *hash = NULL;
<a name="l02348"></a>02348         name = <a class="code" href="_sync_actions_8c.html#adf89fd412f0e65a80e9a7e961f7d6b13">constructCommandPrefix</a>(root, <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692a8e4c22d4ecccb39943c4a3ebaa6ea0e2" title="root advise request">SRI_Kind_RootAdvise</a>);
<a name="l02349"></a>02349         <span class="keywordflow">if</span> (deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a8a2da51337ad341fe46305ad75b3feed">ceStart</a> != NULL) hash = deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a8a2da51337ad341fe46305ad75b3feed">ceStart</a>-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#aba3a8329dde03169d4bb1f369b2d78cf" title="hash used to reach this entry">hash</a>;
<a name="l02350"></a>02350         <span class="keywordflow">if</span> (hash == NULL)
<a name="l02351"></a>02351             <span class="comment">// empty component</span>
<a name="l02352"></a>02352             <a class="code" href="ccn_8h.html#aec5620dc4689a663ea7181cdebeda4d0" title="Add a Component that is a NUL-terminated string.">ccn_name_append_str</a>(name, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02353"></a>02353         <span class="keywordflow">else</span>
<a name="l02354"></a>02354             <span class="comment">// append the start hash as a component</span>
<a name="l02355"></a>02355             <a class="code" href="ccn_8h.html#a3f4f614f38ae77dccb4099e982c646f8" title="Add a Component to a Name.">ccn_name_append</a>(name, hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l02356"></a>02356         <span class="comment">// next, append the stop hash to the name</span>
<a name="l02357"></a>02357         hash = deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a243f388894db181de5c5b603e466a1d6">ceStop</a>-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#aba3a8329dde03169d4bb1f369b2d78cf" title="hash used to reach this entry">hash</a>;
<a name="l02358"></a>02358         <a class="code" href="ccn_8h.html#a3f4f614f38ae77dccb4099e982c646f8" title="Add a Component to a Name.">ccn_name_append</a>(name, hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l02359"></a>02359         <a class="code" href="ccn_8h.html#af222a5e0ff25d4f2ff60eed72b3defb2" title="Extend a Name with a new version stamp.">ccn_create_version</a>(base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>-&gt;<a class="code" href="structsync__plumbing.html#a5c7f66f36ab1eb5de840d06ab1da6e74">ccn</a>, name, <a class="code" href="ccn_8h.html#ac0d9b4a6ddee8ae94d87d8c2340ac907" title="use current time">CCN_V_NOW</a>, 0, 0);
<a name="l02360"></a>02360         <a class="code" href="ccn_8h.html#a3b95a770555b90f43d4876bea62c202d" title="Add a binary Component to a ccnb-encoded Name.">ccn_name_append_numeric</a>(name, <a class="code" href="ccn_8h.html#afec910e39c89dcf24a44f93e97032399af3eb8e7fa3a938a5bcc6c1f141357d71" title="consecutive block sequence numbers">CCN_MARKER_SEQNUM</a>, 0);
<a name="l02361"></a>02361         deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#ad3f2b0e4b2c0363f5e79f98af9d6e7aa">name</a> = name;
<a name="l02362"></a>02362     }
<a name="l02363"></a>02363     <span class="keywordflow">if</span> (cob == NULL) {
<a name="l02364"></a>02364         <span class="comment">// don&#39;t have a signed outbut buffer</span>
<a name="l02365"></a>02365         cob = <a class="code" href="_sync_util_8c.html#aa44ff275b91059d05c609fa23e95418d" title="given a charbuf cb and name for a content object, signs the bytes and">SyncSignBuf</a>(base, deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a2eb71f131a177b594dd505d31ef13f0c">coding</a>, name,
<a name="l02366"></a>02366                           base-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>-&gt;<a class="code" href="struct_sync_private.html#a5c957e953884aae22719c05b8f3adb55">rootAdviseFresh</a>,
<a name="l02367"></a>02367                           <a class="code" href="ccn_8h.html#abff51f3f313d457fbcc13006343fdd28">CCN_SP_FINAL_BLOCK</a>);
<a name="l02368"></a>02368         deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a8b8de9e0004c44b94632a574d515c6c7">cob</a> = cob;
<a name="l02369"></a>02369         newCobMsg = <span class="stringliteral">&quot;+&quot;</span>;
<a name="l02370"></a>02370     }
<a name="l02371"></a>02371     res = <a class="code" href="ccn_8h.html#ac71f5c8727443c13afb11cf471f5f8fc">ccn_put</a>(base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>-&gt;<a class="code" href="structsync__plumbing.html#a5c7f66f36ab1eb5de840d06ab1da6e74">ccn</a>, cob-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, cob-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l02372"></a>02372     <span class="keywordflow">if</span> (res &gt;= 0) {
<a name="l02373"></a>02373         <span class="comment">// we have success!</span>
<a name="l02374"></a>02374         deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#aa69ba4a9afeaa0fd81349eefdfcc9a82">whenSent</a> = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l02375"></a>02375         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l02376"></a>02376             <span class="keywordtype">char</span> temp[64];
<a name="l02377"></a>02377             snprintf(temp, <span class="keyword">sizeof</span>(temp),
<a name="l02378"></a>02378                                <span class="stringliteral">&quot;reply sent%s (%u)&quot;</span>,
<a name="l02379"></a>02379                                newCobMsg,
<a name="l02380"></a>02380                                deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a2b8fbeba7e9500e5a01ff045ebafbca4">deltasCount</a>);
<a name="l02381"></a>02381             <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, temp, name);
<a name="l02382"></a>02382             <span class="keywordflow">if</span> (<a class="code" href="_sync_actions_8c.html#ad990ae99fb88eb7b8bb2864dd04a459f">showHighLevel</a>)
<a name="l02383"></a>02383                 <a class="code" href="_sync_actions_8c.html#a693571491e7f8b307640238175b6aa57">showCacheEntry2</a>(root, <span class="stringliteral">&quot;Sync.$RootAdvise&quot;</span>, temp,
<a name="l02384"></a>02384                                 deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a8a2da51337ad341fe46305ad75b3feed">ceStart</a>, deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a243f388894db181de5c5b603e466a1d6">ceStop</a>);
<a name="l02385"></a>02385         }
<a name="l02386"></a>02386     } <span class="keywordflow">else</span> {
<a name="l02387"></a>02387         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a1aa8c032da69595d9b27357c2bb83da9" title="Severe errors.">CCNL_SEVERE</a>)
<a name="l02388"></a>02388             <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, <span class="stringliteral">&quot;reply failed&quot;</span>, name);
<a name="l02389"></a>02389     }
<a name="l02390"></a>02390     <span class="comment">// purge deltas beyond some count</span>
<a name="l02391"></a>02391     <span class="comment">// (TBD: better method for purging?)</span>
<a name="l02392"></a>02392     <span class="keywordflow">while</span> (rp-&gt;<a class="code" href="struct_sync_root_private.html#a1057f2fa60ff406d5470f057615fc53b">nDeltas</a> &gt; <a class="code" href="_sync_actions_8c.html#ab72e0532e7d3a1c56b45587dd044ac04">nDeltasLimit</a>) {
<a name="l02393"></a>02393         deltas = rp-&gt;<a class="code" href="struct_sync_root_private.html#a5af352dcc2e4e1b3971291edcf79de1b">deltasHead</a>;
<a name="l02394"></a>02394         <span class="keywordflow">if</span> (deltas == rp-&gt;<a class="code" href="struct_sync_root_private.html#aafd656c3421405665406939706237aef">deltasTail</a>) <span class="keywordflow">break</span>;
<a name="l02395"></a>02395         <span class="keywordflow">if</span> (<a class="code" href="_sync_actions_8c.html#a4cb6f1f2011fc2d9e2e79aa09c829c7f">RemRootDeltas</a>(root, deltas) != 1) <span class="keywordflow">break</span>;
<a name="l02396"></a>02396     }
<a name="l02397"></a>02397     <span class="keywordflow">return</span> res;
<a name="l02398"></a>02398 }
<a name="l02399"></a>02399 
<a name="l02400"></a>02400 <span class="comment">// scanRemoteSeen returns the first SyncHashInfoList object int the remoteSeen</span>
<a name="l02401"></a>02401 <span class="comment">// list that refers to the given hash entry (which may be NULL)</span>
<a name="l02402"></a>02402 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="struct_sync_hash_info_list.html">SyncHashInfoList</a> *
<a name="l02403"></a><a class="code" href="_sync_actions_8c.html#af6a5e58957baa0d187552042740ccdd6">02403</a> <a class="code" href="_sync_actions_8c.html#af6a5e58957baa0d187552042740ccdd6">scanRemoteSeen</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root, <span class="keyword">struct</span> <a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceR) {
<a name="l02404"></a>02404     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_info_list.html">SyncHashInfoList</a> *remoteSeen = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a7c217e7610fe07ecbf7ad85c2b4785c7">remoteSeen</a>;
<a name="l02405"></a>02405     <span class="keywordflow">while</span> (remoteSeen != NULL) {
<a name="l02406"></a>02406         <span class="keywordflow">if</span> (remoteSeen-&gt;<a class="code" href="struct_sync_hash_info_list.html#a454640fcbb0a9ba9baa38dfe544a71ef">ce</a> == ceR) <span class="keywordflow">return</span> remoteSeen;
<a name="l02407"></a>02407         remoteSeen = remoteSeen-&gt;<a class="code" href="struct_sync_hash_info_list.html#a09d3622f803ab21ac48e83f1fafdd643">next</a>;
<a name="l02408"></a>02408     }
<a name="l02409"></a>02409     <span class="keywordflow">return</span> NULL;
<a name="l02410"></a>02410 }
<a name="l02411"></a>02411 
<a name="l02412"></a>02412 <span class="comment">// CloseUpdateCoding finishes up the deltas object (closes the coding),</span>
<a name="l02413"></a>02413 <span class="comment">// removes it from the updates, and moves it to the root</span>
<a name="l02414"></a>02414 <span class="comment">// note: if the update object has a deltas object then the coding is not closed!</span>
<a name="l02415"></a>02415 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="struct_sync_root_deltas.html">SyncRootDeltas</a> *
<a name="l02416"></a><a class="code" href="_sync_actions_8c.html#a61417e4f76c984616002640ea5d825c4">02416</a> <a class="code" href="_sync_actions_8c.html#a61417e4f76c984616002640ea5d825c4">CloseUpdateCoding</a>(<span class="keyword">struct</span> SyncUpdateData *ud) {
<a name="l02417"></a>02417     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = ud-&gt;root;
<a name="l02418"></a>02418     <span class="keyword">struct </span><a class="code" href="struct_sync_root_deltas.html">SyncRootDeltas</a> *deltas = ud-&gt;deltas;
<a name="l02419"></a>02419     <span class="keywordflow">if</span> (deltas != NULL) {
<a name="l02420"></a>02420         <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceStop = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#abe335cfe4efd3e95c6fd099835d4baf9">ceCurrent</a>;
<a name="l02421"></a>02421         ud-&gt;deltas = NULL;
<a name="l02422"></a>02422         deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#aa72728441fb5d92b6e88a173593be109">next</a> = NULL;
<a name="l02423"></a>02423         <span class="keywordflow">if</span> (deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a2b8fbeba7e9500e5a01ff045ebafbca4">deltasCount</a> &lt;= 0 || deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a2eb71f131a177b594dd505d31ef13f0c">coding</a> == NULL || ud-&gt;ceStart == ceStop) {
<a name="l02424"></a>02424             <span class="comment">// nothing here, so forget it (fail over to using NodeFetch)</span>
<a name="l02425"></a>02425             <a class="code" href="_sync_actions_8c.html#a406c5876c44e5103173754f0ce6327a0">FreeDeltas</a>(deltas);
<a name="l02426"></a>02426             deltas = NULL;
<a name="l02427"></a>02427         } <span class="keywordflow">else</span> {
<a name="l02428"></a>02428             <span class="comment">// link into the deltas chain</span>
<a name="l02429"></a>02429             <a class="code" href="ccn_8h.html#aa46b72f2e6b3b7f7753ff3baaa4efdf8" title="Append an end-of-element marker.">ccnb_element_end</a>(deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a2eb71f131a177b594dd505d31ef13f0c">coding</a>);
<a name="l02430"></a>02430             <span class="keyword">struct </span><a class="code" href="struct_sync_root_private.html">SyncRootPrivate</a> *rp = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>;
<a name="l02431"></a>02431             <span class="keyword">struct </span><a class="code" href="struct_sync_root_deltas.html">SyncRootDeltas</a> *tail = rp-&gt;<a class="code" href="struct_sync_root_private.html#aafd656c3421405665406939706237aef">deltasTail</a>;
<a name="l02432"></a>02432             <span class="keywordflow">if</span> (tail != NULL) {
<a name="l02433"></a>02433                 tail-&gt;<a class="code" href="struct_sync_root_deltas.html#aa72728441fb5d92b6e88a173593be109">next</a> = deltas;
<a name="l02434"></a>02434             } <span class="keywordflow">else</span> {
<a name="l02435"></a>02435                 rp-&gt;<a class="code" href="struct_sync_root_private.html#a5af352dcc2e4e1b3971291edcf79de1b">deltasHead</a> = deltas;
<a name="l02436"></a>02436             }
<a name="l02437"></a>02437             tail = deltas;
<a name="l02438"></a>02438             deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a243f388894db181de5c5b603e466a1d6">ceStop</a> = ceStop;
<a name="l02439"></a>02439             rp-&gt;<a class="code" href="struct_sync_root_private.html#a1057f2fa60ff406d5470f057615fc53b">nDeltas</a>++;
<a name="l02440"></a>02440         }
<a name="l02441"></a>02441     }
<a name="l02442"></a>02442     <span class="keywordflow">return</span> deltas;
<a name="l02443"></a>02443 }
<a name="l02444"></a>02444 
<a name="l02445"></a>02445 <span class="comment">// scanDeltas retruns the first SyncRootDeltas object that starts with</span>
<a name="l02446"></a>02446 <span class="comment">// the given hash entry</span>
<a name="l02447"></a>02447 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="struct_sync_root_deltas.html">SyncRootDeltas</a> *
<a name="l02448"></a><a class="code" href="_sync_actions_8c.html#a1b1dfd4819fcf3f685f6e09273713102">02448</a> <a class="code" href="_sync_actions_8c.html#a1b1dfd4819fcf3f685f6e09273713102">scanDeltas</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root, <span class="keyword">struct</span> <a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceR) {
<a name="l02449"></a>02449     <span class="keyword">struct </span><a class="code" href="struct_sync_root_deltas.html">SyncRootDeltas</a> *deltas = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a5af352dcc2e4e1b3971291edcf79de1b">deltasHead</a>;
<a name="l02450"></a>02450     <span class="keywordflow">while</span> (deltas != NULL) {
<a name="l02451"></a>02451         <span class="keywordflow">if</span> (deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a8a2da51337ad341fe46305ad75b3feed">ceStart</a> == ceR) <span class="keywordflow">break</span>;
<a name="l02452"></a>02452         deltas = deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#aa72728441fb5d92b6e88a173593be109">next</a>;
<a name="l02453"></a>02453     }
<a name="l02454"></a>02454     <span class="keywordflow">return</span> deltas;
<a name="l02455"></a>02455 }
<a name="l02456"></a>02456 
<a name="l02457"></a>02457 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a>
<a name="l02458"></a><a class="code" href="_sync_actions_8c.html#ae0b12eb9cb07cbc4a15e45982d6f3c95">02458</a> <a class="code" href="_sync_actions_8c.html#ae0b12eb9cb07cbc4a15e45982d6f3c95">SyncInterestArrived</a>(<span class="keyword">struct</span> <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *selfp,
<a name="l02459"></a>02459                     <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92" title="This tells what kind of event the upcall is handling.">ccn_upcall_kind</a> kind,
<a name="l02460"></a>02460                     <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info) {
<a name="l02461"></a>02461     <span class="keyword">static</span> <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.SyncInterestArrived&quot;</span>;
<a name="l02462"></a>02462     <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *data = selfp-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a>;
<a name="l02463"></a>02463     <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a> ret = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcadadb47635316f12c6542c33cebcfa727" title="normal upcall return">CCN_UPCALL_RESULT_OK</a>;
<a name="l02464"></a>02464     <span class="keywordtype">char</span> temp[200];
<a name="l02465"></a>02465     <span class="keywordflow">switch</span> (kind) {
<a name="l02466"></a>02466         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92ad00afdf8a89c718f4c451600b115b5e0" title="handler is about to be deregistered">CCN_UPCALL_FINAL</a>:
<a name="l02467"></a>02467             data = <a class="code" href="_sync_actions_8c.html#a9826ac9a64ba2f80ef24985bee419929">destroyActionData</a>(data);
<a name="l02468"></a>02468             free(selfp);
<a name="l02469"></a>02469             <span class="keywordflow">break</span>;
<a name="l02470"></a>02470         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a10dc20968eaf28989921d076bbc81d62" title="incoming interest">CCN_UPCALL_INTEREST</a>: {
<a name="l02471"></a>02471             <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = data-&gt;<a class="code" href="struct_sync_action_data.html#aec2fc78ddb23d1c2bc5f51841e4a1b07">root</a>;
<a name="l02472"></a>02472             <span class="keywordflow">if</span> (root == NULL) <span class="keywordflow">break</span>;
<a name="l02473"></a>02473             <span class="keyword">struct </span><a class="code" href="struct_sync_root_private.html">SyncRootPrivate</a> *rp = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>;
<a name="l02474"></a>02474             <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>;
<a name="l02475"></a>02475             <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = base-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l02476"></a>02476             <span class="keywordtype">int</span> skipToHash = data-&gt;<a class="code" href="struct_sync_action_data.html#ac2ecd62add48955272a5d9402d4532e4">skipToHash</a>;
<a name="l02477"></a>02477             <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a> = info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>;
<a name="l02478"></a>02478             <span class="keyword">struct </span><a class="code" href="structccn__indexbuf.html">ccn_indexbuf</a> *comps = info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>;
<a name="l02479"></a>02479             <span class="keywordtype">char</span> *hexL = NULL;
<a name="l02480"></a>02480             <span class="keywordtype">char</span> *hexR = NULL;
<a name="l02481"></a>02481             <span class="keywordflow">if</span> ((info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#a0c535d59cbe268b169381219513d54c4">answerfrom</a> &amp; <a class="code" href="ccn_8h.html#a2eee6f7928f301760a9fe253faf676b3">CCN_AOK_NEW</a>) == 0) {
<a name="l02482"></a>02482                 <span class="comment">// TBD: is this the right thing to do?</span>
<a name="l02483"></a>02483                 <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>)
<a name="l02484"></a>02484                     <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, <span class="stringliteral">&quot;CCN_AOK_NEW = 0&quot;</span>, data-&gt;<a class="code" href="struct_sync_action_data.html#a74202828f01407a2254b56ba73bdfd23">prefix</a>);
<a name="l02485"></a>02485                 <span class="keywordflow">break</span>;
<a name="l02486"></a>02486             }
<a name="l02487"></a>02487             <span class="keywordflow">switch</span> (data-&gt;<a class="code" href="struct_sync_action_data.html#ad64d193a1ef56426675d4042263da5c5">kind</a>) {
<a name="l02488"></a>02488                 <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692a7640d722dadf2853d6ea27eda0e8d3ef">SRI_Kind_None</a>:
<a name="l02489"></a>02489                     <span class="comment">// not an active request, so ignore</span>
<a name="l02490"></a>02490                     <span class="keywordflow">break</span>;
<a name="l02491"></a>02491                 <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692ae4c4b5fac43e82b5de019d17decbfa99" title="root stats request">SRI_Kind_RootStats</a>: {
<a name="l02492"></a>02492                     <span class="keywordtype">char</span> *who = <a class="code" href="_sync_actions_8c.html#a2e45b34bf59d445273e73ab77c39eef0">getKindStr</a>(data-&gt;<a class="code" href="struct_sync_action_data.html#ad64d193a1ef56426675d4042263da5c5">kind</a>);
<a name="l02493"></a>02493                     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = <a class="code" href="_sync_util_8c.html#a01fc44dbffb2f846caf907c293b98c02">SyncCopyName</a>(data-&gt;<a class="code" href="struct_sync_action_data.html#a74202828f01407a2254b56ba73bdfd23">prefix</a>);
<a name="l02494"></a>02494                     <a class="code" href="ccn_8h.html#af222a5e0ff25d4f2ff60eed72b3defb2" title="Extend a Name with a new version stamp.">ccn_create_version</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, name, <a class="code" href="ccn_8h.html#ac0d9b4a6ddee8ae94d87d8c2340ac907" title="use current time">CCN_V_NOW</a>, 0, 0);
<a name="l02495"></a>02495                     <a class="code" href="ccn_8h.html#a3b95a770555b90f43d4876bea62c202d" title="Add a binary Component to a ccnb-encoded Name.">ccn_name_append_numeric</a>(name, <a class="code" href="ccn_8h.html#afec910e39c89dcf24a44f93e97032399af3eb8e7fa3a938a5bcc6c1f141357d71" title="consecutive block sequence numbers">CCN_MARKER_SEQNUM</a>, 0);
<a name="l02496"></a>02496                     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>)
<a name="l02497"></a>02497                         <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, who, name);
<a name="l02498"></a>02498                     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *cb = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l02499"></a>02499                     <span class="keyword">struct </span>timeval tv = {0};
<a name="l02500"></a>02500                     gettimeofday(&amp;tv, 0);
<a name="l02501"></a>02501                     <span class="keywordtype">int</span> pos = snprintf(temp, <span class="keyword">sizeof</span>(temp),
<a name="l02502"></a>02502                                        <span class="stringliteral">&quot;%ju.%06u: &quot;</span>, 
<a name="l02503"></a>02503                                        (uintmax_t) tv.tv_sec,
<a name="l02504"></a>02504                                        (<span class="keywordtype">unsigned</span>) tv.tv_usec);
<a name="l02505"></a>02505                     <a class="code" href="charbuf_8h.html#a5cc5c1412e38c015951394fcd79e2f6e">ccn_charbuf_append</a>(cb, temp, pos);
<a name="l02506"></a>02506                     <a class="code" href="_sync_actions_8c.html#a2246f94f121a2ca6c1346b721484ed80">formatStats</a>(root, cb);
<a name="l02507"></a>02507                     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *cob = <a class="code" href="_sync_util_8c.html#aa44ff275b91059d05c609fa23e95418d" title="given a charbuf cb and name for a content object, signs the bytes and">SyncSignBuf</a>(base, cb, name,
<a name="l02508"></a>02508                                                           1, <a class="code" href="ccn_8h.html#abff51f3f313d457fbcc13006343fdd28">CCN_SP_FINAL_BLOCK</a>);
<a name="l02509"></a>02509                     <span class="keywordtype">int</span> res = <a class="code" href="ccn_8h.html#ac71f5c8727443c13afb11cf471f5f8fc">ccn_put</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, cob-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, cob-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l02510"></a>02510                     <span class="keywordflow">if</span> (res &gt;= 0) {
<a name="l02511"></a>02511                         <span class="comment">// we have success!</span>
<a name="l02512"></a>02512                         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>)
<a name="l02513"></a>02513                             <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, <span class="stringliteral">&quot;reply sent&quot;</span>, name);
<a name="l02514"></a>02514                     } <span class="keywordflow">else</span> {
<a name="l02515"></a>02515                         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a1aa8c032da69595d9b27357c2bb83da9" title="Severe errors.">CCNL_SEVERE</a>)
<a name="l02516"></a>02516                             <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, <span class="stringliteral">&quot;reply failed&quot;</span>, name);
<a name="l02517"></a>02517                     }
<a name="l02518"></a>02518                     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l02519"></a>02519                     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;cb);
<a name="l02520"></a>02520                     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;cob);
<a name="l02521"></a>02521                     ret = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca35e0232348739cde04ba6355c4395001" title="upcall claims to consume interest">CCN_UPCALL_RESULT_INTEREST_CONSUMED</a>;
<a name="l02522"></a>02522                     <span class="keywordflow">break</span>;
<a name="l02523"></a>02523                 }
<a name="l02524"></a>02524                 <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692a39c856787f4097f1f34c1827c24358b2" title="root advise handler">SRI_Kind_AdviseInt</a>:
<a name="l02525"></a>02525                 <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692acb00b1720ed5338efebdba3809611d17" title="node fetch handler">SRI_Kind_FetchInt</a>: {
<a name="l02526"></a>02526                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *bufR = NULL;
<a name="l02527"></a>02527                     <span class="keywordtype">size_t</span> lenR = 0;
<a name="l02528"></a>02528                     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceL = NULL;
<a name="l02529"></a>02529                     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceR = NULL;
<a name="l02530"></a>02530                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *bufL = root-&gt;<a class="code" href="struct_sync_root_struct.html#a013f6ae133c768d7bff2495445283bb4" title="current top-level cache hash">currentHash</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>;
<a name="l02531"></a>02531                     <span class="keywordtype">char</span> *who = <a class="code" href="_sync_actions_8c.html#a2e45b34bf59d445273e73ab77c39eef0">getKindStr</a>(data-&gt;<a class="code" href="struct_sync_action_data.html#ad64d193a1ef56426675d4042263da5c5">kind</a>);
<a name="l02532"></a>02532                     <span class="keywordtype">size_t</span> lenL = root-&gt;<a class="code" href="struct_sync_root_struct.html#a013f6ae133c768d7bff2495445283bb4" title="current top-level cache hash">currentHash</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>;
<a name="l02533"></a>02533                     <span class="keywordtype">char</span> *highHere = <span class="stringliteral">&quot;??&quot;</span>;
<a name="l02534"></a>02534                     <a class="code" href="ccn_8h.html#a70c13909ea45ffb1069916d7a512fdda" title="Extract a pointer to and size of component at given index i.">ccn_name_comp_get</a>(buf, comps, skipToHash, &amp;bufR, &amp;lenR);
<a name="l02535"></a>02535                     <span class="keywordflow">if</span> (bufR == NULL || lenR == 0) {
<a name="l02536"></a>02536                         <span class="keywordflow">if</span> (data-&gt;<a class="code" href="struct_sync_action_data.html#ad64d193a1ef56426675d4042263da5c5">kind</a> == <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692acb00b1720ed5338efebdba3809611d17" title="node fetch handler">SRI_Kind_FetchInt</a>) {
<a name="l02537"></a>02537                         }
<a name="l02538"></a>02538                     } <span class="keywordflow">else</span> {
<a name="l02539"></a>02539                         hexR = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(bufR, lenR);
<a name="l02540"></a>02540                         ceR = <a class="code" href="_sync_hash_cache_8c.html#abcf5e784c52d971d943bddef80731954" title="based on the raw hash, ensure that a remote cache entry exists ent-&amp;gt;state |= set...">SyncHashEnter</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>, bufR, lenR, <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381aec73ed0d374163f11f2d715ce0a3c197" title="a remote hash has been seen">SyncHashState_remote</a>);
<a name="l02541"></a>02541                     }
<a name="l02542"></a>02542                     hexL = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(bufL, lenL);
<a name="l02543"></a>02543                     ceL = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#abe335cfe4efd3e95c6fd099835d4baf9">ceCurrent</a>;
<a name="l02544"></a>02544                     
<a name="l02545"></a>02545                     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l02546"></a>02546                         <span class="keywordflow">if</span> (hexR == NULL)
<a name="l02547"></a>02547                             <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, who, <span class="stringliteral">&quot;empty remote hash&quot;</span>);
<a name="l02548"></a>02548                         <span class="keywordflow">else</span> <a class="code" href="_sync_util_8c.html#a2df89a5d7d920998491aba6fc5af63aa">SyncNoteSimple3</a>(root, here, who, <span class="stringliteral">&quot;remote hash&quot;</span>, hexR);
<a name="l02549"></a>02549                         <span class="keywordflow">if</span> (hexL == NULL)
<a name="l02550"></a>02550                             <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, who, <span class="stringliteral">&quot;empty local hash&quot;</span>);
<a name="l02551"></a>02551                         <span class="keywordflow">else</span> <a class="code" href="_sync_util_8c.html#a2df89a5d7d920998491aba6fc5af63aa">SyncNoteSimple3</a>(root, here, who, <span class="stringliteral">&quot;local hash&quot;</span>, hexL);
<a name="l02552"></a>02552                     }
<a name="l02553"></a>02553                     <span class="keywordflow">if</span> (data-&gt;<a class="code" href="struct_sync_action_data.html#ad64d193a1ef56426675d4042263da5c5">kind</a> == <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692a39c856787f4097f1f34c1827c24358b2" title="root advise handler">SRI_Kind_AdviseInt</a>) {
<a name="l02554"></a>02554                         <span class="comment">// get the entry for the local root node</span>
<a name="l02555"></a>02555                         <span class="comment">// should expire fairly quickly</span>
<a name="l02556"></a>02556                         <span class="keywordtype">int</span> seen = <a class="code" href="_sync_actions_8c.html#ab011bfe2bd9aaf272495352a045ae144">noteHash</a>(root, ceR, 1, 1);
<a name="l02557"></a>02557                         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l02558"></a>02558                             <span class="comment">// worth noting the remote root</span>
<a name="l02559"></a>02559                             rp-&gt;<a class="code" href="struct_sync_root_private.html#a38e2e743a14abac78e109da409dfd072">stats</a>-&gt;<a class="code" href="struct_sync_root_stats.html#a7794db2aa8ad15d0416faf064bff504a">rootAdviseSeen</a>++;
<a name="l02560"></a>02560                             highHere = <span class="stringliteral">&quot;Sync.$RootAdvise&quot;</span>;
<a name="l02561"></a>02561                             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a> &amp;&amp; <a class="code" href="_sync_actions_8c.html#ad990ae99fb88eb7b8bb2864dd04a459f">showHighLevel</a>)
<a name="l02562"></a>02562                                 <a class="code" href="_sync_actions_8c.html#a677c4508262ab00cdea51b16065eac17">showCacheEntry1</a>(root, highHere, <span class="stringliteral">&quot;interest arrived&quot;</span>, ceR);
<a name="l02563"></a>02563                         }
<a name="l02564"></a>02564                         <span class="keywordflow">if</span> (ceL == ceR) {
<a name="l02565"></a>02565                             <span class="comment">// hash given is same as our root hash, so ignore the request</span>
<a name="l02566"></a>02566                             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>)
<a name="l02567"></a>02567                                 <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, who, <span class="stringliteral">&quot;ignored (same hash)&quot;</span>);
<a name="l02568"></a>02568                             <span class="comment">// both L and R are empty, so suppress short-term thrashing</span>
<a name="l02569"></a>02569                             rp-&gt;<a class="code" href="struct_sync_root_private.html#ae1767969829a1018570bf64d50ab5c8f">adviseNeed</a> = 0;
<a name="l02570"></a>02570                             <a class="code" href="_sync_actions_8c.html#aa7b4b03461c37b445235b4fd9a523416">purgeOldEntries</a>(root);
<a name="l02571"></a>02571                             <span class="keywordflow">break</span>;
<a name="l02572"></a>02572                         }
<a name="l02573"></a>02573                         ssize_t excl_start = info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9a4c40a9e5305b7602b96ababfd02f6775">CCN_PI_B_Exclude</a>];
<a name="l02574"></a>02574                         ssize_t excl_stop = info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ad7411aa4c9a0b67d3b48c4abbe1e0f0a">CCN_PI_E_Exclude</a>];
<a name="l02575"></a>02575                         ssize_t excl_len = excl_stop - excl_start;
<a name="l02576"></a>02576                         <span class="keywordflow">if</span> (excl_len &gt; 0) {
<a name="l02577"></a>02577                             <span class="comment">// we appear to have an exclusion</span>
<a name="l02578"></a>02578                             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a795a0a3098f6c9ba5990e8a23775284d" title="More debugging.">CCNL_FINER</a>) {
<a name="l02579"></a>02579                                 <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> ds;
<a name="l02580"></a>02580                                 <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> *d = &amp;ds;
<a name="l02581"></a>02581                                 <a class="code" href="ccn_8h.html#a4ba830f8dad511663779d85122db633a">ccn_buf_decoder_start</a>(d,
<a name="l02582"></a>02582                                                       buf+excl_start,
<a name="l02583"></a>02583                                                       excl_len);
<a name="l02584"></a>02584                                 <a class="code" href="_sync_actions_8c.html#a5649db4933bbb71f0337fe748e52fec0">reportExclude</a>(root, d);
<a name="l02585"></a>02585                             }
<a name="l02586"></a>02586                             <span class="keywordflow">if</span> (<a class="code" href="_sync_actions_8c.html#abcf03dd02fc21c497e5f79698025ce11">useCompExcl</a> &amp;&amp; lenL &gt; 0
<a name="l02587"></a>02587                                 &amp;&amp; <a class="code" href="ccn_8h.html#a6798296ca78192d0aad45e802effb9cf" title="Test for a match between a next component and an exclusion clause.">ccn_excluded</a>(buf+excl_start,
<a name="l02588"></a>02588                                                 excl_len,
<a name="l02589"></a>02589                                                 bufL,
<a name="l02590"></a>02590                                                 lenL)) {
<a name="l02591"></a>02591                                     <span class="comment">// we have an exclusion match, so forget it!</span>
<a name="l02592"></a>02592                                     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>)
<a name="l02593"></a>02593                                         <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, who, <span class="stringliteral">&quot;excluded&quot;</span>);
<a name="l02594"></a>02594                                     <span class="keywordflow">break</span>;
<a name="l02595"></a>02595                                 }
<a name="l02596"></a>02596                         }
<a name="l02597"></a>02597                         <span class="keywordflow">if</span> (seen == 0 &amp;&amp; !<a class="code" href="_sync_actions_8c.html#a870761b1ea0620fc7bf78e6a7c4a8fb3">isCovered</a>(ceR)) {
<a name="l02598"></a>02598                             <span class="comment">// first time seen, so force a RootAdvise from our side</span>
<a name="l02599"></a>02599                             <span class="comment">// this should allow the remote to answer with deltas (if present)</span>
<a name="l02600"></a>02600                             rp-&gt;<a class="code" href="struct_sync_root_private.html#ae1767969829a1018570bf64d50ab5c8f">adviseNeed</a> = <a class="code" href="_sync_actions_8c.html#a96ca9c9a78727d3479674cdaa27b56f5">adviseNeedReset</a>;
<a name="l02601"></a>02601                             <span class="comment">// kickHeartBeat(root, shortDelayMicros);</span>
<a name="l02602"></a>02602                         }
<a name="l02603"></a>02603                     } <span class="keywordflow">else</span> {
<a name="l02604"></a>02604                         <span class="comment">// NodeFetch</span>
<a name="l02605"></a>02605                         rp-&gt;<a class="code" href="struct_sync_root_private.html#a38e2e743a14abac78e109da409dfd072">stats</a>-&gt;<a class="code" href="struct_sync_root_stats.html#a9c59d2cd1b10ad10bdd4662c8f187505">nodeFetchSeen</a>++;
<a name="l02606"></a>02606                         <span class="keywordflow">if</span> (ceR == NULL) {
<a name="l02607"></a>02607                             <span class="comment">// NodeFetch MUST have a valid remote hash!</span>
<a name="l02608"></a>02608                             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a1aa8c032da69595d9b27357c2bb83da9" title="Severe errors.">CCNL_SEVERE</a>)
<a name="l02609"></a>02609                                 <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, who, <span class="stringliteral">&quot;failed, no remote hash&quot;</span>);
<a name="l02610"></a>02610                             <span class="keywordflow">return</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>;
<a name="l02611"></a>02611                         }
<a name="l02612"></a>02612                         highHere = <span class="stringliteral">&quot;Sync.$NodeFetch&quot;</span>;
<a name="l02613"></a>02613                         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a> &amp;&amp; <a class="code" href="_sync_actions_8c.html#ad990ae99fb88eb7b8bb2864dd04a459f">showHighLevel</a>)
<a name="l02614"></a>02614                             <a class="code" href="_sync_actions_8c.html#a677c4508262ab00cdea51b16065eac17">showCacheEntry1</a>(root, highHere, <span class="stringliteral">&quot;interest arrived&quot;</span>, ceR);
<a name="l02615"></a>02615                         <span class="comment">// after this point, ceL is the requested node</span>
<a name="l02616"></a>02616                         ceL = ceR;
<a name="l02617"></a>02617                     }
<a name="l02618"></a>02618                     <span class="keywordflow">if</span> (lenL == 0) {
<a name="l02619"></a>02619                         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>)
<a name="l02620"></a>02620                             <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, who, <span class="stringliteral">&quot;ignored (empty local root)&quot;</span>);
<a name="l02621"></a>02621                         <span class="keywordflow">if</span> (lenR == 0) {
<a name="l02622"></a>02622                             <span class="comment">// both L and R are empty, so suppress short-term thrashing</span>
<a name="l02623"></a>02623                             rp-&gt;<a class="code" href="struct_sync_root_private.html#ae1767969829a1018570bf64d50ab5c8f">adviseNeed</a> = 0;
<a name="l02624"></a>02624                         }
<a name="l02625"></a>02625                         <span class="keywordflow">if</span> (root-&gt;<a class="code" href="struct_sync_root_struct.html#a973c1488c9df1486c21fc37465c10def" title="names needing addition to root">namesToAdd</a>-&gt;<a class="code" href="struct_sync_name_accum.html#a43e6bf3321957d08f4985443cc36555d">len</a> &gt; 0) {
<a name="l02626"></a>02626                             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>)
<a name="l02627"></a>02627                                 <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, who, <span class="stringliteral">&quot;new tree needed&quot;</span>);
<a name="l02628"></a>02628                         }
<a name="l02629"></a>02629                         <span class="keywordflow">break</span>;
<a name="l02630"></a>02630                     }
<a name="l02631"></a>02631                     
<a name="l02632"></a>02632                     <span class="keywordtype">long</span> fresh = base-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>-&gt;<a class="code" href="struct_sync_private.html#a5c957e953884aae22719c05b8f3adb55">rootAdviseFresh</a>;
<a name="l02633"></a>02633                     <span class="comment">// excessive freshness may be a problem when there is an A-B-C</span>
<a name="l02634"></a>02634                     <span class="comment">// routing, and a node shows up in B&#39;s cache that mentions</span>
<a name="l02635"></a>02635                     <span class="comment">// subnodes that C cannot reach</span>
<a name="l02636"></a>02636                     <span class="comment">// TBD: come up with a better solution!</span>
<a name="l02637"></a>02637                     
<a name="l02638"></a>02638                     rp-&gt;<a class="code" href="struct_sync_root_private.html#ae1767969829a1018570bf64d50ab5c8f">adviseNeed</a> = <a class="code" href="_sync_actions_8c.html#a96ca9c9a78727d3479674cdaa27b56f5">adviseNeedReset</a>;
<a name="l02639"></a>02639                     
<a name="l02640"></a>02640                     <span class="comment">// we need to respond with a local tree node (in ceL)</span>
<a name="l02641"></a>02641                     
<a name="l02642"></a>02642                     <span class="comment">// test for desired local tree node being present</span>
<a name="l02643"></a>02643                     <span class="keywordflow">if</span> (<a class="code" href="_sync_hash_cache_8c.html#a88b8496fee4324b2359f23e3c6dd9472" title="fetches the cache entry to be eligible, ce != NULL &amp;amp;&amp;amp; ce-&amp;gt;ncL != NULL...">SyncCacheEntryFetch</a>(ceL) &lt; 0) {
<a name="l02644"></a>02644                         <span class="comment">// requested local node is probably not ours</span>
<a name="l02645"></a>02645                         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l02646"></a>02646                             <a class="code" href="_sync_util_8c.html#a2df89a5d7d920998491aba6fc5af63aa">SyncNoteSimple3</a>(root, here, who, <span class="stringliteral">&quot;no local node&quot;</span>, hexL);
<a name="l02647"></a>02647                         }
<a name="l02648"></a>02648                         <span class="keywordflow">break</span>;
<a name="l02649"></a>02649                     }
<a name="l02650"></a>02650                     <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *ncL = ceL-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a>;
<a name="l02651"></a>02651                     
<a name="l02652"></a>02652                     <span class="comment">// root advise: name is prefix + hashIn + hashOut</span>
<a name="l02653"></a>02653                     <span class="comment">// node fetch: name is prefix + hashIn</span>
<a name="l02654"></a>02654                     <span class="comment">// empty hashes are OK, but must be encoded</span>
<a name="l02655"></a>02655                     <span class="keyword">struct </span><a class="code" href="struct_sync_root_deltas.html">SyncRootDeltas</a> *deltas = NULL;
<a name="l02656"></a>02656                     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *cbL = ncL-&gt;<a class="code" href="struct_sync_node_composite.html#a5b1cdb9c3eabafe04a18c8623784ff04" title="pointer to ccnb encoding">cb</a>;
<a name="l02657"></a>02657                     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = <a class="code" href="_sync_util_8c.html#a01fc44dbffb2f846caf907c293b98c02">SyncCopyName</a>(data-&gt;<a class="code" href="struct_sync_action_data.html#a74202828f01407a2254b56ba73bdfd23">prefix</a>);
<a name="l02658"></a>02658                     <a class="code" href="ccn_8h.html#a3f4f614f38ae77dccb4099e982c646f8" title="Add a Component to a Name.">ccn_name_append</a>(name, bufR, lenR);
<a name="l02659"></a>02659                     <span class="keywordflow">if</span> (data-&gt;<a class="code" href="struct_sync_action_data.html#ad64d193a1ef56426675d4042263da5c5">kind</a> == <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692a39c856787f4097f1f34c1827c24358b2" title="root advise handler">SRI_Kind_AdviseInt</a>) {
<a name="l02660"></a>02660                         <span class="comment">// respond with the current local hash</span>
<a name="l02661"></a>02661                         <a class="code" href="ccn_8h.html#a3f4f614f38ae77dccb4099e982c646f8" title="Add a Component to a Name.">ccn_name_append</a>(name, bufL, lenL);
<a name="l02662"></a>02662                         deltas = <a class="code" href="_sync_actions_8c.html#a1b1dfd4819fcf3f685f6e09273713102">scanDeltas</a>(root, ceR);
<a name="l02663"></a>02663                         <span class="keywordflow">if</span> (deltas != NULL &amp;&amp; deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#aa69ba4a9afeaa0fd81349eefdfcc9a82">whenSent</a> == 0) {
<a name="l02664"></a>02664                             <span class="comment">// we&#39;ve got one, so send it now</span>
<a name="l02665"></a>02665                             <a class="code" href="_sync_actions_8c.html#acc491ad38b38700ae0597ecc5422eca3">SendDeltasReply</a>(root, deltas);
<a name="l02666"></a>02666                             <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l02667"></a>02667                             ret = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca35e0232348739cde04ba6355c4395001" title="upcall claims to consume interest">CCN_UPCALL_RESULT_INTEREST_CONSUMED</a>;
<a name="l02668"></a>02668                             <span class="keywordflow">break</span>;
<a name="l02669"></a>02669                         }
<a name="l02670"></a>02670                     }
<a name="l02671"></a>02671                     
<a name="l02672"></a>02672                     <span class="comment">// the content object is based on the node</span>
<a name="l02673"></a>02673                     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *cob = NULL;
<a name="l02674"></a>02674                     <span class="keywordflow">if</span> (data-&gt;<a class="code" href="struct_sync_action_data.html#ad64d193a1ef56426675d4042263da5c5">kind</a> == <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692acb00b1720ed5338efebdba3809611d17" title="node fetch handler">SRI_Kind_FetchInt</a>) {
<a name="l02675"></a>02675                         <span class="comment">// node fetch results need not expire</span>
<a name="l02676"></a>02676                         cob = ncL-&gt;<a class="code" href="struct_sync_node_composite.html#a89dd56e0b8b6a2e0af61a704aa34af26" title="the signed content node (may be NULL)">content</a>;
<a name="l02677"></a>02677                     }
<a name="l02678"></a>02678                     <span class="keywordflow">if</span> (cob == NULL &amp;&amp; cbL != NULL) {
<a name="l02679"></a>02679                         <span class="comment">// don&#39;t already have it, so make it</span>
<a name="l02680"></a>02680                         cob = <a class="code" href="_sync_util_8c.html#aa44ff275b91059d05c609fa23e95418d" title="given a charbuf cb and name for a content object, signs the bytes and">SyncSignBuf</a>(base, cbL, name,
<a name="l02681"></a>02681                                           fresh, <a class="code" href="ccn_8h.html#abff51f3f313d457fbcc13006343fdd28">CCN_SP_FINAL_BLOCK</a>);
<a name="l02682"></a>02682                     }
<a name="l02683"></a>02683                     
<a name="l02684"></a>02684                     <span class="keywordflow">if</span> (cob != NULL) {
<a name="l02685"></a>02685                         <span class="comment">// we have a reply encoded</span>
<a name="l02686"></a>02686                         <span class="keywordflow">if</span> (<a class="code" href="ccn_8h.html#a2e161e1c17ef110dfa019bc1d560c82c" title="Test for a match between a ContentObject and an Interest.">ccn_content_matches_interest</a>(cob-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, cob-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>,
<a name="l02687"></a>02687                                                          1, NULL,
<a name="l02688"></a>02688                                                          info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>,
<a name="l02689"></a>02689                                                          info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ae3500edfbd06a2be152e0ef8fcc64328">CCN_PI_E</a>],
<a name="l02690"></a>02690                                                          info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>)) {
<a name="l02691"></a>02691                             <span class="comment">// we match the interest</span>
<a name="l02692"></a>02692                             <span class="keywordtype">int</span> res = <a class="code" href="ccn_8h.html#ac71f5c8727443c13afb11cf471f5f8fc">ccn_put</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, cob-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, cob-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l02693"></a>02693                             <span class="keywordflow">if</span> (res &gt;= 0) {
<a name="l02694"></a>02694                                 <span class="comment">// we have success!</span>
<a name="l02695"></a>02695                                 <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l02696"></a>02696                                     <span class="keywordtype">char</span> *why = <span class="stringliteral">&quot;reply sent&quot;</span>;
<a name="l02697"></a>02697                                     <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, why, name);
<a name="l02698"></a>02698                                     <span class="keywordflow">if</span> (<a class="code" href="_sync_actions_8c.html#ad990ae99fb88eb7b8bb2864dd04a459f">showHighLevel</a>) {
<a name="l02699"></a>02699                                         <span class="keywordflow">if</span> (data-&gt;<a class="code" href="struct_sync_action_data.html#ad64d193a1ef56426675d4042263da5c5">kind</a> == <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692a39c856787f4097f1f34c1827c24358b2" title="root advise handler">SRI_Kind_AdviseInt</a>)
<a name="l02700"></a>02700                                             <a class="code" href="_sync_actions_8c.html#a693571491e7f8b307640238175b6aa57">showCacheEntry2</a>(root, highHere, why, ceR, ceL);
<a name="l02701"></a>02701                                         <span class="keywordflow">else</span> <a class="code" href="_sync_actions_8c.html#a677c4508262ab00cdea51b16065eac17">showCacheEntry1</a>(root, highHere, why, ceL);
<a name="l02702"></a>02702                                     }
<a name="l02703"></a>02703                                 }
<a name="l02704"></a>02704                             } <span class="keywordflow">else</span> {
<a name="l02705"></a>02705                                 <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a1aa8c032da69595d9b27357c2bb83da9" title="Severe errors.">CCNL_SEVERE</a>)
<a name="l02706"></a>02706                                     <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, <span class="stringliteral">&quot;reply failed&quot;</span>, name);
<a name="l02707"></a>02707                             }
<a name="l02708"></a>02708                             ret = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca35e0232348739cde04ba6355c4395001" title="upcall claims to consume interest">CCN_UPCALL_RESULT_INTEREST_CONSUMED</a>;
<a name="l02709"></a>02709                         } <span class="keywordflow">else</span> {
<a name="l02710"></a>02710                             <span class="comment">// the exclusion filter disallows it</span>
<a name="l02711"></a>02711                             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>)
<a name="l02712"></a>02712                                 <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, <span class="stringliteral">&quot;no match&quot;</span>, name);
<a name="l02713"></a>02713                         }
<a name="l02714"></a>02714                         <span class="keywordflow">if</span> (data-&gt;<a class="code" href="struct_sync_action_data.html#ad64d193a1ef56426675d4042263da5c5">kind</a> == <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692acb00b1720ed5338efebdba3809611d17" title="node fetch handler">SRI_Kind_FetchInt</a>) {
<a name="l02715"></a>02715                             <span class="comment">// ownership of the encoding transfers to the node</span>
<a name="l02716"></a>02716                             ncL-&gt;<a class="code" href="struct_sync_node_composite.html#a89dd56e0b8b6a2e0af61a704aa34af26" title="the signed content node (may be NULL)">content</a> = cob;
<a name="l02717"></a>02717                         } <span class="keywordflow">else</span> {
<a name="l02718"></a>02718                             <span class="comment">// for root advise, don&#39;t hold on to the encoding</span>
<a name="l02719"></a>02719                             <span class="comment">// (it&#39;s not signed right for Node Fetch)</span>
<a name="l02720"></a>02720                             <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;cob);
<a name="l02721"></a>02721                         }
<a name="l02722"></a>02722                     }
<a name="l02723"></a>02723                     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l02724"></a>02724                     <span class="keywordflow">break</span>;
<a name="l02725"></a>02725                 }
<a name="l02726"></a>02726                 <span class="keywordflow">default</span>:
<a name="l02727"></a>02727                     <span class="comment">// SHOULD NOT HAPPEN</span>
<a name="l02728"></a>02728                     ret = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>;
<a name="l02729"></a>02729                     <span class="keywordflow">break</span>;
<a name="l02730"></a>02730             }
<a name="l02731"></a>02731             <span class="keywordflow">if</span> (hexL != NULL) free(hexL);
<a name="l02732"></a>02732             <span class="keywordflow">if</span> (hexR != NULL) free(hexR);
<a name="l02733"></a>02733             <span class="keywordflow">break</span>;
<a name="l02734"></a>02734         }
<a name="l02735"></a>02735         <span class="keywordflow">default</span>:
<a name="l02736"></a>02736             <span class="comment">// SHOULD NOT HAPPEN</span>
<a name="l02737"></a>02737             ret = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>;
<a name="l02738"></a>02738             <span class="keywordflow">break</span>;
<a name="l02739"></a>02739     }
<a name="l02740"></a>02740     <span class="keywordflow">return</span> ret;
<a name="l02741"></a>02741     
<a name="l02742"></a>02742 }
<a name="l02743"></a>02743 
<a name="l02744"></a>02744 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02745"></a><a class="code" href="_sync_actions_8c.html#a2eb786649cdbee71327931114c7beb18">02745</a> <a class="code" href="_sync_actions_8c.html#a2eb786649cdbee71327931114c7beb18">SyncRegisterInterest</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root,
<a name="l02746"></a>02746                      <span class="keyword">enum</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692">SyncRegisterActionKind</a> kind) {
<a name="l02747"></a>02747     <span class="keyword">static</span> <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.SyncRegisterInterest&quot;</span>;
<a name="l02748"></a>02748     <span class="keywordtype">int</span> res = 0;
<a name="l02749"></a>02749     <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>;
<a name="l02750"></a>02750     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = base-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l02751"></a>02751     <span class="keyword">struct </span>ccn *ccn = base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>-&gt;<a class="code" href="structsync__plumbing.html#a5c7f66f36ab1eb5de840d06ab1da6e74">ccn</a>;
<a name="l02752"></a>02752     <span class="keywordflow">if</span> (ccn == NULL)
<a name="l02753"></a>02753         <span class="keywordflow">return</span> -__LINE__;
<a name="l02754"></a>02754     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *prefix = <a class="code" href="_sync_actions_8c.html#adf89fd412f0e65a80e9a7e961f7d6b13">constructCommandPrefix</a>(root, kind);
<a name="l02755"></a>02755     <span class="keywordflow">if</span> (prefix != NULL) {
<a name="l02756"></a>02756         <span class="comment">// so far we have built the full prefix for the interest</span>
<a name="l02757"></a>02757         <span class="keyword">struct </span><a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *action = <a class="code" href="_sync_macros_8h.html#ab707d3cfcb52f2e2f819771123942548">NEW_STRUCT</a>(1, <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a>);
<a name="l02758"></a>02758         <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *data = <a class="code" href="_sync_actions_8c.html#a16e2f339bd3d0141bdc0fbf8a128ff26">newActionData</a>(kind);
<a name="l02759"></a>02759         data-&gt;<a class="code" href="struct_sync_action_data.html#a74202828f01407a2254b56ba73bdfd23">prefix</a> = prefix;
<a name="l02760"></a>02760         data-&gt;<a class="code" href="struct_sync_action_data.html#ac2ecd62add48955272a5d9402d4532e4">skipToHash</a> = <a class="code" href="_sync_util_8c.html#aa1be3053fdf3e2122f3582e74ff8b694">SyncComponentCount</a>(prefix);
<a name="l02761"></a>02761         action-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a> = data;
<a name="l02762"></a>02762         action-&gt;<a class="code" href="structccn__closure.html#a48dca74271023e0caf287ad31dd1e66c" title="client-supplied handler">p</a> = &amp;<a class="code" href="_sync_actions_8c.html#ae0b12eb9cb07cbc4a15e45982d6f3c95">SyncInterestArrived</a>;
<a name="l02763"></a>02763         
<a name="l02764"></a>02764         <span class="comment">// we can register the prefix</span>
<a name="l02765"></a>02765         res |= <a class="code" href="ccn_8h.html#a9193ff0e42816aea703225a374d5532d" title="Register to receive interests on a prefix.">ccn_set_interest_filter</a>(ccn, prefix, action);
<a name="l02766"></a>02766         <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l02767"></a>02767             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a1aa8c032da69595d9b27357c2bb83da9" title="Severe errors.">CCNL_SEVERE</a>)
<a name="l02768"></a>02768                 <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, <span class="stringliteral">&quot;ccn_set_interest_filter failed&quot;</span>, prefix);
<a name="l02769"></a>02769             data = <a class="code" href="_sync_actions_8c.html#a9826ac9a64ba2f80ef24985bee419929">destroyActionData</a>(data);
<a name="l02770"></a>02770         } <span class="keywordflow">else</span> {
<a name="l02771"></a>02771             <a class="code" href="_sync_actions_8c.html#a95080bffa712dcfdea59f2fe0affd18b">linkActionData</a>(root, data);
<a name="l02772"></a>02772             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>)
<a name="l02773"></a>02773                 <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, <a class="code" href="_sync_actions_8c.html#a2e45b34bf59d445273e73ab77c39eef0">getKindStr</a>(kind), prefix);
<a name="l02774"></a>02774         }
<a name="l02775"></a>02775     } <span class="keywordflow">else</span> {
<a name="l02776"></a>02776         <span class="comment">// bad input, so delete the prefix</span>
<a name="l02777"></a>02777         res = <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad prefix&quot;</span>, __LINE__);
<a name="l02778"></a>02778     }
<a name="l02779"></a>02779     <span class="keywordflow">return</span> res;
<a name="l02780"></a>02780 }
<a name="l02781"></a>02781 
<a name="l02782"></a>02782 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02783"></a><a class="code" href="_sync_actions_8c.html#a834f23cf4596b1ef8013a972558f936c">02783</a> <a class="code" href="_sync_actions_8c.html#a834f23cf4596b1ef8013a972558f936c">SyncRegisterInterests</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root) {
<a name="l02784"></a>02784     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.SyncRegisterInterests&quot;</span>;
<a name="l02785"></a>02785     <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>;
<a name="l02786"></a>02786     <span class="keyword">struct </span>ccn *ccn = base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>-&gt;<a class="code" href="structsync__plumbing.html#a5c7f66f36ab1eb5de840d06ab1da6e74">ccn</a>;
<a name="l02787"></a>02787     <span class="keywordflow">if</span> (ccn == NULL) <span class="keywordflow">return</span> -1;
<a name="l02788"></a>02788     <span class="keywordtype">int</span> res = 0;
<a name="l02789"></a>02789     <span class="keywordflow">if</span> (base-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l02790"></a>02790         <span class="comment">// report the root registration and the hex values</span>
<a name="l02791"></a>02791         <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#add7a152b7bdc85bd56a20b16f1da93f6" title="the raw hash of the sliceCoding">sliceHash</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, root-&gt;<a class="code" href="struct_sync_root_struct.html#add7a152b7bdc85bd56a20b16f1da93f6" title="the raw hash of the sliceCoding">sliceHash</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l02792"></a>02792         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *uriTopo = NULL;
<a name="l02793"></a>02793         <span class="keywordtype">char</span> *msgTopo = <span class="stringliteral">&quot;??&quot;</span>;
<a name="l02794"></a>02794         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *topoPrefix = root-&gt;<a class="code" href="struct_sync_root_struct.html#a6ba6270127aea47744c6860e6aff6627" title="Sync Protocol topo prefix.">topoPrefix</a>;
<a name="l02795"></a>02795         <span class="keywordflow">if</span> (topoPrefix != NULL &amp;&amp; topoPrefix-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> &gt; 0) {
<a name="l02796"></a>02796             uriTopo = <a class="code" href="_sync_util_8c.html#adc7df34c5bbfec9243b0402b6ebbe093" title="Convenience routine to make a uri for a name.">SyncUriForName</a>(topoPrefix);
<a name="l02797"></a>02797             msgTopo = <a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(uriTopo);
<a name="l02798"></a>02798         }
<a name="l02799"></a>02799         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *uriPrefix = NULL;
<a name="l02800"></a>02800         <span class="keywordtype">char</span> *msgPrefix = <span class="stringliteral">&quot;??&quot;</span>;
<a name="l02801"></a>02801         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *namingPrefix = root-&gt;<a class="code" href="struct_sync_root_struct.html#a88e2d2d45da428702e31f7067278a19a" title="Sync Protocol naming prefix.">namingPrefix</a>;
<a name="l02802"></a>02802         <span class="keywordflow">if</span> (namingPrefix != NULL &amp;&amp; namingPrefix-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> &gt; 0) {
<a name="l02803"></a>02803             uriPrefix = <a class="code" href="_sync_util_8c.html#adc7df34c5bbfec9243b0402b6ebbe093" title="Convenience routine to make a uri for a name.">SyncUriForName</a>(namingPrefix);
<a name="l02804"></a>02804             msgPrefix = <a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(uriPrefix);
<a name="l02805"></a>02805         }
<a name="l02806"></a>02806         
<a name="l02807"></a>02807         <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base,
<a name="l02808"></a>02808                  <span class="stringliteral">&quot;%s, root#%u, topo %s, prefix %s, hash %s&quot;</span>,
<a name="l02809"></a>02809                  here, root-&gt;<a class="code" href="struct_sync_root_struct.html#a86cbcbdd2e2d8c30311da406d36c80e5" title="root Id for reporting">rootId</a>, msgTopo, msgPrefix, hex);
<a name="l02810"></a>02810         
<a name="l02811"></a>02811         <span class="keyword">struct </span><a class="code" href="struct_sync_name_accum.html">SyncNameAccum</a> *filter = root-&gt;<a class="code" href="struct_sync_root_struct.html#a24acad680fbad7342bfc4a4c8f9fcf82" title="filter clauses">filter</a>;
<a name="l02812"></a>02812         <span class="keywordflow">if</span> (filter != NULL) {
<a name="l02813"></a>02813             <span class="keywordtype">int</span> i = 0;
<a name="l02814"></a>02814             <span class="keywordflow">for</span> (i = 0; i &lt; filter-&gt;<a class="code" href="struct_sync_name_accum.html#a43e6bf3321957d08f4985443cc36555d">len</a>; i++) {
<a name="l02815"></a>02815                 <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *uri = <a class="code" href="_sync_util_8c.html#adc7df34c5bbfec9243b0402b6ebbe093" title="Convenience routine to make a uri for a name.">SyncUriForName</a>(filter-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[i].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a>);
<a name="l02816"></a>02816                 <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base,
<a name="l02817"></a>02817                          <span class="stringliteral">&quot;%s, root#%u, op %d, pattern %s&quot;</span>,
<a name="l02818"></a>02818                          here, root-&gt;<a class="code" href="struct_sync_root_struct.html#a86cbcbdd2e2d8c30311da406d36c80e5" title="root Id for reporting">rootId</a>,
<a name="l02819"></a>02819                          (<span class="keywordtype">int</span>) filter-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[i].<a class="code" href="struct_sync_name_accum_entry.html#a1d7698b1a8fe70c6e30e59231314a4c4">data</a>,
<a name="l02820"></a>02820                          <a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(uri));
<a name="l02821"></a>02821                 <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;uri);
<a name="l02822"></a>02822             }
<a name="l02823"></a>02823         }
<a name="l02824"></a>02824         <span class="keywordflow">if</span> (uriTopo != NULL) <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;uriTopo);
<a name="l02825"></a>02825         <span class="keywordflow">if</span> (uriPrefix != NULL) <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;uriPrefix);
<a name="l02826"></a>02826         free(hex);
<a name="l02827"></a>02827     }
<a name="l02828"></a>02828     res |= <a class="code" href="_sync_actions_8c.html#a2eb786649cdbee71327931114c7beb18">SyncRegisterInterest</a>(root, <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692a39c856787f4097f1f34c1827c24358b2" title="root advise handler">SRI_Kind_AdviseInt</a>);
<a name="l02829"></a>02829     res |= <a class="code" href="_sync_actions_8c.html#a2eb786649cdbee71327931114c7beb18">SyncRegisterInterest</a>(root, <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692acb00b1720ed5338efebdba3809611d17" title="node fetch handler">SRI_Kind_FetchInt</a>);
<a name="l02830"></a>02830     res |= <a class="code" href="_sync_actions_8c.html#a2eb786649cdbee71327931114c7beb18">SyncRegisterInterest</a>(root, <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692ae4c4b5fac43e82b5de019d17decbfa99" title="root stats request">SRI_Kind_RootStats</a>);
<a name="l02831"></a>02831     root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#ae1767969829a1018570bf64d50ab5c8f">adviseNeed</a> = <a class="code" href="_sync_actions_8c.html#a96ca9c9a78727d3479674cdaa27b56f5">adviseNeedReset</a>;
<a name="l02832"></a>02832     <span class="keywordflow">return</span> res;
<a name="l02833"></a>02833 }
<a name="l02834"></a>02834 
<a name="l02835"></a>02835 <span class="comment">// callback for when a root advise interest gets a reply</span>
<a name="l02836"></a>02836 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a>
<a name="l02837"></a><a class="code" href="_sync_actions_8c.html#af9de4a2101bd02a94534871bffc25cea">02837</a> <a class="code" href="_sync_actions_8c.html#af9de4a2101bd02a94534871bffc25cea">SyncRootAdviseResponse</a>(<span class="keyword">struct</span> <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *selfp,
<a name="l02838"></a>02838                        <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92" title="This tells what kind of event the upcall is handling.">ccn_upcall_kind</a> kind,
<a name="l02839"></a>02839                        <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info) {
<a name="l02840"></a>02840     <span class="keyword">static</span> <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.SyncRootAdviseResponse&quot;</span>;
<a name="l02841"></a>02841     <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *data = selfp-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a>;
<a name="l02842"></a>02842     <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a> ret = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcadadb47635316f12c6542c33cebcfa727" title="normal upcall return">CCN_UPCALL_RESULT_OK</a>;
<a name="l02843"></a>02843     <span class="keywordflow">switch</span> (kind) {
<a name="l02844"></a>02844         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92ad00afdf8a89c718f4c451600b115b5e0" title="handler is about to be deregistered">CCN_UPCALL_FINAL</a>:
<a name="l02845"></a>02845             data = <a class="code" href="_sync_actions_8c.html#a9826ac9a64ba2f80ef24985bee419929">destroyActionData</a>(data);
<a name="l02846"></a>02846             free(selfp);
<a name="l02847"></a>02847             <span class="keywordflow">break</span>;
<a name="l02848"></a>02848         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a8db121649c55820013bfaaf65e436f5c" title="content that has not been verified">CCN_UPCALL_CONTENT_UNVERIFIED</a>:
<a name="l02849"></a>02849             ret = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcaacded567eed5b8559bd0e6b30ab241ce" title="force an unverified result to be verified">CCN_UPCALL_RESULT_VERIFY</a>;
<a name="l02850"></a>02850             <span class="keywordflow">break</span>;
<a name="l02851"></a>02851         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a1b0d17f15edd2e43d9a026d19498ab7c" title="key has not been fetched">CCN_UPCALL_CONTENT_KEYMISSING</a>:
<a name="l02852"></a>02852             ret = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcacd6ea884bd093194e63bb68acbb784d1" title="request fetching of an unfetched key">CCN_UPCALL_RESULT_FETCHKEY</a>;
<a name="l02853"></a>02853             <span class="keywordflow">break</span>;
<a name="l02854"></a>02854         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a3c7ef9861eb5ba1529b4d05630e83c88" title="interest timed out">CCN_UPCALL_INTEREST_TIMED_OUT</a>: {
<a name="l02855"></a>02855             <span class="keywordflow">if</span> (data == NULL || info == NULL ||
<a name="l02856"></a>02856                 data-&gt;<a class="code" href="struct_sync_action_data.html#aec2fc78ddb23d1c2bc5f51841e4a1b07">root</a> == NULL || data-&gt;<a class="code" href="struct_sync_action_data.html#ad64d193a1ef56426675d4042263da5c5">kind</a> != <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692a8e4c22d4ecccb39943c4a3ebaa6ea0e2" title="root advise request">SRI_Kind_RootAdvise</a>) {
<a name="l02857"></a>02857                 <span class="comment">// not active, no useful info</span>
<a name="l02858"></a>02858             } <span class="keywordflow">else</span> {
<a name="l02859"></a>02859                 int64_t now = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l02860"></a>02860                 <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = data-&gt;<a class="code" href="struct_sync_action_data.html#aec2fc78ddb23d1c2bc5f51841e4a1b07">root</a>;
<a name="l02861"></a>02861                 <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l02862"></a>02862                 root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a38e2e743a14abac78e109da409dfd072">stats</a>-&gt;<a class="code" href="struct_sync_root_stats.html#afc887687da70f1a089a99b83ced65e35">rootAdviseTimeout</a>++;
<a name="l02863"></a>02863                 <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l02864"></a>02864                     <span class="keywordtype">char</span> temp[64];
<a name="l02865"></a>02865                     int64_t dt = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(data-&gt;<a class="code" href="struct_sync_action_data.html#a79f3e380339ba613e01440cf2b6611fc">startTime</a>, now);
<a name="l02866"></a>02866                     dt = (dt + 500) / 1000;
<a name="l02867"></a>02867                     snprintf(temp, <span class="keyword">sizeof</span>(temp),
<a name="l02868"></a>02868                              <span class="stringliteral">&quot;timeout, %d.%03d secs&quot;</span>,
<a name="l02869"></a>02869                              (<span class="keywordtype">int</span>) (dt / 1000), (<span class="keywordtype">int</span>) (dt % 1000));
<a name="l02870"></a>02870                     <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, temp, data-&gt;<a class="code" href="struct_sync_action_data.html#a74202828f01407a2254b56ba73bdfd23">prefix</a>);
<a name="l02871"></a>02871                 }
<a name="l02872"></a>02872                 data-&gt;<a class="code" href="struct_sync_action_data.html#a79f3e380339ba613e01440cf2b6611fc">startTime</a> = now;
<a name="l02873"></a>02873                 <span class="comment">// as long as we need a reply, keep expressing it</span>
<a name="l02874"></a>02874                 ret = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca686785df48ac222ef31beea39eebd404" title="reexpress the same interest again">CCN_UPCALL_RESULT_REEXPRESS</a>;
<a name="l02875"></a>02875             }
<a name="l02876"></a>02876             <span class="keywordflow">break</span>;
<a name="l02877"></a>02877         }
<a name="l02878"></a>02878         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92aa96e60c7c64a5a65145b918cf6fcb4b4" title="verification has not been attempted">CCN_UPCALL_CONTENT_RAW</a>:
<a name="l02879"></a>02879         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a28260b0a25b7046e6930f0b13a718db0" title="incoming verified content">CCN_UPCALL_CONTENT</a>: {
<a name="l02880"></a>02880             <span class="keywordflow">if</span> (data == NULL || info == NULL ||
<a name="l02881"></a>02881                 data-&gt;<a class="code" href="struct_sync_action_data.html#aec2fc78ddb23d1c2bc5f51841e4a1b07">root</a> == NULL || data-&gt;<a class="code" href="struct_sync_action_data.html#ad64d193a1ef56426675d4042263da5c5">kind</a> != <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692a8e4c22d4ecccb39943c4a3ebaa6ea0e2" title="root advise request">SRI_Kind_RootAdvise</a>) {
<a name="l02882"></a>02882                 <span class="comment">// not active, no useful info</span>
<a name="l02883"></a>02883                 <span class="keywordflow">break</span>;
<a name="l02884"></a>02884             }
<a name="l02885"></a>02885             <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = data-&gt;<a class="code" href="struct_sync_action_data.html#aec2fc78ddb23d1c2bc5f51841e4a1b07">root</a>;
<a name="l02886"></a>02886             <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l02887"></a>02887             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l02888"></a>02888                 <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *nm = <a class="code" href="_sync_util_8c.html#a1a925a096b21aa48f337913cf8e7d373" title="Convenience routine to make a name from a ccn_indexbuf.">SyncNameForIndexbuf</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#a226aa6acbc2fe85ee7d400b52ef3664a">content_ccnb</a>,
<a name="l02889"></a>02889                                                              info-&gt;<a class="code" href="structccn__upcall__info.html#a4cb4214256b27c8512dc5f9de87aa400">content_comps</a>);
<a name="l02890"></a>02890                 <span class="keywordtype">size_t</span> bytes = info-&gt;<a class="code" href="structccn__upcall__info.html#a5483525206dfb80f831040d0d9602906">pco</a>-&gt;<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387a1d25adf694c64b4ae597b26abe6b30fc">CCN_PCO_E</a>];
<a name="l02891"></a>02891                 <span class="keywordtype">char</span> temp[64];
<a name="l02892"></a>02892                 int64_t dt = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(data-&gt;<a class="code" href="struct_sync_action_data.html#a79f3e380339ba613e01440cf2b6611fc">startTime</a>, <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>());
<a name="l02893"></a>02893                 dt = (dt + 500) / 1000;
<a name="l02894"></a>02894                 snprintf(temp, <span class="keyword">sizeof</span>(temp),
<a name="l02895"></a>02895                          <span class="stringliteral">&quot;content, %d.%03d secs, %u bytes&quot;</span>,
<a name="l02896"></a>02896                          (<span class="keywordtype">int</span>) (dt / 1000), (<span class="keywordtype">int</span>) (dt % 1000),
<a name="l02897"></a>02897                          (<span class="keywordtype">unsigned</span>) bytes);
<a name="l02898"></a>02898                 <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, temp, nm);
<a name="l02899"></a>02899                 <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;nm);
<a name="l02900"></a>02900             }
<a name="l02901"></a>02901             
<a name="l02902"></a>02902             <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *hp = NULL;
<a name="l02903"></a>02903             <span class="keywordtype">size_t</span> hs = 0;
<a name="l02904"></a>02904             <span class="keywordtype">size_t</span> bytes = 0;
<a name="l02905"></a>02905             <span class="keywordtype">int</span> failed = 0;
<a name="l02906"></a>02906             <span class="keywordtype">int</span> cres = <a class="code" href="ccn_8h.html#a70c13909ea45ffb1069916d7a512fdda" title="Extract a pointer to and size of component at given index i.">ccn_name_comp_get</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#a226aa6acbc2fe85ee7d400b52ef3664a">content_ccnb</a>,
<a name="l02907"></a>02907                                          info-&gt;<a class="code" href="structccn__upcall__info.html#a4cb4214256b27c8512dc5f9de87aa400">content_comps</a>,
<a name="l02908"></a>02908                                          data-&gt;<a class="code" href="struct_sync_action_data.html#ac2ecd62add48955272a5d9402d4532e4">skipToHash</a>, &amp;hp, &amp;hs);
<a name="l02909"></a>02909             <span class="keywordflow">if</span> (cres &lt; 0 || hp == NULL || hs == 0) {
<a name="l02910"></a>02910                 <span class="comment">// bad hash, so complain</span>
<a name="l02911"></a>02911                 failed++;
<a name="l02912"></a>02912                 <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad hash&quot;</span>, __LINE__);
<a name="l02913"></a>02913             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="_sync_actions_8c.html#af1d3bf7c6863a87ad17a9f27cda5e9e6">fauxError</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>)) {
<a name="l02914"></a>02914                 failed++;
<a name="l02915"></a>02915                 <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a2813bb28b1559ff71ca56e66d8df63a6" title="Something might be wrong.">CCNL_WARNING</a>)
<a name="l02916"></a>02916                     <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;faux error&quot;</span>);
<a name="l02917"></a>02917             } <span class="keywordflow">else</span> {
<a name="l02918"></a>02918                 <span class="keywordtype">char</span> *highWhy = <span class="stringliteral">&quot;covered&quot;</span>;
<a name="l02919"></a>02919                 <span class="keywordtype">char</span> highWhyTemp[32];
<a name="l02920"></a>02920                 <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = <a class="code" href="_sync_hash_cache_8c.html#abcf5e784c52d971d943bddef80731954" title="based on the raw hash, ensure that a remote cache entry exists ent-&amp;gt;state |= set...">SyncHashEnter</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>, hp, hs,
<a name="l02921"></a>02921                                                               <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381aec73ed0d374163f11f2d715ce0a3c197" title="a remote hash has been seen">SyncHashState_remote</a>);
<a name="l02922"></a>02922                 <a class="code" href="_sync_actions_8c.html#ab011bfe2bd9aaf272495352a045ae144">noteHash</a>(root, ce, 1, 1);
<a name="l02923"></a>02923                 <span class="keywordflow">if</span> (!<a class="code" href="_sync_actions_8c.html#a870761b1ea0620fc7bf78e6a7c4a8fb3">isCovered</a>(ce)) {
<a name="l02924"></a>02924                     <span class="comment">// may need to make an entry</span>
<a name="l02925"></a>02925                     <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *nc = NULL;
<a name="l02926"></a>02926                     <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hp, hs);
<a name="l02927"></a>02927                     <span class="keywordflow">if</span> (ce != NULL &amp;&amp; ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a> != NULL) {
<a name="l02928"></a>02928                         nc = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a>;
<a name="l02929"></a>02929                         highWhy = <span class="stringliteral">&quot;not covered&quot;</span>;
<a name="l02930"></a>02930                         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>)
<a name="l02931"></a>02931                             <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, highWhy, hex);
<a name="l02932"></a>02932                     } <span class="keywordflow">else</span> {
<a name="l02933"></a>02933                         <span class="keywordtype">int</span> nd = <a class="code" href="_sync_actions_8c.html#a30eb686207e398b04523666b16e4de17">extractDeltas</a>(root, info);
<a name="l02934"></a>02934                         <span class="keywordflow">if</span> (nd &gt; 0) {
<a name="l02935"></a>02935                             <span class="comment">// the deltas have been remembered in the root</span>
<a name="l02936"></a>02936                             snprintf(highWhyTemp, <span class="keyword">sizeof</span>(highWhyTemp),
<a name="l02937"></a>02937                                      <span class="stringliteral">&quot;deltas (%u)&quot;</span>, nd);
<a name="l02938"></a>02938                             highWhy = highWhyTemp;
<a name="l02939"></a>02939                             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l02940"></a>02940                                 <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, highWhy, hex);
<a name="l02941"></a>02941                             }
<a name="l02942"></a>02942                             <a class="code" href="_sync_actions_8c.html#ac35071e0f9bf12dcd5d9b37f36463a79">SyncStartCompareAction</a>(root, NULL);
<a name="l02943"></a>02943                         } <span class="keywordflow">else</span> {
<a name="l02944"></a>02944                             nc = <a class="code" href="_sync_actions_8c.html#aef266441ec21334a137f07c70f706859">extractNode</a>(root, info);
<a name="l02945"></a>02945                             <span class="keywordflow">if</span> (nc == NULL) {
<a name="l02946"></a>02946                                 <span class="comment">// this is bad news, the parsing failed</span>
<a name="l02947"></a>02947                                 failed++;
<a name="l02948"></a>02948                                 <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a1aa8c032da69595d9b27357c2bb83da9" title="Severe errors.">CCNL_SEVERE</a>)
<a name="l02949"></a>02949                                     <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, <span class="stringliteral">&quot;extractNode failed&quot;</span>, hex);
<a name="l02950"></a>02950                             } <span class="keywordflow">else</span> {
<a name="l02951"></a>02951                                 <span class="comment">// new entry</span>
<a name="l02952"></a>02952                                 ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a> = nc;
<a name="l02953"></a>02953                                 <a class="code" href="_sync_node_8c.html#aab2c27ab0d33e00e6bfe576bd9142c0a" title="Increments the reference count.">SyncNodeIncRC</a>(nc);
<a name="l02954"></a>02954                                 bytes = info-&gt;<a class="code" href="structccn__upcall__info.html#a5483525206dfb80f831040d0d9602906">pco</a>-&gt;<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387a1d25adf694c64b4ae597b26abe6b30fc">CCN_PCO_E</a>];
<a name="l02955"></a>02955                                 <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>)
<a name="l02956"></a>02956                                     <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, <span class="stringliteral">&quot;remote entered&quot;</span>, hex);
<a name="l02957"></a>02957                                 <a class="code" href="_sync_actions_8c.html#ac35071e0f9bf12dcd5d9b37f36463a79">SyncStartCompareAction</a>(root, ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#aba3a8329dde03169d4bb1f369b2d78cf" title="hash used to reach this entry">hash</a>);
<a name="l02958"></a>02958                             }
<a name="l02959"></a>02959                         }
<a name="l02960"></a>02960                     }
<a name="l02961"></a>02961                     free(hex);
<a name="l02962"></a>02962                 }
<a name="l02963"></a>02963                 <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a> &amp;&amp; <a class="code" href="_sync_actions_8c.html#ad990ae99fb88eb7b8bb2864dd04a459f">showHighLevel</a>) {
<a name="l02964"></a>02964                     <span class="keywordtype">char</span> temp[64];
<a name="l02965"></a>02965                     snprintf(temp, <span class="keyword">sizeof</span>(temp),
<a name="l02966"></a>02966                              <span class="stringliteral">&quot;reply received, %s&quot;</span>,
<a name="l02967"></a>02967                              highWhy);
<a name="l02968"></a>02968                     <a class="code" href="_sync_actions_8c.html#a693571491e7f8b307640238175b6aa57">showCacheEntry2</a>(root, <span class="stringliteral">&quot;Sync.$RootAdvise&quot;</span>, temp,
<a name="l02969"></a>02969                                     root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#abe335cfe4efd3e95c6fd099835d4baf9">ceCurrent</a>,
<a name="l02970"></a>02970                                     ce);
<a name="l02971"></a>02971                 }
<a name="l02972"></a>02972             }
<a name="l02973"></a>02973             <span class="keywordflow">if</span> (failed) {
<a name="l02974"></a>02974                 root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a38e2e743a14abac78e109da409dfd072">stats</a>-&gt;<a class="code" href="struct_sync_root_stats.html#aee523a1351c61a5cc03a74295ed10baf">rootAdviseFailed</a>++;
<a name="l02975"></a>02975             } <span class="keywordflow">else</span> {
<a name="l02976"></a>02976                 root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a38e2e743a14abac78e109da409dfd072">stats</a>-&gt;<a class="code" href="struct_sync_root_stats.html#a2533a72412c28ba68272fc99f22a21d2">rootAdviseReceived</a>++;
<a name="l02977"></a>02977                 root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a38e2e743a14abac78e109da409dfd072">stats</a>-&gt;<a class="code" href="struct_sync_root_stats.html#a458125c416986b8815b85369a04718b3">rootAdviseBytes</a> += bytes;
<a name="l02978"></a>02978             }
<a name="l02979"></a>02979             <span class="keywordflow">break</span>;
<a name="l02980"></a>02980         }
<a name="l02981"></a>02981         <span class="keywordflow">default</span>:
<a name="l02982"></a>02982             <span class="comment">// SHOULD NOT HAPPEN</span>
<a name="l02983"></a>02983             ret = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>;
<a name="l02984"></a>02984             <span class="keywordflow">break</span>;
<a name="l02985"></a>02985     }
<a name="l02986"></a>02986     <span class="keywordflow">return</span> ret;
<a name="l02987"></a>02987 }
<a name="l02988"></a>02988 
<a name="l02989"></a>02989 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02990"></a><a class="code" href="_sync_actions_8c.html#a883ea40ef1982edd049f48944662a933">02990</a> <a class="code" href="_sync_actions_8c.html#a883ea40ef1982edd049f48944662a933">SyncSendRootAdviseInterest</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root) {
<a name="l02991"></a>02991     <span class="keyword">static</span> <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.SyncSendRootAdviseInterest&quot;</span>;
<a name="l02992"></a>02992     <span class="keyword">enum</span> <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692">SyncRegisterActionKind</a> kind = <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692a8e4c22d4ecccb39943c4a3ebaa6ea0e2" title="root advise request">SRI_Kind_RootAdvise</a>;
<a name="l02993"></a>02993     <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>;
<a name="l02994"></a>02994     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = base-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l02995"></a>02995     <span class="keyword">struct </span><a class="code" href="struct_sync_action_data.html">SyncActionData</a> *data = <a class="code" href="_sync_actions_8c.html#adb2f129a63a7e944fa3b6bb62f3c3084">SyncFindAction</a>(root, kind);
<a name="l02996"></a>02996     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#abe335cfe4efd3e95c6fd099835d4baf9">ceCurrent</a>;
<a name="l02997"></a>02997     <span class="keyword">struct </span>ccn *ccn = base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>-&gt;<a class="code" href="structsync__plumbing.html#a5c7f66f36ab1eb5de840d06ab1da6e74">ccn</a>;
<a name="l02998"></a>02998     <span class="keywordflow">if</span> (ccn == NULL)
<a name="l02999"></a>02999         <span class="comment">// we don&#39;t have a way to send interests</span>
<a name="l03000"></a>03000         <span class="keywordflow">return</span> 0;
<a name="l03001"></a>03001     <span class="keywordflow">if</span> (data != NULL) {
<a name="l03002"></a>03002         <span class="comment">// don&#39;t override exiting interest for this root unless the root has changed</span>
<a name="l03003"></a>03003         <span class="keywordflow">if</span> (ce == NULL || ce == root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a1998de60355f20d0664de51eac6258c8">lastLocalSent</a>)
<a name="l03004"></a>03004             <span class="keywordflow">return</span> 0;
<a name="l03005"></a>03005         <span class="comment">// mark this as inactive, reply to be ignored</span>
<a name="l03006"></a>03006         data-&gt;<a class="code" href="struct_sync_action_data.html#ad64d193a1ef56426675d4042263da5c5">kind</a> = <a class="code" href="_sync_actions_8h.html#a66e853f1d2264aa0df8efca8d0997692a7640d722dadf2853d6ea27eda0e8d3ef">SRI_Kind_None</a>;
<a name="l03007"></a>03007         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>)
<a name="l03008"></a>03008             <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;marked old interest as inactive&quot;</span>);
<a name="l03009"></a>03009     }
<a name="l03010"></a>03010     <span class="keyword">struct </span><a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *action = <a class="code" href="_sync_macros_8h.html#ab707d3cfcb52f2e2f819771123942548">NEW_STRUCT</a>(1, <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a>);
<a name="l03011"></a>03011     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *prefix = <a class="code" href="_sync_actions_8c.html#adf89fd412f0e65a80e9a7e961f7d6b13">constructCommandPrefix</a>(root, kind);
<a name="l03012"></a>03012     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *hash = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l03013"></a>03013     
<a name="l03014"></a>03014     <a class="code" href="charbuf_8h.html#aca88638b2e81602eb4a1da9be923dad7">ccn_charbuf_append_charbuf</a>(hash, root-&gt;<a class="code" href="struct_sync_root_struct.html#a013f6ae133c768d7bff2495445283bb4" title="current top-level cache hash">currentHash</a>);
<a name="l03015"></a>03015     <a class="code" href="ccn_8h.html#a3f4f614f38ae77dccb4099e982c646f8" title="Add a Component to a Name.">ccn_name_append</a>(prefix, hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l03016"></a>03016     
<a name="l03017"></a>03017     data = <a class="code" href="_sync_actions_8c.html#a16e2f339bd3d0141bdc0fbf8a128ff26">newActionData</a>(kind);
<a name="l03018"></a>03018     data-&gt;<a class="code" href="struct_sync_action_data.html#ac2ecd62add48955272a5d9402d4532e4">skipToHash</a> = <a class="code" href="_sync_util_8c.html#aa1be3053fdf3e2122f3582e74ff8b694">SyncComponentCount</a>(prefix);
<a name="l03019"></a>03019     data-&gt;<a class="code" href="struct_sync_action_data.html#af8df0a4ba0bd30cd13c1976985e8d7f1">hash</a> = hash;
<a name="l03020"></a>03020     data-&gt;<a class="code" href="struct_sync_action_data.html#a74202828f01407a2254b56ba73bdfd23">prefix</a> = prefix;
<a name="l03021"></a>03021     action-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a> = data;
<a name="l03022"></a>03022     action-&gt;<a class="code" href="structccn__closure.html#a48dca74271023e0caf287ad31dd1e66c" title="client-supplied handler">p</a> = &amp;<a class="code" href="_sync_actions_8c.html#af9de4a2101bd02a94534871bffc25cea">SyncRootAdviseResponse</a>;
<a name="l03023"></a>03023     
<a name="l03024"></a>03024     <span class="keyword">struct </span><a class="code" href="struct_sync_name_accum.html">SyncNameAccum</a> *excl = <a class="code" href="_sync_util_8c.html#a63abbe663332372f438ec05fbfc88bd0">SyncExclusionsFromHashList</a>(root, NULL, root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a7c217e7610fe07ecbf7ad85c2b4785c7">remoteSeen</a>);
<a name="l03025"></a>03025     excl = <a class="code" href="_sync_util_8c.html#a63abbe663332372f438ec05fbfc88bd0">SyncExclusionsFromHashList</a>(root, excl, root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a7f856ccd9518ec05ad8605f8fb46a47b">localMade</a>);
<a name="l03026"></a>03026     <span class="keywordtype">int</span> exclCount = ((excl == NULL) ? 0 : excl-&gt;<a class="code" href="struct_sync_name_accum.html#a43e6bf3321957d08f4985443cc36555d">len</a>);
<a name="l03027"></a>03027     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *<span class="keyword">template</span> = <a class="code" href="_sync_util_8c.html#a72ca03631d566369877fc92b0819d720" title="given a spec for the desired fields (scope, lifetime, maxSuffix, child are omitted...">SyncGenInterest</a>(NULL,
<a name="l03028"></a>03028                                                    root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a043c6fc891ececbddbc4b446ecd5bc31">syncScope</a>,
<a name="l03029"></a>03029                                                    root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>-&gt;<a class="code" href="struct_sync_private.html#a0797a7f49da728903eb8c2a1adbca1a9">rootAdviseLifetime</a>,
<a name="l03030"></a>03030                                                    -1, -1,
<a name="l03031"></a>03031                                                    excl);
<a name="l03032"></a>03032     <span class="keywordtype">int</span> res = <a class="code" href="ccn_8h.html#a9f2d6eede46c8aac3dbb4b6e22e1d492">ccn_express_interest</a>(ccn,
<a name="l03033"></a>03033                                    prefix,
<a name="l03034"></a>03034                                    action,
<a name="l03035"></a>03035                                    <span class="keyword">template</span>);
<a name="l03036"></a>03036     <a class="code" href="_sync_util_8c.html#a6c2c47daae1a00b2fd20577c8bd7eef0" title="frees the name accum and all of the names">SyncFreeNameAccumAndNames</a>(excl);
<a name="l03037"></a>03037     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;<span class="keyword">template</span>);
<a name="l03038"></a>03038     <span class="keywordflow">if</span> (res &gt;= 0) {
<a name="l03039"></a>03039         <span class="comment">// link the request into the root</span>
<a name="l03040"></a>03040         <span class="keywordflow">if</span> (root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#ae1767969829a1018570bf64d50ab5c8f">adviseNeed</a> &gt; 0) root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#ae1767969829a1018570bf64d50ab5c8f">adviseNeed</a>--;
<a name="l03041"></a>03041         <a class="code" href="_sync_actions_8c.html#a95080bffa712dcfdea59f2fe0affd18b">linkActionData</a>(root, data);
<a name="l03042"></a>03042         root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a9c79def61eb0960acdd5db128e76e4fe">lastAdvise</a> = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l03043"></a>03043         root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a1998de60355f20d0664de51eac6258c8">lastLocalSent</a> = ce;
<a name="l03044"></a>03044         root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a38e2e743a14abac78e109da409dfd072">stats</a>-&gt;<a class="code" href="struct_sync_root_stats.html#aee16b2c92c038b6b7670d89e3d236770">rootAdviseSent</a>++;
<a name="l03045"></a>03045         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l03046"></a>03046             <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, <span class="stringliteral">&quot;sent&quot;</span>, prefix);
<a name="l03047"></a>03047             <span class="keywordflow">if</span> (<a class="code" href="_sync_actions_8c.html#ad990ae99fb88eb7b8bb2864dd04a459f">showHighLevel</a>) {
<a name="l03048"></a>03048                 <span class="keywordtype">char</span> temp[32];
<a name="l03049"></a>03049                 snprintf(temp, <span class="keyword">sizeof</span>(temp),
<a name="l03050"></a>03050                          <span class="stringliteral">&quot;interest sent (excl %d)&quot;</span>, exclCount);
<a name="l03051"></a>03051                 <a class="code" href="_sync_actions_8c.html#a677c4508262ab00cdea51b16065eac17">showCacheEntry1</a>(root, <span class="stringliteral">&quot;Sync.$RootAdvise&quot;</span>, temp, ce);
<a name="l03052"></a>03052             }
<a name="l03053"></a>03053         }
<a name="l03054"></a>03054         <span class="keywordflow">return</span> 1;
<a name="l03055"></a>03055     } <span class="keywordflow">else</span> {
<a name="l03056"></a>03056         <span class="comment">// failed, so return the storage</span>
<a name="l03057"></a>03057         data = <a class="code" href="_sync_actions_8c.html#a9826ac9a64ba2f80ef24985bee419929">destroyActionData</a>(data);
<a name="l03058"></a>03058         free(action);
<a name="l03059"></a>03059         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#af91ddb985e8b28b1f1d0c74c7b6385c9" title="Configuration errors.">CCNL_ERROR</a>)
<a name="l03060"></a>03060             <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;ccn_express_interest failed&quot;</span>);
<a name="l03061"></a>03061         <span class="keywordflow">return</span> -1;
<a name="l03062"></a>03062     }
<a name="l03063"></a>03063 }
<a name="l03064"></a>03064 
<a name="l03065"></a>03065 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l03066"></a><a class="code" href="_sync_actions_8c.html#adc98208f3a3edd356b8aee8d0ee039a1">03066</a> <a class="code" href="_sync_actions_8c.html#adc98208f3a3edd356b8aee8d0ee039a1">MakeNodeFromNames</a>(<span class="keyword">struct</span> SyncUpdateData *ud, <span class="keywordtype">int</span> split) {
<a name="l03067"></a>03067     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.MakeNodeFromNames&quot;</span>;
<a name="l03068"></a>03068     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = ud-&gt;root;
<a name="l03069"></a>03069     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l03070"></a>03070     <span class="keyword">struct </span><a class="code" href="struct_sync_name_accum.html">SyncNameAccum</a> *na = ud-&gt;sort;
<a name="l03071"></a>03071     <span class="keywordtype">int</span> lim = na-&gt;<a class="code" href="struct_sync_name_accum.html#a43e6bf3321957d08f4985443cc36555d">len</a>;
<a name="l03072"></a>03072     <span class="keywordflow">if</span> (lim == 0)
<a name="l03073"></a>03073         <span class="comment">// should not have been called, but no harm done</span>
<a name="l03074"></a>03074         <span class="keywordflow">return</span> 0;
<a name="l03075"></a>03075     <span class="keywordtype">int</span> i = 0;
<a name="l03076"></a>03076     <span class="keywordflow">if</span> (split == 0) split = lim;
<a name="l03077"></a>03077     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l03078"></a>03078         <span class="keywordtype">char</span> tmp[64];
<a name="l03079"></a>03079         snprintf(tmp, <span class="keyword">sizeof</span>(tmp),
<a name="l03080"></a>03080                  <span class="stringliteral">&quot;split %d, lim %d&quot;</span>,
<a name="l03081"></a>03081                  split, lim);
<a name="l03082"></a>03082         <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, tmp);
<a name="l03083"></a>03083     }
<a name="l03084"></a>03084     
<a name="l03085"></a>03085     <span class="comment">// accum the hash for the node, and see if it exists</span>
<a name="l03086"></a>03086     <span class="keyword">struct </span><a class="code" href="struct_sync_long_hash_struct.html" title="A SyncLongHashStruct is used to accumulate a combined hash code The pos field is...">SyncLongHashStruct</a> longHash;
<a name="l03087"></a>03087     memset(&amp;longHash, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="struct_sync_long_hash_struct.html" title="A SyncLongHashStruct is used to accumulate a combined hash code The pos field is...">SyncLongHashStruct</a>));
<a name="l03088"></a>03088     longHash.<a class="code" href="struct_sync_long_hash_struct.html#ae53b573313bdbdd9f31f4010112f1aa9">pos</a> = <a class="code" href="_sync_macros_8h.html#a3922c71e229552ce16d1c6e016c10dd8">MAX_HASH_BYTES</a>;
<a name="l03089"></a>03089     <span class="keywordflow">for</span> (i = 0; i &lt; split; i++) {
<a name="l03090"></a>03090         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = na-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[i].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a>;
<a name="l03091"></a>03091         <a class="code" href="_sync_util_8c.html#adf85aac3b766385d231242a06f606c15">SyncAccumHash</a>(&amp;longHash, name);
<a name="l03092"></a>03092     }
<a name="l03093"></a>03093     ssize_t hs = <a class="code" href="_sync_macros_8h.html#a3922c71e229552ce16d1c6e016c10dd8">MAX_HASH_BYTES</a>-longHash.<a class="code" href="struct_sync_long_hash_struct.html#ae53b573313bdbdd9f31f4010112f1aa9">pos</a>;
<a name="l03094"></a>03094     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *hp = longHash.<a class="code" href="struct_sync_long_hash_struct.html#a57ac8b0ec5184164f74edb8cfb45220a">bytes</a>+longHash.<a class="code" href="struct_sync_long_hash_struct.html#ae53b573313bdbdd9f31f4010112f1aa9">pos</a>;
<a name="l03095"></a>03095     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = <a class="code" href="_sync_hash_cache_8c.html#a15c6eafb71bb631fde85a2424f5ac449" title="lookup a full hash in a hash table (raw contents, no tag)">SyncHashLookup</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>, hp, hs);
<a name="l03096"></a>03096     <span class="keywordflow">if</span> (ce != NULL &amp;&amp; ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a> != NULL) {
<a name="l03097"></a>03097         <span class="comment">// node already exists</span>
<a name="l03098"></a>03098         <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *nc = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a>;
<a name="l03099"></a>03099         <a class="code" href="_sync_node_8c.html#aab2c27ab0d33e00e6bfe576bd9142c0a" title="Increments the reference count.">SyncNodeIncRC</a>(nc);
<a name="l03100"></a>03100         <a class="code" href="_sync_util_8c.html#adcc1cea741c9dc3781e76b1713a6a579">SyncAccumNode</a>(ud-&gt;nodes, nc);
<a name="l03101"></a>03101         root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a38e2e743a14abac78e109da409dfd072">stats</a>-&gt;<a class="code" href="struct_sync_root_stats.html#a9c4b7420a516f81a8fcbf566b31a93b8">nodesShared</a>++;
<a name="l03102"></a>03102         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l03103"></a>03103             <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hp, hs);
<a name="l03104"></a>03104             <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, <span class="stringliteral">&quot;existing local node&quot;</span>, hex);
<a name="l03105"></a>03105             free(hex);
<a name="l03106"></a>03106         }
<a name="l03107"></a>03107     } <span class="keywordflow">else</span> {
<a name="l03108"></a>03108         <span class="comment">// need to create a new node</span>
<a name="l03109"></a>03109         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l03110"></a>03110             <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hp, hs);
<a name="l03111"></a>03111             <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, <span class="stringliteral">&quot;need new local node&quot;</span>, hex);
<a name="l03112"></a>03112             free(hex);
<a name="l03113"></a>03113         }
<a name="l03114"></a>03114         <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *nc = <a class="code" href="_sync_node_8c.html#adbc4a9ebd7d35b9d7c9d36a9c3263bb7" title="allocates a new, empty, composite object">SyncAllocComposite</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>);
<a name="l03115"></a>03115         <span class="keywordflow">for</span> (i = 0; i &lt; split; i++)
<a name="l03116"></a>03116             <a class="code" href="_sync_node_8c.html#af50e30366159577adfcc4207665d5c15" title="extends the references section of a composite object with a new name, updating the...">SyncNodeAddName</a>(nc, na-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[i].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a>);
<a name="l03117"></a>03117         <a class="code" href="_sync_node_8c.html#a15cb874167ed7c39b1d2af2957a5036d" title="endComposite finishes up the encoding, appending the composite fields the hash field...">SyncEndComposite</a>(nc);
<a name="l03118"></a>03118         <a class="code" href="_sync_actions_8c.html#a12f107ab8c09088d09713f29247cdbab">newNodeCommon</a>(root, ud-&gt;nodes, nc);
<a name="l03119"></a>03119     }
<a name="l03120"></a>03120     <span class="keywordflow">for</span> (i = 0; i &lt; split; i++)
<a name="l03121"></a>03121         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;na-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[i].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a>);
<a name="l03122"></a>03122     <span class="comment">// shift remaining elements down in the name accum</span>
<a name="l03123"></a>03123     ud-&gt;nameLenAccum = 0;
<a name="l03124"></a>03124     i = 0;
<a name="l03125"></a>03125     <span class="keywordflow">while</span> (split &lt; lim) {
<a name="l03126"></a>03126         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = na-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[split].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a>;
<a name="l03127"></a>03127         ud-&gt;nameLenAccum += name-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>;
<a name="l03128"></a>03128         na-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[i] = na-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[split];
<a name="l03129"></a>03129         na-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[split].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a> = NULL;
<a name="l03130"></a>03130         i++;
<a name="l03131"></a>03131         split++;
<a name="l03132"></a>03132     }
<a name="l03133"></a>03133     na-&gt;<a class="code" href="struct_sync_name_accum.html#a43e6bf3321957d08f4985443cc36555d">len</a> = i;
<a name="l03134"></a>03134     <span class="keywordflow">return</span> i;
<a name="l03135"></a>03135 }
<a name="l03136"></a>03136 
<a name="l03137"></a>03137 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l03138"></a><a class="code" href="_sync_actions_8c.html#aa5139d218c713da44fe6f0cad4468a8b">03138</a> <a class="code" href="_sync_actions_8c.html#aa5139d218c713da44fe6f0cad4468a8b">TryNodeSplit</a>(<span class="keyword">struct</span> SyncUpdateData *ud) {
<a name="l03139"></a>03139     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.TryNodeSplit&quot;</span>;
<a name="l03140"></a>03140     <span class="keyword">struct </span><a class="code" href="struct_sync_name_accum.html">SyncNameAccum</a> *na = ud-&gt;sort;
<a name="l03141"></a>03141     <span class="keywordtype">int</span> lim = na-&gt;<a class="code" href="struct_sync_name_accum.html#a43e6bf3321957d08f4985443cc36555d">len</a>;
<a name="l03142"></a>03142     <span class="keywordflow">if</span> (lim == 0)
<a name="l03143"></a>03143         <span class="comment">// should not have been called, but no harm done</span>
<a name="l03144"></a>03144         <span class="keywordflow">return</span> 0;
<a name="l03145"></a>03145     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = ud-&gt;root;
<a name="l03146"></a>03146     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l03147"></a>03147     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *prev = NULL;
<a name="l03148"></a>03148     <span class="keywordtype">int</span> accLim = <a class="code" href="_sync_actions_8c.html#ad6e384ed8d6687203b96177c4425df08">nodeSplitTrigger</a> - <a class="code" href="_sync_actions_8c.html#ad6e384ed8d6687203b96177c4425df08">nodeSplitTrigger</a>/8;
<a name="l03149"></a>03149     <span class="keywordtype">int</span> accMin = <a class="code" href="_sync_actions_8c.html#ad6e384ed8d6687203b96177c4425df08">nodeSplitTrigger</a>/2;
<a name="l03150"></a>03150     <span class="keywordtype">int</span> res = 0;
<a name="l03151"></a>03151     <span class="keywordtype">int</span> splitMethod = 3;  <span class="comment">// was variable, now is constantly enabled</span>
<a name="l03152"></a>03152     <span class="keywordtype">int</span> maxLen = 0;
<a name="l03153"></a>03153     <span class="keywordtype">int</span> accLen = 0;
<a name="l03154"></a>03154     <span class="keywordtype">int</span> prevMatch = 0;
<a name="l03155"></a>03155     <span class="keywordtype">int</span> split = 0;
<a name="l03156"></a>03156     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l03157"></a>03157         <span class="keywordtype">char</span> tmp[64];
<a name="l03158"></a>03158         snprintf(tmp, <span class="keyword">sizeof</span>(tmp),
<a name="l03159"></a>03159                  <span class="stringliteral">&quot;entered, %d names&quot;</span>,
<a name="l03160"></a>03160                  lim);
<a name="l03161"></a>03161         <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, tmp);
<a name="l03162"></a>03162     }
<a name="l03163"></a>03163     <span class="keywordflow">for</span> (split = 0; split &lt; lim; split++) {
<a name="l03164"></a>03164         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = na-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[split].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a>;
<a name="l03165"></a>03165         <span class="keywordtype">int</span> nameLen = name-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> + 8;
<a name="l03166"></a>03166         <span class="keywordflow">if</span> (nameLen &gt; maxLen) maxLen = nameLen;
<a name="l03167"></a>03167         accLen = accLen + nameLen + (maxLen - nameLen) * 2;
<a name="l03168"></a>03168         prev = name;
<a name="l03169"></a>03169         <span class="keywordflow">if</span> (split+1 &lt; lim) {
<a name="l03170"></a>03170             <span class="keywordflow">if</span> (splitMethod &amp; 1) {
<a name="l03171"></a>03171                 <span class="comment">// use level shift to split</span>
<a name="l03172"></a>03172                 <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *next = na-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[split+1].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a>;
<a name="l03173"></a>03173                 <span class="keywordtype">int</span> match = <a class="code" href="_sync_util_8c.html#a056c61da0b2155d6a2e53f5c4e9f8e74">SyncComponentMatch</a>(name, next);
<a name="l03174"></a>03174                 <span class="keywordflow">if</span> (accLen &gt;= accMin
<a name="l03175"></a>03175                     &amp;&amp; (match &lt; prevMatch || (match &gt; prevMatch+1))) {
<a name="l03176"></a>03176                     <span class="comment">// force a break due to level changes</span>
<a name="l03177"></a>03177                     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l03178"></a>03178                         <span class="keywordtype">char</span> tmp[64];
<a name="l03179"></a>03179                         snprintf(tmp, <span class="keyword">sizeof</span>(tmp),
<a name="l03180"></a>03180                                  <span class="stringliteral">&quot;split %d, lim %d, match %d, prev %d, accLen %d&quot;</span>,
<a name="l03181"></a>03181                                  split, lim, match, prevMatch, accLen);
<a name="l03182"></a>03182                         <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, <span class="stringliteral">&quot;level split found&quot;</span>, tmp);
<a name="l03183"></a>03183                     }
<a name="l03184"></a>03184                     <span class="keywordflow">break</span>;
<a name="l03185"></a>03185                 }
<a name="l03186"></a>03186                 prevMatch = match;
<a name="l03187"></a>03187             }
<a name="l03188"></a>03188             <span class="keywordflow">if</span> (splitMethod &amp; 2) {
<a name="l03189"></a>03189                 <span class="comment">// use bits of hash to split</span>
<a name="l03190"></a>03190                 <span class="keywordtype">int</span> pos = name-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> - 9;
<a name="l03191"></a>03191                 <span class="keywordflow">if</span> (pos &gt; 0 &amp;&amp; accLen &gt;= accMin) {
<a name="l03192"></a>03192                     <span class="keywordtype">unsigned</span> c = name-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>[pos] &amp; 255;
<a name="l03193"></a>03193                     <span class="keywordflow">if</span> (c &lt; <a class="code" href="_sync_actions_8c.html#a81327fc9c584dac59986ec3725d2cd77">hashSplitTrigger</a>) {
<a name="l03194"></a>03194                         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l03195"></a>03195                             <span class="keywordtype">char</span> tmp[64];
<a name="l03196"></a>03196                             snprintf(tmp, <span class="keyword">sizeof</span>(tmp),
<a name="l03197"></a>03197                                      <span class="stringliteral">&quot;split %d, lim %d, x %u, accLen %d&quot;</span>,
<a name="l03198"></a>03198                                      split, lim, c, accLen);
<a name="l03199"></a>03199                             <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, <span class="stringliteral">&quot;hash split found&quot;</span>, tmp);
<a name="l03200"></a>03200                         }
<a name="l03201"></a>03201                         <span class="keywordflow">break</span>;
<a name="l03202"></a>03202                     }
<a name="l03203"></a>03203                 }
<a name="l03204"></a>03204             }
<a name="l03205"></a>03205         }
<a name="l03206"></a>03206         <span class="keywordflow">if</span> (accLen &gt;= accLim) {
<a name="l03207"></a>03207             <span class="keywordflow">break</span>;
<a name="l03208"></a>03208         }
<a name="l03209"></a>03209     }
<a name="l03210"></a>03210     <span class="comment">// at this point we take the first &quot;split&quot; elements into a node</span>
<a name="l03211"></a>03211     res = <a class="code" href="_sync_actions_8c.html#adc98208f3a3edd356b8aee8d0ee039a1">MakeNodeFromNames</a>(ud, split);
<a name="l03212"></a>03212     <span class="keywordflow">return</span> res;
<a name="l03213"></a>03213 }
<a name="l03214"></a>03214 
<a name="l03215"></a>03215 <span class="comment">// AddUpdateName adds a name to the current update name accumulator</span>
<a name="l03216"></a>03216 <span class="comment">// and adds it to the deltas if it is a new name and can be added</span>
<a name="l03217"></a>03217 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l03218"></a><a class="code" href="_sync_actions_8c.html#a9a7cd72bc68a89893e1d9e6184a3ba0c">03218</a> <a class="code" href="_sync_actions_8c.html#a9a7cd72bc68a89893e1d9e6184a3ba0c">AddUpdateName</a>(<span class="keyword">struct</span> SyncUpdateData *ud, <span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name, <span class="keywordtype">int</span> isNew) {
<a name="l03219"></a>03219     <span class="keyword">static</span> <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.AddUpdateName&quot;</span>;
<a name="l03220"></a>03220     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = ud-&gt;root;
<a name="l03221"></a>03221     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l03222"></a>03222     <span class="keyword">struct </span><a class="code" href="struct_sync_name_accum.html">SyncNameAccum</a> *dst = ud-&gt;sort;
<a name="l03223"></a>03223     <span class="keywordtype">int</span> nameLen = name-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>;
<a name="l03224"></a>03224     <span class="keywordtype">int</span> accLim = <a class="code" href="_sync_actions_8c.html#ad6e384ed8d6687203b96177c4425df08">nodeSplitTrigger</a> - <a class="code" href="_sync_actions_8c.html#ad6e384ed8d6687203b96177c4425df08">nodeSplitTrigger</a>/8;
<a name="l03225"></a>03225     <span class="keywordtype">int</span> res = 0;
<a name="l03226"></a>03226     name = <a class="code" href="_sync_util_8c.html#a01fc44dbffb2f846caf907c293b98c02">SyncCopyName</a>(name);
<a name="l03227"></a>03227     <a class="code" href="_sync_util_8c.html#a9c7204a6cd37470ba61c05e5da8d8fc6" title="appends a new name with associated data important: the name is not copied!">SyncNameAccumAppend</a>(dst, name, 0);
<a name="l03228"></a>03228     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l03229"></a>03229         <span class="keywordtype">char</span> *msg = ((isNew) ? <span class="stringliteral">&quot;added+&quot;</span> : <span class="stringliteral">&quot;added&quot;</span>);
<a name="l03230"></a>03230         <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, msg, name);
<a name="l03231"></a>03231     }
<a name="l03232"></a>03232     <span class="keywordflow">if</span> (isNew) {
<a name="l03233"></a>03233         <span class="keyword">struct </span><a class="code" href="struct_sync_root_deltas.html">SyncRootDeltas</a> *deltas = ud-&gt;deltas;
<a name="l03234"></a>03234         <span class="keywordtype">int</span> deltasLimit = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>-&gt;<a class="code" href="struct_sync_private.html#a7c88ee63ac4522d6bb14fc3803135164">deltasLimit</a>;
<a name="l03235"></a>03235         <span class="keywordflow">if</span> (deltasLimit &gt; 0 &amp;&amp; deltas != NULL &amp;&amp; deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a2eb71f131a177b594dd505d31ef13f0c">coding</a> != NULL) {
<a name="l03236"></a>03236             <span class="comment">// append the name to the update coding</span>
<a name="l03237"></a>03237             <a class="code" href="charbuf_8h.html#aca88638b2e81602eb4a1da9be923dad7">ccn_charbuf_append_charbuf</a>(deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a2eb71f131a177b594dd505d31ef13f0c">coding</a>, name);
<a name="l03238"></a>03238             <span class="keywordflow">if</span> (deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a2eb71f131a177b594dd505d31ef13f0c">coding</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> &gt; deltasLimit) {
<a name="l03239"></a>03239                 <span class="comment">// too large for simple update, kill the coding</span>
<a name="l03240"></a>03240                 <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a2eb71f131a177b594dd505d31ef13f0c">coding</a>);
<a name="l03241"></a>03241             }
<a name="l03242"></a>03242             deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a2b8fbeba7e9500e5a01ff045ebafbca4">deltasCount</a>++;
<a name="l03243"></a>03243         }
<a name="l03244"></a>03244     }
<a name="l03245"></a>03245 
<a name="l03246"></a>03246     ud-&gt;nameLenAccum += nameLen;
<a name="l03247"></a>03247     ud-&gt;namesAdded++;
<a name="l03248"></a>03248     <span class="keywordflow">if</span> (ud-&gt;nameLenAccum &gt;= accLim) {
<a name="l03249"></a>03249         <span class="comment">// we should split, if it is possible</span>
<a name="l03250"></a>03250         res = <a class="code" href="_sync_actions_8c.html#aa5139d218c713da44fe6f0cad4468a8b">TryNodeSplit</a>(ud);
<a name="l03251"></a>03251     }
<a name="l03252"></a>03252     <span class="keywordflow">return</span> res;
<a name="l03253"></a>03253 }
<a name="l03254"></a>03254 
<a name="l03255"></a>03255 <span class="comment">// merge the semi-sorted names and the old sync tree</span>
<a name="l03256"></a>03256 <span class="comment">// returns -1 for failure, 0 for incomplete, 1 for complete</span>
<a name="l03257"></a>03257 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l03258"></a><a class="code" href="_sync_actions_8c.html#a53406413f4bca6f6a2c91b3fc8b1b6b3">03258</a> <a class="code" href="_sync_actions_8c.html#a53406413f4bca6f6a2c91b3fc8b1b6b3">SyncTreeMergeNames</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_tree_worker_head.html">SyncTreeWorkerHead</a> *head,
<a name="l03259"></a>03259                    <span class="keyword">struct</span> SyncUpdateData *ud) {
<a name="l03260"></a>03260     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.SyncTreeMergeNames&quot;</span>;
<a name="l03261"></a>03261     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = ud-&gt;root;
<a name="l03262"></a>03262     <span class="keyword">struct </span><a class="code" href="struct_sync_root_private.html">SyncRootPrivate</a> *rp = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>;
<a name="l03263"></a>03263     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l03264"></a>03264     <a class="code" href="struct_index_sorter___struct.html">IndexSorter_Base</a> ixBase = ud-&gt;ixBase;
<a name="l03265"></a>03265     <span class="keyword">struct </span><a class="code" href="struct_sync_name_accum.html">SyncNameAccum</a> *src = (<span class="keyword">struct </span><a class="code" href="struct_sync_name_accum.html">SyncNameAccum</a> *) ixBase-&gt;<a class="code" href="struct_index_sorter___struct.html#a3274800bc9f0a51d55384f18393ee142">client</a>;
<a name="l03266"></a>03266     <a class="code" href="_index_sorter_8h.html#a0a81cac7637bf5c4fcbe34ededd138ae">IndexSorter_Index</a> srcPos = 0;
<a name="l03267"></a>03267     <span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *cb = ud-&gt;cb;
<a name="l03268"></a>03268     <span class="keywordtype">int</span> res = 0;
<a name="l03269"></a>03269     <span class="keywordtype">int</span> namesLim = ud-&gt;namesAdded+<a class="code" href="_sync_actions_8c.html#ad6ea5755329f76c1602ad6ba25a27daf">namesYieldInc</a>;
<a name="l03270"></a>03270     if (head != NULL) {
<a name="l03271"></a>03271         <span class="keywordflow">while</span> (res == 0) {
<a name="l03272"></a>03272             <span class="keyword">struct </span><a class="code" href="struct_sync_tree_worker_entry.html">SyncTreeWorkerEntry</a> *ent = <a class="code" href="_sync_tree_worker_8c.html#a776013fec43bda3e07895da7e668f05a">SyncTreeWorkerTop</a>(head);
<a name="l03273"></a>03273             <span class="keywordflow">if</span> (ent == NULL) <span class="keywordflow">break</span>;
<a name="l03274"></a>03274             <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#aa98b86e01f36d39897ed843711728a36">cacheEntry</a>;
<a name="l03275"></a>03275             <span class="keywordflow">if</span> (ce == NULL)  {
<a name="l03276"></a>03276                 <span class="comment">// should not happen</span>
<a name="l03277"></a>03277                 res = -__LINE__;
<a name="l03278"></a>03278                 <span class="keywordflow">break</span>;
<a name="l03279"></a>03279             }
<a name="l03280"></a>03280             <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *nc = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a>;
<a name="l03281"></a>03281             <span class="keywordflow">if</span> (nc == NULL) nc = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a>;
<a name="l03282"></a>03282             <span class="keywordflow">if</span> (nc == NULL) {
<a name="l03283"></a>03283                 <span class="comment">// should not happen</span>
<a name="l03284"></a>03284                 res = -__LINE__;
<a name="l03285"></a>03285                 <span class="keywordflow">break</span>;
<a name="l03286"></a>03286             }
<a name="l03287"></a>03287             <span class="keywordtype">int</span> lim = nc-&gt;<a class="code" href="struct_sync_node_composite.html#a29c915fd509d8e74edf1d862f357915a" title="number of references">refLen</a>;
<a name="l03288"></a>03288             <span class="keywordflow">if</span> (ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a> &gt;= lim) {
<a name="l03289"></a>03289                 <span class="comment">// done with the current level, go back to the previous level</span>
<a name="l03290"></a>03290                 ent = <a class="code" href="_sync_tree_worker_8c.html#a0029e127047a93efbc28a7b93e1ae005" title="pops the stack and returns the top entry popping an empty stack has no effect and...">SyncTreeWorkerPop</a>(head);
<a name="l03291"></a>03291                 <span class="keywordflow">if</span> (ent == NULL) <span class="keywordflow">break</span>;
<a name="l03292"></a>03292                 ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l03293"></a>03293             } <span class="keywordflow">else</span> {
<a name="l03294"></a>03294                 <span class="keyword">struct </span><a class="code" href="struct_sync_node_elem.html">SyncNodeElem</a> *ep = &amp;nc-&gt;<a class="code" href="struct_sync_node_composite.html#a2d6c08c55513380b341cf6ef74aab2d5" title="pointer to references array">refs</a>[ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>];
<a name="l03295"></a>03295                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="struct_sync_node_elem.html#a770ab2553870198f1b5dbc1a7302eccb" title="leaf/composite flag">kind</a> &amp; <a class="code" href="_sync_node_8h.html#ab268103cfe0f550f6c750922e68b4706a814b9a3505f28764701d289e71b8a649" title="leaf">SyncElemKind_leaf</a>) {
<a name="l03296"></a>03296                     <span class="comment">// a leaf, so the element name is inline</span>
<a name="l03297"></a>03297                     <span class="keyword">enum</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64">SyncCompareResult</a> cmp = <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64a40ed003d6315e67fb76e3a251c61bf8b">SCR_after</a>;
<a name="l03298"></a>03298                     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = NULL;
<a name="l03299"></a>03299                     uint64_t seq_num = 0;
<a name="l03300"></a>03300                     
<a name="l03301"></a>03301                     <span class="keywordflow">if</span> (ud-&gt;ixBase-&gt;len &gt; 0) {
<a name="l03302"></a>03302                         srcPos = <a class="code" href="_index_sorter_8c.html#a7b408c3c57927075011edb274861e319">IndexSorter_Best</a>(ud-&gt;ixBase);
<a name="l03303"></a>03303                         name = src-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[srcPos].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a>;
<a name="l03304"></a>03304                         <span class="keywordflow">if</span> (name != NULL) {
<a name="l03305"></a>03305                             cmp = <a class="code" href="_sync_node_8c.html#a7102b95fead88e5e2eb47387583d4771" title="Compares a name against the leaf in the element.">SyncNodeCompareLeaf</a>(nc, ep, name);
<a name="l03306"></a>03306                             seq_num = src-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[srcPos].<a class="code" href="struct_sync_name_accum_entry.html#a1d7698b1a8fe70c6e30e59231314a4c4">data</a>;
<a name="l03307"></a>03307                             <span class="keywordflow">if</span> (seq_num &gt; rp-&gt;<a class="code" href="struct_sync_root_private.html#a4a0e91da86d1033d0b4a2716080e0c38">max_seq_num_build</a>)
<a name="l03308"></a>03308                                 rp-&gt;<a class="code" href="struct_sync_root_private.html#a4a0e91da86d1033d0b4a2716080e0c38">max_seq_num_build</a> = seq_num;
<a name="l03309"></a>03309                         }
<a name="l03310"></a>03310                     }
<a name="l03311"></a>03311                     <span class="keywordflow">switch</span> (cmp) {
<a name="l03312"></a>03312                         <span class="keywordflow">case</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64a0c33200977bb75a132aa6fdcfc354ea4">SCR_before</a>:
<a name="l03313"></a>03313                             <span class="comment">// add the name from src</span>
<a name="l03314"></a>03314                             <a class="code" href="_sync_actions_8c.html#a9a7cd72bc68a89893e1d9e6184a3ba0c">AddUpdateName</a>(ud, name, 1);
<a name="l03315"></a>03315                         <span class="keywordflow">case</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64ae59232c058740e4c8407b05a3d2a30f7">SCR_min</a>:
<a name="l03316"></a>03316                             <span class="comment">// advance the src, remove duplicates</span>
<a name="l03317"></a>03317                             <span class="keywordflow">if</span> (cmp == <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64ae59232c058740e4c8407b05a3d2a30f7">SCR_min</a>) {
<a name="l03318"></a>03318                                 <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l03319"></a>03319                                     <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, <span class="stringliteral">&quot;skip&quot;</span>, name);
<a name="l03320"></a>03320                                 }
<a name="l03321"></a>03321                             }
<a name="l03322"></a>03322                             <span class="keywordflow">for</span> (;;) {
<a name="l03323"></a>03323                                 <a class="code" href="_index_sorter_8c.html#a1f75d021cf9a8603a37a1a2818254f0b">IndexSorter_Rem</a>(ud-&gt;ixBase);
<a name="l03324"></a>03324                                 <span class="keywordflow">if</span> (ud-&gt;ixBase-&gt;len &lt;= 0) <span class="keywordflow">break</span>;
<a name="l03325"></a>03325                                 srcPos = <a class="code" href="_index_sorter_8c.html#a7b408c3c57927075011edb274861e319">IndexSorter_Best</a>(ud-&gt;ixBase);
<a name="l03326"></a>03326                                 <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *next = src-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[srcPos].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a>;
<a name="l03327"></a>03327                                 <span class="keywordflow">if</span> (<a class="code" href="_sync_util_8c.html#a83e5cd9675cc633d9504bd3ee7c8f025">SyncCmpNames</a>(name, next) != 0) <span class="keywordflow">break</span>;
<a name="l03328"></a>03328                                 <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l03329"></a>03329                                     <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, <span class="stringliteral">&quot;skip dup&quot;</span>, next);
<a name="l03330"></a>03330                                 }
<a name="l03331"></a>03331                             }
<a name="l03332"></a>03332                             <span class="keywordflow">break</span>;
<a name="l03333"></a>03333                         <span class="keywordflow">case</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64a40ed003d6315e67fb76e3a251c61bf8b">SCR_after</a>:
<a name="l03334"></a>03334                             <span class="comment">// add the name from the tree</span>
<a name="l03335"></a>03335                             <a class="code" href="_sync_actions_8c.html#aaf9c87ebf674e592c7bcb15aebbe937e">extractBuf</a>(cb, nc, ep);
<a name="l03336"></a>03336                             <a class="code" href="_sync_actions_8c.html#a9a7cd72bc68a89893e1d9e6184a3ba0c">AddUpdateName</a>(ud, cb, 0);
<a name="l03337"></a>03337                             ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l03338"></a>03338                             <span class="keywordflow">break</span>;
<a name="l03339"></a>03339                         <span class="keywordflow">default</span>:
<a name="l03340"></a>03340                             <span class="comment">// this is not kosher</span>
<a name="l03341"></a>03341                             res = -__LINE__;
<a name="l03342"></a>03342                             <span class="keywordflow">break</span>;
<a name="l03343"></a>03343                     }
<a name="l03344"></a>03344                     <span class="keywordflow">if</span> (ud-&gt;namesAdded &gt;= namesLim) {
<a name="l03345"></a>03345                         int64_t dt = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(ud-&gt;entryTime, <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>());
<a name="l03346"></a>03346                         <span class="keywordflow">if</span> (dt &gt;= <a class="code" href="_sync_actions_8c.html#a01f91d5802d6020d15662f4afea91e9f">namesYieldMicros</a>) {
<a name="l03347"></a>03347                             <span class="comment">// need to yield</span>
<a name="l03348"></a>03348                             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>)
<a name="l03349"></a>03349                                 <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;yield&quot;</span>);
<a name="l03350"></a>03350                             <span class="keywordflow">return</span> 0;
<a name="l03351"></a>03351                         }
<a name="l03352"></a>03352                         namesLim += <a class="code" href="_sync_actions_8c.html#ad6ea5755329f76c1602ad6ba25a27daf">namesYieldInc</a>;
<a name="l03353"></a>03353                     }
<a name="l03354"></a>03354                 } <span class="keywordflow">else</span> {
<a name="l03355"></a>03355                     <span class="comment">// a node, so push into it</span>
<a name="l03356"></a>03356                     ent = <a class="code" href="_sync_tree_worker_8c.html#a10a364304f0c94e2e44252cf24ed6572" title="pushes into the node at the current position">SyncTreeWorkerPush</a>(head);
<a name="l03357"></a>03357                     <span class="keywordflow">if</span> (ent == NULL) {
<a name="l03358"></a>03358                         res = -__LINE__;
<a name="l03359"></a>03359                         <span class="keywordflow">break</span>;
<a name="l03360"></a>03360                     }                
<a name="l03361"></a>03361                 }
<a name="l03362"></a>03362             }
<a name="l03363"></a>03363         }
<a name="l03364"></a>03364     }
<a name="l03365"></a>03365     <span class="keywordflow">if</span> (res == 0) {
<a name="l03366"></a>03366         <span class="comment">// done with the tree, move items from the src</span>
<a name="l03367"></a>03367         <span class="keywordflow">while</span> (ud-&gt;ixBase-&gt;len &gt; 0) {
<a name="l03368"></a>03368             srcPos = <a class="code" href="_index_sorter_8c.html#a7b408c3c57927075011edb274861e319">IndexSorter_Best</a>(ud-&gt;ixBase);
<a name="l03369"></a>03369             <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = src-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[srcPos].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a>;
<a name="l03370"></a>03370             <a class="code" href="_sync_actions_8c.html#a9a7cd72bc68a89893e1d9e6184a3ba0c">AddUpdateName</a>(ud, name, 1);
<a name="l03371"></a>03371             <span class="keywordflow">for</span> (;;) {
<a name="l03372"></a>03372                 <a class="code" href="_index_sorter_8c.html#a1f75d021cf9a8603a37a1a2818254f0b">IndexSorter_Rem</a>(ud-&gt;ixBase);
<a name="l03373"></a>03373                 <span class="keywordflow">if</span> (ud-&gt;ixBase-&gt;len &lt;= 0) <span class="keywordflow">break</span>;
<a name="l03374"></a>03374                 srcPos = <a class="code" href="_index_sorter_8c.html#a7b408c3c57927075011edb274861e319">IndexSorter_Best</a>(ud-&gt;ixBase);
<a name="l03375"></a>03375                 <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *next = src-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[srcPos].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a>;
<a name="l03376"></a>03376                 <span class="keywordflow">if</span> (<a class="code" href="_sync_util_8c.html#a83e5cd9675cc633d9504bd3ee7c8f025">SyncCmpNames</a>(name, next) != 0) <span class="keywordflow">break</span>;
<a name="l03377"></a>03377             }
<a name="l03378"></a>03378             <span class="keywordflow">if</span> (ud-&gt;namesAdded &gt;= namesLim) {
<a name="l03379"></a>03379                 int64_t dt = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(ud-&gt;entryTime, <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>());
<a name="l03380"></a>03380                 <span class="keywordflow">if</span> (dt &gt;= <a class="code" href="_sync_actions_8c.html#a01f91d5802d6020d15662f4afea91e9f">namesYieldMicros</a>) {
<a name="l03381"></a>03381                     <span class="comment">// need to yield</span>
<a name="l03382"></a>03382                     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>)
<a name="l03383"></a>03383                         <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;yield&quot;</span>);
<a name="l03384"></a>03384                     <span class="keywordflow">return</span> 0;
<a name="l03385"></a>03385                 }
<a name="l03386"></a>03386                 namesLim += <a class="code" href="_sync_actions_8c.html#ad6ea5755329f76c1602ad6ba25a27daf">namesYieldInc</a>;
<a name="l03387"></a>03387             }
<a name="l03388"></a>03388         }
<a name="l03389"></a>03389         res = 1;
<a name="l03390"></a>03390     }
<a name="l03391"></a>03391     <span class="keywordflow">return</span> res;
<a name="l03392"></a>03392 }
<a name="l03393"></a>03393 
<a name="l03394"></a>03394 <span class="keyword">static</span> <span class="keyword">struct </span>SyncUpdateData *
<a name="l03395"></a><a class="code" href="_sync_actions_8c.html#a4d7ce920ea0013f6b6a2f67c43563da8">03395</a> <a class="code" href="_sync_actions_8c.html#a4d7ce920ea0013f6b6a2f67c43563da8">FreeUpdateData</a>(<span class="keyword">struct</span> SyncUpdateData *ud) {
<a name="l03396"></a>03396     <span class="keywordflow">if</span> (ud != NULL) {
<a name="l03397"></a>03397         ud-&gt;sort = <a class="code" href="_sync_util_8c.html#a6c2c47daae1a00b2fd20577c8bd7eef0" title="frees the name accum and all of the names">SyncFreeNameAccumAndNames</a>(ud-&gt;sort);
<a name="l03398"></a>03398         ud-&gt;nodes = <a class="code" href="_sync_util_8c.html#a1bc7a4088f04170cdf7ea57e04866c4b">SyncFreeNodeAccum</a>(ud-&gt;nodes);
<a name="l03399"></a>03399         ud-&gt;deltas = <a class="code" href="_sync_actions_8c.html#a406c5876c44e5103173754f0ce6327a0">FreeDeltas</a>(ud-&gt;deltas);
<a name="l03400"></a>03400         free(ud);
<a name="l03401"></a>03401     }
<a name="l03402"></a>03402     <span class="keywordflow">return</span> NULL;
<a name="l03403"></a>03403 }
<a name="l03404"></a>03404 
<a name="l03405"></a>03405 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l03406"></a><a class="code" href="_sync_actions_8c.html#a1c708bcddeda324dbc2f5dc27376d251">03406</a> <a class="code" href="_sync_actions_8c.html#a1c708bcddeda324dbc2f5dc27376d251">UpdateAction</a>(<span class="keyword">struct</span> ccn_schedule *sched,
<a name="l03407"></a>03407              <span class="keywordtype">void</span> *clienth,
<a name="l03408"></a>03408              <span class="keyword">struct</span> <a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev,
<a name="l03409"></a>03409              <span class="keywordtype">int</span> flags) {
<a name="l03410"></a>03410     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.UpdateAction&quot;</span>;
<a name="l03411"></a>03411     int64_t now = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l03412"></a>03412     <span class="keyword">struct </span>SyncUpdateData *ud = (<span class="keyword">struct </span>SyncUpdateData *) ev-&gt;<a class="code" href="structccn__scheduled__event.html#a4f4c36335e9001eaca5442f672798e95">evdata</a>;
<a name="l03413"></a>03413     <span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = ud-&gt;root;
<a name="l03414"></a>03414     <span class="keyword">struct</span> <a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = root-&gt;base;
<a name="l03415"></a>03415     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = base-&gt;debug;
<a name="l03416"></a>03416     <span class="keywordtype">int</span> showEntry = base-&gt;priv-&gt;syncActionsPrivate &amp; 8;
<a name="l03417"></a>03417     ud-&gt;entryTime = now;
<a name="l03418"></a>03418     
<a name="l03419"></a>03419     switch (ud-&gt;state) {
<a name="l03420"></a>03420         <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8c.html#aa6cc1c7877f35a7df1951c989f371e90aec69f28641f92a3fd6b9451380718992">SyncUpdate_init</a>: {
<a name="l03421"></a>03421             <span class="comment">// we are initialized, and need to insert root-&gt;namesToAdd</span>
<a name="l03422"></a>03422             <span class="comment">// only process a bounded number of names each time</span>
<a name="l03423"></a>03423             <span class="keywordflow">if</span> (showEntry &amp;&amp; <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l03424"></a>03424                 <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;SyncUpdate_init&quot;</span>);
<a name="l03425"></a>03425             }
<a name="l03426"></a>03426             <span class="keyword">struct </span><a class="code" href="struct_sync_name_accum.html">SyncNameAccum</a> *src = (<span class="keyword">struct </span><a class="code" href="struct_sync_name_accum.html">SyncNameAccum</a> *) ud-&gt;ixBase-&gt;client;
<a name="l03427"></a>03427             <a class="code" href="_index_sorter_8h.html#a0a81cac7637bf5c4fcbe34ededd138ae">IndexSorter_Index</a> srcLen = src-&gt;<a class="code" href="struct_sync_name_accum.html#a43e6bf3321957d08f4985443cc36555d">len</a>;
<a name="l03428"></a>03428             <a class="code" href="_index_sorter_8h.html#a0a81cac7637bf5c4fcbe34ededd138ae">IndexSorter_Index</a> ix = ud-&gt;ixPos;
<a name="l03429"></a>03429             <a class="code" href="_index_sorter_8h.html#a0a81cac7637bf5c4fcbe34ededd138ae">IndexSorter_Index</a> ixLim = ix+<a class="code" href="_sync_actions_8c.html#ad6ea5755329f76c1602ad6ba25a27daf">namesYieldInc</a>;
<a name="l03430"></a>03430             if (srcLen &lt; ixLim) ixLim = srcLen;
<a name="l03431"></a>03431             
<a name="l03432"></a>03432             <span class="keywordflow">while</span> (ix &lt; srcLen) {
<a name="l03433"></a>03433                 <span class="keywordflow">if</span> (ix &gt; ixLim) {
<a name="l03434"></a>03434                     int64_t dt = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(ud-&gt;entryTime, <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>());
<a name="l03435"></a>03435                     <span class="keywordflow">if</span> (dt &gt;= <a class="code" href="_sync_actions_8c.html#a01f91d5802d6020d15662f4afea91e9f">namesYieldMicros</a>) {
<a name="l03436"></a>03436                         <span class="comment">// need to yield</span>
<a name="l03437"></a>03437                         <span class="keywordflow">if</span> (<a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>)
<a name="l03438"></a>03438                             <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;yield&quot;</span>);
<a name="l03439"></a>03439                         <span class="keywordflow">break</span>;
<a name="l03440"></a>03440                     }
<a name="l03441"></a>03441                     ixLim += <a class="code" href="_sync_actions_8c.html#ad6ea5755329f76c1602ad6ba25a27daf">namesYieldInc</a>;
<a name="l03442"></a>03442                 }
<a name="l03443"></a>03443                 <span class="keywordflow">if</span> (<a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l03444"></a>03444                     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = src-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[ix].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a>;
<a name="l03445"></a>03445                     <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, <span class="stringliteral">&quot;insert&quot;</span>, name);
<a name="l03446"></a>03446                 }
<a name="l03447"></a>03447                 <a class="code" href="_index_sorter_8c.html#ad71b0c293c212c0e7a4f48791c345c22">IndexSorter_Add</a>(ud-&gt;ixBase, ix);
<a name="l03448"></a>03448                 ix++;
<a name="l03449"></a>03449             }
<a name="l03450"></a>03450             ud-&gt;ixPos = ix;
<a name="l03451"></a>03451             <span class="keywordflow">if</span> (ix &lt; srcLen)
<a name="l03452"></a>03452                 <span class="comment">// not done yet, so take a break</span>
<a name="l03453"></a>03453                 <span class="keywordflow">return</span> <a class="code" href="_sync_actions_8c.html#a259cad241b04e57ac063e149d3fb511e">shortDelayMicros</a>;
<a name="l03454"></a>03454             
<a name="l03455"></a>03455             <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ent = <a class="code" href="_sync_root_8c.html#aed2aaaf7ab32c22cf311c996f97e13b8">SyncRootTopEntry</a>(root);
<a name="l03456"></a>03456             <span class="keywordflow">if</span> (ent != NULL &amp;&amp; ud-&gt;tw == NULL) {
<a name="l03457"></a>03457                 <a class="code" href="_sync_hash_cache_8c.html#a88b8496fee4324b2359f23e3c6dd9472" title="fetches the cache entry to be eligible, ce != NULL &amp;amp;&amp;amp; ce-&amp;gt;ncL != NULL...">SyncCacheEntryFetch</a>(ent);
<a name="l03458"></a>03458                 ud-&gt;tw = <a class="code" href="_sync_tree_worker_8c.html#ab50ea183a52285c94049d758fa2cb966" title="create a new tree worker, based on the given cache ent != NULL: initialize from the...">SyncTreeWorkerCreate</a>(root-&gt;ch, ent);
<a name="l03459"></a>03459             }
<a name="l03460"></a>03460             ud-&gt;sort = <a class="code" href="_sync_util_8c.html#adcdacf16d78ec4fff95eff5f0d63446b">SyncAllocNameAccum</a>(0);
<a name="l03461"></a>03461             ud-&gt;cb = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l03462"></a>03462             ud-&gt;nodes = <a class="code" href="_sync_util_8c.html#acfdd4906ae2c5ffb57df166f281a8436">SyncAllocNodeAccum</a>(0);
<a name="l03463"></a>03463             ud-&gt;state = <a class="code" href="_sync_actions_8c.html#aa6cc1c7877f35a7df1951c989f371e90acfbd019b329059114ff86b166111ea52">SyncUpdate_inserted</a>;
<a name="l03464"></a>03464         }
<a name="l03465"></a>03465         <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8c.html#aa6cc1c7877f35a7df1951c989f371e90acfbd019b329059114ff86b166111ea52">SyncUpdate_inserted</a>: {
<a name="l03466"></a>03466             <span class="comment">// all names to be added are now in ud-&gt;ixBase</span>
<a name="l03467"></a>03467             <span class="comment">// the old sync tree has not been changed</span>
<a name="l03468"></a>03468             <span class="keywordflow">if</span> (showEntry &amp;&amp; <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l03469"></a>03469                 <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;SyncUpdate_inserted&quot;</span>);
<a name="l03470"></a>03470             }
<a name="l03471"></a>03471             
<a name="l03472"></a>03472             <span class="keywordtype">int</span> res = <a class="code" href="_sync_actions_8c.html#a53406413f4bca6f6a2c91b3fc8b1b6b3">SyncTreeMergeNames</a>(ud-&gt;tw, ud);
<a name="l03473"></a>03473             <span class="keywordflow">if</span> (res == 0) <span class="keywordflow">break</span>;
<a name="l03474"></a>03474                 <span class="comment">// not done yet, pause requested</span>
<a name="l03475"></a>03475             res = <a class="code" href="_sync_actions_8c.html#adc98208f3a3edd356b8aee8d0ee039a1">MakeNodeFromNames</a>(ud, 0);
<a name="l03476"></a>03476             <span class="comment">// done, either normally or with error</span>
<a name="l03477"></a>03477             <span class="comment">// free the resources</span>
<a name="l03478"></a>03478             <span class="keyword">struct </span><a class="code" href="struct_sync_name_accum.html">SyncNameAccum</a> *src = (<span class="keyword">struct </span><a class="code" href="struct_sync_name_accum.html">SyncNameAccum</a> *) ud-&gt;ixBase-&gt;client;
<a name="l03479"></a>03479             ud-&gt;tw = <a class="code" href="_sync_tree_worker_8c.html#a5b7baae8bce01030ed514fd40e6268c5" title="Free the storage for the worker.">SyncTreeWorkerFree</a>(ud-&gt;tw);
<a name="l03480"></a>03480             src = <a class="code" href="_sync_util_8c.html#a6c2c47daae1a00b2fd20577c8bd7eef0" title="frees the name accum and all of the names">SyncFreeNameAccumAndNames</a>(src);
<a name="l03481"></a>03481             <a class="code" href="_index_sorter_8c.html#a62d194631af83ae5a4568d2145c05a62">IndexSorter_Free</a>(&amp;ud-&gt;ixBase);
<a name="l03482"></a>03482             <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;ud-&gt;cb);
<a name="l03483"></a>03483             <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l03484"></a>03484                 <span class="comment">// this is bad news!</span>
<a name="l03485"></a>03485                 ud-&gt;deltas = <a class="code" href="_sync_actions_8c.html#a406c5876c44e5103173754f0ce6327a0">FreeDeltas</a>(ud-&gt;deltas);
<a name="l03486"></a>03486                 ud-&gt;sort = <a class="code" href="_sync_util_8c.html#a6c2c47daae1a00b2fd20577c8bd7eef0" title="frees the name accum and all of the names">SyncFreeNameAccumAndNames</a>(ud-&gt;sort);
<a name="l03487"></a>03487                 <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;merge names&quot;</span>, __LINE__);
<a name="l03488"></a>03488                 <span class="keywordflow">return</span> res;
<a name="l03489"></a>03489             }
<a name="l03490"></a>03490             ud-&gt;state = <a class="code" href="_sync_actions_8c.html#aa6cc1c7877f35a7df1951c989f371e90a43d2e9c591ba0aee21329a369e1c2f5d">SyncUpdate_busy</a>;
<a name="l03491"></a>03491         }
<a name="l03492"></a>03492         <span class="keywordflow">case</span> <a class="code" href="_sync_actions_8c.html#aa6cc1c7877f35a7df1951c989f371e90a43d2e9c591ba0aee21329a369e1c2f5d">SyncUpdate_busy</a>: {
<a name="l03493"></a>03493             <span class="comment">// ud-&gt;nodes has the nodes created from the names</span>
<a name="l03494"></a>03494             <span class="comment">// the last step is to make up the node superstructure</span>
<a name="l03495"></a>03495             <span class="keywordflow">if</span> (showEntry &amp;&amp; <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l03496"></a>03496                 <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;SyncUpdate_busy&quot;</span>);
<a name="l03497"></a>03497             }
<a name="l03498"></a>03498             <span class="keywordtype">int</span> initCount = root-&gt;priv-&gt;currentSize;
<a name="l03499"></a>03499             <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = <a class="code" href="_sync_actions_8c.html#aafbab8e971bc3b20be60f597bde137d1">nodeFromNodes</a>(root, ud-&gt;nodes);
<a name="l03500"></a>03500             <span class="keywordtype">int</span> count = ud-&gt;namesAdded;
<a name="l03501"></a>03501             <span class="keywordflow">if</span> (ce == NULL) {
<a name="l03502"></a>03502                 count = <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad nodeFromNames()&quot;</span>, __LINE__);
<a name="l03503"></a>03503             } <span class="keywordflow">else</span> {
<a name="l03504"></a>03504                 <a class="code" href="_sync_hash_cache_8c.html#a88b8496fee4324b2359f23e3c6dd9472" title="fetches the cache entry to be eligible, ce != NULL &amp;amp;&amp;amp; ce-&amp;gt;ncL != NULL...">SyncCacheEntryFetch</a>(ce);
<a name="l03505"></a>03505                 <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *nc = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a>;
<a name="l03506"></a>03506                 <span class="keywordflow">if</span> (nc != NULL) {
<a name="l03507"></a>03507                     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *old = root-&gt;currentHash;
<a name="l03508"></a>03508                     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *hash = <a class="code" href="_sync_util_8c.html#ae3d2194bffabb34d644a34297c834ecf">SyncLongHashToBuf</a>(&amp;nc-&gt;<a class="code" href="struct_sync_node_composite.html#afda83b9329537ddc4c035bb21d292896" title="space for accumulated hash">longHash</a>);
<a name="l03509"></a>03509                     <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l03510"></a>03510                     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *cePrev = root-&gt;priv-&gt;ceCurrent;
<a name="l03511"></a>03511                     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = <a class="code" href="_sync_hash_cache_8c.html#abcf5e784c52d971d943bddef80731954" title="based on the raw hash, ensure that a remote cache entry exists ent-&amp;gt;state |= set...">SyncHashEnter</a>(root-&gt;ch, 
<a name="l03512"></a>03512                                                                   hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>,
<a name="l03513"></a>03513                                                                   <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a9e849b0fed91e850763db20a54956128" title="a local node exists">SyncHashState_local</a>);
<a name="l03514"></a>03514                     root-&gt;currentHash = hash;
<a name="l03515"></a>03515                     root-&gt;priv-&gt;ceCurrent = ce;
<a name="l03516"></a>03516                     root-&gt;priv-&gt;currentSize = count;
<a name="l03517"></a>03517                     now = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l03518"></a>03518                     <span class="keywordflow">if</span> (ce != cePrev) {
<a name="l03519"></a>03519                         <span class="comment">// note the time of the last hash change</span>
<a name="l03520"></a>03520                         root-&gt;priv-&gt;lastHashChange = now;
<a name="l03521"></a>03521                         <a class="code" href="_sync_actions_8c.html#ab011bfe2bd9aaf272495352a045ae144">noteHash</a>(root, ce, 1, 0);
<a name="l03522"></a>03522                     }
<a name="l03523"></a>03523                     ud-&gt;ceStop = ce;
<a name="l03524"></a>03524                     <span class="comment">// now that we have a new current hash, close out the deltas</span>
<a name="l03525"></a>03525                     <span class="keyword">struct </span><a class="code" href="struct_sync_root_deltas.html">SyncRootDeltas</a> *deltas = <a class="code" href="_sync_actions_8c.html#a61417e4f76c984616002640ea5d825c4">CloseUpdateCoding</a>(ud);
<a name="l03526"></a>03526                     int64_t dt = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(ud-&gt;startTime, now);
<a name="l03527"></a>03527                     root-&gt;priv-&gt;stats-&gt;updatesDone++;
<a name="l03528"></a>03528                     root-&gt;priv-&gt;stats-&gt;lastUpdateMicros = dt;
<a name="l03529"></a>03529                     dt = (dt + 500) / 1000;
<a name="l03530"></a>03530                     int64_t mh = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(ud-&gt;entryTime, now);
<a name="l03531"></a>03531                     <span class="keywordflow">if</span> (mh &lt; ud-&gt;maxHold) mh = ud-&gt;maxHold;
<a name="l03532"></a>03532                     mh = (mh + 500) / 1000;
<a name="l03533"></a>03533                     <span class="keywordflow">if</span> (<a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l03534"></a>03534                         <span class="keywordtype">int</span> reportStats = base-&gt;priv-&gt;syncActionsPrivate &amp; 4;
<a name="l03535"></a>03535                         <span class="keywordtype">char</span> temp[256];
<a name="l03536"></a>03536                         snprintf(temp, <span class="keyword">sizeof</span>(temp)-2,
<a name="l03537"></a>03537                                  <span class="stringliteral">&quot;%d.%03d secs [%d.%03d], %d names, depth %d, hash %s&quot;</span>,
<a name="l03538"></a>03538                                  (<span class="keywordtype">int</span>) (dt / 1000), (<span class="keywordtype">int</span>) (dt % 1000),
<a name="l03539"></a>03539                                  (<span class="keywordtype">int</span>) (mh / 1000), (<span class="keywordtype">int</span>) (mh % 1000),
<a name="l03540"></a>03540                                  (<span class="keywordtype">int</span>) count, (<span class="keywordtype">int</span>) nc-&gt;<a class="code" href="struct_sync_node_composite.html#a2394633cbdfbb3733266a8fef137f6e2" title="max tree depth (includes this node)">treeDepth</a>, hex);
<a name="l03541"></a>03541                         <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, <span class="stringliteral">&quot;done&quot;</span>, temp);
<a name="l03542"></a>03542                         <span class="keywordflow">if</span> (reportStats) {
<a name="l03543"></a>03543                             <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *cb = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l03544"></a>03544                             <a class="code" href="_sync_actions_8c.html#a2246f94f121a2ca6c1346b721484ed80">formatStats</a>(root, cb);
<a name="l03545"></a>03545                             <span class="keywordtype">char</span> *str = <a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(cb);
<a name="l03546"></a>03546                             <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base, <span class="stringliteral">&quot;%s, %s&quot;</span>, here, str);
<a name="l03547"></a>03547                             <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;cb);
<a name="l03548"></a>03548                         }
<a name="l03549"></a>03549                     }
<a name="l03550"></a>03550                     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *chk = <a class="code" href="_sync_root_8c.html#aed2aaaf7ab32c22cf311c996f97e13b8">SyncRootTopEntry</a>(root);
<a name="l03551"></a>03551                     <span class="keywordflow">if</span> (chk != ce)
<a name="l03552"></a>03552                         count = <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad top entry&quot;</span>, __LINE__);
<a name="l03553"></a>03553                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ud-&gt;ceStart != ud-&gt;ceStop) {
<a name="l03554"></a>03554                         <span class="comment">// only do this if the update got something</span>
<a name="l03555"></a>03555                         <span class="keyword">struct </span><a class="code" href="struct_sync_hash_info_list.html">SyncHashInfoList</a> *remoteSeen = <a class="code" href="_sync_actions_8c.html#af6a5e58957baa0d187552042740ccdd6">scanRemoteSeen</a>(root, ud-&gt;ceStart);
<a name="l03556"></a>03556                         <span class="keywordflow">if</span> (<a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l03557"></a>03557                             <span class="keywordflow">if</span> (<a class="code" href="_sync_actions_8c.html#ad990ae99fb88eb7b8bb2864dd04a459f">showHighLevel</a>) {
<a name="l03558"></a>03558                                 <span class="keywordtype">char</span> temp[64];
<a name="l03559"></a>03559                                 <span class="keywordtype">int</span> tlim = <span class="keyword">sizeof</span>(temp)-16;
<a name="l03560"></a>03560                                 <span class="keywordtype">int</span> pos = snprintf(temp, <span class="keyword">sizeof</span>(temp),
<a name="l03561"></a>03561                                                    <span class="stringliteral">&quot;done (%d)&quot;</span>,
<a name="l03562"></a>03562                                                    count);
<a name="l03563"></a>03563                                 <span class="keywordflow">if</span> (deltas != NULL) {
<a name="l03564"></a>03564                                     pos += snprintf(temp+pos, tlim-pos,
<a name="l03565"></a>03565                                                     <span class="stringliteral">&quot;, deltas (%d)&quot;</span>,
<a name="l03566"></a>03566                                                     deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#a2b8fbeba7e9500e5a01ff045ebafbca4">deltasCount</a>);
<a name="l03567"></a>03567                                 }
<a name="l03568"></a>03568 
<a name="l03569"></a>03569                                 <span class="keywordflow">if</span> (remoteSeen != NULL)
<a name="l03570"></a>03570                                     pos += snprintf(temp+pos, tlim-pos, <span class="stringliteral">&quot;, seen&quot;</span>);
<a name="l03571"></a>03571 
<a name="l03572"></a>03572                                 <a class="code" href="_sync_actions_8c.html#a693571491e7f8b307640238175b6aa57">showCacheEntry2</a>(root, <span class="stringliteral">&quot;Sync.$Update&quot;</span>, temp,
<a name="l03573"></a>03573                                                 ud-&gt;ceStart, ud-&gt;ceStop);
<a name="l03574"></a>03574                             }
<a name="l03575"></a>03575                         }
<a name="l03576"></a>03576                         <span class="keywordflow">if</span> (deltas != NULL &amp;&amp; deltas-&gt;<a class="code" href="struct_sync_root_deltas.html#aa69ba4a9afeaa0fd81349eefdfcc9a82">whenSent</a> == 0
<a name="l03577"></a>03577                             &amp;&amp; remoteSeen != NULL) {
<a name="l03578"></a>03578                             <span class="comment">// if there is no remote hash matching the deltas stopping hash</span>
<a name="l03579"></a>03579                             <span class="comment">// but there is a request for the starting hash, then send</span>
<a name="l03580"></a>03580                             <span class="comment">// the updates now</span>
<a name="l03581"></a>03581                             <span class="comment">// TBD: is this a good enough test?</span>
<a name="l03582"></a>03582                             <a class="code" href="_sync_actions_8c.html#acc491ad38b38700ae0597ecc5422eca3">SendDeltasReply</a>(root, deltas);
<a name="l03583"></a>03583                             remoteSeen-&gt;<a class="code" href="struct_sync_hash_info_list.html#a80001233f5a192af604d2df927529f47">lastReplied</a> = now;
<a name="l03584"></a>03584                         } <span class="keywordflow">else</span>
<a name="l03585"></a>03585                             <span class="comment">// since we have a new root, we need a new RootAdvise</span>
<a name="l03586"></a>03586                             <a class="code" href="_sync_actions_8c.html#a883ea40ef1982edd049f48944662a933">SyncSendRootAdviseInterest</a>(root);
<a name="l03587"></a>03587                     } 
<a name="l03588"></a>03588                     <span class="keywordflow">if</span> (old != NULL) <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;old);
<a name="l03589"></a>03589                     free(hex);
<a name="l03590"></a>03590                 } <span class="keywordflow">else</span> {
<a name="l03591"></a>03591                     count = <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad node&quot;</span>, __LINE__);
<a name="l03592"></a>03592                 }
<a name="l03593"></a>03593             }
<a name="l03594"></a>03594             root-&gt;priv-&gt;adviseNeed = <a class="code" href="_sync_actions_8c.html#a96ca9c9a78727d3479674cdaa27b56f5">adviseNeedReset</a>;
<a name="l03595"></a>03595             <span class="keywordflow">if</span> (count &lt;= initCount) {
<a name="l03596"></a>03596                 <span class="comment">// we were supposed to add something?</span>
<a name="l03597"></a>03597                 <span class="keywordflow">if</span> (<a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l03598"></a>03598                     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *hash = root-&gt;currentHash;
<a name="l03599"></a>03599                     <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l03600"></a>03600                     <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base,
<a name="l03601"></a>03601                              <span class="stringliteral">&quot;%s, root#%u, note, count %d, initCount %d, hash %s&quot;</span>,
<a name="l03602"></a>03602                              here, root-&gt;rootId, count, initCount, hex);
<a name="l03603"></a>03603                     free(hex);
<a name="l03604"></a>03604                 }
<a name="l03605"></a>03605             }
<a name="l03606"></a>03606             root-&gt;update = <a class="code" href="_sync_actions_8c.html#a4d7ce920ea0013f6b6a2f67c43563da8">FreeUpdateData</a>(ud);
<a name="l03607"></a>03607             ev-&gt;<a class="code" href="structccn__scheduled__event.html#a4f4c36335e9001eaca5442f672798e95">evdata</a> = NULL;
<a name="l03608"></a>03608             <a class="code" href="_sync_actions_8c.html#a2355f67fe61fee13d8cdcb7ca131d911">kickHeartBeat</a>(root, 0);
<a name="l03609"></a>03609             <span class="keywordflow">return</span> -1;
<a name="l03610"></a>03610         }
<a name="l03611"></a>03611         <span class="keywordflow">default</span>: {
<a name="l03612"></a>03612             <span class="comment">// show that we are no longer updating</span>
<a name="l03613"></a>03613             <span class="keywordflow">return</span> -1;
<a name="l03614"></a>03614         }
<a name="l03615"></a>03615     }
<a name="l03616"></a>03616     int64_t edt = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(ud-&gt;entryTime, <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>());
<a name="l03617"></a>03617     <span class="keywordflow">if</span> (edt &gt; ud-&gt;maxHold) ud-&gt;maxHold = edt;
<a name="l03618"></a>03618     <span class="keywordflow">return</span> <a class="code" href="_sync_actions_8c.html#a259cad241b04e57ac063e149d3fb511e">shortDelayMicros</a>;
<a name="l03619"></a>03619 }
<a name="l03620"></a>03620 
<a name="l03621"></a>03621 <span class="comment">// SyncUpdateRoot initiates an update action for the given root,</span>
<a name="l03622"></a>03622 <span class="comment">// creating the SyncUpdateData and scheduling the initial phase</span>
<a name="l03623"></a>03623 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l03624"></a><a class="code" href="_sync_actions_8c.html#ac59cbfbac45ae18f43a1bed7d1c6a8ce">03624</a> <a class="code" href="_sync_actions_8c.html#ac59cbfbac45ae18f43a1bed7d1c6a8ce">SyncUpdateRoot</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root) {
<a name="l03625"></a>03625     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.UpdateAction&quot;</span>;
<a name="l03626"></a>03626     <span class="keyword">struct </span><a class="code" href="struct_sync_name_accum.html">SyncNameAccum</a> *acc = root-&gt;<a class="code" href="struct_sync_root_struct.html#a973c1488c9df1486c21fc37465c10def" title="names needing addition to root">namesToAdd</a>;
<a name="l03627"></a>03627     <span class="keywordflow">if</span> (acc-&gt;<a class="code" href="struct_sync_name_accum.html#a43e6bf3321957d08f4985443cc36555d">len</a> == 0) <span class="keywordflow">return</span> 0;
<a name="l03628"></a>03628     int64_t now = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l03629"></a>03629     <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>;
<a name="l03630"></a>03630     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *hash = root-&gt;<a class="code" href="struct_sync_root_struct.html#a013f6ae133c768d7bff2495445283bb4" title="current top-level cache hash">currentHash</a>;
<a name="l03631"></a>03631     <span class="keyword">struct </span>SyncUpdateData *ud = <a class="code" href="_sync_macros_8h.html#ab707d3cfcb52f2e2f819771123942548">NEW_STRUCT</a>(1, SyncUpdateData);
<a name="l03632"></a>03632     ud-&gt;root = root;
<a name="l03633"></a>03633     ud-&gt;state = <a class="code" href="_sync_actions_8c.html#aa6cc1c7877f35a7df1951c989f371e90aec69f28641f92a3fd6b9451380718992">SyncUpdate_init</a>;
<a name="l03634"></a>03634     ud-&gt;startTime = now;
<a name="l03635"></a>03635     ud-&gt;entryTime = now;
<a name="l03636"></a>03636     ud-&gt;ixBase = <a class="code" href="_index_sorter_8c.html#a156f5d5e3b95ba3647c34da129ee9f12">IndexSorter_New</a>(acc-&gt;<a class="code" href="struct_sync_name_accum.html#a43e6bf3321957d08f4985443cc36555d">len</a>, -1);
<a name="l03637"></a>03637     ud-&gt;ixBase-&gt;sorter = <a class="code" href="_sync_util_8c.html#ac6cc4568b5fb1d1e09882b746a42603f" title="default sorter callback for a name accum uses CCN standard name order">SyncNameAccumSorter</a>;
<a name="l03638"></a>03638     ud-&gt;ixBase-&gt;client = acc;
<a name="l03639"></a>03639     ud-&gt;ixPos = 0;
<a name="l03640"></a>03640     ud-&gt;initLen = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#ad184fb3f8d57f787b50f2c094d86eebc">currentSize</a>;
<a name="l03641"></a>03641     ud-&gt;ceStart = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#abe335cfe4efd3e95c6fd099835d4baf9">ceCurrent</a>;
<a name="l03642"></a>03642     <span class="keywordflow">if</span> (root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>-&gt;<a class="code" href="struct_sync_private.html#a7c88ee63ac4522d6bb14fc3803135164">deltasLimit</a> &gt; 0)
<a name="l03643"></a>03643         <span class="comment">// create and init the deltas object</span>
<a name="l03644"></a>03644         ud-&gt;deltas = <a class="code" href="_sync_actions_8c.html#a7443aed719df8ae6c7599e34711714b9">NewDeltas</a>(root);
<a name="l03645"></a>03645     <span class="keyword">struct </span><a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev = <a class="code" href="schedule_8h.html#a1b46f1ba6b54371f41a5c160cd1604ba">ccn_schedule_event</a>(base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>-&gt;<a class="code" href="structsync__plumbing.html#ab5e574093a95dfb432043980ce9a5e17">sched</a>,
<a name="l03646"></a>03646                                                         0,
<a name="l03647"></a>03647                                                         <a class="code" href="_sync_actions_8c.html#a1c708bcddeda324dbc2f5dc27376d251">UpdateAction</a>,
<a name="l03648"></a>03648                                                         ud,
<a name="l03649"></a>03649                                                         0);
<a name="l03650"></a>03650     <span class="keywordflow">if</span> (ev == NULL) {
<a name="l03651"></a>03651         <span class="keywordflow">if</span> (base-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a1aa8c032da69595d9b27357c2bb83da9" title="Severe errors.">CCNL_SEVERE</a>)
<a name="l03652"></a>03652             <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base, <span class="stringliteral">&quot;%s, initial schedule failed!&quot;</span>, here);
<a name="l03653"></a>03653         <a class="code" href="_sync_actions_8c.html#a4d7ce920ea0013f6b6a2f67c43563da8">FreeUpdateData</a>(ud);
<a name="l03654"></a>03654         <span class="keywordflow">return</span> -1;
<a name="l03655"></a>03655     }
<a name="l03656"></a>03656     root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#ab12485a114af6f5de646eb708d579ef0">lastUpdate</a> = now;
<a name="l03657"></a>03657     root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb992ba3fa12a25258ed93ae52b25eb5" title="data for doing sync tree updates">update</a> = ud;
<a name="l03658"></a>03658     root-&gt;<a class="code" href="struct_sync_root_struct.html#a973c1488c9df1486c21fc37465c10def" title="names needing addition to root">namesToAdd</a> = <a class="code" href="_sync_util_8c.html#adcdacf16d78ec4fff95eff5f0d63446b">SyncAllocNameAccum</a>(0);
<a name="l03659"></a>03659     <span class="keywordflow">if</span> (base-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l03660"></a>03660         <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l03661"></a>03661         <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base,
<a name="l03662"></a>03662                  <span class="stringliteral">&quot;%s, root#%u, start, toAdd %d, current %d, hash %s&quot;</span>,
<a name="l03663"></a>03663                  here, root-&gt;<a class="code" href="struct_sync_root_struct.html#a86cbcbdd2e2d8c30311da406d36c80e5" title="root Id for reporting">rootId</a>,
<a name="l03664"></a>03664                  (<span class="keywordtype">int</span>) acc-&gt;<a class="code" href="struct_sync_name_accum.html#a43e6bf3321957d08f4985443cc36555d">len</a>, (<span class="keywordtype">int</span>) ud-&gt;initLen, hex);
<a name="l03665"></a>03665         free(hex);
<a name="l03666"></a>03666     }
<a name="l03667"></a>03667     <span class="keywordflow">return</span> 1;
<a name="l03668"></a>03668 }
<a name="l03669"></a>03669 
<a name="l03670"></a>03670 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l03671"></a><a class="code" href="_sync_actions_8c.html#ac35071e0f9bf12dcd5d9b37f36463a79">03671</a> <a class="code" href="_sync_actions_8c.html#ac35071e0f9bf12dcd5d9b37f36463a79">SyncStartCompareAction</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root, <span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *hashR) {
<a name="l03672"></a>03672     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.SyncStartCompareAction&quot;</span>;
<a name="l03673"></a>03673     <span class="keyword">struct </span><a class="code" href="struct_sync_private.html">SyncPrivate</a> *priv = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>;
<a name="l03674"></a>03674     <span class="keywordflow">if</span> (root-&gt;<a class="code" href="struct_sync_root_struct.html#afc1f6cd0fc635888971bee16931d4aa6" title="data for doing sync tree comparison">compare</a> != NULL || root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb992ba3fa12a25258ed93ae52b25eb5" title="data for doing sync tree updates">update</a> != NULL
<a name="l03675"></a>03675         || priv-&gt;<a class="code" href="struct_sync_private.html#af2979f2e620ae3bcfdf2d18dd14f31c0">comparesBusy</a> &gt;= priv-&gt;<a class="code" href="struct_sync_private.html#abd53831e7d50282feaf1e46767265178">maxComparesBusy</a>)
<a name="l03676"></a>03676         <span class="comment">// not OK to start another compare</span>
<a name="l03677"></a>03677         <span class="keywordflow">return</span> 0;
<a name="l03678"></a>03678     
<a name="l03679"></a>03679     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *hashL = root-&gt;<a class="code" href="struct_sync_root_struct.html#a013f6ae133c768d7bff2495445283bb4" title="current top-level cache hash">currentHash</a>;
<a name="l03680"></a>03680     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceL = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#abe335cfe4efd3e95c6fd099835d4baf9">ceCurrent</a>;
<a name="l03681"></a>03681     <span class="keyword">struct </span><a class="code" href="struct_sync_name_accum.html">SyncNameAccum</a> *remoteDeltas = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#aaf1e25bbca5a71684b2deefce4f2082f">remoteDeltas</a>;
<a name="l03682"></a>03682     <span class="keywordflow">if</span> (remoteDeltas == NULL &amp;&amp; hashR == NULL)
<a name="l03683"></a>03683         <span class="comment">// no point in trying, no data to work on</span>
<a name="l03684"></a>03684         <span class="keywordflow">return</span> 0;
<a name="l03685"></a>03685     
<a name="l03686"></a>03686     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceR = NULL;
<a name="l03687"></a>03687     <span class="keywordflow">if</span> (hashR != NULL) {
<a name="l03688"></a>03688         ceR = <a class="code" href="_sync_hash_cache_8c.html#abcf5e784c52d971d943bddef80731954" title="based on the raw hash, ensure that a remote cache entry exists ent-&amp;gt;state |= set...">SyncHashEnter</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>,
<a name="l03689"></a>03689                             hashR-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>,
<a name="l03690"></a>03690                             hashR-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>,
<a name="l03691"></a>03691                             <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381aec73ed0d374163f11f2d715ce0a3c197" title="a remote hash has been seen">SyncHashState_remote</a>);
<a name="l03692"></a>03692         <span class="keywordflow">if</span> (ceR == NULL)
<a name="l03693"></a>03693             <span class="keywordflow">return</span> <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad lookup for R&quot;</span>, __LINE__);
<a name="l03694"></a>03694     }
<a name="l03695"></a>03695     
<a name="l03696"></a>03696     <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>;
<a name="l03697"></a>03697     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = base-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l03698"></a>03698     <span class="keyword">struct </span>SyncCompareData *data = <a class="code" href="_sync_macros_8h.html#ab707d3cfcb52f2e2f819771123942548">NEW_STRUCT</a>(1, SyncCompareData);
<a name="l03699"></a>03699     int64_t mark = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l03700"></a>03700     data-&gt;startTime = mark;
<a name="l03701"></a>03701     data-&gt;lastEnter = mark;
<a name="l03702"></a>03702     data-&gt;lastMark = mark;
<a name="l03703"></a>03703     data-&gt;lastFetchOK = mark;
<a name="l03704"></a>03704     data-&gt;root = root;
<a name="l03705"></a>03705     root-&gt;<a class="code" href="struct_sync_root_struct.html#afc1f6cd0fc635888971bee16931d4aa6" title="data for doing sync tree comparison">compare</a> = data;
<a name="l03706"></a>03706     root-&gt;<a class="code" href="struct_sync_root_struct.html#ac28d004acf78c3ef247937c0b10d8b7c" title="names needing contents fetch">namesToFetch</a> = <a class="code" href="_sync_util_8c.html#a6c2c47daae1a00b2fd20577c8bd7eef0" title="frees the name accum and all of the names">SyncFreeNameAccumAndNames</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#ac28d004acf78c3ef247937c0b10d8b7c" title="names needing contents fetch">namesToFetch</a>);
<a name="l03707"></a>03707     data-&gt;twL = <a class="code" href="_sync_tree_worker_8c.html#ab50ea183a52285c94049d758fa2cb966" title="create a new tree worker, based on the given cache ent != NULL: initialize from the...">SyncTreeWorkerCreate</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>, ceL);
<a name="l03708"></a>03708     <span class="keywordflow">if</span> (ceL != NULL) ceL-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a6861960908cc217b639d3f1af6bbc520" title="time when entry last used in compare">lastUsed</a> = mark;
<a name="l03709"></a>03709     data-&gt;twR = <a class="code" href="_sync_tree_worker_8c.html#ab50ea183a52285c94049d758fa2cb966" title="create a new tree worker, based on the given cache ent != NULL: initialize from the...">SyncTreeWorkerCreate</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>, ceR);
<a name="l03710"></a>03710     <span class="keywordflow">if</span> (ceR != NULL) ceR-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a6861960908cc217b639d3f1af6bbc520" title="time when entry last used in compare">lastUsed</a> = mark;
<a name="l03711"></a>03711     data-&gt;hashL = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l03712"></a>03712     <a class="code" href="charbuf_8h.html#aca88638b2e81602eb4a1da9be923dad7">ccn_charbuf_append_charbuf</a>(data-&gt;hashL, hashL);
<a name="l03713"></a>03713     <span class="keywordflow">if</span> (remoteDeltas == NULL) {
<a name="l03714"></a>03714         <span class="comment">// no deltas, so must work from hashR</span>
<a name="l03715"></a>03715         data-&gt;state = <a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767aea4e7487ab4ca7505378434b0cc96e77">SyncCompare_init</a>;
<a name="l03716"></a>03716         data-&gt;hashR = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l03717"></a>03717         <a class="code" href="charbuf_8h.html#aca88638b2e81602eb4a1da9be923dad7">ccn_charbuf_append_charbuf</a>(data-&gt;hashR, hashR);
<a name="l03718"></a>03718     } <span class="keywordflow">else</span> {
<a name="l03719"></a>03719         <span class="comment">// deltas trump hashR</span>
<a name="l03720"></a>03720         root-&gt;<a class="code" href="struct_sync_root_struct.html#ac28d004acf78c3ef247937c0b10d8b7c" title="names needing contents fetch">namesToFetch</a> = remoteDeltas;
<a name="l03721"></a>03721         root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#aaf1e25bbca5a71684b2deefce4f2082f">remoteDeltas</a> = NULL;
<a name="l03722"></a>03722         data-&gt;state = <a class="code" href="_sync_actions_8c.html#a4ace3b798258679d3968cef234853767a0af8ae16c6d77b372a710583dd92aa50">SyncCompare_waiting</a>;
<a name="l03723"></a>03723     }
<a name="l03724"></a>03724     
<a name="l03725"></a>03725     data-&gt;cbL = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l03726"></a>03726     data-&gt;cbR = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l03727"></a>03727     
<a name="l03728"></a>03728     priv-&gt;<a class="code" href="struct_sync_private.html#af2979f2e620ae3bcfdf2d18dd14f31c0">comparesBusy</a>++;
<a name="l03729"></a>03729     
<a name="l03730"></a>03730     <a class="code" href="_sync_actions_8c.html#ad2d955864020d9986169c8574244c472">kickCompare</a>(data, NULL);
<a name="l03731"></a>03731     
<a name="l03732"></a>03732     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l03733"></a>03733         <span class="keywordtype">char</span> *hexL = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hashL-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hashL-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l03734"></a>03734         <span class="keywordtype">char</span> *msgL = ((hashL-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> &gt; 0) ? hexL : <span class="stringliteral">&quot;empty&quot;</span>);
<a name="l03735"></a>03735         <span class="keywordflow">if</span> (hashR != NULL &amp;&amp; hashR-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> &gt; 0) {
<a name="l03736"></a>03736             <span class="keywordtype">char</span> *hexR = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hashR-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hashR-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l03737"></a>03737             <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base, <span class="stringliteral">&quot;%s, root#%u, L %s, R %s&quot;</span>,
<a name="l03738"></a>03738                      here, root-&gt;<a class="code" href="struct_sync_root_struct.html#a86cbcbdd2e2d8c30311da406d36c80e5" title="root Id for reporting">rootId</a>, msgL, hexR);
<a name="l03739"></a>03739             free(hexR);
<a name="l03740"></a>03740         } <span class="keywordflow">else</span> {
<a name="l03741"></a>03741             <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base, <span class="stringliteral">&quot;%s, root#%u, L %s, R empty&quot;</span>,
<a name="l03742"></a>03742                      here, root-&gt;<a class="code" href="struct_sync_root_struct.html#a86cbcbdd2e2d8c30311da406d36c80e5" title="root Id for reporting">rootId</a>, msgL);
<a name="l03743"></a>03743         }
<a name="l03744"></a>03744         free(hexL);
<a name="l03745"></a>03745     }
<a name="l03746"></a>03746     
<a name="l03747"></a>03747     <span class="keywordflow">return</span> 1;
<a name="l03748"></a>03748 }
<a name="l03749"></a>03749 <span class="comment"></span>
<a name="l03750"></a>03750 <span class="comment">///////////////////////////////////////////////////////////////////////////</span>
<a name="l03751"></a>03751 <span class="comment"></span><span class="comment">// Support for constructing a new Base</span><span class="comment"></span>
<a name="l03752"></a>03752 <span class="comment">///////////////////////////////////////////////////////////////////////////</span>
<a name="l03753"></a>03753 <span class="comment"></span>
<a name="l03754"></a>03754 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l03755"></a><a class="code" href="_sync_actions_8c.html#a3b120c72e4513035e580dc4806b978a4">03755</a> <a class="code" href="_sync_actions_8c.html#a3b120c72e4513035e580dc4806b978a4">sync_start_for_actions</a>(<span class="keyword">struct</span> <a class="code" href="structsync__plumbing.html">sync_plumbing</a> *sd,
<a name="l03756"></a>03756                    <span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *state_buf) {
<a name="l03757"></a>03757     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.sync_start_for_actions&quot;</span>;
<a name="l03758"></a>03758     <span class="keywordflow">if</span> (sd == NULL) <span class="keywordflow">return</span> -1;
<a name="l03759"></a>03759     <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = (<span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *) sd-&gt;<a class="code" href="structsync__plumbing.html#a66410bcee4a37eef69673f10715ae13b">sync_data</a>;
<a name="l03760"></a>03760     if (base == NULL || base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a> != sd) <span class="keywordflow">return</span> -1;
<a name="l03761"></a>03761     
<a name="l03762"></a>03762     <span class="keyword">struct </span><a class="code" href="struct_sync_private.html">SyncPrivate</a> *priv = base-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>;
<a name="l03763"></a>03763     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = base-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l03764"></a>03764     
<a name="l03765"></a>03765     <span class="keywordtype">int</span> res = priv-&gt;<a class="code" href="struct_sync_private.html#a47e1558d643d98f7ce7996597ef29d47">saveMethods</a>-&gt;<a class="code" href="struct_sync_methods_list.html#a9f5ee7e17ece1c352f600c6400f35023">sync_methods</a>-&gt;<a class="code" href="structsync__plumbing__sync__methods.html#af37a73b9483bb048a03e8ecdaa845444">sync_start</a>(sd, state_buf);
<a name="l03766"></a>03766     <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l03767"></a>03767         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#af91ddb985e8b28b1f1d0c74c7b6385c9" title="Configuration errors.">CCNL_ERROR</a>)
<a name="l03768"></a>03768             <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base, <span class="stringliteral">&quot;%s, failed for the underlying sync_start&quot;</span>, here);
<a name="l03769"></a>03769         <span class="keywordflow">return</span> res;
<a name="l03770"></a>03770     }
<a name="l03771"></a>03771     <a class="code" href="_sync_actions_8c.html#aff1ca26129e6d6b02bf799de59a26bd8">SyncStartHeartbeat</a>(base);
<a name="l03772"></a>03772     <span class="keywordflow">return</span> 0;
<a name="l03773"></a>03773 }
<a name="l03774"></a>03774 
<a name="l03775"></a>03775 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l03776"></a><a class="code" href="_sync_actions_8c.html#aaa527a707f3931bed9f230663684def1">03776</a> <a class="code" href="_sync_actions_8c.html#aaa527a707f3931bed9f230663684def1">sync_notify_for_actions</a>(<span class="keyword">struct</span> <a class="code" href="structsync__plumbing.html">sync_plumbing</a> *sd,
<a name="l03777"></a>03777                     <span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name,
<a name="l03778"></a>03778                     <span class="keywordtype">int</span> enum_index,
<a name="l03779"></a>03779                     uint64_t seq_num) {
<a name="l03780"></a>03780     <span class="comment">// here for any updates, whether from time-based enumeration</span>
<a name="l03781"></a>03781     <span class="comment">// or from prefix-based enumeration</span>
<a name="l03782"></a>03782     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.sync_notify_for_actions&quot;</span>;
<a name="l03783"></a>03783     <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base;
<a name="l03784"></a>03784     <span class="keyword">struct </span><a class="code" href="struct_sync_private.html">SyncPrivate</a> *priv;
<a name="l03785"></a>03785     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a>;
<a name="l03786"></a>03786     
<a name="l03787"></a>03787     <span class="keywordflow">if</span> (sd == NULL) <span class="keywordflow">return</span> -1;
<a name="l03788"></a>03788     base = (<span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *) sd-&gt;<a class="code" href="structsync__plumbing.html#a66410bcee4a37eef69673f10715ae13b">sync_data</a>;
<a name="l03789"></a>03789     if (base == NULL || base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a> != sd)
<a name="l03790"></a>03790         <span class="keywordflow">return</span> (-1);
<a name="l03791"></a>03791     
<a name="l03792"></a>03792     priv = base-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>;
<a name="l03793"></a>03793     debug = base-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l03794"></a>03794     
<a name="l03795"></a>03795     <span class="keywordflow">if</span> (name == NULL) {
<a name="l03796"></a>03796         <span class="comment">// end of an enumeration</span>
<a name="l03797"></a>03797         <span class="keywordflow">if</span> (enum_index == 0) {
<a name="l03798"></a>03798             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a2813bb28b1559ff71ca56e66d8df63a6" title="Something might be wrong.">CCNL_WARNING</a>)
<a name="l03799"></a>03799                 <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base, <span class="stringliteral">&quot;%s, end of time-based enum?&quot;</span>, here);
<a name="l03800"></a>03800         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (enum_index == priv-&gt;<a class="code" href="struct_sync_private.html#a6ce7fb490cd43b077407aa78fc307c04">sliceEnum</a>) {
<a name="l03801"></a>03801             priv-&gt;<a class="code" href="struct_sync_private.html#a6ce7fb490cd43b077407aa78fc307c04">sliceEnum</a> = 0;
<a name="l03802"></a>03802             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>)
<a name="l03803"></a>03803                 <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base, <span class="stringliteral">&quot;%s, all slice names seen&quot;</span>, here);
<a name="l03804"></a>03804             <span class="keywordflow">return</span>(0);
<a name="l03805"></a>03805         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (enum_index == priv-&gt;<a class="code" href="struct_sync_private.html#a58f4a8cec789303dba45ae3cc09ffb5e">sliceBusy</a>) {
<a name="l03806"></a>03806             priv-&gt;<a class="code" href="struct_sync_private.html#a58f4a8cec789303dba45ae3cc09ffb5e">sliceBusy</a> = 0;
<a name="l03807"></a>03807             <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = priv-&gt;<a class="code" href="struct_sync_private.html#ab73c3970c30ef4b6d3bcf11eac0b5cef">rootHead</a>;
<a name="l03808"></a>03808             <span class="keywordflow">while</span> (root != NULL) {
<a name="l03809"></a>03809                 <span class="keyword">struct </span><a class="code" href="struct_sync_root_private.html">SyncRootPrivate</a> *rp = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>;
<a name="l03810"></a>03810                 <span class="keywordflow">if</span> (enum_index == rp-&gt;<a class="code" href="struct_sync_root_private.html#a312e33d7f5b862de736711a14f7210f8">sliceBusy</a>) {
<a name="l03811"></a>03811                     rp-&gt;<a class="code" href="struct_sync_root_private.html#a312e33d7f5b862de736711a14f7210f8">sliceBusy</a> = 0;
<a name="l03812"></a>03812                     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>)
<a name="l03813"></a>03813                         <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;slice enum done&quot;</span>);
<a name="l03814"></a>03814                     <span class="keywordflow">break</span>;
<a name="l03815"></a>03815                 }
<a name="l03816"></a>03816                 root = root-&gt;<a class="code" href="struct_sync_root_struct.html#acd0d587d8fdf825a7145f5f26c86cac2" title="next root in our list">next</a>;
<a name="l03817"></a>03817             }
<a name="l03818"></a>03818             <span class="comment">// may need a new enumeration started</span>
<a name="l03819"></a>03819             root = priv-&gt;<a class="code" href="struct_sync_private.html#ab73c3970c30ef4b6d3bcf11eac0b5cef">rootHead</a>;
<a name="l03820"></a>03820             <span class="keywordflow">while</span> (root != NULL) {
<a name="l03821"></a>03821                 <span class="keyword">struct </span><a class="code" href="struct_sync_root_private.html">SyncRootPrivate</a> *rp = root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>;
<a name="l03822"></a>03822                 <span class="keywordflow">if</span> (rp-&gt;<a class="code" href="struct_sync_root_private.html#a312e33d7f5b862de736711a14f7210f8">sliceBusy</a> &lt; 0) {
<a name="l03823"></a>03823                     <a class="code" href="_sync_actions_8c.html#a044828070bf2362a52a7f12bd7517537">SyncStartSliceEnum</a>(root);
<a name="l03824"></a>03824                     <span class="keywordflow">break</span>;
<a name="l03825"></a>03825                 }
<a name="l03826"></a>03826                 root = root-&gt;<a class="code" href="struct_sync_root_struct.html#acd0d587d8fdf825a7145f5f26c86cac2" title="next root in our list">next</a>;
<a name="l03827"></a>03827             }
<a name="l03828"></a>03828             <span class="keywordflow">return</span>(0);
<a name="l03829"></a>03829         } <span class="keywordflow">else</span> {
<a name="l03830"></a>03830             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a2813bb28b1559ff71ca56e66d8df63a6" title="Something might be wrong.">CCNL_WARNING</a>)
<a name="l03831"></a>03831                 <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base, <span class="stringliteral">&quot;%s, end of what enum?&quot;</span>, here);
<a name="l03832"></a>03832         }
<a name="l03833"></a>03833         <span class="keywordflow">return</span> -1;
<a name="l03834"></a>03834     }
<a name="l03835"></a>03835     
<a name="l03836"></a>03836     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l03837"></a>03837         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *uri = <a class="code" href="_sync_util_8c.html#adc7df34c5bbfec9243b0402b6ebbe093" title="Convenience routine to make a uri for a name.">SyncUriForName</a>(name);
<a name="l03838"></a>03838         <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base,
<a name="l03839"></a>03839                  <span class="stringliteral">&quot;%s, enum %d, %s!&quot;</span>,
<a name="l03840"></a>03840                  here, enum_index, <a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(uri));
<a name="l03841"></a>03841         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;uri);
<a name="l03842"></a>03842     }
<a name="l03843"></a>03843     
<a name="l03844"></a>03844     <span class="keywordflow">if</span> (<a class="code" href="_sync_util_8c.html#a4ccb250b1c02f44a29dfb8bbecd77c38">SyncPrefixMatch</a>(priv-&gt;<a class="code" href="struct_sync_private.html#a1a6a455f37786351f559a2d717339a28">localHostPrefix</a>, name, 0)) {
<a name="l03845"></a>03845         <span class="comment">// to the local host, don&#39;t update the stable target</span>
<a name="l03846"></a>03846         <span class="keywordflow">if</span> (<a class="code" href="_sync_util_8c.html#a4ccb250b1c02f44a29dfb8bbecd77c38">SyncPrefixMatch</a>(priv-&gt;<a class="code" href="struct_sync_private.html#abb613517c031d15f2a065c28fb0738a0">sliceCmdPrefix</a>, name, 0))
<a name="l03847"></a>03847             <span class="comment">// this is a new slice</span>
<a name="l03848"></a>03848             <a class="code" href="_sync_actions_8c.html#ad570ed53bd25c0b07f250c835150e969">SyncHandleSlice</a>(base, name);
<a name="l03849"></a>03849     }
<a name="l03850"></a>03850     <a class="code" href="_sync_util_8c.html#afe14c6afc4e09022082c1241ba6ab66c" title="Adds the given name to any applicable roots.">SyncAddName</a>(base, name, seq_num);
<a name="l03851"></a>03851     <span class="keywordflow">return</span> 0;
<a name="l03852"></a>03852 }
<a name="l03853"></a>03853 
<a name="l03854"></a>03854 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l03855"></a><a class="code" href="_sync_actions_8c.html#a6919e770f7d03e314b83c9442a52799d">03855</a> <a class="code" href="_sync_actions_8c.html#a6919e770f7d03e314b83c9442a52799d">sync_stop_for_actions</a>(<span class="keyword">struct</span> <a class="code" href="structsync__plumbing.html">sync_plumbing</a> *sd,
<a name="l03856"></a>03856                       <span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *state_buf) {
<a name="l03857"></a>03857     <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = sd-&gt;<a class="code" href="structsync__plumbing.html#a66410bcee4a37eef69673f10715ae13b">sync_data</a>;
<a name="l03858"></a>03858     <span class="keywordflow">if</span> (base != NULL &amp;&amp; base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a> == sd) {
<a name="l03859"></a>03859         <span class="comment">// TBD: shut down the heartbeat before using the underlying method</span>
<a name="l03860"></a>03860         base-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>-&gt;<a class="code" href="struct_sync_private.html#a47e1558d643d98f7ce7996597ef29d47">saveMethods</a>-&gt;<a class="code" href="struct_sync_methods_list.html#a9f5ee7e17ece1c352f600c6400f35023">sync_methods</a>-&gt;<a class="code" href="structsync__plumbing__sync__methods.html#a5882116137005f1256b11e97ad2b88bf">sync_stop</a>(sd, state_buf);
<a name="l03861"></a>03861     }
<a name="l03862"></a>03862 }
<a name="l03863"></a>03863 
<a name="l03864"></a><a class="code" href="_sync_actions_8c.html#aaa31d7896458f7d61e69518775671148">03864</a> <span class="keyword">struct </span><a class="code" href="structsync__plumbing__sync__methods.html">sync_plumbing_sync_methods</a> <a class="code" href="_sync_actions_8c.html#aaa31d7896458f7d61e69518775671148">syncActionMethods</a> = {
<a name="l03865"></a>03865     &amp;<a class="code" href="_sync_actions_8c.html#a3b120c72e4513035e580dc4806b978a4">sync_start_for_actions</a>,
<a name="l03866"></a>03866     &amp;<a class="code" href="_sync_actions_8c.html#aaa527a707f3931bed9f230663684def1">sync_notify_for_actions</a>,
<a name="l03867"></a>03867     &amp;<a class="code" href="_sync_actions_8c.html#a6919e770f7d03e314b83c9442a52799d">sync_stop_for_actions</a>
<a name="l03868"></a>03868 };
<a name="l03869"></a>03869 
<a name="l03870"></a>03870 <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *
<a name="l03871"></a><a class="code" href="_sync_actions_8h.html#a0b83326cd44f34e25acb51a2c0011daf">03871</a> <a class="code" href="_sync_actions_8c.html#a0b83326cd44f34e25acb51a2c0011daf" title="construct a new base with methods at the SyncActions level">SyncNewBaseForActions</a>(<span class="keyword">struct</span> <a class="code" href="structsync__plumbing.html">sync_plumbing</a> *sd) {
<a name="l03872"></a>03872     <span class="comment">// most of the construction happens using the default</span>
<a name="l03873"></a>03873     <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = <a class="code" href="_sync_base_8c.html#a60dacbb75fe89752bfeafec9e7d5848c">SyncNewBase</a>(sd);
<a name="l03874"></a>03874     <span class="keyword">struct </span><a class="code" href="struct_sync_private.html">SyncPrivate</a> *bp = base-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>;
<a name="l03875"></a>03875     <span class="keyword">struct </span><a class="code" href="struct_sync_methods_list.html">SyncMethodsList</a> *saveMethods = <a class="code" href="_sync_macros_8h.html#ab707d3cfcb52f2e2f819771123942548">NEW_STRUCT</a>(1, <a class="code" href="struct_sync_methods_list.html">SyncMethodsList</a>);
<a name="l03876"></a>03876     saveMethods-&gt;<a class="code" href="struct_sync_methods_list.html#a9f5ee7e17ece1c352f600c6400f35023">sync_methods</a> = sd-&gt;<a class="code" href="structsync__plumbing.html#a8f068520439474b1ac2461afb96641aa">sync_methods</a>;
<a name="l03877"></a>03877     sd-&gt;<a class="code" href="structsync__plumbing.html#a8f068520439474b1ac2461afb96641aa">sync_methods</a> = &amp;syncActionMethods;
<a name="l03878"></a>03878     saveMethods-&gt;<a class="code" href="struct_sync_methods_list.html#a45c1359579a16ed9632013fae576a741">next</a> = bp-&gt;<a class="code" href="struct_sync_private.html#a47e1558d643d98f7ce7996597ef29d47">saveMethods</a>;
<a name="l03879"></a>03879     bp-&gt;<a class="code" href="struct_sync_private.html#a47e1558d643d98f7ce7996597ef29d47">saveMethods</a> = saveMethods;
<a name="l03880"></a>03880     <span class="keywordflow">return</span> base;
<a name="l03881"></a>03881 }
<a name="l03882"></a>03882 
<a name="l03883"></a>03883 
<a name="l03884"></a>03884 <span class="preprocessor">#undef M</span>
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Mon Feb 4 11:56:48 2013 for Content-Centric Networking in C by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
