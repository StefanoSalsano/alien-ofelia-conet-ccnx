<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Content-Centric Networking in C: sync/sync_diff.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_a2ce97d05a9d430b2851eef455e009f7.html">sync</a>
  </div>
</div>
<div class="contents">
<h1>sync_diff.c</h1><a href="sync__diff_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/**</span>
<a name="l00002"></a>00002 <span class="comment"> * @file csrc/sync_diff.c</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Part of CCNx Sync.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Copyright (C) 2012 Palo Alto Research Center, Inc.</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * This library is free software; you can redistribute it and/or modify it</span>
<a name="l00009"></a>00009 <span class="comment"> * under the terms of the GNU Lesser General Public License version 2.1</span>
<a name="l00010"></a>00010 <span class="comment"> * as published by the Free Software Foundation.</span>
<a name="l00011"></a>00011 <span class="comment"> * This library is distributed in the hope that it will be useful,</span>
<a name="l00012"></a>00012 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00013"></a>00013 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU</span>
<a name="l00014"></a>00014 <span class="comment"> * Lesser General Public License for more details. You should have received</span>
<a name="l00015"></a>00015 <span class="comment"> * a copy of the GNU Lesser General Public License along with this library;</span>
<a name="l00016"></a>00016 <span class="comment"> * if not, write to the Free Software Foundation, Inc., 51 Franklin Street,</span>
<a name="l00017"></a>00017 <span class="comment"> * Fifth Floor, Boston, MA 02110-1301 USA.</span>
<a name="l00018"></a>00018 <span class="comment"> */</span>
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;<a class="code" href="ccn_8h.html" title="This is the low-level interface for CCNx clients.">ccn/ccn.h</a>&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;<a class="code" href="coding_8h.html" title="Details of the ccn binary wire encoding.">ccn/coding.h</a>&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;<a class="code" href="digest_8h.html" title="Message digest interface.">ccn/digest.h</a>&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;<a class="code" href="schedule_8h.html" title="Event scheduling.">ccn/schedule.h</a>&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;<a class="code" href="sync_8h.html">ccn/sync.h</a>&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;<a class="code" href="uri_8h.html" title="ccn-scheme uri conversions.">ccn/uri.h</a>&gt;</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="_index_sorter_8h.html">IndexSorter.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="_sync_node_8h.html" title="Part of CCNx Sync.">SyncNode.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="_sync_private_8h.html" title="Part of CCNx Sync.">SyncPrivate.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="_sync_tree_worker_8h.html" title="Part of CCNx Sync.">SyncTreeWorker.h</a>&quot;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="sync__plumbing_8h.html">sync_plumbing.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="sync__diff_8h.html">sync_diff.h</a>&quot;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a><a class="code" href="sync__diff_8c.html#ad6e384ed8d6687203b96177c4425df08">00039</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="sync__diff_8c.html#ad6e384ed8d6687203b96177c4425df08">nodeSplitTrigger</a> = 4000;     <span class="comment">// in bytes, triggers node split</span>
<a name="l00040"></a><a class="code" href="sync__diff_8c.html#a81327fc9c584dac59986ec3725d2cd77">00040</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="sync__diff_8c.html#a81327fc9c584dac59986ec3725d2cd77">hashSplitTrigger</a> = 17;       <span class="comment">// trigger for splitting based on hash (n/255)</span>
<a name="l00041"></a><a class="code" href="sync__diff_8c.html#a259cad241b04e57ac063e149d3fb511e">00041</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="sync__diff_8c.html#a259cad241b04e57ac063e149d3fb511e">shortDelayMicros</a> = 1000;     <span class="comment">// short delay for quick reschedule</span>
<a name="l00042"></a><a class="code" href="sync__diff_8c.html#ad6ea5755329f76c1602ad6ba25a27daf">00042</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="sync__diff_8c.html#ad6ea5755329f76c1602ad6ba25a27daf">namesYieldInc</a> = 100;         <span class="comment">// number of names to inc between yield tests</span>
<a name="l00043"></a><a class="code" href="sync__diff_8c.html#a01f91d5802d6020d15662f4afea91e9f">00043</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="sync__diff_8c.html#a01f91d5802d6020d15662f4afea91e9f">namesYieldMicros</a> = 20*1000;  <span class="comment">// number of micros to use as yield trigger</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00046"></a><a class="code" href="sync__diff_8c.html#a8d981d346c90e43d3f8d9e52077e28ca">00046</a> <a class="code" href="sync__diff_8c.html#a8d981d346c90e43d3f8d9e52077e28ca">setCovered</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce) {
<a name="l00047"></a>00047     <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381ae306c2dc55f40bf7e12c45acaf8d7a26" title="remote hash known covered by the local root">SyncHashState_covered</a>) {
<a name="l00048"></a>00048         <span class="comment">// nothing to do, already covered</span>
<a name="l00049"></a>00049     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381aec73ed0d374163f11f2d715ce0a3c197" title="a remote hash has been seen">SyncHashState_remote</a>) {
<a name="l00050"></a>00050         <span class="comment">// only set this bit if a remote hash has been entered</span>
<a name="l00051"></a>00051         ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> |= <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381ae306c2dc55f40bf7e12c45acaf8d7a26" title="remote hash known covered by the local root">SyncHashState_covered</a>;
<a name="l00052"></a>00052     }
<a name="l00053"></a>00053 }
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00056"></a><a class="code" href="sync__diff_8c.html#a870761b1ea0620fc7bf78e6a7c4a8fb3">00056</a> <a class="code" href="sync__diff_8c.html#a870761b1ea0620fc7bf78e6a7c4a8fb3">isCovered</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce) {
<a name="l00057"></a>00057     <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381ae306c2dc55f40bf7e12c45acaf8d7a26" title="remote hash known covered by the local root">SyncHashState_covered</a>) <span class="keywordflow">return</span> 1;
<a name="l00058"></a>00058     <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a9e849b0fed91e850763db20a54956128" title="a local node exists">SyncHashState_local</a>) {
<a name="l00059"></a>00059         <a class="code" href="sync__diff_8c.html#a8d981d346c90e43d3f8d9e52077e28ca">setCovered</a>(ce);
<a name="l00060"></a>00060         <span class="keywordflow">return</span> 1;
<a name="l00061"></a>00061     }
<a name="l00062"></a>00062     <span class="keywordflow">return</span> 0;
<a name="l00063"></a>00063 }
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structsync__diff__fetch__data.html">sync_diff_fetch_data</a> *
<a name="l00066"></a><a class="code" href="sync__diff_8c.html#a49a64c3583c2f1ac3c4967c337e130a0">00066</a> <a class="code" href="sync__diff_8c.html#a49a64c3583c2f1ac3c4967c337e130a0">allocNodeFetch</a>(<span class="keyword">struct</span> <a class="code" href="structsync__diff__data.html">sync_diff_data</a> *sdd, <span class="keyword">struct</span> <a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce) {
<a name="l00067"></a>00067     <span class="keyword">struct </span><a class="code" href="structsync__diff__fetch__data.html">sync_diff_fetch_data</a> *fd = calloc(1, <span class="keyword">sizeof</span>(*fd));
<a name="l00068"></a>00068     fd-&gt;<a class="code" href="structsync__diff__fetch__data.html#a7b67bfcaa0fd8456ce3061393eb74722">diff_data</a> = sdd;
<a name="l00069"></a>00069     fd-&gt;<a class="code" href="structsync__diff__fetch__data.html#a8dbd1b4a1d501f88e83a7f0869abaee8">hash_cache_entry</a> = ce;
<a name="l00070"></a>00070     <span class="keywordflow">return</span> fd;
<a name="l00071"></a>00071 }
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 <span class="comment">// addNodeFetch adds the tracking info for a fetch of a cache entry</span>
<a name="l00074"></a>00074 <span class="comment">// the client must ensure that the fetch is in progress</span>
<a name="l00075"></a>00075 <span class="comment">// duplicate fetches are detected, however (and ignored)</span>
<a name="l00076"></a>00076 <span class="comment">// returns NULL if duplicate, otherwise returns the tracking sync_diff_fetch_data</span>
<a name="l00077"></a>00077 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structsync__diff__fetch__data.html">sync_diff_fetch_data</a> *
<a name="l00078"></a><a class="code" href="sync__diff_8c.html#af2471003bfb1cc750027d448b2abe58b">00078</a> <a class="code" href="sync__diff_8c.html#af2471003bfb1cc750027d448b2abe58b">addNodeFetch</a>(<span class="keyword">struct</span> <a class="code" href="structsync__diff__data.html">sync_diff_data</a> *sdd,
<a name="l00079"></a>00079              <span class="keyword">struct</span> <a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce,
<a name="l00080"></a>00080              <span class="keyword">enum</span> <a class="code" href="sync__diff_8h.html#a6e15e35d7afe80f23fa4bda464bc86bf">sync_diff_side</a> <a class="code" href="structsync__diff__fetch__data.html#ac8126dbb54d8ac5db5fd3fcf3e44424f">side</a>) {
<a name="l00081"></a>00081     <span class="keyword">struct </span><a class="code" href="structsync__diff__fetch__data.html">sync_diff_fetch_data</a> *fd = sdd-&gt;<a class="code" href="structsync__diff__data.html#a106732432ae0dc955f522dab508edc01" title="cache entries being fetched">fetchQ</a>;
<a name="l00082"></a>00082     <span class="keyword">struct </span><a class="code" href="structsync__diff__fetch__data.html">sync_diff_fetch_data</a> *lag = NULL;
<a name="l00083"></a>00083     <span class="comment">// check for the entry already being present</span>
<a name="l00084"></a>00084     <span class="keywordflow">while</span> (fd != NULL) {
<a name="l00085"></a>00085         <span class="keyword">struct </span><a class="code" href="structsync__diff__fetch__data.html">sync_diff_fetch_data</a> *<a class="code" href="structsync__diff__fetch__data.html#a0996ee8ab9ca24a1b80bba72b9faf50f">next</a> = fd-&gt;<a class="code" href="structsync__diff__fetch__data.html#a0996ee8ab9ca24a1b80bba72b9faf50f">next</a>;
<a name="l00086"></a>00086         <span class="keywordflow">if</span> (ce == fd-&gt;<a class="code" href="structsync__diff__fetch__data.html#a8dbd1b4a1d501f88e83a7f0869abaee8">hash_cache_entry</a>) <span class="keywordflow">return</span> NULL;
<a name="l00087"></a>00087         lag = fd;
<a name="l00088"></a>00088         fd = next;
<a name="l00089"></a>00089     }
<a name="l00090"></a>00090     <span class="comment">// ce not in the fetchQ, so add it</span>
<a name="l00091"></a>00091     fd = <a class="code" href="sync__diff_8c.html#a49a64c3583c2f1ac3c4967c337e130a0">allocNodeFetch</a>(sdd, ce);
<a name="l00092"></a>00092     <span class="keywordflow">if</span> (lag == NULL) sdd-&gt;<a class="code" href="structsync__diff__data.html#a106732432ae0dc955f522dab508edc01" title="cache entries being fetched">fetchQ</a> = fd;
<a name="l00093"></a>00093     <span class="keywordflow">else</span> lag-&gt;<a class="code" href="structsync__diff__fetch__data.html#a0996ee8ab9ca24a1b80bba72b9faf50f">next</a> = fd;
<a name="l00094"></a>00094     sdd-&gt;<a class="code" href="structsync__diff__data.html#ab73d161b4048d7b47b90fc165460c2b6" title="number of busy remote node fetches">nodeFetchBusy</a>++;
<a name="l00095"></a>00095     ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> |= <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a543f8cfea4a3c99237abeac7e563b90b" title="remote node is being fetched">SyncHashState_fetching</a>;
<a name="l00096"></a>00096     fd-&gt;<a class="code" href="structsync__diff__fetch__data.html#ac4db1e798ad619a2fdde5ee7bc081390">startTime</a> = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l00097"></a>00097     fd-&gt;<a class="code" href="structsync__diff__fetch__data.html#ac8126dbb54d8ac5db5fd3fcf3e44424f">side</a> = side;
<a name="l00098"></a>00098     <span class="keywordflow">return</span> fd;
<a name="l00099"></a>00099 }
<a name="l00100"></a>00100 
<a name="l00101"></a>00101 <span class="comment">// remNodeFetch removes the tracking data for a cache entry</span>
<a name="l00102"></a>00102 <span class="comment">// returns NULL if there was no sync_diff_fetch_data found,</span>
<a name="l00103"></a>00103 <span class="comment">// returns the sync_diff_fetch_data if it was found (and removed)</span>
<a name="l00104"></a>00104 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structsync__diff__fetch__data.html">sync_diff_fetch_data</a> *
<a name="l00105"></a><a class="code" href="sync__diff_8c.html#a06ceecb0e3976283d223d8c250cc9ff3">00105</a> <a class="code" href="sync__diff_8c.html#a06ceecb0e3976283d223d8c250cc9ff3">remNodeFetch</a>(<span class="keyword">struct</span> <a class="code" href="structsync__diff__data.html">sync_diff_data</a> *sdd, <span class="keyword">struct</span> <a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce) {
<a name="l00106"></a>00106     <span class="keywordflow">if</span> (ce != NULL) {
<a name="l00107"></a>00107         <span class="keyword">struct </span><a class="code" href="structsync__diff__fetch__data.html">sync_diff_fetch_data</a> *fd = sdd-&gt;<a class="code" href="structsync__diff__data.html#a106732432ae0dc955f522dab508edc01" title="cache entries being fetched">fetchQ</a>;
<a name="l00108"></a>00108         <span class="keyword">struct </span><a class="code" href="structsync__diff__fetch__data.html">sync_diff_fetch_data</a> *lag = NULL;
<a name="l00109"></a>00109         <span class="keywordflow">while</span> (fd != NULL) {
<a name="l00110"></a>00110             <span class="keyword">struct </span><a class="code" href="structsync__diff__fetch__data.html">sync_diff_fetch_data</a> *<a class="code" href="structsync__diff__fetch__data.html#a0996ee8ab9ca24a1b80bba72b9faf50f">next</a> = fd-&gt;<a class="code" href="structsync__diff__fetch__data.html#a0996ee8ab9ca24a1b80bba72b9faf50f">next</a>;
<a name="l00111"></a>00111             <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="structsync__diff__fetch__data.html#a8dbd1b4a1d501f88e83a7f0869abaee8">hash_cache_entry</a> == ce) {
<a name="l00112"></a>00112                 <span class="keywordflow">if</span> (lag == NULL) sdd-&gt;<a class="code" href="structsync__diff__data.html#a106732432ae0dc955f522dab508edc01" title="cache entries being fetched">fetchQ</a> = next;
<a name="l00113"></a>00113                 <span class="keywordflow">else</span> lag-&gt;<a class="code" href="structsync__diff__fetch__data.html#a0996ee8ab9ca24a1b80bba72b9faf50f">next</a> = next;
<a name="l00114"></a>00114                 fd-&gt;<a class="code" href="structsync__diff__fetch__data.html#a0996ee8ab9ca24a1b80bba72b9faf50f">next</a> = NULL;
<a name="l00115"></a>00115                 sdd-&gt;<a class="code" href="structsync__diff__data.html#ab73d161b4048d7b47b90fc165460c2b6" title="number of busy remote node fetches">nodeFetchBusy</a>--;
<a name="l00116"></a>00116                 <span class="keywordflow">return</span> fd;
<a name="l00117"></a>00117             }
<a name="l00118"></a>00118             lag = fd;
<a name="l00119"></a>00119             fd = next;
<a name="l00120"></a>00120         }
<a name="l00121"></a>00121     }
<a name="l00122"></a>00122     <span class="keywordflow">return</span> NULL;
<a name="l00123"></a>00123 }
<a name="l00124"></a>00124 
<a name="l00125"></a>00125 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00126"></a><a class="code" href="sync__diff_8c.html#a85ca214fc1bc97b25fe23c1363cd593d">00126</a> <a class="code" href="sync__diff_8c.html#a85ca214fc1bc97b25fe23c1363cd593d">formatCacheEntry</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root, <span class="keywordtype">char</span> *dst, <span class="keywordtype">int</span> lim,
<a name="l00127"></a>00127                <span class="keywordtype">char</span> *prefix, <span class="keyword">struct</span> <a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce) {
<a name="l00128"></a>00128     <span class="keywordtype">int</span> n = 0;
<a name="l00129"></a>00129     <span class="keywordflow">if</span> (ce == NULL) n = snprintf(dst, lim, <span class="stringliteral">&quot;%shash#null&quot;</span>, prefix);
<a name="l00130"></a>00130     <span class="keywordflow">else</span> n = snprintf(dst, lim, <span class="stringliteral">&quot;%shash#%08x&quot;</span>, prefix, (uint32_t) ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a875dcf9fba72d3d3d8da0e8266ada7de" title="the small hash">small</a>);
<a name="l00131"></a>00131     <span class="keywordflow">return</span> n;
<a name="l00132"></a>00132 }
<a name="l00133"></a>00133 
<a name="l00134"></a>00134 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00135"></a><a class="code" href="sync__diff_8c.html#a677c4508262ab00cdea51b16065eac17">00135</a> <a class="code" href="sync__diff_8c.html#a677c4508262ab00cdea51b16065eac17">showCacheEntry1</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root, <span class="keywordtype">char</span> *here, <span class="keywordtype">char</span> *msg,
<a name="l00136"></a>00136                 <span class="keyword">struct</span> <a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce) {
<a name="l00137"></a>00137     <span class="keywordtype">char</span> temp[1024];
<a name="l00138"></a>00138     <a class="code" href="sync__diff_8c.html#a85ca214fc1bc97b25fe23c1363cd593d">formatCacheEntry</a>(root, temp, <span class="keyword">sizeof</span>(temp), <span class="stringliteral">&quot;&quot;</span>, ce);
<a name="l00139"></a>00139     <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, msg, temp);
<a name="l00140"></a>00140 }
<a name="l00141"></a>00141 
<a name="l00142"></a>00142 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00143"></a><a class="code" href="sync__diff_8c.html#a693571491e7f8b307640238175b6aa57">00143</a> <a class="code" href="sync__diff_8c.html#a693571491e7f8b307640238175b6aa57">showCacheEntry2</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root, <span class="keywordtype">char</span> *here, <span class="keywordtype">char</span> *msg,
<a name="l00144"></a>00144                 <span class="keyword">struct</span> <a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce1, <span class="keyword">struct</span> <a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce2) {
<a name="l00145"></a>00145     <span class="keywordtype">char</span> temp[1024];
<a name="l00146"></a>00146     <span class="keywordtype">int</span> n = <a class="code" href="sync__diff_8c.html#a85ca214fc1bc97b25fe23c1363cd593d">formatCacheEntry</a>(root, temp, <span class="keyword">sizeof</span>(temp), <span class="stringliteral">&quot;&quot;</span>, ce1);
<a name="l00147"></a>00147     <a class="code" href="sync__diff_8c.html#a85ca214fc1bc97b25fe23c1363cd593d">formatCacheEntry</a>(root, temp+n, <span class="keyword">sizeof</span>(temp)-n, <span class="stringliteral">&quot;, &quot;</span>, ce2);
<a name="l00148"></a>00148     <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, msg, temp);
<a name="l00149"></a>00149 }
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 <span class="comment">// forward declaration</span>
<a name="l00152"></a>00152 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00153"></a>00153 <a class="code" href="sync__diff_8c.html#a31715d7e9f5852d90ca9b6d5a2d16986">compareAction</a>(<span class="keyword">struct</span> ccn_schedule *sched,
<a name="l00154"></a>00154               <span class="keywordtype">void</span> *clienth,
<a name="l00155"></a>00155               <span class="keyword">struct</span> <a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev,
<a name="l00156"></a>00156               <span class="keywordtype">int</span> flags);
<a name="l00157"></a>00157 
<a name="l00158"></a>00158 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00159"></a>00159 <a class="code" href="sync__diff_8c.html#ad7dd34a571d7610744d405d6d20f5e8d">updateAction</a>(<span class="keyword">struct</span> ccn_schedule *sched,
<a name="l00160"></a>00160              <span class="keywordtype">void</span> *clienth,
<a name="l00161"></a>00161              <span class="keyword">struct</span> <a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev,
<a name="l00162"></a>00162              <span class="keywordtype">int</span> flags);
<a name="l00163"></a>00163 
<a name="l00164"></a>00164 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00165"></a><a class="code" href="sync__diff_8c.html#a7e6d6e49a77c4bbd419a15345182d344">00165</a> <a class="code" href="sync__diff_8c.html#a7e6d6e49a77c4bbd419a15345182d344">freeFetchData</a>(<span class="keyword">struct</span> <a class="code" href="structsync__diff__fetch__data.html">sync_diff_fetch_data</a> *fd) {
<a name="l00166"></a>00166     <span class="keyword">struct </span><a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *action = fd-&gt;<a class="code" href="structsync__diff__fetch__data.html#ace9463f437347a44f954a6133c155f00">action</a>;
<a name="l00167"></a>00167     <span class="keywordflow">if</span> (action != NULL &amp;&amp; action-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a> == fd) {
<a name="l00168"></a>00168         <span class="comment">// don&#39;t follow the link to something that is gone</span>
<a name="l00169"></a>00169         action-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a> = NULL;
<a name="l00170"></a>00170     }
<a name="l00171"></a>00171     free(fd);
<a name="l00172"></a>00172 }
<a name="l00173"></a>00173 
<a name="l00174"></a>00174 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00175"></a><a class="code" href="sync__diff_8c.html#a8d52b9e0db366a10c79a3014f2319d75">00175</a> <a class="code" href="sync__diff_8c.html#a8d52b9e0db366a10c79a3014f2319d75">resetDiffData</a>(<span class="keyword">struct</span> <a class="code" href="structsync__diff__data.html">sync_diff_data</a> *sdd) {
<a name="l00176"></a>00176     <span class="keywordflow">if</span> (sdd == NULL) <span class="keywordflow">return</span>;
<a name="l00177"></a>00177     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = sdd-&gt;<a class="code" href="structsync__diff__data.html#a4c835d54dc03229f2856a1e0966b0d1c">root</a>;
<a name="l00178"></a>00178     <span class="keywordflow">if</span> (root == NULL) <span class="keywordflow">return</span>;
<a name="l00179"></a>00179     <span class="keyword">struct </span><a class="code" href="structsync__diff__fetch__data.html">sync_diff_fetch_data</a> *fd = sdd-&gt;<a class="code" href="structsync__diff__data.html#a106732432ae0dc955f522dab508edc01" title="cache entries being fetched">fetchQ</a>;
<a name="l00180"></a>00180     sdd-&gt;<a class="code" href="structsync__diff__data.html#a106732432ae0dc955f522dab508edc01" title="cache entries being fetched">fetchQ</a> = NULL;
<a name="l00181"></a>00181     <span class="keyword">struct </span><a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev = sdd-&gt;<a class="code" href="structsync__diff__data.html#a10ee698bc4a7227ceb48d52f9d113600" title="progress event">ev</a>;
<a name="l00182"></a>00182     sdd-&gt;<a class="code" href="structsync__diff__data.html#a10ee698bc4a7227ceb48d52f9d113600" title="progress event">ev</a> = NULL;
<a name="l00183"></a>00183     <span class="keywordflow">if</span> (sdd-&gt;<a class="code" href="structsync__diff__data.html#a26751453e1f6d08681032db803534d4c" title="&amp;quot;local&amp;quot; tree scratch">cbX</a> != NULL) {
<a name="l00184"></a>00184         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;sdd-&gt;<a class="code" href="structsync__diff__data.html#a26751453e1f6d08681032db803534d4c" title="&amp;quot;local&amp;quot; tree scratch">cbX</a>);
<a name="l00185"></a>00185         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;sdd-&gt;<a class="code" href="structsync__diff__data.html#a03e23c9e9c1a157371f956e74292fa24" title="&amp;quot;remote&amp;quot; tree scratch">cbY</a>);
<a name="l00186"></a>00186     }
<a name="l00187"></a>00187     <span class="keywordflow">while</span> (fd != NULL) {
<a name="l00188"></a>00188         <span class="keyword">struct </span><a class="code" href="structsync__diff__fetch__data.html">sync_diff_fetch_data</a> *lag = fd;
<a name="l00189"></a>00189         fd = fd-&gt;<a class="code" href="structsync__diff__fetch__data.html#a0996ee8ab9ca24a1b80bba72b9faf50f">next</a>;
<a name="l00190"></a>00190         <a class="code" href="sync__diff_8c.html#a7e6d6e49a77c4bbd419a15345182d344">freeFetchData</a>(lag);
<a name="l00191"></a>00191     }
<a name="l00192"></a>00192     sdd-&gt;<a class="code" href="structsync__diff__data.html#a3f95b5a31ad339b0cd28f190288fe533" title="&amp;quot;local&amp;quot; tree walker state">twX</a> = <a class="code" href="_sync_tree_worker_8c.html#a5b7baae8bce01030ed514fd40e6268c5" title="Free the storage for the worker.">SyncTreeWorkerFree</a>(sdd-&gt;<a class="code" href="structsync__diff__data.html#a3f95b5a31ad339b0cd28f190288fe533" title="&amp;quot;local&amp;quot; tree walker state">twX</a>);
<a name="l00193"></a>00193     sdd-&gt;<a class="code" href="structsync__diff__data.html#aea271c342899152f5e314fdea4a26ab9" title="&amp;quot;remote&amp;quot; tree walker state">twY</a> = <a class="code" href="_sync_tree_worker_8c.html#a5b7baae8bce01030ed514fd40e6268c5" title="Free the storage for the worker.">SyncTreeWorkerFree</a>(sdd-&gt;<a class="code" href="structsync__diff__data.html#aea271c342899152f5e314fdea4a26ab9" title="&amp;quot;remote&amp;quot; tree walker state">twY</a>);
<a name="l00194"></a>00194     <span class="keywordflow">if</span> (ev != NULL &amp;&amp; ev-&gt;<a class="code" href="structccn__scheduled__event.html#a4f4c36335e9001eaca5442f672798e95">evdata</a> == sdd) {
<a name="l00195"></a>00195         sdd-&gt;<a class="code" href="structsync__diff__data.html#a10ee698bc4a7227ceb48d52f9d113600" title="progress event">ev</a> = NULL;
<a name="l00196"></a>00196         <a class="code" href="schedule_8h.html#a0b636a012b97cc600634684736018fe7" title="Cancel a scheduled event.">ccn_schedule_cancel</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>-&gt;<a class="code" href="structsync__plumbing.html#ab5e574093a95dfb432043980ce9a5e17">sched</a>, ev);
<a name="l00197"></a>00197     }
<a name="l00198"></a>00198 }
<a name="l00199"></a>00199 
<a name="l00200"></a>00200 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00201"></a><a class="code" href="sync__diff_8c.html#ab9656b13bde807ac27980d88fa49f026">00201</a> <a class="code" href="sync__diff_8c.html#ab9656b13bde807ac27980d88fa49f026">resetUpdateData</a>(<span class="keyword">struct</span> <a class="code" href="structsync__update__data.html">sync_update_data</a> *ud) {
<a name="l00202"></a>00202     <span class="keywordflow">if</span> (ud == NULL) <span class="keywordflow">return</span>;
<a name="l00203"></a>00203     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = ud-&gt;<a class="code" href="structsync__update__data.html#ae27a2fd5da60493df931427349b1419f">root</a>;
<a name="l00204"></a>00204     <span class="keywordflow">if</span> (root == NULL) <span class="keywordflow">return</span>;
<a name="l00205"></a>00205     <span class="keywordflow">if</span> (ud-&gt;<a class="code" href="structsync__update__data.html#a95435eb475deb0007ba15c50be1d088f">cb</a> != NULL)
<a name="l00206"></a>00206         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;ud-&gt;<a class="code" href="structsync__update__data.html#a95435eb475deb0007ba15c50be1d088f">cb</a>);
<a name="l00207"></a>00207     ud-&gt;<a class="code" href="structsync__update__data.html#af93ce2f9b944704a210429631edae49c" title="sorted names from start_sync_update">adding</a> = <a class="code" href="_sync_util_8c.html#a6c2c47daae1a00b2fd20577c8bd7eef0" title="frees the name accum and all of the names">SyncFreeNameAccumAndNames</a>(ud-&gt;<a class="code" href="structsync__update__data.html#af93ce2f9b944704a210429631edae49c" title="sorted names from start_sync_update">adding</a>);
<a name="l00208"></a>00208     ud-&gt;<a class="code" href="structsync__update__data.html#a1cb1d7a80bfc2712d5b22bea479e32f1" title="temp storage used while updating">names</a> = <a class="code" href="_sync_util_8c.html#a6c2c47daae1a00b2fd20577c8bd7eef0" title="frees the name accum and all of the names">SyncFreeNameAccumAndNames</a>(ud-&gt;<a class="code" href="structsync__update__data.html#a1cb1d7a80bfc2712d5b22bea479e32f1" title="temp storage used while updating">names</a>);
<a name="l00209"></a>00209     ud-&gt;<a class="code" href="structsync__update__data.html#a54c30a3acf32ec8669ce466e00b05af1" title="temp storage used while updating">nodes</a> = <a class="code" href="_sync_util_8c.html#a1bc7a4088f04170cdf7ea57e04866c4b">SyncFreeNodeAccum</a>(ud-&gt;<a class="code" href="structsync__update__data.html#a54c30a3acf32ec8669ce466e00b05af1" title="temp storage used while updating">nodes</a>);
<a name="l00210"></a>00210     ud-&gt;<a class="code" href="structsync__update__data.html#abd7c89908b0b14fbe51592a8c42b881c">tw</a> = <a class="code" href="_sync_tree_worker_8c.html#a5b7baae8bce01030ed514fd40e6268c5" title="Free the storage for the worker.">SyncTreeWorkerFree</a>(ud-&gt;<a class="code" href="structsync__update__data.html#abd7c89908b0b14fbe51592a8c42b881c">tw</a>);
<a name="l00211"></a>00211     <span class="keyword">struct </span><a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev = ud-&gt;<a class="code" href="structsync__update__data.html#a8a4d113ce8990e961a9496424d8c0847" title="progress event">ev</a>;
<a name="l00212"></a>00212     <span class="keywordflow">if</span> (ev != NULL &amp;&amp; ev-&gt;<a class="code" href="structccn__scheduled__event.html#a4f4c36335e9001eaca5442f672798e95">evdata</a> == ud) {
<a name="l00213"></a>00213         ud-&gt;<a class="code" href="structsync__update__data.html#a8a4d113ce8990e961a9496424d8c0847" title="progress event">ev</a> = NULL;
<a name="l00214"></a>00214         <a class="code" href="schedule_8h.html#a0b636a012b97cc600634684736018fe7" title="Cancel a scheduled event.">ccn_schedule_cancel</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>-&gt;<a class="code" href="structsync__plumbing.html#ab5e574093a95dfb432043980ce9a5e17">sched</a>, ev);
<a name="l00215"></a>00215     }
<a name="l00216"></a>00216 }
<a name="l00217"></a>00217 
<a name="l00218"></a>00218 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00219"></a><a class="code" href="sync__diff_8c.html#a3bb2d2b15c7a550960f237975f4d27b6">00219</a> <a class="code" href="sync__diff_8c.html#a3bb2d2b15c7a550960f237975f4d27b6">abortCompare</a>(<span class="keyword">struct</span> <a class="code" href="structsync__diff__data.html">sync_diff_data</a> *sdd, <span class="keywordtype">char</span> *why) {
<a name="l00220"></a>00220     <span class="comment">// this compare failed due to a node fetch or content fetch failure</span>
<a name="l00221"></a>00221     <span class="comment">// we could get repeated failures if we try the same remote node,</span>
<a name="l00222"></a>00222     <span class="comment">// so remove it from the seen remote nodes, then destroy the compare data</span>
<a name="l00223"></a>00223     <span class="keywordflow">if</span> (sdd == NULL) <span class="keywordflow">return</span> -1;
<a name="l00224"></a>00224     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = sdd-&gt;<a class="code" href="structsync__diff__data.html#a4c835d54dc03229f2856a1e0966b0d1c">root</a>;
<a name="l00225"></a>00225     <span class="keywordflow">if</span> (root != NULL) {
<a name="l00226"></a>00226         <span class="keywordflow">if</span> (root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a2813bb28b1559ff71ca56e66d8df63a6" title="Something might be wrong.">CCNL_WARNING</a>)
<a name="l00227"></a>00227             <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, <span class="stringliteral">&quot;Sync.compare&quot;</span>, why);
<a name="l00228"></a>00228     }
<a name="l00229"></a>00229     sdd-&gt;<a class="code" href="structsync__diff__data.html#a10ee698bc4a7227ceb48d52f9d113600" title="progress event">ev</a> = NULL;
<a name="l00230"></a>00230     sdd-&gt;<a class="code" href="structsync__diff__data.html#a67fc1283c7352412a50f417e07a855d9" title="summary state of comparison">state</a> = <a class="code" href="sync__diff_8h.html#ae0c609194fbe6e000ccea19e6591dd19a3201ee381d392a46812079cb64d5c0c0">sync_diff_state_error</a>;
<a name="l00231"></a>00231     <span class="keywordflow">if</span> (sdd-&gt;<a class="code" href="structsync__diff__data.html#a8c48a9c5ac1c18f27b6ea84e8c8a3f88">add_closure</a> != NULL &amp;&amp; sdd-&gt;<a class="code" href="structsync__diff__data.html#a8c48a9c5ac1c18f27b6ea84e8c8a3f88">add_closure</a>-&gt;<a class="code" href="structsync__diff__add__closure.html#a9fe212376ec8cb5f4ec35ccae87b7876">add</a> != NULL)
<a name="l00232"></a>00232         <span class="comment">// give the client a last shot at the data</span>
<a name="l00233"></a>00233         sdd-&gt;<a class="code" href="structsync__diff__data.html#a8c48a9c5ac1c18f27b6ea84e8c8a3f88">add_closure</a>-&gt;<a class="code" href="structsync__diff__add__closure.html#a9fe212376ec8cb5f4ec35ccae87b7876">add</a>(sdd-&gt;<a class="code" href="structsync__diff__data.html#a8c48a9c5ac1c18f27b6ea84e8c8a3f88">add_closure</a>, NULL);
<a name="l00234"></a>00234     <span class="keywordflow">return</span> -1;
<a name="l00235"></a>00235 }
<a name="l00236"></a>00236 
<a name="l00237"></a>00237 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00238"></a><a class="code" href="sync__diff_8c.html#ab315e023d432486f7c2b0966654b3c8c">00238</a> <a class="code" href="sync__diff_8c.html#ab315e023d432486f7c2b0966654b3c8c">comparisonFailed</a>(<span class="keyword">struct</span> <a class="code" href="structsync__diff__data.html">sync_diff_data</a> *sdd, <span class="keywordtype">char</span> *why, <span class="keywordtype">int</span> line) {
<a name="l00239"></a>00239     <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(sdd-&gt;<a class="code" href="structsync__diff__data.html#a4c835d54dc03229f2856a1e0966b0d1c">root</a>, <span class="stringliteral">&quot;Sync.compare&quot;</span>, why, line);
<a name="l00240"></a>00240     <span class="keywordflow">return</span> -1;
<a name="l00241"></a>00241 }
<a name="l00242"></a>00242 
<a name="l00243"></a>00243 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00244"></a><a class="code" href="sync__diff_8c.html#aaf9c87ebf674e592c7bcb15aebbe937e">00244</a> <a class="code" href="sync__diff_8c.html#aaf9c87ebf674e592c7bcb15aebbe937e">extractBuf</a>(<span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *cb, <span class="keyword">struct</span> <a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *nc, <span class="keyword">struct</span> <a class="code" href="struct_sync_node_elem.html">SyncNodeElem</a> *ne) {
<a name="l00245"></a>00245     <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> ds;
<a name="l00246"></a>00246     <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> *d = <a class="code" href="_sync_node_8c.html#a68422d265d86c4cd45315b342f399b4f" title="Makes a decoder from an element.">SyncInitDecoderFromElem</a>(&amp;ds, nc, ne);
<a name="l00247"></a>00247     <a class="code" href="charbuf_8h.html#aa0cf436e626f2e8d0fefeaed179676de">ccn_charbuf_reset</a>(cb);
<a name="l00248"></a>00248     <span class="keywordtype">int</span> res = <a class="code" href="_sync_util_8c.html#ad88a88ea7a19638ca65486387db41a72">SyncAppendElementInner</a>(cb, d);
<a name="l00249"></a>00249     <span class="keywordflow">return</span> res;
<a name="l00250"></a>00250 }
<a name="l00251"></a>00251 
<a name="l00252"></a>00252 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *
<a name="l00253"></a><a class="code" href="sync__diff_8c.html#a6eea619c02366baa2c0f7391a3d331f2">00253</a> <a class="code" href="sync__diff_8c.html#a6eea619c02366baa2c0f7391a3d331f2">entryForHash</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root, <span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *<a class="code" href="struct_sync_hash_cache_entry.html#aba3a8329dde03169d4bb1f369b2d78cf" title="hash used to reach this entry">hash</a>) {
<a name="l00254"></a>00254     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = NULL;
<a name="l00255"></a>00255     <span class="keywordflow">if</span> (hash != NULL &amp;&amp; hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> &gt; 0)
<a name="l00256"></a>00256         ce = <a class="code" href="_sync_hash_cache_8c.html#a15c6eafb71bb631fde85a2424f5ac449" title="lookup a full hash in a hash table (raw contents, no tag)">SyncHashLookup</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00257"></a>00257     <span class="keywordflow">return</span> ce;
<a name="l00258"></a>00258 }
<a name="l00259"></a>00259 
<a name="l00260"></a>00260 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00261"></a><a class="code" href="sync__diff_8c.html#aa6a3bb3fd352266999d3ff44c18f4488">00261</a> <a class="code" href="sync__diff_8c.html#aa6a3bb3fd352266999d3ff44c18f4488">initWorkerFromHash</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root,
<a name="l00262"></a>00262                    <span class="keyword">struct</span> <a class="code" href="struct_sync_tree_worker_head.html">SyncTreeWorkerHead</a> *tw,
<a name="l00263"></a>00263                    <span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *<a class="code" href="struct_sync_hash_cache_entry.html#aba3a8329dde03169d4bb1f369b2d78cf" title="hash used to reach this entry">hash</a>) {
<a name="l00264"></a>00264     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = <a class="code" href="sync__diff_8c.html#a6eea619c02366baa2c0f7391a3d331f2">entryForHash</a>(root, hash);
<a name="l00265"></a>00265     <a class="code" href="_sync_tree_worker_8c.html#a2b23b35551daa1814a39180621642342" title="initialize an existing worker from the cache entry resulting level will be 1">SyncTreeWorkerInit</a>(tw, ce);
<a name="l00266"></a>00266 }
<a name="l00267"></a>00267 
<a name="l00268"></a>00268 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *
<a name="l00269"></a><a class="code" href="sync__diff_8c.html#ae36b30555d09158a5fae4d8658d49fe1">00269</a> <a class="code" href="sync__diff_8c.html#ae36b30555d09158a5fae4d8658d49fe1">cacheEntryForElem</a>(<span class="keyword">struct</span> <a class="code" href="structsync__diff__data.html">sync_diff_data</a> *sdd,
<a name="l00270"></a>00270                   <span class="keyword">struct</span> <a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *nc,
<a name="l00271"></a>00271                   <span class="keyword">struct</span> <a class="code" href="struct_sync_node_elem.html">SyncNodeElem</a> *ne) {
<a name="l00272"></a>00272     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.cacheEntryForElem&quot;</span>;
<a name="l00273"></a>00273     <span class="keywordflow">if</span> (ne-&gt;<a class="code" href="struct_sync_node_elem.html#a770ab2553870198f1b5dbc1a7302eccb" title="leaf/composite flag">kind</a> == <a class="code" href="_sync_node_8h.html#ab268103cfe0f550f6c750922e68b4706a814b9a3505f28764701d289e71b8a649" title="leaf">SyncElemKind_leaf</a>) <span class="keywordflow">return</span> NULL;
<a name="l00274"></a>00274     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = sdd-&gt;<a class="code" href="structsync__diff__data.html#a4c835d54dc03229f2856a1e0966b0d1c">root</a>;
<a name="l00275"></a>00275     <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> ds;
<a name="l00276"></a>00276     <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> *d = <a class="code" href="_sync_node_8c.html#a2c3c4e8ac29c16de51ab89101c57c84e" title="Makes a decoder from an offset range using the node charbuf.">SyncInitDecoderFromOffset</a>(&amp;ds, nc,
<a name="l00277"></a>00277                                                           ne-&gt;<a class="code" href="struct_sync_node_elem.html#a20ccaf134fbf6330b2da16f33b313a05" title="start of element encoding">start</a>,
<a name="l00278"></a>00278                                                           ne-&gt;<a class="code" href="struct_sync_node_elem.html#ac5994b53656f2c5fc163770a1805f00e" title="stop of element encoding">stop</a>);
<a name="l00279"></a>00279     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * xp = NULL;
<a name="l00280"></a>00280     ssize_t xs = 0;
<a name="l00281"></a>00281     <a class="code" href="_sync_util_8c.html#a530e9d73b66665fcb2801436189b76cc" title="finds the hash code, storing the pointer to *xp and the length to *xs if the hash...">SyncGetHashPtr</a>(d, &amp;xp, &amp;xs);
<a name="l00282"></a>00282     <span class="keywordflow">if</span> (xs == 0 || xp == NULL) {
<a name="l00283"></a>00283         <span class="comment">// no hash?  this could be a problem</span>
<a name="l00284"></a>00284         <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;no hash&quot;</span>, __LINE__);
<a name="l00285"></a>00285         <span class="keywordflow">return</span> NULL;
<a name="l00286"></a>00286     }
<a name="l00287"></a>00287     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = <a class="code" href="_sync_hash_cache_8c.html#a15c6eafb71bb631fde85a2424f5ac449" title="lookup a full hash in a hash table (raw contents, no tag)">SyncHashLookup</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>, xp, xs);
<a name="l00288"></a>00288     <span class="keywordflow">if</span> (ce == NULL) {
<a name="l00289"></a>00289         ce = <a class="code" href="_sync_hash_cache_8c.html#abcf5e784c52d971d943bddef80731954" title="based on the raw hash, ensure that a remote cache entry exists ent-&amp;gt;state |= set...">SyncHashEnter</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>, xp, xs, <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381afe5be5594d6673042bf71f7b5301d6b7" title="empty, not much known">SyncHashState_null</a>);
<a name="l00290"></a>00290         <span class="keywordflow">if</span> (ce == NULL) {
<a name="l00291"></a>00291             <span class="comment">// and why did this fail?</span>
<a name="l00292"></a>00292             <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad enter&quot;</span>, __LINE__);
<a name="l00293"></a>00293             <span class="keywordflow">return</span> ce;
<a name="l00294"></a>00294         }
<a name="l00295"></a>00295     }
<a name="l00296"></a>00296     <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a> != NULL)
<a name="l00297"></a>00297         ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> |= <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a9e849b0fed91e850763db20a54956128" title="a local node exists">SyncHashState_local</a>;
<a name="l00298"></a>00298     <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a> != NULL) {
<a name="l00299"></a>00299         ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> |= <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381aec73ed0d374163f11f2d715ce0a3c197" title="a remote hash has been seen">SyncHashState_remote</a>;
<a name="l00300"></a>00300         <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a> != NULL)
<a name="l00301"></a>00301             ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> |= <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381ae306c2dc55f40bf7e12c45acaf8d7a26" title="remote hash known covered by the local root">SyncHashState_covered</a>;
<a name="l00302"></a>00302     }
<a name="l00303"></a>00303     ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a6861960908cc217b639d3f1af6bbc520" title="time when entry last used in compare">lastUsed</a> = sdd-&gt;<a class="code" href="structsync__diff__data.html#aa134e2b168f70a1869f32f5ecb819f6d" title="time marker for last compare step entry">lastEnter</a>;
<a name="l00304"></a>00304     <span class="keywordflow">return</span> ce;
<a name="l00305"></a>00305 }
<a name="l00306"></a>00306 
<a name="l00307"></a>00307 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00308"></a><a class="code" href="sync__diff_8c.html#ae67b3191df0edba9de445e0b36dc1b0b">00308</a> <a class="code" href="sync__diff_8c.html#ae67b3191df0edba9de445e0b36dc1b0b">kickCompare</a>(<span class="keyword">struct</span> <a class="code" href="structsync__diff__data.html">sync_diff_data</a> *sdd, <span class="keywordtype">int</span> micros) {
<a name="l00309"></a>00309     <span class="comment">// we need to restart compareAction</span>
<a name="l00310"></a>00310     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = sdd-&gt;<a class="code" href="structsync__diff__data.html#a4c835d54dc03229f2856a1e0966b0d1c">root</a>;
<a name="l00311"></a>00311     <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>;
<a name="l00312"></a>00312     <span class="keyword">struct </span><a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev = sdd-&gt;<a class="code" href="structsync__diff__data.html#a10ee698bc4a7227ceb48d52f9d113600" title="progress event">ev</a>;
<a name="l00313"></a>00313     <span class="keywordflow">if</span> (ev != NULL &amp;&amp; ev-&gt;<a class="code" href="structccn__scheduled__event.html#a4f4c36335e9001eaca5442f672798e95">evdata</a> == sdd) {
<a name="l00314"></a>00314         <span class="comment">// this one may wait too long, kick it now!</span>
<a name="l00315"></a>00315         sdd-&gt;<a class="code" href="structsync__diff__data.html#a10ee698bc4a7227ceb48d52f9d113600" title="progress event">ev</a> = NULL;
<a name="l00316"></a>00316         <a class="code" href="schedule_8h.html#a0b636a012b97cc600634684736018fe7" title="Cancel a scheduled event.">ccn_schedule_cancel</a>(base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>-&gt;<a class="code" href="structsync__plumbing.html#ab5e574093a95dfb432043980ce9a5e17">sched</a>, ev);
<a name="l00317"></a>00317     }
<a name="l00318"></a>00318     sdd-&gt;<a class="code" href="structsync__diff__data.html#a10ee698bc4a7227ceb48d52f9d113600" title="progress event">ev</a> = <a class="code" href="schedule_8h.html#a1b46f1ba6b54371f41a5c160cd1604ba">ccn_schedule_event</a>(base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>-&gt;<a class="code" href="structsync__plumbing.html#ab5e574093a95dfb432043980ce9a5e17">sched</a>,
<a name="l00319"></a>00319                                  micros,
<a name="l00320"></a>00320                                  <a class="code" href="sync__diff_8c.html#a31715d7e9f5852d90ca9b6d5a2d16986">compareAction</a>,
<a name="l00321"></a>00321                                  sdd,
<a name="l00322"></a>00322                                  0);
<a name="l00323"></a>00323     <span class="keywordflow">return</span>;
<a name="l00324"></a>00324 }
<a name="l00325"></a>00325 
<a name="l00326"></a>00326 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00327"></a><a class="code" href="sync__diff_8c.html#a73f268e26ad71d0c588bf953e30610d1">00327</a> <a class="code" href="sync__diff_8c.html#a73f268e26ad71d0c588bf953e30610d1">kickUpdate</a>(<span class="keyword">struct</span> <a class="code" href="structsync__update__data.html">sync_update_data</a> *ud, <span class="keywordtype">int</span> micros) {
<a name="l00328"></a>00328     <span class="comment">// we need to restart compareAction</span>
<a name="l00329"></a>00329     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = ud-&gt;<a class="code" href="structsync__update__data.html#ae27a2fd5da60493df931427349b1419f">root</a>;
<a name="l00330"></a>00330     <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>;
<a name="l00331"></a>00331     <span class="keyword">struct </span><a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev = ud-&gt;<a class="code" href="structsync__update__data.html#a8a4d113ce8990e961a9496424d8c0847" title="progress event">ev</a>;
<a name="l00332"></a>00332     <span class="keywordflow">if</span> (ev != NULL &amp;&amp; ev-&gt;<a class="code" href="structccn__scheduled__event.html#a4f4c36335e9001eaca5442f672798e95">evdata</a> == ud) {
<a name="l00333"></a>00333         <span class="comment">// this one may wait too long, kick it now!</span>
<a name="l00334"></a>00334         ud-&gt;<a class="code" href="structsync__update__data.html#a8a4d113ce8990e961a9496424d8c0847" title="progress event">ev</a> = NULL;
<a name="l00335"></a>00335         <a class="code" href="schedule_8h.html#a0b636a012b97cc600634684736018fe7" title="Cancel a scheduled event.">ccn_schedule_cancel</a>(base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>-&gt;<a class="code" href="structsync__plumbing.html#ab5e574093a95dfb432043980ce9a5e17">sched</a>, ev);
<a name="l00336"></a>00336     }
<a name="l00337"></a>00337     ud-&gt;<a class="code" href="structsync__update__data.html#a8a4d113ce8990e961a9496424d8c0847" title="progress event">ev</a> = <a class="code" href="schedule_8h.html#a1b46f1ba6b54371f41a5c160cd1604ba">ccn_schedule_event</a>(base-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>-&gt;<a class="code" href="structsync__plumbing.html#ab5e574093a95dfb432043980ce9a5e17">sched</a>,
<a name="l00338"></a>00338                                 micros,
<a name="l00339"></a>00339                                 <a class="code" href="sync__diff_8c.html#ad7dd34a571d7610744d405d6d20f5e8d">updateAction</a>,
<a name="l00340"></a>00340                                 ud,
<a name="l00341"></a>00341                                 0);
<a name="l00342"></a>00342     <span class="keywordflow">return</span>;
<a name="l00343"></a>00343 }
<a name="l00344"></a>00344 
<a name="l00345"></a>00345 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *
<a name="l00346"></a><a class="code" href="sync__diff_8c.html#a36c48b475019d6fd3eff04a343e09b94">00346</a> <a class="code" href="sync__diff_8c.html#a36c48b475019d6fd3eff04a343e09b94">constructCommandPrefix</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root,
<a name="l00347"></a>00347                        <span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *hash,
<a name="l00348"></a>00348                        <span class="keywordtype">char</span> *cmd) {
<a name="l00349"></a>00349     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *prefix = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00350"></a>00350     <span class="keywordtype">int</span> res = 0;
<a name="l00351"></a>00351     <a class="code" href="ccn_8h.html#a4aa75ce6fc675e7a4c4c6d65e68817bd" title="Reset charbuf to represent an empty Name in binary format.">ccn_name_init</a>(prefix);
<a name="l00352"></a>00352     <span class="keywordflow">if</span> (root-&gt;<a class="code" href="struct_sync_root_struct.html#a6ba6270127aea47744c6860e6aff6627" title="Sync Protocol topo prefix.">topoPrefix</a> != NULL &amp;&amp; root-&gt;<a class="code" href="struct_sync_root_struct.html#a6ba6270127aea47744c6860e6aff6627" title="Sync Protocol topo prefix.">topoPrefix</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> &gt; 0) {
<a name="l00353"></a>00353         <span class="comment">// the topo (if any) always comes first</span>
<a name="l00354"></a>00354         res |= <a class="code" href="_sync_util_8c.html#ab3aa3affaa70eb4e73a29afdad0cda71" title="appends components from src to dst (both must be names)">SyncAppendAllComponents</a>(prefix, root-&gt;<a class="code" href="struct_sync_root_struct.html#a6ba6270127aea47744c6860e6aff6627" title="Sync Protocol topo prefix.">topoPrefix</a>);
<a name="l00355"></a>00355     }
<a name="l00356"></a>00356     <span class="comment">// the command comes after the topo</span>
<a name="l00357"></a>00357     <a class="code" href="ccn_8h.html#aec5620dc4689a663ea7181cdebeda4d0" title="Add a Component that is a NUL-terminated string.">ccn_name_append_str</a>(prefix, cmd);
<a name="l00358"></a>00358     <span class="keywordflow">if</span> (hash != NULL)
<a name="l00359"></a>00359         res |= <a class="code" href="ccn_8h.html#a3f4f614f38ae77dccb4099e982c646f8" title="Add a Component to a Name.">ccn_name_append</a>(prefix, hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00360"></a>00360     
<a name="l00361"></a>00361     <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00362"></a>00362         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;prefix);
<a name="l00363"></a>00363     }
<a name="l00364"></a>00364     <span class="keywordflow">return</span> prefix;
<a name="l00365"></a>00365 }
<a name="l00366"></a>00366 
<a name="l00367"></a>00367 
<a name="l00368"></a>00368 <span class="comment">/*</span>
<a name="l00369"></a>00369 <span class="comment"> * start_node_fetch initiates a node fetch for a cache entry</span>
<a name="l00370"></a>00370 <span class="comment"> * using the client-supplied lookup and get methods</span>
<a name="l00371"></a>00371 <span class="comment"> * the lookup method is tried first, and if it wins then</span>
<a name="l00372"></a>00372 <span class="comment"> * the get method is not called, and ce-&gt;state |= SyncHashState_local</span>
<a name="l00373"></a>00373 <span class="comment"> * if lookup is not present or does not find the entry then sdd-&gt;get is called</span>
<a name="l00374"></a>00374 <span class="comment"> * to initiate a &quot;remote&quot; fetch, which does not have an immediate response</span>
<a name="l00375"></a>00375 <span class="comment"> * (sync_diff_note_node is called when the node shows up)</span>
<a name="l00376"></a>00376 <span class="comment"> * returns &lt; 0 for failure, 0 for node already present (or being fetched),</span>
<a name="l00377"></a>00377 <span class="comment"> * and &gt; 0 for success</span>
<a name="l00378"></a>00378 <span class="comment"> */</span>
<a name="l00379"></a>00379 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00380"></a><a class="code" href="sync__diff_8c.html#ae7e18f957924a160ff1b68a328aadf85">00380</a> <a class="code" href="sync__diff_8c.html#ae7e18f957924a160ff1b68a328aadf85">start_node_fetch</a>(<span class="keyword">struct</span> <a class="code" href="structsync__diff__data.html">sync_diff_data</a> *sdd,
<a name="l00381"></a>00381                  <span class="keyword">struct</span> <a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce,
<a name="l00382"></a>00382                  <span class="keyword">enum</span> <a class="code" href="sync__diff_8h.html#a6e15e35d7afe80f23fa4bda464bc86bf">sync_diff_side</a> side) {
<a name="l00383"></a>00383     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = sdd-&gt;<a class="code" href="structsync__diff__data.html#a4c835d54dc03229f2856a1e0966b0d1c">root</a>;
<a name="l00384"></a>00384     <span class="keyword">struct </span><a class="code" href="structsync__diff__get__closure.html" title="sync_diff_get_closure is called from the differencing operation when a node is required...">sync_diff_get_closure</a> *<span class="keyword">get</span> = sdd-&gt;<a class="code" href="structsync__diff__data.html#affea13f4cd89753b889c29af52683d65">get_closure</a>;
<a name="l00385"></a>00385     <span class="keywordflow">if</span> (ce == NULL)
<a name="l00386"></a>00386         <span class="comment">// not supposed to happen, bad call</span>
<a name="l00387"></a>00387         <span class="keywordflow">return</span> -1;
<a name="l00388"></a>00388     <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a543f8cfea4a3c99237abeac7e563b90b" title="remote node is being fetched">SyncHashState_fetching</a>)
<a name="l00389"></a>00389         <span class="comment">// already busy</span>
<a name="l00390"></a>00390         <span class="keywordflow">return</span> 0;
<a name="l00391"></a>00391     <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a> != NULL || ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a> != NULL)
<a name="l00392"></a>00392         <span class="comment">// we already have the node</span>
<a name="l00393"></a>00393         <span class="keywordflow">return</span> 0;
<a name="l00394"></a>00394     <span class="keyword">struct </span><a class="code" href="structsync__plumbing.html">sync_plumbing</a> *sd = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>;
<a name="l00395"></a>00395     <span class="keyword">struct </span><a class="code" href="structsync__plumbing__client__methods.html">sync_plumbing_client_methods</a> *sdcm = sd-&gt;<a class="code" href="structsync__plumbing.html#a4978a2b8be6bda0393274d9c107b7436">client_methods</a>;
<a name="l00396"></a>00396     <span class="keywordflow">if</span> (sdcm != NULL &amp;&amp; sdcm-&gt;<a class="code" href="structsync__plumbing__client__methods.html#acafd58bc51f62ef7ceebf9cdfae22f57">r_sync_lookup</a> != NULL) {
<a name="l00397"></a>00397         <span class="comment">// we have a means for local lookup (like a Repo)</span>
<a name="l00398"></a>00398         <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *nc = NULL;
<a name="l00399"></a>00399         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *content = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00400"></a>00400         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = <a class="code" href="sync__diff_8c.html#a36c48b475019d6fd3eff04a343e09b94">constructCommandPrefix</a>(root, root-&gt;<a class="code" href="struct_sync_root_struct.html#add7a152b7bdc85bd56a20b16f1da93f6" title="the raw hash of the sliceCoding">sliceHash</a>, <span class="stringliteral">&quot;\xC1.S.nf&quot;</span>);
<a name="l00401"></a>00401         <span class="keywordtype">int</span> res = 0;
<a name="l00402"></a>00402         <span class="keywordflow">if</span> (ce != NULL) {
<a name="l00403"></a>00403             <span class="comment">// append the best component seen</span>
<a name="l00404"></a>00404             res |= <a class="code" href="ccn_8h.html#a3f4f614f38ae77dccb4099e982c646f8" title="Add a Component to a Name.">ccn_name_append</a>(name, ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#aba3a8329dde03169d4bb1f369b2d78cf" title="hash used to reach this entry">hash</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#aba3a8329dde03169d4bb1f369b2d78cf" title="hash used to reach this entry">hash</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00405"></a>00405         }
<a name="l00406"></a>00406         res |= sdcm-&gt;<a class="code" href="structsync__plumbing__client__methods.html#acafd58bc51f62ef7ceebf9cdfae22f57">r_sync_lookup</a>(sd, name, content);
<a name="l00407"></a>00407         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l00408"></a>00408         <span class="keywordflow">if</span> (res &gt; 0) {
<a name="l00409"></a>00409             <span class="keyword">struct </span><a class="code" href="structccn__parsed___content_object.html">ccn_parsed_ContentObject</a> pcos;
<a name="l00410"></a>00410             <span class="keyword">struct </span><a class="code" href="structccn__parsed___content_object.html">ccn_parsed_ContentObject</a> *pco = &amp;pcos;
<a name="l00411"></a>00411             res = <a class="code" href="ccn_8h.html#a464e10bcdb62aa8821df3ce27eb8c5aa">ccn_parse_ContentObject</a>(content-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, content-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, pco, NULL);
<a name="l00412"></a>00412             <span class="keywordflow">if</span> (res &gt;= 0) {
<a name="l00413"></a>00413                 nc = <a class="code" href="_sync_node_8c.html#adfb4947c4c2919b13654b703364f0172">SyncNodeFromParsedObject</a>(root, content-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, pco);
<a name="l00414"></a>00414                 <span class="keywordflow">if</span> (nc != NULL) {
<a name="l00415"></a>00415                     <span class="comment">// found it!</span>
<a name="l00416"></a>00416                     ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a> = nc;
<a name="l00417"></a>00417                     ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> |= <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a9e849b0fed91e850763db20a54956128" title="a local node exists">SyncHashState_local</a>;
<a name="l00418"></a>00418                     <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381aec73ed0d374163f11f2d715ce0a3c197" title="a remote hash has been seen">SyncHashState_remote</a>)
<a name="l00419"></a>00419                         ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> |= <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381ae306c2dc55f40bf7e12c45acaf8d7a26" title="remote hash known covered by the local root">SyncHashState_covered</a>;
<a name="l00420"></a>00420                     <span class="keywordflow">return</span> 0;
<a name="l00421"></a>00421                 }
<a name="l00422"></a>00422             }
<a name="l00423"></a>00423         }
<a name="l00424"></a>00424     }
<a name="l00425"></a>00425     <span class="comment">// if there is a get method supplied, call it</span>
<a name="l00426"></a>00426     <span class="keywordflow">if</span> (<span class="keyword">get</span> != NULL &amp;&amp; get-&gt;get != NULL) {
<a name="l00427"></a>00427         <span class="comment">// we have a hash and a get method</span>
<a name="l00428"></a>00428         <span class="keyword">struct </span><a class="code" href="structsync__diff__fetch__data.html">sync_diff_fetch_data</a> *fd = <a class="code" href="sync__diff_8c.html#af2471003bfb1cc750027d448b2abe58b">addNodeFetch</a>(sdd, ce, side);
<a name="l00429"></a>00429         <span class="keywordflow">if</span> (fd == NULL)
<a name="l00430"></a>00430             <span class="comment">// already in the fetchQ, don&#39;t make me do this again</span>
<a name="l00431"></a>00431             <span class="keywordflow">return</span> 0;
<a name="l00432"></a>00432         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = <a class="code" href="sync__diff_8c.html#a36c48b475019d6fd3eff04a343e09b94">constructCommandPrefix</a>(root, root-&gt;<a class="code" href="struct_sync_root_struct.html#add7a152b7bdc85bd56a20b16f1da93f6" title="the raw hash of the sliceCoding">sliceHash</a>, <span class="stringliteral">&quot;\xC1.S.nf&quot;</span>);
<a name="l00433"></a>00433         <span class="keywordtype">int</span> res = <span class="keyword">get</span>-&gt;get(<span class="keyword">get</span>, fd);
<a name="l00434"></a>00434         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l00435"></a>00435         <span class="keywordflow">if</span> (res &gt; 0 &amp;&amp; ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a> == NULL &amp;&amp; ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a> == NULL) {
<a name="l00436"></a>00436             <span class="comment">// we have a node being fetched</span>
<a name="l00437"></a>00437         } <span class="keywordflow">else</span> {
<a name="l00438"></a>00438             <span class="comment">// no fetch, so remove the entry</span>
<a name="l00439"></a>00439             fd = <a class="code" href="sync__diff_8c.html#a06ceecb0e3976283d223d8c250cc9ff3">remNodeFetch</a>(sdd, ce);
<a name="l00440"></a>00440             <span class="keywordflow">if</span> (fd != NULL) <a class="code" href="sync__diff_8c.html#a7e6d6e49a77c4bbd419a15345182d344">freeFetchData</a>(fd);
<a name="l00441"></a>00441             <span class="keywordflow">if</span> (res &gt; 0) res = 0;
<a name="l00442"></a>00442         }
<a name="l00443"></a>00443         <span class="keywordflow">return</span> res;
<a name="l00444"></a>00444     }
<a name="l00445"></a>00445     <span class="keywordflow">return</span> -1;
<a name="l00446"></a>00446 }
<a name="l00447"></a>00447 <span class="comment"></span>
<a name="l00448"></a>00448 <span class="comment">/**</span>
<a name="l00449"></a>00449 <span class="comment"> * doPreload(sdd) walks the given tree, and requests a fetch for every</span>
<a name="l00450"></a>00450 <span class="comment"> * node that is not covered and is not in the cache, and is not being fetched.</span>
<a name="l00451"></a>00451 <span class="comment"> * This allows sync trees to be fetched in parallel.</span>
<a name="l00452"></a>00452 <span class="comment"> * @returns &lt; 0 for failure, 0 for incomplete, and &gt; 0 for success</span>
<a name="l00453"></a>00453 <span class="comment"> */</span>
<a name="l00454"></a>00454 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00455"></a><a class="code" href="sync__diff_8c.html#a3525d6b09b95889fc98472f40e9f93b0">00455</a> <a class="code" href="sync__diff_8c.html#a3525d6b09b95889fc98472f40e9f93b0" title="doPreload(sdd) walks the given tree, and requests a fetch for every node that is...">doPreload</a>(<span class="keyword">struct</span> <a class="code" href="structsync__diff__data.html">sync_diff_data</a> *sdd,
<a name="l00456"></a>00456           <span class="keyword">struct</span> <a class="code" href="struct_sync_tree_worker_head.html">SyncTreeWorkerHead</a> *twHead,
<a name="l00457"></a>00457           <span class="keyword">enum</span> <a class="code" href="sync__diff_8h.html#a6e15e35d7afe80f23fa4bda464bc86bf">sync_diff_side</a> side) {
<a name="l00458"></a>00458     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = sdd-&gt;<a class="code" href="structsync__diff__data.html#a4c835d54dc03229f2856a1e0966b0d1c">root</a>;
<a name="l00459"></a>00459     <span class="keywordtype">int</span> busyLim = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>-&gt;<a class="code" href="struct_sync_private.html#abc0dcd016d407f91323ef33772d98e15">maxFetchBusy</a>;
<a name="l00460"></a>00460     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l00461"></a>00461     <span class="keywordtype">int</span> incomplete = 0;
<a name="l00462"></a>00462     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l00463"></a>00463         <span class="keyword">static</span> <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.doPreload&quot;</span>;
<a name="l00464"></a>00464         <span class="keywordtype">char</span> temp[256];
<a name="l00465"></a>00465         <span class="keywordtype">int</span> pos = 0;
<a name="l00466"></a>00466         pos += snprintf(temp+pos, <span class="keyword">sizeof</span>(temp)-pos, <span class="stringliteral">&quot;side %d&quot;</span>, side);
<a name="l00467"></a>00467         pos += snprintf(temp+pos, <span class="keyword">sizeof</span>(temp)-pos, <span class="stringliteral">&quot;, level %d&quot;</span>,
<a name="l00468"></a>00468                         twHead-&gt;<a class="code" href="struct_sync_tree_worker_head.html#ad3fbea62094d3a5e81e325f896e8a4df">level</a>);
<a name="l00469"></a>00469         <span class="keyword">struct </span><a class="code" href="struct_sync_tree_worker_entry.html">SyncTreeWorkerEntry</a> *ent = <a class="code" href="_sync_tree_worker_8c.html#a776013fec43bda3e07895da7e668f05a">SyncTreeWorkerTop</a>(twHead);
<a name="l00470"></a>00470         <span class="keywordflow">if</span> (ent != NULL)
<a name="l00471"></a>00471             pos += snprintf(temp+pos, <span class="keyword">sizeof</span>(temp)-pos,
<a name="l00472"></a>00472                             <span class="stringliteral">&quot;, pos %d, count %d&quot;</span>,
<a name="l00473"></a>00473                             (<span class="keywordtype">int</span>) ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>, (<span class="keywordtype">int</span>) ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#a1fe537a031485a9ca226ff4fc83d6aa3">count</a>);
<a name="l00474"></a>00474         <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, temp);
<a name="l00475"></a>00475     }
<a name="l00476"></a>00476     <span class="keywordflow">for</span> (;;) {
<a name="l00477"></a>00477         <span class="keywordflow">if</span> (sdd-&gt;<a class="code" href="structsync__diff__data.html#ab73d161b4048d7b47b90fc165460c2b6" title="number of busy remote node fetches">nodeFetchBusy</a> &gt; busyLim) <span class="keywordflow">return</span> 0;
<a name="l00478"></a>00478         <span class="keywordflow">if</span> (twHead-&gt;<a class="code" href="struct_sync_tree_worker_head.html#ad3fbea62094d3a5e81e325f896e8a4df">level</a> &lt;= 0) <span class="keywordflow">break</span>;
<a name="l00479"></a>00479         <span class="keyword">struct </span><a class="code" href="struct_sync_tree_worker_entry.html">SyncTreeWorkerEntry</a> *ent = <a class="code" href="_sync_tree_worker_8c.html#a776013fec43bda3e07895da7e668f05a">SyncTreeWorkerTop</a>(twHead);
<a name="l00480"></a>00480         <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#aa98b86e01f36d39897ed843711728a36">cacheEntry</a>;
<a name="l00481"></a>00481         <span class="keywordflow">if</span> (ce == NULL)
<a name="l00482"></a>00482             <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#a3bb2d2b15c7a550960f237975f4d27b6">abortCompare</a>(sdd, <span class="stringliteral">&quot;bad cache entry&quot;</span>);
<a name="l00483"></a>00483         <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a543f8cfea4a3c99237abeac7e563b90b" title="remote node is being fetched">SyncHashState_fetching</a>) {
<a name="l00484"></a>00484             <span class="comment">// already underway</span>
<a name="l00485"></a>00485             incomplete++;
<a name="l00486"></a>00486         } <span class="keywordflow">else</span> {
<a name="l00487"></a>00487             <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *nc = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a>;
<a name="l00488"></a>00488             <span class="keywordflow">if</span> (nc == NULL) nc = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a>;
<a name="l00489"></a>00489             <span class="keywordflow">if</span> (nc != NULL) {
<a name="l00490"></a>00490                 <span class="comment">// we can visit the children</span>
<a name="l00491"></a>00491                 <span class="keywordtype">int</span> lim = nc-&gt;<a class="code" href="struct_sync_node_composite.html#a29c915fd509d8e74edf1d862f357915a" title="number of references">refLen</a>;
<a name="l00492"></a>00492                 <span class="keywordflow">while</span> (ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a> &lt; lim) {
<a name="l00493"></a>00493                     <span class="comment">// push into node refs that need fetching</span>
<a name="l00494"></a>00494                     <span class="keyword">struct </span><a class="code" href="struct_sync_node_elem.html">SyncNodeElem</a> *ep = &amp;nc-&gt;<a class="code" href="struct_sync_node_composite.html#a2d6c08c55513380b341cf6ef74aab2d5" title="pointer to references array">refs</a>[ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>];
<a name="l00495"></a>00495                     <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="struct_sync_node_elem.html#a770ab2553870198f1b5dbc1a7302eccb" title="leaf/composite flag">kind</a> == <a class="code" href="_sync_node_8h.html#ab268103cfe0f550f6c750922e68b4706a4ee0bed023456d8699399116bfd2858b" title="node">SyncElemKind_node</a>) {
<a name="l00496"></a>00496                         <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *sub = <a class="code" href="sync__diff_8c.html#ae36b30555d09158a5fae4d8658d49fe1">cacheEntryForElem</a>(sdd, nc, ep);
<a name="l00497"></a>00497                         <span class="keywordflow">if</span> (sub == NULL)
<a name="l00498"></a>00498                             <span class="comment">// really broken, somehow</span>
<a name="l00499"></a>00499                             <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#a3bb2d2b15c7a550960f237975f4d27b6">abortCompare</a>(sdd, <span class="stringliteral">&quot;bad cache entry&quot;</span>);
<a name="l00500"></a>00500                         <span class="comment">// push into the node to visit the children</span>
<a name="l00501"></a>00501                         ent = <a class="code" href="_sync_tree_worker_8c.html#a10a364304f0c94e2e44252cf24ed6572" title="pushes into the node at the current position">SyncTreeWorkerPush</a>(twHead);
<a name="l00502"></a>00502                         <span class="keywordflow">if</span> (ent == NULL)
<a name="l00503"></a>00503                             <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#a3bb2d2b15c7a550960f237975f4d27b6">abortCompare</a>(sdd, <span class="stringliteral">&quot;bad push&quot;</span>);
<a name="l00504"></a>00504                         <span class="keywordflow">goto</span> Advance;
<a name="l00505"></a>00505                     }
<a name="l00506"></a>00506                     ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l00507"></a>00507                 }
<a name="l00508"></a>00508             } <span class="keywordflow">else</span> {
<a name="l00509"></a>00509                 <span class="comment">// we need to start a fetch</span>
<a name="l00510"></a>00510                 <span class="keywordtype">int</span> res = <a class="code" href="sync__diff_8c.html#ae7e18f957924a160ff1b68a328aadf85">start_node_fetch</a>(sdd, ce, side);
<a name="l00511"></a>00511                 <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a> != NULL || ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a> != NULL)
<a name="l00512"></a>00512                     <span class="comment">// we scored using a local fetch, so loop to try again</span>
<a name="l00513"></a>00513                     <span class="keywordflow">continue</span>;
<a name="l00514"></a>00514                 <span class="keywordflow">if</span> (res &gt; 0)
<a name="l00515"></a>00515                     <span class="comment">// fetch started, result not ready</span>
<a name="l00516"></a>00516                     <span class="keywordflow">return</span> 0;
<a name="l00517"></a>00517                 <span class="comment">// we failed to initiate a fetch</span>
<a name="l00518"></a>00518                 <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#a3bb2d2b15c7a550960f237975f4d27b6">abortCompare</a>(sdd, <span class="stringliteral">&quot;fetch failed&quot;</span>);
<a name="l00519"></a>00519             }
<a name="l00520"></a>00520         }
<a name="l00521"></a>00521         <span class="comment">// common exit to pop and iterate</span>
<a name="l00522"></a>00522         ent = <a class="code" href="_sync_tree_worker_8c.html#a0029e127047a93efbc28a7b93e1ae005" title="pops the stack and returns the top entry popping an empty stack has no effect and...">SyncTreeWorkerPop</a>(twHead);
<a name="l00523"></a>00523     Advance:
<a name="l00524"></a>00524         <span class="keywordflow">if</span> (ent != NULL) ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l00525"></a>00525     }
<a name="l00526"></a>00526     <span class="keywordflow">while</span> (sdd-&gt;<a class="code" href="structsync__diff__data.html#ab73d161b4048d7b47b90fc165460c2b6" title="number of busy remote node fetches">nodeFetchBusy</a> &lt; busyLim) {
<a name="l00527"></a>00527         <span class="comment">// restart the failed node fetches (while we can)</span>
<a name="l00528"></a>00528         <span class="keyword">struct </span><a class="code" href="structsync__diff__fetch__data.html">sync_diff_fetch_data</a> *fd = sdd-&gt;<a class="code" href="structsync__diff__data.html#a106732432ae0dc955f522dab508edc01" title="cache entries being fetched">fetchQ</a>;
<a name="l00529"></a>00529         <span class="keywordflow">if</span> (fd == NULL) <span class="keywordflow">break</span>;
<a name="l00530"></a>00530         sdd-&gt;<a class="code" href="structsync__diff__data.html#a106732432ae0dc955f522dab508edc01" title="cache entries being fetched">fetchQ</a> = fd-&gt;<a class="code" href="structsync__diff__fetch__data.html#a0996ee8ab9ca24a1b80bba72b9faf50f">next</a>;
<a name="l00531"></a>00531         fd-&gt;<a class="code" href="structsync__diff__fetch__data.html#a0996ee8ab9ca24a1b80bba72b9faf50f">next</a> = NULL;
<a name="l00532"></a>00532         <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = fd-&gt;<a class="code" href="structsync__diff__fetch__data.html#a8dbd1b4a1d501f88e83a7f0869abaee8">hash_cache_entry</a>;
<a name="l00533"></a>00533         <a class="code" href="sync__diff_8c.html#ae7e18f957924a160ff1b68a328aadf85">start_node_fetch</a>(sdd, ce, side);
<a name="l00534"></a>00534         <a class="code" href="sync__diff_8c.html#a7e6d6e49a77c4bbd419a15345182d344">freeFetchData</a>(fd);
<a name="l00535"></a>00535     }
<a name="l00536"></a>00536     
<a name="l00537"></a>00537     <span class="keywordflow">if</span> (sdd-&gt;<a class="code" href="structsync__diff__data.html#ab73d161b4048d7b47b90fc165460c2b6" title="number of busy remote node fetches">nodeFetchBusy</a> &gt; 0 || sdd-&gt;<a class="code" href="structsync__diff__data.html#a106732432ae0dc955f522dab508edc01" title="cache entries being fetched">fetchQ</a> != NULL) <span class="keywordflow">return</span> 0;
<a name="l00538"></a>00538     <span class="keywordflow">if</span> (twHead-&gt;<a class="code" href="struct_sync_tree_worker_head.html#ad3fbea62094d3a5e81e325f896e8a4df">level</a> &gt; 0 || incomplete) <span class="keywordflow">return</span> 0;
<a name="l00539"></a>00539     <span class="keywordflow">return</span> 1;
<a name="l00540"></a>00540 }
<a name="l00541"></a>00541 
<a name="l00542"></a>00542 <span class="comment">// call the client to add the name from R&#39;s current position (in sdd-&gt;cbY),</span>
<a name="l00543"></a>00543 <span class="comment">// then advance the tree worker for R</span>
<a name="l00544"></a>00544 <span class="comment">// return &lt; 0 to stop the comparison (without error)</span>
<a name="l00545"></a>00545 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00546"></a><a class="code" href="sync__diff_8c.html#acc9c042023c7de74dfb004cf3f4470de">00546</a> <a class="code" href="sync__diff_8c.html#acc9c042023c7de74dfb004cf3f4470de">addNameFromCompare</a>(<span class="keyword">struct</span> <a class="code" href="structsync__diff__data.html">sync_diff_data</a> *sdd) {
<a name="l00547"></a>00547     <span class="comment">//struct SyncRootStruct *root = sdd-&gt;root;</span>
<a name="l00548"></a>00548     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = sdd-&gt;<a class="code" href="structsync__diff__data.html#a03e23c9e9c1a157371f956e74292fa24" title="&amp;quot;remote&amp;quot; tree scratch">cbY</a>;
<a name="l00549"></a>00549     <span class="comment">// callback for new name</span>
<a name="l00550"></a>00550     <span class="keyword">struct </span><a class="code" href="struct_sync_tree_worker_entry.html">SyncTreeWorkerEntry</a> *tweR = <a class="code" href="_sync_tree_worker_8c.html#a776013fec43bda3e07895da7e668f05a">SyncTreeWorkerTop</a>(sdd-&gt;<a class="code" href="structsync__diff__data.html#aea271c342899152f5e314fdea4a26ab9" title="&amp;quot;remote&amp;quot; tree walker state">twY</a>);
<a name="l00551"></a>00551     <span class="keywordflow">if</span> (sdd-&gt;<a class="code" href="structsync__diff__data.html#a8c48a9c5ac1c18f27b6ea84e8c8a3f88">add_closure</a> != NULL &amp;&amp; sdd-&gt;<a class="code" href="structsync__diff__data.html#a8c48a9c5ac1c18f27b6ea84e8c8a3f88">add_closure</a>-&gt;<a class="code" href="structsync__diff__add__closure.html#a9fe212376ec8cb5f4ec35ccae87b7876">add</a> != NULL) {
<a name="l00552"></a>00552         <span class="keywordtype">int</span> res = sdd-&gt;<a class="code" href="structsync__diff__data.html#a8c48a9c5ac1c18f27b6ea84e8c8a3f88">add_closure</a>-&gt;<a class="code" href="structsync__diff__add__closure.html#a9fe212376ec8cb5f4ec35ccae87b7876">add</a>(sdd-&gt;<a class="code" href="structsync__diff__data.html#a8c48a9c5ac1c18f27b6ea84e8c8a3f88">add_closure</a>, name);
<a name="l00553"></a>00553         <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00554"></a>00554             sdd-&gt;<a class="code" href="structsync__diff__data.html#a67fc1283c7352412a50f417e07a855d9" title="summary state of comparison">state</a> = <a class="code" href="sync__diff_8h.html#ae0c609194fbe6e000ccea19e6591dd19af4843063aa987f6dcf5db4f0042b8de4">sync_diff_state_done</a>;
<a name="l00555"></a>00555             <span class="keywordflow">return</span> res;
<a name="l00556"></a>00556         }
<a name="l00557"></a>00557     }
<a name="l00558"></a>00558     <span class="comment">// advance R</span>
<a name="l00559"></a>00559     sdd-&gt;<a class="code" href="structsync__diff__data.html#a2b5e8bbacc8ece0572d43ce7101964c3" title="names added during this comparison">namesAdded</a>++;
<a name="l00560"></a>00560     tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l00561"></a>00561     tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#a1fe537a031485a9ca226ff4fc83d6aa3">count</a>++;
<a name="l00562"></a>00562     <span class="keywordflow">return</span> 1;
<a name="l00563"></a>00563 }
<a name="l00564"></a>00564 
<a name="l00565"></a>00565 <span class="comment">/*</span>
<a name="l00566"></a>00566 <span class="comment"> * doComparison(sdd) is a key routine, because it determines what is</span>
<a name="l00567"></a>00567 <span class="comment"> * present in sdd-&gt;twY that is not present in sdd-&gt;twX.  It does so by</span>
<a name="l00568"></a>00568 <span class="comment"> * walking the two trees, L and R, in increasing name order.  To gain efficiency</span>
<a name="l00569"></a>00569 <span class="comment"> * doComparison avoids examining nodes in R that are already covered, and nodes</span>
<a name="l00570"></a>00570 <span class="comment"> * in L that have been bypassed in the walk of R.</span>
<a name="l00571"></a>00571 <span class="comment"> *</span>
<a name="l00572"></a>00572 <span class="comment"> * Ideally doComparison allows determination of k differences in O(k*log(N))</span>
<a name="l00573"></a>00573 <span class="comment"> * steps, where N is the number of names in the union of L and R.  However, if</span>
<a name="l00574"></a>00574 <span class="comment"> * the tree structures differ significantly the cost can be as high as O(N).</span>
<a name="l00575"></a>00575 <span class="comment"> *</span>
<a name="l00576"></a>00576 <span class="comment"> * @returns &lt; 0 for failure, 0 for incomplete, and &gt; 0 for success</span>
<a name="l00577"></a>00577 <span class="comment"> */</span>
<a name="l00578"></a>00578 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00579"></a><a class="code" href="sync__diff_8c.html#a8795ec3504c2f70d327752e333038b4e">00579</a> <a class="code" href="sync__diff_8c.html#a8795ec3504c2f70d327752e333038b4e">doComparison</a>(<span class="keyword">struct</span> <a class="code" href="structsync__diff__data.html">sync_diff_data</a> *sdd) {
<a name="l00580"></a>00580     <span class="comment">//struct SyncRootStruct *root = sdd-&gt;root;</span>
<a name="l00581"></a>00581     <span class="keyword">struct </span><a class="code" href="struct_sync_tree_worker_head.html">SyncTreeWorkerHead</a> *twX = sdd-&gt;<a class="code" href="structsync__diff__data.html#a3f95b5a31ad339b0cd28f190288fe533" title="&amp;quot;local&amp;quot; tree walker state">twX</a>;
<a name="l00582"></a>00582     <span class="keyword">struct </span><a class="code" href="struct_sync_tree_worker_head.html">SyncTreeWorkerHead</a> *twY = sdd-&gt;<a class="code" href="structsync__diff__data.html#aea271c342899152f5e314fdea4a26ab9" title="&amp;quot;remote&amp;quot; tree walker state">twY</a>;
<a name="l00583"></a>00583     
<a name="l00584"></a>00584     <span class="keywordflow">for</span> (;;) {
<a name="l00585"></a>00585         <span class="keyword">struct </span><a class="code" href="struct_sync_tree_worker_entry.html">SyncTreeWorkerEntry</a> *tweR = <a class="code" href="_sync_tree_worker_8c.html#a776013fec43bda3e07895da7e668f05a">SyncTreeWorkerTop</a>(twY);
<a name="l00586"></a>00586         <span class="keywordflow">if</span> (tweR == NULL) {
<a name="l00587"></a>00587             <span class="comment">// the &quot;remote&quot; is done, so no more names to add</span>
<a name="l00588"></a>00588             <span class="keywordflow">return</span> 1;
<a name="l00589"></a>00589         }
<a name="l00590"></a>00590         <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceR = tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#aa98b86e01f36d39897ed843711728a36">cacheEntry</a>;
<a name="l00591"></a>00591         <span class="keywordflow">if</span> (ceR == NULL)
<a name="l00592"></a>00592             <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#ab315e023d432486f7c2b0966654b3c8c">comparisonFailed</a>(sdd, <span class="stringliteral">&quot;bad cache entry for R&quot;</span>, __LINE__);
<a name="l00593"></a>00593         ceR-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a6861960908cc217b639d3f1af6bbc520" title="time when entry last used in compare">lastUsed</a> = sdd-&gt;<a class="code" href="structsync__diff__data.html#aa134e2b168f70a1869f32f5ecb819f6d" title="time marker for last compare step entry">lastEnter</a>;
<a name="l00594"></a>00594         <span class="keywordflow">if</span> (tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a> == 0 &amp;&amp; <a class="code" href="sync__diff_8c.html#a870761b1ea0620fc7bf78e6a7c4a8fb3">isCovered</a>(ceR)) {
<a name="l00595"></a>00595             <span class="comment">// short cut, nothing in R we don&#39;t have</span>
<a name="l00596"></a>00596             <span class="keywordtype">size_t</span> c = tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#a1fe537a031485a9ca226ff4fc83d6aa3">count</a>;
<a name="l00597"></a>00597             tweR = <a class="code" href="_sync_tree_worker_8c.html#a0029e127047a93efbc28a7b93e1ae005" title="pops the stack and returns the top entry popping an empty stack has no effect and...">SyncTreeWorkerPop</a>(twY);
<a name="l00598"></a>00598             <span class="keywordflow">if</span> (tweR != NULL) {
<a name="l00599"></a>00599                 tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l00600"></a>00600                 tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#a1fe537a031485a9ca226ff4fc83d6aa3">count</a> += c;
<a name="l00601"></a>00601             }
<a name="l00602"></a>00602             <span class="keywordflow">continue</span>;
<a name="l00603"></a>00603         }
<a name="l00604"></a>00604         <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *ncR = ceR-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a>;
<a name="l00605"></a>00605         <span class="keywordflow">if</span> (ncR == NULL) ncR = ceR-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a>;
<a name="l00606"></a>00606         <span class="keywordflow">if</span> (ncR == NULL) {
<a name="l00607"></a>00607             <span class="comment">// &quot;remote&quot; node not present, so go get it</span>
<a name="l00608"></a>00608             <span class="keywordtype">int</span> nf = <a class="code" href="sync__diff_8c.html#ae7e18f957924a160ff1b68a328aadf85">start_node_fetch</a>(sdd, ceR, <a class="code" href="sync__diff_8h.html#a6e15e35d7afe80f23fa4bda464bc86bfa4f99506bd13ae2ecfa3b2d111e588326">sync_diff_Y</a>);
<a name="l00609"></a>00609             <span class="keywordflow">if</span> (nf &lt; 0)
<a name="l00610"></a>00610                 <span class="comment">// node fetch failed to initiate</span>
<a name="l00611"></a>00611                 <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#ab315e023d432486f7c2b0966654b3c8c">comparisonFailed</a>(sdd, <span class="stringliteral">&quot;bad node fetch for R&quot;</span>, __LINE__);
<a name="l00612"></a>00612             <span class="comment">// fetch started OK or no fetch needed</span>
<a name="l00613"></a>00613             <span class="keywordflow">if</span> (ceR-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a> == NULL &amp;&amp; ceR-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a> == NULL)
<a name="l00614"></a>00614                 <span class="comment">// hope to get it later</span>
<a name="l00615"></a>00615                 <span class="keywordflow">return</span> 0;
<a name="l00616"></a>00616             <span class="keywordflow">continue</span>;
<a name="l00617"></a>00617         }
<a name="l00618"></a>00618         <span class="keywordflow">if</span> (tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a> &gt;= ncR-&gt;<a class="code" href="struct_sync_node_composite.html#a29c915fd509d8e74edf1d862f357915a" title="number of references">refLen</a>) {
<a name="l00619"></a>00619             <span class="comment">// we just went off the end of the current remote node, so pop it</span>
<a name="l00620"></a>00620             <span class="comment">// skip over the processed element if we still have a node</span>
<a name="l00621"></a>00621             <span class="keywordtype">size_t</span> c = tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#a1fe537a031485a9ca226ff4fc83d6aa3">count</a>;
<a name="l00622"></a>00622             <span class="keywordflow">if</span> (c == 0) {
<a name="l00623"></a>00623                 <span class="comment">// nothing was added, so this node must be covered</span>
<a name="l00624"></a>00624                 <a class="code" href="sync__diff_8c.html#a8d981d346c90e43d3f8d9e52077e28ca">setCovered</a>(ceR);
<a name="l00625"></a>00625             }
<a name="l00626"></a>00626             tweR = <a class="code" href="_sync_tree_worker_8c.html#a0029e127047a93efbc28a7b93e1ae005" title="pops the stack and returns the top entry popping an empty stack has no effect and...">SyncTreeWorkerPop</a>(twY);
<a name="l00627"></a>00627             <span class="keywordflow">if</span> (tweR != NULL) {
<a name="l00628"></a>00628                 tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l00629"></a>00629                 tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#a1fe537a031485a9ca226ff4fc83d6aa3">count</a> += c;
<a name="l00630"></a>00630             }
<a name="l00631"></a>00631             <span class="keywordflow">continue</span>;
<a name="l00632"></a>00632         }
<a name="l00633"></a>00633         <span class="keyword">struct </span><a class="code" href="struct_sync_node_elem.html">SyncNodeElem</a> *neR = <a class="code" href="_sync_tree_worker_8c.html#a77931eb09ea49c8f1c460467e836336d" title="requires that the node be present">SyncTreeWorkerGetElem</a>(twY);
<a name="l00634"></a>00634         <span class="keywordflow">if</span> (neR == NULL || <a class="code" href="sync__diff_8c.html#aaf9c87ebf674e592c7bcb15aebbe937e">extractBuf</a>(sdd-&gt;<a class="code" href="structsync__diff__data.html#a03e23c9e9c1a157371f956e74292fa24" title="&amp;quot;remote&amp;quot; tree scratch">cbY</a>, ncR, neR) &lt; 0)
<a name="l00635"></a>00635             <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#ab315e023d432486f7c2b0966654b3c8c">comparisonFailed</a>(sdd, <span class="stringliteral">&quot;bad extract for R&quot;</span>, __LINE__);
<a name="l00636"></a>00636         
<a name="l00637"></a>00637         <span class="keyword">struct </span><a class="code" href="struct_sync_tree_worker_entry.html">SyncTreeWorkerEntry</a> *tweL = <a class="code" href="_sync_tree_worker_8c.html#a776013fec43bda3e07895da7e668f05a">SyncTreeWorkerTop</a>(twX);
<a name="l00638"></a>00638         <span class="keywordflow">if</span> (tweL == NULL) {
<a name="l00639"></a>00639             <span class="comment">// L is now empty, so add R</span>
<a name="l00640"></a>00640             <span class="keywordflow">if</span> (neR-&gt;<a class="code" href="struct_sync_node_elem.html#a770ab2553870198f1b5dbc1a7302eccb" title="leaf/composite flag">kind</a> == <a class="code" href="_sync_node_8h.html#ab268103cfe0f550f6c750922e68b4706a4ee0bed023456d8699399116bfd2858b" title="node">SyncElemKind_node</a>) {
<a name="l00641"></a>00641                 <span class="comment">// to add a node R, push into it</span>
<a name="l00642"></a>00642                 <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *subR = <a class="code" href="sync__diff_8c.html#ae36b30555d09158a5fae4d8658d49fe1">cacheEntryForElem</a>(sdd, ncR, neR);
<a name="l00643"></a>00643                 <span class="keywordflow">if</span> (subR == NULL || <a class="code" href="_sync_tree_worker_8c.html#a10a364304f0c94e2e44252cf24ed6572" title="pushes into the node at the current position">SyncTreeWorkerPush</a>(twY) == NULL)
<a name="l00644"></a>00644                     <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#ab315e023d432486f7c2b0966654b3c8c">comparisonFailed</a>(sdd, <span class="stringliteral">&quot;bad cache entry for R&quot;</span>, __LINE__);
<a name="l00645"></a>00645             } <span class="keywordflow">else</span> {
<a name="l00646"></a>00646                 <span class="comment">// R is a leaf, so add it (and advance R)</span>
<a name="l00647"></a>00647                 <span class="keywordflow">if</span> (<a class="code" href="sync__diff_8c.html#acc9c042023c7de74dfb004cf3f4470de">addNameFromCompare</a>(sdd) &lt; 0)
<a name="l00648"></a>00648                     <span class="keywordflow">return</span> 1;
<a name="l00649"></a>00649             }
<a name="l00650"></a>00650         } <span class="keywordflow">else</span> {
<a name="l00651"></a>00651             <span class="comment">// L and R are both not empty</span>
<a name="l00652"></a>00652             <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceL = tweL-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#aa98b86e01f36d39897ed843711728a36">cacheEntry</a>;
<a name="l00653"></a>00653             <span class="keywordflow">if</span> (ceL == NULL)
<a name="l00654"></a>00654                 <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#ab315e023d432486f7c2b0966654b3c8c">comparisonFailed</a>(sdd, <span class="stringliteral">&quot;bad cache entry for L&quot;</span>, __LINE__);
<a name="l00655"></a>00655             <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *ncL = ceL-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a>;
<a name="l00656"></a>00656             <span class="keywordflow">if</span> (ncL == NULL) ncL = ceL-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a>;
<a name="l00657"></a>00657             <span class="keywordflow">if</span> (ncL == NULL) {
<a name="l00658"></a>00658                 <span class="comment">// &quot;local&quot; node not present, so go get it</span>
<a name="l00659"></a>00659                 <span class="keywordtype">int</span> nf = <a class="code" href="sync__diff_8c.html#ae7e18f957924a160ff1b68a328aadf85">start_node_fetch</a>(sdd, ceL, <a class="code" href="sync__diff_8h.html#a6e15e35d7afe80f23fa4bda464bc86bfa73be5c5095f769655c3d5f621c45b40a">sync_diff_X</a>);
<a name="l00660"></a>00660                 <span class="keywordflow">if</span> (nf &lt; 0) {
<a name="l00661"></a>00661                     <span class="comment">// node fetch failed to initiate</span>
<a name="l00662"></a>00662                     <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#ab315e023d432486f7c2b0966654b3c8c">comparisonFailed</a>(sdd, <span class="stringliteral">&quot;bad node fetch for L&quot;</span>, __LINE__);
<a name="l00663"></a>00663                 }
<a name="l00664"></a>00664                 <span class="comment">// fetch started OK or no fetch needed</span>
<a name="l00665"></a>00665                 <span class="keywordflow">if</span> (ceL-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a> == NULL &amp;&amp; ceL-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a> == NULL)
<a name="l00666"></a>00666                     <span class="comment">// hope to get it later</span>
<a name="l00667"></a>00667                     <span class="keywordflow">return</span> 0;
<a name="l00668"></a>00668                 <span class="keywordflow">continue</span>;
<a name="l00669"></a>00669             }
<a name="l00670"></a>00670             <span class="comment">// both L and R nodes are present</span>
<a name="l00671"></a>00671             ceL-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a6861960908cc217b639d3f1af6bbc520" title="time when entry last used in compare">lastUsed</a> = sdd-&gt;<a class="code" href="structsync__diff__data.html#aa134e2b168f70a1869f32f5ecb819f6d" title="time marker for last compare step entry">lastEnter</a>;
<a name="l00672"></a>00672             <span class="keywordflow">if</span> (tweL-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a> &gt;= ncL-&gt;<a class="code" href="struct_sync_node_composite.html#a29c915fd509d8e74edf1d862f357915a" title="number of references">refLen</a>) {
<a name="l00673"></a>00673                 <span class="comment">// we just went off the end of the current local node, so pop it</span>
<a name="l00674"></a>00674                 tweL = <a class="code" href="_sync_tree_worker_8c.html#a0029e127047a93efbc28a7b93e1ae005" title="pops the stack and returns the top entry popping an empty stack has no effect and...">SyncTreeWorkerPop</a>(twX);
<a name="l00675"></a>00675                 <span class="keywordflow">if</span> (tweL != NULL) tweL-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l00676"></a>00676                 <span class="keywordflow">continue</span>;
<a name="l00677"></a>00677             }
<a name="l00678"></a>00678             <span class="comment">// both L and R nodes are present, and both have remaining elements</span>
<a name="l00679"></a>00679             <span class="comment">// subR and subL are the elements</span>
<a name="l00680"></a>00680             <span class="keyword">struct </span><a class="code" href="struct_sync_node_elem.html">SyncNodeElem</a> *neL = <a class="code" href="_sync_tree_worker_8c.html#a77931eb09ea49c8f1c460467e836336d" title="requires that the node be present">SyncTreeWorkerGetElem</a>(twX);
<a name="l00681"></a>00681             <span class="keywordflow">if</span> (neL == NULL || <a class="code" href="sync__diff_8c.html#aaf9c87ebf674e592c7bcb15aebbe937e">extractBuf</a>(sdd-&gt;<a class="code" href="structsync__diff__data.html#a26751453e1f6d08681032db803534d4c" title="&amp;quot;local&amp;quot; tree scratch">cbX</a>, ncL, neL) &lt; 0) {
<a name="l00682"></a>00682                 <span class="comment">// the local name/hash extract failed</span>
<a name="l00683"></a>00683                 <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#ab315e023d432486f7c2b0966654b3c8c">comparisonFailed</a>(sdd, <span class="stringliteral">&quot;bad extract for L&quot;</span>, __LINE__);
<a name="l00684"></a>00684             }
<a name="l00685"></a>00685             <span class="keywordflow">if</span> (neR-&gt;<a class="code" href="struct_sync_node_elem.html#a770ab2553870198f1b5dbc1a7302eccb" title="leaf/composite flag">kind</a> == <a class="code" href="_sync_node_8h.html#ab268103cfe0f550f6c750922e68b4706a4ee0bed023456d8699399116bfd2858b" title="node">SyncElemKind_node</a>) {
<a name="l00686"></a>00686                 <span class="comment">// subR is a node</span>
<a name="l00687"></a>00687                 <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *subR = <a class="code" href="sync__diff_8c.html#ae36b30555d09158a5fae4d8658d49fe1">cacheEntryForElem</a>(sdd, ncR, neR);
<a name="l00688"></a>00688                 <span class="keywordflow">if</span> (subR == NULL)
<a name="l00689"></a>00689                     <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#ab315e023d432486f7c2b0966654b3c8c">comparisonFailed</a>(sdd, <span class="stringliteral">&quot;bad element for R&quot;</span>, __LINE__);
<a name="l00690"></a>00690                 <span class="keywordflow">if</span> (<a class="code" href="sync__diff_8c.html#a870761b1ea0620fc7bf78e6a7c4a8fb3">isCovered</a>(subR)) {
<a name="l00691"></a>00691                     <span class="comment">// nothing to add, this node is already covered</span>
<a name="l00692"></a>00692                     <span class="comment">// note: this works even if the remote node is not present!</span>
<a name="l00693"></a>00693                     tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l00694"></a>00694                     <span class="keywordflow">continue</span>;
<a name="l00695"></a>00695                 }
<a name="l00696"></a>00696                 <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *ncS = subR-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a>;
<a name="l00697"></a>00697                 <span class="keywordflow">if</span> (ncS == NULL) ncS = subR-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a>;
<a name="l00698"></a>00698                 <span class="keywordflow">if</span> (ncS == NULL) {
<a name="l00699"></a>00699                     <span class="comment">// there is a remote hash, but no node present,</span>
<a name="l00700"></a>00700                     <span class="comment">// so push into it to force the fetch</span>
<a name="l00701"></a>00701                     <span class="keywordflow">if</span> (<a class="code" href="_sync_tree_worker_8c.html#a10a364304f0c94e2e44252cf24ed6572" title="pushes into the node at the current position">SyncTreeWorkerPush</a>(twY) == NULL)
<a name="l00702"></a>00702                         <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#ab315e023d432486f7c2b0966654b3c8c">comparisonFailed</a>(sdd, <span class="stringliteral">&quot;bad push for R&quot;</span>, __LINE__);
<a name="l00703"></a>00703                     <span class="keywordflow">continue</span>;
<a name="l00704"></a>00704                 }
<a name="l00705"></a>00705                 
<a name="l00706"></a>00706                 <span class="keywordflow">if</span> (neL-&gt;<a class="code" href="struct_sync_node_elem.html#a770ab2553870198f1b5dbc1a7302eccb" title="leaf/composite flag">kind</a> == <a class="code" href="_sync_node_8h.html#ab268103cfe0f550f6c750922e68b4706a814b9a3505f28764701d289e71b8a649" title="leaf">SyncElemKind_leaf</a>) {
<a name="l00707"></a>00707                     <span class="comment">// subL is a leaf, subR is a node that is present</span>
<a name="l00708"></a>00708                     <span class="keyword">enum</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64">SyncCompareResult</a> scr = <a class="code" href="_sync_node_8c.html#ace5e85a8d920773cb68e947238f2448a" title="Compares a name against the min and max names in the node.">SyncNodeCompareMinMax</a>(ncS, sdd-&gt;<a class="code" href="structsync__diff__data.html#a26751453e1f6d08681032db803534d4c" title="&amp;quot;local&amp;quot; tree scratch">cbX</a>);
<a name="l00709"></a>00709                     <span class="keywordflow">switch</span> (scr) {
<a name="l00710"></a>00710                         <span class="keywordflow">case</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64a0c33200977bb75a132aa6fdcfc354ea4">SCR_before</a>:
<a name="l00711"></a>00711                             <span class="comment">// L &lt; Min(R), so advance L</span>
<a name="l00712"></a>00712                             tweL-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l00713"></a>00713                             <span class="keywordflow">break</span>;
<a name="l00714"></a>00714                         <span class="keywordflow">case</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64a7a3a53a61272e732e13e4a229a73dab8">SCR_max</a>:
<a name="l00715"></a>00715                             <span class="comment">// L == Max(R), advance both</span>
<a name="l00716"></a>00716                             tweL-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l00717"></a>00717                             tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l00718"></a>00718                             <span class="keywordflow">break</span>;
<a name="l00719"></a>00719                         <span class="keywordflow">default</span>:
<a name="l00720"></a>00720                             <span class="comment">// in all other cases, dive into R</span>
<a name="l00721"></a>00721                             <span class="keywordflow">if</span> (<a class="code" href="_sync_tree_worker_8c.html#a10a364304f0c94e2e44252cf24ed6572" title="pushes into the node at the current position">SyncTreeWorkerPush</a>(twY) == NULL)
<a name="l00722"></a>00722                                 <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#ab315e023d432486f7c2b0966654b3c8c">comparisonFailed</a>(sdd, <span class="stringliteral">&quot;bad push for R&quot;</span>, __LINE__);
<a name="l00723"></a>00723                             <span class="keywordflow">break</span>;
<a name="l00724"></a>00724                     }
<a name="l00725"></a>00725                     
<a name="l00726"></a>00726                 } <span class="keywordflow">else</span> {
<a name="l00727"></a>00727                     <span class="comment">// both subL and subR are nodes</span>
<a name="l00728"></a>00728                     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *subL = <a class="code" href="sync__diff_8c.html#ae36b30555d09158a5fae4d8658d49fe1">cacheEntryForElem</a>(sdd, ncL, neL);
<a name="l00729"></a>00729                     <span class="keywordflow">if</span> (subL == NULL)
<a name="l00730"></a>00730                         <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#ab315e023d432486f7c2b0966654b3c8c">comparisonFailed</a>(sdd, <span class="stringliteral">&quot;bad cache entry for L&quot;</span>, __LINE__);
<a name="l00731"></a>00731                     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *subR = <a class="code" href="sync__diff_8c.html#ae36b30555d09158a5fae4d8658d49fe1">cacheEntryForElem</a>(sdd, ncR, neR);
<a name="l00732"></a>00732                     <span class="keywordflow">if</span> (subR == NULL)
<a name="l00733"></a>00733                         <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#ab315e023d432486f7c2b0966654b3c8c">comparisonFailed</a>(sdd, <span class="stringliteral">&quot;bad cache entry for R&quot;</span>, __LINE__);
<a name="l00734"></a>00734                     
<a name="l00735"></a>00735                     <span class="comment">// both L and R are nodes, and both have cache entries</span>
<a name="l00736"></a>00736                     <span class="keywordflow">if</span> (subL == subR) {
<a name="l00737"></a>00737                         <span class="comment">// same hashes, so same contents, so advance both</span>
<a name="l00738"></a>00738                         tweL-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l00739"></a>00739                         tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l00740"></a>00740                     } <span class="keywordflow">else</span> {
<a name="l00741"></a>00741                         <span class="comment">// different hashes, try for the children</span>
<a name="l00742"></a>00742                         <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *sncL = subL-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a>;
<a name="l00743"></a>00743                         <span class="keywordflow">if</span> (sncL == NULL) sncL = subL-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a>;
<a name="l00744"></a>00744                         <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *sncR = subR-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a>;
<a name="l00745"></a>00745                         <span class="keywordflow">if</span> (sncR == NULL) sncR = subR-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a>;
<a name="l00746"></a>00746                         <span class="keywordflow">if</span> (sncL == NULL) {
<a name="l00747"></a>00747                             <span class="comment">// no node for subL</span>
<a name="l00748"></a>00748                             <span class="keywordflow">if</span> (<a class="code" href="_sync_tree_worker_8c.html#a10a364304f0c94e2e44252cf24ed6572" title="pushes into the node at the current position">SyncTreeWorkerPush</a>(twX) == NULL)
<a name="l00749"></a>00749                                 <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#ab315e023d432486f7c2b0966654b3c8c">comparisonFailed</a>(sdd, <span class="stringliteral">&quot;bad push for L&quot;</span>, __LINE__);
<a name="l00750"></a>00750                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sncR == NULL) {
<a name="l00751"></a>00751                             <span class="comment">// no node for subR</span>
<a name="l00752"></a>00752                             <span class="keywordflow">if</span> (<a class="code" href="_sync_tree_worker_8c.html#a10a364304f0c94e2e44252cf24ed6572" title="pushes into the node at the current position">SyncTreeWorkerPush</a>(twY) == NULL)
<a name="l00753"></a>00753                                 <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#ab315e023d432486f7c2b0966654b3c8c">comparisonFailed</a>(sdd, <span class="stringliteral">&quot;bad push for R&quot;</span>, __LINE__);
<a name="l00754"></a>00754                         } <span class="keywordflow">else</span> {
<a name="l00755"></a>00755                             <span class="comment">// now use the name bounds comparison to skip work (if possible)</span>
<a name="l00756"></a>00756                             <span class="keywordtype">int</span> cmp = <a class="code" href="_sync_util_8c.html#a83e5cd9675cc633d9504bd3ee7c8f025">SyncCmpNames</a>(sncR-&gt;<a class="code" href="struct_sync_node_composite.html#a3c48241aa540c2dbae4a5a1f1cbb5b66" title="minimum name">minName</a>, sncL-&gt;<a class="code" href="struct_sync_node_composite.html#ada7af45eaf5373b0a25e7cc943f883c0" title="maximum name">maxName</a>);
<a name="l00757"></a>00757                             <span class="keywordflow">if</span> (cmp &gt; 0) {
<a name="l00758"></a>00758                                 <span class="comment">// Min(subR) &gt; Max(subL), so advance subL</span>
<a name="l00759"></a>00759                                 tweL-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l00760"></a>00760                             } <span class="keywordflow">else</span> {
<a name="l00761"></a>00761                                 <span class="comment">// dive into both nodes</span>
<a name="l00762"></a>00762                                 <span class="keywordflow">if</span> (<a class="code" href="_sync_tree_worker_8c.html#a10a364304f0c94e2e44252cf24ed6572" title="pushes into the node at the current position">SyncTreeWorkerPush</a>(twX) == NULL)
<a name="l00763"></a>00763                                     <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#ab315e023d432486f7c2b0966654b3c8c">comparisonFailed</a>(sdd, <span class="stringliteral">&quot;bad push for L&quot;</span>, __LINE__);
<a name="l00764"></a>00764                                 <span class="keywordflow">if</span> (<a class="code" href="_sync_tree_worker_8c.html#a10a364304f0c94e2e44252cf24ed6572" title="pushes into the node at the current position">SyncTreeWorkerPush</a>(twY) == NULL)
<a name="l00765"></a>00765                                     <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#ab315e023d432486f7c2b0966654b3c8c">comparisonFailed</a>(sdd, <span class="stringliteral">&quot;bad push for R&quot;</span>, __LINE__);
<a name="l00766"></a>00766                             }
<a name="l00767"></a>00767                         }
<a name="l00768"></a>00768                     }
<a name="l00769"></a>00769                 }
<a name="l00770"></a>00770             } <span class="keywordflow">else</span> {
<a name="l00771"></a>00771                 <span class="comment">// R is a leaf</span>
<a name="l00772"></a>00772                 <span class="keywordflow">if</span> (neL-&gt;<a class="code" href="struct_sync_node_elem.html#a770ab2553870198f1b5dbc1a7302eccb" title="leaf/composite flag">kind</a> == <a class="code" href="_sync_node_8h.html#ab268103cfe0f550f6c750922e68b4706a814b9a3505f28764701d289e71b8a649" title="leaf">SyncElemKind_leaf</a>) {
<a name="l00773"></a>00773                     <span class="comment">// both L and R are names, so the compare is simple</span>
<a name="l00774"></a>00774                     <span class="keywordtype">int</span> cmp = <a class="code" href="_sync_util_8c.html#a83e5cd9675cc633d9504bd3ee7c8f025">SyncCmpNames</a>(sdd-&gt;<a class="code" href="structsync__diff__data.html#a26751453e1f6d08681032db803534d4c" title="&amp;quot;local&amp;quot; tree scratch">cbX</a>, sdd-&gt;<a class="code" href="structsync__diff__data.html#a03e23c9e9c1a157371f956e74292fa24" title="&amp;quot;remote&amp;quot; tree scratch">cbY</a>);
<a name="l00775"></a>00775                     <span class="keywordflow">if</span> (cmp == 0) {
<a name="l00776"></a>00776                         <span class="comment">// L == R, so advance both</span>
<a name="l00777"></a>00777                         tweL-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l00778"></a>00778                         tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l00779"></a>00779                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmp &lt; 0) {
<a name="l00780"></a>00780                         <span class="comment">// L &lt; R, advance L</span>
<a name="l00781"></a>00781                         tweL-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l00782"></a>00782                     } <span class="keywordflow">else</span> {
<a name="l00783"></a>00783                         <span class="comment">// L &gt; R, so add R (and advance R)</span>
<a name="l00784"></a>00784                         <span class="keywordflow">if</span> (<a class="code" href="sync__diff_8c.html#acc9c042023c7de74dfb004cf3f4470de">addNameFromCompare</a>(sdd) &lt; 0)
<a name="l00785"></a>00785                             <span class="keywordflow">return</span> 1;
<a name="l00786"></a>00786                     }
<a name="l00787"></a>00787                 } <span class="keywordflow">else</span> {
<a name="l00788"></a>00788                     <span class="comment">// R is a leaf, but L is a node</span>
<a name="l00789"></a>00789                     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *subL = <a class="code" href="sync__diff_8c.html#ae36b30555d09158a5fae4d8658d49fe1">cacheEntryForElem</a>(sdd, ncL, neL);
<a name="l00790"></a>00790                     <span class="keywordflow">if</span> (subL == NULL)
<a name="l00791"></a>00791                         <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#ab315e023d432486f7c2b0966654b3c8c">comparisonFailed</a>(sdd, <span class="stringliteral">&quot;bad cache entry for L&quot;</span>, __LINE__);
<a name="l00792"></a>00792                     <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *sncL = subL-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a>;
<a name="l00793"></a>00793                     <span class="keywordflow">if</span> (sncL == NULL) sncL = subL-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a>;
<a name="l00794"></a>00794                     <span class="keywordflow">if</span> (sncL == NULL)
<a name="l00795"></a>00795                         <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#ab315e023d432486f7c2b0966654b3c8c">comparisonFailed</a>(sdd, <span class="stringliteral">&quot;sncL == NULL&quot;</span>, __LINE__);
<a name="l00796"></a>00796                     <span class="keyword">enum</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64">SyncCompareResult</a> scr = <a class="code" href="_sync_node_8c.html#ace5e85a8d920773cb68e947238f2448a" title="Compares a name against the min and max names in the node.">SyncNodeCompareMinMax</a>(sncL, sdd-&gt;<a class="code" href="structsync__diff__data.html#a03e23c9e9c1a157371f956e74292fa24" title="&amp;quot;remote&amp;quot; tree scratch">cbY</a>);
<a name="l00797"></a>00797                     <span class="keywordflow">switch</span> (scr) {
<a name="l00798"></a>00798                         <span class="keywordflow">case</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64a0c33200977bb75a132aa6fdcfc354ea4">SCR_before</a>:
<a name="l00799"></a>00799                             <span class="comment">// R &lt; Min(L), so add R (and advance R)</span>
<a name="l00800"></a>00800                             <span class="keywordflow">if</span> (<a class="code" href="sync__diff_8c.html#acc9c042023c7de74dfb004cf3f4470de">addNameFromCompare</a>(sdd) &lt; 0)
<a name="l00801"></a>00801                                 <span class="keywordflow">return</span> 1;
<a name="l00802"></a>00802                             <span class="keywordflow">break</span>;
<a name="l00803"></a>00803                         <span class="keywordflow">case</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64a7a3a53a61272e732e13e4a229a73dab8">SCR_max</a>:
<a name="l00804"></a>00804                             <span class="comment">// R == Max(L), advance both</span>
<a name="l00805"></a>00805                             tweL-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l00806"></a>00806                             tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l00807"></a>00807                             <span class="keywordflow">break</span>;
<a name="l00808"></a>00808                         <span class="keywordflow">case</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64ae59232c058740e4c8407b05a3d2a30f7">SCR_min</a>:
<a name="l00809"></a>00809                             <span class="comment">// R == Min(L), advance R</span>
<a name="l00810"></a>00810                             tweR-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l00811"></a>00811                             <span class="keywordflow">break</span>;
<a name="l00812"></a>00812                         <span class="keywordflow">case</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64a40ed003d6315e67fb76e3a251c61bf8b">SCR_after</a>:
<a name="l00813"></a>00813                             <span class="comment">// R &gt; Max(L), advance L</span>
<a name="l00814"></a>00814                             tweL-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l00815"></a>00815                             <span class="keywordflow">break</span>;
<a name="l00816"></a>00816                         <span class="keywordflow">case</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64a2c9d0ac245c2e225518313dfa540899b">SCR_inside</a>:
<a name="l00817"></a>00817                             <span class="comment">// Min(L) &lt; R &lt; Max(L), so dive into L</span>
<a name="l00818"></a>00818                             <span class="keywordflow">if</span> (<a class="code" href="_sync_tree_worker_8c.html#a10a364304f0c94e2e44252cf24ed6572" title="pushes into the node at the current position">SyncTreeWorkerPush</a>(twX) == NULL)
<a name="l00819"></a>00819                                 <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#ab315e023d432486f7c2b0966654b3c8c">comparisonFailed</a>(sdd, <span class="stringliteral">&quot;bad push for L&quot;</span>, __LINE__);
<a name="l00820"></a>00820                             <span class="keywordflow">break</span>;
<a name="l00821"></a>00821                         <span class="keywordflow">default</span>:
<a name="l00822"></a>00822                             <span class="comment">// this is really broken</span>
<a name="l00823"></a>00823                             <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#ab315e023d432486f7c2b0966654b3c8c">comparisonFailed</a>(sdd, <span class="stringliteral">&quot;bad min/max compare&quot;</span>, __LINE__);
<a name="l00824"></a>00824                     }
<a name="l00825"></a>00825                     
<a name="l00826"></a>00826                 }
<a name="l00827"></a>00827             }
<a name="l00828"></a>00828         }
<a name="l00829"></a>00829     }
<a name="l00830"></a>00830 }
<a name="l00831"></a>00831 
<a name="l00832"></a>00832 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00833"></a><a class="code" href="sync__diff_8c.html#a31715d7e9f5852d90ca9b6d5a2d16986">00833</a> <a class="code" href="sync__diff_8c.html#a31715d7e9f5852d90ca9b6d5a2d16986">compareAction</a>(<span class="keyword">struct</span> ccn_schedule *sched,
<a name="l00834"></a>00834               <span class="keywordtype">void</span> *clienth,
<a name="l00835"></a>00835               <span class="keyword">struct</span> <a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev,
<a name="l00836"></a>00836               <span class="keywordtype">int</span> flags) {
<a name="l00837"></a>00837     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.compareAction&quot;</span>;
<a name="l00838"></a>00838     <span class="keyword">struct </span><a class="code" href="structsync__diff__data.html">sync_diff_data</a> *sdd = (<span class="keyword">struct </span><a class="code" href="structsync__diff__data.html">sync_diff_data</a> *) ev-&gt;<a class="code" href="structccn__scheduled__event.html#a4f4c36335e9001eaca5442f672798e95">evdata</a>;
<a name="l00839"></a>00839     <span class="keywordtype">int</span> res = -1;
<a name="l00840"></a>00840     
<a name="l00841"></a>00841     if (sdd == NULL) {
<a name="l00842"></a>00842         <span class="comment">// invalid, not sure how we got here, can&#39;t report</span>
<a name="l00843"></a>00843         <span class="keywordflow">return</span> -1;
<a name="l00844"></a>00844     }
<a name="l00845"></a>00845     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = sdd-&gt;<a class="code" href="structsync__diff__data.html#a4c835d54dc03229f2856a1e0966b0d1c">root</a>;
<a name="l00846"></a>00846     sdd-&gt;<a class="code" href="structsync__diff__data.html#aa134e2b168f70a1869f32f5ecb819f6d" title="time marker for last compare step entry">lastEnter</a> = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l00847"></a>00847     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l00848"></a>00848     <span class="keywordflow">if</span> (sdd-&gt;<a class="code" href="structsync__diff__data.html#a10ee698bc4a7227ceb48d52f9d113600" title="progress event">ev</a> != ev) {
<a name="l00849"></a>00849         <span class="comment">// orphaned?</span>
<a name="l00850"></a>00850         <span class="keywordflow">return</span> -1;
<a name="l00851"></a>00851     }
<a name="l00852"></a>00852     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="schedule_8h.html#a705b7a47118864084280c615c0e6a2de">CCN_SCHEDULE_CANCEL</a>) {
<a name="l00853"></a>00853         <span class="comment">// cancelled (rescheduled)</span>
<a name="l00854"></a>00854         sdd-&gt;<a class="code" href="structsync__diff__data.html#a10ee698bc4a7227ceb48d52f9d113600" title="progress event">ev</a> = NULL;
<a name="l00855"></a>00855         <span class="keywordflow">return</span> -1;
<a name="l00856"></a>00856     }
<a name="l00857"></a>00857     
<a name="l00858"></a>00858     <span class="keywordtype">int</span> delay = 1000; <span class="comment">// microseconds</span>
<a name="l00859"></a>00859     <span class="keywordflow">if</span> (sdd-&gt;<a class="code" href="structsync__diff__data.html#a2570461f217f175955736961a677216d" title="number of failed remote node fetches">nodeFetchFailed</a> &gt; 0)
<a name="l00860"></a>00860         <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#a3bb2d2b15c7a550960f237975f4d27b6">abortCompare</a>(sdd, <span class="stringliteral">&quot;node fetch failed&quot;</span>);
<a name="l00861"></a>00861     <span class="keywordflow">switch</span> (sdd-&gt;<a class="code" href="structsync__diff__data.html#a67fc1283c7352412a50f417e07a855d9" title="summary state of comparison">state</a>) {
<a name="l00862"></a>00862         <span class="keywordflow">case</span> <a class="code" href="sync__diff_8h.html#ae0c609194fbe6e000ccea19e6591dd19a6443961c8f5bd345cb1d099c1a3c7555">sync_diff_state_init</a>: {
<a name="l00863"></a>00863             <span class="comment">// nothing to do, flow into next state</span>
<a name="l00864"></a>00864             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l00865"></a>00865                 <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceX = <a class="code" href="sync__diff_8c.html#a6eea619c02366baa2c0f7391a3d331f2">entryForHash</a>(root, sdd-&gt;<a class="code" href="structsync__diff__data.html#a5997cd58b4376ccf9f71e4bd7a454d1c">hashX</a>);
<a name="l00866"></a>00866                 <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceY = <a class="code" href="sync__diff_8c.html#a6eea619c02366baa2c0f7391a3d331f2">entryForHash</a>(root, sdd-&gt;<a class="code" href="structsync__diff__data.html#a55e8315cc447c98fca09ade2acd8ff23">hashY</a>);
<a name="l00867"></a>00867                 <a class="code" href="sync__diff_8c.html#a693571491e7f8b307640238175b6aa57">showCacheEntry2</a>(root, here, <span class="stringliteral">&quot;at init&quot;</span>, ceX, ceY);
<a name="l00868"></a>00868             }
<a name="l00869"></a>00869             <a class="code" href="sync__diff_8c.html#aa6a3bb3fd352266999d3ff44c18f4488">initWorkerFromHash</a>(root, sdd-&gt;<a class="code" href="structsync__diff__data.html#a3f95b5a31ad339b0cd28f190288fe533" title="&amp;quot;local&amp;quot; tree walker state">twX</a>, sdd-&gt;<a class="code" href="structsync__diff__data.html#a5997cd58b4376ccf9f71e4bd7a454d1c">hashX</a>);
<a name="l00870"></a>00870             <a class="code" href="sync__diff_8c.html#aa6a3bb3fd352266999d3ff44c18f4488">initWorkerFromHash</a>(root, sdd-&gt;<a class="code" href="structsync__diff__data.html#aea271c342899152f5e314fdea4a26ab9" title="&amp;quot;remote&amp;quot; tree walker state">twY</a>, sdd-&gt;<a class="code" href="structsync__diff__data.html#a55e8315cc447c98fca09ade2acd8ff23">hashY</a>);
<a name="l00871"></a>00871             sdd-&gt;<a class="code" href="structsync__diff__data.html#a67fc1283c7352412a50f417e07a855d9" title="summary state of comparison">state</a> = <a class="code" href="sync__diff_8h.html#ae0c609194fbe6e000ccea19e6591dd19aedd95a178d4f8beca50d05ae01589bc8">sync_diff_state_preload</a>;
<a name="l00872"></a>00872         }
<a name="l00873"></a>00873         <span class="keywordflow">case</span> <a class="code" href="sync__diff_8h.html#ae0c609194fbe6e000ccea19e6591dd19aedd95a178d4f8beca50d05ae01589bc8">sync_diff_state_preload</a>:
<a name="l00874"></a>00874             <span class="comment">// nothing to do (yet), flow into next state</span>
<a name="l00875"></a>00875             delay = 2000000;
<a name="l00876"></a>00876             <span class="comment">// For library, need to preload for Local as well as Remote.</span>
<a name="l00877"></a>00877             <span class="keywordtype">int</span> resX = <a class="code" href="sync__diff_8c.html#a3525d6b09b95889fc98472f40e9f93b0" title="doPreload(sdd) walks the given tree, and requests a fetch for every node that is...">doPreload</a>(sdd, sdd-&gt;<a class="code" href="structsync__diff__data.html#a3f95b5a31ad339b0cd28f190288fe533" title="&amp;quot;local&amp;quot; tree walker state">twX</a>, <a class="code" href="sync__diff_8h.html#a6e15e35d7afe80f23fa4bda464bc86bfa73be5c5095f769655c3d5f621c45b40a">sync_diff_X</a>);
<a name="l00878"></a>00878             <span class="keywordflow">if</span> (resX &lt; 0)
<a name="l00879"></a>00879                 <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#a3bb2d2b15c7a550960f237975f4d27b6">abortCompare</a>(sdd, <span class="stringliteral">&quot;doPreload L failed&quot;</span>);
<a name="l00880"></a>00880             <span class="keywordtype">int</span> resY = <a class="code" href="sync__diff_8c.html#a3525d6b09b95889fc98472f40e9f93b0" title="doPreload(sdd) walks the given tree, and requests a fetch for every node that is...">doPreload</a>(sdd, sdd-&gt;<a class="code" href="structsync__diff__data.html#aea271c342899152f5e314fdea4a26ab9" title="&amp;quot;remote&amp;quot; tree walker state">twY</a>, <a class="code" href="sync__diff_8h.html#a6e15e35d7afe80f23fa4bda464bc86bfa4f99506bd13ae2ecfa3b2d111e588326">sync_diff_Y</a>);
<a name="l00881"></a>00881             <span class="keywordflow">if</span> (resY &lt; 0)
<a name="l00882"></a>00882                 <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#a3bb2d2b15c7a550960f237975f4d27b6">abortCompare</a>(sdd, <span class="stringliteral">&quot;doPreload R failed&quot;</span>);
<a name="l00883"></a>00883             <span class="comment">// before switch to busy, reset the tree walkers</span>
<a name="l00884"></a>00884             <a class="code" href="sync__diff_8c.html#aa6a3bb3fd352266999d3ff44c18f4488">initWorkerFromHash</a>(root, sdd-&gt;<a class="code" href="structsync__diff__data.html#a3f95b5a31ad339b0cd28f190288fe533" title="&amp;quot;local&amp;quot; tree walker state">twX</a>, sdd-&gt;<a class="code" href="structsync__diff__data.html#a5997cd58b4376ccf9f71e4bd7a454d1c">hashX</a>);
<a name="l00885"></a>00885             <a class="code" href="sync__diff_8c.html#aa6a3bb3fd352266999d3ff44c18f4488">initWorkerFromHash</a>(root, sdd-&gt;<a class="code" href="structsync__diff__data.html#aea271c342899152f5e314fdea4a26ab9" title="&amp;quot;remote&amp;quot; tree walker state">twY</a>, sdd-&gt;<a class="code" href="structsync__diff__data.html#a55e8315cc447c98fca09ade2acd8ff23">hashY</a>);
<a name="l00886"></a>00886             <span class="keywordflow">if</span> (sdd-&gt;<a class="code" href="structsync__diff__data.html#a106732432ae0dc955f522dab508edc01" title="cache entries being fetched">fetchQ</a> != NULL || resX == 0 || resY == 0) {
<a name="l00887"></a>00887                 <span class="comment">// incomplete, so restart the preload</span>
<a name="l00888"></a>00888                 <span class="keywordflow">break</span>;
<a name="l00889"></a>00889             }
<a name="l00890"></a>00890             sdd-&gt;<a class="code" href="structsync__diff__data.html#a67fc1283c7352412a50f417e07a855d9" title="summary state of comparison">state</a> = <a class="code" href="sync__diff_8h.html#ae0c609194fbe6e000ccea19e6591dd19a587cdef50036ca9a41091efe79a42dd2">sync_diff_state_busy</a>;
<a name="l00891"></a>00891         <span class="keywordflow">case</span> <a class="code" href="sync__diff_8h.html#ae0c609194fbe6e000ccea19e6591dd19a587cdef50036ca9a41091efe79a42dd2">sync_diff_state_busy</a>:
<a name="l00892"></a>00892             <span class="comment">// come here when we are comparing the trees</span>
<a name="l00893"></a>00893             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>)
<a name="l00894"></a>00894                 <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;busy&quot;</span>);
<a name="l00895"></a>00895             res = <a class="code" href="sync__diff_8c.html#a8795ec3504c2f70d327752e333038b4e">doComparison</a>(sdd);
<a name="l00896"></a>00896             <span class="keywordflow">if</span> (res &lt; 0)
<a name="l00897"></a>00897                 <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#a3bb2d2b15c7a550960f237975f4d27b6">abortCompare</a>(sdd, <span class="stringliteral">&quot;doComparison failed&quot;</span>);
<a name="l00898"></a>00898             <span class="keywordflow">if</span> (sdd-&gt;<a class="code" href="structsync__diff__data.html#a106732432ae0dc955f522dab508edc01" title="cache entries being fetched">fetchQ</a> != NULL) {
<a name="l00899"></a>00899                 <span class="comment">// we had a load start during compare, so stall</span>
<a name="l00900"></a>00900                 delay = 100000;
<a name="l00901"></a>00901                 <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a2813bb28b1559ff71ca56e66d8df63a6" title="Something might be wrong.">CCNL_WARNING</a>)
<a name="l00902"></a>00902                     <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;doComparison fetch stall&quot;</span>);
<a name="l00903"></a>00903                 <span class="keywordflow">break</span>;
<a name="l00904"></a>00904             }
<a name="l00905"></a>00905             <span class="keywordflow">if</span> (res == 0 || sdd-&gt;<a class="code" href="structsync__diff__data.html#a106732432ae0dc955f522dab508edc01" title="cache entries being fetched">fetchQ</a> != NULL)
<a name="l00906"></a>00906                 <span class="comment">// comparison not yet complete</span>
<a name="l00907"></a>00907                 <span class="keywordflow">break</span>;
<a name="l00908"></a>00908             sdd-&gt;<a class="code" href="structsync__diff__data.html#a67fc1283c7352412a50f417e07a855d9" title="summary state of comparison">state</a> = <a class="code" href="sync__diff_8h.html#ae0c609194fbe6e000ccea19e6591dd19af4843063aa987f6dcf5db4f0042b8de4">sync_diff_state_done</a>;
<a name="l00909"></a>00909         <span class="keywordflow">case</span> <a class="code" href="sync__diff_8h.html#ae0c609194fbe6e000ccea19e6591dd19af4843063aa987f6dcf5db4f0042b8de4">sync_diff_state_done</a>: {
<a name="l00910"></a>00910             <span class="comment">// there is no change to the root hash when we are done</span>
<a name="l00911"></a>00911             <span class="comment">// the client may wish to fetch content, then alter the hash state</span>
<a name="l00912"></a>00912             <span class="comment">// what we do here is to log the result</span>
<a name="l00913"></a>00913             int64_t now = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l00914"></a>00914             int64_t mh = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(sdd-&gt;<a class="code" href="structsync__diff__data.html#aa134e2b168f70a1869f32f5ecb819f6d" title="time marker for last compare step entry">lastEnter</a>, now);
<a name="l00915"></a>00915             int64_t dt = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(sdd-&gt;<a class="code" href="structsync__diff__data.html#ac88ec31f887b4813bf31a9ed624020a1" title="time marker for sync_diff_start">startTime</a>, now);
<a name="l00916"></a>00916             <span class="keywordflow">if</span> (mh &gt; sdd-&gt;<a class="code" href="structsync__diff__data.html#a85e597d52688e91b19047f936bdb84e1" title="max time thread was held by compare">maxHold</a>) sdd-&gt;<a class="code" href="structsync__diff__data.html#a85e597d52688e91b19047f936bdb84e1" title="max time thread was held by compare">maxHold</a> = mh;
<a name="l00917"></a>00917             
<a name="l00918"></a>00918             <span class="keywordflow">if</span> (sdd-&gt;<a class="code" href="structsync__diff__data.html#a2570461f217f175955736961a677216d" title="number of failed remote node fetches">nodeFetchFailed</a> &gt; 0)
<a name="l00919"></a>00919                 <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#a3bb2d2b15c7a550960f237975f4d27b6">abortCompare</a>(sdd, <span class="stringliteral">&quot;node fetch failed&quot;</span>);
<a name="l00920"></a>00920             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l00921"></a>00921                 <span class="keywordtype">char</span> temp[64];
<a name="l00922"></a>00922                 mh = (mh + 500) / 1000;
<a name="l00923"></a>00923                 dt = (dt + 500) / 1000;
<a name="l00924"></a>00924                 snprintf(temp, <span class="keyword">sizeof</span>(temp)-2,
<a name="l00925"></a>00925                          <span class="stringliteral">&quot;%d.%03d secs [%d.%03d], %d names added&quot;</span>,
<a name="l00926"></a>00926                          (<span class="keywordtype">int</span>) (dt / 1000), (<span class="keywordtype">int</span>) (dt % 1000),
<a name="l00927"></a>00927                          (<span class="keywordtype">int</span>) (mh / 1000), (<span class="keywordtype">int</span>) (mh % 1000),
<a name="l00928"></a>00928                          (<span class="keywordtype">int</span>) sdd-&gt;<a class="code" href="structsync__diff__data.html#a2b5e8bbacc8ece0572d43ce7101964c3" title="names added during this comparison">namesAdded</a>);
<a name="l00929"></a>00929                 <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, <span class="stringliteral">&quot;done&quot;</span>, temp);
<a name="l00930"></a>00930             }
<a name="l00931"></a>00931             <span class="keywordflow">if</span> (sdd-&gt;<a class="code" href="structsync__diff__data.html#a8c48a9c5ac1c18f27b6ea84e8c8a3f88">add_closure</a> != NULL &amp;&amp; sdd-&gt;<a class="code" href="structsync__diff__data.html#a8c48a9c5ac1c18f27b6ea84e8c8a3f88">add_closure</a>-&gt;<a class="code" href="structsync__diff__add__closure.html#a9fe212376ec8cb5f4ec35ccae87b7876">add</a> != NULL)
<a name="l00932"></a>00932                 <span class="comment">// give the client a last shot at the data</span>
<a name="l00933"></a>00933                 sdd-&gt;<a class="code" href="structsync__diff__data.html#a8c48a9c5ac1c18f27b6ea84e8c8a3f88">add_closure</a>-&gt;<a class="code" href="structsync__diff__add__closure.html#a9fe212376ec8cb5f4ec35ccae87b7876">add</a>(sdd-&gt;<a class="code" href="structsync__diff__data.html#a8c48a9c5ac1c18f27b6ea84e8c8a3f88">add_closure</a>, NULL);
<a name="l00934"></a>00934             delay = -1;
<a name="l00935"></a>00935             <span class="keywordflow">break</span>;
<a name="l00936"></a>00936         }
<a name="l00937"></a>00937         <span class="keywordflow">case</span> <a class="code" href="sync__diff_8h.html#ae0c609194fbe6e000ccea19e6591dd19a3201ee381d392a46812079cb64d5c0c0">sync_diff_state_error</a>: {
<a name="l00938"></a>00938             <span class="keywordflow">if</span> (sdd-&gt;<a class="code" href="structsync__diff__data.html#a8c48a9c5ac1c18f27b6ea84e8c8a3f88">add_closure</a> != NULL &amp;&amp; sdd-&gt;<a class="code" href="structsync__diff__data.html#a8c48a9c5ac1c18f27b6ea84e8c8a3f88">add_closure</a>-&gt;<a class="code" href="structsync__diff__add__closure.html#a9fe212376ec8cb5f4ec35ccae87b7876">add</a> != NULL)
<a name="l00939"></a>00939                 <span class="comment">// give the client a last shot at the data</span>
<a name="l00940"></a>00940                 sdd-&gt;<a class="code" href="structsync__diff__data.html#a8c48a9c5ac1c18f27b6ea84e8c8a3f88">add_closure</a>-&gt;<a class="code" href="structsync__diff__add__closure.html#a9fe212376ec8cb5f4ec35ccae87b7876">add</a>(sdd-&gt;<a class="code" href="structsync__diff__data.html#a8c48a9c5ac1c18f27b6ea84e8c8a3f88">add_closure</a>, NULL);
<a name="l00941"></a>00941             <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#a3bb2d2b15c7a550960f237975f4d27b6">abortCompare</a>(sdd, <span class="stringliteral">&quot;sync_diff_state_error&quot;</span>);
<a name="l00942"></a>00942         }
<a name="l00943"></a>00943         <span class="keywordflow">default</span>: {
<a name="l00944"></a>00944             <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#a3bb2d2b15c7a550960f237975f4d27b6">abortCompare</a>(sdd, <span class="stringliteral">&quot;bad state&quot;</span>);
<a name="l00945"></a>00945         };
<a name="l00946"></a>00946     }
<a name="l00947"></a>00947     int64_t mh = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(sdd-&gt;<a class="code" href="structsync__diff__data.html#aa134e2b168f70a1869f32f5ecb819f6d" title="time marker for last compare step entry">lastEnter</a>, <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>());
<a name="l00948"></a>00948     <span class="keywordflow">if</span> (mh &gt; sdd-&gt;<a class="code" href="structsync__diff__data.html#a85e597d52688e91b19047f936bdb84e1" title="max time thread was held by compare">maxHold</a>) sdd-&gt;<a class="code" href="structsync__diff__data.html#a85e597d52688e91b19047f936bdb84e1" title="max time thread was held by compare">maxHold</a> = mh;
<a name="l00949"></a>00949     <span class="keywordflow">return</span> delay;
<a name="l00950"></a>00950 }
<a name="l00951"></a>00951 <span class="comment"></span>
<a name="l00952"></a>00952 <span class="comment">/////////////////////////////////</span>
<a name="l00953"></a>00953 <span class="comment">//// Update support</span>
<a name="l00954"></a>00954 <span class="comment">/////////////////////////////////</span>
<a name="l00955"></a>00955 <span class="comment"></span>
<a name="l00956"></a>00956 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *
<a name="l00957"></a><a class="code" href="sync__diff_8c.html#a12f107ab8c09088d09713f29247cdbab">00957</a> <a class="code" href="sync__diff_8c.html#a12f107ab8c09088d09713f29247cdbab">newNodeCommon</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root,
<a name="l00958"></a>00958               <span class="keyword">struct</span> <a class="code" href="struct_sync_node_accum.html">SyncNodeAccum</a> *nodes,
<a name="l00959"></a>00959               <span class="keyword">struct</span> <a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *nc) {
<a name="l00960"></a>00960     <span class="comment">// finish building and inserting a local node</span>
<a name="l00961"></a>00961     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.newNodeCommon&quot;</span>;
<a name="l00962"></a>00962     <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>;
<a name="l00963"></a>00963     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = base-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l00964"></a>00964     <span class="keywordflow">if</span> (nc == NULL || nc-&gt;<a class="code" href="struct_sync_node_composite.html#ab073cc0831daad1ab5096c261f75f6eb" title="combined hash (no tag, requires SyncEndComposite)">hash</a> == NULL) {
<a name="l00965"></a>00965         <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad node&quot;</span>, __LINE__);
<a name="l00966"></a>00966         <span class="keywordflow">return</span> NULL;
<a name="l00967"></a>00967     }
<a name="l00968"></a>00968     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *hash = nc-&gt;<a class="code" href="struct_sync_node_composite.html#ab073cc0831daad1ab5096c261f75f6eb" title="combined hash (no tag, requires SyncEndComposite)">hash</a>;
<a name="l00969"></a>00969     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = <a class="code" href="sync__diff_8c.html#a6eea619c02366baa2c0f7391a3d331f2">entryForHash</a>(root, hash);
<a name="l00970"></a>00970     <a class="code" href="_sync_hash_cache_8c.html#a88b8496fee4324b2359f23e3c6dd9472" title="fetches the cache entry to be eligible, ce != NULL &amp;amp;&amp;amp; ce-&amp;gt;ncL != NULL...">SyncCacheEntryFetch</a>(ce);
<a name="l00971"></a>00971     <span class="keywordflow">if</span> (ce != NULL &amp;&amp; ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a> != NULL) {
<a name="l00972"></a>00972         <span class="comment">// an equivalent local node is already in the cache</span>
<a name="l00973"></a>00973         <span class="comment">// so get rid of the new node and return the existing entry</span>
<a name="l00974"></a>00974         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l00975"></a>00975             <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00976"></a>00976             <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, <span class="stringliteral">&quot;suppressed duplicate&quot;</span>, hex);
<a name="l00977"></a>00977             free(hex);
<a name="l00978"></a>00978         }
<a name="l00979"></a>00979         <a class="code" href="_sync_node_8c.html#af28433d58bb465b237a50e3b0aa9d0e4" title="freeComposite returns the storage for the composite object">SyncFreeComposite</a>(nc);
<a name="l00980"></a>00980         nc = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a>;
<a name="l00981"></a>00981         root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a38e2e743a14abac78e109da409dfd072">stats</a>-&gt;<a class="code" href="struct_sync_root_stats.html#a9c4b7420a516f81a8fcbf566b31a93b8">nodesShared</a>++;
<a name="l00982"></a>00982     } <span class="keywordflow">else</span> {
<a name="l00983"></a>00983         <span class="comment">// no local cache entry, so make one</span>
<a name="l00984"></a>00984         <span class="keyword">struct </span><a class="code" href="struct_sync_private.html">SyncPrivate</a> *priv = base-&gt;<a class="code" href="struct_sync_base_struct.html#ab7d5452e09cb0b6e41205bc9f00e4bf8">priv</a>;
<a name="l00985"></a>00985         ce = <a class="code" href="_sync_hash_cache_8c.html#abcf5e784c52d971d943bddef80731954" title="based on the raw hash, ensure that a remote cache entry exists ent-&amp;gt;state |= set...">SyncHashEnter</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a9e849b0fed91e850763db20a54956128" title="a local node exists">SyncHashState_local</a>);
<a name="l00986"></a>00986         <span class="keywordflow">if</span> (ce == NULL) {
<a name="l00987"></a>00987             <span class="comment">// this should not have happened!</span>
<a name="l00988"></a>00988             <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad enter&quot;</span>, __LINE__);
<a name="l00989"></a>00989             <a class="code" href="_sync_node_8c.html#adbec8777422ca7e8c80714aa77afb5a4" title="Decrements the reference count.">SyncNodeDecRC</a>(nc);
<a name="l00990"></a>00990             <span class="keywordflow">return</span> NULL;
<a name="l00991"></a>00991         }
<a name="l00992"></a>00992         ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a> = nc;
<a name="l00993"></a>00993         <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381aec73ed0d374163f11f2d715ce0a3c197" title="a remote hash has been seen">SyncHashState_remote</a>)
<a name="l00994"></a>00994             <a class="code" href="sync__diff_8c.html#a8d981d346c90e43d3f8d9e52077e28ca">setCovered</a>(ce);
<a name="l00995"></a>00995         <span class="comment">// queue this cache entry for storing</span>
<a name="l00996"></a>00996         ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> |= <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381ad4b20491244029e5364fcf26e8bd7a56" title="local node is queued to be stored">SyncHashState_storing</a>;
<a name="l00997"></a>00997         <span class="keywordflow">if</span> (priv-&gt;<a class="code" href="struct_sync_private.html#a0546eef720ae9f5db072974db5c50630">storingTail</a> == NULL) {
<a name="l00998"></a>00998             <span class="comment">// storing queue is empty</span>
<a name="l00999"></a>00999             priv-&gt;<a class="code" href="struct_sync_private.html#af894176c154e2a66ac8c15c43c905d95">storingHead</a> = ce;
<a name="l01000"></a>01000         } <span class="keywordflow">else</span> {
<a name="l01001"></a>01001             <span class="comment">// append to the tail</span>
<a name="l01002"></a>01002             priv-&gt;<a class="code" href="struct_sync_private.html#a0546eef720ae9f5db072974db5c50630">storingTail</a>-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a5b90f06d440bfd79f5c998a116a0477d" title="the next entry in the storing chain">storing</a> = ce;
<a name="l01003"></a>01003         }
<a name="l01004"></a>01004         priv-&gt;<a class="code" href="struct_sync_private.html#a0546eef720ae9f5db072974db5c50630">storingTail</a> = ce;
<a name="l01005"></a>01005         priv-&gt;<a class="code" href="struct_sync_private.html#a3e547cf3839479721855d5bab5be0e2a">nStoring</a>++;
<a name="l01006"></a>01006         root-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#a38e2e743a14abac78e109da409dfd072">stats</a>-&gt;<a class="code" href="struct_sync_root_stats.html#a9772ca97f213641e9f310dc58cb55863">nodesCreated</a>++;
<a name="l01007"></a>01007         <span class="keywordflow">if</span> (nc-&gt;<a class="code" href="struct_sync_node_composite.html#a5b1cdb9c3eabafe04a18c8623784ff04" title="pointer to ccnb encoding">cb</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> &gt;= <a class="code" href="sync__diff_8c.html#ad6e384ed8d6687203b96177c4425df08">nodeSplitTrigger</a>) {
<a name="l01008"></a>01008             <span class="comment">// if this happens then our split estimate was wrong!</span>
<a name="l01009"></a>01009             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>)
<a name="l01010"></a>01010                 <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base,
<a name="l01011"></a>01011                          <span class="stringliteral">&quot;%s, root#%u, cb-&gt;length (%d) &gt;= nodeSplitTrigger (%d)&quot;</span>,
<a name="l01012"></a>01012                          here, root-&gt;<a class="code" href="struct_sync_root_struct.html#a86cbcbdd2e2d8c30311da406d36c80e5" title="root Id for reporting">rootId</a>,
<a name="l01013"></a>01013                          (<span class="keywordtype">int</span>) nc-&gt;<a class="code" href="struct_sync_node_composite.html#a5b1cdb9c3eabafe04a18c8623784ff04" title="pointer to ccnb encoding">cb</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, (<span class="keywordtype">int</span>) <a class="code" href="sync__diff_8c.html#ad6e384ed8d6687203b96177c4425df08">nodeSplitTrigger</a>);
<a name="l01014"></a>01014         }
<a name="l01015"></a>01015     }
<a name="l01016"></a>01016     <a class="code" href="_sync_node_8c.html#aab2c27ab0d33e00e6bfe576bd9142c0a" title="Increments the reference count.">SyncNodeIncRC</a>(nc);
<a name="l01017"></a>01017     <a class="code" href="_sync_util_8c.html#adcc1cea741c9dc3781e76b1713a6a579">SyncAccumNode</a>(nodes, nc);
<a name="l01018"></a>01018     <span class="keywordflow">return</span> ce;
<a name="l01019"></a>01019 }
<a name="l01020"></a>01020 
<a name="l01021"></a>01021 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *
<a name="l01022"></a><a class="code" href="sync__diff_8c.html#a41bfae51234a2b95442493843fc12ab9">01022</a> <a class="code" href="sync__diff_8c.html#a41bfae51234a2b95442493843fc12ab9">node_from_nodes</a>(<span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root, <span class="keyword">struct</span> <a class="code" href="struct_sync_node_accum.html">SyncNodeAccum</a> *na) {
<a name="l01023"></a>01023     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.node_from_nodes&quot;</span>;
<a name="l01024"></a>01024     <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>;
<a name="l01025"></a>01025     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = base-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l01026"></a>01026     <span class="keywordtype">int</span> lim = na-&gt;<a class="code" href="struct_sync_node_accum.html#a8039343609e269cef4ae64c55467bdfa">len</a>;
<a name="l01027"></a>01027     <span class="keywordflow">if</span> (lim == 0) {
<a name="l01028"></a>01028         <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;empty&quot;</span>, __LINE__);
<a name="l01029"></a>01029         <span class="keywordflow">return</span> NULL;
<a name="l01030"></a>01030     }
<a name="l01031"></a>01031     <span class="keywordflow">if</span> (lim == 1) {
<a name="l01032"></a>01032         <span class="comment">// just return the singleton node</span>
<a name="l01033"></a>01033         <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *nc = na-&gt;<a class="code" href="struct_sync_node_accum.html#a0c6a127c7ca656dea4b08e09e28ed50e">ents</a>[0];
<a name="l01034"></a>01034         <span class="keywordflow">if</span> (nc == NULL || nc-&gt;<a class="code" href="struct_sync_node_composite.html#ab073cc0831daad1ab5096c261f75f6eb" title="combined hash (no tag, requires SyncEndComposite)">hash</a> == NULL) {
<a name="l01035"></a>01035             <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad node&quot;</span>, __LINE__);
<a name="l01036"></a>01036             <span class="keywordflow">return</span> NULL;
<a name="l01037"></a>01037         }
<a name="l01038"></a>01038         <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = <a class="code" href="sync__diff_8c.html#a6eea619c02366baa2c0f7391a3d331f2">entryForHash</a>(root, nc-&gt;<a class="code" href="struct_sync_node_composite.html#ab073cc0831daad1ab5096c261f75f6eb" title="combined hash (no tag, requires SyncEndComposite)">hash</a>);
<a name="l01039"></a>01039         <span class="keywordflow">if</span> (ce == NULL)
<a name="l01040"></a>01040             <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad lookup&quot;</span>, __LINE__);
<a name="l01041"></a>01041         <span class="keywordflow">return</span> ce;
<a name="l01042"></a>01042     }
<a name="l01043"></a>01043     
<a name="l01044"></a>01044     <span class="keywordtype">int</span> accLim = <a class="code" href="sync__diff_8c.html#ad6e384ed8d6687203b96177c4425df08">nodeSplitTrigger</a> - <a class="code" href="sync__diff_8c.html#ad6e384ed8d6687203b96177c4425df08">nodeSplitTrigger</a>/8;
<a name="l01045"></a>01045     <span class="keyword">struct </span><a class="code" href="struct_sync_node_accum.html">SyncNodeAccum</a> *nodes = <a class="code" href="_sync_util_8c.html#acfdd4906ae2c5ffb57df166f281a8436">SyncAllocNodeAccum</a>(0);
<a name="l01046"></a>01046     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = NULL;
<a name="l01047"></a>01047     <span class="keywordtype">int</span> j = 0;
<a name="l01048"></a>01048     <span class="keywordflow">while</span> (j &lt; lim) {
<a name="l01049"></a>01049         <span class="keywordtype">int</span> maxLen = 0;
<a name="l01050"></a>01050         <span class="keywordtype">int</span> i = j;
<a name="l01051"></a>01051         <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *nc = <a class="code" href="_sync_node_8c.html#adbc4a9ebd7d35b9d7c9d36a9c3263bb7" title="allocates a new, empty, composite object">SyncAllocComposite</a>(base);
<a name="l01052"></a>01052         <span class="keywordtype">int</span> accLen = nc-&gt;<a class="code" href="struct_sync_node_composite.html#a5b1cdb9c3eabafe04a18c8623784ff04" title="pointer to ccnb encoding">cb</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>;
<a name="l01053"></a>01053         <span class="comment">// first, loop to find the run length</span>
<a name="l01054"></a>01054         <span class="keywordflow">while</span> (i &lt; lim &amp;&amp; accLen &lt; accLim) {
<a name="l01055"></a>01055             <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *elem = na-&gt;<a class="code" href="struct_sync_node_accum.html#a0c6a127c7ca656dea4b08e09e28ed50e">ents</a>[i];
<a name="l01056"></a>01056             i++;
<a name="l01057"></a>01057             <span class="keywordtype">int</span> nodeLen = elem-&gt;<a class="code" href="struct_sync_node_composite.html#ab073cc0831daad1ab5096c261f75f6eb" title="combined hash (no tag, requires SyncEndComposite)">hash</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> + 8;
<a name="l01058"></a>01058             <span class="keywordflow">if</span> (nodeLen &gt; maxLen) maxLen = nodeLen;
<a name="l01059"></a>01059             accLen = accLen + nodeLen + (maxLen - nodeLen) * 2;
<a name="l01060"></a>01060         }
<a name="l01061"></a>01061         
<a name="l01062"></a>01062         <span class="comment">// append the references in the run</span>
<a name="l01063"></a>01063         <span class="keywordflow">while</span> (j &lt; i) {
<a name="l01064"></a>01064             <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *elem = na-&gt;<a class="code" href="struct_sync_node_accum.html#a0c6a127c7ca656dea4b08e09e28ed50e">ents</a>[j];
<a name="l01065"></a>01065             j++;
<a name="l01066"></a>01066             <a class="code" href="_sync_node_8c.html#acebf6b0bcb035bb0d072abf4e8d02d5f" title="extends the references section of a composite object with a new node, updating the...">SyncNodeAddNode</a>(nc, elem);
<a name="l01067"></a>01067         }
<a name="l01068"></a>01068         <a class="code" href="_sync_node_8c.html#a15cb874167ed7c39b1d2af2957a5036d" title="endComposite finishes up the encoding, appending the composite fields the hash field...">SyncEndComposite</a>(nc); <span class="comment">// finish the node</span>
<a name="l01069"></a>01069         ce = <a class="code" href="sync__diff_8c.html#a12f107ab8c09088d09713f29247cdbab">newNodeCommon</a>(root, nodes, nc);
<a name="l01070"></a>01070     }
<a name="l01071"></a>01071     <span class="comment">// go recursive just in case we need the extra levels</span>
<a name="l01072"></a>01072     ce = <a class="code" href="sync__diff_8c.html#a41bfae51234a2b95442493843fc12ab9">node_from_nodes</a>(root, nodes);
<a name="l01073"></a>01073     nodes = <a class="code" href="_sync_util_8c.html#a1bc7a4088f04170cdf7ea57e04866c4b">SyncFreeNodeAccum</a>(nodes);
<a name="l01074"></a>01074     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l01075"></a>01075         <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base, <span class="stringliteral">&quot;%s, root#%u, %d refs&quot;</span>, here, root-&gt;<a class="code" href="struct_sync_root_struct.html#a86cbcbdd2e2d8c30311da406d36c80e5" title="root Id for reporting">rootId</a>, lim);
<a name="l01076"></a>01076     }
<a name="l01077"></a>01077     <span class="keywordflow">return</span> ce;
<a name="l01078"></a>01078 }
<a name="l01079"></a>01079 
<a name="l01080"></a>01080 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01081"></a><a class="code" href="sync__diff_8c.html#a72146a563f8150859821220b8665837b">01081</a> <a class="code" href="sync__diff_8c.html#a72146a563f8150859821220b8665837b">node_from_names</a>(<span class="keyword">struct</span> <a class="code" href="structsync__update__data.html">sync_update_data</a> *ud, <span class="keywordtype">int</span> split) {
<a name="l01082"></a>01082     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.node_from_names&quot;</span>;
<a name="l01083"></a>01083     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = ud-&gt;<a class="code" href="structsync__update__data.html#ae27a2fd5da60493df931427349b1419f">root</a>;
<a name="l01084"></a>01084     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l01085"></a>01085     <span class="keyword">struct </span><a class="code" href="struct_sync_name_accum.html">SyncNameAccum</a> *na = ud-&gt;<a class="code" href="structsync__update__data.html#a1cb1d7a80bfc2712d5b22bea479e32f1" title="temp storage used while updating">names</a>;
<a name="l01086"></a>01086     <span class="keywordtype">int</span> <a class="code" href="struct_sync_name_accum.html#a82d2e0a816823b365c6a6aa1449f1f2b">lim</a> = na-&gt;<a class="code" href="struct_sync_name_accum.html#a43e6bf3321957d08f4985443cc36555d">len</a>;
<a name="l01087"></a>01087     <span class="keywordflow">if</span> (lim == 0)
<a name="l01088"></a>01088         <span class="comment">// should not have been called, but no harm done</span>
<a name="l01089"></a>01089         <span class="keywordflow">return</span> 0;
<a name="l01090"></a>01090     <span class="keywordtype">int</span> i = 0;
<a name="l01091"></a>01091     <span class="keywordflow">if</span> (split == 0) split = lim;
<a name="l01092"></a>01092     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l01093"></a>01093         <span class="keywordtype">char</span> tmp[64];
<a name="l01094"></a>01094         snprintf(tmp, <span class="keyword">sizeof</span>(tmp),
<a name="l01095"></a>01095                  <span class="stringliteral">&quot;split %d, lim %d&quot;</span>,
<a name="l01096"></a>01096                  split, lim);
<a name="l01097"></a>01097         <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, tmp);
<a name="l01098"></a>01098     }
<a name="l01099"></a>01099     
<a name="l01100"></a>01100     <span class="comment">// accum the hash for the node, and see if it exists</span>
<a name="l01101"></a>01101     <span class="keyword">struct </span><a class="code" href="struct_sync_long_hash_struct.html" title="A SyncLongHashStruct is used to accumulate a combined hash code The pos field is...">SyncLongHashStruct</a> longHash;
<a name="l01102"></a>01102     memset(&amp;longHash, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="struct_sync_long_hash_struct.html" title="A SyncLongHashStruct is used to accumulate a combined hash code The pos field is...">SyncLongHashStruct</a>));
<a name="l01103"></a>01103     longHash.<a class="code" href="struct_sync_long_hash_struct.html#ae53b573313bdbdd9f31f4010112f1aa9">pos</a> = <a class="code" href="_sync_macros_8h.html#a3922c71e229552ce16d1c6e016c10dd8">MAX_HASH_BYTES</a>;
<a name="l01104"></a>01104     <span class="keywordflow">for</span> (i = 0; i &lt; split; i++) {
<a name="l01105"></a>01105         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = na-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[i].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a>;
<a name="l01106"></a>01106         <a class="code" href="_sync_util_8c.html#adf85aac3b766385d231242a06f606c15">SyncAccumHash</a>(&amp;longHash, name);
<a name="l01107"></a>01107     }
<a name="l01108"></a>01108     ssize_t hs = <a class="code" href="_sync_macros_8h.html#a3922c71e229552ce16d1c6e016c10dd8">MAX_HASH_BYTES</a>-longHash.<a class="code" href="struct_sync_long_hash_struct.html#ae53b573313bdbdd9f31f4010112f1aa9">pos</a>;
<a name="l01109"></a>01109     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *hp = longHash.<a class="code" href="struct_sync_long_hash_struct.html#a57ac8b0ec5184164f74edb8cfb45220a">bytes</a>+longHash.<a class="code" href="struct_sync_long_hash_struct.html#ae53b573313bdbdd9f31f4010112f1aa9">pos</a>;
<a name="l01110"></a>01110     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = <a class="code" href="_sync_hash_cache_8c.html#a15c6eafb71bb631fde85a2424f5ac449" title="lookup a full hash in a hash table (raw contents, no tag)">SyncHashLookup</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>, hp, hs);
<a name="l01111"></a>01111     <span class="keywordflow">if</span> (ce != NULL &amp;&amp; ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a> != NULL) {
<a name="l01112"></a>01112         <span class="comment">// node already exists</span>
<a name="l01113"></a>01113         <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *nc = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a>;
<a name="l01114"></a>01114         <a class="code" href="_sync_node_8c.html#aab2c27ab0d33e00e6bfe576bd9142c0a" title="Increments the reference count.">SyncNodeIncRC</a>(nc);
<a name="l01115"></a>01115         <a class="code" href="_sync_util_8c.html#adcc1cea741c9dc3781e76b1713a6a579">SyncAccumNode</a>(ud-&gt;<a class="code" href="structsync__update__data.html#a54c30a3acf32ec8669ce466e00b05af1" title="temp storage used while updating">nodes</a>, nc);
<a name="l01116"></a>01116         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l01117"></a>01117             <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hp, hs);
<a name="l01118"></a>01118             <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, <span class="stringliteral">&quot;existing local node&quot;</span>, hex);
<a name="l01119"></a>01119             free(hex);
<a name="l01120"></a>01120         }
<a name="l01121"></a>01121     } <span class="keywordflow">else</span> {
<a name="l01122"></a>01122         <span class="comment">// need to create a new node</span>
<a name="l01123"></a>01123         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l01124"></a>01124             <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hp, hs);
<a name="l01125"></a>01125             <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, <span class="stringliteral">&quot;need new local node&quot;</span>, hex);
<a name="l01126"></a>01126             free(hex);
<a name="l01127"></a>01127         }
<a name="l01128"></a>01128         <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *nc = <a class="code" href="_sync_node_8c.html#adbc4a9ebd7d35b9d7c9d36a9c3263bb7" title="allocates a new, empty, composite object">SyncAllocComposite</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>);
<a name="l01129"></a>01129         <span class="keywordflow">for</span> (i = 0; i &lt; split; i++) {
<a name="l01130"></a>01130             <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = na-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[i].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a>;
<a name="l01131"></a>01131             <a class="code" href="_sync_node_8c.html#af50e30366159577adfcc4207665d5c15" title="extends the references section of a composite object with a new name, updating the...">SyncNodeAddName</a>(nc, name);
<a name="l01132"></a>01132             <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l01133"></a>01133             na-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[i].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a> = NULL;
<a name="l01134"></a>01134         }
<a name="l01135"></a>01135         <a class="code" href="_sync_node_8c.html#a15cb874167ed7c39b1d2af2957a5036d" title="endComposite finishes up the encoding, appending the composite fields the hash field...">SyncEndComposite</a>(nc);
<a name="l01136"></a>01136         <a class="code" href="sync__diff_8c.html#a12f107ab8c09088d09713f29247cdbab">newNodeCommon</a>(root, ud-&gt;<a class="code" href="structsync__update__data.html#a54c30a3acf32ec8669ce466e00b05af1" title="temp storage used while updating">nodes</a>, nc);
<a name="l01137"></a>01137     }
<a name="l01138"></a>01138     <span class="comment">// shift remaining elements down in the name accum</span>
<a name="l01139"></a>01139     ud-&gt;<a class="code" href="structsync__update__data.html#a0c50d872a6a7c598b87474c0b3f5e553">nameLenAccum</a> = 0;
<a name="l01140"></a>01140     i = 0;
<a name="l01141"></a>01141     <span class="keywordflow">while</span> (split &lt; lim) {
<a name="l01142"></a>01142         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = na-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[split].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a>;
<a name="l01143"></a>01143         ud-&gt;<a class="code" href="structsync__update__data.html#a0c50d872a6a7c598b87474c0b3f5e553">nameLenAccum</a> += name-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>;
<a name="l01144"></a>01144         na-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[i] = na-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[split];
<a name="l01145"></a>01145         na-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[split].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a> = NULL;
<a name="l01146"></a>01146         i++;
<a name="l01147"></a>01147         split++;
<a name="l01148"></a>01148     }
<a name="l01149"></a>01149     na-&gt;<a class="code" href="struct_sync_name_accum.html#a43e6bf3321957d08f4985443cc36555d">len</a> = i;
<a name="l01150"></a>01150     <span class="keywordflow">return</span> i;
<a name="l01151"></a>01151 }
<a name="l01152"></a>01152 
<a name="l01153"></a>01153 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01154"></a><a class="code" href="sync__diff_8c.html#a1132ffd0441e72a582b434b9242da15c">01154</a> <a class="code" href="sync__diff_8c.html#a1132ffd0441e72a582b434b9242da15c">try_node_split</a>(<span class="keyword">struct</span> <a class="code" href="structsync__update__data.html">sync_update_data</a> *ud) {
<a name="l01155"></a>01155     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.try_node_split&quot;</span>;
<a name="l01156"></a>01156     <span class="keyword">struct </span><a class="code" href="struct_sync_name_accum.html">SyncNameAccum</a> *na = ud-&gt;<a class="code" href="structsync__update__data.html#a1cb1d7a80bfc2712d5b22bea479e32f1" title="temp storage used while updating">names</a>;
<a name="l01157"></a>01157     <span class="keywordtype">int</span> <a class="code" href="struct_sync_name_accum.html#a82d2e0a816823b365c6a6aa1449f1f2b">lim</a> = na-&gt;<a class="code" href="struct_sync_name_accum.html#a43e6bf3321957d08f4985443cc36555d">len</a>;
<a name="l01158"></a>01158     <span class="keywordflow">if</span> (lim == 0)
<a name="l01159"></a>01159         <span class="comment">// should not have been called, but no harm done</span>
<a name="l01160"></a>01160         <span class="keywordflow">return</span> 0;
<a name="l01161"></a>01161     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = ud-&gt;<a class="code" href="structsync__update__data.html#ae27a2fd5da60493df931427349b1419f">root</a>;
<a name="l01162"></a>01162     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l01163"></a>01163     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *prev = NULL;
<a name="l01164"></a>01164     <span class="keywordtype">int</span> accLim = <a class="code" href="sync__diff_8c.html#ad6e384ed8d6687203b96177c4425df08">nodeSplitTrigger</a> - <a class="code" href="sync__diff_8c.html#ad6e384ed8d6687203b96177c4425df08">nodeSplitTrigger</a>/8;
<a name="l01165"></a>01165     <span class="keywordtype">int</span> accMin = <a class="code" href="sync__diff_8c.html#ad6e384ed8d6687203b96177c4425df08">nodeSplitTrigger</a>/2;
<a name="l01166"></a>01166     <span class="keywordtype">int</span> res = 0;
<a name="l01167"></a>01167     <span class="keywordtype">int</span> splitMethod = 3;  <span class="comment">// was variable, now is constantly enabled</span>
<a name="l01168"></a>01168     <span class="keywordtype">int</span> maxLen = 0;
<a name="l01169"></a>01169     <span class="keywordtype">int</span> accLen = 0;
<a name="l01170"></a>01170     <span class="keywordtype">int</span> prevMatch = 0;
<a name="l01171"></a>01171     <span class="keywordtype">int</span> split = 0;
<a name="l01172"></a>01172     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l01173"></a>01173         <span class="keywordtype">char</span> tmp[64];
<a name="l01174"></a>01174         snprintf(tmp, <span class="keyword">sizeof</span>(tmp),
<a name="l01175"></a>01175                  <span class="stringliteral">&quot;entered, %d names&quot;</span>,
<a name="l01176"></a>01176                  lim);
<a name="l01177"></a>01177         <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, tmp);
<a name="l01178"></a>01178     }
<a name="l01179"></a>01179     <span class="keywordflow">for</span> (split = 0; split &lt; lim; split++) {
<a name="l01180"></a>01180         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = na-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[split].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a>;
<a name="l01181"></a>01181         <span class="keywordtype">int</span> nameLen = name-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> + 8;
<a name="l01182"></a>01182         <span class="keywordflow">if</span> (nameLen &gt; maxLen) maxLen = nameLen;
<a name="l01183"></a>01183         accLen = accLen + nameLen + (maxLen - nameLen) * 2;
<a name="l01184"></a>01184         prev = name;
<a name="l01185"></a>01185         <span class="keywordflow">if</span> (split+1 &lt; lim) {
<a name="l01186"></a>01186             <span class="keywordflow">if</span> (splitMethod &amp; 1) {
<a name="l01187"></a>01187                 <span class="comment">// use level shift to split</span>
<a name="l01188"></a>01188                 <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *next = na-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[split+1].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a>;
<a name="l01189"></a>01189                 <span class="keywordtype">int</span> match = <a class="code" href="_sync_util_8c.html#a056c61da0b2155d6a2e53f5c4e9f8e74">SyncComponentMatch</a>(name, next);
<a name="l01190"></a>01190                 <span class="keywordflow">if</span> (accLen &gt;= accMin
<a name="l01191"></a>01191                     &amp;&amp; (match &lt; prevMatch || (match &gt; prevMatch+1))) {
<a name="l01192"></a>01192                     <span class="comment">// force a break due to level changes</span>
<a name="l01193"></a>01193                     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l01194"></a>01194                         <span class="keywordtype">char</span> tmp[64];
<a name="l01195"></a>01195                         snprintf(tmp, <span class="keyword">sizeof</span>(tmp),
<a name="l01196"></a>01196                                  <span class="stringliteral">&quot;split %d, lim %d, match %d, prev %d, accLen %d&quot;</span>,
<a name="l01197"></a>01197                                  split, lim, match, prevMatch, accLen);
<a name="l01198"></a>01198                         <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, <span class="stringliteral">&quot;level split found&quot;</span>, tmp);
<a name="l01199"></a>01199                     }
<a name="l01200"></a>01200                     <span class="keywordflow">break</span>;
<a name="l01201"></a>01201                 }
<a name="l01202"></a>01202                 prevMatch = match;
<a name="l01203"></a>01203             }
<a name="l01204"></a>01204             <span class="keywordflow">if</span> (splitMethod &amp; 2) {
<a name="l01205"></a>01205                 <span class="comment">// use bits of hash to split</span>
<a name="l01206"></a>01206                 <span class="keywordtype">int</span> pos = name-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> - 9;
<a name="l01207"></a>01207                 <span class="keywordflow">if</span> (pos &gt; 0 &amp;&amp; accLen &gt;= accMin) {
<a name="l01208"></a>01208                     <span class="keywordtype">unsigned</span> c = name-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>[pos] &amp; 255;
<a name="l01209"></a>01209                     <span class="keywordflow">if</span> (c &lt; <a class="code" href="sync__diff_8c.html#a81327fc9c584dac59986ec3725d2cd77">hashSplitTrigger</a>) {
<a name="l01210"></a>01210                         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l01211"></a>01211                             <span class="keywordtype">char</span> tmp[64];
<a name="l01212"></a>01212                             snprintf(tmp, <span class="keyword">sizeof</span>(tmp),
<a name="l01213"></a>01213                                      <span class="stringliteral">&quot;split %d, lim %d, x %u, accLen %d&quot;</span>,
<a name="l01214"></a>01214                                      split, lim, c, accLen);
<a name="l01215"></a>01215                             <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, <span class="stringliteral">&quot;hash split found&quot;</span>, tmp);
<a name="l01216"></a>01216                         }
<a name="l01217"></a>01217                         <span class="keywordflow">break</span>;
<a name="l01218"></a>01218                     }
<a name="l01219"></a>01219                 }
<a name="l01220"></a>01220             }
<a name="l01221"></a>01221         }
<a name="l01222"></a>01222         <span class="keywordflow">if</span> (accLen &gt;= accLim) {
<a name="l01223"></a>01223             <span class="keywordflow">break</span>;
<a name="l01224"></a>01224         }
<a name="l01225"></a>01225     }
<a name="l01226"></a>01226     <span class="comment">// at this point we take the first &quot;split&quot; elements into a node</span>
<a name="l01227"></a>01227     res = <a class="code" href="sync__diff_8c.html#a72146a563f8150859821220b8665837b">node_from_names</a>(ud, split);
<a name="l01228"></a>01228     <span class="keywordflow">return</span> res;
<a name="l01229"></a>01229 }
<a name="l01230"></a>01230 
<a name="l01231"></a>01231 <span class="comment">// add_update_name adds a name to the current update name accumulator</span>
<a name="l01232"></a>01232 <span class="comment">// and adds it to the deltas if it is a new name and can be added</span>
<a name="l01233"></a>01233 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01234"></a><a class="code" href="sync__diff_8c.html#ae674232388177bfa913955bbcff76aa6">01234</a> <a class="code" href="sync__diff_8c.html#ae674232388177bfa913955bbcff76aa6">add_update_name</a>(<span class="keyword">struct</span> <a class="code" href="structsync__update__data.html">sync_update_data</a> *ud, <span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name, <span class="keywordtype">int</span> isNew) {
<a name="l01235"></a>01235     <span class="keyword">static</span> <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.add_update_name&quot;</span>;
<a name="l01236"></a>01236     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = ud-&gt;<a class="code" href="structsync__update__data.html#ae27a2fd5da60493df931427349b1419f">root</a>;
<a name="l01237"></a>01237     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l01238"></a>01238     <span class="keyword">struct </span><a class="code" href="struct_sync_name_accum.html">SyncNameAccum</a> *dst = ud-&gt;<a class="code" href="structsync__update__data.html#a1cb1d7a80bfc2712d5b22bea479e32f1" title="temp storage used while updating">names</a>;
<a name="l01239"></a>01239     <span class="keywordtype">int</span> nameLen = name-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>;
<a name="l01240"></a>01240     <span class="keywordtype">int</span> accLim = <a class="code" href="sync__diff_8c.html#ad6e384ed8d6687203b96177c4425df08">nodeSplitTrigger</a> - <a class="code" href="sync__diff_8c.html#ad6e384ed8d6687203b96177c4425df08">nodeSplitTrigger</a>/8;
<a name="l01241"></a>01241     <span class="keywordtype">int</span> res = 0;
<a name="l01242"></a>01242     name = <a class="code" href="_sync_util_8c.html#a01fc44dbffb2f846caf907c293b98c02">SyncCopyName</a>(name);
<a name="l01243"></a>01243     <a class="code" href="_sync_util_8c.html#a9c7204a6cd37470ba61c05e5da8d8fc6" title="appends a new name with associated data important: the name is not copied!">SyncNameAccumAppend</a>(dst, name, 0);
<a name="l01244"></a>01244     <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l01245"></a>01245         <span class="keywordtype">char</span> *msg = ((isNew) ? <span class="stringliteral">&quot;added+&quot;</span> : <span class="stringliteral">&quot;added&quot;</span>);
<a name="l01246"></a>01246         <a class="code" href="_sync_util_8c.html#a60a96e3d70a904dbe3f038aaa622fb36">SyncNoteUri</a>(root, here, msg, name);
<a name="l01247"></a>01247     }
<a name="l01248"></a>01248     ud-&gt;<a class="code" href="structsync__update__data.html#a0c50d872a6a7c598b87474c0b3f5e553">nameLenAccum</a> += nameLen;
<a name="l01249"></a>01249     ud-&gt;<a class="code" href="structsync__update__data.html#a19060fdeb1e72c8aa562ddcba82744ff">namesAdded</a>++;
<a name="l01250"></a>01250     <span class="keywordflow">if</span> (ud-&gt;<a class="code" href="structsync__update__data.html#a0c50d872a6a7c598b87474c0b3f5e553">nameLenAccum</a> &gt;= accLim) {
<a name="l01251"></a>01251         <span class="comment">// we should split, if it is possible</span>
<a name="l01252"></a>01252         res = <a class="code" href="sync__diff_8c.html#a1132ffd0441e72a582b434b9242da15c">try_node_split</a>(ud);
<a name="l01253"></a>01253     }
<a name="l01254"></a>01254     <span class="keywordflow">return</span> res;
<a name="l01255"></a>01255 }
<a name="l01256"></a>01256 
<a name="l01257"></a>01257 <span class="comment">// merge the semi-sorted names and the old sync tree</span>
<a name="l01258"></a>01258 <span class="comment">// returns -1 for failure, 0 for incomplete, 1 for complete</span>
<a name="l01259"></a>01259 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01260"></a><a class="code" href="sync__diff_8c.html#af56e897b6345d7acf11d6d7eaca1a37d">01260</a> <a class="code" href="sync__diff_8c.html#af56e897b6345d7acf11d6d7eaca1a37d">merge_names</a>(<span class="keyword">struct</span> <a class="code" href="structsync__update__data.html">sync_update_data</a> *ud) {
<a name="l01261"></a>01261     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.merge_names&quot;</span>;
<a name="l01262"></a>01262     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = ud-&gt;<a class="code" href="structsync__update__data.html#ae27a2fd5da60493df931427349b1419f">root</a>;
<a name="l01263"></a>01263     <span class="comment">//struct SyncRootPrivate *rp = root-&gt;priv;</span>
<a name="l01264"></a>01264     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l01265"></a>01265     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *cb = ud-&gt;<a class="code" href="structsync__update__data.html#a95435eb475deb0007ba15c50be1d088f">cb</a>;
<a name="l01266"></a>01266     <span class="keyword">struct </span><a class="code" href="struct_sync_tree_worker_head.html">SyncTreeWorkerHead</a> *head = ud-&gt;<a class="code" href="structsync__update__data.html#abd7c89908b0b14fbe51592a8c42b881c">tw</a>;
<a name="l01267"></a>01267     <span class="keywordtype">int</span> res = 0;
<a name="l01268"></a>01268     <span class="keywordtype">int</span> namesLim = ud-&gt;<a class="code" href="structsync__update__data.html#a19060fdeb1e72c8aa562ddcba82744ff">namesAdded</a>+<a class="code" href="sync__diff_8c.html#ad6ea5755329f76c1602ad6ba25a27daf">namesYieldInc</a>;
<a name="l01269"></a>01269     <span class="keywordflow">if</span> (head != NULL) {
<a name="l01270"></a>01270         <span class="keywordflow">while</span> (res == 0) {
<a name="l01271"></a>01271             <span class="keyword">struct </span><a class="code" href="struct_sync_tree_worker_entry.html">SyncTreeWorkerEntry</a> *ent = <a class="code" href="_sync_tree_worker_8c.html#a776013fec43bda3e07895da7e668f05a">SyncTreeWorkerTop</a>(head);
<a name="l01272"></a>01272             <span class="keywordflow">if</span> (ent == NULL) <span class="keywordflow">break</span>;
<a name="l01273"></a>01273             <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#aa98b86e01f36d39897ed843711728a36">cacheEntry</a>;
<a name="l01274"></a>01274             <span class="keywordflow">if</span> (ce == NULL)  {
<a name="l01275"></a>01275                 <span class="comment">// should not happen</span>
<a name="l01276"></a>01276                 res = -__LINE__;
<a name="l01277"></a>01277                 <span class="keywordflow">break</span>;
<a name="l01278"></a>01278             }
<a name="l01279"></a>01279             <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *nc = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a>;
<a name="l01280"></a>01280             <span class="keywordflow">if</span> (nc == NULL) nc = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a>;
<a name="l01281"></a>01281             <span class="keywordflow">if</span> (nc == NULL) {
<a name="l01282"></a>01282                 <span class="comment">// should not happen</span>
<a name="l01283"></a>01283                 res = -__LINE__;
<a name="l01284"></a>01284                 <span class="keywordflow">break</span>;
<a name="l01285"></a>01285             }
<a name="l01286"></a>01286             <span class="keywordtype">int</span> lim = nc-&gt;<a class="code" href="struct_sync_node_composite.html#a29c915fd509d8e74edf1d862f357915a" title="number of references">refLen</a>;
<a name="l01287"></a>01287             <span class="keywordflow">if</span> (ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a> &gt;= lim) {
<a name="l01288"></a>01288                 <span class="comment">// done with the current level, go back to the previous level</span>
<a name="l01289"></a>01289                 ent = <a class="code" href="_sync_tree_worker_8c.html#a0029e127047a93efbc28a7b93e1ae005" title="pops the stack and returns the top entry popping an empty stack has no effect and...">SyncTreeWorkerPop</a>(head);
<a name="l01290"></a>01290                 <span class="keywordflow">if</span> (ent == NULL) <span class="keywordflow">break</span>;
<a name="l01291"></a>01291                 ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l01292"></a>01292             } <span class="keywordflow">else</span> {
<a name="l01293"></a>01293                 <span class="keyword">struct </span><a class="code" href="struct_sync_node_elem.html">SyncNodeElem</a> *ep = &amp;nc-&gt;<a class="code" href="struct_sync_node_composite.html#a2d6c08c55513380b341cf6ef74aab2d5" title="pointer to references array">refs</a>[ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>];
<a name="l01294"></a>01294                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="struct_sync_node_elem.html#a770ab2553870198f1b5dbc1a7302eccb" title="leaf/composite flag">kind</a> &amp; <a class="code" href="_sync_node_8h.html#ab268103cfe0f550f6c750922e68b4706a814b9a3505f28764701d289e71b8a649" title="leaf">SyncElemKind_leaf</a>) {
<a name="l01295"></a>01295                     <span class="comment">// a leaf, so the element name is inline</span>
<a name="l01296"></a>01296                     <span class="keyword">enum</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64">SyncCompareResult</a> cmp = <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64a40ed003d6315e67fb76e3a251c61bf8b">SCR_after</a>;
<a name="l01297"></a>01297                     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = NULL;
<a name="l01298"></a>01298                     <span class="keywordtype">int</span> ax = ud-&gt;<a class="code" href="structsync__update__data.html#ae5d5991473ca013be08c280623060509">ax</a>;
<a name="l01299"></a>01299                     <span class="keywordtype">int</span> aLen = ud-&gt;<a class="code" href="structsync__update__data.html#af93ce2f9b944704a210429631edae49c" title="sorted names from start_sync_update">adding</a>-&gt;<a class="code" href="struct_sync_name_accum.html#a43e6bf3321957d08f4985443cc36555d">len</a>;
<a name="l01300"></a>01300 
<a name="l01301"></a>01301                     <span class="keywordflow">if</span> (ax &lt; aLen) {
<a name="l01302"></a>01302                         name = ud-&gt;<a class="code" href="structsync__update__data.html#af93ce2f9b944704a210429631edae49c" title="sorted names from start_sync_update">adding</a>-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[ax].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a>;
<a name="l01303"></a>01303                         <span class="keywordflow">if</span> (name != NULL) cmp = <a class="code" href="_sync_node_8c.html#a7102b95fead88e5e2eb47387583d4771" title="Compares a name against the leaf in the element.">SyncNodeCompareLeaf</a>(nc, ep, name);
<a name="l01304"></a>01304                     }
<a name="l01305"></a>01305                     <span class="keywordflow">switch</span> (cmp) {
<a name="l01306"></a>01306                         <span class="keywordflow">case</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64a0c33200977bb75a132aa6fdcfc354ea4">SCR_before</a>:
<a name="l01307"></a>01307                             <span class="comment">// add the name from src</span>
<a name="l01308"></a>01308                             ud-&gt;<a class="code" href="structsync__update__data.html#af93ce2f9b944704a210429631edae49c" title="sorted names from start_sync_update">adding</a>-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[ax].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a> = NULL;
<a name="l01309"></a>01309                             <a class="code" href="sync__diff_8c.html#ae674232388177bfa913955bbcff76aa6">add_update_name</a>(ud, name, 1);
<a name="l01310"></a>01310                             ud-&gt;<a class="code" href="structsync__update__data.html#ae5d5991473ca013be08c280623060509">ax</a> = ax+1;
<a name="l01311"></a>01311                         <span class="keywordflow">case</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64ae59232c058740e4c8407b05a3d2a30f7">SCR_min</a>:
<a name="l01312"></a>01312                             <span class="comment">// advance the src, don&#39;t add</span>
<a name="l01313"></a>01313                             ud-&gt;<a class="code" href="structsync__update__data.html#ae5d5991473ca013be08c280623060509">ax</a> = ax+1;
<a name="l01314"></a>01314                             <span class="keywordflow">break</span>;
<a name="l01315"></a>01315                         <span class="keywordflow">case</span> <a class="code" href="_sync_node_8h.html#a676af60dcd2e1e333fc652a129e04a64a40ed003d6315e67fb76e3a251c61bf8b">SCR_after</a>:
<a name="l01316"></a>01316                             <span class="comment">// add the name from the tree</span>
<a name="l01317"></a>01317                             <a class="code" href="sync__diff_8c.html#aaf9c87ebf674e592c7bcb15aebbe937e">extractBuf</a>(cb, nc, ep);
<a name="l01318"></a>01318                             <a class="code" href="sync__diff_8c.html#ae674232388177bfa913955bbcff76aa6">add_update_name</a>(ud, <a class="code" href="_sync_util_8c.html#a01fc44dbffb2f846caf907c293b98c02">SyncCopyName</a>(cb), 0);
<a name="l01319"></a>01319                             ent-&gt;<a class="code" href="struct_sync_tree_worker_entry.html#abe16b82b261935565b6a82ba4bcc3fca">pos</a>++;
<a name="l01320"></a>01320                             <span class="keywordflow">break</span>;
<a name="l01321"></a>01321                         <span class="keywordflow">default</span>:
<a name="l01322"></a>01322                             <span class="comment">// this is not kosher</span>
<a name="l01323"></a>01323                             res = -__LINE__;
<a name="l01324"></a>01324                             <span class="keywordflow">break</span>;
<a name="l01325"></a>01325                     }
<a name="l01326"></a>01326                     <span class="keywordflow">if</span> (ud-&gt;<a class="code" href="structsync__update__data.html#a19060fdeb1e72c8aa562ddcba82744ff">namesAdded</a> &gt;= namesLim) {
<a name="l01327"></a>01327                         int64_t dt = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(ud-&gt;<a class="code" href="structsync__update__data.html#a3723fa968d54f79ecc3da4bbcef7091c">entryTime</a>, <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>());
<a name="l01328"></a>01328                         <span class="keywordflow">if</span> (dt &gt;= <a class="code" href="sync__diff_8c.html#a01f91d5802d6020d15662f4afea91e9f">namesYieldMicros</a>) {
<a name="l01329"></a>01329                             <span class="comment">// need to yield</span>
<a name="l01330"></a>01330                             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>)
<a name="l01331"></a>01331                                 <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;yield&quot;</span>);
<a name="l01332"></a>01332                             <span class="keywordflow">return</span> 0;
<a name="l01333"></a>01333                         }
<a name="l01334"></a>01334                         namesLim += <a class="code" href="sync__diff_8c.html#ad6ea5755329f76c1602ad6ba25a27daf">namesYieldInc</a>;
<a name="l01335"></a>01335                     }
<a name="l01336"></a>01336                 } <span class="keywordflow">else</span> {
<a name="l01337"></a>01337                     <span class="comment">// a node, so push into it</span>
<a name="l01338"></a>01338                     ent = <a class="code" href="_sync_tree_worker_8c.html#a10a364304f0c94e2e44252cf24ed6572" title="pushes into the node at the current position">SyncTreeWorkerPush</a>(head);
<a name="l01339"></a>01339                     <span class="keywordflow">if</span> (ent == NULL) {
<a name="l01340"></a>01340                         res = -__LINE__;
<a name="l01341"></a>01341                         <span class="keywordflow">break</span>;
<a name="l01342"></a>01342                     }                
<a name="l01343"></a>01343                 }
<a name="l01344"></a>01344             }
<a name="l01345"></a>01345         }
<a name="l01346"></a>01346     }
<a name="l01347"></a>01347     <span class="keywordflow">if</span> (res == 0) {
<a name="l01348"></a>01348         <span class="comment">// done with the tree, move items from the src</span>
<a name="l01349"></a>01349         <span class="keywordtype">int</span> ax = ud-&gt;<a class="code" href="structsync__update__data.html#ae5d5991473ca013be08c280623060509">ax</a>;
<a name="l01350"></a>01350         <span class="keywordtype">int</span> aLen = ud-&gt;<a class="code" href="structsync__update__data.html#af93ce2f9b944704a210429631edae49c" title="sorted names from start_sync_update">adding</a>-&gt;<a class="code" href="struct_sync_name_accum.html#a43e6bf3321957d08f4985443cc36555d">len</a>;
<a name="l01351"></a>01351         <span class="keywordflow">while</span> (ax &lt; aLen) {
<a name="l01352"></a>01352             <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = ud-&gt;<a class="code" href="structsync__update__data.html#af93ce2f9b944704a210429631edae49c" title="sorted names from start_sync_update">adding</a>-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[ax].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a>;
<a name="l01353"></a>01353             ud-&gt;<a class="code" href="structsync__update__data.html#af93ce2f9b944704a210429631edae49c" title="sorted names from start_sync_update">adding</a>-&gt;<a class="code" href="struct_sync_name_accum.html#af3b404ba438b87e0b363398dd20b4a1f">ents</a>[ax].<a class="code" href="struct_sync_name_accum_entry.html#a4cb7dff04e4e2a74edcfc20368ad58b4">name</a> = NULL;
<a name="l01354"></a>01354             <a class="code" href="sync__diff_8c.html#ae674232388177bfa913955bbcff76aa6">add_update_name</a>(ud, name, 1);
<a name="l01355"></a>01355             ax++;
<a name="l01356"></a>01356         }
<a name="l01357"></a>01357         ud-&gt;<a class="code" href="structsync__update__data.html#ae5d5991473ca013be08c280623060509">ax</a> = ax;
<a name="l01358"></a>01358         res = 1;
<a name="l01359"></a>01359     }
<a name="l01360"></a>01360     <span class="keywordflow">return</span> res;
<a name="l01361"></a>01361 }
<a name="l01362"></a>01362 
<a name="l01363"></a>01363 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01364"></a><a class="code" href="sync__diff_8c.html#adb2f80f09746c793e14ffb9fbda81a3b">01364</a> <a class="code" href="sync__diff_8c.html#adb2f80f09746c793e14ffb9fbda81a3b">updateError</a>(<span class="keyword">struct</span> <a class="code" href="structsync__update__data.html">sync_update_data</a> *ud) {
<a name="l01365"></a>01365     <span class="keywordflow">if</span> (ud != NULL) {
<a name="l01366"></a>01366         <span class="keyword">struct </span><a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev = ud-&gt;<a class="code" href="structsync__update__data.html#a8a4d113ce8990e961a9496424d8c0847" title="progress event">ev</a>;
<a name="l01367"></a>01367         <span class="keywordflow">if</span> (ev != NULL) {
<a name="l01368"></a>01368             ud-&gt;<a class="code" href="structsync__update__data.html#a8a4d113ce8990e961a9496424d8c0847" title="progress event">ev</a> = NULL;
<a name="l01369"></a>01369             ev-&gt;<a class="code" href="structccn__scheduled__event.html#a4f4c36335e9001eaca5442f672798e95">evdata</a> = NULL;
<a name="l01370"></a>01370         }
<a name="l01371"></a>01371         ud-&gt;<a class="code" href="structsync__update__data.html#a67f89b07bc95f9f25c4184b5d22326a1">state</a> = <a class="code" href="sync__diff_8h.html#a3786a893383525288e5f73ce5feb0a43af6231151b8c191ec8435d2aa77f50809">sync_update_state_error</a>;
<a name="l01372"></a>01372     }
<a name="l01373"></a>01373     <span class="keywordflow">return</span> -1;
<a name="l01374"></a>01374 }
<a name="l01375"></a>01375 
<a name="l01376"></a>01376 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01377"></a><a class="code" href="sync__diff_8c.html#ad7dd34a571d7610744d405d6d20f5e8d">01377</a> <a class="code" href="sync__diff_8c.html#ad7dd34a571d7610744d405d6d20f5e8d">updateAction</a>(<span class="keyword">struct</span> ccn_schedule *sched,
<a name="l01378"></a>01378              <span class="keywordtype">void</span> *clienth,
<a name="l01379"></a>01379              <span class="keyword">struct</span> <a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev,
<a name="l01380"></a>01380              <span class="keywordtype">int</span> flags) {
<a name="l01381"></a>01381     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.updateAction&quot;</span>;
<a name="l01382"></a>01382     int64_t now = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l01383"></a>01383     <span class="keyword">struct </span><a class="code" href="structsync__update__data.html">sync_update_data</a> *ud = (<span class="keyword">struct </span><a class="code" href="structsync__update__data.html">sync_update_data</a> *) ev-&gt;<a class="code" href="structccn__scheduled__event.html#a4f4c36335e9001eaca5442f672798e95">evdata</a>;
<a name="l01384"></a>01384     <span class="keyword">struct</span> <a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *<a class="code" href="structsync__update__data.html#ae27a2fd5da60493df931427349b1419f">root</a> = ud-&gt;<a class="code" href="structsync__update__data.html#ae27a2fd5da60493df931427349b1419f">root</a>;
<a name="l01385"></a>01385     <span class="keyword">struct</span> <a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = <a class="code" href="structsync__update__data.html#ae27a2fd5da60493df931427349b1419f">root</a>-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>;
<a name="l01386"></a>01386     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = base-&gt;debug;
<a name="l01387"></a>01387     
<a name="l01388"></a>01388     if (ud == NULL) {
<a name="l01389"></a>01389         <span class="comment">// cancelled some time ago</span>
<a name="l01390"></a>01390         <span class="keywordflow">return</span> -1;
<a name="l01391"></a>01391     }
<a name="l01392"></a>01392     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="schedule_8h.html#a705b7a47118864084280c615c0e6a2de">CCN_SCHEDULE_CANCEL</a>) {
<a name="l01393"></a>01393         <span class="comment">// cancelled (rescheduled)</span>
<a name="l01394"></a>01394         ud-&gt;<a class="code" href="structsync__update__data.html#a8a4d113ce8990e961a9496424d8c0847" title="progress event">ev</a> = NULL;
<a name="l01395"></a>01395         <span class="keywordflow">return</span> -1;
<a name="l01396"></a>01396     }
<a name="l01397"></a>01397     
<a name="l01398"></a>01398     ud-&gt;<a class="code" href="structsync__update__data.html#a3723fa968d54f79ecc3da4bbcef7091c">entryTime</a> = now;
<a name="l01399"></a>01399     
<a name="l01400"></a>01400     <span class="keywordflow">switch</span> (ud-&gt;<a class="code" href="structsync__update__data.html#a67f89b07bc95f9f25c4184b5d22326a1">state</a>) {
<a name="l01401"></a>01401         <span class="keywordflow">case</span> <a class="code" href="sync__diff_8h.html#a3786a893383525288e5f73ce5feb0a43abd92a419693725472c68e3acf34eaea0">sync_update_state_init</a>: {
<a name="l01402"></a>01402             <span class="comment">// we are mostly initialized</span>
<a name="l01403"></a>01403             <span class="keywordflow">if</span> (<a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l01404"></a>01404                 <a class="code" href="sync__diff_8c.html#a677c4508262ab00cdea51b16065eac17">showCacheEntry1</a>(<a class="code" href="structsync__update__data.html#ae27a2fd5da60493df931427349b1419f">root</a>, here, <span class="stringliteral">&quot;at init&quot;</span>, ud-&gt;<a class="code" href="structsync__update__data.html#afd203c8742791889903eea3a6156194f">ceStart</a>);
<a name="l01405"></a>01405             }
<a name="l01406"></a>01406             <span class="keywordtype">int</span> res = <a class="code" href="sync__diff_8c.html#af56e897b6345d7acf11d6d7eaca1a37d">merge_names</a>(ud);
<a name="l01407"></a>01407             <span class="keywordflow">if</span> (res == 0) <span class="keywordflow">break</span>;
<a name="l01408"></a>01408             <span class="comment">// not done yet, pause requested</span>
<a name="l01409"></a>01409             res = <a class="code" href="sync__diff_8c.html#a72146a563f8150859821220b8665837b">node_from_names</a>(ud, 0);
<a name="l01410"></a>01410             <span class="comment">// done, either normally or with error</span>
<a name="l01411"></a>01411             <span class="comment">// free the resources</span>
<a name="l01412"></a>01412             <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;ud-&gt;<a class="code" href="structsync__update__data.html#a95435eb475deb0007ba15c50be1d088f">cb</a>);
<a name="l01413"></a>01413             <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01414"></a>01414                 <span class="comment">// this is bad news!</span>
<a name="l01415"></a>01415                 <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(<a class="code" href="structsync__update__data.html#ae27a2fd5da60493df931427349b1419f">root</a>, here, <span class="stringliteral">&quot;merge names&quot;</span>, __LINE__);
<a name="l01416"></a>01416                 <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#adb2f80f09746c793e14ffb9fbda81a3b">updateError</a>(ud);
<a name="l01417"></a>01417             }
<a name="l01418"></a>01418             ud-&gt;<a class="code" href="structsync__update__data.html#a67f89b07bc95f9f25c4184b5d22326a1">state</a> = <a class="code" href="sync__diff_8h.html#a3786a893383525288e5f73ce5feb0a43ab61cf365039f6b818ef0cc5c3c05f680">sync_update_state_busy</a>;
<a name="l01419"></a>01419         }
<a name="l01420"></a>01420         <span class="keywordflow">case</span> <a class="code" href="sync__diff_8h.html#a3786a893383525288e5f73ce5feb0a43ab61cf365039f6b818ef0cc5c3c05f680">sync_update_state_busy</a>: {
<a name="l01421"></a>01421             <span class="comment">// ud-&gt;nodes has the nodes created from the names</span>
<a name="l01422"></a>01422             <span class="comment">// the last step is to make up the node superstructure</span>
<a name="l01423"></a>01423             <span class="keywordflow">if</span> (<a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l01424"></a>01424                 <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(<a class="code" href="structsync__update__data.html#ae27a2fd5da60493df931427349b1419f">root</a>, here, <span class="stringliteral">&quot;sync_update_state_busy&quot;</span>);
<a name="l01425"></a>01425             }
<a name="l01426"></a>01426             <span class="keywordtype">int</span> initCount = <a class="code" href="structsync__update__data.html#ae27a2fd5da60493df931427349b1419f">root</a>-&gt;<a class="code" href="struct_sync_root_struct.html#ad1d9b29ffef3be9642a6e0a0d2c4ee02" title="private to SyncRoot">priv</a>-&gt;<a class="code" href="struct_sync_root_private.html#ad184fb3f8d57f787b50f2c094d86eebc">currentSize</a>;
<a name="l01427"></a>01427             <span class="keywordtype">int</span> count = ud-&gt;<a class="code" href="structsync__update__data.html#a19060fdeb1e72c8aa562ddcba82744ff">namesAdded</a>;
<a name="l01428"></a>01428             <span class="keywordflow">if</span> (count &gt; 0) {
<a name="l01429"></a>01429                 <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = <a class="code" href="sync__diff_8c.html#a41bfae51234a2b95442493843fc12ab9">node_from_nodes</a>(root, ud-&gt;<a class="code" href="structsync__update__data.html#a54c30a3acf32ec8669ce466e00b05af1" title="temp storage used while updating">nodes</a>);
<a name="l01430"></a>01430                 <span class="keywordflow">if</span> (ce == NULL) {
<a name="l01431"></a>01431                     count = <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad node_from_nodes()&quot;</span>, __LINE__);
<a name="l01432"></a>01432                 } <span class="keywordflow">else</span> {
<a name="l01433"></a>01433                     <a class="code" href="_sync_hash_cache_8c.html#a88b8496fee4324b2359f23e3c6dd9472" title="fetches the cache entry to be eligible, ce != NULL &amp;amp;&amp;amp; ce-&amp;gt;ncL != NULL...">SyncCacheEntryFetch</a>(ce);
<a name="l01434"></a>01434                     <span class="keyword">struct </span><a class="code" href="struct_sync_node_composite.html" title="A SyncNodeComposite object holds the necessary data for a sync tree node.">SyncNodeComposite</a> *nc = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a>;
<a name="l01435"></a>01435                     <span class="keywordflow">if</span> (nc == NULL) nc = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a>;
<a name="l01436"></a>01436                     <span class="keywordflow">if</span> (nc != NULL) {
<a name="l01437"></a>01437                         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *hash = <a class="code" href="_sync_util_8c.html#ae3d2194bffabb34d644a34297c834ecf">SyncLongHashToBuf</a>(&amp;nc-&gt;<a class="code" href="struct_sync_node_composite.html#afda83b9329537ddc4c035bb21d292896" title="space for accumulated hash">longHash</a>);
<a name="l01438"></a>01438                         <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01439"></a>01439                         <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce = <a class="code" href="_sync_hash_cache_8c.html#abcf5e784c52d971d943bddef80731954" title="based on the raw hash, ensure that a remote cache entry exists ent-&amp;gt;state |= set...">SyncHashEnter</a>(root-&gt;ch, 
<a name="l01440"></a>01440                                                                       hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>,
<a name="l01441"></a>01441                                                                       <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a9e849b0fed91e850763db20a54956128" title="a local node exists">SyncHashState_local</a>);
<a name="l01442"></a>01442                         now = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l01443"></a>01443                         ud-&gt;<a class="code" href="structsync__update__data.html#ac62c008e26334cbc402fa4dc7470f08a">ceStop</a> = ce;
<a name="l01444"></a>01444                         <span class="comment">// now that we have a new current hash, close out the deltas</span>
<a name="l01445"></a>01445                         int64_t dt = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(ud-&gt;<a class="code" href="structsync__update__data.html#a482162bc91d56387d879836f92285716">startTime</a>, now);
<a name="l01446"></a>01446                         dt = (dt + 500) / 1000;
<a name="l01447"></a>01447                         int64_t mh = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(ud-&gt;<a class="code" href="structsync__update__data.html#a3723fa968d54f79ecc3da4bbcef7091c">entryTime</a>, now);
<a name="l01448"></a>01448                         <span class="keywordflow">if</span> (mh &lt; ud-&gt;maxHold) mh = ud-&gt;<a class="code" href="structsync__update__data.html#a6a26c4a94de42743b236887d9b0856bf">maxHold</a>;
<a name="l01449"></a>01449                         mh = (mh + 500) / 1000;
<a name="l01450"></a>01450                         <span class="keywordflow">if</span> (<a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l01451"></a>01451                             <span class="keywordtype">char</span> temp[256];
<a name="l01452"></a>01452                             snprintf(temp, <span class="keyword">sizeof</span>(temp)-2,
<a name="l01453"></a>01453                                      <span class="stringliteral">&quot;%d.%03d secs [%d.%03d], %d names, depth %d, hash %s&quot;</span>,
<a name="l01454"></a>01454                                      (<span class="keywordtype">int</span>) (dt / 1000), (<span class="keywordtype">int</span>) (dt % 1000),
<a name="l01455"></a>01455                                      (<span class="keywordtype">int</span>) (mh / 1000), (<span class="keywordtype">int</span>) (mh % 1000),
<a name="l01456"></a>01456                                      (<span class="keywordtype">int</span>) count, (<span class="keywordtype">int</span>) nc-&gt;<a class="code" href="struct_sync_node_composite.html#a2394633cbdfbb3733266a8fef137f6e2" title="max tree depth (includes this node)">treeDepth</a>, hex);
<a name="l01457"></a>01457                             <a class="code" href="_sync_util_8c.html#aa20108b42fb1dbda5eb8825139ca7368">SyncNoteSimple2</a>(root, here, <span class="stringliteral">&quot;done&quot;</span>, temp);
<a name="l01458"></a>01458                         }
<a name="l01459"></a>01459                         <span class="keywordflow">if</span> (ud-&gt;<a class="code" href="structsync__update__data.html#afd203c8742791889903eea3a6156194f">ceStart</a> != ud-&gt;<a class="code" href="structsync__update__data.html#ac62c008e26334cbc402fa4dc7470f08a">ceStop</a>) {
<a name="l01460"></a>01460                             <span class="comment">// only do this if the update got something</span>
<a name="l01461"></a>01461                             <span class="keywordflow">if</span> (<a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l01462"></a>01462                                 <span class="keywordtype">char</span> temp[64];
<a name="l01463"></a>01463                                 snprintf(temp, <span class="keyword">sizeof</span>(temp),
<a name="l01464"></a>01464                                          <span class="stringliteral">&quot;done (%d)&quot;</span>,
<a name="l01465"></a>01465                                          count);
<a name="l01466"></a>01466                                 <a class="code" href="sync__diff_8c.html#a693571491e7f8b307640238175b6aa57">showCacheEntry2</a>(root, <span class="stringliteral">&quot;Sync.$Update&quot;</span>, temp,
<a name="l01467"></a>01467                                                 ud-&gt;<a class="code" href="structsync__update__data.html#afd203c8742791889903eea3a6156194f">ceStart</a>, ud-&gt;<a class="code" href="structsync__update__data.html#ac62c008e26334cbc402fa4dc7470f08a">ceStop</a>);
<a name="l01468"></a>01468                             }
<a name="l01469"></a>01469                         } 
<a name="l01470"></a>01470                         free(hex);
<a name="l01471"></a>01471                     } <span class="keywordflow">else</span> {
<a name="l01472"></a>01472                         count = <a class="code" href="_sync_util_8c.html#a6254a7aa1971aad66d1d59e7d53f6403">SyncNoteFailed</a>(root, here, <span class="stringliteral">&quot;bad node&quot;</span>, __LINE__);
<a name="l01473"></a>01473                     }
<a name="l01474"></a>01474                 }
<a name="l01475"></a>01475             }
<a name="l01476"></a>01476             <span class="keywordflow">if</span> (count &lt;= initCount) {
<a name="l01477"></a>01477                 <span class="comment">// we were supposed to add something?</span>
<a name="l01478"></a>01478                 <span class="keywordflow">if</span> (<a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a67e055da2ff13d71c36d66687a54c259" title="Low-volume informational.">CCNL_INFO</a>) {
<a name="l01479"></a>01479                     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *hash = root-&gt;currentHash;
<a name="l01480"></a>01480                     <span class="keywordtype">char</span> *hex = <a class="code" href="_sync_util_8c.html#a7892d18ecb7d3ee55b7d2d1ec64c275b">SyncHexStr</a>(hash-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, hash-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01481"></a>01481                     <a class="code" href="_sync_base_8c.html#a126bf64c323813fa9a759b0f8c7d6ec1">sync_msg</a>(base,
<a name="l01482"></a>01482                              <span class="stringliteral">&quot;%s, root#%u, note, count %d, initCount %d, hash %s&quot;</span>,
<a name="l01483"></a>01483                              here, root-&gt;rootId, count, initCount, hex);
<a name="l01484"></a>01484                     free(hex);
<a name="l01485"></a>01485                 }
<a name="l01486"></a>01486             }
<a name="l01487"></a>01487             ud-&gt;<a class="code" href="structsync__update__data.html#a8a4d113ce8990e961a9496424d8c0847" title="progress event">ev</a> = NULL;
<a name="l01488"></a>01488             ev-&gt;<a class="code" href="structccn__scheduled__event.html#a4f4c36335e9001eaca5442f672798e95">evdata</a> = NULL;
<a name="l01489"></a>01489             ud-&gt;<a class="code" href="structsync__update__data.html#a67f89b07bc95f9f25c4184b5d22326a1">state</a> = ((count &lt; 0) ? <a class="code" href="sync__diff_8h.html#a3786a893383525288e5f73ce5feb0a43af6231151b8c191ec8435d2aa77f50809">sync_update_state_error</a> : <a class="code" href="sync__diff_8h.html#a3786a893383525288e5f73ce5feb0a43a65974dc44d485be21ba5c47dfdf06617">sync_update_state_done</a>);
<a name="l01490"></a>01490             <span class="keywordflow">if</span> (<a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>)
<a name="l01491"></a>01491                 <a class="code" href="sync__diff_8c.html#a693571491e7f8b307640238175b6aa57">showCacheEntry2</a>(root, here, <span class="stringliteral">&quot;at exit&quot;</span>, ud-&gt;<a class="code" href="structsync__update__data.html#afd203c8742791889903eea3a6156194f">ceStart</a>, ud-&gt;<a class="code" href="structsync__update__data.html#ac62c008e26334cbc402fa4dc7470f08a">ceStop</a>);
<a name="l01492"></a>01492             <span class="keywordflow">if</span> (ud-&gt;<a class="code" href="structsync__update__data.html#a569d05589f22e952f099ae84ac415474">done_closure</a> != NULL) {
<a name="l01493"></a>01493                 <span class="comment">// notify the caller</span>
<a name="l01494"></a>01494                 ud-&gt;<a class="code" href="structsync__update__data.html#a569d05589f22e952f099ae84ac415474">done_closure</a>-&gt;<a class="code" href="structsync__done__closure.html#a501de5999eaacca19d2ca807f27232c5">update_data</a> = ud;
<a name="l01495"></a>01495                 ud-&gt;<a class="code" href="structsync__update__data.html#a569d05589f22e952f099ae84ac415474">done_closure</a>-&gt;<a class="code" href="structsync__done__closure.html#a8b27559822477f1b81b40b763405b3f5">done</a>(ud-&gt;<a class="code" href="structsync__update__data.html#a569d05589f22e952f099ae84ac415474">done_closure</a>);
<a name="l01496"></a>01496             }
<a name="l01497"></a>01497             <span class="keywordflow">return</span> -1;
<a name="l01498"></a>01498         }
<a name="l01499"></a>01499         <span class="keywordflow">default</span>: {
<a name="l01500"></a>01500             <span class="comment">// no reschedule</span>
<a name="l01501"></a>01501             ud-&gt;<a class="code" href="structsync__update__data.html#a8a4d113ce8990e961a9496424d8c0847" title="progress event">ev</a> = NULL;
<a name="l01502"></a>01502             ev-&gt;<a class="code" href="structccn__scheduled__event.html#a4f4c36335e9001eaca5442f672798e95">evdata</a> = NULL;
<a name="l01503"></a>01503             <span class="keywordflow">return</span> -1;
<a name="l01504"></a>01504         }
<a name="l01505"></a>01505     }
<a name="l01506"></a>01506     int64_t edt = <a class="code" href="_sync_util_8c.html#a25e11b5e280f99ed7d4e9ba08ec9a3f2">SyncDeltaTime</a>(ud-&gt;<a class="code" href="structsync__update__data.html#a3723fa968d54f79ecc3da4bbcef7091c">entryTime</a>, <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>());
<a name="l01507"></a>01507     <span class="keywordflow">if</span> (edt &gt; ud-&gt;<a class="code" href="structsync__update__data.html#a6a26c4a94de42743b236887d9b0856bf">maxHold</a>) ud-&gt;<a class="code" href="structsync__update__data.html#a6a26c4a94de42743b236887d9b0856bf">maxHold</a> = edt;
<a name="l01508"></a>01508     <span class="keywordflow">return</span> <a class="code" href="sync__diff_8c.html#a259cad241b04e57ac063e149d3fb511e">shortDelayMicros</a>;
<a name="l01509"></a>01509 }
<a name="l01510"></a>01510 <span class="comment"></span>
<a name="l01511"></a>01511 <span class="comment">/////////////////////////////////</span>
<a name="l01512"></a>01512 <span class="comment">//// External operations</span>
<a name="l01513"></a>01513 <span class="comment">/////////////////////////////////</span>
<a name="l01514"></a>01514 <span class="comment"></span>
<a name="l01515"></a>01515 <span class="keywordtype">int</span>
<a name="l01516"></a><a class="code" href="sync__diff_8h.html#a86612ec768575d85f0d28d310bc71cf9">01516</a> <a class="code" href="sync__diff_8c.html#a86612ec768575d85f0d28d310bc71cf9" title="sync_diff_start starts a differencing operation between two sync trees, specified...">sync_diff_start</a>(<span class="keyword">struct</span> <a class="code" href="structsync__diff__data.html">sync_diff_data</a> *sdd) {
<a name="l01517"></a>01517     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = sdd-&gt;<a class="code" href="structsync__diff__data.html#a4c835d54dc03229f2856a1e0966b0d1c">root</a>;
<a name="l01518"></a>01518     int64_t mark = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l01519"></a>01519     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceX = <a class="code" href="sync__diff_8c.html#a6eea619c02366baa2c0f7391a3d331f2">entryForHash</a>(root, sdd-&gt;<a class="code" href="structsync__diff__data.html#a5997cd58b4376ccf9f71e4bd7a454d1c">hashX</a>);
<a name="l01520"></a>01520     <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ceY = <a class="code" href="sync__diff_8c.html#a6eea619c02366baa2c0f7391a3d331f2">entryForHash</a>(root, sdd-&gt;<a class="code" href="structsync__diff__data.html#a55e8315cc447c98fca09ade2acd8ff23">hashY</a>);
<a name="l01521"></a>01521     
<a name="l01522"></a>01522     <span class="keywordflow">if</span> (ceX != NULL) ceX-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a6861960908cc217b639d3f1af6bbc520" title="time when entry last used in compare">lastUsed</a> = mark;
<a name="l01523"></a>01523     <span class="keywordflow">if</span> (ceY != NULL) ceY-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a6861960908cc217b639d3f1af6bbc520" title="time when entry last used in compare">lastUsed</a> = mark;
<a name="l01524"></a>01524     sdd-&gt;<a class="code" href="structsync__diff__data.html#a3f95b5a31ad339b0cd28f190288fe533" title="&amp;quot;local&amp;quot; tree walker state">twX</a> = <a class="code" href="_sync_tree_worker_8c.html#ab50ea183a52285c94049d758fa2cb966" title="create a new tree worker, based on the given cache ent != NULL: initialize from the...">SyncTreeWorkerCreate</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>, ceX);
<a name="l01525"></a>01525     sdd-&gt;<a class="code" href="structsync__diff__data.html#aea271c342899152f5e314fdea4a26ab9" title="&amp;quot;remote&amp;quot; tree walker state">twY</a> = <a class="code" href="_sync_tree_worker_8c.html#ab50ea183a52285c94049d758fa2cb966" title="create a new tree worker, based on the given cache ent != NULL: initialize from the...">SyncTreeWorkerCreate</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>, ceY);
<a name="l01526"></a>01526     
<a name="l01527"></a>01527     sdd-&gt;<a class="code" href="structsync__diff__data.html#ac88ec31f887b4813bf31a9ed624020a1" title="time marker for sync_diff_start">startTime</a> = mark;
<a name="l01528"></a>01528     sdd-&gt;<a class="code" href="structsync__diff__data.html#aa134e2b168f70a1869f32f5ecb819f6d" title="time marker for last compare step entry">lastEnter</a> = mark;
<a name="l01529"></a>01529     sdd-&gt;<a class="code" href="structsync__diff__data.html#a1b914638474fab198be467a5caa9c0b2" title="time marker for stall determination">lastMark</a> = mark;
<a name="l01530"></a>01530     sdd-&gt;<a class="code" href="structsync__diff__data.html#aa2feef8569ab535932ad3170e9c41170" title="time marker for last successul node fetch">lastFetchOK</a> = mark;
<a name="l01531"></a>01531     sdd-&gt;<a class="code" href="structsync__diff__data.html#a26751453e1f6d08681032db803534d4c" title="&amp;quot;local&amp;quot; tree scratch">cbX</a> = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01532"></a>01532     sdd-&gt;<a class="code" href="structsync__diff__data.html#a03e23c9e9c1a157371f956e74292fa24" title="&amp;quot;remote&amp;quot; tree scratch">cbY</a> = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01533"></a>01533     
<a name="l01534"></a>01534     sdd-&gt;<a class="code" href="structsync__diff__data.html#a106732432ae0dc955f522dab508edc01" title="cache entries being fetched">fetchQ</a> = NULL;
<a name="l01535"></a>01535     sdd-&gt;<a class="code" href="structsync__diff__data.html#a2b5e8bbacc8ece0572d43ce7101964c3" title="names added during this comparison">namesAdded</a> = 0;
<a name="l01536"></a>01536     sdd-&gt;<a class="code" href="structsync__diff__data.html#ab73d161b4048d7b47b90fc165460c2b6" title="number of busy remote node fetches">nodeFetchBusy</a> = 0;
<a name="l01537"></a>01537     sdd-&gt;<a class="code" href="structsync__diff__data.html#a2570461f217f175955736961a677216d" title="number of failed remote node fetches">nodeFetchFailed</a> = 0;
<a name="l01538"></a>01538     
<a name="l01539"></a>01539     sdd-&gt;<a class="code" href="structsync__diff__data.html#a67fc1283c7352412a50f417e07a855d9" title="summary state of comparison">state</a> = <a class="code" href="sync__diff_8h.html#ae0c609194fbe6e000ccea19e6591dd19a6443961c8f5bd345cb1d099c1a3c7555">sync_diff_state_init</a>;
<a name="l01540"></a>01540     
<a name="l01541"></a>01541     <a class="code" href="sync__diff_8c.html#ae67b3191df0edba9de445e0b36dc1b0b">kickCompare</a>(sdd, 1);
<a name="l01542"></a>01542     <span class="comment">// XXX - documented returns of negative and 0 can&#39;t happen.</span>
<a name="l01543"></a>01543     <span class="keywordflow">return</span>(1);
<a name="l01544"></a>01544 }
<a name="l01545"></a>01545 
<a name="l01546"></a>01546 <span class="comment">// the client uses sync_diff_note_node to note the completion of a node fetch</span>
<a name="l01547"></a>01547 <span class="comment">// the success of the fetch is inferred from the presence of a node object</span>
<a name="l01548"></a>01548 <span class="comment">// in the cache entry (either ce-&gt;ncL or ce-&gt;ncR will do)</span>
<a name="l01549"></a>01549 <span class="keywordtype">int</span>
<a name="l01550"></a><a class="code" href="sync__diff_8h.html#ac2dcc6edc4b46bbc8514086b8dc263de">01550</a> <a class="code" href="sync__diff_8c.html#ac2dcc6edc4b46bbc8514086b8dc263de" title="sync_diff_note_node is used to establish the result of the client closure sdd-&amp;gt;get...">sync_diff_note_node</a>(<span class="keyword">struct</span> <a class="code" href="structsync__diff__data.html">sync_diff_data</a> *sdd,
<a name="l01551"></a>01551                     <span class="keyword">struct</span> <a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ce) {
<a name="l01552"></a>01552     <span class="keywordtype">int</span> res = 0;
<a name="l01553"></a>01553     <span class="keywordflow">if</span> (ce != NULL) {
<a name="l01554"></a>01554         <span class="keyword">struct </span><a class="code" href="structsync__diff__fetch__data.html">sync_diff_fetch_data</a> *fd = <a class="code" href="sync__diff_8c.html#a06ceecb0e3976283d223d8c250cc9ff3">remNodeFetch</a>(sdd, ce);
<a name="l01555"></a>01555         <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = sdd-&gt;<a class="code" href="structsync__diff__data.html#a4c835d54dc03229f2856a1e0966b0d1c">root</a>;
<a name="l01556"></a>01556         <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l01557"></a>01557         <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l01558"></a>01558             <span class="keyword">static</span> <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.sync_diff_note_node&quot;</span>;
<a name="l01559"></a>01559             <span class="keywordtype">char</span> temp[256];
<a name="l01560"></a>01560             <span class="keywordtype">int</span> pos = 0;
<a name="l01561"></a>01561             <span class="keywordflow">if</span> (fd == NULL)
<a name="l01562"></a>01562                 pos += snprintf(temp+pos, <span class="keyword">sizeof</span>(temp)-pos, <span class="stringliteral">&quot;NULL!!!&quot;</span>);
<a name="l01563"></a>01563             <span class="keywordflow">else</span> {
<a name="l01564"></a>01564                 pos += snprintf(temp+pos, <span class="keyword">sizeof</span>(temp)-pos, <span class="stringliteral">&quot;fd OK&quot;</span>);
<a name="l01565"></a>01565             }
<a name="l01566"></a>01566             <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a> != NULL)
<a name="l01567"></a>01567                 pos += snprintf(temp+pos, <span class="keyword">sizeof</span>(temp)-pos, <span class="stringliteral">&quot;, ce-&gt;ncL OK&quot;</span>);
<a name="l01568"></a>01568             <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a> != NULL)
<a name="l01569"></a>01569                 pos += snprintf(temp+pos, <span class="keyword">sizeof</span>(temp)-pos, <span class="stringliteral">&quot;, ce-&gt;ncR OK&quot;</span>);
<a name="l01570"></a>01570             <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, temp);
<a name="l01571"></a>01571         }
<a name="l01572"></a>01572         <span class="keywordflow">if</span> (fd == NULL)
<a name="l01573"></a>01573             <span class="comment">// the supplied hash entry is not queued</span>
<a name="l01574"></a>01574             res = -1;
<a name="l01575"></a>01575         <span class="keywordflow">else</span> {
<a name="l01576"></a>01576             <span class="comment">// so far so good</span>
<a name="l01577"></a>01577             <span class="keyword">enum</span> <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381">SyncHashState</a> es = ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a>;
<a name="l01578"></a>01578             <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a> != NULL) {
<a name="l01579"></a>01579                 es |= <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a9e849b0fed91e850763db20a54956128" title="a local node exists">SyncHashState_local</a>;
<a name="l01580"></a>01580             }
<a name="l01581"></a>01581             <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a> != NULL) {
<a name="l01582"></a>01582                 es |= <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381aec73ed0d374163f11f2d715ce0a3c197" title="a remote hash has been seen">SyncHashState_remote</a>;
<a name="l01583"></a>01583                 <span class="keywordflow">if</span> (es &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a9e849b0fed91e850763db20a54956128" title="a local node exists">SyncHashState_local</a>)
<a name="l01584"></a>01584                     es |= <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381ae306c2dc55f40bf7e12c45acaf8d7a26" title="remote hash known covered by the local root">SyncHashState_covered</a>;
<a name="l01585"></a>01585             }
<a name="l01586"></a>01586             <span class="keywordflow">if</span> (es &amp; <a class="code" href="_sync_hash_cache_8h.html#adc94d2e43fee7f723745607e3c3a1381a543f8cfea4a3c99237abeac7e563b90b" title="remote node is being fetched">SyncHashState_fetching</a>) {
<a name="l01587"></a>01587                 es = es - SyncHashState_fetching;
<a name="l01588"></a>01588             }
<a name="l01589"></a>01589             ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a35ea2895580f670d81cc43cdc9505d8f" title="state bits">state</a> = es;
<a name="l01590"></a>01590             <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#a94d0a088221aef50aace5c203075d686" title="the local node in memory">ncL</a> != NULL || ce-&gt;<a class="code" href="struct_sync_hash_cache_entry.html#ac36cf9f951468f67bd6bdb6afba90636" title="some remote node in memory">ncR</a> != NULL) {
<a name="l01591"></a>01591                 <span class="comment">// the fetch is OK!</span>
<a name="l01592"></a>01592                 int64_t mark = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l01593"></a>01593                 res = 1;
<a name="l01594"></a>01594                 sdd-&gt;<a class="code" href="structsync__diff__data.html#aa2feef8569ab535932ad3170e9c41170" title="time marker for last successul node fetch">lastFetchOK</a> = mark;
<a name="l01595"></a>01595             } <span class="keywordflow">else</span> {
<a name="l01596"></a>01596                 <span class="comment">// the fetch was not successful</span>
<a name="l01597"></a>01597                 res = 0;
<a name="l01598"></a>01598                 sdd-&gt;<a class="code" href="structsync__diff__data.html#a2570461f217f175955736961a677216d" title="number of failed remote node fetches">nodeFetchFailed</a>++;
<a name="l01599"></a>01599             }
<a name="l01600"></a>01600             <a class="code" href="sync__diff_8c.html#a7e6d6e49a77c4bbd419a15345182d344">freeFetchData</a>(fd);
<a name="l01601"></a>01601         }
<a name="l01602"></a>01602     }
<a name="l01603"></a>01603     <a class="code" href="sync__diff_8c.html#ae67b3191df0edba9de445e0b36dc1b0b">kickCompare</a>(sdd, 1);
<a name="l01604"></a>01604     <span class="keywordflow">return</span> res;
<a name="l01605"></a>01605 }
<a name="l01606"></a>01606 
<a name="l01607"></a>01607 <span class="keywordtype">int</span>
<a name="l01608"></a><a class="code" href="sync__diff_8h.html#a1be9171a2f9c634b8562511688f16222">01608</a> <a class="code" href="sync__diff_8c.html#a1be9171a2f9c634b8562511688f16222" title="sync_diff_stop will stop the differencing operation if it has not completed.">sync_diff_stop</a>(<span class="keyword">struct</span> <a class="code" href="structsync__diff__data.html">sync_diff_data</a> *sdd) {
<a name="l01609"></a>01609     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = sdd-&gt;<a class="code" href="structsync__diff__data.html#a4c835d54dc03229f2856a1e0966b0d1c">root</a>;
<a name="l01610"></a>01610     <span class="keywordflow">if</span> (sdd == NULL
<a name="l01611"></a>01611         || sdd-&gt;<a class="code" href="structsync__diff__data.html#a67fc1283c7352412a50f417e07a855d9" title="summary state of comparison">state</a> == <a class="code" href="sync__diff_8h.html#ae0c609194fbe6e000ccea19e6591dd19af4843063aa987f6dcf5db4f0042b8de4">sync_diff_state_done</a>
<a name="l01612"></a>01612         || sdd-&gt;<a class="code" href="structsync__diff__data.html#a67fc1283c7352412a50f417e07a855d9" title="summary state of comparison">state</a> == <a class="code" href="sync__diff_8h.html#ae0c609194fbe6e000ccea19e6591dd19a6443961c8f5bd345cb1d099c1a3c7555">sync_diff_state_init</a>) <span class="keywordflow">return</span> 0;
<a name="l01613"></a>01613     <span class="keyword">struct </span><a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev = sdd-&gt;<a class="code" href="structsync__diff__data.html#a10ee698bc4a7227ceb48d52f9d113600" title="progress event">ev</a>;
<a name="l01614"></a>01614     <span class="keywordflow">if</span> (ev != NULL &amp;&amp; ev-&gt;<a class="code" href="structccn__scheduled__event.html#a4f4c36335e9001eaca5442f672798e95">evdata</a> == sdd) {
<a name="l01615"></a>01615         <span class="comment">// no more callbacks</span>
<a name="l01616"></a>01616         <a class="code" href="schedule_8h.html#a0b636a012b97cc600634684736018fe7" title="Cancel a scheduled event.">ccn_schedule_cancel</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a86379b5e56784ebff9e36a2da1976ef6">sd</a>-&gt;<a class="code" href="structsync__plumbing.html#ab5e574093a95dfb432043980ce9a5e17">sched</a>, ev);
<a name="l01617"></a>01617         sdd-&gt;<a class="code" href="structsync__diff__data.html#a10ee698bc4a7227ceb48d52f9d113600" title="progress event">ev</a> = NULL;
<a name="l01618"></a>01618     }
<a name="l01619"></a>01619     <a class="code" href="sync__diff_8c.html#a8d52b9e0db366a10c79a3014f2319d75">resetDiffData</a>(sdd);
<a name="l01620"></a>01620     <span class="keywordflow">return</span> 1; 
<a name="l01621"></a>01621 }
<a name="l01622"></a>01622 
<a name="l01623"></a>01623 <span class="keywordtype">int</span>
<a name="l01624"></a><a class="code" href="sync__diff_8h.html#a3bb272eae464ab13b38049b71d84f3d1">01624</a> <a class="code" href="sync__diff_8c.html#a3bb272eae464ab13b38049b71d84f3d1" title="sync_update_start is called to start an update of ud-&amp;gt;ceStart, based on the names...">sync_update_start</a>(<span class="keyword">struct</span> <a class="code" href="structsync__update__data.html">sync_update_data</a> *ud, <span class="keyword">struct</span> <a class="code" href="struct_sync_name_accum.html">SyncNameAccum</a> *acc) {
<a name="l01625"></a>01625     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.sync_update_start&quot;</span>;
<a name="l01626"></a>01626     int64_t now = <a class="code" href="_sync_util_8c.html#a17f22694d0381f7cc758e3cb3a504283">SyncCurrentTime</a>();
<a name="l01627"></a>01627     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = ud-&gt;<a class="code" href="structsync__update__data.html#ae27a2fd5da60493df931427349b1419f">root</a>;
<a name="l01628"></a>01628     <span class="keyword">struct </span><a class="code" href="struct_sync_base_struct.html">SyncBaseStruct</a> *base = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>;
<a name="l01629"></a>01629     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = base-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l01630"></a>01630     <span class="keywordflow">switch</span> (ud-&gt;<a class="code" href="structsync__update__data.html#a67f89b07bc95f9f25c4184b5d22326a1">state</a>) {
<a name="l01631"></a>01631         <span class="keywordflow">case</span> <a class="code" href="sync__diff_8h.html#a3786a893383525288e5f73ce5feb0a43abd92a419693725472c68e3acf34eaea0">sync_update_state_init</a>:
<a name="l01632"></a>01632         <span class="keywordflow">case</span> <a class="code" href="sync__diff_8h.html#a3786a893383525288e5f73ce5feb0a43af6231151b8c191ec8435d2aa77f50809">sync_update_state_error</a>:
<a name="l01633"></a>01633         <span class="keywordflow">case</span> <a class="code" href="sync__diff_8h.html#a3786a893383525288e5f73ce5feb0a43a65974dc44d485be21ba5c47dfdf06617">sync_update_state_done</a>: {
<a name="l01634"></a>01634             <span class="comment">// OK to restart</span>
<a name="l01635"></a>01635             <span class="keywordflow">if</span> (acc == NULL || acc-&gt;<a class="code" href="struct_sync_name_accum.html#a43e6bf3321957d08f4985443cc36555d">len</a> == 0) <span class="keywordflow">return</span> 0;
<a name="l01636"></a>01636             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l01637"></a>01637                 <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;starting&quot;</span>);
<a name="l01638"></a>01638             }
<a name="l01639"></a>01639             <span class="keyword">struct </span><a class="code" href="struct_sync_hash_cache_entry.html">SyncHashCacheEntry</a> *ent = ud-&gt;<a class="code" href="structsync__update__data.html#afd203c8742791889903eea3a6156194f">ceStart</a>;
<a name="l01640"></a>01640             ud-&gt;<a class="code" href="structsync__update__data.html#a482162bc91d56387d879836f92285716">startTime</a> = now;
<a name="l01641"></a>01641             ud-&gt;<a class="code" href="structsync__update__data.html#ac62c008e26334cbc402fa4dc7470f08a">ceStop</a> = NULL;
<a name="l01642"></a>01642             <a class="code" href="sync__diff_8c.html#ab9656b13bde807ac27980d88fa49f026">resetUpdateData</a>(ud);
<a name="l01643"></a>01643             ud-&gt;<a class="code" href="structsync__update__data.html#af93ce2f9b944704a210429631edae49c" title="sorted names from start_sync_update">adding</a> = <a class="code" href="_sync_util_8c.html#a37502b84914417129a189d02e26cdc4f" title="takes a list of names and sort them, removing duplicates names are transfered to...">SyncSortNames</a>(root, acc);
<a name="l01644"></a>01644             acc-&gt;<a class="code" href="struct_sync_name_accum.html#a43e6bf3321957d08f4985443cc36555d">len</a> = 0; <span class="comment">// source no longer owns the names</span>
<a name="l01645"></a>01645             ud-&gt;<a class="code" href="structsync__update__data.html#a95435eb475deb0007ba15c50be1d088f">cb</a> = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01646"></a>01646             ud-&gt;<a class="code" href="structsync__update__data.html#a1cb1d7a80bfc2712d5b22bea479e32f1" title="temp storage used while updating">names</a> = <a class="code" href="_sync_util_8c.html#adcdacf16d78ec4fff95eff5f0d63446b">SyncAllocNameAccum</a>(0);
<a name="l01647"></a>01647             ud-&gt;<a class="code" href="structsync__update__data.html#a54c30a3acf32ec8669ce466e00b05af1" title="temp storage used while updating">nodes</a> = <a class="code" href="_sync_util_8c.html#acfdd4906ae2c5ffb57df166f281a8436">SyncAllocNodeAccum</a>(0);
<a name="l01648"></a>01648             ud-&gt;<a class="code" href="structsync__update__data.html#a19060fdeb1e72c8aa562ddcba82744ff">namesAdded</a> = 0;
<a name="l01649"></a>01649             ud-&gt;<a class="code" href="structsync__update__data.html#a0c50d872a6a7c598b87474c0b3f5e553">nameLenAccum</a> = 0;
<a name="l01650"></a>01650             ud-&gt;<a class="code" href="structsync__update__data.html#a67f89b07bc95f9f25c4184b5d22326a1">state</a> = <a class="code" href="sync__diff_8h.html#a3786a893383525288e5f73ce5feb0a43abd92a419693725472c68e3acf34eaea0">sync_update_state_init</a>;
<a name="l01651"></a>01651             <span class="keywordflow">if</span> (ent != NULL) {
<a name="l01652"></a>01652                 <a class="code" href="_sync_hash_cache_8c.html#a88b8496fee4324b2359f23e3c6dd9472" title="fetches the cache entry to be eligible, ce != NULL &amp;amp;&amp;amp; ce-&amp;gt;ncL != NULL...">SyncCacheEntryFetch</a>(ent);
<a name="l01653"></a>01653                 ud-&gt;<a class="code" href="structsync__update__data.html#abd7c89908b0b14fbe51592a8c42b881c">tw</a> = <a class="code" href="_sync_tree_worker_8c.html#ab50ea183a52285c94049d758fa2cb966" title="create a new tree worker, based on the given cache ent != NULL: initialize from the...">SyncTreeWorkerCreate</a>(root-&gt;<a class="code" href="struct_sync_root_struct.html#a404384379387e0beb78ebfb7b81109f6" title="cache head">ch</a>, ent);
<a name="l01654"></a>01654             }
<a name="l01655"></a>01655             <a class="code" href="sync__diff_8c.html#a73f268e26ad71d0c588bf953e30610d1">kickUpdate</a>(ud, 1);
<a name="l01656"></a>01656             <span class="keywordflow">return</span> 1;
<a name="l01657"></a>01657         }
<a name="l01658"></a>01658         <span class="keywordflow">default</span>: <span class="keywordflow">return</span> 0;
<a name="l01659"></a>01659             <span class="comment">// don&#39;t restart a busy updater</span>
<a name="l01660"></a>01660             <span class="keywordflow">return</span> -1;
<a name="l01661"></a>01661     }
<a name="l01662"></a>01662 }
<a name="l01663"></a>01663 
<a name="l01664"></a>01664 <span class="keywordtype">int</span>
<a name="l01665"></a><a class="code" href="sync__diff_8h.html#a79c577f4db986229fa0768e32782d3c3">01665</a> <a class="code" href="sync__diff_8c.html#a79c577f4db986229fa0768e32782d3c3" title="sync_update_stop can be called to stop the update operation.">sync_update_stop</a>(<span class="keyword">struct</span> <a class="code" href="structsync__update__data.html">sync_update_data</a> *ud) {
<a name="l01666"></a>01666     <span class="keywordtype">char</span> *here = <span class="stringliteral">&quot;Sync.sync_update_stop&quot;</span>;
<a name="l01667"></a>01667     <span class="keyword">struct </span><a class="code" href="struct_sync_root_struct.html" title="A SyncRootStruct object holds the necessary data for a root sync tree.">SyncRootStruct</a> *root = ud-&gt;<a class="code" href="structsync__update__data.html#ae27a2fd5da60493df931427349b1419f">root</a>;
<a name="l01668"></a>01668     <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = root-&gt;<a class="code" href="struct_sync_root_struct.html#aeb13995531505b4198ee20697bf1c08f" title="Sync Agent base.">base</a>-&gt;<a class="code" href="struct_sync_base_struct.html#a700f75c76dde6f2a525ea5b4cf7c0b79">debug</a>;
<a name="l01669"></a>01669     <span class="keywordflow">switch</span> (ud-&gt;<a class="code" href="structsync__update__data.html#a67f89b07bc95f9f25c4184b5d22326a1">state</a>) {
<a name="l01670"></a>01670         <span class="keywordflow">case</span> <a class="code" href="sync__diff_8h.html#a3786a893383525288e5f73ce5feb0a43abd92a419693725472c68e3acf34eaea0">sync_update_state_init</a>:
<a name="l01671"></a>01671         <span class="keywordflow">case</span> <a class="code" href="sync__diff_8h.html#a3786a893383525288e5f73ce5feb0a43a65974dc44d485be21ba5c47dfdf06617">sync_update_state_done</a>:
<a name="l01672"></a>01672             <span class="keywordflow">return</span> 0;
<a name="l01673"></a>01673         <span class="keywordflow">default</span>: {
<a name="l01674"></a>01674             <span class="keywordflow">if</span> (debug &gt;= <a class="code" href="loglevels_8h.html#a20714dcd4a5ab949a517b9631cfa4b21" title="Debugging.">CCNL_FINE</a>) {
<a name="l01675"></a>01675                 <a class="code" href="_sync_util_8c.html#ac8180ce34825395dfd42c16437008acb">SyncNoteSimple</a>(root, here, <span class="stringliteral">&quot;stopping&quot;</span>);
<a name="l01676"></a>01676             }
<a name="l01677"></a>01677             <a class="code" href="sync__diff_8c.html#ab9656b13bde807ac27980d88fa49f026">resetUpdateData</a>(ud);
<a name="l01678"></a>01678             ud-&gt;<a class="code" href="structsync__update__data.html#a67f89b07bc95f9f25c4184b5d22326a1">state</a> = <a class="code" href="sync__diff_8h.html#a3786a893383525288e5f73ce5feb0a43a65974dc44d485be21ba5c47dfdf06617">sync_update_state_done</a>;
<a name="l01679"></a>01679             <span class="keywordflow">return</span> 1;
<a name="l01680"></a>01680         }
<a name="l01681"></a>01681     }
<a name="l01682"></a>01682     <span class="keywordflow">return</span> 0;
<a name="l01683"></a>01683 }
<a name="l01684"></a>01684 
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Mon Feb 4 11:56:48 2013 for Content-Centric Networking in C by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
